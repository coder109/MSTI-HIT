window.Laya=function(e){"use strict";class ClassUtils{static regClass(e,t){ClassUtils._classMap[e]=t}static getClass(e){return ClassUtils._classMap[e]}static getInstance(e){var t=ClassUtils.getClass(e);return t?new t:(console.warn("[error] Undefined class:",e),null)}}function dummy(){}ClassUtils._classMap={};class Config{}Config.isAntialias=!0,Config.useWebGL2=!0,Config.FPS=60,Config.useRetinalCanvas=!1,Config.animationInterval=50,Config.webGL2D_MeshAllocMaxMem=!0,Config.defaultFontSize=12,Config.defaultFont="Arial",Config.isAlpha=!1,Config.isDepth=!1,Config.isfailIfMajorPerformanceCaveat=!1,Config.powerPreference="default",Config.premultipliedAlpha=!0,Config.isStencil=!1,Config.preserveDrawingBuffer=!1,Config.printWebglOrder=!1,Config.fontFamilyMap={"报隶":"报隶-简","黑体":"黑体-简","楷体":"楷体-简","兰亭黑":"兰亭黑-简","隶变":"隶变-简","凌慧体":"凌慧体-简","翩翩体":"翩翩体-简","苹方":"苹方-简","手札体":"手札体-简","宋体":"宋体-简","娃娃体":"娃娃体-简","魏碑":"魏碑-简","行楷":"行楷-简","雅痞":"雅痞-简","圆体":"圆体-简"},Config.fixedFrames=!0,Config.destroyResourceImmediatelyDefault=!0,Config._enableWindowRAFFunction=!0;class Const{}Const.ENUM_TEXTALIGN_DEFAULT=0,Const.ENUM_TEXTALIGN_CENTER=1,Const.ENUM_TEXTALIGN_RIGHT=2,Const.INDEX_BYTES=2,Const.MAX_CLIP_SIZE=99999999;class NodeFlags{}NodeFlags.NOT_ACTIVE=1,NodeFlags.ACTIVE_INHIERARCHY=2,NodeFlags.AWAKED=4,NodeFlags.NOT_READY=8,NodeFlags.DISPLAY=16,NodeFlags.HAS_ZORDER=32,NodeFlags.HAS_MOUSE=64,NodeFlags.DISPLAYED_INSTAGE=128,NodeFlags.DRAWCALL_OPTIMIZE=256,NodeFlags.PROCESS_COLLISIONS=512,NodeFlags.PROCESS_TRIGGERS=1024,NodeFlags.HAS_SCRIPT=2048,NodeFlags.ESCAPE_DRAWING_TO_TEXTURE=4096,NodeFlags.DISABLE_INNER_CLIPPING=8192,NodeFlags.DISABLE_OUTER_CLIPPING=16384,NodeFlags.DISABLE_VISIBILITY=32768,NodeFlags.EDITING_NODE=65536,NodeFlags.HIDE_BY_EDITOR=131072,NodeFlags.LOCK_BY_EDITOR=262144;class HideFlags{}HideFlags.HideInHierarchy=1,HideFlags.HideInInspector=2,HideFlags.DontSave=4,HideFlags.HideAndDontSave=7;class ILaya{}ILaya.Loader=null,ILaya.Context=null,ILaya.Browser=null,ILaya.Laya=null,ILaya.loader=null,ILaya.timer=null,ILaya.systemTimer=null,ILaya.physicsTimer=null,ILaya.stage=null;class LayaEnv{}LayaEnv.version="3.2.0-beta.1",LayaEnv.isPlaying=!0,LayaEnv.isPreview=!1,LayaEnv.isConch=null!=window.conch;class Pool{static getPoolBySign(e){return Pool._poolDic[e]||(Pool._poolDic[e]=[])}static clearBySign(e){Pool._poolDic[e]&&(Pool._poolDic[e].length=0)}static recover(e,t){!1===t[Pool.POOLSIGN]&&(t[Pool.POOLSIGN]=!0,Pool.getPoolBySign(e).push(t))}static recoverByClass(e){if(e){var t=e.__className||e.constructor._$gid;t&&Pool.recover(t,e)}}static _getClassSign(e){var t=e.__className||e._$gid;return t||(e._$gid=t=Pool._CLSID+"",Pool._CLSID++),t}static createByClass(e){return Pool.getItemByClass(Pool._getClassSign(e),e)}static getItemByClass(e,t){let r,i=Pool.getPoolBySign(e);return r=i.length?i.pop():new t,r[Pool.POOLSIGN]=!1,r}static getItemByCreateFun(e,t,r=null){var i=Pool.getPoolBySign(e),a=i.length?i.pop():t.call(r);return a[Pool.POOLSIGN]=!1,a}static getItem(e){var t=Pool.getPoolBySign(e),r=t.length?t.pop():null;return r&&(r[Pool.POOLSIGN]=!1),r}}Pool._CLSID=0,Pool.POOLSIGN="__InPool",Pool._poolDic={};var t=1;const r=180/Math.PI,i=Math.PI/180;class Utils{static toRadian(e){return e*i}static toAngle(e){return e*r}static toHexColor(e){if(e<0||isNaN(e))return null;for(var t=e.toString(16);t.length<6;)t="0"+t;return"#"+t}static fromStringColor(e){if(!e)return 0;if(e.indexOf("rgba(")>=0||e.indexOf("rgb(")>=0){let t=e.indexOf("("),r=e.indexOf(")");if(-1==t||-1==r)return 0;let i=(e=e.substring(t+1,r)).split(","),a=i.length;for(let e=0;e<a;e++)i[e]=parseFloat(i[e]),isNaN(i[e])&&(i[e]=0);return 4==i.length?(i[0]<<24)+(i[1]<<16)+(i[2]<<8)+Math.round(255*i[3]):(i[0]<<16)+(i[1]<<8)+i[2]}{"#"===e.charAt(0)&&(e=e.substring(1));let t=e.length;if(3===t||4===t){let r="";for(let i=0;i<t;i++)r+=e[i]+e[i];e=r}return parseInt(e,16)}}static getGID(){return t++}static copyArray(e,t){if(e||(e=[]),!t)return e;e.length=t.length;var r=t.length;for(let i=0;i<r;i++)e[i]=t[i];return e}static transPointList(e,t,r){var i,a=e.length;for(i=0;i<a;i+=2)e[i]+=t,e[i+1]+=r}static parseInt(e,t=0){var r=parseInt(e,t);return isNaN(r)?0:r}static getBaseName(e){let t=e.lastIndexOf("/");return-1!=t&&(e=e.substring(t+1)),t=e.indexOf("?"),-1!=t&&(e=e.substring(0,t)),e}static getFileExtension(e){let t=e.lastIndexOf(".");if(-1!=t){let r=e.substring(t+1).toLowerCase(),i=r.indexOf("?");if(-1!=i&&(r=r.substring(0,i)),"ls"===r){let i=e.lastIndexOf(".",t-1);if(-1!=i){let a=e.substring(i+1,t+1)+r;if("lanit.ls"===a||"ltcb.ls"===a)return a}}return r}return""}static replaceFileExtension(e,t,r){if(!e)return e;let i=e.lastIndexOf(".");if(t.length>0&&!r&&(t="."+t),-1!=i){let r=e.indexOf("?",i);return-1!=r?e.substring(0,i)+t+e.substring(r):e.substring(0,i)+t}return e+t}}class Component{constructor(){this._hideFlags=0,this._status=0,this._enabled=!0,this._singleton=!0,this._id=Utils.getGID(),this._initialize()}get hideFlags(){return this._hideFlags}set hideFlags(e){this._hideFlags=e}_initialize(){this._extra={}}hasHideFlag(e){return 0!=(this._hideFlags&e)}get id(){return this._id}get enabled(){return this._enabled}set enabled(e){this._enabled!=e&&(this._enabled=e,this.owner&&this._setActive(e&&this.owner.activeInHierarchy))}get awaked(){return this._status>0}get destroyed(){return 4==this._status}_isScript(){return!1}_resetComp(){this._enabled=!0,this._status=0,this._enableState=!1,this.owner=null}_setOwner(e){if(0!=this._status)throw"reuse a destroyed component";this.owner=e,this._isScript()&&e._setBit(NodeFlags.HAS_SCRIPT,!0),this._onAdded(),this.onAdded()}_onAdded(){}_onAwake(){}_onEnable(){this.onEnable()}_onDisable(){this.onDisable()}_onDestroy(){}_parse(e,t=null){}_parseInteractive(e=null,t=null){}_cloneTo(e){}_setActive(e){var t,r;if(e){if(0==this._status&&(this._status=1,(LayaEnv.isPlaying||this.runInEditor)&&(this._onAwake(),this.onAwake())),this._enabled&&!this._enableState&&(this._enableState=!0,LayaEnv.isPlaying||this.runInEditor)){((null===(t=this.owner._is3D&&this.owner._scene)||void 0===t?void 0:t._componentDriver)||ILaya.stage._componentDriver).add(this),LayaEnv.isPlaying&&this._isScript()&&this.setupScript(),this._onEnable()}}else if(this._enableState&&(this._enableState=!1,LayaEnv.isPlaying||this.runInEditor)){((null===(r=this.owner._is3D&&this.owner._scene)||void 0===r?void 0:r._componentDriver)||ILaya.stage._componentDriver).remove(this),ILaya.stage.offAllCaller(this),this._onDisable()}}setupScript(){}destroy(){4!=this._status&&(this.owner?this.owner._destroyComponent(this):this.destroyed||this._destroy(!0))}_destroy(e){var t;if(e)(LayaEnv.isPlaying||this.runInEditor)&&(this._onDestroy(),this.onDestroy(),this.onReset&&(this.onReset(),this._resetComp(),Pool.recoverByClass(this)));else if(this._setActive(!1),this._status=4,LayaEnv.isPlaying||this.runInEditor){((null===(t=this.owner._is3D&&this.owner._scene)||void 0===t?void 0:t._componentDriver)||ILaya.stage._componentDriver)._toDestroys.add(this)}}onAdded(){}onAwake(){}onEnable(){}onDisable(){}onDestroy(){}}class Point{constructor(e=0,t=0){this.x=e,this.y=t}static create(){return Pool.getItemByClass("Point",Point)}setTo(e,t){return this.x=e,this.y=t,this}reset(){return this.x=this.y=0,this}recover(){Pool.recover("Point",this.reset())}distance(e,t){return Math.sqrt((this.x-e)*(this.x-e)+(this.y-t)*(this.y-t))}toString(){return this.x+","+this.y}normalize(){var e=Math.sqrt(this.x*this.x+this.y*this.y);if(e>0){var t=1/e;this.x*=t,this.y*=t}}copy(e){return this.setTo(e.x,e.y)}}Point.TEMP=new Point,Point.EMPTY=new Point;class GrahamScan{static multiply(e,t,r){return(e.x-r.x)*(t.y-r.y)-(t.x-r.x)*(e.y-r.y)}static dis(e,t){return(e.x-t.x)*(e.x-t.x)+(e.y-t.y)*(e.y-t.y)}static _getPoints(e,t=!1,r=null){for(GrahamScan._mPointList||(GrahamScan._mPointList=[]);GrahamScan._mPointList.length<e;)GrahamScan._mPointList.push(new Point);return r||(r=[]),r.length=0,t?GrahamScan.getFrom(r,GrahamScan._mPointList,e):GrahamScan.getFromR(r,GrahamScan._mPointList,e),r}static getFrom(e,t,r){var i;for(i=0;i<r;i++)e.push(t[i]);return e}static getFromR(e,t,r){var i;for(i=0;i<r;i++)e.push(t.pop());return e}static pListToPointList(e,t=!1){var r,i=e.length/2,a=GrahamScan._getPoints(i,t,GrahamScan._tempPointList);for(r=0;r<i;r++)a[r].setTo(e[r+r],e[r+r+1]);return a}static pointListToPlist(e){var t,r,i=e.length,a=GrahamScan._temPList;for(a.length=0,t=0;t<i;t++)r=e[t],a.push(r.x,r.y);return a}static scanPList(e){return Utils.copyArray(e,GrahamScan.pointListToPlist(GrahamScan.scan(GrahamScan.pListToPointList(e,!0))))}static scan(e){var t,r,i,a,s,n=0,o=e.length,l={};for((a=GrahamScan._temArr).length=0,t=(o=e.length)-1;t>=0;t--)(s=(i=e[t]).x+"_"+i.y)in l||(l[s]=!0,a.push(i));for(o=a.length,Utils.copyArray(e,a),t=1;t<o;t++)(e[t].y<e[n].y||e[t].y==e[n].y&&e[t].x<e[n].x)&&(n=t);for(i=e[0],e[0]=e[n],e[n]=i,t=1;t<o-1;t++){for(n=t,r=t+1;r<o;r++)(GrahamScan.multiply(e[r],e[n],e[0])>0||0==GrahamScan.multiply(e[r],e[n],e[0])&&GrahamScan.dis(e[0],e[r])<GrahamScan.dis(e[0],e[n]))&&(n=r);i=e[t],e[t]=e[n],e[n]=i}if((a=GrahamScan._temArr).length=0,e.length<3)return Utils.copyArray(a,e);for(a.push(e[0],e[1],e[2]),t=3;t<o;t++){for(;a.length>=2&&GrahamScan.multiply(e[t],a[a.length-1],a[a.length-2])>=0;)a.pop();e[t]&&a.push(e[t])}return a}}GrahamScan._tempPointList=[],GrahamScan._temPList=[],GrahamScan._temArr=[];class Matrix{constructor(e=1,t=0,r=0,i=1,a=0,s=0,n=0){if(this._bTransform=!1,null!=Matrix._createFun)return Matrix._createFun(e,t,r,i,a,s,n);this.a=e,this.b=t,this.c=r,this.d=i,this.tx=a,this.ty=s,this._checkTransform()}identity(){return this.a=this.d=1,this.b=this.tx=this.ty=this.c=0,this._bTransform=!1,this}_checkTransform(){return this._bTransform=1!==this.a||0!==this.b||0!==this.c||1!==this.d}setTranslate(e,t){return this.tx=e,this.ty=t,this}translate(e,t){return this.tx+=e,this.ty+=t,this}scale(e,t){return this.a*=e,this.d*=t,this.c*=e,this.b*=t,this.tx*=e,this.ty*=t,this._bTransform=!0,this}rotate(e){var t=Math.cos(e),r=Math.sin(e),i=this.a,a=this.c,s=this.tx;return this.a=i*t-this.b*r,this.b=i*r+this.b*t,this.c=a*t-this.d*r,this.d=a*r+this.d*t,this.tx=s*t-this.ty*r,this.ty=s*r+this.ty*t,this._bTransform=!0,this}skew(e,t){var r=Math.tan(e),i=Math.tan(t),a=this.a,s=this.b;return this.a+=i*this.c,this.b+=i*this.d,this.c+=r*a,this.d+=r*s,this}invertTransformPoint(e){var t=this.a,r=this.b,i=this.c,a=this.d,s=this.tx,n=t*a-r*i,o=a/n,l=-r/n,h=-i/n,d=t/n,u=(i*this.ty-a*s)/n,c=-(t*this.ty-r*s)/n;return e.setTo(o*e.x+h*e.y+u,l*e.x+d*e.y+c)}transformPoint(e){return e.setTo(this.a*e.x+this.c*e.y+this.tx,this.b*e.x+this.d*e.y+this.ty)}transformPointN(e){return e.setTo(this.a*e.x+this.c*e.y,this.b*e.x+this.d*e.y)}getScaleX(){return 0===this.b?this.a:Math.sqrt(this.a*this.a+this.b*this.b)}getScaleY(){return 0===this.c?this.d:Math.sqrt(this.c*this.c+this.d*this.d)}invert(){var e=this.a,t=this.b,r=this.c,i=this.d,a=this.tx,s=e*i-t*r;return this.a=i/s,this.b=-t/s,this.c=-r/s,this.d=e/s,this.tx=(r*this.ty-i*a)/s,this.ty=-(e*this.ty-t*a)/s,this}setTo(e,t,r,i,a,s){return this.a=e,this.b=t,this.c=r,this.d=i,this.tx=a,this.ty=s,this}concat(e){var t=this.a,r=this.c,i=this.tx;return this.a=t*e.a+this.b*e.c,this.b=t*e.b+this.b*e.d,this.c=r*e.a+this.d*e.c,this.d=r*e.b+this.d*e.d,this.tx=i*e.a+this.ty*e.c+e.tx,this.ty=i*e.b+this.ty*e.d+e.ty,this}static mul(e,t,r){var i=e.a,a=e.b,s=e.c,n=e.d,o=e.tx,l=e.ty,h=t.a,d=t.b,u=t.c,c=t.d,_=t.tx,p=t.ty;return 0!==d||0!==u?(r.a=i*h+a*u,r.b=i*d+a*c,r.c=s*h+n*u,r.d=s*d+n*c,r.tx=h*o+u*l+_,r.ty=d*o+c*l+p):(r.a=i*h,r.b=a*c,r.c=s*h,r.d=n*c,r.tx=h*o+_,r.ty=c*l+p),r}static mul16(e,t,r){var i=e.a,a=e.b,s=e.c,n=e.d,o=e.tx,l=e.ty,h=t.a,d=t.b,u=t.c,c=t.d,_=t.tx,p=t.ty;return 0!==d||0!==u?(r[0]=i*h+a*u,r[1]=i*d+a*c,r[4]=s*h+n*u,r[5]=s*d+n*c,r[12]=h*o+u*l+_,r[13]=d*o+c*l+p):(r[0]=i*h,r[1]=a*c,r[4]=s*h,r[5]=n*c,r[12]=h*o+_,r[13]=c*l+p),r}scaleEx(e,t){var r=this.a,i=this.b,a=this.c,s=this.d;0!==i||0!==a?(this.a=e*r,this.b=e*i,this.c=t*a,this.d=t*s):(this.a=e*r,this.b=0*s,this.c=0*r,this.d=t*s),this._bTransform=!0}rotateEx(e){var t=Math.cos(e),r=Math.sin(e),i=this.a,a=this.b,s=this.c,n=this.d;0!==a||0!==s?(this.a=t*i+r*s,this.b=t*a+r*n,this.c=-r*i+t*s,this.d=-r*a+t*n):(this.a=t*i,this.b=r*n,this.c=-r*i,this.d=t*n),this._bTransform=!0}clone(){var e=Matrix.create();return e.a=this.a,e.b=this.b,e.c=this.c,e.d=this.d,e.tx=this.tx,e.ty=this.ty,e._bTransform=this._bTransform,e}copyTo(e){return e.a=this.a,e.b=this.b,e.c=this.c,e.d=this.d,e.tx=this.tx,e.ty=this.ty,e._bTransform=this._bTransform,e}toString(){return this.a+","+this.b+","+this.c+","+this.d+","+this.tx+","+this.ty}destroy(){this.recover()}recover(){Pool.recover("Matrix",this.identity())}static create(){return Pool.getItemByClass("Matrix",Matrix)}}Matrix.EMPTY=new Matrix,Matrix.TEMP=new Matrix,Matrix._createFun=null;class Rectangle{constructor(e=0,t=0,r=0,i=0){this.x=e,this.y=t,this.width=r,this.height=i}get right(){return this.x+this.width}get bottom(){return this.y+this.height}setTo(e,t,r,i){return this.x=e,this.y=t,this.width=r,this.height=i,this}reset(){return this.x=this.y=this.width=this.height=0,this}recover(){this!=Rectangle.TEMP&&this!=Rectangle.EMPTY&&Pool.recover("Rectangle",this.reset())}static create(){return Pool.getItemByClass("Rectangle",Rectangle)}copyFrom(e){return this.x=e.x,this.y=e.y,this.width=e.width,this.height=e.height,this}contains(e,t){return!(this.width<=0||this.height<=0)&&(e>=this.x&&e<this.right&&t>=this.y&&t<this.bottom)}intersects(e){return!(e.x>this.x+this.width||e.x+e.width<this.x||e.y>this.y+this.height||e.y+e.height<this.y)}intersection(e,t=null){return this.intersects(e)?(t||(t=new Rectangle),t.x=Math.max(this.x,e.x),t.y=Math.max(this.y,e.y),t.width=Math.min(this.right,e.right)-t.x,t.height=Math.min(this.bottom,e.bottom)-t.y,t):null}union(e,t=null){return t||(t=new Rectangle),this.clone(t),e.width<=0||e.height<=0?t:(t.addPoint(e.x,e.y),t.addPoint(e.right,e.bottom),this)}clone(e=null){return e||(e=new Rectangle),e.x=this.x,e.y=this.y,e.width=this.width,e.height=this.height,e}toString(){return this.x+","+this.y+","+this.width+","+this.height}equals(e){return!(!e||e.x!==this.x||e.y!==this.y||e.width!==this.width||e.height!==this.height)}addPoint(e,t){return this.x>e&&(this.width+=this.x-e,this.x=e),this.y>t&&(this.height+=this.y-t,this.y=t),this.width<e-this.x&&(this.width=e-this.x),this.height<t-this.y&&(this.height=t-this.y),this}_getBoundPoints(){var e=Rectangle._temB;return e.length=0,0==this.width||0==this.height||e.push(this.x,this.y,this.x+this.width,this.y,this.x,this.y+this.height,this.x+this.width,this.y+this.height),e}static _getBoundPointS(e,t,r,i,a){var s=Rectangle._temA;return s.length=0,0==r||0==i||(a&&(e*=a.width,t*=a.height,r*=a.width,i*=a.height),s.push(e,t,e+r,t,e,t+i,e+r,t+i)),s}static _getWrapRec(e,t=null){if(!e||e.length<1)return t?t.setTo(0,0,0,0):Rectangle.TEMP.setTo(0,0,0,0);t=t||Rectangle.create();var r,i,a,s,n,o=e.length,l=Point.TEMP;for(a=n=-(i=s=99999),r=0;r<o;r+=2)l.x=e[r],l.y=e[r+1],i=i<l.x?i:l.x,s=s<l.y?s:l.y,a=a>l.x?a:l.x,n=n>l.y?n:l.y;return t.setTo(i,s,a-i,n-s)}isEmpty(){return this.width<=0||this.height<=0}}var a,s,n;Rectangle.EMPTY=new Rectangle,Rectangle.TEMP=new Rectangle,Rectangle._temB=[],Rectangle._temA=[],e.RenderTargetFormat=void 0,(a=e.RenderTargetFormat||(e.RenderTargetFormat={}))[a.None=-1]="None",a[a.R8G8B8=0]="R8G8B8",a[a.R8G8B8A8=1]="R8G8B8A8",a[a.R16G16B16A16=17]="R16G16B16A16",a[a.R32G32B32=30]="R32G32B32",a[a.R32G32B32A32=15]="R32G32B32A32",a[a.R16G16B16=31]="R16G16B16",a[a.DEPTH_16=35]="DEPTH_16",a[a.STENCIL_8=36]="STENCIL_8",a[a.DEPTHSTENCIL_24_8=37]="DEPTHSTENCIL_24_8",a[a.DEPTH_32=38]="DEPTH_32",a[a.DEPTHSTENCIL_24_Plus=39]="DEPTHSTENCIL_24_Plus";class SpriteConst{}SpriteConst.ALPHA=1,SpriteConst.TRANSFORM=2,SpriteConst.BLEND=4,SpriteConst.CANVAS=8,SpriteConst.FILTERS=16,SpriteConst.MASK=32,SpriteConst.CLIP=64,SpriteConst.TEXTURE=128,SpriteConst.GRAPHICS=256,SpriteConst.LAYAGL3D=512,SpriteConst.CUSTOM=1024,SpriteConst.HITAREA=2048,SpriteConst.CHILDS=4096,SpriteConst.REPAINT_NONE=0,SpriteConst.REPAINT_NODE=1,SpriteConst.REPAINT_CACHE=2,SpriteConst.REPAINT_ALL=3,e.HDREncodeFormat=void 0,(s=e.HDREncodeFormat||(e.HDREncodeFormat={}))[s.NONE=0]="NONE",s[s.RGBM=1]="RGBM",s[s.RGBD=2]="RGBD",e.TextureFormat=void 0,(n=e.TextureFormat||(e.TextureFormat={}))[n.R8G8B8=0]="R8G8B8",n[n.R8G8B8A8=1]="R8G8B8A8",n[n.R5G6B5=16]="R5G6B5",n[n.Alpha8=2]="Alpha8",n[n.DXT1=3]="DXT1",n[n.DXT3=29]="DXT3",n[n.DXT5=4]="DXT5",n[n.ETC1RGB=5]="ETC1RGB",n[n.ETC2RGB=6]="ETC2RGB",n[n.ETC2RGBA=7]="ETC2RGBA",n[n.ETC2SRGB_Alpha8=8]="ETC2SRGB_Alpha8",n[n.ETC2SRGB=28]="ETC2SRGB",n[n.PVRTCRGB_2BPPV=9]="PVRTCRGB_2BPPV",n[n.PVRTCRGBA_2BPPV=10]="PVRTCRGBA_2BPPV",n[n.PVRTCRGB_4BPPV=11]="PVRTCRGB_4BPPV",n[n.PVRTCRGBA_4BPPV=12]="PVRTCRGBA_4BPPV",n[n.R32G32B32A32=15]="R32G32B32A32",n[n.R32G32B32=30]="R32G32B32",n[n.R16G16B16A16=17]="R16G16B16A16",n[n.R16G16B16=31]="R16G16B16",n[n.ASTC4x4=18]="ASTC4x4",n[n.ASTC4x4SRGB=23]="ASTC4x4SRGB",n[n.ASTC6x6=19]="ASTC6x6",n[n.ASTC6x6SRGB=24]="ASTC6x6SRGB",n[n.ASTC8x8=20]="ASTC8x8",n[n.ASTC8x8SRGB=25]="ASTC8x8SRGB",n[n.ASTC10x10=21]="ASTC10x10",n[n.ASTC10x10SRGB=26]="ASTC10x10SRGB",n[n.ASTC12x12=22]="ASTC12x12",n[n.ASTC12x12SRGB=27]="ASTC12x12SRGB",n[n.KTXTEXTURE=-1]="KTXTEXTURE",n[n.PVRTEXTURE=-2]="PVRTEXTURE";class LayaGL{}class Delegate{constructor(){this._flag=0,this._items=[]}add(e,t,r){let i=this._items,a=i.findIndex(((r,i,a)=>r==e&&a[i+1]==t));-1!=a?(i[a+2]=r,i[a+3]=1):i.push(e,t,r,1)}once(e,t,r){let i=this._items,a=i.findIndex(((r,i,a)=>r==e&&a[i+1]==t));-1!=a?(i[a+2]=r,i[a+3]=2):i.push(e,t,r,2)}remove(e,t){let r=this._items,i=r.findIndex(((r,i,a)=>r==e&&a[i+1]==t));-1!=i&&(0!=this._flag?(r[i+3]=0,this._flag=2):r.splice(i,4))}clear(){let e=this._items;0!=this._flag?(e.forEach(((e,t,r)=>{t%4==3&&(r[t]=0)})),this._flag=2):e.length=0}clearForTarget(e){if(!e)return;let t=this._items;if(0!=this._flag)t.forEach(((t,r,i)=>{r%4==1&&i[r]==e&&(i[r+2]=0)})),this._flag=2;else{let r=t.length-4;for(;r>=0;)t[r+1]==e&&t.splice(r,4),r-=4}}get count(){return this._items.length/4}invoke(...e){if(0!=this._flag)return;this._flag=1;let t=this._items,r=t.length;for(let i=0;i<r;i+=4){if(0==t[i+3])continue;let r=t[i+2];try{null!=r?t[i].call(t[i+1],...r,...e):t[i].call(t[i+1],...e)}catch(e){console.error(e)}2==t[i+3]&&(t[i+3]=0,this._flag=2)}if(2==this._flag){let e=t.length,r=0;for(;r<e;)0!=t[r+3]?r+=4:(t.splice(r,4),e-=4)}this._flag=0}}class Event{constructor(){this.touchId=0,this.delta=0,this.button=0,this.touchPos=new Point}static isMouseEvent(e){return o.has(e)}setTo(e,t,r){return this.type=e,this.currentTarget=t,this.target=r,this}stopPropagation(){this._stopped=!0}get touches(){return this._touches}get altKey(){var e;return null===(e=this.nativeEvent)||void 0===e?void 0:e.altKey}get ctrlKey(){var e;return null===(e=this.nativeEvent)||void 0===e?void 0:e.ctrlKey}get shiftKey(){var e;return null===(e=this.nativeEvent)||void 0===e?void 0:e.shiftKey}get metaKey(){var e;return null===(e=this.nativeEvent)||void 0===e?void 0:e.metaKey}get key(){return this.nativeEvent.key}get keyCode(){return this.nativeEvent.keyCode}get charCode(){var e;return null===(e=this.nativeEvent)||void 0===e?void 0:e.code}get keyLocation(){return this.nativeEvent?this.nativeEvent.location||this.nativeEvent.keyLocation:0}get stageX(){return this.touchPos.x}get stageY(){return this.touchPos.y}}Event.EMPTY=new Event,Event.MOUSE_DOWN="mousedown",Event.MOUSE_UP="mouseup",Event.RIGHT_MOUSE_DOWN="rightmousedown",Event.RIGHT_MOUSE_UP="rightmouseup",Event.CLICK="click",Event.RIGHT_CLICK="rightclick",Event.MOUSE_MOVE="mousemove",Event.MOUSE_OVER="mouseover",Event.MOUSE_OUT="mouseout",Event.MOUSE_WHEEL="mousewheel",Event.ROLL_OVER="mouseover",Event.ROLL_OUT="mouseout",Event.DOUBLE_CLICK="doubleclick",Event.MOUSE_DRAG="mousedrag",Event.MOUSE_DRAG_END="mousedragend",Event.DRAG_START="dragstart",Event.DRAG_MOVE="dragmove",Event.DRAG_END="dragend",Event.KEY_DOWN="keydown",Event.KEY_PRESS="keypress",Event.KEY_UP="keyup",Event.CHANGE="change",Event.CHANGED="changed",Event.WILL_RESIZE="willResize",Event.RESIZE="resize",Event.ADDED="added",Event.REMOVED="removed",Event.DISPLAY="display",Event.UNDISPLAY="undisplay",Event.ERROR="error",Event.COMPLETE="complete",Event.LOADED="loaded",Event.READY="ready",Event.PROGRESS="progress",Event.INPUT="input",Event.RENDER="render",Event.OPEN="open",Event.MESSAGE="message",Event.CLOSE="close",Event.FRAME="enterframe",Event.ENTER="enter",Event.SELECT="select",Event.BLUR="blur",Event.FOCUS="focus",Event.VISIBILITY_CHANGE="visibilitychange",Event.FOCUS_CHANGE="focuschange",Event.PLAYED="played",Event.PAUSED="paused",Event.STOPPED="stopped",Event.START="start",Event.END="end",Event.LINK="link",Event.LABEL="label",Event.FULL_SCREEN_CHANGE="fullscreenchange",Event.DEVICE_LOST="devicelost",Event.TRANSFORM_CHANGED="transformchanged",Event.LAYERCHANGE="layerChange",Event.staticMask="staticMask",Event.TRIGGER_ENTER="triggerenter",Event.TRIGGER_STAY="triggerstay",Event.TRIGGER_EXIT="triggerexit",Event.COLLISION_ENTER="collisionenter",Event.COLLISION_STAY="collisionstay",Event.COLLISION_EXIT="collisionexit",Event.JOINT_BREAK="jointbreak",Event._Add_Script="addscript";const o=new Set([Event.MOUSE_DOWN,Event.MOUSE_UP,Event.MOUSE_MOVE,Event.CLICK,Event.DOUBLE_CLICK,Event.RIGHT_CLICK,Event.RIGHT_MOUSE_DOWN,Event.RIGHT_MOUSE_UP,Event.MOUSE_OVER,Event.MOUSE_OUT,Event.MOUSE_WHEEL,Event.MOUSE_DRAG,Event.MOUSE_DRAG_END]),l=[];class EventDispatcher{onStartListeningToType(e){}hasListener(e){let t=this._events&&this._events[e];return!!t&&t.count>0}event(e,t){let r=this._events&&this._events[e];if(!r)return!1;let i=r.count>0;if(Array.isArray(t))r.invoke(...t);else if(void 0!==t)r.invoke(t);else if(t===Event.EMPTY){let t=l.length>0?l.pop():new Event;r.invoke(t.setTo(e,this,this)),t.target=t.currentTarget=null,l.push(t)}else r.invoke();return i}on(e,t,r,i){2==arguments.length&&(r=t,t=null),this._events||(this._events={});let a=this._events[e];return a||(this.onStartListeningToType(e),this._events[e]=a=new Delegate),a.add(r,t,i),this}once(e,t,r,i){2==arguments.length&&(r=t,t=null),this._events||(this._events={});let a=this._events[e];return a||(this.onStartListeningToType(e),this._events[e]=a=new Delegate),a.once(r,t,i),this}off(e,t,r){2==arguments.length&&(r=t,t=null);let i=this._events&&this._events[e];return i&&i.remove(r,t),this}offAll(e){if(null==e)this._events=null;else{let t=this._events&&this._events[e];t&&t.clear()}return this}offAllCaller(e){if(e&&this._events)for(let t in this._events)this._events[t].clearForTarget(e);return this}}var h,d,u=0,c=0,_=0;class Resource extends EventDispatcher{constructor(e){super(),this._cpuMemory=0,this._gpuMemory=0,this._id=0,this._referenceCount=0,this._id=++u,this._destroyed=!1,this._referenceCount=0,(null==e||e)&&(Resource._idResourcesMap[this._id]=this),this.lock=!1,this.destroyedImmediately=!0}static get cpuMemory(){return Resource._cpuMemory}static get gpuMemory(){return Resource._gpuMemory}static _addCPUMemory(e){Resource._cpuMemory+=e}static _addGPUMemory(e){Resource._gpuMemory+=e}static _addMemory(e,t){Resource._cpuMemory+=e,Resource._gpuMemory+=t}static destroyUnusedResources(){c=0,_=0,ILaya.loader.loading?ILaya.timer.frameLoop(1,Resource,Resource._destroyUnusedResources):Resource._destroyUnusedResources(!0)}static _destroyUnusedResources(e){if(!e&&ILaya.loader.loading)return;ILaya.timer.clear(Resource,Resource._destroyUnusedResources);let t=0;for(let e in Resource._idResourcesMap){let r=Resource._idResourcesMap[e];r.lock||0!==r._referenceCount||(r.destroy(),t++)}Resource.DEBUG&&t>0&&console.debug(`destroyUnusedResources(${t})`),t>0&&_<5&&(_++,ILaya.timer.frameLoop(1,Resource,Resource._destroyUnusedResources))}get id(){return this._id}get cpuMemory(){return this._cpuMemory}get gpuMemory(){return this._gpuMemory}get destroyed(){return this._destroyed}get obsolute(){return this._obsolute}set obsolute(e){this._obsolute=e}get referenceCount(){return this._referenceCount}_setCPUMemory(e){var t=e-this._cpuMemory;this._cpuMemory=e,Resource._addCPUMemory(t)}_setGPUMemory(e){var t=e-this._gpuMemory;this._gpuMemory=e,Resource._addGPUMemory(t)}_setCreateURL(e,t){this.url=e,this.uuid=t}isCreateFromURL(e){return this.uuid&&e.length===this.uuid.length+6&&e.endsWith(this.uuid)||this.url===e}_addReference(e=1){this._referenceCount+=e}_removeReference(e=1){this._referenceCount-=e,c>0&&this._referenceCount<=0&&!this.lock&&this.destroyedImmediately&&this.destroy()}_clearReference(){this._referenceCount=0}_recoverResource(){}_disposeResource(){}_activeResource(){}destroy(){this._destroyed||(this._destroyed=!0,this.lock=!1,c++,this._disposeResource(),c--,this.offAll(),delete Resource._idResourcesMap[this.id],this.url&&(Resource.DEBUG&&console.debug(`destroy ${Object.getPrototypeOf(this).constructor.name} ${this.url}`),ILaya.loader.clearRes(this.url,this)))}}Resource._idResourcesMap={},Resource._cpuMemory=0,Resource._gpuMemory=0,Resource.DEBUG=!1;class BaseTexture extends Resource{constructor(t,r,i){super(),this._gammaSpace=!1,this._width=t,this._height=r,this._format=i,this.destroyedImmediately=Config.destroyResourceImmediatelyDefault,this.hdrEncodeFormat=e.HDREncodeFormat.NONE}get width(){return this._width}set width(e){this._width=e}get height(){return this._height}set height(e){this._height=e}get dimension(){return this._dimension}get format(){return this._format}get mipmap(){return this._texture.mipmap}get mipmapCount(){return this._texture.mipmapCount}get anisoLevel(){return this._texture.anisoLevel}set anisoLevel(e){this._texture.anisoLevel=e}get filterMode(){return this._texture.filterMode}set filterMode(e){this._texture.filterMode=e}get wrapModeU(){return this._texture.wrapU}set wrapModeU(e){this._texture.wrapU=e}get wrapModeV(){return this._texture.wrapV}set wrapModeV(e){this._texture.wrapV=e}get wrapModeW(){return this._texture.wrapW}set wrapModeW(e){this._texture.wrapW=e}get compareMode(){return this._texture.compareMode}set compareMode(e){this._texture.compareMode=LayaGL.textureContext.setTextureCompareMode(this._texture,e)}get gammaCorrection(){return this._texture.gammaCorrection}set baseMipmapLevel(e){this._texture.baseMipmapLevel=e}get baseMipmapLevel(){return this._texture.baseMipmapLevel}set maxMipmapLevel(e){this._texture.maxMipmapLevel=e}get maxMipmapLevel(){return this._texture.maxMipmapLevel}get gammaSpace(){return this._texture.useSRGBLoad||this._texture.gammaCorrection>1}gpuCompressFormat(){switch(this._format){case e.TextureFormat.R8G8B8:case e.TextureFormat.R8G8B8A8:case e.TextureFormat.R16G16B16:case e.TextureFormat.R16G16B16A16:case e.TextureFormat.R32G32B32:case e.TextureFormat.R32G32B32A32:case e.TextureFormat.R5G6B5:case e.TextureFormat.Alpha8:return!1;case e.TextureFormat.DXT1:case e.TextureFormat.DXT3:case e.TextureFormat.DXT5:case e.TextureFormat.ETC1RGB:case e.TextureFormat.ETC2RGB:case e.TextureFormat.ETC2RGBA:case e.TextureFormat.ETC2SRGB_Alpha8:case e.TextureFormat.ETC2SRGB:case e.TextureFormat.PVRTCRGB_2BPPV:case e.TextureFormat.PVRTCRGBA_2BPPV:case e.TextureFormat.PVRTCRGB_4BPPV:case e.TextureFormat.PVRTCRGBA_4BPPV:case e.TextureFormat.ASTC4x4:case e.TextureFormat.ASTC4x4SRGB:case e.TextureFormat.ASTC6x6:case e.TextureFormat.ASTC6x6SRGB:case e.TextureFormat.ASTC8x8:case e.TextureFormat.ASTC8x8SRGB:case e.TextureFormat.ASTC10x10:case e.TextureFormat.ASTC10x10SRGB:case e.TextureFormat.ASTC12x12:case e.TextureFormat.ASTC12x12SRGB:return!0;default:return!1}}_getFormatByteCount(){switch(this._format){case e.TextureFormat.R8G8B8:return 3;case e.TextureFormat.R8G8B8A8:return 4;case e.TextureFormat.R5G6B5:case e.TextureFormat.Alpha8:return 1;case e.TextureFormat.R16G16B16A16:return 2;case e.TextureFormat.R32G32B32A32:return 4;default:throw"Texture2D: unknown format."}}_getSource(){return this._texture.resource}get defaultTexture(){throw"defaulte"}_disposeResource(){this._texture.dispose()}}class Byte{constructor(e=null){this._xd_=!0,this._allocated_=8,this._pos_=0,this._length=0,e?(this._u8d_=new Uint8Array(e),this._d_=new DataView(this._u8d_.buffer),this._length=this._d_.byteLength):this._resizeBuffer(this._allocated_)}static getSystemEndian(){if(!Byte._sysEndian){var e=new ArrayBuffer(2);new DataView(e).setInt16(0,256,!0),Byte._sysEndian=256===new Int16Array(e)[0]?Byte.LITTLE_ENDIAN:Byte.BIG_ENDIAN}return Byte._sysEndian}get buffer(){var e=this._d_.buffer;return e.byteLength===this._length?e:e.slice(0,this._length)}get endian(){return this._xd_?Byte.LITTLE_ENDIAN:Byte.BIG_ENDIAN}set endian(e){this._xd_=e===Byte.LITTLE_ENDIAN}set length(e){this._allocated_<e?this._resizeBuffer(this._allocated_=Math.floor(Math.max(e,2*this._allocated_))):this._allocated_>e&&this._resizeBuffer(this._allocated_=e),this._length=e}get length(){return this._length}_resizeBuffer(e){try{var t=new Uint8Array(e);null!=this._u8d_&&(this._u8d_.length<=e?t.set(this._u8d_):t.set(this._u8d_.subarray(0,e))),this._u8d_=t,this._d_=new DataView(t.buffer)}catch(t){throw"Invalid typed array length:"+e}}getString(){return this.readString()}readString(){return this._rUTF(this.getUint16())}getFloat32Array(e,t){return this.readFloat32Array(e,t)}readFloat32Array(e,t){var r=e+t;r=r>this._length?this._length:r;var i=new Float32Array(this._d_.buffer.slice(e,r));return this._pos_=r,i}getUint8Array(e,t){return this.readUint8Array(e,t)}readUint8Array(e,t){var r=e+t;r=r>this._length?this._length:r;var i=new Uint8Array(this._d_.buffer.slice(e,r));return this._pos_=r,i}getInt16Array(e,t){return this.readInt16Array(e,t)}readInt16Array(e,t){var r=e+t;r=r>this._length?this._length:r;var i=new Int16Array(this._d_.buffer.slice(e,r));return this._pos_=r,i}getFloat32(){return this.readFloat32()}readFloat32(){if(this._pos_+4>this._length)throw"getFloat32 error - Out of bounds";var e=this._d_.getFloat32(this._pos_,this._xd_);return this._pos_+=4,e}getFloat64(){return this.readFloat64()}readFloat64(){if(this._pos_+8>this._length)throw"getFloat64 error - Out of bounds";var e=this._d_.getFloat64(this._pos_,this._xd_);return this._pos_+=8,e}writeFloat32(e){this._ensureWrite(this._pos_+4),this._d_.setFloat32(this._pos_,e,this._xd_),this._pos_+=4}writeFloat64(e){this._ensureWrite(this._pos_+8),this._d_.setFloat64(this._pos_,e,this._xd_),this._pos_+=8}getInt32(){return this.readInt32()}readInt32(){if(this._pos_+4>this._length)throw"getInt32 error - Out of bounds";var e=this._d_.getInt32(this._pos_,this._xd_);return this._pos_+=4,e}getUint32(){return this.readUint32()}readUint32(){if(this._pos_+4>this._length)throw"getUint32 error - Out of bounds";var e=this._d_.getUint32(this._pos_,this._xd_);return this._pos_+=4,e}writeInt32(e){this._ensureWrite(this._pos_+4),this._d_.setInt32(this._pos_,e,this._xd_),this._pos_+=4}writeUint32(e){this._ensureWrite(this._pos_+4),this._d_.setUint32(this._pos_,e,this._xd_),this._pos_+=4}getInt16(){return this.readInt16()}readInt16(){if(this._pos_+2>this._length)throw"getInt16 error - Out of bounds";var e=this._d_.getInt16(this._pos_,this._xd_);return this._pos_+=2,e}getUint16(){return this.readUint16()}readUint16(){if(this._pos_+2>this._length)throw"getUint16 error - Out of bounds";var e=this._d_.getUint16(this._pos_,this._xd_);return this._pos_+=2,e}writeUint16(e){this._ensureWrite(this._pos_+2),this._d_.setUint16(this._pos_,e,this._xd_),this._pos_+=2}writeInt16(e){this._ensureWrite(this._pos_+2),this._d_.setInt16(this._pos_,e,this._xd_),this._pos_+=2}getUint8(){return this.readUint8()}readUint8(){if(this._pos_+1>this._length)throw"getUint8 error - Out of bounds";return this._u8d_[this._pos_++]}writeUint8(e){this._ensureWrite(this._pos_+1),this._d_.setUint8(this._pos_,e),this._pos_++}_getUInt8(e){return this._readUInt8(e)}_readUInt8(e){return this._d_.getUint8(e)}_getUint16(e){return this._readUint16(e)}_readUint16(e){return this._d_.getUint16(e,this._xd_)}_getMatrix(){return this._readMatrix()}_readMatrix(){return new Matrix(this.getFloat32(),this.getFloat32(),this.getFloat32(),this.getFloat32(),this.getFloat32(),this.getFloat32())}_rUTF(e){var t,r,i=this._pos_+e,a=String.fromCharCode,s=this._u8d_,n=[],o=0;for(n.length=1e3;this._pos_<i;)if((t=s[this._pos_++])<128)0!=t&&(n[o++]=a(t));else if(t<224)n[o++]=a((63&t)<<6|127&s[this._pos_++]);else if(t<240)r=s[this._pos_++],n[o++]=a((31&t)<<12|(127&r)<<6|127&s[this._pos_++]);else{const e=(15&t)<<18|(127&(r=s[this._pos_++]))<<12|(127&s[this._pos_++])<<6|127&s[this._pos_++];if(e>=65536){const t=e-65536,r=55296|t>>10,i=56320|1023&t;n[o++]=a(r),n[o++]=a(i)}else n[o++]=a(e)}return n.length=o,n.join("")}getCustomString(e){return this.readCustomString(e)}readCustomString(e){for(var t,r="",i=0,a=String.fromCharCode,s=this._u8d_;e>0;)if((t=s[this._pos_])<128)r+=a(t),this._pos_++,e--;else for(i=t-128,this._pos_++,e-=i;i>0;)t=s[this._pos_++],r+=a(s[this._pos_++]<<8|t),i--;return r}get pos(){return this._pos_}set pos(e){this._pos_=e}get bytesAvailable(){return this._length-this._pos_}clear(){this._pos_=0,this.length=0}__getBuffer(){return this._d_.buffer}writeUTFBytes(e){for(var t=0,r=(e+="").length;t<r;t++){var i=e.charCodeAt(t);if(i<=127)this.writeByte(i);else if(i<=2047)this._ensureWrite(this._pos_+2),this._u8d_.set([192|i>>6,128|63&i],this._pos_),this._pos_+=2;else if(i>=55296&&i<=56319){t++;const r=e.charCodeAt(t);if(!Number.isNaN(r)&&r>=56320&&r<=57343){const e=64+(1023&i),t=1023&r,a=240|e>>8&63,s=128|e>>2&63,n=128|(3&e)<<4|t>>6&15,o=128|63&t;this._ensureWrite(this._pos_+4),this._u8d_.set([a,s,n,o],this._pos_),this._pos_+=4}}else i<=65535?(this._ensureWrite(this._pos_+3),this._u8d_.set([224|i>>12,128|i>>6&63,128|63&i],this._pos_),this._pos_+=3):(this._ensureWrite(this._pos_+4),this._u8d_.set([240|i>>18,128|i>>12&63,128|i>>6&63,128|63&i],this._pos_),this._pos_+=4)}}writeUTFString(e){var t=this.pos;this.writeUint16(1),this.writeUTFBytes(e);var r=this.pos-t-2;this._d_.setUint16(t,r,this._xd_)}writeUTFString32(e){var t=this.pos;this.writeUint32(1),this.writeUTFBytes(e);var r=this.pos-t-4;this._d_.setUint32(t,r,this._xd_)}readUTFString(){return this.readUTFBytes(this.getUint16())}readUTFString32(){return this.readUTFBytes(this.getUint32())}getUTFString(){return this.readUTFString()}readUTFBytes(e=-1){if(0===e)return"";var t=this.bytesAvailable;if(e>t)throw"readUTFBytes error - Out of bounds";return e=e>0?e:t,this._rUTF(e)}getUTFBytes(e=-1){return this.readUTFBytes(e)}writeByte(e){this._ensureWrite(this._pos_+1),this._d_.setInt8(this._pos_,e),this._pos_+=1}readByte(){if(this._pos_+1>this._length)throw"readByte error - Out of bounds";return this._d_.getInt8(this._pos_++)}getByte(){return this.readByte()}_ensureWrite(e){this._length<e&&(this._length=e),this._allocated_<e&&(this.length=e)}writeArrayBuffer(e,t=0,r=0){if(t<0||r<0)throw"writeArrayBuffer error - Out of bounds";0==r&&(r=e.byteLength-t),this._ensureWrite(this._pos_+r);var i=new Uint8Array(e);this._u8d_.set(i.subarray(t,t+r),this._pos_),this._pos_+=r}readArrayBuffer(e){var t;return t=this._u8d_.buffer.slice(this._pos_,this._pos_+e),this._pos_=this._pos_+e,t}}Byte.BIG_ENDIAN="bigEndian",Byte.LITTLE_ENDIAN="littleEndian",Byte._sysEndian=null;class HalfFloatUtils{static __init__(){for(var e=0;e<256;++e){var t=e-127;t<-27?(HalfFloatUtils._baseTable[0|e]=0,HalfFloatUtils._baseTable[256|e]=32768,HalfFloatUtils._shiftTable[0|e]=24,HalfFloatUtils._shiftTable[256|e]=24):t<-14?(HalfFloatUtils._baseTable[0|e]=1024>>-t-14,HalfFloatUtils._baseTable[256|e]=1024>>-t-14|32768,HalfFloatUtils._shiftTable[0|e]=-t-1,HalfFloatUtils._shiftTable[256|e]=-t-1):t<=15?(HalfFloatUtils._baseTable[0|e]=t+15<<10,HalfFloatUtils._baseTable[256|e]=t+15<<10|32768,HalfFloatUtils._shiftTable[0|e]=13,HalfFloatUtils._shiftTable[256|e]=13):t<128?(HalfFloatUtils._baseTable[0|e]=31744,HalfFloatUtils._baseTable[256|e]=64512,HalfFloatUtils._shiftTable[0|e]=24,HalfFloatUtils._shiftTable[256|e]=24):(HalfFloatUtils._baseTable[0|e]=31744,HalfFloatUtils._baseTable[256|e]=64512,HalfFloatUtils._shiftTable[0|e]=13,HalfFloatUtils._shiftTable[256|e]=13)}for(HalfFloatUtils._mantissaTable[0]=0,e=1;e<1024;++e){var r=e<<13;for(t=0;0==(8388608&r);)t-=8388608,r<<=1;r&=-8388609,t+=947912704,HalfFloatUtils._mantissaTable[e]=r|t}for(e=1024;e<2048;++e)HalfFloatUtils._mantissaTable[e]=939524096+(e-1024<<13);for(HalfFloatUtils._exponentTable[0]=0,e=1;e<31;++e)HalfFloatUtils._exponentTable[e]=e<<23;for(HalfFloatUtils._exponentTable[31]=1199570944,HalfFloatUtils._exponentTable[32]=2147483648,e=33;e<63;++e)HalfFloatUtils._exponentTable[e]=2147483648+(e-32<<23);for(HalfFloatUtils._exponentTable[63]=3347054592,HalfFloatUtils._offsetTable[0]=0,e=1;e<64;++e)HalfFloatUtils._offsetTable[e]=32===e?0:1024}static roundToFloat16Bits(e){HalfFloatUtils._floatView[0]=e;var t=HalfFloatUtils._uint32View[0],r=t>>23&511;return HalfFloatUtils._baseTable[r]+((8388607&t)>>HalfFloatUtils._shiftTable[r])}static convertToNumber(e){var t=e>>10;return HalfFloatUtils._uint32View[0]=HalfFloatUtils._mantissaTable[HalfFloatUtils._offsetTable[t]+(1023&e)]+HalfFloatUtils._exponentTable[t],HalfFloatUtils._floatView[0]}}HalfFloatUtils._buffer=new ArrayBuffer(4),HalfFloatUtils._floatView=new Float32Array(HalfFloatUtils._buffer),HalfFloatUtils._uint32View=new Uint32Array(HalfFloatUtils._buffer),HalfFloatUtils._baseTable=new Uint32Array(512),HalfFloatUtils._shiftTable=new Uint32Array(512),HalfFloatUtils._mantissaTable=new Uint32Array(2048),HalfFloatUtils._exponentTable=new Uint32Array(64),HalfFloatUtils._offsetTable=new Uint32Array(64),e.FilterMode=void 0,(h=e.FilterMode||(e.FilterMode={}))[h.Point=0]="Point",h[h.Bilinear=1]="Bilinear",h[h.Trilinear=2]="Trilinear",e.RenderCapable=void 0,(d=e.RenderCapable||(e.RenderCapable={}))[d.Element_Index_Uint32=0]="Element_Index_Uint32",d[d.TextureFormat_R32G32B32A32=1]="TextureFormat_R32G32B32A32",d[d.TextureFormat_R16G16B16A16=2]="TextureFormat_R16G16B16A16",d[d.Texture_anisotropic=3]="Texture_anisotropic",d[d.RenderTextureFormat_R16G16B16A16=4]="RenderTextureFormat_R16G16B16A16",d[d.RenderTextureFormat_R32G32B32A32=5]="RenderTextureFormat_R32G32B32A32",d[d.RenderTextureFormat_Depth=6]="RenderTextureFormat_Depth",d[d.RenderTextureFormat_ShadowMap=7]="RenderTextureFormat_ShadowMap",d[d.Vertex_VAO=8]="Vertex_VAO",d[d.DrawElement_Instance=9]="DrawElement_Instance",d[d.Shader_TextureLod=10]="Shader_TextureLod",d[d.COMPRESS_TEXTURE_S3TC=11]="COMPRESS_TEXTURE_S3TC",d[d.COMPRESS_TEXTURE_S3TC_SRGB=12]="COMPRESS_TEXTURE_S3TC_SRGB",d[d.COMPRESS_TEXTURE_PVRTC=13]="COMPRESS_TEXTURE_PVRTC",d[d.COMPRESS_TEXTURE_ETC1=14]="COMPRESS_TEXTURE_ETC1",d[d.COMPRESS_TEXTURE_ETC=15]="COMPRESS_TEXTURE_ETC",d[d.COMPRESS_TEXTURE_ASTC=16]="COMPRESS_TEXTURE_ASTC",d[d.Texture_SRGB=17]="Texture_SRGB",d[d.MSAA=18]="MSAA",d[d.UnifromBufferObject=19]="UnifromBufferObject",d[d.Texture3D=20]="Texture3D",d[d.Texture_FloatLinearFiltering=21]="Texture_FloatLinearFiltering",d[d.Texture_HalfFloatLinearFiltering=22]="Texture_HalfFloatLinearFiltering";const p=827611204,g=861165636,m=894720068,f=131072;class DDSTextureInfo{constructor(e,t,r,i,a,s,n,o,l,h){this.width=e,this.height=t,this.mipmapCount=r,this.isCube=i,this.blockBytes=s,this.dataOffset=n,this.format=o,this.source=h,this.bpp=a,this.compressed=l}static getDDSTextureInfo(t){let r=new Int32Array(t,0,31),i=r[4],a=r[3],s=1;131072&r[2]&&(s=Math.max(1,r[7]));let n=r[21],o=4==(4&r[20]),l=64==(64&r[20]),h=(r[20]&f)===f,d=512==(512&r[28]),u=n===p||n===g||n===m,c=e.TextureFormat.DXT1,_=r[1]+4,S=1;switch(n){case p:c=e.TextureFormat.DXT1,S=8;break;case g:c=e.TextureFormat.DXT3,S=16;break;case 877942852:case m:c=e.TextureFormat.DXT5,S=16;break;case 113:c=e.TextureFormat.R16G16B16A16,S=4;break;case 116:c=e.TextureFormat.R32G32B32A32,S=4;break;default:throw"Unsupported format "+(y=n,String.fromCharCode(255&y,y>>8&255,y>>16&255,y>>24&255))}var y;if(542327876!==r[0])throw"Invalid magic number in DDS header";if(!o&&!l&&!h)throw"Unsupported format, must contain a FourCC, RGB or LUMINANCE code";let T=LayaGL.renderEngine.getCapable(e.RenderCapable.COMPRESS_TEXTURE_S3TC)||LayaGL.renderEngine.getCapable(e.RenderCapable.COMPRESS_TEXTURE_S3TC_SRGB);if(u&&!T)throw"Compressed textures are not supported on this platform.";return new DDSTextureInfo(i,a,s,d,0,S,_,c,u,t)}}var S;e.TextureDimension=void 0,(S=e.TextureDimension||(e.TextureDimension={}))[S.Tex2D=0]="Tex2D",S[S.Cube=1]="Cube",S[S.Tex3D=2]="Tex3D",S[S.Texture2DArray=3]="Texture2DArray",S[S.CubeArray=4]="CubeArray",S[S.Unkonw=5]="Unkonw",S[S.None=6]="None";const y=6408,T=6407,x=5121;class KTXTextureInfo{constructor(e,t,r,i,a,s,n,o,l,h){this.source=e,this.compress=t,this.sRGB=r,this.dimension=i,this.width=a,this.height=s,this.format=n,this.mipmapCount=o,this.bytesOfKeyValueData=l,this.headerOffset=h}static getLayaFormat(t,r,i,a){if(0!=t){if(t==y&&32856==r&&i==x)return{format:e.TextureFormat.R8G8B8A8,sRGB:!1};if(t==y&&35907==r&&i==x)return{format:e.TextureFormat.R8G8B8A8,sRGB:!0};if(t==y&&34836==r&&5126==i)return{format:e.TextureFormat.R32G32B32A32,sRGB:!1};if(t==y&&34842==r&&5131==i)return{format:e.TextureFormat.R16G16B16A16,sRGB:!1};if(t==T&&34837==r&&5126==i)return{format:e.TextureFormat.R32G32B32,sRGB:!1};if(t==T&&34843==r&&5131==i)return{format:e.TextureFormat.R16G16B16,sRGB:!1};if(t==T&&35905==r&&i==x)return{format:e.TextureFormat.R8G8B8,sRGB:!0};if(t==T&&32849==r&&i==x)return{format:e.TextureFormat.R8G8B8,sRGB:!1};throw"ktx: Unsupported UnCompressed image data."}switch(r){case 36196:return{format:e.TextureFormat.ETC1RGB,sRGB:!1};case 37496:return{format:e.TextureFormat.ETC2RGBA,sRGB:!1};case 37492:return{format:e.TextureFormat.ETC2RGB,sRGB:!1};case 37497:return{format:e.TextureFormat.ETC2SRGB_Alpha8,sRGB:!0};case 37493:return{format:e.TextureFormat.ETC2SRGB,sRGB:!0};case 37808:return{format:e.TextureFormat.ASTC4x4,sRGB:!1};case 37812:return{format:e.TextureFormat.ASTC6x6,sRGB:!1};case 37815:return{format:e.TextureFormat.ASTC8x8,sRGB:!1};case 37819:return{format:e.TextureFormat.ASTC10x10,sRGB:!1};case 37821:return{format:e.TextureFormat.ASTC12x12,sRGB:!1};case 37840:return{format:e.TextureFormat.ASTC4x4SRGB,sRGB:!0};case 37844:return{format:e.TextureFormat.ASTC6x6SRGB,sRGB:!0};case 37847:return{format:e.TextureFormat.ASTC8x8SRGB,sRGB:!0};case 37851:return{format:e.TextureFormat.ASTC10x10SRGB,sRGB:!0};case 37853:return{format:e.TextureFormat.ASTC12x12SRGB,sRGB:!0};default:throw"KTX: UnSupported Compressed format."}}static getKTXTextureInfo(e){let t=new Uint8Array(e,0,12);if(171===t[0]&&75===t[1]&&84===t[2]&&88===t[3]&&32===t[4]&&50===t[5]&&48===t[6]&&187===t[7]&&13===t[8]&&10===t[9]&&26===t[10]&&10===t[11])throw"ktx2 !";if(171===t[0]&&75===t[1]&&84===t[2]&&88===t[3]&&32===t[4]&&49===t[5]&&49===t[6]&&187===t[7]&&13===t[8]&&10===t[9]&&26===t[10]&&10===t[11])return KTXTextureInfo.createKTX1Info(e);throw"ktx data wrong, not ktx1 or ktx2 buffer!"}static createKTX1Info(t){let r=Uint32Array.BYTES_PER_ELEMENT,i=new DataView(t,12,13*r),a=67305985==i.getUint32(0,!0),s=i.getUint32(1*r,a),n=i.getUint32(2*r,a),o=i.getUint32(3*r,a),l=i.getUint32(4*r,a);i.getUint32(5*r,a);let h=i.getUint32(6*r,a),d=i.getUint32(7*r,a);i.getUint32(8*r,a);let u=i.getUint32(9*r,a),c=i.getUint32(10*r,a),_=i.getUint32(11*r,a),p=i.getUint32(12*r,a),g=KTXTextureInfo.getLayaFormat(o,l,s,n),m=g.format,f=g.sRGB,S=e.TextureDimension.Tex2D;c>1&&u>1?S=e.TextureDimension.CubeArray:c>1&&u<=1?S=e.TextureDimension.Cube:c<=1&&u>1&&(S=e.TextureDimension.Texture2DArray);return new KTXTextureInfo(t,0==o,f,S,h,d,m,_||1,p,64)}}class Texture2D extends BaseTexture{constructor(t,r,i,a=!0,s,n=!1,o=!1){super(t,r,i),this._canRead=!1,this._dimension=e.TextureDimension.Tex2D,this._gammaSpace=n,this._canRead=s,this._texture=LayaGL.textureContext.createTextureInternal(this._dimension,t,r,i,a,n,o)}static __init__(){var t=new Uint8Array(4);if(t[0]=128,t[1]=128,t[2]=128,t[3]=255,Texture2D.grayTexture=new Texture2D(1,1,e.TextureFormat.R8G8B8A8,!1,!1),Texture2D.grayTexture.setPixelsData(t,!1,!1),Texture2D.grayTexture.lock=!0,Texture2D.grayTexture.name="Default_Gray",t[0]=255,t[1]=255,t[2]=255,t[3]=255,Texture2D.whiteTexture=new Texture2D(1,1,e.TextureFormat.R8G8B8A8,!1,!1),Texture2D.whiteTexture.setPixelsData(t,!1,!1),Texture2D.whiteTexture.lock=!0,Texture2D.whiteTexture.name="Default_White",t[0]=0,t[1]=0,t[2]=0,t[3]=255,Texture2D.blackTexture=new Texture2D(1,1,e.TextureFormat.R8G8B8A8,!1,!1),Texture2D.blackTexture.setPixelsData(t,!1,!1),Texture2D.blackTexture.lock=!0,Texture2D.blackTexture.name="Default_Black",LayaGL.renderEngine.getCapable(e.RenderCapable.TextureFormat_R16G16B16A16)){let t=new Uint16Array(4);t[0]=14336,t[1]=14336,t[2]=15360,t[3]=15360,Texture2D.normalTexture=new Texture2D(1,1,e.TextureFormat.R16G16B16A16,!1,!1,!1),Texture2D.normalTexture.setPixelsData(t,!1,!1)}else t[0]=128,t[1]=128,t[2]=255,t[3]=255,Texture2D.normalTexture=new Texture2D(1,1,e.TextureFormat.R8G8B8A8,!1,!1,!1),Texture2D.normalTexture.setPixelsData(t,!1,!1);Texture2D.normalTexture.lock=!0,Texture2D.normalTexture.name="Default_Normal",Texture2D.errorTexture=Texture2D.whiteTexture}static _SimpleAnimatorTextureParse(t,r=null,i=null){var a,s,n=new Byte(t);switch(n.readUTFString()){case"LAYAANIMATORTEXTURE:0000":var o,l=n.readInt32(),h=n.readInt32();a=new Float32Array(l*l*4),s=new Float32Array(n.readArrayBuffer(4*h)),a.set(s,0),(o=new Texture2D(l,l,e.TextureFormat.R32G32B32A32,!1,!1)).setPixelsData(a,!1,!1),o.filterMode=e.FilterMode.Point;break;case"LAYACOMPRESSANIMATORTEXTURE:0000":l=n.readInt32(),h=n.readInt32();if(a=new Uint16Array(n.readArrayBuffer(2*h)),LayaGL.renderEngine.getCapable(e.RenderCapable.TextureFormat_R16G16B16A16))(s=new Uint16Array(l*l*4)).set(a,0),(o=new Texture2D(l,l,e.TextureFormat.R16G16B16A16,!1,!1)).setPixelsData(s,!1,!1),o.filterMode=e.FilterMode.Point;else{console.log("The platform does not support 16-bit floating-point textures"),LayaGL.renderEngine.getCapable(e.RenderCapable.TextureFormat_R32G32B32A32)||console.error("The platform does not support 32-bit floating-point textures"),s=new Float32Array(l*l*4);for(var d=0,u=a.length;d<u;d++)s[d]=HalfFloatUtils.convertToNumber(a[d]);(o=new Texture2D(l,l,e.TextureFormat.R32G32B32A32,!1,!1)).setPixelsData(s,!1,!1),o.filterMode=e.FilterMode.Point}break;default:throw"Laya3D:unknow version."}return o}static _parseImage(t,r=null,i=null){let a=i?i[2]:e.TextureFormat.R8G8B8A8,s=!i||i[3],n=!!i&&i[4],o=!!i&&i[5],l=!!r&&r.premultiplyAlpha,h=new Texture2D(t.width,t.height,a,s,n,o,l);return r?(h.setImageData(t,l,!1),h.setProperties(r)):h.setImageData(t,!1,!1),n&&(LayaEnv.isConch&&t._nativeObj?h._pixels=new Uint8Array(t._nativeObj.getImageData(0,0,t.width,t.height)):(ILaya.Browser.canvas.size(t.width,t.height),ILaya.Browser.canvas.clear(),ILaya.Browser.context.drawImage(t,0,0,t.width,t.height),h._pixels=new Uint8Array(ILaya.Browser.context.getImageData(0,0,t.width,t.height).data.buffer))),h}static _parseDDS(e,t=null,r=null){let i=DDSTextureInfo.getDDSTextureInfo(e),a=new Texture2D(i.width,i.height,i.format,i.mipmapCount>1,!1,!1);return a.setDDSData(i),t&&a.setProperties(t),a}static _parseKTX(e,t=null,r=null){let i=KTXTextureInfo.getKTXTextureInfo(e),a=new Texture2D(i.width,i.height,i.format,i.mipmapCount>1,!1,i.sRGB);return a.setKTXData(i),t&&a.setProperties(t),a}static _parsePVR(e,t=null,r=null){throw"pvr !"}static load(e,t){ILaya.loader.load(e,t,null,ILaya.Loader.TEXTURE2D)}setImageData(e,t,r){let i=this._texture;LayaGL.textureContext.setTextureImageData(i,e,t,r)}setPixelsData(e,t,r){let i=this._texture;LayaGL.textureContext.setTexturePixelsData(i,e,t,r)}setSubPixelsData(e,t,r,i,a,s,n,o,l){let h=this._texture;LayaGL.textureContext.setTextureSubPixelsData(h,a,s,n,e,t,r,i,o,l)}setDDSData(e){let t=this._texture;LayaGL.textureContext.setTextureDDSData(t,e)}setKTXData(e){let t=this._texture;LayaGL.textureContext.setTextureKTXData(t,e)}setHDRData(e){let t=this._texture;LayaGL.textureContext.setTextureHDRData(t,e)}get defaultTexture(){return Texture2D.grayTexture}getPixels(){if(this._canRead&&this._pixels)return this._pixels;throw new Error("Texture2D: must set texture canRead is true.")}setProperties(e){e&&(null!=e.wrapModeU&&(this.wrapModeU=e.wrapModeU),null!=e.wrapModeV&&(this.wrapModeV=e.wrapModeV),null!=e.filterMode&&(this.filterMode=e.filterMode),null!=e.anisoLevel&&(this.anisoLevel=e.anisoLevel))}}Texture2D.TEXTURE2D="TEXTURE2D",Texture2D.grayTexture=null,Texture2D.whiteTexture=null,Texture2D.blackTexture=null,Texture2D.normalTexture=null,Texture2D.errorTexture=null;class Color{constructor(e=1,t=1,r=1,i=1){this.r=e,this.g=t,this.b=r,this.a=i}static gammaToLinearSpace(e){return e<=.04045?e/12.92:e<1?Math.pow((e+.055)/1.055,2.4):Math.pow(e,2.4)}static linearToGammaSpace(e){return e<=0?0:e<=.0031308?12.92*e:e<=1?1.055*Math.pow(e,.41666)-.055:Math.pow(e,.41666)}equal(e){if(!e)return!1;const toFIxed=(e,t)=>{var r=1e-5;return-r<e-t&&e-t<r};return toFIxed(e.r,this.r)&&toFIxed(e.g,this.g)&&toFIxed(e.b,this.b)&&toFIxed(e.a,this.a)}toLinear(e){e.r=Color.gammaToLinearSpace(this.r),e.g=Color.gammaToLinearSpace(this.g),e.b=Color.gammaToLinearSpace(this.b),e.a=this.a}toGamma(e){e.r=Color.linearToGammaSpace(this.r),e.g=Color.linearToGammaSpace(this.g),e.b=Color.linearToGammaSpace(this.b),e.a=this.a}cloneTo(e){var t=e;t.r=this.r,t.g=this.g,t.b=this.b,t.a=this.a}scale(e){return this.r=this.r*e,this.g=this.g*e,this.b=this.b*e,this}setValue(e,t,r,i){this.r=e,this.g=t,this.b=r,this.a=i}fromArray(e,t=0){this.r=e[t+0],this.g=e[t+1],this.b=e[t+2],this.a=e[t+3]}toArray(){return[this.r,this.g,this.b,this.a]}clone(){var e=new Color;return this.cloneTo(e),e}}Color.RED=new Color(1,0,0,1),Color.GREEN=new Color(0,1,0,1),Color.BLUE=new Color(0,0,1,1),Color.CYAN=new Color(0,1,1,1),Color.YELLOW=new Color(1,.92,.016,1),Color.MAGENTA=new Color(1,0,1,1),Color.GRAY=new Color(.5,.5,.5,1),Color.WHITE=new Color(1,1,1,1),Color.BLACK=new Color(0,0,0,1),Color.CLEAR=new Color(0,0,0,0);class RenderTexture2D extends BaseTexture{constructor(t,r,i=e.RenderTargetFormat.R8G8B8,a=e.RenderTargetFormat.None){super(t,r,i),this._mgrKey=0,this._invertY=!1,this._colorFormat=i,this._depthStencilFormat=a,0!=t&&0!=r&&this._create(),this.lock=!0}static get currentActive(){return RenderTexture2D._currentActive}get depthStencilFormat(){return this._depthStencilFormat}get defaultTexture(){return Texture2D.grayTexture}getIsReady(){return!0}get sourceWidth(){return this._width}get sourceHeight(){return this._height}get offsetX(){return 0}get offsetY(){return 0}get isCube(){return this._renderTarget._isCube}get samples(){return this._renderTarget._samples}get generateMipmap(){return this._renderTarget._generateMipmap}_start(){throw new Error("Method not implemented.")}_end(){throw new Error("Method not implemented.")}_create(){this._renderTarget=LayaGL.textureContext.createRenderTargetInternal(this.width,this.height,this._colorFormat,this.depthStencilFormat,!1,!1,1),this._texture=this._renderTarget._textures[0],this._texture.gammaCorrection=2.2}clear(e=0,t=0,r=0,i=1){RenderTexture2D._clearColor.r=e,RenderTexture2D._clearColor.g=t,RenderTexture2D._clearColor.b=r,RenderTexture2D._clearColor.a=i,RenderTexture2D._clear=!0}getData(e,t,r,i){return LayaGL.textureContext.getRenderTextureData(this._renderTarget,e,t,r,i)}recycle(){}_disposeResource(){this._renderTarget&&this._renderTarget.dispose()}}var D,v,C,E,R,w,M,b,I;RenderTexture2D._clearColor=new Color(0,0,0,0),RenderTexture2D._clear=!1,RenderTexture2D._clearLinearColor=new Color,RenderTexture2D.defuv=[0,0,1,0,1,1,0,1],RenderTexture2D.flipyuv=[0,1,1,1,1,0,0,0],e.RenderParams=void 0,(D=e.RenderParams||(e.RenderParams={}))[D.Max_Active_Texture_Count=0]="Max_Active_Texture_Count",D[D.Max_Uniform_Count=1]="Max_Uniform_Count",D[D.Max_AnisoLevel_Count=2]="Max_AnisoLevel_Count",D[D.MAX_Texture_Size=3]="MAX_Texture_Size",D[D.MAX_Texture_Image_Uint=4]="MAX_Texture_Image_Uint",D[D.SHADER_CAPAILITY_LEVEL=5]="SHADER_CAPAILITY_LEVEL",D[D.FLOAT=6]="FLOAT",D[D.UNSIGNED_BYTE=7]="UNSIGNED_BYTE",D[D.BYTE=8]="BYTE",D[D.UNSIGNED_SHORT=9]="UNSIGNED_SHORT";class VertexElementFormat{static __init__(){VertexElementFormat._elementInfos={single:[1,LayaGL.renderEngine.getParams(e.RenderParams.FLOAT),0],vector2:[2,LayaGL.renderEngine.getParams(e.RenderParams.FLOAT),0],vector3:[3,LayaGL.renderEngine.getParams(e.RenderParams.FLOAT),0],vector4:[4,LayaGL.renderEngine.getParams(e.RenderParams.FLOAT),0],color:[4,LayaGL.renderEngine.getParams(e.RenderParams.FLOAT),0],byte4:[4,LayaGL.renderEngine.getParams(e.RenderParams.UNSIGNED_BYTE),0],byte3:[3,LayaGL.renderEngine.getParams(e.RenderParams.UNSIGNED_BYTE),0],byte2:[2,LayaGL.renderEngine.getParams(e.RenderParams.UNSIGNED_BYTE),0],byte:[1,LayaGL.renderEngine.getParams(e.RenderParams.UNSIGNED_BYTE),0],short2:[2,LayaGL.renderEngine.getParams(e.RenderParams.UNSIGNED_SHORT),0],short4:[4,LayaGL.renderEngine.getParams(e.RenderParams.UNSIGNED_SHORT),0],normalizedshort2:[2,LayaGL.renderEngine.getParams(e.RenderParams.UNSIGNED_SHORT),1],normalizedshort4:[4,LayaGL.renderEngine.getParams(e.RenderParams.UNSIGNED_SHORT),1],halfvector2:[2,LayaGL.renderEngine.getParams(e.RenderParams.FLOAT),0],halfvector4:[4,LayaGL.renderEngine.getParams(e.RenderParams.FLOAT),0],nbyte4:[4,LayaGL.renderEngine.getParams(e.RenderParams.BYTE),1],ubyte4:[4,LayaGL.renderEngine.getParams(e.RenderParams.UNSIGNED_BYTE),1]}}static getElementInfos(e){var t=VertexElementFormat._elementInfos[e];if(t)return t;throw"VertexElementFormat: this vertexElementFormat is not implement."}}VertexElementFormat.Single="single",VertexElementFormat.Vector2="vector2",VertexElementFormat.Vector3="vector3",VertexElementFormat.Vector4="vector4",VertexElementFormat.Color="color",VertexElementFormat.Byte4="byte4",VertexElementFormat.Byte3="byte3",VertexElementFormat.Byte2="byte2",VertexElementFormat.ByteOne="byte",VertexElementFormat.Short2="short2",VertexElementFormat.Short4="short4",VertexElementFormat.NormalizedShort2="normalizedshort2",VertexElementFormat.NormalizedShort4="normalizedshort4",VertexElementFormat.HalfVector2="halfvector2",VertexElementFormat.HalfVector4="halfvector4",VertexElementFormat.NorByte4="nbyte4",VertexElementFormat.NorUByte4="ubyte4";class VertexStateContext{}class VertexDeclaration{constructor(e,t){this._id=++VertexDeclaration._uniqueIDCounter,this._vertexElementsDic={},this._vertexStride=e,this._vertexElements=t,this._VAElements=[];var r=t.length;this._shaderValues={};for(var i=0;i<r;i++){var a=t[i],s=a._elementUsage;this._vertexElementsDic[s]=a;var n=new VertexStateContext,o=VertexElementFormat.getElementInfos(a._elementFormat);n.elementString=a._elementFormat,n.elementCount=o[0],n.elementType=o[1],n.normalized=o[2],n.vertexStride=this._vertexStride,n.elementOffset=a._offset,this._shaderValues[s]=n,this._VAElements.push({format:a._elementFormat,stride:a._offset,shaderLocation:s})}}get id(){return this._id}get vertexStride(){return this._vertexStride}get vertexElementCount(){return this._vertexElements.length}getVertexElementByIndex(e){return this._vertexElements[e]}getVertexElementByUsage(e){return this._vertexElementsDic[e]}}VertexDeclaration._uniqueIDCounter=1;class VertexElement{constructor(e,t,r){this._offset=e,this._elementFormat=t,this._elementUsage=r}get offset(){return this._offset}get elementFormat(){return this._elementFormat}get elementUsage(){return this._elementUsage}}class Mesh2D{constructor(e,t,r){this._stride=0,this._vertNum=0,this._indexNum=0,this._stride=e,this._VBBuff=new ArrayBuffer(t||32),this._IBBuff=new ArrayBuffer(r||8),this.onVBRealloc(this._VBBuff),this.onIBRealloc(this._IBBuff)}get vbBuffer(){return this._VBBuff}get ibBuffer(){return this._IBBuff}get indexNum(){return this._indexNum}get vertexNum(){return this._vertNum}clearMesh(){this._vertNum=0,this._indexNum=0}expVBSize(e){if(e){let t=this._vertNum*this._stride;if(t+e>this._VBBuff.byteLength){let r=this._VBBuff;this._VBBuff=new ArrayBuffer(t+8*e),new Uint8Array(this._VBBuff,0,t).set(new Uint8Array(r,0,t)),this.onVBRealloc(this._VBBuff)}}}expIBSize(e){if(e){let t=2*this._indexNum;if(t+e>this._IBBuff.byteLength){let r=this._IBBuff;this._IBBuff=new ArrayBuffer(t+8*e),new Uint8Array(this._IBBuff,0,t).set(new Uint8Array(r,0,t)),this.onIBRealloc(this._IBBuff)}}}}class MeshQuadTexture extends Mesh2D{constructor(e=4){super(MeshQuadTexture.const_stride,e,4),this._curVBPos=0}static __int__(){MeshQuadTexture._fixib=function(e){let t=new Byte(6*e*2),r=new Uint16Array(t.buffer);for(var i=0,a=0,s=0;s<e;s++)r[i++]=a,r[i++]=a+2,r[i++]=a+1,r[i++]=a,r[i++]=a+3,r[i++]=a+2,a+=4;return r}(MeshQuadTexture._maxIB),MeshQuadTexture.VertexDeclarition=new VertexDeclaration(48,[new VertexElement(0,VertexElementFormat.Vector4,0),new VertexElement(16,VertexElementFormat.Vector4,1),new VertexElement(32,VertexElementFormat.Vector4,2)])}onVBRealloc(e){this._vbFloat32Array=new Float32Array(e)}onIBRealloc(e){}addQuad(e,t,r,i){this.expVBSize(MeshQuadTexture.const_stride);var a=this._vbFloat32Array;let s=(r>>>16&255)/255,n=(r>>>8&255)/255,o=(255&r)/255,l=(r>>>24)/255;var h=this._curVBPos,d=i?1:0;a[h++]=e[0],a[h++]=e[1],a[h++]=t[0],a[h++]=t[1],a[h++]=o,a[h++]=n,a[h++]=s,a[h++]=l,a[h++]=d,h+=3,a[h++]=e[2],a[h++]=e[3],a[h++]=t[2],a[h++]=t[3],a[h++]=o,a[h++]=n,a[h++]=s,a[h++]=l,a[h++]=d,h+=3,a[h++]=e[4],a[h++]=e[5],a[h++]=t[4],a[h++]=t[5],a[h++]=o,a[h++]=n,a[h++]=s,a[h++]=l,a[h++]=d,h+=3,a[h++]=e[6],a[h++]=e[7],a[h++]=t[6],a[h++]=t[7],a[h++]=o,a[h++]=n,a[h++]=s,a[h++]=l,a[h++]=d,h+=3,this._curVBPos=h,this._vertNum+=4,this._indexNum+=6}clearMesh(){super.clearMesh(),this._curVBPos=0}get ibBuffer(){return MeshQuadTexture._fixib.buffer}get vertexDeclarition(){return MeshQuadTexture.VertexDeclarition}}MeshQuadTexture.const_stride=48,MeshQuadTexture._maxIB=16384;class Filter{constructor(){this.left=0,this.top=0,this.width=0,this.height=0;let e=this._rectMesh=new MeshQuadTexture;e.addQuad([0,0,1,0,1,1,0,1],[0,0,1,0,1,1,0,1],4294967295,!0),this._rectMeshVB=new Float32Array(e.vbBuffer)}set render2D(e){this._render2D=e}get type(){return-1}}Filter.COLOR=32,Filter._filter=function(e,t,r,i){var a=this._next;if(!a)return;var s=e.filters,n=s.length;if(1==n&&s[0].type==Filter.COLOR)return t.save(),t.setColorFilter(s[0]),a._fun.call(a,e,t,r,i),void t.restore();let o=e._getCacheStyle();if(this._renderNextToCacheRT(e,t)){let e=o.renderTexture,r=e,i=e.width,a=e.height,h=t.render2D.out;for(let o=0;o<n;o++){e=r;var l=s[o];l._render2D=t.render2D,l.render(e,i,a),i=l.width,a=l.height,r=l.texture}t.render2D.setRenderTarget(h),o.renderTexture=r,o.renderTexOffx=s[n-1].top,o.renderTexOffy=s[n-1].left}o.renderTexture&&t._drawRenderTexture(o.renderTexture,r+o.renderTexOffx,i+o.renderTexOffy,o.renderTexture.width,o.renderTexture.height,null,1,RenderTexture2D.defuv)},e.GPUEngineStatisticsInfo=void 0,(v=e.GPUEngineStatisticsInfo||(e.GPUEngineStatisticsInfo={}))[v.C_UniformBufferUploadCount=0]="C_UniformBufferUploadCount",v[v.C_GeometryBufferUploadCount=1]="C_GeometryBufferUploadCount",v[v.C_TriangleCount=2]="C_TriangleCount",v[v.C_SetRenderPassCount=3]="C_SetRenderPassCount",v[v.C_DrawCallCount=4]="C_DrawCallCount",v[v.C_Instancing_DrawCallCount=5]="C_Instancing_DrawCallCount",v[v.C_ShaderCompile=6]="C_ShaderCompile",v[v.T_ShaderCompile=7]="T_ShaderCompile",v[v.FrameClearCount=8]="FrameClearCount",v[v.M_GPUMemory=9]="M_GPUMemory",v[v.M_GPUBuffer=10]="M_GPUBuffer",v[v.M_VertexBuffer=11]="M_VertexBuffer",v[v.M_IndexBuffer=12]="M_IndexBuffer",v[v.M_UniformBlockBuffer=13]="M_UniformBlockBuffer",v[v.RC_GPUBuffer=14]="RC_GPUBuffer",v[v.RC_VertexBuffer=15]="RC_VertexBuffer",v[v.RC_IndexBuffer=16]="RC_IndexBuffer",v[v.RC_UniformBlockBuffer=17]="RC_UniformBlockBuffer",v[v.M_ALLTexture=18]="M_ALLTexture",v[v.M_Texture2D=19]="M_Texture2D",v[v.M_TextureCube=20]="M_TextureCube",v[v.M_Texture3D=21]="M_Texture3D",v[v.M_Texture2DArray=22]="M_Texture2DArray",v[v.RC_ALLTexture=23]="RC_ALLTexture",v[v.RC_Texture2D=24]="RC_Texture2D",v[v.RC_TextureCube=25]="RC_TextureCube",v[v.RC_Texture3D=26]="RC_Texture3D",v[v.RC_Texture2DArray=27]="RC_Texture2DArray",v[v.M_ALLRenderTexture=28]="M_ALLRenderTexture",v[v.RC_ALLRenderTexture=29]="RC_ALLRenderTexture",v[v.Count=30]="Count";class Browser{static __init__(){var e;let t=window.Laya||ILaya.Laya;if(Browser._window)return Browser._window;let r,i=Browser._window=window,a=Browser._document=i.document,s=Browser.userAgent=i.navigator.userAgent,n=i.navigator.maxTouchPoints||0,o=i.navigator.platform;window.conch&&"conchUseWXAdapter"in Browser.window&&(r=["wxMiniGame","MiniAdpter","wx"]),"my"in Browser.window&&(s.indexOf("TB/")>-1||s.indexOf("Taobao/")>-1||s.indexOf("TM/")>-1?r=["tbMiniGame","TBMiniAdapter","my"]:s.indexOf("AlipayMiniGame")>-1&&(r=["aliPayMiniGame","ALIMiniAdapter","my"])),(-1==s.indexOf("OPPO")&&s.indexOf("MiniGame")>-1||-1!=s.indexOf("runtime")||-1!=s.indexOf("miniprogram")&&window.isWXMiMi)&&"wx"in Browser.window&&(r="tt"in Browser.window?["ttMiniGame","TTMiniAdapter","tt"]:"bl"in Browser.window?["biliMiniGame","BLMiniAdapter",null]:"qq"in Browser.window?["qqMiniGame","QQMiniAdapter",null]:["wxMiniGame","MiniAdpter","wx"]),"hbs"in Browser.window&&(r=["hwMiniGame","HWMiniAdapter",null]),s.indexOf("SwanGame")>-1&&(r=["bdMiniGame","BMiniAdapter",null]),s.indexOf("QuickGame")>-1&&(r=["miMiniGame","KGMiniAdapter","qg"]),s.indexOf("OPPO")>-1&&s.indexOf("MiniGame")>-1&&(r=["qgMiniGame","QGMiniAdapter","qg"],Config.fixedFrames=!1),s.indexOf("VVGame")>-1&&(r=["vvMiniGame","VVMiniAdapter","qg"],Config.fixedFrames=!1),null!=r&&(Browser.window[r[0]](t,t),t[r[1]].enable(),Browser.miniGameContext=Browser.window[r[2]]),i.trace=console.log,i.requestAnimationFrame=i.requestAnimationFrame||i.webkitRequestAnimationFrame||i.mozRequestAnimationFrame||i.oRequestAnimationFrame||i.msRequestAnimationFrame||function(e){return i.setTimeout(e,1e3/60)};var l=a.body.style;l.margin=0,l.overflow="hidden",l["-webkit-user-select"]="none",l["-webkit-tap-highlight-color"]="rgba(200,200,200,0)";var h=a.getElementsByTagName("meta");let d,u={width:"device-width","initial-scale":"1.0","minimum-scale":"1.0","maximum-scale":"1.0","user-scalable":"no"};for(const e of h)if("viewport"==e.name){d=e;break}if(d){let e=(d.content||"").split(",");for(let t of e){let e=t.split("=");u[e[0].trim()]||(u[e[0]]=e[1])}}else d=a.createElement("meta"),d.name="viewport",null===(e=a.getElementsByTagName("head")[0])||void 0===e||e.appendChild(d);return d.content=Object.keys(u).map((e=>e+"="+u[e])),Browser.onMobile=!!window.conch||s.indexOf("Mobile")>-1,Browser.onIOS=!!s.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),Browser.onIPhone=s.indexOf("iPhone")>-1,Browser.onMac=s.indexOf("Mac OS X")>-1,Browser.onIPad=s.indexOf("iPad")>-1||"MacIntel"===o&&n>1,Browser.onAndroid=s.indexOf("Android")>-1||s.indexOf("Adr")>-1,Browser.onWP=s.indexOf("Windows Phone")>-1,Browser.onQQBrowser=s.indexOf("QQBrowser")>-1,Browser.onMQQBrowser=s.indexOf("MQQBrowser")>-1||s.indexOf("Mobile")>-1&&s.indexOf("QQ")>-1,Browser.onIE=!!i.ActiveXObject||"ActiveXObject"in i,Browser.onWeiXin=s.indexOf("MicroMessenger")>-1,Browser.onSafari=s.indexOf("Safari")>-1&&-1===s.indexOf("Chrome"),Browser.onChrome=s.indexOf("Chrome")>-1,Browser.onPC=!Browser.onMobile,Browser.onFirefox=s.indexOf("Firefox")>-1,Browser.onEdge=s.indexOf("Edge")>-1||s.indexOf("Edg")>-1,Browser.onMiniGame=s.indexOf("MiniGame")>-1,Browser.onBDMiniGame=s.indexOf("SwanGame")>-1,Browser.onLayaRuntime=!!window.conch,s.indexOf("OPPO")>-1&&s.indexOf("MiniGame")>-1?(Browser.onQGMiniGame=!0,Browser.onMiniGame=!1):"qq"in Browser.window&&s.indexOf("MiniGame")>-1?(Browser.onQQMiniGame=!0,Browser.onMiniGame=!1):"bl"in Browser.window&&s.indexOf("MiniGame")>-1?(Browser.onBLMiniGame=!0,Browser.onMiniGame=!1):"tt"in Browser.window&&s.indexOf("MiniGame")>-1&&(Browser.onTTMiniGame=!0,Browser.onMiniGame=!1),Browser.onHWMiniGame="hbs"in Browser.window,Browser.onVVMiniGame=s.indexOf("VVGame")>-1,Browser.onKGMiniGame=s.indexOf("QuickGame")>-1,s.indexOf("AlipayMiniGame")>-1&&(Browser.onAlipayMiniGame=!0,Browser.onMiniGame=!1),(s.indexOf("TB/")>-1||s.indexOf("Taobao/")>-1||s.indexOf("TM/")>-1)&&(Browser.onTBMiniGame=!0),(Browser.onAndroid||Browser.onIOS)&&(!o||-1==o.indexOf("Win")&&-1==o.indexOf("Mac"))?Browser.onAndroid?Browser.platform=Browser.PLATFORM_ANDROID:Browser.platform=Browser.PLATFORM_IOS:Browser.platform=Browser.PLATFORM_PC,i}static get _isMiniGame(){return Browser.onMiniGame||Browser.onBDMiniGame||Browser.onQGMiniGame||Browser.onKGMiniGame||Browser.onVVMiniGame||Browser.onAlipayMiniGame||Browser.onQQMiniGame||Browser.onBLMiniGame||Browser.onTTMiniGame||Browser.onHWMiniGame||Browser.onTBMiniGame||Browser.window&&Browser.window.isWXMiMi}static createElement(e){return Browser.__init__(),Browser._document.createElement(e)}static getElementById(e){return Browser.__init__(),Browser._document.getElementById(e)}static removeElement(e){e&&e.parentNode&&e.parentNode.removeChild(e)}static now(){return Date.now()}static get clientWidth(){return Browser.__init__(),Browser._clientWidth||Browser._window.innerWidth||Browser._document.body.clientWidth}static set clientWidth(e){Browser._clientWidth=e}static get clientHeight(){return Browser.__init__(),Browser._clientHeight||Browser._window.innerHeight||Browser._document.body.clientHeight||Browser._document.documentElement.clientHeight}static set clientHeight(e){Browser._clientHeight=e}static get width(){return Browser.__init__(),(ILaya.stage&&ILaya.stage.canvasRotation?Browser.clientHeight:Browser.clientWidth)*Browser.pixelRatio}static get height(){return Browser.__init__(),(ILaya.stage&&ILaya.stage.canvasRotation?Browser.clientWidth:Browser.clientHeight)*Browser.pixelRatio}static get pixelRatio(){return Browser._pixelRatio<0&&(Browser.__init__(),Browser.userAgent.indexOf("Mozilla/6.0(Linux; Android 6.0; HUAWEI NXT-AL10 Build/HUAWEINXT-AL10)")>-1?Browser._pixelRatio=2:(Browser._pixelRatio=Browser._window.devicePixelRatio||1,Browser._pixelRatio<1&&(Browser._pixelRatio=1))),Browser._pixelRatio}static get container(){return Browser._container||(Browser.__init__(),Browser._container=Browser.createElement("div"),Browser._container.id="layaContainer",Browser._document.body.appendChild(Browser._container)),Browser._container}static set container(e){Browser._container=e}static get window(){return Browser._window||Browser.__init__()}static get document(){return Browser.__init__(),Browser._document}static getQueryString(e){if(Browser.onMiniGame)return null;if(!window.location||!window.location.search)return null;var t=new RegExp("(^|&)"+e+"=([^&]*)(&|$)"),r=window.location.search.substring(1).match(t);return null!=r?unescape(r[2]):null}static getSafariToolbarOffset(){return(Browser.window.__innerHeight||Browser.document.body.clientHeight||Browser.document.documentElement.clientHeight)-Browser.window.innerHeight}static loadLib(e){return new Promise(((t,r)=>{let i=Browser.document.createElement("script");i.onload=function(){t()},i.onerror=function(){r(`load ${e} failed`)},i.src=e,Browser.document.body.appendChild(i)}))}}Browser.PLATFORM_PC=0,Browser.PLATFORM_ANDROID=1,Browser.PLATFORM_IOS=2,Browser._pixelRatio=-1,Browser.mainCanvas=null,Browser.hanzi=new RegExp("^[一-龥]$"),Browser.fontMap={},Browser.measureText=function(e,t){let r=Browser.hanzi.test(e);if(r&&Browser.fontMap[t])return Browser.fontMap[t];let i=Browser.context;i.font=t;let a=i.measureText(e);return r&&(Browser.fontMap[t]=a),a};class Stat{static show(e,t,r){Stat.checkUI()&&(this.hide(),Stat._show=!0,LayaGL.renderEngine._enableStatistics=!0,Stat._currentShowArray=r||Stat.AllShow,Stat._statUI.show(e,t,Stat._currentShowArray),ILaya.systemTimer.frameLoop(1,null,Stat.loop))}static showToggle(e,t,r){Stat.checkUI()&&(this.hide(),Stat._show=!0,Stat._currentToggleArray=r,Stat._statUI.showToggle(e,t,r),ILaya.systemTimer.frameLoop(1,null,Stat.loop))}static checkUI(){if(!Stat._statUI){let e=ClassUtils.getClass("StatUI");if(!e)return console.error("StatUI not found"),!1;Stat._statUI=new e}return!0}static hide(){Stat._show&&(Stat._show=!1,Stat._currentShowArray=null,Stat._currentToggleArray=null,ILaya.systemTimer.clear(null,Stat.loop),Stat._statUI&&Stat._statUI.hide())}static loop(){Stat._count++;let e=Browser.now();if(e-Stat._timer<1e3)return;let t=Stat._count;if(Stat.FPS=Math.round(1e3*t/(e-Stat._timer)),Stat._show){Stat.updateEngineData();let e=Stat.FPS>0?Math.floor(1e3/Stat.FPS).toString():" ";Stat._fpsStr=Stat.FPS+(Stat.renderSlow?" slow":"")+" "+e+"ms",Stat._statUI.update(),Stat.clear()}Stat._count=0,Stat._timer=e}static updateEngineData(){Stat.trianglesFaces=LayaGL.renderEngine.getStatisticsInfo(e.GPUEngineStatisticsInfo.C_TriangleCount),Stat.drawCall=LayaGL.renderEngine.getStatisticsInfo(e.GPUEngineStatisticsInfo.C_DrawCallCount),Stat.instanceDrawCall=LayaGL.renderEngine.getStatisticsInfo(e.GPUEngineStatisticsInfo.C_Instancing_DrawCallCount),Stat.gpuMemory=LayaGL.renderEngine.getStatisticsInfo(e.GPUEngineStatisticsInfo.M_GPUMemory),Stat.textureMemory=LayaGL.renderEngine.getStatisticsInfo(e.GPUEngineStatisticsInfo.M_ALLTexture),Stat.renderTextureMemory=LayaGL.renderEngine.getStatisticsInfo(e.GPUEngineStatisticsInfo.RC_ALLRenderTexture),Stat.bufferMemory=LayaGL.renderEngine.getStatisticsInfo(e.GPUEngineStatisticsInfo.M_GPUBuffer)}static clear(){Stat._currentShowArray&&(Stat._currentShowArray.forEach((e=>{"average"==e.mode&&(Stat[e.value]=0)})),LayaGL.renderEngine.clearStatisticsInfo())}static render(e,t,r){Stat._show&&Stat._statUI.render(e,t,r)}}Stat.FPSStatUIParams={title:"FPS",value:"_fpsStr",color:"yellow",units:"int",mode:"summit"},Stat.NodeStatUIParams={title:"Node",value:"spriteCount",color:"white",units:"int",mode:"summit"},Stat.Sprite3DStatUIParams={title:"Sprite3D",value:"sprite3DCount",color:"white",units:"int",mode:"summit"},Stat.DrawCall={title:"DrawCall",value:"drawCall",color:"white",units:"int",mode:"average"},Stat.TriangleFace={title:"TriangleFace",value:"trianglesFaces",color:"white",units:"int",mode:"average"},Stat.RenderNode={title:"RenderNode",value:"renderNode",color:"white",units:"int",mode:"summit"},Stat.SkinRenderNode={title:"SkinRenderNode",value:"skinRenderNode",color:"white",units:"int",mode:"summit"},Stat.ParticleRenderNode={title:"ParticleRenderNode",value:"particleRenderNode",color:"white",units:"int",mode:"summit"},Stat.FrustumCulling={title:"FrustumCulling",value:"frustumCulling",color:"white",units:"int",mode:"average"},Stat.UniformUpload={title:"UniformUpload",value:"uniformUpload",color:"white",units:"int",mode:"average"},Stat.OpaqueDrawCall={title:"OpaqueDrawCall",value:"opaqueDrawCall",color:"white",units:"int",mode:"average"},Stat.TransDrawCall={title:"TransDrawCall",value:"transDrawCall",color:"white",units:"int",mode:"average"},Stat.DepthCastDrawCall={title:"DepthCastDrawCall",value:"depthCastDrawCall",color:"white",units:"int",mode:"average"},Stat.InstanceDrawCall={title:"InstanceDrawCall",value:"instanceDrawCall",color:"white",units:"int",mode:"average"},Stat.CMDDrawCall={title:"CMDDrawCall",value:"cmdDrawCall",color:"white",units:"int",mode:"average"},Stat.BlitDrawCall={title:"BlitDrawCall",value:"blitDrawCall",color:"white",units:"int",mode:"average"},Stat.GPUMemory={title:"GPUMemory",value:"gpuMemory",color:"white",units:"M",mode:"summit"},Stat.TextureMemeory={title:"TextureMemory",value:"textureMemory",color:"white",units:"M",mode:"summit"},Stat.RenderTextureMemory={title:"RenderTextureMemory",value:"renderTextureMemory",color:"white",units:"M",mode:"summit"},Stat.BufferMemory={title:"BufferMemory",value:"bufferMemory",color:"white",units:"M",mode:"summit"},Stat.uploadUniformNum={title:"UploadUniformNum",value:"uploadUniform",color:"white",units:"int",mode:"average"},Stat.AllShow=[Stat.FPSStatUIParams,Stat.NodeStatUIParams,Stat.Sprite3DStatUIParams,Stat.DrawCall,Stat.TriangleFace,Stat.RenderNode,Stat.SkinRenderNode,Stat.ParticleRenderNode,Stat.FrustumCulling,Stat.OpaqueDrawCall,Stat.TransDrawCall,Stat.DepthCastDrawCall,Stat.InstanceDrawCall,Stat.CMDDrawCall,Stat.BlitDrawCall,Stat.GPUMemory,Stat.TextureMemeory,Stat.RenderTextureMemory,Stat.BufferMemory,Stat.uploadUniformNum],Stat.memoryShow=[Stat.GPUMemory,Stat.TextureMemeory,Stat.RenderTextureMemory,Stat.BufferMemory],Stat.renderShow=[Stat.DrawCall,Stat.TriangleFace,Stat.OpaqueDrawCall,Stat.TransDrawCall,Stat.DepthCastDrawCall,Stat.InstanceDrawCall,Stat.CMDDrawCall,Stat.BlitDrawCall],Stat.toogle_Shadow={title:"Shadow",value:"enableShadow",color:"white"},Stat.toogle_MulLight={title:"MulLight",value:"enableMulLight",color:"white"},Stat.toogle_Light={title:"Light",value:"enableLight",color:"white"},Stat.toogle_Postprocess={title:"Postprocess",value:"enablePostprocess",color:"white"},Stat.toogle_AnimatorUpdate={title:"AnimatorUpdate",value:"enableAnimatorUpdate",color:"white"},Stat.toogle_PhysicsUpdate={title:"PhysicsUpdate",value:"enablePhysicsUpdate",color:"white"},Stat.toogle_Skin={title:"Skin",value:"enableSkin",color:"white"},Stat.toogle_Transparent={title:"Transparent",value:"enableTransparent",color:"white"},Stat.toogle_Particle={title:"Particle",value:"enableParticle",color:"white"},Stat.toogle_msaa={title:"MSAA",value:"enablemsaa",color:"white"},Stat.toogle_CameraCMD={title:"CameraCMD",value:"enableCameraCMD",color:"white"},Stat.toogle_Opaque={title:"Opaque",value:"enableOpaque",color:"white"},Stat.AllToggle=[Stat.toogle_Shadow,Stat.toogle_Light,Stat.toogle_MulLight,Stat.toogle_Postprocess,Stat.toogle_AnimatorUpdate,Stat.toogle_PhysicsUpdate,Stat.toogle_Opaque,Stat.toogle_Transparent,Stat.toogle_CameraCMD,Stat.toogle_Skin,Stat.toogle_Particle,Stat.toogle_msaa],Stat.RenderModeToggle=[Stat.toogle_Shadow,Stat.toogle_Light,Stat.toogle_MulLight,Stat.toogle_Postprocess,Stat.toogle_AnimatorUpdate,Stat.toogle_PhysicsUpdate],Stat.RenderFuncToggle=[Stat.toogle_Opaque,Stat.toogle_Transparent,Stat.toogle_CameraCMD,Stat.toogle_Skin,Stat.toogle_Particle,Stat.toogle_msaa],Stat.FPS=0,Stat.loopCount=0,Stat.spriteRenderUseCacheCount=0,Stat.canvasNormal=0,Stat.canvasBitmap=0,Stat.canvasReCache=0,Stat.renderSlow=!1,Stat._timer=0,Stat._count=0,Stat._fpsStr="",Stat.spriteCount=0,Stat.sprite3DCount=0,Stat.drawCall=0,Stat.draw2D=0,Stat.trianglesFaces=0,Stat.renderNode=0,Stat.meshRenderNode=0,Stat.skinRenderNode=0,Stat.particleRenderNode=0,Stat.frustumCulling=0,Stat.uniformUpload=0,Stat.opaqueDrawCall=0,Stat.transDrawCall=0,Stat.depthCastDrawCall=0,Stat.instanceDrawCall=0,Stat.cmdDrawCall=0,Stat.blitDrawCall=0,Stat.textureMemory=0,Stat.renderTextureMemory=0,Stat.bufferMemory=0,Stat.uploadUniform=0,Stat.enableShadow=!0,Stat.enableMulLight=!0,Stat.enableLight=!0,Stat.enableCameraCMD=!0,Stat.enablePostprocess=!0,Stat.enableSkin=!0,Stat.enableTransparent=!0,Stat.enableParticle=!0,Stat.enableAnimatorUpdate=!0,Stat.enablePhysicsUpdate=!0,Stat.enablemsaa=!0,Stat.enableOpaque=!0,window.Stat=Stat,e.BlendEquationSeparate=void 0,(C=e.BlendEquationSeparate||(e.BlendEquationSeparate={}))[C.ADD=0]="ADD",C[C.SUBTRACT=1]="SUBTRACT",C[C.REVERSE_SUBTRACT=2]="REVERSE_SUBTRACT",C[C.MIN=3]="MIN",C[C.MAX=4]="MAX",e.BlendFactor=void 0,(E=e.BlendFactor||(e.BlendFactor={}))[E.Zero=0]="Zero",E[E.One=1]="One",E[E.SourceColor=2]="SourceColor",E[E.OneMinusSourceColor=3]="OneMinusSourceColor",E[E.DestinationColor=4]="DestinationColor",E[E.OneMinusDestinationColor=5]="OneMinusDestinationColor",E[E.SourceAlpha=6]="SourceAlpha",E[E.OneMinusSourceAlpha=7]="OneMinusSourceAlpha",E[E.DestinationAlpha=8]="DestinationAlpha",E[E.OneMinusDestinationAlpha=9]="OneMinusDestinationAlpha",E[E.SourceAlphaSaturate=10]="SourceAlphaSaturate",E[E.BlendColor=11]="BlendColor",E[E.OneMinusBlendColor=12]="OneMinusBlendColor",e.BlendType=void 0,(R=e.BlendType||(e.BlendType={}))[R.BLEND_DISABLE=0]="BLEND_DISABLE",R[R.BLEND_ENABLE_ALL=1]="BLEND_ENABLE_ALL",R[R.BLEND_ENABLE_SEPERATE=2]="BLEND_ENABLE_SEPERATE",e.CompareFunction=void 0,(w=e.CompareFunction||(e.CompareFunction={}))[w.Never=0]="Never",w[w.Less=1]="Less",w[w.Equal=2]="Equal",w[w.LessEqual=3]="LessEqual",w[w.Greater=4]="Greater",w[w.NotEqual=5]="NotEqual",w[w.GreaterEqual=6]="GreaterEqual",w[w.Always=7]="Always",w[w.Off=8]="Off",e.CullMode=void 0,(M=e.CullMode||(e.CullMode={}))[M.Off=0]="Off",M[M.Front=1]="Front",M[M.Back=2]="Back",e.FrontFace=void 0,(b=e.FrontFace||(e.FrontFace={}))[b.CW=0]="CW",b[b.CCW=1]="CCW",e.StencilOperation=void 0,(I=e.StencilOperation||(e.StencilOperation={}))[I.Keep=0]="Keep",I[I.Zero=1]="Zero",I[I.Replace=2]="Replace",I[I.IncrementSaturate=3]="IncrementSaturate",I[I.DecrementSaturate=4]="DecrementSaturate",I[I.Invert=5]="Invert",I[I.IncrementWrap=6]="IncrementWrap",I[I.DecrementWrap=7]="DecrementWrap";class MathUtils3D{constructor(){}static isZero(e){return Math.abs(e)<MathUtils3D.zeroTolerance}static nearEqual(e,t){return!!MathUtils3D.isZero(e-t)}static fastInvSqrt(e){return MathUtils3D.isZero(e)?e:1/Math.sqrt(e)}}MathUtils3D.zeroTolerance=1e-6,MathUtils3D.MaxValue=340282347e30,MathUtils3D.MinValue=-340282347e30,MathUtils3D.Deg2Rad=Math.PI/180;class Vector4{constructor(e=0,t=0,r=0,i=0){this.x=e,this.y=t,this.z=r,this.w=i}setValue(e,t,r,i){this.x=e,this.y=t,this.z=r,this.w=i}fromArray(e,t=0){this.x=e[t+0],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3]}toArray(){return[this.x,this.y,this.z,this.w]}writeTo(e,t=0){e[t+0]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w}cloneTo(e){var t=e;t.x=this.x,t.y=this.y,t.z=this.z,t.w=this.w}clone(){var e=new Vector4;return this.cloneTo(e),e}static lerp(e,t,r,i){var a=e.x,s=e.y,n=e.z,o=e.w;i.x=a+r*(t.x-a),i.y=s+r*(t.y-s),i.z=n+r*(t.z-n),i.w=o+r*(t.w-o)}static transformByM4x4(e,t,r){var i=e.x,a=e.y,s=e.z,n=e.w,o=t.elements;r.x=i*o[0]+a*o[4]+s*o[8]+n*o[12],r.y=i*o[1]+a*o[5]+s*o[9]+n*o[13],r.z=i*o[2]+a*o[6]+s*o[10]+n*o[14],r.w=i*o[3]+a*o[7]+s*o[11]+n*o[15]}static equals(e,t){return MathUtils3D.nearEqual(Math.abs(e.x),Math.abs(t.x))&&MathUtils3D.nearEqual(Math.abs(e.y),Math.abs(t.y))&&MathUtils3D.nearEqual(Math.abs(e.z),Math.abs(t.z))&&MathUtils3D.nearEqual(Math.abs(e.w),Math.abs(t.w))}equal(e){return Vector4.equals(this,e)}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}static normalize(e,t){var r=e.length();if(r>0){var i=1/r;t.x=e.x*i,t.y=e.y*i,t.z=e.z*i,t.w=e.w*i}}static add(e,t,r){r.x=e.x+t.x,r.y=e.y+t.y,r.z=e.z+t.z,r.w=e.w+t.w}static subtract(e,t,r){r.x=e.x-t.x,r.y=e.y-t.y,r.z=e.z-t.z,r.w=e.w-t.w}static multiply(e,t,r){r.x=e.x*t.x,r.y=e.y*t.y,r.z=e.z*t.z,r.w=e.w*t.w}static scale(e,t,r){r.x=e.x*t,r.y=e.y*t,r.z=e.z*t,r.w=e.w*t}static Clamp(e,t,r,i){var a=e.x,s=e.y,n=e.z,o=e.w,l=t.x,h=t.y,d=t.z,u=t.w,c=r.x,_=r.y,p=r.z,g=r.w;a=(a=a>c?c:a)<l?l:a,s=(s=s>_?_:s)<h?h:s,n=(n=n>p?p:n)<d?d:n,o=(o=o>g?g:o)<u?u:o,i.x=a,i.y=s,i.z=n,i.w=o}static distanceSquared(e,t){var r=e.x-t.x,i=e.y-t.y,a=e.z-t.z,s=e.w-t.w;return r*r+i*i+a*a+s*s}static distance(e,t){var r=e.x-t.x,i=e.y-t.y,a=e.z-t.z,s=e.w-t.w;return Math.sqrt(r*r+i*i+a*a+s*s)}static dot(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}static min(e,t,r){r.x=Math.min(e.x,t.x),r.y=Math.min(e.y,t.y),r.z=Math.min(e.z,t.z),r.w=Math.min(e.w,t.w)}static max(e,t,r){r.x=Math.max(e.x,t.x),r.y=Math.max(e.y,t.y),r.z=Math.max(e.z,t.z),r.w=Math.max(e.w,t.w)}}Vector4.ZERO=new Vector4,Vector4.ONE=new Vector4(1,1,1,1),Vector4.UnitX=new Vector4(1,0,0,0),Vector4.UnitY=new Vector4(0,1,0,0),Vector4.UnitZ=new Vector4(0,0,1,0),Vector4.UnitW=new Vector4(0,0,0,1),Vector4.tempVec4=new Vector4(0,0,0,0);class Vector3{constructor(e=0,t=0,r=0){this.x=e,this.y=t,this.z=r}static distanceSquared(e,t){var r=e.x-t.x,i=e.y-t.y,a=e.z-t.z;return r*r+i*i+a*a}static distance(e,t){var r=e.x-t.x,i=e.y-t.y,a=e.z-t.z;return Math.sqrt(r*r+i*i+a*a)}static min(e,t,r){r.x=Math.min(e.x,t.x),r.y=Math.min(e.y,t.y),r.z=Math.min(e.z,t.z)}static max(e,t,r){r.x=Math.max(e.x,t.x),r.y=Math.max(e.y,t.y),r.z=Math.max(e.z,t.z)}static transformQuat(e,t,r){var i=e.x,a=e.y,s=e.z,n=t.x,o=t.y,l=t.z,h=t.w,d=h*i+o*s-l*a,u=h*a+l*i-n*s,c=h*s+n*a-o*i,_=-n*i-o*a-l*s;r.x=d*h+_*-n+u*-l-c*-o,r.y=u*h+_*-o+c*-n-d*-l,r.z=c*h+_*-l+d*-o-u*-n}static scalarLength(e){var t=e.x,r=e.y,i=e.z;return Math.sqrt(t*t+r*r+i*i)}static scalarLengthSquared(e){var t=e.x,r=e.y,i=e.z;return t*t+r*r+i*i}static normalize(e,t){var r=e.x,i=e.y,a=e.z,s=r*r+i*i+a*a;s>0&&(s=1/Math.sqrt(s),t.x=r*s,t.y=i*s,t.z=a*s)}static multiply(e,t,r){r.x=e.x*t.x,r.y=e.y*t.y,r.z=e.z*t.z}static scale(e,t,r){r.x=e.x*t,r.y=e.y*t,r.z=e.z*t}static lerp(e,t,r,i){var a=e.x,s=e.y,n=e.z;i.x=a+r*(t.x-a),i.y=s+r*(t.y-s),i.z=n+r*(t.z-n)}static transformV3ToV3(e,t,r){var i=Vector3._tempVector4;Vector3.transformV3ToV4(e,t,i),r.x=i.x,r.y=i.y,r.z=i.z}static transformV3ToV4(e,t,r){var i=e.x,a=e.y,s=e.z,n=t.elements;r.x=i*n[0]+a*n[4]+s*n[8]+n[12],r.y=i*n[1]+a*n[5]+s*n[9]+n[13],r.z=i*n[2]+a*n[6]+s*n[10]+n[14],r.w=i*n[3]+a*n[7]+s*n[11]+n[15]}static TransformNormal(e,t,r){var i=e.x,a=e.y,s=e.z,n=t.elements;r.x=i*n[0]+a*n[4]+s*n[8],r.y=i*n[1]+a*n[5]+s*n[9],r.z=i*n[2]+a*n[6]+s*n[10]}static transformCoordinate(e,t,r){var i=e.x,a=e.y,s=e.z,n=t.elements,o=i*n[3]+a*n[7]+s*n[11]+n[15];r.x=(i*n[0]+a*n[4]+s*n[8]+n[12])/o,r.y=(i*n[1]+a*n[5]+s*n[9]+n[13])/o,r.z=(i*n[2]+a*n[6]+s*n[10]+n[14])/o}static Clamp(e,t,r,i){var a=e.x,s=e.y,n=e.z,o=t.x,l=t.y,h=t.z,d=r.x,u=r.y,c=r.z;a=(a=a>d?d:a)<o?o:a,s=(s=s>u?u:s)<l?l:s,n=(n=n>c?c:n)<h?h:n,i.x=a,i.y=s,i.z=n}static add(e,t,r){r.x=e.x+t.x,r.y=e.y+t.y,r.z=e.z+t.z}static subtract(e,t,r){r.x=e.x-t.x,r.y=e.y-t.y,r.z=e.z-t.z}static cross(e,t,r){var i=e.x,a=e.y,s=e.z,n=t.x,o=t.y,l=t.z;r.x=a*l-s*o,r.y=s*n-i*l,r.z=i*o-a*n}static dot(e,t){return e.x*t.x+e.y*t.y+e.z*t.z}static equals(e,t){return MathUtils3D.nearEqual(e.x,t.x)&&MathUtils3D.nearEqual(e.y,t.y)&&MathUtils3D.nearEqual(e.z,t.z)}equal(e){return Vector3.equals(this,e)}setValue(e,t,r){return this.x=e,this.y=t,this.z=r,this}set(e,t,r){return this.x=e,this.y=t,this.z=r,this}fromArray(e,t=0){this.x=e[t+0],this.y=e[t+1],this.z=e[t+2]}toArray(){return[this.x,this.y,this.z]}writeTo(e,t=0){e[t+0]=this.x,e[t+1]=this.y,e[t+2]=this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z}vsub(e,t){return t.x=this.x-e.x,t.y=this.y-e.y,t.z=this.z-e.z,t}vadd(e,t){return t.x=this.x+e.x,t.y=this.y+e.y,t.z=this.z+e.z,t}scale(e,t){return t.x=this.x*e,t.y=this.y*e,t.z=this.z*e,t}normalize(){let e=this.x,t=this.y,r=this.z;var i=e*e+t*t+r*r;return i>0&&(i=1/Math.sqrt(i),this.x=e*i,this.y=t*i,this.z=r*i),this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}cross(e,t){var r=this.x,i=this.y,a=this.z,s=e.x,n=e.y,o=e.z;return t.x=i*o-a*n,t.y=a*s-r*o,t.z=r*n-i*s,t}cloneTo(e){var t=e;t.x=this.x,t.y=this.y,t.z=this.z}clone(){var e=new Vector3;return this.cloneTo(e),e}toDefault(){this.x=0,this.y=0,this.z=0}}Vector3._tempVector4=new Vector4,Vector3._tempVector3=new Vector3,Vector3.ZERO=new Vector3(0,0,0),Vector3.ONE=new Vector3(1,1,1),Vector3.NegativeUnitX=new Vector3(-1,0,0),Vector3.UnitX=new Vector3(1,0,0),Vector3.UnitY=new Vector3(0,1,0),Vector3.UnitZ=new Vector3(0,0,1),Vector3.ForwardRH=new Vector3(0,0,-1),Vector3.ForwardLH=new Vector3(0,0,1),Vector3.Up=new Vector3(0,1,0);class RenderState{constructor(){this._stencilOp=new Vector3,this.createObj(),this.cull=RenderState.CULL_BACK,this.blend=RenderState.BLEND_DISABLE,this.srcBlend=RenderState.BLENDPARAM_ONE,this.dstBlend=RenderState.BLENDPARAM_ZERO,this.srcBlendRGB=RenderState.BLENDPARAM_ONE,this.dstBlendRGB=RenderState.BLENDPARAM_ZERO,this.srcBlendAlpha=RenderState.BLENDPARAM_ONE,this.dstBlendAlpha=RenderState.BLENDPARAM_ZERO,this.blendEquation=RenderState.BLENDEQUATION_ADD,this.blendEquationRGB=RenderState.BLENDEQUATION_ADD,this.blendEquationAlpha=RenderState.BLENDEQUATION_ADD,this.depthTest=RenderState.DEPTHTEST_LEQUAL,this.depthWrite=!0,this.stencilRef=1,this.stencilTest=RenderState.STENCILTEST_OFF,this.stencilWrite=!1,this.stencilOp=new Vector3(RenderState.STENCILOP_KEEP,RenderState.STENCILOP_KEEP,RenderState.STENCILOP_REPLACE)}get cull(){return this._cull}set cull(e){this._cull=e}get blend(){return this._blend}set blend(e){this._blend=e}get srcBlend(){return this._srcBlend}set srcBlend(e){this._srcBlend=e}get dstBlend(){return this._dstBlend}set dstBlend(e){this._dstBlend=e}get srcBlendRGB(){return this._srcBlendRGB}set srcBlendRGB(e){this._srcBlendRGB=e}get dstBlendRGB(){return this._dstBlendRGB}set dstBlendRGB(e){this._dstBlendRGB=e}get srcBlendAlpha(){return this._srcBlendAlpha}set srcBlendAlpha(e){this._srcBlendAlpha=e}get dstBlendAlpha(){return this._dstBlendAlpha}set dstBlendAlpha(e){this._dstBlendAlpha=e}get blendEquation(){return this._blendEquation}set blendEquation(e){this._blendEquation=e}get blendEquationRGB(){return this._blendEquationRGB}set blendEquationRGB(e){this._blendEquationRGB=e}get blendEquationAlpha(){return this._blendEquationAlpha}set blendEquationAlpha(e){this._blendEquationAlpha=e}get depthTest(){return this._depthTest}set depthTest(e){this._depthTest=e}get depthWrite(){return this._depthWrite}set depthWrite(e){this._depthWrite=e}get stencilWrite(){return this._stencilWrite}set stencilWrite(e){this._stencilWrite=e}get stencilTest(){return this._stencilTest}set stencilTest(e){this._stencilTest=e}get stencilRef(){return this._stencilRef}set stencilRef(e){this._stencilRef=e}get stencilOp(){return this._stencilOp}set stencilOp(e){this._stencilOp=e}createObj(){}setNull(){this.cull=null,this.blend=null,this.srcBlend=null,this.dstBlend=null,this.srcBlendRGB=null,this.dstBlendRGB=null,this.srcBlendAlpha=null,this.dstBlendAlpha=null,this.blendEquation=null,this.blendEquationRGB=null,this.blendEquationAlpha=null,this.depthTest=null,this.depthWrite=null,this.stencilRef=null,this.stencilTest=null,this.stencilWrite=null,this.stencilOp.set(null,null,null)}cloneTo(e){e.cull=this.cull,e.blend=this.blend,e.srcBlend=this.srcBlend,e.dstBlend=this.dstBlend,e.srcBlendRGB=this.srcBlendRGB,e.dstBlendRGB=this.dstBlendRGB,e.srcBlendAlpha=this.srcBlendAlpha,e.dstBlendAlpha=this.dstBlendAlpha,e.blendEquation=this.blendEquation,e.blendEquationRGB=this.blendEquationRGB,e.blendEquationAlpha=this.blendEquationAlpha,e.depthTest=this.depthTest,e.depthWrite=this.depthWrite,e.stencilRef=this.stencilRef,e.stencilTest=this.stencilTest,e.stencilWrite=this.stencilWrite,this.stencilOp.cloneTo(e.stencilOp)}clone(){var e=new RenderState;return this.cloneTo(e),e}}RenderState.CULL_NONE=e.CullMode.Off,RenderState.CULL_FRONT=e.CullMode.Front,RenderState.CULL_BACK=e.CullMode.Back,RenderState.BLEND_DISABLE=e.BlendType.BLEND_DISABLE,RenderState.BLEND_ENABLE_ALL=e.BlendType.BLEND_ENABLE_ALL,RenderState.BLEND_ENABLE_SEPERATE=e.BlendType.BLEND_ENABLE_SEPERATE,RenderState.BLENDPARAM_ZERO=e.BlendFactor.Zero,RenderState.BLENDPARAM_ONE=e.BlendFactor.One,RenderState.BLENDPARAM_SRC_COLOR=e.BlendFactor.SourceColor,RenderState.BLENDPARAM_ONE_MINUS_SRC_COLOR=e.BlendFactor.OneMinusSourceColor,RenderState.BLENDPARAM_DST_COLOR=e.BlendFactor.DestinationColor,RenderState.BLENDPARAM_ONE_MINUS_DST_COLOR=e.BlendFactor.OneMinusDestinationColor,RenderState.BLENDPARAM_SRC_ALPHA=e.BlendFactor.SourceAlpha,RenderState.BLENDPARAM_ONE_MINUS_SRC_ALPHA=e.BlendFactor.OneMinusSourceAlpha,RenderState.BLENDPARAM_DST_ALPHA=e.BlendFactor.DestinationAlpha,RenderState.BLENDPARAM_ONE_MINUS_DST_ALPHA=e.BlendFactor.OneMinusDestinationAlpha,RenderState.BLENDPARAM_SRC_ALPHA_SATURATE=e.BlendFactor.SourceAlphaSaturate,RenderState.BLENDPARAM_BLENDCOLOR=e.BlendFactor.BlendColor,RenderState.BLENDPARAM_BLEND_ONEMINUS_COLOR=e.BlendFactor.OneMinusBlendColor,RenderState.BLENDEQUATION_ADD=e.BlendEquationSeparate.ADD,RenderState.BLENDEQUATION_SUBTRACT=e.BlendEquationSeparate.SUBTRACT,RenderState.BLENDEQUATION_REVERSE_SUBTRACT=e.BlendEquationSeparate.REVERSE_SUBTRACT,RenderState.BLENDEQUATION_MIN=e.BlendEquationSeparate.MIN,RenderState.BLENDEQUATION_MAX=e.BlendEquationSeparate.MAX,RenderState.DEPTHTEST_OFF=e.CompareFunction.Off,RenderState.DEPTHTEST_NEVER=e.CompareFunction.Never,RenderState.DEPTHTEST_LESS=e.CompareFunction.Less,RenderState.DEPTHTEST_EQUAL=e.CompareFunction.Equal,RenderState.DEPTHTEST_LEQUAL=e.CompareFunction.LessEqual,RenderState.DEPTHTEST_GREATER=e.CompareFunction.Greater,RenderState.DEPTHTEST_NOTEQUAL=e.CompareFunction.NotEqual,RenderState.DEPTHTEST_GEQUAL=e.CompareFunction.GreaterEqual,RenderState.DEPTHTEST_ALWAYS=e.CompareFunction.Always,RenderState.STENCILTEST_OFF=e.CompareFunction.Off,RenderState.STENCILTEST_NEVER=e.CompareFunction.Never,RenderState.STENCILTEST_LESS=e.CompareFunction.Less,RenderState.STENCILTEST_EQUAL=e.CompareFunction.Equal,RenderState.STENCILTEST_LEQUAL=e.CompareFunction.LessEqual,RenderState.STENCILTEST_GREATER=e.CompareFunction.Greater,RenderState.STENCILTEST_NOTEQUAL=e.CompareFunction.NotEqual,RenderState.STENCILTEST_GEQUAL=e.CompareFunction.GreaterEqual,RenderState.STENCILTEST_ALWAYS=e.CompareFunction.Always,RenderState.STENCILOP_KEEP=e.StencilOperation.Keep,RenderState.STENCILOP_ZERO=e.StencilOperation.Zero,RenderState.STENCILOP_REPLACE=e.StencilOperation.Replace,RenderState.STENCILOP_INCR=e.StencilOperation.IncrementSaturate,RenderState.STENCILOP_INCR_WRAP=e.StencilOperation.IncrementWrap,RenderState.STENCILOP_DECR=e.StencilOperation.DecrementSaturate,RenderState.STENCILOP_DECR_WRAP=e.StencilOperation.DecrementWrap,RenderState.STENCILOP_INVERT=e.StencilOperation.Invert,RenderState.Default=new RenderState;class AssetDb{constructor(){this.uuidMap={},this.shaderNameMap={},this.metaMap={}}UUID_to_URL(e){return this.uuidMap[e]}UUID_to_URL_async(e){return Promise.resolve(null)}URL_to_UUID_async(e){return Promise.resolve(null)}resolveURL(e,t){if(e.startsWith("res://")){let r=e.substring(6);return AssetDb.inst.UUID_to_URL_async(r).then((e=>(t&&t(e),e)))}return t&&t(e),Promise.resolve(e)}shaderName_to_URL(e){return this.shaderNameMap[e]}shaderName_to_URL_async(e){return Promise.resolve(null)}getMeta(e,t){return Promise.resolve(null)}getSubAssetURL(e,t,r,i){return r?`${Utils.replaceFileExtension(e,"")}@${r}.${i}`:e}}AssetDb.inst=new AssetDb;class URL{constructor(e){this._url=URL.formatURL(e),this._path=URL.getPath(e)}static __init__(){URL.rootPath=URL.basePath=location&&null!=location.protocol&&""!=location.protocol?URL.getPath(location.protocol+"//"+location.host+location.pathname):""}static initMiniGameExtensionOverrides(){LayaEnv.isPreview||(URL.overrideExtension(["rendertexture","videotexture"],"rt.json"),URL.overrideExtension(["controller"],"controller.json"),URL.overrideExtension(["mc"],"mc.bin"),URL.overrideExtension(["mcc"],"mcc.json"),URL.overrideExtension(["shader"],"shader.json"),URL.overrideExtension(["scene3d","scene","taa","prefab"],"json"),URL.overrideExtension(["fui"],"fui.json"),URL.overrideExtension(["glsl"],"glsl.txt"),URL.overrideExtension(["skel"],"skel.bin"))}get url(){return this._url}get path(){return this._path}static formatURL(e,t){if(!e)return t||URL.basePath||"";if(e.startsWith("res://")){let t=e.substring(6),r=AssetDb.inst.UUID_to_URL(t);if(!r)return e;e=r}let r=e.charCodeAt(0);if(-1==e.indexOf(":")&&47!==r){null!=URL.customFormat&&(e=URL.customFormat(e));let i=URL.version[e];if(null!=i){let t=e.lastIndexOf(".");e=e.substring(0,t)+"-"+i+e.substring(t)}if(126===r)e=URL.join(URL.rootPath,e.substring(2));else{if(null==t){t=URL.basePath;for(let r in URL.basePaths)if(e.startsWith(r)){t=URL.basePaths[r];break}}e=URL.join(t,e)}}return e}static postFormatURL(e){if(URL.hasExtOverrides){let t=Utils.getFileExtension(e),r=URL.overrideFileExts[t];null!=r&&(e=Utils.replaceFileExtension(e,r))}return e}static normalize(e){if(-1==e.indexOf("./"))return e;let t=e.split("/"),r=t.length,i=0;for(;i<r;)if("."!=t[i]){if(".."==t[i]){let e=i-1;if(e>=0&&".."!==t[e]){t.splice(e,2),r-=2,i--;continue}}i++}else t.splice(i,1),r--;return t.length=r,t.join("/")}static getResURLByUUID(e){return e.length>=36&&45===e.charCodeAt(8)&&45===e.charCodeAt(13)?"res://"+e:e}static join(e,t){if(!t)return"";if(t.indexOf(":")>0)return t;if(e){let r=t.charCodeAt(0);126!==r&&47!==r&&(t=47!==e.charCodeAt(e.length-1)?e+"/"+t:e+t)}return URL.normalize(t)}static getPath(e){var t=e.lastIndexOf("/");return t>0?e.substring(0,t+1):""}static getFileName(e){var t=e.lastIndexOf("/");return t>0?e.substring(t+1):e}static getURLVerion(e){var t=e.indexOf("?");return t>=0?e.substring(t):null}static overrideExtension(e,t){for(let r of e)URL.overrideFileExts[r]=t;URL.hasExtOverrides=!0}}URL.version={},URL.basePath="",URL.basePaths={},URL.rootPath="",URL.overrideFileExts={},URL.customFormat=function(e){return e};class IncludeFile{constructor(e){this.codes={},this.funs={},this.curUseID=-1,this.funnames="",this.script=e;for(var t,r,i=0;!((i=e.indexOf("#begin",i))<0);){for(r=i+5;!((r=e.indexOf("#end",r))<0)&&"i"===e.charAt(r+4);)r+=5;if(r<0)throw"add include err,no #end:"+e;t=e.indexOf("\n",i);var a=IncludeFile.splitToWords(e.substr(i,t-i),null);"code"==a[1]?this.codes[a[2]]=e.substr(t+1,r-t-1):"function"==a[1]&&(t=e.indexOf("function",i),t+="function".length,this.funs[a[3]]=e.substr(t+1,r-t-1),this.funnames+=a[3]+";"),i=r+1}}static splitToWords(e,t){for(var r,i,a=[],s=-1,n=0,o=e.length;n<o;n++)if(r=e.charAt(n)," \t=+-*/&%!<>()'\",;".indexOf(r)>=0){if(s>=0&&n-s>1&&(i=e.substr(s,n-s),a.push(i)),'"'==r||"'"==r){var l=e.indexOf(r,n+1);if(l<0)throw"Sharder err:"+e;a.push(e.substr(n+1,l-n-1)),n=l,s=-1;continue}"("==r&&t&&a.length>0&&(i=a[a.length-1]+";","vec4;main;".indexOf(i)<0&&(t.useFuns+=i)),s=-1}else s<0&&(s=n);return s<o&&o-s>1&&(i=e.substr(s,o-s),a.push(i)),a}getWith(e=null){var t=e?this.codes[e]:this.script;if(!t)throw"get with error:"+e;return t}getFunsScript(e){var t="";for(var r in this.funs)e.indexOf(r+";")>=0&&(t+=this.funs[r]);return t}}class ShaderNode{constructor(e){this.childs=[],this.text="",this.useFuns="",this.z=0,this.includefiles=e}setParent(e){e.childs.push(this),this.z=e.z+1,this.parent=e}setCondition(e,t){e&&(this.conditionType=t,e=e.replace(/(\s*$)/g,""),this.condition=function(){return this[e]},this.condition.__condition=e)}toscript(e,t){return this._toscript(e,t,++ShaderNode.__id)}_toscript(e,t,r){if(this.childs.length<1&&!this.text)return t;if(t.length,this.condition){var i=!!this.condition.call(e);if(2===this.conditionType&&(i=!i),!i&&ShaderNode.__noCompileEnable)return t}if(!this.noCompile&&ShaderNode.__noCompileEnable||this.text&&t.push(this.text),this.childs.length>0&&this.childs.forEach((function(i,a,s){i._toscript(e,t,r)})),this.includefiles.length>0&&this.useFuns.length>0)for(var a,s=0,n=this.includefiles.length;s<n;s++)this.includefiles[s].curUseID!=r&&(a=this.includefiles[s].file.getFunsScript(this.useFuns)).length>0&&(this.includefiles[s].curUseID=r,t[0]=a+t[0]);return t}}ShaderNode.__id=1,ShaderNode.__noCompileEnable=!0;const L=new RegExp("\r","g"),A=new RegExp("[ \\t=\\+\\-*/&%!<>!%(),;\\|]","g"),B={Back:e.CullMode.Back,Front:e.CullMode.Front,Off:e.CullMode.Off},P={Disable:e.BlendType.BLEND_DISABLE,All:e.BlendType.BLEND_ENABLE_ALL,Seperate:e.BlendType.BLEND_ENABLE_SEPERATE},N={Zero:e.BlendFactor.Zero,One:e.BlendFactor.One,SourceColor:e.BlendFactor.SourceColor,OneMinusSourceColor:e.BlendFactor.OneMinusSourceColor,DestinationColor:e.BlendFactor.DestinationColor,OneMinusDestinationColor:e.BlendFactor.OneMinusDestinationColor,SourceAlpha:e.BlendFactor.SourceAlpha,OneMinusSourceAlpha:e.BlendFactor.OneMinusSourceAlpha,DestinationAlpha:e.BlendFactor.DestinationAlpha,OneMinusDestinationAlpha:e.BlendFactor.OneMinusDestinationAlpha,SourceAlphaSaturate:e.BlendFactor.SourceAlphaSaturate,BlendColor:e.BlendFactor.BlendColor,OneMinusBlendColor:e.BlendFactor.OneMinusBlendColor},F={Add:e.BlendEquationSeparate.ADD,Subtract:e.BlendEquationSeparate.SUBTRACT,Reverse_substract:e.BlendEquationSeparate.REVERSE_SUBTRACT,Min:e.BlendEquationSeparate.MIN,Max:e.BlendEquationSeparate.MAX},U={Never:e.CompareFunction.Never,Less:e.CompareFunction.Less,Equal:e.CompareFunction.Equal,LessEqual:e.CompareFunction.LessEqual,Greater:e.CompareFunction.Greater,NotEqual:e.CompareFunction.NotEqual,GreaterEqual:e.CompareFunction.GreaterEqual,Always:e.CompareFunction.Always,Off:e.CompareFunction.Off},O={Keep:e.StencilOperation.Keep,Zero:e.StencilOperation.Zero,Replace:e.StencilOperation.Replace,IncrementSaturate:e.StencilOperation.IncrementSaturate,DecrementSaturate:e.StencilOperation.DecrementSaturate,Invert:e.StencilOperation.Invert,IncrementWrap:e.StencilOperation.IncrementWrap,DecrementWrap:e.StencilOperation.DecrementWrap};class ShaderCompile{static addInclude(e,t,r){if(!t||0===t.length)return console.error("shader include file err:"+e),null;if(!r&&ShaderCompile.includes[e])return console.warn("shader include file already exists:"+e),ShaderCompile.includes[e];t=t.replace(L,"");let i=new IncludeFile(t);return ShaderCompile.includes[e]=i,i}static compile(e,t,r){let i={vsNode:new ShaderNode([]),psNode:new ShaderNode([]),includeNames:new Set,defs:new Set},a=[];e=e.replace(L,""),t=t.replace(L,""),ShaderCompile._compileToTree(i.vsNode,e,i.defs,a,r),ShaderCompile._compileToTree(i.psNode,t,i.defs,a,r);for(let e of a)e.file?i.includeNames.add(e.name):console.warn(`ShaderCompile missing file ${e.name}`);return i}static compileAsync(e,t,r){let i={vsNode:new ShaderNode([]),psNode:new ShaderNode([]),includeNames:new Set,defs:new Set},a=[];return e=e.replace(L,""),t=t.replace(L,""),ShaderCompile._compileToTree(i.vsNode,e,i.defs,a,r),ShaderCompile._compileToTree(i.psNode,t,i.defs,a,r),this._loadIncludesDeep(i,a,0)}static _loadIncludesDeep(e,t,r){let i,a=t.length;for(let s=r;s<a;s++){let r=t[s];r.file?e.includeNames.add(r.name):(i||(i=[]),i.push(r))}return i?ILaya.loader.load(i.map((e=>e.name))).then((r=>{let s=i.length;for(let a=0;a<s;a++){let s=i[a],n=r[a];if(n){e.includeNames.add(s.name);let r=n.getWith(s.codeName);s.node.condition?s.node.text=r:(ShaderCompile._compileToTree(s.node,r,e.defs,t,URL.getPath(s.name)),s.node.text="")}else{let e=s.node.parent.childs;e.splice(e.indexOf(s.node),1)}}return t.length>a?ShaderCompile._loadIncludesDeep(e,t,a):e})):Promise.resolve(e)}static _compileToTree(e,t,r,i,a){let s,n,o,l,h,d,u,c,_,p,g=t.split("\n");for(c=0;c<g.length;c++)if(o=g[c],!(o.length<1)&&(d=o.indexOf("//"),0!==d))if(d>=0&&(o=o.substr(0,d)),(d=o.indexOf("#"))<0){n=e.childs[e.childs.length-1];let t=e.includefiles;if(n&&!n.name){t.length>0&&IncludeFile.splitToWords(o,n),n.text+="\n"+o;continue}s=new ShaderNode(t),s.text=o,s.noCompile=!0,t.length>0&&IncludeFile.splitToWords(o,s),s.setParent(e)}else{for(s=new ShaderNode(e.includefiles),s.text=o,s.noCompile=!0,l="#",p=d+1,_=o.length;p<_;p++){let e=o.charAt(p);if(" "===e||"\t"===e||"?"===e)break;l+=e}switch(s.name=l,l){case"#ifdef":case"#ifndef":for(s.src=o,s.noCompile=null!=o.match(/[!&|()=<>]/),s.noCompile?console.log("function():Boolean{return "+o.substr(d+s.name.length)+"}"):(u=o.replace(/^\s*/,"").split(/\s+/),s.setCondition(u[1],"#ifdef"===l?ShaderCompile.IFDEF_YES:ShaderCompile.IFDEF_ELSE),s.text=s.text),s.setParent(e),e=s,u=o.substr(p).split(A),p=0;p<u.length;p++)o=u[p],o.length&&r.add(o);break;case"#if":case"#elif":for(s.src=o,s.noCompile=!0,"#elif"==l&&(n=(e=e.parent).childs[e.childs.length-1],n.text=n.src,n.noCompile=!0,n.condition=null),s.setParent(e),e=s,u=o.substr(p).split(A),p=0;p<u.length;p++)o=u[p],o.length&&"defined"!=o&&r.add(o);break;case"#else":s.src=o,n=(e=e.parent).childs[e.childs.length-1],s.noCompile=n.noCompile,s.noCompile||(s.condition=n.condition,s.conditionType=n.conditionType==ShaderCompile.IFDEF_YES?ShaderCompile.IFDEF_ELSE:ShaderCompile.IFDEF_YES),s.setParent(e),e=s;break;case"#endif":n=(e=e.parent).childs[e.childs.length-1],s.noCompile=n.noCompile,s.noCompile||(s.text=s.text),s.setParent(e);break;case"#include":u=IncludeFile.splitToWords(o,null);let t,c=u[1];c.startsWith(".")?c=URL.join(a,c):c.startsWith("/")?c=URL.formatURL(c.substring(1)):(t=ShaderCompile.includes[c],t||(c="internal/"+c)),t=ShaderCompile.includes[c],!t&&ShaderCompile.loadIncludeFileSync&&(ShaderCompile.loadIncludeFileSync(c),t=ShaderCompile.includes[c]);let _="with"==u[2]?u[3]:null;i.push({name:c,codeName:_,node:s,file:t}),s.setParent(e),(d=u[0].indexOf("?"))<0?(t&&(o=t.getWith(_),this._compileToTree(s,o,r,i,URL.getPath(c))),s.text=""):(s.setCondition(u[0].substr(d+1),ShaderCompile.IFDEF_YES),t&&(s.text=t.getWith(_)));break;case"#import":u=IncludeFile.splitToWords(o,null),h=u[1],s.includefiles.push({node:s,file:ShaderCompile.includes[h],ofs:s.text.length});break;default:s.setParent(e)}}}static getRenderState(e,t){if(!e)return;t.cull=B[e.cull],t.blend=P[e.blend],t.srcBlend=N[e.srcBlend],t.dstBlend=N[e.dstBlend],t.srcBlendRGB=N[e.srcBlendRGB],t.dstBlendRGB=N[e.dstBlendRGB],t.srcBlendAlpha=N[e.srcBlendAlpha],t.dstBlendAlpha=N[e.dstBlendAlpha],t.blendEquation=F[e.blendEquation],t.blendEquationRGB=F[e.blendEquationRGB],t.blendEquationAlpha=F[e.blendEquationAlpha],t.depthTest=U[e.depthTest],t.depthWrite=e.depthWrite,t.stencilRef=e.stencilRef,t.stencilTest=U[e.stencilTest],t.stencilWrite=e.stencilWrite;let r=e.stencilOp,i=r?r[0]:null,a=r?r[1]:null,s=r?r[2]:null;t.stencilOp.x=O[i],t.stencilOp.y=O[a],t.stencilOp.z=O[s]}}ShaderCompile.IFDEF_NO=0,ShaderCompile.IFDEF_YES=1,ShaderCompile.IFDEF_ELSE=2,ShaderCompile.IFDEF_PARENT=3,ShaderCompile.includes={};const G=new Float32Array([1,0,0,0,1,0,0,0,1]),V=new Vector3,k=new Vector3,H=new Vector3;class Matrix3x3{constructor(e=!0){e&&(this.elements=G.slice())}static createRotationQuaternion(e,t){var r=e.x,i=e.y,a=e.z,s=e.w,n=r*r,o=i*i,l=a*a,h=r*i,d=a*s,u=a*r,c=i*s,_=i*a,p=r*s,g=t.elements;g[0]=1-2*(o+l),g[1]=2*(h+d),g[2]=2*(u-c),g[3]=2*(h-d),g[4]=1-2*(l+n),g[5]=2*(_+p),g[6]=2*(u+c),g[7]=2*(_-p),g[8]=1-2*(o+n)}static createFromTranslation(e,t){var r=t.elements;r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=1,r[5]=0,r[6]=e.x,r[7]=e.y,r[8]=1}static createFromRotation(e,t){var r=t.elements,i=Math.sin(e),a=Math.cos(e);r[0]=a,r[1]=i,r[2]=0,r[3]=-i,r[4]=a,r[5]=0,r[6]=0,r[7]=0,r[8]=1}static createFromScaling(e,t){var r=t.elements;r[0]=e.x,r[1]=0,r[2]=0,r[3]=0,r[4]=e.y,r[5]=0,r[6]=0,r[7]=0,r[8]=e.z}static createFromMatrix4x4(e,t){var r=e.elements,i=t.elements;i[0]=r[0],i[1]=r[1],i[2]=r[2],i[3]=r[4],i[4]=r[5],i[5]=r[6],i[6]=r[8],i[7]=r[9],i[8]=r[10]}static multiply(e,t,r){var i=e.elements,a=t.elements,s=r.elements,n=i[0],o=i[1],l=i[2],h=i[3],d=i[4],u=i[5],c=i[6],_=i[7],p=i[8],g=a[0],m=a[1],f=a[2],S=a[3],y=a[4],T=a[5],x=a[6],D=a[7],v=a[8];s[0]=g*n+m*h+f*c,s[1]=g*o+m*d+f*D,s[2]=g*l+m*u+f*p,s[3]=S*n+y*h+T*c,s[4]=S*o+y*d+T*_,s[5]=S*l+y*u+T*p,s[6]=x*n+D*h+v*c,s[7]=x*o+D*d+v*_,s[8]=x*l+D*u+v*p}cloneByArray(e){this.elements.set(e)}determinant(){var e=this.elements,t=e[0],r=e[1],i=e[2],a=e[3],s=e[4],n=e[5],o=e[6],l=e[7],h=e[8];return t*(h*s-n*l)+r*(-h*a+n*o)+i*(l*a-s*o)}translate(e,t){var r=t.elements,i=this.elements,a=i[0],s=i[1],n=i[2],o=i[3],l=i[4],h=i[5],d=i[6],u=i[7],c=i[8],_=e.x,p=e.y;r[0]=a,r[1]=s,r[2]=n,r[3]=o,r[4]=l,r[5]=h,r[6]=_*a+p*o+d,r[7]=_*s+p*l+u,r[8]=_*n+p*h+c}rotate(e,t){var r=t.elements,i=this.elements,a=i[0],s=i[1],n=i[2],o=i[3],l=i[4],h=i[5],d=i[6],u=i[7],c=i[8],_=Math.sin(e),p=Math.cos(e);r[0]=p*a+_*o,r[1]=p*s+_*l,r[2]=p*n+_*h,r[3]=p*o-_*a,r[4]=p*l-_*s,r[5]=p*h-_*n,r[6]=d,r[7]=u,r[8]=c}scale(e,t){var r=t.elements,i=this.elements,a=e.x,s=e.y;r[0]=a*i[0],r[1]=a*i[1],r[2]=a*i[2],r[3]=s*i[3],r[4]=s*i[4],r[5]=s*i[5],r[6]=i[6],r[7]=i[7],r[8]=i[8]}invert(e){var t=e.elements,r=this.elements,i=r[0],a=r[1],s=r[2],n=r[3],o=r[4],l=r[5],h=r[6],d=r[7],u=r[8],c=u*o-l*d,_=-u*n+l*h,p=d*n-o*h,g=i*c+a*_+s*p;g&&(g=1/g,t[0]=c*g,t[1]=(-u*a+s*d)*g,t[2]=(l*a-s*o)*g,t[3]=_*g,t[4]=(u*i-s*h)*g,t[5]=(-l*i+s*n)*g,t[6]=p*g,t[7]=(-d*i+a*h)*g,t[8]=(o*i-a*n)*g)}transpose(e){var t=e.elements,r=this.elements;if(e===this){var i=r[1],a=r[2],s=r[5];t[1]=r[3],t[2]=r[6],t[3]=i,t[5]=r[7],t[6]=a,t[7]=s}else t[0]=r[0],t[1]=r[3],t[2]=r[6],t[3]=r[1],t[4]=r[4],t[5]=r[7],t[6]=r[2],t[7]=r[5],t[8]=r[8]}identity(){this.elements.set(G)}cloneTo(e){var t,r;(t=this.elements)!==(r=e.elements)&&r.set(t)}clone(){var e=new Matrix3x3(!1);return e.elements=this.elements.slice(),e}static lookAt(e,t,r,i){Vector3.subtract(e,t,V),Vector3.normalize(V,V),Vector3.cross(r,V,k),Vector3.normalize(k,k),Vector3.cross(V,k,H);var a=V,s=k,n=H,o=i.elements;o[0]=s.x,o[3]=s.y,o[6]=s.z,o[1]=n.x,o[4]=n.y,o[7]=n.z,o[2]=a.x,o[5]=a.y,o[8]=a.z}static forwardLookAt(e,t,r,i){var a=k,s=H,n=V;t.vsub(e,n).normalize(),r.cross(n,a).normalize(),n.cross(a,s);var o=i.elements;o[0]=a.x,o[1]=a.y,o[2]=a.z,o[3]=s.x,o[4]=s.y,o[5]=s.z,o[6]=n.x,o[7]=n.y,o[8]=n.z}}Matrix3x3.DEFAULT=new Matrix3x3,Matrix3x3.Temp=new Matrix3x3;const W=new Vector3,z=new Vector3,X=new Vector3,Y=new Vector3,j=new Matrix3x3;class Quaternion{constructor(e=0,t=0,r=0,i=1){this.x=e,this.y=t,this.z=r,this.w=i}static createFromYawPitchRoll(e,t,r,i){var a=.5*r,s=.5*t,n=.5*e,o=Math.sin(a),l=Math.cos(a),h=Math.sin(s),d=Math.cos(s),u=Math.sin(n),c=Math.cos(n);i.x=c*h*l+u*d*o,i.y=u*d*l-c*h*o,i.z=c*d*o-u*h*l,i.w=c*d*l+u*h*o}static multiply(e,t,r){var i=e.x,a=e.y,s=e.z,n=e.w,o=t.x,l=t.y,h=t.z,d=t.w,u=a*h-s*l,c=s*o-i*h,_=i*l-a*o,p=i*o+a*l+s*h;r.x=i*d+o*n+u,r.y=a*d+l*n+c,r.z=s*d+h*n+_,r.w=n*d-p}static rotationAxisAngle(e,t,r){const i=Vector3._tempVector3;Vector3.normalize(e,i),t*=.5;const a=Math.sin(t);r.x=i.x*a,r.y=i.y*a,r.z=i.z*a,r.w=Math.cos(t)}static arcTanAngle(e,t){return 0==e?1==t?Math.PI/2:-Math.PI/2:e>0?Math.atan(t/e):e<0?t>0?Math.atan(t/e)+Math.PI:Math.atan(t/e)-Math.PI:0}static angleTo(e,t,r){Vector3.subtract(t,e,W),Vector3.normalize(W,W),r.x=Math.asin(W.y),r.y=Quaternion.arcTanAngle(-W.z,-W.x)}static createFromAxisAngle(e,t,r){t*=.5;var i=Math.sin(t);r.x=i*e.x,r.y=i*e.y,r.z=i*e.z,r.w=Math.cos(t)}static createFromMatrix4x4(e,t){var r,i,a=e.elements,s=a[0]+a[5]+a[10];s>0?(r=Math.sqrt(s+1),t.w=.5*r,r=.5/r,t.x=(a[6]-a[9])*r,t.y=(a[8]-a[2])*r,t.z=(a[1]-a[4])*r):a[0]>=a[5]&&a[0]>=a[10]?(i=.5/(r=Math.sqrt(1+a[0]-a[5]-a[10])),t.x=.5*r,t.y=(a[1]+a[4])*i,t.z=(a[2]+a[8])*i,t.w=(a[6]-a[9])*i):a[5]>a[10]?(i=.5/(r=Math.sqrt(1+a[5]-a[0]-a[10])),t.x=(a[4]+a[1])*i,t.y=.5*r,t.z=(a[9]+a[6])*i,t.w=(a[8]-a[2])*i):(i=.5/(r=Math.sqrt(1+a[10]-a[0]-a[5])),t.x=(a[8]+a[2])*i,t.y=(a[9]+a[6])*i,t.z=.5*r,t.w=(a[1]-a[4])*i)}static slerp(e,t,r,i){var a,s,n,o,l,h=e.x,d=e.y,u=e.z,c=e.w,_=t.x,p=t.y,g=t.z,m=t.w;return(s=h*_+d*p+u*g+c*m)<0&&(s=-s,_=-_,p=-p,g=-g,m=-m),1-s>1e-6?(a=Math.acos(s),n=Math.sin(a),o=Math.sin((1-r)*a)/n,l=Math.sin(r*a)/n):(o=1-r,l=r),i.x=o*h+l*_,i.y=o*d+l*p,i.z=o*u+l*g,i.w=o*c+l*m,i}static lerp(e,t,r,i){var a=1-r;Quaternion.dot(e,t)>=0?(i.x=a*e.x+r*t.x,i.y=a*e.y+r*t.y,i.z=a*e.z+r*t.z,i.w=a*e.w+r*t.w):(i.x=a*e.x-r*t.x,i.y=a*e.y-r*t.y,i.z=a*e.z-r*t.z,i.w=a*e.w-r*t.w),i.normalize(i)}static add(e,t,r){r.x=e.x+t.x,r.y=e.y+t.y,r.z=e.z+t.z,r.w=e.w+t.w}static dot(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}setValue(e,t,r,i){this.x=e,this.y=t,this.z=r,this.w=i}set(e,t,r,i){return this.x=e,this.y=t,this.z=r,this.w=i,this}scaling(e,t){t.x=this.x*e,t.y=this.y*e,t.z=this.z*e,t.w=this.w*e}normalize(e){var t=this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w;t>0&&(t=1/Math.sqrt(t),e.x=this.x*t,e.y=this.y*t,e.z=this.z*t,e.w=this.w*t)}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}rotateX(e,t){e*=.5;var r=Math.sin(e),i=Math.cos(e);t.x=this.x*i+this.w*r,t.y=this.y*i+this.z*r,t.z=this.z*i-this.y*r,t.w=this.w*i-this.x*r}rotateY(e,t){e*=.5;var r=Math.sin(e),i=Math.cos(e);t.x=this.x*i-this.z*r,t.y=this.y*i+this.w*r,t.z=this.z*i+this.x*r,t.w=this.w*i-this.y*r}rotateZ(e,t){e*=.5;var r=Math.sin(e),i=Math.cos(e);t.x=this.x*i+this.y*r,t.y=this.y*i-this.x*r,t.z=this.z*i+this.w*r,t.w=this.w*i-this.z*r}getYawPitchRoll(e){Vector3.transformQuat(Vector3.ForwardRH,this,z),Vector3.transformQuat(Vector3.Up,this,X);var t=X;Quaternion.angleTo(Vector3.ZERO,z,Y);var r=Y;r.x==Math.PI/2?(r.y=Quaternion.arcTanAngle(t.z,t.x),r.z=0):r.x==-Math.PI/2?(r.y=Quaternion.arcTanAngle(-t.z,-t.x),r.z=0):(Matrix4x4.createRotationY(-r.y,Matrix4x4.TEMPMatrix0),Matrix4x4.createRotationX(-r.x,Matrix4x4.TEMPMatrix1),Vector3.transformCoordinate(X,Matrix4x4.TEMPMatrix0,X),Vector3.transformCoordinate(X,Matrix4x4.TEMPMatrix1,X),r.z=Quaternion.arcTanAngle(t.y,-t.x)),r.y<=-Math.PI&&(r.y=Math.PI),r.z<=-Math.PI&&(r.z=Math.PI),r.y>=Math.PI&&r.z>=Math.PI&&(r.y=0,r.z=0,r.x=Math.PI-r.x);var i=e;i.x=r.y,i.y=r.x,i.z=r.z}invert(e){var t=this.x,r=this.y,i=this.z,a=this.w,s=t*t+r*r+i*i+a*a,n=s?1/s:0;e.x=-t*n,e.y=-r*n,e.z=-i*n,e.w=a*n}identity(){this.x=0,this.y=0,this.z=0,this.w=1}fromArray(e,t=0){this.x=e[t+0],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3]}cloneTo(e){this!==e&&(e.x=this.x,e.y=this.y,e.z=this.z,e.w=this.w)}clone(){var e=new Quaternion;return this.cloneTo(e),e}equals(e){return MathUtils3D.nearEqual(this.x,e.x)&&MathUtils3D.nearEqual(this.y,e.y)&&MathUtils3D.nearEqual(this.z,e.z)&&MathUtils3D.nearEqual(this.w,e.w)}static rotationLookAt(e,t,r){Quaternion.lookAt(Vector3.ZERO,e,t,r)}static lookAt(e,t,r,i){Matrix3x3.lookAt(e,t,r,j),Quaternion.rotationMatrix(j,i)}static forwardLookAt(e,t,r,i){Matrix3x3.forwardLookAt(e,t,r,j),Quaternion.rotationMatrix(j,i)}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}static invert(e,t){var r=e.lengthSquared();MathUtils3D.isZero(r)||(r=1/r,t.x=-e.x*r,t.y=-e.y*r,t.z=-e.z*r,t.w=e.w*r)}static rotationMatrix(e,t){var r,i,a=e.elements,s=a[0],n=a[1],o=a[2],l=a[3],h=a[4],d=a[5],u=a[6],c=a[7],_=a[8],p=s+h+_;p>0?(r=Math.sqrt(p+1),t.w=.5*r,r=.5/r,t.x=(d-c)*r,t.y=(u-o)*r,t.z=(n-l)*r):s>=h&&s>=_?(i=.5/(r=Math.sqrt(1+s-h-_)),t.x=.5*r,t.y=(n+l)*i,t.z=(o+u)*i,t.w=(d-c)*i):h>_?(i=.5/(r=Math.sqrt(1+h-s-_)),t.x=(l+n)*i,t.y=.5*r,t.z=(c+d)*i,t.w=(u-o)*i):(i=.5/(r=Math.sqrt(1+_-s-h)),t.x=(u+o)*i,t.y=(c+d)*i,t.z=.5*r,t.w=(n-l)*i)}}Quaternion.TEMP=new Quaternion,Quaternion.DEFAULT=new Quaternion,Quaternion.NAN=new Quaternion(NaN,NaN,NaN,NaN);const K=new Vector3,q=new Vector3,Q=new Vector3,$=new Vector3,Z=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);class Matrix4x4{constructor(e=1,t=0,r=0,i=0,a=0,s=1,n=0,o=0,l=0,h=0,d=1,u=0,c=0,_=0,p=0,g=1,m=null){if(0!=arguments.length){if(1!==arguments.length||null!==arguments[0]){var f=this.elements=m||new Float32Array(16);f[0]=e,f[1]=t,f[2]=r,f[3]=i,f[4]=a,f[5]=s,f[6]=n,f[7]=o,f[8]=l,f[9]=h,f[10]=d,f[11]=u,f[12]=c,f[13]=_,f[14]=p,f[15]=g}}else this.elements=Z.slice()}static createRotationX(e,t){var r=t.elements,i=Math.sin(e),a=Math.cos(e);r[1]=r[2]=r[3]=r[4]=r[7]=r[8]=r[11]=r[12]=r[13]=r[14]=0,r[0]=r[15]=1,r[5]=r[10]=a,r[6]=i,r[9]=-i}static createRotationY(e,t){var r=t.elements,i=Math.sin(e),a=Math.cos(e);r[1]=r[3]=r[4]=r[6]=r[7]=r[9]=r[11]=r[12]=r[13]=r[14]=0,r[5]=r[15]=1,r[0]=r[10]=a,r[2]=-i,r[8]=i}static createRotationZ(e,t){var r=t.elements,i=Math.sin(e),a=Math.cos(e);r[2]=r[3]=r[6]=r[7]=r[8]=r[9]=r[11]=r[12]=r[13]=r[14]=0,r[10]=r[15]=1,r[0]=r[5]=a,r[1]=i,r[4]=-i}static createRotationYawPitchRoll(e,t,r,i){Quaternion.createFromYawPitchRoll(e,t,r,Quaternion.TEMP),Matrix4x4.createRotationQuaternion(Quaternion.TEMP,i)}static createRotationAxis(e,t,r){var i=e.x,a=e.y,s=e.z,n=Math.cos(t),o=Math.sin(t),l=i*i,h=a*a,d=s*s,u=i*a,c=i*s,_=a*s,p=r.elements;p[3]=p[7]=p[11]=p[12]=p[13]=p[14]=0,p[15]=1,p[0]=l+n*(1-l),p[1]=u-n*u+o*s,p[2]=c-n*c-o*a,p[4]=u-n*u-o*s,p[5]=h+n*(1-h),p[6]=_-n*_+o*i,p[8]=c-n*c+o*a,p[9]=_-n*_-o*i,p[10]=d+n*(1-d)}static createRotationQuaternion(e,t){var r=t.elements,i=e.x,a=e.y,s=e.z,n=e.w,o=i*i,l=a*a,h=s*s,d=i*a,u=s*n,c=s*i,_=a*n,p=a*s,g=i*n;r[3]=r[7]=r[11]=r[12]=r[13]=r[14]=0,r[15]=1,r[0]=1-2*(l+h),r[1]=2*(d+u),r[2]=2*(c-_),r[4]=2*(d-u),r[5]=1-2*(h+o),r[6]=2*(p+g),r[8]=2*(c+_),r[9]=2*(p-g),r[10]=1-2*(l+o)}static createTranslate(e,t){var r=t.elements;r[4]=r[8]=r[1]=r[9]=r[2]=r[6]=r[3]=r[7]=r[11]=0,r[0]=r[5]=r[10]=r[15]=1,r[12]=e.x,r[13]=e.y,r[14]=e.z}static createScaling(e,t){var r=t.elements;r[0]=e.x,r[5]=e.y,r[10]=e.z,r[1]=r[4]=r[8]=r[12]=r[9]=r[13]=r[2]=r[6]=r[14]=r[3]=r[7]=r[11]=0,r[15]=1}static multiply(e,t,r){var i=t.elements,a=e.elements,s=r.elements,n=i[0],o=i[1],l=i[2],h=i[3],d=i[4],u=i[5],c=i[6],_=i[7],p=i[8],g=i[9],m=i[10],f=i[11],S=i[12],y=i[13],T=i[14],x=i[15],D=a[0],v=a[1],C=a[2],E=a[3],R=a[4],w=a[5],M=a[6],b=a[7],I=a[8],L=a[9],A=a[10],B=a[11],P=a[12],N=a[13],F=a[14],U=a[15];s[0]=n*D+o*R+l*I+h*P,s[1]=n*v+o*w+l*L+h*N,s[2]=n*C+o*M+l*A+h*F,s[3]=n*E+o*b+l*B+h*U,s[4]=d*D+u*R+c*I+_*P,s[5]=d*v+u*w+c*L+_*N,s[6]=d*C+u*M+c*A+_*F,s[7]=d*E+u*b+c*B+_*U,s[8]=p*D+g*R+m*I+f*P,s[9]=p*v+g*w+m*L+f*N,s[10]=p*C+g*M+m*A+f*F,s[11]=p*E+g*b+m*B+f*U,s[12]=S*D+y*R+T*I+x*P,s[13]=S*v+y*w+T*L+x*N,s[14]=S*C+y*M+T*A+x*F,s[15]=S*E+y*b+T*B+x*U}static createFromQuaternion(e,t){var r=t.elements,i=e.x,a=e.y,s=e.z,n=e.w,o=i+i,l=a+a,h=s+s,d=i*o,u=a*o,c=a*l,_=s*o,p=s*l,g=s*h,m=n*o,f=n*l,S=n*h;r[0]=1-c-g,r[1]=u+S,r[2]=_-f,r[3]=0,r[4]=u-S,r[5]=1-d-g,r[6]=p+m,r[7]=0,r[8]=_+f,r[9]=p-m,r[10]=1-d-c,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1}static createAffineTransformation(e,t,r,i){var a=i.elements,s=t.x,n=t.y,o=t.z,l=t.w,h=s+s,d=n+n,u=o+o,c=s*h,_=s*d,p=s*u,g=n*d,m=n*u,f=o*u,S=l*h,y=l*d,T=l*u,x=r.x,D=r.y,v=r.z;a[0]=(1-(g+f))*x,a[1]=(_+T)*x,a[2]=(p-y)*x,a[3]=0,a[4]=(_-T)*D,a[5]=(1-(c+f))*D,a[6]=(m+S)*D,a[7]=0,a[8]=(p+y)*v,a[9]=(m-S)*v,a[10]=(1-(c+g))*v,a[11]=0,a[12]=e.x,a[13]=e.y,a[14]=e.z,a[15]=1}static createLookAt(e,t,r,i){var a=i.elements,s=K,n=q,o=Q;Vector3.subtract(e,t,o),Vector3.normalize(o,o),Vector3.cross(r,o,s),Vector3.normalize(s,s),Vector3.cross(o,s,n),a[3]=a[7]=a[11]=0,a[15]=1,a[0]=s.x,a[4]=s.y,a[8]=s.z,a[1]=n.x,a[5]=n.y,a[9]=n.z,a[2]=o.x,a[6]=o.y,a[10]=o.z,a[12]=-Vector3.dot(s,e),a[13]=-Vector3.dot(n,e),a[14]=-Vector3.dot(o,e)}static createPerspective(e,t,r,i,a){var s=1/Math.tan(.5*e),n=r/(s/t),o=r/s;Matrix4x4.createPerspectiveOffCenter(-n,n,-o,o,r,i,a)}static createPerspectiveOffCenter(e,t,r,i,a,s,n){var o=n.elements,l=s/(s-a);o[1]=o[2]=o[3]=o[4]=o[6]=o[7]=o[12]=o[13]=o[15]=0,o[0]=2*a/(t-e),o[5]=2*a/(i-r),o[8]=(e+t)/(t-e),o[9]=(i+r)/(i-r),o[10]=-l,o[11]=-1,o[14]=-a*l}static createOrthoOffCenter(e,t,r,i,a,s,n){var o=n.elements,l=1/(s-a);o[1]=o[2]=o[3]=o[4]=o[6]=o[8]=o[7]=o[9]=o[11]=0,o[15]=1,o[0]=2/(t-e),o[5]=2/(i-r),o[10]=-l,o[12]=(e+t)/(e-t),o[13]=(i+r)/(r-i),o[14]=-a*l}getElementByRowColumn(e,t){if(e<0||e>3)throw new Error("row Rows and columns for matrices run from 0 to 3, inclusive.");if(t<0||t>3)throw new Error("column Rows and columns for matrices run from 0 to 3, inclusive.");return this.elements[4*e+t]}setElementByRowColumn(e,t,r){if(e<0||e>3)throw new Error("row Rows and columns for matrices run from 0 to 3, inclusive.");if(t<0||t>3)throw new Error("column Rows and columns for matrices run from 0 to 3, inclusive.");this.elements[4*e+t]=r}setRotation(e){var t=e.x,r=e.y,i=e.z,a=e.w,s=t*t,n=r*r,o=i*i,l=t*r,h=i*a,d=i*t,u=r*a,c=r*i,_=t*a,p=this.elements;p[0]=1-2*(n+o),p[1]=2*(l+h),p[2]=2*(d-u),p[4]=2*(l-h),p[5]=1-2*(o+s),p[6]=2*(c+_),p[8]=2*(d+u),p[9]=2*(c-_),p[10]=1-2*(n+s)}setPosition(e){var t=this.elements;t[12]=e.x,t[13]=e.y,t[14]=e.z}equalsOtherMatrix(e){var t=this.elements,r=e.elements;return MathUtils3D.nearEqual(t[0],r[0])&&MathUtils3D.nearEqual(t[1],r[1])&&MathUtils3D.nearEqual(t[2],r[2])&&MathUtils3D.nearEqual(t[3],r[3])&&MathUtils3D.nearEqual(t[4],r[4])&&MathUtils3D.nearEqual(t[5],r[5])&&MathUtils3D.nearEqual(t[6],r[6])&&MathUtils3D.nearEqual(t[7],r[7])&&MathUtils3D.nearEqual(t[8],r[8])&&MathUtils3D.nearEqual(t[9],r[9])&&MathUtils3D.nearEqual(t[10],r[10])&&MathUtils3D.nearEqual(t[11],r[11])&&MathUtils3D.nearEqual(t[12],r[12])&&MathUtils3D.nearEqual(t[13],r[13])&&MathUtils3D.nearEqual(t[14],r[14])&&MathUtils3D.nearEqual(t[15],r[15])}decomposeTransRotScale(e,t,r){var i=J;return this.decomposeTransRotMatScale(e,i,r)?(Quaternion.createFromMatrix4x4(i,t),!0):(t.identity(),!1)}decomposeTransRotMatScale(e,t,r){var i=this.elements,a=e,s=t.elements,n=r;a.x=i[12],a.y=i[13],a.z=i[14];var o=i[0],l=i[1],h=i[2],d=i[4],u=i[5],c=i[6],_=i[8],p=i[9],g=i[10],m=n.x=Math.sqrt(o*o+l*l+h*h),f=n.y=Math.sqrt(d*d+u*u+c*c),S=n.z=Math.sqrt(_*_+p*p+g*g);if(MathUtils3D.isZero(m)||MathUtils3D.isZero(f)||MathUtils3D.isZero(S))return s[1]=s[2]=s[3]=s[4]=s[6]=s[7]=s[8]=s[9]=s[11]=s[12]=s[13]=s[14]=0,s[0]=s[5]=s[10]=s[15]=1,!1;var y=K;y.x=_/S,y.y=p/S,y.z=g/S;var T=q;T.x=o/m,T.y=l/m,T.z=h/m;var x=Q;Vector3.cross(y,T,x);var D=q;return Vector3.cross(x,y,D),s[3]=s[7]=s[11]=s[12]=s[13]=s[14]=0,s[15]=1,s[0]=D.x,s[1]=D.y,s[2]=D.z,s[4]=x.x,s[5]=x.y,s[6]=x.z,s[8]=y.x,s[9]=y.y,s[10]=y.z,s[0]*o+s[1]*l+s[2]*h<0&&(n.x=-m),s[4]*d+s[5]*u+s[6]*c<0&&(n.y=-f),s[8]*_+s[9]*p+s[10]*g<0&&(n.z=-S),!0}decomposeYawPitchRoll(e){var t=Math.asin(-this.elements[9]);e.y=t,Math.cos(t)>MathUtils3D.zeroTolerance?(e.z=Math.atan2(this.elements[1],this.elements[5]),e.x=Math.atan2(this.elements[8],this.elements[10])):(e.z=Math.atan2(-this.elements[4],this.elements[0]),e.x=0)}normalize(){var e=this.elements,t=e[0],r=e[1],i=e[2],a=Math.sqrt(t*t+r*r+i*i);if(!a)return e[0]=0,e[1]=0,void(e[2]=0);1!=a&&(a=1/a,e[0]=t*a,e[1]=r*a,e[2]=i*a)}transpose(){var e,t;return t=(e=this.elements)[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this}invert(e){var t=this.elements,r=e.elements,i=t[0],a=t[1],s=t[2],n=t[3],o=t[4],l=t[5],h=t[6],d=t[7],u=t[8],c=t[9],_=t[10],p=t[11],g=t[12],m=t[13],f=t[14],S=t[15],y=i*l-a*o,T=i*h-s*o,x=i*d-n*o,D=a*h-s*l,v=a*d-n*l,C=s*d-n*h,E=u*m-c*g,R=u*f-_*g,w=u*S-p*g,M=c*f-_*m,b=c*S-p*m,I=_*S-p*f,L=y*I-T*b+x*M+D*w-v*R+C*E;0!==Math.abs(L)&&(L=1/L,r[0]=(l*I-h*b+d*M)*L,r[1]=(s*b-a*I-n*M)*L,r[2]=(m*C-f*v+S*D)*L,r[3]=(_*v-c*C-p*D)*L,r[4]=(h*w-o*I-d*R)*L,r[5]=(i*I-s*w+n*R)*L,r[6]=(f*x-g*C-S*T)*L,r[7]=(u*C-_*x+p*T)*L,r[8]=(o*b-l*w+d*E)*L,r[9]=(a*w-i*b-n*E)*L,r[10]=(g*v-m*x+S*y)*L,r[11]=(c*x-u*v-p*y)*L,r[12]=(l*R-o*M-h*E)*L,r[13]=(i*M-a*R+s*E)*L,r[14]=(m*T-g*D-f*y)*L,r[15]=(u*D-c*T+_*y)*L)}static billboard(e,t,r,i,a){Vector3.subtract(e,t,K);var s=Vector3.scalarLengthSquared(K);MathUtils3D.isZero(s)?(Vector3.scale(i,-1,q),q.cloneTo(K)):Vector3.scale(K,1/Math.sqrt(s),K),Vector3.cross(r,K,Q),Vector3.normalize(Q,Q),Vector3.cross(K,Q,$);var n=Q,o=$,l=K,h=e,d=a.elements;d[0]=n.x,d[1]=n.y,d[2]=n.z,d[3]=0,d[4]=o.x,d[5]=o.y,d[6]=o.z,d[7]=0,d[8]=l.x,d[9]=l.y,d[10]=l.z,d[11]=0,d[12]=h.x,d[13]=h.y,d[14]=h.z,d[15]=1}identity(){this.elements.set(Z)}isIdentity(){let e=this.elements,t=Matrix4x4.DEFAULT.elements;for(let a=0,s=e.length;a<s;a++)if(r=e[a],i=t[a],!(Math.abs(r-i)<1e-7))return!1;var r,i;return!0}cloneTo(e){this.elements!==e.elements&&e.elements.set(this.elements)}cloneByArray(e){this.elements.set(e)}clone(){var e=new Matrix4x4(null);return e.elements=this.elements.slice(),e}static translation(e,t){var r=t.elements;r[0]=r[5]=r[10]=r[15]=1,r[12]=e.x,r[13]=e.y,r[14]=e.z}getTranslationVector(e){var t=this.elements;e.x=t[12],e.y=t[13],e.z=t[14]}setTranslationVector(e){var t=this.elements,r=e;t[12]=r.x,t[13]=r.y,t[14]=r.z}getForward(e){var t=this.elements;e.x=-t[8],e.y=-t[9],e.z=-t[10]}setForward(e){var t=this.elements;t[8]=-e.x,t[9]=-e.y,t[10]=-e.z}getInvertFront(){this.decomposeTransRotScale(K,Quaternion.TEMP,q);var e=q,t=e.x<0;return e.y<0&&(t=!t),e.z<0&&(t=!t),t}}Matrix4x4.TEMPMatrix0=new Matrix4x4,Matrix4x4.TEMPMatrix1=new Matrix4x4,Matrix4x4.DEFAULT=new Matrix4x4,Matrix4x4.DEFAULTINVERT=new Matrix4x4(-1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),Matrix4x4.ZERO=new Matrix4x4(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const J=new Matrix4x4;class Vector2{constructor(e=0,t=0){this.x=e,this.y=t}setValue(e,t){this.x=e,this.y=t}static scale(e,t,r){r.x=e.x*t,r.y=e.y*t}static equals(e,t){return MathUtils3D.nearEqual(e.x,t.x)&&MathUtils3D.nearEqual(e.y,t.y)}fromArray(e,t=0){this.x=e[t+0],this.y=e[t+1]}toArray(){return[this.x,this.y]}writeTo(e,t=0){e[t+0]=this.x,e[t+1]=this.y}cloneTo(e){var t=e;t.x=this.x,t.y=this.y}static dot(e,t){return e.x*t.x+e.y*t.y}static normalize(e,t){var r=e.x,i=e.y,a=r*r+i*i;a>0&&(a=1/Math.sqrt(a),t.x=r*a,t.y=i*a)}static scalarLength(e){var t=e.x,r=e.y;return Math.sqrt(t*t+r*r)}clone(){var e=new Vector2;return this.cloneTo(e),e}}var ee,te,re;function ShaderDataDefaultValue(t){switch(t){case e.ShaderDataType.Int:return 0;case e.ShaderDataType.Bool:return!1;case e.ShaderDataType.Float:return 0;case e.ShaderDataType.Vector2:return Vector2.ZERO;case e.ShaderDataType.Vector3:return Vector3.ZERO;case e.ShaderDataType.Vector4:return Vector4.ZERO;case e.ShaderDataType.Color:return Color.BLACK;case e.ShaderDataType.Matrix4x4:return Matrix4x4.DEFAULT;case e.ShaderDataType.Matrix3x3:return Matrix3x3.DEFAULT}return null}Vector2.ZERO=new Vector2(0,0),Vector2.ONE=new Vector2(1,1),Vector2.TempVector2=new Vector2,e.ShaderDataType=void 0,(ee=e.ShaderDataType||(e.ShaderDataType={}))[ee.None=0]="None",ee[ee.Int=1]="Int",ee[ee.Bool=2]="Bool",ee[ee.Float=3]="Float",ee[ee.Vector2=4]="Vector2",ee[ee.Vector3=5]="Vector3",ee[ee.Vector4=6]="Vector4",ee[ee.Color=7]="Color",ee[ee.Matrix4x4=8]="Matrix4x4",ee[ee.Texture2D=9]="Texture2D",ee[ee.Texture3D=10]="Texture3D",ee[ee.TextureCube=11]="TextureCube",ee[ee.Buffer=12]="Buffer",ee[ee.Matrix3x3=13]="Matrix3x3",ee[ee.Texture2DArray=14]="Texture2DArray";e.UniformBufferParamsType=void 0,(te=e.UniformBufferParamsType||(e.UniformBufferParamsType={}))[te.Number=0]="Number",te[te.Vector2=1]="Vector2",te[te.Vector3=2]="Vector3",te[te.Vector4=3]="Vector4",te[te.Matrix4x4=4]="Matrix4x4",te[te.Vector4Array=5]="Vector4Array",te[te.MatrixArray=6]="MatrixArray";class UnifromBufferData{constructor(e){this._uniformParamsState=new Map(e),this._createBuffer(),this._updateFlag=new Vector2,this._resetUpdateFlag()}_createBuffer(){var e=0;this._layoutMap={};this._uniformParamsState.forEach(((t,r)=>{e+=this._addUniformParams(r,t,e)})),this._bytelength=4*Math.ceil(e/4)*4,this._buffer=new Float32Array(e)}_getArraySize(e){let t=e.indexOf("["),r=e.indexOf("]");if(-1!=t&&-1!=r&&t<r)return parseFloat(e.substring(t+1,r));throw e+" is illegal "}_addUniformParams(t,r,i){let a,s=0,n=0,o=i%4;switch(r){case e.UniformBufferParamsType.Number:s=1,n=1;break;case e.UniformBufferParamsType.Vector2:switch(s=2,o){case 0:case 2:n=2;break;case 1:case 3:i+=1,n=3}break;case e.UniformBufferParamsType.Vector3:switch(s=3,n=3,o){case 1:case 2:case 3:i+=4-o,n=4-o+3}break;case e.UniformBufferParamsType.Vector4:switch(s=4,o){case 0:n=4;break;case 1:i+=3,n=7;break;case 2:i+=2,n=6;break;case 3:i+=1,n=5}break;case e.UniformBufferParamsType.Matrix4x4:s=16,a=o?4-o:o,i+=a,n=s+a;break;case e.UniformBufferParamsType.Vector4Array:s=4*this._getArraySize(Shader3D.propertyIDToName(t)),a=o?4-o:o,i+=a,n=s+a;break;case e.UniformBufferParamsType.MatrixArray:s=16*this._getArraySize(Shader3D.propertyIDToName(t)),a=o?4-o:o,i+=a,n=s+a;break;default:throw"Unifrom Buffer Params Type is illegal "}const l=new Vector2(i,s);return this._layoutMap[t]=l,n}_getParamsInfo(e){return this._layoutMap[e]}_setUpdateFlag(e,t){e<this._updateFlag.x&&(this._updateFlag.x=e),t>this._updateFlag.y&&(this._updateFlag.y=t)}destroy(){delete this._buffer,this._uniformParamsState.clear(),this._uniformParamsState=null,this._layoutMap=null,this._updateFlag=null}_resetUpdateFlag(){this._updateFlag.setValue(this._buffer.length,0)}_has(e){return!!this._getParamsInfo(e)}_setData(t,r){switch(this._uniformParamsState.get(t)){case e.UniformBufferParamsType.Number:this.setNumberbyIndex(t,r);break;case e.UniformBufferParamsType.Vector2:this.setVector2byIndex(t,r);break;case e.UniformBufferParamsType.Vector3:this.setVector3byIndex(t,r);break;case e.UniformBufferParamsType.Vector4:this.setVector4byIndex(t,r);break;case e.UniformBufferParamsType.Matrix4x4:this.setMatrixbyIndex(t,r);break;case e.UniformBufferParamsType.Vector4Array:this.setVector4ArraybyIndex(t,r);break;case e.UniformBufferParamsType.MatrixArray:this.setMatrixArraybyIndex(t,r)}}getbyteLength(){return this._bytelength}setVector4Array(e,t){const r=Shader3D.propertyNameToID(e);this.setVector4ArraybyIndex(r,t)}setVector4ArraybyIndex(e,t){const r=this._getParamsInfo(e);if(!r)return;let i=r.x,a=r.y/4;for(let e=0;e<a;e++){let r=t[e];this._buffer[i++]=r.x,this._buffer[i++]=r.y,this._buffer[i++]=r.z,this._buffer[i++]=r.w}this._setUpdateFlag(r.x,i)}setMatrixArray(e,t){const r=Shader3D.propertyNameToID(e);this.setMatrixArraybyIndex(r,t)}setMatrixArraybyIndex(e,t){const r=this._getParamsInfo(e);if(!r)return;let i=r.x,a=r.y/4;for(let e=0;e<a;e++){let r=t[e];this._buffer.set(r.elements,i),i+=16}this._setUpdateFlag(r.x,i)}setNumber(e,t){const r=Shader3D.propertyNameToID(e);this.setNumberbyIndex(r,t)}setNumberbyIndex(e,t){const r=this._getParamsInfo(e);if(!r)return;let i=r.x;this._buffer[i++]=t,this._setUpdateFlag(r.x,i)}setVector2(e,t){const r=Shader3D.propertyNameToID(e);this.setVector2byIndex(r,t)}setVector2byIndex(e,t){const r=this._getParamsInfo(e);if(!r)return;let i=r.x;this._buffer[i++]=t.x,this._buffer[i++]=t.y,this._setUpdateFlag(r.x,i)}setVector3(e,t){const r=Shader3D.propertyNameToID(e);this.setVector3byIndex(r,t)}setVector3byIndex(e,t){const r=this._getParamsInfo(e);if(!r)return;let i=r.x;this._buffer[i++]=t.x,this._buffer[i++]=t.y,this._buffer[i++]=t.z,this._setUpdateFlag(r.x,i)}setVector4(e,t){const r=Shader3D.propertyNameToID(e);this.setVector4byIndex(r,t)}setVector4byIndex(e,t){const r=this._getParamsInfo(e);if(!r)return;let i=r.x;this._buffer[i++]=t.x,this._buffer[i++]=t.y,this._buffer[i++]=t.z,this._buffer[i++]=t.w,this._setUpdateFlag(r.x,i)}setColor(e,t){const r=Shader3D.propertyNameToID(e);this.setColorbyIndex(r,t)}setColorbyIndex(e,t){const r=this._getParamsInfo(e);if(!r)return;let i=r.x;this._buffer[i++]=Color.gammaToLinearSpace(t.r),this._buffer[i++]=Color.gammaToLinearSpace(t.g),this._buffer[i++]=Color.gammaToLinearSpace(t.b),this._buffer[i++]=Color.gammaToLinearSpace(t.a),this._setUpdateFlag(r.x,i)}setMatrix(e,t){const r=Shader3D.propertyNameToID(e);this.setMatrixbyIndex(r,t)}setMatrixbyIndex(e,t){const r=this._getParamsInfo(e);if(!r)return;let i=r.x;this._buffer.set(t.elements,i),i+=16,this._setUpdateFlag(r.x,i)}clone(){let e=new UnifromBufferData(this._uniformParamsState);return this.cloneTo(e),e}cloneTo(e){e._bytelength==this._bytelength&&(e._buffer=Float32Array.from(this._buffer),this._updateFlag.setValue(0,this._buffer.length))}}class ShaderProcessInfo{}class ShaderCompileDefineBase{constructor(e,t,r){this._owner=e,this.name=t,this._VS=r.vsNode,this._PS=r.psNode,this._defs=r.defs,this._validDefine=LayaGL.unitRenderModuleDataFactory.createDefineDatas();for(let e of r.defs)this._validDefine.add(Shader3D.getDefineByName(e))}withCompile(e){return null}}ShaderCompileDefineBase._defineStrings=[];class ShaderVariant{constructor(e,t,r,i){this._subShaderIndex=0,this._passIndex=0,this.setValue(e,t,r,i)}get shader(){return this._shader}get subShaderIndex(){return this._subShaderIndex}get passIndex(){return this._passIndex}get defineNames(){return this._defineNames}setValue(e,t,r,i){if(!e)throw"ShaderVariantInfo:Shader can't be null.";var a=e.getSubShaderAt(t);if(!a)throw`ShaderVariantInfo:Shader don't have subShaderIndex of ${t}.`;var s=a._passes[r];if(!s)throw`ShaderVariantInfo:Shader don't have passIndex of ${r}.`;for(var n=s._validDefine,o=0,l=i.length;o<l;o++){var h=i[o];if(!n.has(Shader3D.getDefineByName(h)))throw`ShaderVariantInfo:Invalid defineName ${h} in ${e._name} subShaderIndex of ${t} passIndex of ${r}.`}this._shader=e,this._subShaderIndex=t,this._passIndex=r,this._defineNames=i}equal(e){if(this._shader!==e._shader||this._subShaderIndex!==e._subShaderIndex||this._passIndex!==e._passIndex)return!1;var t=this._defineNames,r=e._defineNames;if(t.length!==r.length)return!1;for(var i=0,a=this._defineNames.length;i<a;i++)if(t[i]!==r[i])return!1;return!0}clone(){return new ShaderVariant(this._shader,this._subShaderIndex,this._passIndex,this._defineNames.slice())}}class ShaderVariantCollection{constructor(e){this.items=e||{}}add(e,t){let r=e._owner._owner,i=r._subShaders.indexOf(e._owner),a=e._owner._passes.indexOf(e),s=e.nodeCommonMap;if(!s)return;t=t.filter((e=>!Shader3D._configDefineValues.has(Shader3D.getDefineByName(e))));let n=this.items[r._name];n||(n=[],this.items[r._name]=n),n.some((e=>e.subShaderIndex===i&&e.passIndex===a&&e.defines.length===t.length&&e.defines.every(((e,r)=>e===t[r]))&&e.nodeCommonMap.length===s.length&&e.nodeCommonMap.every(((e,t)=>e===s[t]))))||(n.push({subShaderIndex:i,passIndex:a,defines:t,nodeCommonMap:s}),console.debug(`Shader variant: ${r._name}/${i}/${a}/${t.join(",")}/${s?s.join(","):""}`))}compileAll(){let e=this.items;for(let t in e){let r=e[t];for(let e of r){let r=Shader3D.compileShaderByDefineNames(t,e.subShaderIndex,e.passIndex,e.defines,e.nodeCommonMap),i=`${t}/${e.subShaderIndex}/${e.passIndex}/${e.defines.join(",")}/${e.nodeCommonMap?e.nodeCommonMap.join(","):""}`;r?console.debug("Warm up",i):console.warn("Warm up failed!",i)}}}}ShaderVariantCollection.active=new ShaderVariantCollection;class ShaderPass extends ShaderCompileDefineBase{constructor(e,t){super(e,null,t),this._statefirst=!1,this.moduleData=LayaGL.unitRenderModuleDataFactory.createShaderPass(this),this.moduleData.validDefine=this._validDefine}get pipelineMode(){return this._pipelineMode}set pipelineMode(e){this._pipelineMode=e,this.moduleData.pipelineMode=e}get statefirst(){return this._statefirst}set statefirst(e){this._statefirst=e,this.moduleData.statefirst=e}get renderState(){return this.moduleData.renderState}static createShaderInstance(e,t,r){var i;let a=new ShaderProcessInfo;a.is2D=t,a.vs=e._VS,a.ps=e._PS,a.attributeMap=e._owner._attributeMap,a.uniformMap=e._owner._uniformMap;var s=ShaderCompileDefineBase._defineStrings;return s.length=0,Shader3D._getNamesByDefineData(r,s),a.defineString=s,i=LayaGL.renderDeviceFactory.createShaderInstance(a,e),Shader3D.debugMode&&ShaderVariantCollection.active.add(e,s),i}withCompile(e,t=!1){var r=this.moduleData.getCacheShader(e);return r||(r=ShaderPass.createShaderInstance(this,t,e),this.moduleData.setCacheShader(e,r),r)}}ShaderPass._debugDefineStrings=[],ShaderPass._debugDefineMasks=[];class VertexMesh{static __init__(){VertexMesh.instanceWorldMatrixDeclaration=new VertexDeclaration(64,[new VertexElement(0,VertexElementFormat.Vector4,VertexMesh.MESH_WORLDMATRIX_ROW0),new VertexElement(16,VertexElementFormat.Vector4,VertexMesh.MESH_WORLDMATRIX_ROW1),new VertexElement(32,VertexElementFormat.Vector4,VertexMesh.MESH_WORLDMATRIX_ROW2),new VertexElement(48,VertexElementFormat.Vector4,VertexMesh.MESH_WORLDMATRIX_ROW3)]),VertexMesh.instanceSimpleAnimatorDeclaration=new VertexDeclaration(16,[new VertexElement(0,VertexElementFormat.Vector4,VertexMesh.MESH_SIMPLEANIMATOR)]),VertexMesh.instanceLightMapScaleOffsetDeclaration=new VertexDeclaration(16,[new VertexElement(0,VertexElementFormat.Vector4,VertexMesh.MESH_LIGHTMAPSCALEOFFSET)])}static getVertexDeclaration(e,t=!0){var r=VertexMesh._vertexDeclarationMap[e+(t?"_0":"_1")];if(!r){for(var i=e.split(","),a=0,s=[],n=0,o=i.length;n<o;n++){var l;switch(i[n]){case"POSITION":l=new VertexElement(a,VertexElementFormat.Vector3,VertexMesh.MESH_POSITION0),a+=12;break;case"NORMAL":l=new VertexElement(a,VertexElementFormat.Vector3,VertexMesh.MESH_NORMAL0),a+=12;break;case"COLOR":l=new VertexElement(a,VertexElementFormat.Vector4,VertexMesh.MESH_COLOR0),a+=16;break;case"UV":l=new VertexElement(a,VertexElementFormat.Vector2,VertexMesh.MESH_TEXTURECOORDINATE0),a+=8;break;case"UV1":l=new VertexElement(a,VertexElementFormat.Vector2,VertexMesh.MESH_TEXTURECOORDINATE1),a+=8;break;case"BLENDWEIGHT":l=new VertexElement(a,VertexElementFormat.Vector4,VertexMesh.MESH_BLENDWEIGHT0),a+=16;break;case"BLENDINDICES":t?(l=new VertexElement(a,VertexElementFormat.Vector4,VertexMesh.MESH_BLENDINDICES0),a+=16):(l=new VertexElement(a,VertexElementFormat.Byte4,VertexMesh.MESH_BLENDINDICES0),a+=4);break;case"TANGENT":l=new VertexElement(a,VertexElementFormat.Vector4,VertexMesh.MESH_TANGENT0),a+=16;break;case"NORMAL_BYTE":l=new VertexElement(a,VertexElementFormat.NorByte4,VertexMesh.MESH_NORMAL0),a+=4;break;default:throw"VertexMesh: unknown vertex flag."}s.push(l)}r=new VertexDeclaration(a,s),VertexMesh._vertexDeclarationMap[e+(t?"_0":"_1")]=r}return r}}VertexMesh.MESH_POSITION0=0,VertexMesh.MESH_COLOR0=1,VertexMesh.MESH_TEXTURECOORDINATE0=2,VertexMesh.MESH_NORMAL0=3,VertexMesh.MESH_TANGENT0=4,VertexMesh.MESH_BLENDINDICES0=5,VertexMesh.MESH_BLENDWEIGHT0=6,VertexMesh.MESH_TEXTURECOORDINATE1=7,VertexMesh.MESH_WORLDMATRIX_ROW0=8,VertexMesh.MESH_WORLDMATRIX_ROW1=9,VertexMesh.MESH_WORLDMATRIX_ROW2=10,VertexMesh.MESH_WORLDMATRIX_ROW3=11,VertexMesh.MESH_SIMPLEANIMATOR=12,VertexMesh.MESH_LIGHTMAPSCALEOFFSET=13,VertexMesh.MESH_CUSTOME0=12,VertexMesh.MESH_CUSTOME1=13,VertexMesh.MESH_CUSTOME2=14,VertexMesh.MESH_CUSTOME3=15,VertexMesh._vertexDeclarationMap={};class SubShader{constructor(t=SubShader.DefaultAttributeMap,r={},i=null){this._uniformBufferDataMap=new Map,this._flags={},this._passes=[],this.moduleData=LayaGL.unitRenderModuleDataFactory.createSubShader(),this._attributeMap=t,this._uniformMap=r,this._uniformDefaultValue=i,this._uniformTypeMap=new Map;for(const t in r)if("object"==typeof r[t]){let e=r[t],i=new Map;for(const t in e){let r=ShaderDataTypeToUniformBufferType(e[t]);i.set(t,r),this._uniformTypeMap.set(t,e[t])}let a=new Map;i.forEach(((e,t)=>{a.set(Shader3D.propertyNameToID(t),e)}));let s=new UnifromBufferData(a);this._uniformBufferDataMap.set(t,s)}else{let i=r[t];if(this._uniformTypeMap.set(t,i),i==e.ShaderDataType.Texture2D||i==e.ShaderDataType.TextureCube||i==e.ShaderDataType.Texture3D||i==e.ShaderDataType.Texture2DArray){let e=Shader3D.getDefineByName(`Gamma_${t}`),r=Shader3D.propertyNameToID(t);LayaGL.renderEngine.addTexGammaDefine(r,e)}}}static regIncludeBindUnifrom(e,t,r){let i={},a=i[e]={};a.uniformMap=t,a.defaultValue=r,Object.assign(SubShader.IncludeUniformMap,i)}addShaderPass(e,t,r="Forward"){return this._addShaderPass(ShaderCompile.compile(e,t),r)}_addShaderPass(e,t="Forward"){var r=new ShaderPass(this,e);return r.pipelineMode=t,this._passes.push(r),this.moduleData.addShaderPass(r.moduleData),this._addIncludeUniform(e.includeNames),r}_addIncludeUniform(e){for(let r of e)if(SubShader.IncludeUniformMap[r]){let e=SubShader.IncludeUniformMap[r],i=e.uniformMap,a=e.defaultValue;for(var t in i)this._uniformTypeMap.has(t)||(this._uniformTypeMap.set(t,i[t]),this._uniformMap[t]=i[t]);for(var t in a)this._uniformDefaultValue[t]||(this._uniformDefaultValue[t]=a[t])}}}function ShaderDataTypeToUniformBufferType(t){switch(t){case e.ShaderDataType.Float:return e.UniformBufferParamsType.Number;case e.ShaderDataType.Vector2:return e.UniformBufferParamsType.Vector2;case e.ShaderDataType.Vector3:return e.UniformBufferParamsType.Vector3;case e.ShaderDataType.Vector4:case e.ShaderDataType.Color:return e.UniformBufferParamsType.Vector4;case e.ShaderDataType.Matrix4x4:return e.UniformBufferParamsType.Matrix4x4;default:throw"ShaderDataType can not be in UniformBuffer."}}SubShader.IncludeUniformMap={},SubShader.DefaultAttributeMap={a_Position:[VertexMesh.MESH_POSITION0,e.ShaderDataType.Vector4],a_Normal:[VertexMesh.MESH_NORMAL0,e.ShaderDataType.Vector3],a_Tangent0:[VertexMesh.MESH_TANGENT0,e.ShaderDataType.Vector4],a_Texcoord0:[VertexMesh.MESH_TEXTURECOORDINATE0,e.ShaderDataType.Vector2],a_Texcoord1:[VertexMesh.MESH_TEXTURECOORDINATE1,e.ShaderDataType.Vector2],a_Color:[VertexMesh.MESH_COLOR0,e.ShaderDataType.Vector4],a_BoneWeights:[VertexMesh.MESH_BLENDWEIGHT0,e.ShaderDataType.Vector4],a_BoneIndices:[VertexMesh.MESH_BLENDINDICES0,e.ShaderDataType.Vector4],a_WorldMat:[VertexMesh.MESH_WORLDMATRIX_ROW0,e.ShaderDataType.Matrix4x4],a_SimpleTextureParams:[VertexMesh.MESH_SIMPLEANIMATOR,e.ShaderDataType.Vector4],a_LightmapScaleOffset:[VertexMesh.MESH_LIGHTMAPSCALEOFFSET,e.ShaderDataType.Vector4]},e.ShaderFeatureType=void 0,(re=e.ShaderFeatureType||(e.ShaderFeatureType={}))[re.DEFAULT=0]="DEFAULT",re[re.D3=1]="D3",re[re.D2=2]="D2",re[re.PostProcess=3]="PostProcess",re[re.Sky=4]="Sky",re[re.Effect=5]="Effect";class Shader3D{constructor(e,t,r){this._enableInstancing=!1,this._supportReflectionProbe=!1,this._surportVolumetricGI=!1,this._subShaders=[],this._name=e,this._enableInstancing=t,this._supportReflectionProbe=r}static init(){Shader3D._configDefineValues=LayaGL.unitRenderModuleDataFactory.createDefineDatas(),Shader3D.SHADERDEFINE_BLITSCREEN_INVERTY=Shader3D.getDefineByName("BLITSCREEN_INVERTY"),Shader3D.SHADERDEFINE_REMAP_POSITIONZ=Shader3D.getDefineByName("REMAP_Z"),Shader3D.SHADERDEFINE_LOD_TEXTURE_SAMPLE=Shader3D.getDefineByName("LOD_TEXTURE_SAMPLE"),Shader3D.SHADERDEFINE_BREAK_TEXTURE_SAMPLE=Shader3D.getDefineByName("BREAK_TEXTURE_SAMPLE"),LayaGL.renderEngine._remapZ&&Shader3D._configDefineValues.add(Shader3D.SHADERDEFINE_REMAP_POSITIONZ),LayaGL.renderEngine._screenInvertY,LayaGL.renderEngine._lodTextureSample&&Shader3D._configDefineValues.add(Shader3D.SHADERDEFINE_LOD_TEXTURE_SAMPLE),LayaGL.renderEngine._breakTextureSample&&Shader3D._configDefineValues.add(Shader3D.SHADERDEFINE_BREAK_TEXTURE_SAMPLE)}static _getNamesByDefineData(e,t){return LayaGL.renderEngine.getNamesByDefineData(e,t),t}static getDefineByName(e){return LayaGL.renderEngine.getDefineByName(e)}static propertyNameToID(e){return LayaGL.renderEngine.propertyNameToID(e)}static propertyIDToName(e){return LayaGL.renderEngine.propertyIDToName(e)}static addInclude(e,t){ShaderCompile.addInclude(e,t)}static compileShaderByDefineNames(e,t,r,i,a){var s=Shader3D.find(e);if(s){var n=s.getSubShaderAt(t);if(n){var o=n._passes[r];if(o.nodeCommonMap=a,o){var l=Shader3D._compileDefineDatas;Shader3D._configDefineValues.cloneTo(l);for(let e of i)l.add(Shader3D.getDefineByName(e));return o.withCompile(l),!0}}}return!1}static add(e,t=!1,r=!1){return Shader3D._preCompileShader[e]=new Shader3D(e,t,r)}static find(e){return Shader3D._preCompileShader[e]}static parse(e,t){var r;e.name||console.warn("shader name is empty",e),e.uniformMap||console.warn(`${e.name}: uniformMap is empty`);let i=Shader3D.add(e.name,e.enableInstancing,e.supportReflectionProbe);i._surportVolumetricGI=e.surportVolumetricGI;let a=new SubShader(e.attributeMap?e.attributeMap:SubShader.DefaultAttributeMap,e.uniformMap,e.defaultValue);i.addSubShader(a);let s=e.shaderPass;for(var n in s){let i=s[n];if(!i.VS){console.warn(`${e.name}: VS of pass ${n} is empty`);continue}if(!i.FS){console.warn(`${e.name}: FS of pass ${n} is empty`);continue}let o=a._addShaderPass(ShaderCompile.compile(i.VS,i.FS,t),i.pipeline);o.statefirst=null!==(r=i.statefirst)&&void 0!==r&&r,ShaderCompile.getRenderState(i.renderState,o.renderState)}return i}get name(){return this._name}addSubShader(e){this._subShaders.push(e),e._owner=this,e.moduleData.enableInstance=this._enableInstancing}getSubShaderAt(e){return this._subShaders[e]}}Shader3D.PERIOD_CUSTOM=0,Shader3D.PERIOD_MATERIAL=1,Shader3D.PERIOD_SPRITE=2,Shader3D.PERIOD_CAMERA=3,Shader3D.PERIOD_SCENE=4,Shader3D._propertyNameMap={},Shader3D._propertyNameCounter=0,Shader3D._preCompileShader={},Shader3D.debugMode=!1;class Bezier{constructor(){this._controlPoints=[new Point,new Point,new Point],this._calFun=this.getPoint2}_switchPoint(e,t){var r=this._controlPoints.shift();r.setTo(e,t),this._controlPoints.push(r)}getPoint2(e,t){var r=this._controlPoints[0],i=this._controlPoints[1],a=this._controlPoints[2],s=Math.pow(1-e,2)*r.x+2*e*(1-e)*i.x+Math.pow(e,2)*a.x,n=Math.pow(1-e,2)*r.y+2*e*(1-e)*i.y+Math.pow(e,2)*a.y;t.push(s,n)}getPoint3(e,t){var r=this._controlPoints[0],i=this._controlPoints[1],a=this._controlPoints[2],s=this._controlPoints[3],n=Math.pow(1-e,3)*r.x+3*i.x*e*(1-e)*(1-e)+3*a.x*e*e*(1-e)+s.x*Math.pow(e,3),o=Math.pow(1-e,3)*r.y+3*i.y*e*(1-e)*(1-e)+3*a.y*e*e*(1-e)+s.y*Math.pow(e,3);t.push(n,o)}insertPoints(e,t){var r,i;for(i=1/(e=e>0?e:5),r=0;r<=1;r+=i)this._calFun(r,t)}getBezierPoints(e,t=5,r=2){var i,a;if((a=e.length)<2*(r+1))return[];var s=[];switch(r){case 2:this._calFun=this.getPoint2;break;case 3:this._calFun=this.getPoint3;break;default:return[]}for(;this._controlPoints.length<=r;)this._controlPoints.push(Point.create());for(i=0;i<2*r;i+=2)this._switchPoint(e[i],e[i+1]);for(i=2*r;i<a;i+=2)this._switchPoint(e[i],e[i+1]),i/2%r==0&&this.insertPoints(t,s);return s}}Bezier.I=new Bezier;const ie=new Rectangle,ae=new Rectangle;class Texture extends Resource{constructor(e=null,t=null,r=0,i=0){super(!1),this.uvrect=[0,0,1,1],this._w=0,this._h=0,this.offsetX=0,this.offsetY=0,this.sourceWidth=0,this.sourceHeight=0,this.scaleRate=1;let a=e instanceof Texture?e.bitmap:e;this.setTo(a,t,r,i)}static create(e,t,r,i,a,s=0,n=0,o=0,l=0){return Texture._create(e,t,r,i,a,s,n,o,l)}static _create(e,t,r,i,a,s=0,n=0,o=0,l=0,h=null){var d,u=e instanceof Texture,c=u?e.uv:Texture.DEF_UV,_=u?e.bitmap:e;_.width&&t+i>_.width&&(i=_.width-t),_.height&&r+a>_.height&&(a=_.height-r),h?(d=h).setTo(_,null,o||i,l||a):d=new Texture(_,null,o||i,l||a),d.width=i,d.height=a,d.offsetX=s,d.offsetY=n;var p=1/_.width,g=1/_.height;t*=p,r*=g,i*=p,a*=g;var m=d.uv[0],f=d.uv[1],S=d.uv[4],y=d.uv[5],T=S-m,x=y-f,D=function(e,t,r){for(var i=0;i<8;i+=2)r[i]+=e,r[i+1]+=t;return r}(c[0],c[1],[t,r,t+i,r,t+i,r+a,t,r+a]);d.uv=new Float32Array([m+D[0]*T,f+D[1]*x,S-(1-D[2])*T,f+D[3]*x,S-(1-D[4])*T,y-(1-D[5])*x,m+D[6]*T,y-(1-D[7])*x]);var v=e.scaleRate;return v&&1!=v?(d.sourceWidth/=v,d.sourceHeight/=v,d.width/=v,d.height/=v,d.scaleRate=v,d.offsetX/=v,d.offsetY/=v):d.scaleRate=1,d}static createFromTexture(e,t,r,i,a){var s=e.scaleRate;1!=s&&(t*=s,r*=s,i*=s,a*=s);var n=Rectangle.TEMP.setTo(t-e.offsetX,r-e.offsetY,i,a),o=n.intersection(ie.setTo(0,0,e.width,e.height),ae);return o?Texture.create(e,o.x,o.y,o.width,o.height,o.x-n.x,o.y-n.y,i,a):null}get uv(){return this._uv}set uv(e){this.uvrect[0]=Math.min(e[0],e[2],e[4],e[6]),this.uvrect[1]=Math.min(e[1],e[3],e[5],e[7]),this.uvrect[2]=Math.max(e[0],e[2],e[4],e[6])-this.uvrect[0],this.uvrect[3]=Math.max(e[1],e[3],e[5],e[7])-this.uvrect[1],this._uv=e}get width(){return this._w?this._w:this.bitmap?this.uv&&this.uv!==Texture.DEF_UV?(this.uv[2]-this.uv[0])*this.bitmap.width:this.bitmap.width:0}set width(e){this._w=e,this.sourceWidth||(this.sourceWidth=e)}get height(){return this._h?this._h:this.bitmap?this.uv&&this.uv!==Texture.DEF_UV?(this.uv[5]-this.uv[1])*this.bitmap.height:this.bitmap.height:0}set height(e){this._h=e,this.sourceHeight||(this.sourceHeight=e)}get bitmap(){return this._bitmap}set bitmap(e){this._bitmap!=e&&(this._bitmap&&this._bitmap._removeReference(this._referenceCount),this._bitmap=e,e&&e._addReference(this._referenceCount))}_addReference(e=1){super._addReference(e),this._bitmap&&this._bitmap._addReference(e)}_removeReference(e=1){this._bitmap&&this._bitmap._removeReference(e),super._removeReference(e)}_getSource(e=null){return this._destroyed||!this._bitmap?null:(this.recoverBitmap(e),this._bitmap.destroyed?null:this.bitmap._getSource())}setTo(e=null,t=null,r=0,i=0){this.bitmap=e,this.sourceWidth=r,this.sourceHeight=i,e&&(this._w=e.width,this._h=e.height,this.sourceWidth=this.sourceWidth||e.width,this.sourceHeight=this.sourceHeight||e.height),this.uv=t||Texture.DEF_UV}load(e,t){return this._destroyed?Promise.resolve():ILaya.loader.load(e).then((e=>{let r=e.bitmap;this.bitmap=r,this.sourceWidth=this._w=r.width,this.sourceHeight=this._h=r.height,t&&t.run(),this.event(Event.READY,this)}))}getTexturePixels(t,r,i,a){var s,n,o,l=this.bitmap,h=this._w,d=this._h,u=this.sourceWidth,c=this.sourceHeight,_=l.width,p=l.height,g=this.offsetX,m=this.offsetY;let f=i,S=a;if(t+i>h+g&&(f-=t+i-h-g),t+i>u&&(i-=t+i-u),r+a>d+m&&(S-=r+a-d-m),r+a>c&&(a-=r+a-c),i<=0||a<=0)return null;let y=g>t?g-t:0,T=m>r?m-r:0,x=t>g?t-g:0,D=r>m?r-m:0;f-=y,S-=T;var v=4*i,C=null;try{C=l.getPixels()}catch(e){}if(C){if(0==t&&0==r&&i==_&&a==p)return C;let e=this._uv.slice(),l=Math.round(e[0]*_),h=Math.round(e[1]*p);var E=new Uint8Array(i*a*4);for(s=4*l+4*x+(n=(h+D)*(v=4*_)),o=0;o<S;o++)E.set(C.slice(s,s+4*f),4*i*(o+T)+4*y),s+=v;return E}var R=new ILaya.Context;R.size(i,a);let w=new RenderTexture2D(i,a,e.RenderTargetFormat.R8G8B8A8);R.render2D=R.render2D.clone(w);var M=null;if(0!=t||0!=r||i!=_||a!=p){var b=(M=this._uv.slice())[0],I=M[1],L=(M[2]-b)/h,A=(M[7]-I)/d;M=[b+x*L,I+D*A,b+(x+f)*L,I+D*A,b+(x+f)*L,I+(D+S)*A,b+x*L,I+(D+S)*A]}R.startRender(),R._drawTextureM(this,y,T,f,S,null,1,M,4294967295),R.endRender();var B=w.getData(0,0,i,a);for(R.destroy(),w.destroy(),E=new Uint8Array(i*a*4),s=0,n=(a-1)*v,o=a-1;o>=0;o--)E.set(B.slice(n,n+v),s),s+=v,n-=v;return E}getPixels(e,t,r,i){return this.getTexturePixels(e,t,r,i)}recoverBitmap(e){var t=this._bitmap.url;this._destroyed||this._bitmap&&!this._bitmap.destroyed||!t||ILaya.loader.load(t).then((t=>{this.bitmap=t.bitmap,e&&e()}))}disposeBitmap(){!this._destroyed&&this._bitmap&&this._bitmap.destroy()}get valid(){return!this._destroyed&&this._bitmap&&!this._bitmap.destroyed}get obsolute(){return this._obsolute||!this._bitmap||this._bitmap.destroyed||this._bitmap.obsolute}set obsolute(e){this._obsolute=e}_disposeResource(){let e=this._bitmap;this._bitmap=null,e&&e._removeReference(this._referenceCount)}getCachedClip(e,t,r,i){let a=`${e}_${t}_${r}_${i}`;this._clipCache||(this._clipCache=new Map);let s=this._clipCache.get(a);return s||(s=Texture.createFromTexture(this,e,t,r,i),s&&(s._sizeGrid=this._sizeGrid),this._clipCache.size>100&&this._clipCache.clear(),this._clipCache.set(a,s),s)}}Texture.DEF_UV=new Float32Array([0,0,1,0,1,1,0,1]),Texture.NO_UV=new Float32Array([0,0,0,0,0,0,0,0]),Texture.INV_UV=new Float32Array([0,1,1,1,1,0,0,0]);class RenderStateContext{static __init__(){}static setDepthTest(e){LayaGL.renderEngine._GLRenderState.setDepthTest(e)}static setDepthMask(e){LayaGL.renderEngine._GLRenderState.setDepthMask(e)}static setDepthFunc(e){LayaGL.renderEngine._GLRenderState.setDepthFunc(e)}static setStencilTest(e){LayaGL.renderEngine._GLRenderState.setStencilTest(e)}static setStencilMask(e){LayaGL.renderEngine._GLRenderState.setStencilMask(e)}static setStencilFunc(e,t){LayaGL.renderEngine._GLRenderState.setStencilFunc(e,t)}static setstencilOp(e,t,r){LayaGL.renderEngine._GLRenderState.setstencilOp(e,t,r)}static setBlend(e){LayaGL.renderEngine._GLRenderState.setBlend(e)}static setBlendEquation(e){LayaGL.renderEngine._GLRenderState.setBlendEquation(e)}static setBlendEquationSeparate(e,t){LayaGL.renderEngine._GLRenderState.setBlendEquationSeparate(e,t)}static setBlendFunc(e,t){LayaGL.renderEngine._GLRenderState.setBlendFunc(e,t)}static setBlendFuncSeperate(e,t,r,i){LayaGL.renderEngine._GLRenderState.setBlendFuncSeperate(e,t,r,i)}static setCullFace(e){LayaGL.renderEngine._GLRenderState.setCullFace(e)}static setFrontFace(e){LayaGL.renderEngine._GLRenderState.setFrontFace(e)}}RenderStateContext.stencilFuncArray=new Array(2),RenderStateContext.blendEquationSeparateArray=new Array(2),RenderStateContext.blenfunArray=new Array(2),RenderStateContext.blendFuncSeperateArray=new Array(4),RenderStateContext.stencilOpArray=new Array(3);class BlendMode{static _init_(){BlendMode.fns=[BlendMode.BlendNormal,BlendMode.BlendAdd,BlendMode.BlendMultiply,BlendMode.BlendScreen,BlendMode.BlendOverlay,BlendMode.BlendLight,BlendMode.BlendMask,BlendMode.BlendDestinationOut,BlendMode.BlendAddOld,BlendMode.BlendSourceAlpha],BlendMode.targetFns=[BlendMode.BlendNormalTarget,BlendMode.BlendAddTarget,BlendMode.BlendMultiplyTarget,BlendMode.BlendScreenTarget,BlendMode.BlendOverlayTarget,BlendMode.BlendLightTarget,BlendMode.BlendMask,BlendMode.BlendDestinationOut,BlendMode.BlendAddTargetOld,BlendMode.BlendSourceAlpha]}static BlendNormal(){RenderStateContext.setBlendFunc(e.BlendFactor.One,e.BlendFactor.OneMinusSourceAlpha)}static BlendAddOld(){RenderStateContext.setBlendFunc(e.BlendFactor.One,e.BlendFactor.DestinationAlpha)}static BlendAdd(){RenderStateContext.setBlendFunc(e.BlendFactor.One,e.BlendFactor.One)}static BlendMultiply(){RenderStateContext.setBlendFunc(e.BlendFactor.DestinationColor,e.BlendFactor.OneMinusSourceAlpha)}static BlendScreen(){RenderStateContext.setBlendFunc(e.BlendFactor.One,e.BlendFactor.One)}static BlendOverlay(){RenderStateContext.setBlendFunc(e.BlendFactor.One,e.BlendFactor.OneMinusSourceAlpha)}static BlendLight(){RenderStateContext.setBlendFunc(e.BlendFactor.One,e.BlendFactor.One)}static BlendNormalTarget(){RenderStateContext.setBlendFunc(e.BlendFactor.One,e.BlendFactor.OneMinusSourceAlpha)}static BlendAddTargetOld(){RenderStateContext.setBlendFunc(e.BlendFactor.One,e.BlendFactor.DestinationAlpha)}static BlendAddTarget(){RenderStateContext.setBlendFunc(e.BlendFactor.One,e.BlendFactor.One)}static BlendMultiplyTarget(){RenderStateContext.setBlendFunc(e.BlendFactor.DestinationColor,e.BlendFactor.OneMinusSourceAlpha)}static BlendScreenTarget(){RenderStateContext.setBlendFunc(e.BlendFactor.One,e.BlendFactor.One)}static BlendOverlayTarget(){RenderStateContext.setBlendFunc(e.BlendFactor.One,e.BlendFactor.OneMinusSourceColor)}static BlendLightTarget(){RenderStateContext.setBlendFunc(e.BlendFactor.One,e.BlendFactor.One)}static BlendMask(){RenderStateContext.setBlendFunc(e.BlendFactor.Zero,e.BlendFactor.SourceAlpha)}static BlendDestinationOut(){RenderStateContext.setBlendFunc(e.BlendFactor.Zero,e.BlendFactor.Zero)}static BlendSourceAlpha(){RenderStateContext.setBlendFunc(e.BlendFactor.SourceAlpha,e.BlendFactor.OneMinusSourceAlpha)}}BlendMode.activeBlendFunction=null,BlendMode.NAMES=["normal","add","multiply","screen","overlay","light","mask","destination-out","add_old"],BlendMode.TOINT={normal:0,add:1,multiply:2,screen:3,overlay:4,light:5,mask:6,"destination-out":7,lighter:1,lighter_old:8,add_old:8},BlendMode.NORMAL="normal",BlendMode.MASK="mask",BlendMode.LIGHTER="lighter";const se={purple:"#800080",orange:"#ffa500",white:"#FFFFFF",red:"#FF0000",green:"#00FF00",blue:"#0000FF",black:"#000000",yellow:"#FFFF00",gray:"#808080"};class ColorUtils{constructor(e){if(this.arrColor=[],null==e||"none"==e)return this.strColor="#00000000",this.numColor=0,void(this.arrColor=[0,0,0,0]);let t;"string"==typeof e?(t=Utils.fromStringColor(e),this.strColor=e):(t=e,this.strColor=Utils.toHexColor(t)),this.strColor.indexOf("rgba")>=0||9===this.strColor.length?(this.arrColor=[((4278190080&t)>>>24)/255,((16711680&t)>>16)/255,((65280&t)>>8)/255,(255&t)/255],this.numColor=(4278190080&t)>>>24|(16711680&t)>>8|(65280&t)<<8|(255&t)<<24):(this.arrColor=[((16711680&t)>>16)/255,((65280&t)>>8)/255,(255&t)/255,1],this.numColor=4278190080|(16711680&t)>>16|65280&t|(255&t)<<16)}static _initDefault(){for(var e in ColorUtils._DEFAULT={},se)ColorUtils._SAVE[e]=ColorUtils._DEFAULT[e]=new ColorUtils(se[e]);return ColorUtils._DEFAULT}static _initSaveMap(){ColorUtils._SAVE_SIZE=0,ColorUtils._SAVE=Object.assign({},ColorUtils._DEFAULT)}static create(e){let t=e+"",r=ColorUtils._SAVE[t];return null!=r?r:(ColorUtils._SAVE_SIZE>500&&ColorUtils._initSaveMap(),ColorUtils._SAVE_SIZE++,ColorUtils._SAVE[t]=new ColorUtils(e))}}ColorUtils._SAVE={},ColorUtils._SAVE_SIZE=0,ColorUtils._DEFAULT=ColorUtils._initDefault();class DrawStyle{constructor(e){this.setValue(e)}static _Defaultinit(){DrawStyle.DEFAULT=new DrawStyle("#000000")}static create(e){if(e){var t=e instanceof ColorUtils?e:ColorUtils.create(e);return t._drawStyle||(t._drawStyle=new DrawStyle(e))}return DrawStyle.DEFAULT}setValue(e){this._color=e?e instanceof ColorUtils?e:ColorUtils.create(e):ColorUtils.create("#000000")}reset(){this._color=ColorUtils.create("#000000")}toInt(){return this._color.numColor}equal(e){return"string"==typeof e?this._color.strColor===e:e instanceof ColorUtils&&this._color.numColor===e.numColor}toColorStr(){return this._color.strColor}}class Path{constructor(){this._lastOriX=0,this._lastOriY=0,this.paths=[],this._curPath=null}beginPath(e){this.paths.length=1,this._curPath=this.paths[0]=new renderPath,this._curPath.convex=e}closePath(){this._curPath.loop=!0}newPath(){this._curPath=new renderPath,this.paths.push(this._curPath)}addPoint(e,t){this._curPath.path.push(e,t)}push(e,t){this._curPath?this._curPath.path.length>0&&(this._curPath=new renderPath,this.paths.push(this._curPath)):(this._curPath=new renderPath,this.paths.push(this._curPath));var r=this._curPath;r.path=e.slice(),r.convex=t}reset(){this.paths.length=0}}class renderPath{constructor(){this.path=[],this.loop=!1,this.convex=!1}}class SaveBase{constructor(){}static _createArray(){var e=[];return e._length=0,e}static _init(){var e=SaveBase._namemap={};return e[SaveBase.TYPE_ALPHA]="ALPHA",e[SaveBase.TYPE_FILESTYLE]="fillStyle",e[SaveBase.TYPE_FONT]="font",e[SaveBase.TYPE_LINEWIDTH]="lineWidth",e[SaveBase.TYPE_STROKESTYLE]="strokeStyle",e[SaveBase.TYPE_ENABLEMERGE]="_mergeID",e[SaveBase.TYPE_MARK]=e[SaveBase.TYPE_TRANSFORM]=e[SaveBase.TYPE_TRANSLATE]=[],e[SaveBase.TYPE_TEXTBASELINE]="textBaseline",e[SaveBase.TYPE_TEXTALIGN]="textAlign",e[SaveBase.TYPE_GLOBALCOMPOSITEOPERATION]="_nBlendType",e[SaveBase.TYPE_SHADER]="shader",e[SaveBase.TYPE_FILTERS]="filters",e[SaveBase.TYPE_COLORFILTER]="_colorFiler",e}isSaveMark(){return!1}restore(e){this._dataObj[this._valueName]=this._value,SaveBase.POOL[SaveBase.POOL._length++]=this,this._newSubmit&&(e.stopMerge=!0)}static save(e,t,r,i){if((e._saveMark._saveuse&t)!==t){e._saveMark._saveuse|=t;var a=SaveBase.POOL,s=a._length>0?a[--a._length]:new SaveBase;s._value=r[s._valueName=SaveBase._namemap[t]],s._dataObj=r,s._newSubmit=i;var n=e._save;n[n._length++]=s}}}SaveBase.TYPE_ALPHA=1,SaveBase.TYPE_FILESTYLE=2,SaveBase.TYPE_FONT=8,SaveBase.TYPE_LINEWIDTH=256,SaveBase.TYPE_STROKESTYLE=512,SaveBase.TYPE_MARK=1024,SaveBase.TYPE_TRANSFORM=2048,SaveBase.TYPE_TRANSLATE=4096,SaveBase.TYPE_ENABLEMERGE=8192,SaveBase.TYPE_TEXTBASELINE=16384,SaveBase.TYPE_TEXTALIGN=32768,SaveBase.TYPE_GLOBALCOMPOSITEOPERATION=65536,SaveBase.TYPE_CLIPRECT=131072,SaveBase.TYPE_CLIPRECT_STENCIL=262144,SaveBase.TYPE_IBVB=524288,SaveBase.TYPE_SHADER=1048576,SaveBase.TYPE_FILTERS=2097152,SaveBase.TYPE_FILTERS_TYPE=4194304,SaveBase.TYPE_COLORFILTER=8388608,SaveBase.POOL=SaveBase._createArray(),SaveBase._namemap=SaveBase._init();class SaveClipRect{constructor(){this._globalClipMatrix=new Matrix,this._clipInfoID=-1,this._clipRect=new Rectangle}isSaveMark(){return!1}restore(e){this._globalClipMatrix.copyTo(e._globalClipMatrix),this._clipRect.clone(e._clipRect),e._clipInfoID=this._clipInfoID,SaveClipRect.POOL[SaveClipRect.POOL._length++]=this}static save(e){if((e._saveMark._saveuse&SaveBase.TYPE_CLIPRECT)!=SaveBase.TYPE_CLIPRECT){e._saveMark._saveuse|=SaveBase.TYPE_CLIPRECT;var t=SaveClipRect.POOL,r=t._length>0?t[--t._length]:new SaveClipRect;e._globalClipMatrix.copyTo(r._globalClipMatrix),e._clipRect.clone(r._clipRect),r._clipInfoID=e._clipInfoID;var i=e._save;i[i._length++]=r}}}SaveClipRect.POOL=SaveBase._createArray();class SaveMark{constructor(){this._saveuse=0}isSaveMark(){return!0}restore(e){e._saveMark=this._preSaveMark,SaveMark.POOL[SaveMark.POOL._length++]=this}static Create(e){var t=SaveMark.POOL,r=t._length>0?t[--t._length]:new SaveMark;return r._saveuse=0,r._preSaveMark=e._saveMark,e._saveMark=r,r}}SaveMark.POOL=SaveBase._createArray();class SaveTransform{constructor(){this._matrix=new Matrix}isSaveMark(){return!1}restore(e){e._curMat=this._savematrix,SaveTransform.POOL[SaveTransform.POOL._length++]=this}static save(e){var t=e._saveMark;if((t._saveuse&SaveBase.TYPE_TRANSFORM)!==SaveBase.TYPE_TRANSFORM){t._saveuse|=SaveBase.TYPE_TRANSFORM;var r=SaveTransform.POOL,i=r._length>0?r[--r._length]:new SaveTransform;i._savematrix=e._curMat,e._curMat=e._curMat.copyTo(i._matrix);var a=e._save;a[a._length++]=i}}}SaveTransform.POOL=SaveBase._createArray();class SaveTranslate{constructor(){this._mat=new Matrix}isSaveMark(){return!1}restore(e){this._mat.copyTo(e._curMat),SaveTranslate.POOL[SaveTranslate.POOL._length++]=this}static save(e){var t=SaveTranslate.POOL,r=t._length>0?t[--t._length]:new SaveTranslate;e._curMat.copyTo(r._mat);var i=e._save;i[i._length++]=r}}SaveTranslate.POOL=SaveBase._createArray();var ne;class Shader2D{destroy(){}static __init__(){Shader3D.addInclude("Sprite2DFrag.glsl","vec3 gammaToLinear(in vec3 value)\n{\n    return pow((value + 0.055) / 1.055, vec3(2.4));\n}\n\nvec4 gammaToLinear(in vec4 value)\n{\n    return vec4(gammaToLinear(value.rgb), value.a);\n}\n\nvec3 linearToGamma(in vec3 value)\n{\n    return vec3(mix(pow(value.rgb, vec3(0.41666)) * 1.055 - vec3(0.055), value.rgb * 12.92, vec3(lessThanEqual(value.rgb, vec3(0.0031308)))));\n\n    // return pow(value, vec3(1.0 / 2.2));\n    // return pow(value, vec3(0.455));\n}\n\nvec4 linearToGamma(in vec4 value)\n{\n    return vec4(linearToGamma(value.rgb), value.a);\n}\n\nvec4 transspaceColor(vec4 color)\n{\n     \n #ifndef GAMMATEXTURE\n     //是linear数据\n     #ifdef GAMMASPACE\n         color.xyz = linearToGamma(color.xyz);    \n     #endif\n #else\n     //gamma数据\n     #ifndef GAMMASPACE\n         color.xyz = gammaToLinear(color.xyz);\n     #endif\n #endif\n     return color;\n }\n\n#if defined(PRIMITIVEMESH)\n    varying vec4 v_color;\n    varying vec2 v_cliped;\n  \n\n    vec4 getGlColor(vec4 color){\n        #ifdef GAMMASPACE\n            return color;\n        #else\n            return gammaToLinear(color);\n        #endif\n    }\n\n#elif defined(TEXTUREVS)\n    varying vec2 v_cliped;\n    varying vec4 v_texcoordAlpha;\n    varying vec4 v_color;\n    varying float v_useTex;\n    \n    //uniform\n    uniform sampler2D u_spriteTexture;\n\n    #ifdef BLUR_FILTER\n        uniform vec4 u_strength_sig2_2sig2_gauss1; // TODO模糊的过程中会导致变暗变亮\n        uniform vec2 u_blurInfo;\n        #define PI 3.141593\n    #endif\n\n    #ifdef COLOR_FILTER\n        uniform vec4 u_colorAlpha;\n        uniform mat4 u_colorMat;\n    #endif\n\n    #ifdef GLOW_FILTER\n        uniform vec4 u_color;\n        uniform vec4 u_blurInfo1;\n        uniform vec4 u_blurInfo2;\n    #endif\n\n    #ifdef COLOR_ADD\n        uniform vec4 u_colorAdd;\n    #endif\n\n    #ifdef FILLTEXTURE\n        uniform vec4 u_TexRange; // startu,startv,urange, vrange\n    #endif\n\n\n    #ifdef BLUR_FILTER\n        float getGaussian(float x, float y)\n        {\n            return u_strength_sig2_2sig2_gauss1.w * exp(-(x * x + y * y) / u_strength_sig2_2sig2_gauss1.z);\n        }\n\n        vec4 blur()\n        {\n            const float blurw = 9.0;\n            vec4 vec4Color = vec4(0.0, 0.0, 0.0, 0.0);\n            vec2 halfsz = vec2(blurw, blurw) / 2.0 / u_blurInfo;\n            vec2 startpos = v_texcoordAlpha.xy - halfsz;\n            vec2 ctexcoord = startpos;\n            vec2 step = 1.0 / u_blurInfo; //每个像素\n\n            for (float y = 0.0; y <= blurw; ++y)\n            {\n                ctexcoord.x = startpos.x;\n                for (float x = 0.0; x <= blurw; ++x)\n                {\n                    // TODO 纹理坐标的固定偏移应该在vs中处理\n                    vec4Color +=transspaceColor(texture2D(u_spriteTexture, ctexcoord) * getGaussian(x - blurw / 2.0, y - blurw / 2.0));\n                    ctexcoord.x += step.x;\n                }\n                ctexcoord.y += step.y;\n            }\n            // vec4Color.w=1.0;  这个会导致丢失alpha。以后有时间再找模糊会导致透明的问题\n            return vec4Color;\n        }\n    #endif\n\n    vec4 getSpriteTextureColor(){\n        #ifdef FILLTEXTURE\n            vec4 color = texture2D(u_spriteTexture, fract(v_texcoordAlpha.xy) * u_TexRange.zw + u_TexRange.xy);\n        #else\n            vec4 color = texture2D(u_spriteTexture, v_texcoordAlpha.xy);\n        #endif\n        return transspaceColor(color);\n    }\n\n    void setglColor(in vec4 color){\n        if (v_useTex <= 0.)\n            color = vec4(1., 1., 1., 1.);\n\n        color.a *= v_color.w;\n        // color.rgb*=v_color.w;\n        vec4 transColor = v_color;\n        #ifndef GAMMASPACE\n            transColor = gammaToLinear(v_color);\n        #endif\n        color.rgb *= transColor.rgb;\n        gl_FragColor = color;\n\n        #ifdef COLOR_ADD\n            gl_FragColor = vec4(u_colorAdd.rgb, u_colorAdd.a * gl_FragColor.a);\n            gl_FragColor.xyz *= u_colorAdd.a;\n        #endif\n\n        #ifdef BLUR_FILTER\n            gl_FragColor = blur();\n            gl_FragColor.w *= v_color.w;\n        #endif\n\n        #ifdef COLOR_FILTER\n            mat4 alphaMat = u_colorMat;\n\n            alphaMat[0][3] *= gl_FragColor.a;\n            alphaMat[1][3] *= gl_FragColor.a;\n            alphaMat[2][3] *= gl_FragColor.a;\n\n            gl_FragColor = gl_FragColor * alphaMat;\n            gl_FragColor += u_colorAlpha / 255.0 * gl_FragColor.a;\n        #endif\n\n        #ifdef GLOW_FILTER\n            const float c_IterationTime = 10.0;\n            float floatIterationTotalTime = c_IterationTime * c_IterationTime;\n            vec4 vec4Color = vec4(0.0, 0.0, 0.0, 0.0);\n            vec2 vec2FilterDir = vec2(-u_blurInfo1.z / u_blurInfo2.x, -u_blurInfo1.w / u_blurInfo2.y);\n            vec2 vec2FilterOff = vec2(u_blurInfo1.x / u_blurInfo2.x / c_IterationTime * 2.0, u_blurInfo1.y / u_blurInfo2.y / c_IterationTime * 2.0);\n            float maxNum = u_blurInfo1.x * u_blurInfo1.y;\n            vec2 vec2Off = vec2(0.0, 0.0);\n            float floatOff = c_IterationTime / 2.0;\n            for (float i = 0.0; i <= c_IterationTime; ++i){\n                for (float j = 0.0; j <= c_IterationTime; ++j){\n                    vec2Off = vec2(vec2FilterOff.x * (i - floatOff), vec2FilterOff.y * (j - floatOff));\n                    vec4Color += transspaceColor(texture2D(u_spriteTexture, v_texcoordAlpha.xy + vec2FilterDir + vec2Off))  ;\n                }\n            }\n            vec4Color /= floatIterationTotalTime;\n            gl_FragColor = vec4(u_color.rgb, vec4Color.a * u_blurInfo2.z);\n            gl_FragColor.rgb *= gl_FragColor.a;\n        #endif\n    }\n#endif\n\n\n\nvoid clip(){\n    if(v_cliped.x<0.) discard;\n    if(v_cliped.x>1.) discard;\n    if(v_cliped.y<0.) discard;\n    if(v_cliped.y>1.) discard;\n}"),Shader3D.addInclude("Sprite2DVertex.glsl",'#include "Sprite2DShaderInfo.glsl";\nuniform vec4 u_clipMatDir;\nuniform vec2 u_clipMatPos;// 这个是全局的，不用再应用矩阵了。\nuniform vec2 u_size;\nuniform float u_VertAlpha;\nvarying vec2 v_cliped;\n#ifdef WORLDMAT\n    uniform mat4 u_mmat;\n    vec4 transedPos;\n#endif\nvarying vec4 v_color;\n\n\n#if defined(PRIMITIVEMESH)\n    // attribute vec4 a_position;\n    // attribute vec4 a_attribColor;\n\n    void getVertexInfo(inout vertexInfo info){\n        float clipw = length(u_clipMatDir.xy);\n        float cliph = length(u_clipMatDir.zw);\n        #ifdef WORLDMAT\n            vec2 clippos = transedPos.xy - u_clipMatPos.xy;\n        #else\n        vec2 clippos = a_position.xy - u_clipMatPos.xy;\t//pos已经应用矩阵了，为了减的有意义，clip的位置也要缩放\n        #endif\n\n        if(clipw>20000. && cliph>20000.)\n            info.cliped = vec2(0.5,0.5);\n        else {\n            //clipdir是带缩放的方向，由于上面clippos是在缩放后的空间计算的，所以需要把方向先normalize一下\n            info.cliped =vec2( dot(clippos,u_clipMatDir.xy)/clipw/clipw, dot(clippos,u_clipMatDir.zw)/cliph/cliph);\n        }\n        info.color = a_attribColor;\n    }\n\n    void getPosition(inout vec4 pos){\n        pos = vec4(a_position.xy,0.,1.);\n        #ifdef WORLDMAT\n            pos = u_mmat*pos;\n            transedPos=pos;\n            pos = vec4((pos.x/u_size.x-0.5)*2.0,(0.5-pos.y/u_size.y)*2.0,pos.z,1.0);\n        #else\n            pos = vec4((a_position.x/u_size.x-0.5)*2.0,(0.5-a_position.y/u_size.y)*2.0,a_position.z,1.0);\n        #endif\n    }\n\n#elif defined(TEXTUREVS)\n\t//texture和fillrect使用的。\n    // attribute vec4 a_posuv;\n    // attribute vec4 a_attribColor;\n    // attribute vec4 a_attribFlags;\n    #ifdef MVP3D\n        uniform mat4 u_MvpMatrix;\n    #endif\n\n    varying vec4 v_texcoordAlpha;\n    varying float v_useTex;\n\n    void getVertexInfo(inout vertexInfo info){\n       \t//texcoordAlpha\n        info.texcoordAlpha.xy = a_posuv.zw;\n        //color\n        info.color = a_attribColor;\n        info.color.a*=u_VertAlpha;\n\t    info.color.xyz*= info.color.w;//反正后面也要预乘\n        //useTex\n        info.useTex = a_attribFlags.r;\n\n        //clip\n    \tfloat clipw = length(u_clipMatDir.xy);\n    \tfloat cliph = length(u_clipMatDir.zw);\n\t    vec2 clpos = u_clipMatPos.xy;\n        #ifdef WORLDMAT\n            vec2 clippos = transedPos.xy - clpos;\n        #else\n        vec2 clippos = a_posuv.xy - clpos;\t//pos已经应用矩阵了，为了减的有意义，clip的位置也要缩放\n        #endif\n        if(clipw>20000. && cliph>20000.)\n            info.cliped = vec2(0.5,0.5);\n        else {\n            //转成0到1之间。/clipw/clipw 表示clippos与normalize之后的clip朝向点积之后，再除以clipw\n            info.cliped = vec2( dot(clippos,u_clipMatDir.xy)/clipw/clipw, dot(clippos,u_clipMatDir.zw)/cliph/cliph);\n        }\n    }\n\n    void getPosition(inout vec4 glPosition){\n        vec4 pos = vec4(a_posuv.xy,0.,1.);\n        #ifdef WORLDMAT\n            pos= u_mmat * pos;\n            transedPos=pos;//vec4(pos.x,pos.y,0.0,1.0);\n        #endif\n        vec4 pos1 = vec4((pos.x/u_size.x-0.5)*2.0,(0.5-pos.y/u_size.y)*2.0,0.,1.0);\n        #ifdef MVP3D\n            glPosition = u_MvpMatrix * pos1;\n        #else\n            glPosition = pos1;\n        #endif\n        \n        #ifdef INVERTY\n            glPosition.y = -glPosition.y;\n        #endif\n    }\n\n#endif'),Shader3D.addInclude("Sprite2DShaderInfo.glsl","\n#if defined(PRIMITIVEMESH)\n    struct vertexInfo {\n        vec4 color;\n        vec2 cliped;\n    };\n#elif defined(TEXTUREVS)\n   struct vertexInfo {\n        vec4 color;\n        vec2 cliped;\n        vec4 texcoordAlpha;\n        float useTex;\n    };\n#endif"),Shader2D.textureShader=Shader3D.add("Sprite2DTexture",!1,!1),Shader2D.textureShader.shaderType=e.ShaderFeatureType.D2;let t=new SubShader(Shader2D.textureAttribute,{},{});Shader2D.textureShader.addSubShader(t),t.addShaderPass('#define SHADER_NAME TextureVS2D\n#include "Sprite2DVertex.glsl";\n\nvoid main() {\n\tvec4 pos;\n\t//先计算位置，再做裁剪\n\tgetPosition(pos);\n\tvertexInfo info;\n\tgetVertexInfo(info);\n\n\tv_cliped = info.cliped;\n\tv_texcoordAlpha = info.texcoordAlpha;\n\tv_useTex = info.useTex;\n\tv_color = info.color;\n\n\tgl_Position = pos;\n\n}\n','#define SHADER_NAME TextureFS2D\n//texture和fillrect使用的。\n#if defined(GL_FRAGMENT_PRECISION_HIGH) // 原来的写法会被我们自己的解析流程处理，而我们的解析是不认内置宏的，导致被删掉，所以改成 if defined 了\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\n#include "Sprite2DFrag.glsl";\n\nvoid main()\n{\n    clip();\n    vec4 color = getSpriteTextureColor();\n    setglColor(color);\n}\n'),Shader2D.primitiveShader=Shader3D.add("Sprite2DPrimitive",!1,!1),Shader2D.primitiveShader.shaderType=e.ShaderFeatureType.D2,t=new SubShader(Shader2D.primitiveAttribute,{},{}),Shader2D.primitiveShader.addSubShader(t),t.addShaderPass('#define SHADER_NAME PrimitiveVS2D\n#include "Sprite2DVertex.glsl";\n\n\n#ifdef WORLDMAT\n\tuniform mat4 mmat;\n#endif\n\nvoid main(){\n\tvec4 pos;\n\t//先计算位置，再做裁剪\n\tgetPosition(pos);\n\tvertexInfo info;\n\tgetVertexInfo(info);\n\t\n\t//Update \n\tv_color = info.color;\n\tv_cliped = info.cliped;\n\t\n\tgl_Position = pos;\n}','#define SHADER_NAME PrimitiveFS2D\nprecision mediump float;\n\n#include "Sprite2DFrag.glsl";\n\nvoid main(){\n\tclip();\n\tgl_FragColor = getGlColor(v_color);\n\tgl_FragColor.rgb*=gl_FragColor.a;\n}')}}Shader2D.primitiveAttribute={a_position:[0,e.ShaderDataType.Vector4],a_attribColor:[1,e.ShaderDataType.Vector4]},Shader2D.textureAttribute={a_posuv:[0,e.ShaderDataType.Vector4],a_attribColor:[1,e.ShaderDataType.Vector4],a_attribFlags:[2,e.ShaderDataType.Vector4]};class ShaderDefines2D{static __init__(){ShaderDefines2D.TEXTURE2D=Shader3D.getDefineByName("TEXTURE2D"),ShaderDefines2D.PRIMITIVE=Shader3D.getDefineByName("PRIMITIVE"),ShaderDefines2D.FILTERGLOW=Shader3D.getDefineByName("GLOW_FILTER"),ShaderDefines2D.FILTERBLUR=Shader3D.getDefineByName("BLUR_FILTER"),ShaderDefines2D.FILTERCOLOR=Shader3D.getDefineByName("COLOR_FILTER"),ShaderDefines2D.COLORADD=Shader3D.getDefineByName("COLOR_ADD"),ShaderDefines2D.WORLDMAT=Shader3D.getDefineByName("WORLDMAT"),ShaderDefines2D.FILLTEXTURE=Shader3D.getDefineByName("FILLTEXTURE"),ShaderDefines2D.MVP3D=Shader3D.getDefineByName("MVP3D"),ShaderDefines2D.GAMMASPACE=Shader3D.getDefineByName("GAMMASPACE"),ShaderDefines2D.INVERTY=Shader3D.getDefineByName("INVERTY"),ShaderDefines2D.GAMMATEXTURE=Shader3D.getDefineByName("GAMMATEXTURE"),ShaderDefines2D.TEXTURESHADER=Shader3D.getDefineByName("TEXTUREVS"),ShaderDefines2D.PRIMITIVESHADER=Shader3D.getDefineByName("PRIMITIVEMESH"),ShaderDefines2D.initSprite2DCommandEncoder()}static initSprite2DCommandEncoder(){ShaderDefines2D.UNIFORM_MMAT=Shader3D.propertyNameToID("u_mmat"),ShaderDefines2D.UNIFORM_CLIPMATDIR=Shader3D.propertyNameToID("u_clipMatDir"),ShaderDefines2D.UNIFORM_CLIPMATPOS=Shader3D.propertyNameToID("u_clipMatPos"),ShaderDefines2D.UNIFORM_MMAT2=Shader3D.propertyNameToID("u_mmat2"),ShaderDefines2D.UNIFORM_SIZE=Shader3D.propertyNameToID("u_size"),ShaderDefines2D.UNIFORM_VERTALPHA=Shader3D.propertyNameToID("u_VertAlpha"),ShaderDefines2D.UNIFORM_MVPMatrix=Shader3D.propertyNameToID("u_MvpMatrix"),ShaderDefines2D.UNIFORM_SPRITETEXTURE=Shader3D.propertyNameToID("u_spriteTexture"),ShaderDefines2D.UNIFORM_STRENGTH_SIG2_2SIG2_GAUSS1=Shader3D.propertyNameToID("u_strength_sig2_2sig2_gauss1"),ShaderDefines2D.UNIFORM_BLURINFO=Shader3D.propertyNameToID("u_blurInfo"),ShaderDefines2D.UNIFORM_COLORALPHA=Shader3D.propertyNameToID("u_colorAlpha"),ShaderDefines2D.UNIFORM_COLORMAT=Shader3D.propertyNameToID("u_colorMat"),ShaderDefines2D.UNIFORM_COLOR=Shader3D.propertyNameToID("u_color"),ShaderDefines2D.UNIFORM_BLURINFO1=Shader3D.propertyNameToID("u_blurInfo1"),ShaderDefines2D.UNIFORM_BLURINFO2=Shader3D.propertyNameToID("u_blurInfo2"),ShaderDefines2D.UNIFORM_COLORADD=Shader3D.propertyNameToID("u_colorAdd"),ShaderDefines2D.UNIFORM_TEXRANGE=Shader3D.propertyNameToID("u_TexRange");const t=LayaGL.renderDeviceFactory.createGlobalUniformMap("Sprite2D");t.addShaderUniform(ShaderDefines2D.UNIFORM_MMAT,"u_mmat",e.ShaderDataType.Matrix4x4),t.addShaderUniform(ShaderDefines2D.UNIFORM_CLIPMATDIR,"u_clipMatDir",e.ShaderDataType.Vector4),t.addShaderUniform(ShaderDefines2D.UNIFORM_CLIPMATPOS,"u_clipMatPos",e.ShaderDataType.Vector2),t.addShaderUniform(ShaderDefines2D.UNIFORM_MMAT2,"u_mmat2",e.ShaderDataType.Matrix4x4),t.addShaderUniform(ShaderDefines2D.UNIFORM_SIZE,"u_size",e.ShaderDataType.Vector2),t.addShaderUniform(ShaderDefines2D.UNIFORM_VERTALPHA,"u_VertAlpha",e.ShaderDataType.Float),t.addShaderUniform(ShaderDefines2D.UNIFORM_MVPMatrix,"u_MvpMatrix",e.ShaderDataType.Matrix4x4),t.addShaderUniform(ShaderDefines2D.UNIFORM_SPRITETEXTURE,"u_spriteTexture",e.ShaderDataType.Texture2D),t.addShaderUniform(ShaderDefines2D.UNIFORM_STRENGTH_SIG2_2SIG2_GAUSS1,"u_strength_sig2_2sig2_gauss1",e.ShaderDataType.Vector4),t.addShaderUniform(ShaderDefines2D.UNIFORM_BLURINFO,"u_blurInfo",e.ShaderDataType.Vector2),t.addShaderUniform(ShaderDefines2D.UNIFORM_COLORALPHA,"u_colorAlpha",e.ShaderDataType.Vector4),t.addShaderUniform(ShaderDefines2D.UNIFORM_COLORMAT,"u_colorMat",e.ShaderDataType.Matrix4x4),t.addShaderUniform(ShaderDefines2D.UNIFORM_COLOR,"u_color",e.ShaderDataType.Vector4),t.addShaderUniform(ShaderDefines2D.UNIFORM_BLURINFO1,"u_blurInfo1",e.ShaderDataType.Vector4),t.addShaderUniform(ShaderDefines2D.UNIFORM_BLURINFO2,"u_blurInfo2",e.ShaderDataType.Vector4),t.addShaderUniform(ShaderDefines2D.UNIFORM_COLORADD,"u_colorAdd",e.ShaderDataType.Vector4),t.addShaderUniform(ShaderDefines2D.UNIFORM_TEXRANGE,"u_TexRange",e.ShaderDataType.Vector4)}}e.RenderSpriteData=void 0,(ne=e.RenderSpriteData||(e.RenderSpriteData={}))[ne.Zero=0]="Zero",ne[ne.Texture2D=1]="Texture2D",ne[ne.Primitive=2]="Primitive";class Value2D{constructor(t){this._needRelease=!1,this.mainID=e.RenderSpriteData.Zero,this.ref=1,this._cacheID=0,this.mainID=t,Value2D.prototype.initialize.call(this)}_init2DRenderState(){this.shaderData.setInt(Shader3D.BLEND,RenderState.BLEND_ENABLE_ALL),this.shaderData.setInt(Shader3D.BLEND_SRC,RenderState.BLENDPARAM_ONE),this.shaderData.setInt(Shader3D.BLEND_DST,RenderState.BLENDPARAM_ONE_MINUS_SRC_ALPHA),this.shaderData.setInt(Shader3D.DEPTH_TEST,RenderState.DEPTHTEST_OFF),this.shaderData.setInt(Shader3D.CULL,RenderState.CULL_NONE)}initialize(){this.localClipMatrix=new Matrix;let t=this.mainID;this.shaderData=LayaGL.renderDeviceFactory.createShaderData(null),this._init2DRenderState(),this.mainID==e.RenderSpriteData.Texture2D&&this.shaderData.addDefine(ShaderDefines2D.TEXTURESHADER),this.mainID==e.RenderSpriteData.Primitive&&this.shaderData.addDefine(ShaderDefines2D.PRIMITIVESHADER),this.textureHost=null,this.texture=null,this.clipMatDir=new Vector4(Const.MAX_CLIP_SIZE,0,0,Const.MAX_CLIP_SIZE),this.clipMatPos=new Vector2,this._cacheID=t,this._inClassCache=Value2D._cache[this._cacheID],t>0&&!this._inClassCache&&(this._inClassCache=Value2D._cache[this._cacheID]=[],this._inClassCache._length=0),this.shaderData.setBool(Shader3D.DEPTH_WRITE,!1),this.shaderData.setInt(Shader3D.DEPTH_TEST,RenderState.DEPTHTEST_OFF),this.shaderData.setInt(Shader3D.BLEND,RenderState.BLEND_ENABLE_ALL),this.shaderData.setInt(Shader3D.BLEND_EQUATION,RenderState.BLENDEQUATION_ADD),this.shaderData.setInt(Shader3D.BLEND_SRC,RenderState.BLENDPARAM_ONE),this.shaderData.setInt(Shader3D.BLEND_DST,RenderState.BLENDPARAM_ONE_MINUS_SRC_ALPHA),this.shaderData.setNumber(ShaderDefines2D.UNIFORM_VERTALPHA,1)}reinit(){this.initialize()}static _initone(e,t){Value2D._compileDefine=LayaGL.unitRenderModuleDataFactory.createDefineDatas(),Value2D._typeClass[e]=t,Value2D._cache[e]=[],Value2D._cache[e]._length=0,Value2D.globalShaderData=LayaGL.renderDeviceFactory.createShaderData(null)}static create(e){var t=Value2D._cache[e]?Value2D._cache[e]:[];if(t._length){let e=t[--t._length];return e.reinit(),e}return new Value2D._typeClass[e]}set size(e){this.shaderData.setVector2(ShaderDefines2D.UNIFORM_SIZE,e)}get size(){return this.shaderData.getVector2(ShaderDefines2D.UNIFORM_SIZE)}set vertAlpha(e){this.shaderData.setNumber(ShaderDefines2D.UNIFORM_VERTALPHA,e)}get vertAlpha(){return this.shaderData.getNumber(ShaderDefines2D.UNIFORM_VERTALPHA)}set mmat(e){this.shaderData.setMatrix4x4(ShaderDefines2D.UNIFORM_MMAT,e)}get mmat(){return this.shaderData.getMatrix4x4(ShaderDefines2D.UNIFORM_MMAT)}set u_MvpMatrix(e){this.shaderData.setMatrix4x4(ShaderDefines2D.UNIFORM_MVPMatrix,e)}get u_MvpMatrix(){return this.shaderData.getMatrix4x4(ShaderDefines2D.UNIFORM_MVPMatrix)}get textureHost(){return this._textureHost}set textureHost(e){this._textureHost=e;let t,r=!1;this.textureHost&&(this.textureHost instanceof BaseTexture?r=1!=this.textureHost.gammaCorrection:this.textureHost instanceof Texture&&this.textureHost.bitmap&&(r=1!=this.textureHost.bitmap.gammaCorrection)),r?this.shaderData.addDefine(ShaderDefines2D.GAMMATEXTURE):this.shaderData.removeDefine(ShaderDefines2D.GAMMATEXTURE),t=e instanceof Texture?e.bitmap:e,this.shaderData.setTexture(ShaderDefines2D.UNIFORM_SPRITETEXTURE,t)}set color(e){e&&this.shaderData.setVector(ShaderDefines2D.UNIFORM_COLOR,e)}get color(){return this.shaderData.getVector(ShaderDefines2D.UNIFORM_COLOR)}set colorAdd(e){this.shaderData.setVector(ShaderDefines2D.UNIFORM_COLORADD,e)}get colorAdd(){return this.shaderData.getVector(ShaderDefines2D.UNIFORM_COLORADD)}set clipMatDir(e){this.shaderData.setVector(ShaderDefines2D.UNIFORM_CLIPMATDIR,e)}get clipMatDir(){return this.shaderData.getVector(ShaderDefines2D.UNIFORM_CLIPMATDIR)}set clipMatPos(e){this.shaderData.setVector2(ShaderDefines2D.UNIFORM_CLIPMATPOS,e)}get clipMatPos(){return this.shaderData.getVector2(ShaderDefines2D.UNIFORM_CLIPMATPOS)}upload(e,t){}setFilter(e){e&&this.shaderData.addDefine(e.typeDefine)}clear(){this.shaderData.destroy()}blendNormal(){this.shaderData.setInt(Shader3D.BLEND_SRC,RenderState.BLENDPARAM_SRC_ALPHA),this.shaderData.setInt(Shader3D.BLEND_DST,RenderState.BLENDPARAM_ONE_MINUS_SRC_ALPHA)}blendPremulAlpha(){this.shaderData.setInt(Shader3D.BLEND_SRC,RenderState.BLENDPARAM_ONE),this.shaderData.setInt(Shader3D.BLEND_DST,RenderState.BLENDPARAM_ONE_MINUS_SRC_ALPHA)}blendAdd(){this.shaderData.setInt(Shader3D.BLEND_SRC,RenderState.BLENDPARAM_ONE),this.shaderData.setInt(Shader3D.BLEND_DST,RenderState.BLENDPARAM_ONE)}blendMask(){this.shaderData.setInt(Shader3D.BLEND_SRC,RenderState.BLENDPARAM_ZERO),this.shaderData.setInt(Shader3D.BLEND_DST,RenderState.BLENDPARAM_SRC_ALPHA)}release(){--this.ref<1&&(this._inClassCache&&(this._inClassCache[this._inClassCache._length++]=this),this.clear(),this.filters=null,this.ref=1)}}Value2D._cache=[],Value2D._typeClass=[];const oe=15*Math.PI/180;class BasePoly{static _checkMinAngle(e,t,r,i,a,s){const n=r-e,o=i-t,l=a-r,h=s-i,d=(n*l+o*h)/(Math.sqrt(n*n+o*o)*Math.sqrt(l*l+h*h)),u=Math.acos(Math.abs(d));return Math.abs(u)<oe}static createLine2(e,t,r,i,a,s){if(e.length<4)return null;let n=i;var o=BasePoly.tempData.length>e.length+2?BasePoly.tempData:new Array(e.length+2);o[0]=e[0],o[1]=e[1];var l=2,h=0,d=e.length;for(h=2;h<d;h+=2)Math.abs(e[h]-e[h-2])+Math.abs(e[h+1]-e[h-1])>.01&&(o[l++]=e[h],o[l++]=e[h+1]);let u=Math.abs(e[0]-o[l-2])+Math.abs(e[1]-o[l-1]);s&&u>0&&(u>1e-13?(o[l++]=e[0],o[l++]=e[1]):(o[l-2]=e[0],o[l-1]=e[1]));var c=a;d=l/2;var _,p,g,m,f,S,y=r/2;for(_=o[0],p=o[1],g=o[2],m=o[3],this.vec2=this.getNormal(_,p,g,m,y,this.vec2),c.push(_-this.vec2.x,p-this.vec2.y,_+this.vec2.x,p+this.vec2.y),h=1;h<d-1;h++)_=o[2*(h-1)],p=o[2*(h-1)+1],g=o[2*h],m=o[2*h+1],f=o[2*(h+1)],S=o[2*(h+1)+1],t.push(i+0,i+1,i+3,i+3,i+2,i+0),i+=2,i+=this._setMiddleVertexs(_,p,g,m,f,S,y,c,this.vec2,t,i);if(_=o[l-4],p=o[l-3],g=o[l-2],m=o[l-1],this.vec2=this.getNormal(_,p,g,m,y,this.vec2),c.push(g-this.vec2.x,m-this.vec2.y,g+this.vec2.x,m+this.vec2.y),t.push(i+0,i+1,i+3,i+3,i+2,i+0),g==o[0]&&m==o[1]){f=o[2],S=o[3];let e=c.length/2;i+=4;let r=BasePoly.tempIndexs;r[0]=n+e-2,r[1]=n+e-1,r[2]=n,r[3]=n+1,this._setMiddleVertexs(_,p,g,m,f,S,y,c,this.vec2,t,i,r)}return c}static _setMiddleVertexs(e,t,r,i,a,s,n,o,l,h,d,u=null){this.getNormal(e,t,r,i,n,l);let c=l.x,_=l.y;this.getNormal(r,i,a,s,n,l);let p=l.x,g=l.y;if(this._checkMinAngle(e,t,r,i,a,s))return u?h.push(u[0],u[1],u[3],u[3],u[2],u[0]):(o.push(r-c,i-_,r+c,i+_),o.push(r-p,i-g,r+p,i+g),h.push(d+0,d+1,d+3,d+3,d+2,d+0)),2;let m=-_+t-(-_+i),f=-c+r-(-c+e),S=(-c+e)*(-_+i)-(-c+r)*(-_+t),y=-g+s-(-g+i),T=-p+r-(-p+a),x=(-p+a)*(-g+i)-(-p+r)*(-g+s),D=m*T-y*f;if(D=m*T-y*f,Math.abs(D)<.1)return D+=10.1,o.push(r-c,i-_,r+c,i+_),0;let v=(f*x-T*S)/D,C=(y*S-m*x)/D;return u?D>0?(o.push(v,C,r,i),h.push(u[0],d+0,u[2]),h.push(u[2],d+1,u[0])):(o.push(r-(v-r),i-(C-i),r,i),h.push(u[1],d+0,u[3]),h.push(u[3],d+1,u[1])):(o.push(r-c,i-_,r+c,i+_),D>0?(o.push(v,C,r,i),h.push(d+0,d+2,d+4),h.push(d+4,d+3,d+0)):(o.push(r-(v-r),i-(C-i),r,i),h.push(d+1,d+2,d+5),h.push(d+5,d+3,d+1)),o.push(r-p,i-g,r+p,i+g)),4}static getNormal(e,t,r,i,a,s){s||(s=new Vector2);let n=i-t,o=e-r,l=Math.sqrt(n*n+o*o);return s.x=n/l*a,s.y=o/l*a,s}static createLineTriangle(e,t,r,i,a,s,n){var o=e.slice(),l=o.length,h=o[0],d=o[1],u=o[2],c=(o[2],0),_=0,p=0,g=0,m=l/2;if(!(m<=1)&&2!=m){for(var f=new Array(4*m),S=0,y=0,T=0;T<m-1;T++)h=o[y++],d=o[y++],u=o[y++],g=o[y++]-d,0!=(p=u-h)&&0!=g&&(c=Math.sqrt(p*p+g*g))>.001&&(f[_=4*S]=h,f[_+1]=d,f[_+2]=p/c,f[_+3]=g/c,S++);for(i?(h=o[l-2],d=o[l-1],u=o[0],g=o[1]-d,0!=(p=u-h)&&0!=g&&(c=Math.sqrt(p*p+g*g))>.001&&(f[_=4*S]=h,f[_+1]=d,f[_+2]=p/c,f[_+3]=g/c,S++)):(f[_=4*S]=h,f[_+1]=d,f[_+2]=p/c,f[_+3]=g/c,S++),y=0,T=0;T<m;T++)h=o[y],d=o[y+1],u=o[y+2],o[y+3]}}}BasePoly.tempData=new Array(256),BasePoly.tempIndexs=new Array(4);class EarcutNode{constructor(e,t,r){this.i=e,this.x=t,this.y=r,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}}class Earcut{static earcut(e,t,r){r=r||2;var i,a,s,n,o,l,h,d=t&&t.length,u=d?t[0]*r:e.length,c=Earcut.linkedList(e,0,u,r,!0),_=[];if(!c)return _;if(d&&(c=Earcut.eliminateHoles(e,t,c,r)),e.length>80*r){i=s=e[0],a=n=e[1];for(var p=r;p<u;p+=r)(o=e[p])<i&&(i=o),(l=e[p+1])<a&&(a=l),o>s&&(s=o),l>n&&(n=l);h=0!==(h=Math.max(s-i,n-a))?1/h:0}return Earcut.earcutLinked(c,_,r,i,a,h),_}static linkedList(e,t,r,i,a){var s,n;if(a===Earcut.signedArea(e,t,r,i)>0)for(s=t;s<r;s+=i)n=Earcut.insertNode(s,e[s],e[s+1],n);else for(s=r-i;s>=t;s-=i)n=Earcut.insertNode(s,e[s],e[s+1],n);return n&&Earcut.equals(n,n.next)&&(Earcut.removeNode(n),n=n.next),n}static filterPoints(e,t){if(!e)return e;t||(t=e);var r,i=e;do{if(r=!1,i.steiner||!Earcut.equals(i,i.next)&&0!==Earcut.area(i.prev,i,i.next))i=i.next;else{if(Earcut.removeNode(i),(i=t=i.prev)===i.next)break;r=!0}}while(r||i!==t);return t}static earcutLinked(e,t,r,i,a,s,n=null){if(e){!n&&s&&Earcut.indexCurve(e,i,a,s);for(var o,l,h=e;e.prev!==e.next;)if(o=e.prev,l=e.next,s?Earcut.isEarHashed(e,i,a,s):Earcut.isEar(e))t.push(o.i/r),t.push(e.i/r),t.push(l.i/r),Earcut.removeNode(e),e=l.next,h=l.next;else if((e=l)===h){n?1===n?(e=Earcut.cureLocalIntersections(e,t,r),Earcut.earcutLinked(e,t,r,i,a,s,2)):2===n&&Earcut.splitEarcut(e,t,r,i,a,s):Earcut.earcutLinked(Earcut.filterPoints(e,null),t,r,i,a,s,1);break}}}static isEar(e){var t=e.prev,r=e,i=e.next;if(Earcut.area(t,r,i)>=0)return!1;for(var a=e.next.next;a!==e.prev;){if(Earcut.pointInTriangle(t.x,t.y,r.x,r.y,i.x,i.y,a.x,a.y)&&Earcut.area(a.prev,a,a.next)>=0)return!1;a=a.next}return!0}static isEarHashed(e,t,r,i){var a=e.prev,s=e,n=e.next;if(Earcut.area(a,s,n)>=0)return!1;for(var o=a.x<s.x?a.x<n.x?a.x:n.x:s.x<n.x?s.x:n.x,l=a.y<s.y?a.y<n.y?a.y:n.y:s.y<n.y?s.y:n.y,h=a.x>s.x?a.x>n.x?a.x:n.x:s.x>n.x?s.x:n.x,d=a.y>s.y?a.y>n.y?a.y:n.y:s.y>n.y?s.y:n.y,u=Earcut.zOrder(o,l,t,r,i),c=Earcut.zOrder(h,d,t,r,i),_=e.nextZ;_&&_.z<=c;){if(_!==e.prev&&_!==e.next&&Earcut.pointInTriangle(a.x,a.y,s.x,s.y,n.x,n.y,_.x,_.y)&&Earcut.area(_.prev,_,_.next)>=0)return!1;_=_.nextZ}for(_=e.prevZ;_&&_.z>=u;){if(_!==e.prev&&_!==e.next&&Earcut.pointInTriangle(a.x,a.y,s.x,s.y,n.x,n.y,_.x,_.y)&&Earcut.area(_.prev,_,_.next)>=0)return!1;_=_.prevZ}return!0}static cureLocalIntersections(e,t,r){var i=e;do{var a=i.prev,s=i.next.next;!Earcut.equals(a,s)&&Earcut.intersects(a,i,i.next,s)&&Earcut.locallyInside(a,s)&&Earcut.locallyInside(s,a)&&(t.push(a.i/r),t.push(i.i/r),t.push(s.i/r),Earcut.removeNode(i),Earcut.removeNode(i.next),i=e=s),i=i.next}while(i!==e);return i}static splitEarcut(e,t,r,i,a,s){var n=e;do{for(var o=n.next.next;o!==n.prev;){if(n.i!==o.i&&Earcut.isValidDiagonal(n,o)){var l=Earcut.splitPolygon(n,o);return n=Earcut.filterPoints(n,n.next),l=Earcut.filterPoints(l,l.next),Earcut.earcutLinked(n,t,r,i,a,s),void Earcut.earcutLinked(l,t,r,i,a,s)}o=o.next}n=n.next}while(n!==e)}static eliminateHoles(e,t,r,i){var a,s,n,o,l,h=[];for(a=0,s=t.length;a<s;a++)n=t[a]*i,o=a<s-1?t[a+1]*i:e.length,(l=Earcut.linkedList(e,n,o,i,!1))===l.next&&(l.steiner=!0),h.push(Earcut.getLeftmost(l));for(h.sort(Earcut.compareX),a=0;a<h.length;a++)Earcut.eliminateHole(h[a],r),r=Earcut.filterPoints(r,r.next);return r}static compareX(e,t){return e.x-t.x}static eliminateHole(e,t){if(t=Earcut.findHoleBridge(e,t)){var r=Earcut.splitPolygon(t,e);Earcut.filterPoints(r,r.next)}}static findHoleBridge(e,t){var r,i=t,a=e.x,s=e.y,n=-1/0;do{if(s<=i.y&&s>=i.next.y&&i.next.y!==i.y){var o=i.x+(s-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(o<=a&&o>n){if(n=o,o===a){if(s===i.y)return i;if(s===i.next.y)return i.next}r=i.x<i.next.x?i:i.next}}i=i.next}while(i!==t);if(!r)return null;if(a===n)return r.prev;var l,h=r,d=r.x,u=r.y,c=1/0;for(i=r.next;i!==h;)a>=i.x&&i.x>=d&&a!==i.x&&Earcut.pointInTriangle(s<u?a:n,s,d,u,s<u?n:a,s,i.x,i.y)&&((l=Math.abs(s-i.y)/(a-i.x))<c||l===c&&i.x>r.x)&&Earcut.locallyInside(i,e)&&(r=i,c=l),i=i.next;return r}static indexCurve(e,t,r,i){var a=e;do{null===a.z&&(a.z=Earcut.zOrder(a.x,a.y,t,r,i)),a.prevZ=a.prev,a.nextZ=a.next,a=a.next}while(a!==e);a.prevZ.nextZ=null,a.prevZ=null,Earcut.sortLinked(a)}static sortLinked(e){var t,r,i,a,s,n,o,l,h=1;do{for(r=e,e=null,s=null,n=0;r;){for(n++,i=r,o=0,t=0;t<h&&(o++,i=i.nextZ);t++);for(l=h;o>0||l>0&&i;)0!==o&&(0===l||!i||r.z<=i.z)?(a=r,r=r.nextZ,o--):(a=i,i=i.nextZ,l--),s?s.nextZ=a:e=a,a.prevZ=s,s=a;r=i}s.nextZ=null,h*=2}while(n>1);return e}static zOrder(e,t,r,i,a){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-r)*a)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-i)*a)|t<<8))|t<<4))|t<<2))|t<<1))<<1}static getLeftmost(e){var t=e,r=e;do{t.x<r.x&&(r=t),t=t.next}while(t!==e);return r}static pointInTriangle(e,t,r,i,a,s,n,o){return(a-n)*(t-o)-(e-n)*(s-o)>=0&&(e-n)*(i-o)-(r-n)*(t-o)>=0&&(r-n)*(s-o)-(a-n)*(i-o)>=0}static isValidDiagonal(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!Earcut.intersectsPolygon(e,t)&&Earcut.locallyInside(e,t)&&Earcut.locallyInside(t,e)&&Earcut.middleInside(e,t)}static area(e,t,r){return(t.y-e.y)*(r.x-t.x)-(t.x-e.x)*(r.y-t.y)}static equals(e,t){return e.x===t.x&&e.y===t.y}static intersects(e,t,r,i){return!!(Earcut.equals(e,t)&&Earcut.equals(r,i)||Earcut.equals(e,i)&&Earcut.equals(r,t))||Earcut.area(e,t,r)>0!=Earcut.area(e,t,i)>0&&Earcut.area(r,i,e)>0!=Earcut.area(r,i,t)>0}static intersectsPolygon(e,t){var r=e;do{if(r.i!==e.i&&r.next.i!==e.i&&r.i!==t.i&&r.next.i!==t.i&&Earcut.intersects(r,r.next,e,t))return!0;r=r.next}while(r!==e);return!1}static locallyInside(e,t){return Earcut.area(e.prev,e,e.next)<0?Earcut.area(e,t,e.next)>=0&&Earcut.area(e,e.prev,t)>=0:Earcut.area(e,t,e.prev)<0||Earcut.area(e,e.next,t)<0}static middleInside(e,t){var r=e,i=!1,a=(e.x+t.x)/2,s=(e.y+t.y)/2;do{r.y>s!=r.next.y>s&&r.next.y!==r.y&&a<(r.next.x-r.x)*(s-r.y)/(r.next.y-r.y)+r.x&&(i=!i),r=r.next}while(r!==e);return i}static splitPolygon(e,t){var r=new EarcutNode(e.i,e.x,e.y),i=new EarcutNode(t.i,t.x,t.y),a=e.next,s=t.prev;return e.next=t,t.prev=e,r.next=a,a.prev=r,i.next=r,r.prev=i,s.next=i,i.prev=s,i}static insertNode(e,t,r,i){var a=new EarcutNode(e,t,r);return i?(a.next=i.next,a.prev=i,i.next.prev=a,i.next=a):(a.prev=a,a.next=a),a}static removeNode(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}static signedArea(e,t,r,i){for(var a=0,s=t,n=r-i;s<r;s+=i)a+=(e[n]-e[s])*(e[s+1]+e[n+1]),n=s;return a}}class SubmitKey{constructor(){this.clear()}clear(){this.submitType=-1,this.blendShader=this.other=0}}class SubmitBase{constructor(){this.clipInfoID=-1,this.blendType=-1,this._id=0,this._renderType=0,this._key=new SubmitKey,this._startIdx=0,this._numEle=0,this._colorFiler=null,this.shaderValue=null,this._id=++SubmitBase.ID}static create(e,t,r){var i=new SubmitBase;i._mesh=t,i._key.clear(),i._key.submitType=SubmitBase.KEY_DRAWTEXTURE,i._startIdx=t.indexNum*Const.INDEX_BYTES,i._numEle=0;var a=e._nBlendType;return i._key.blendShader=a,i.shaderValue=r,i.material=e.material,i._colorFiler=e._colorFiler,i}}SubmitBase.KEY_ONCE=-1,SubmitBase.KEY_FILLRECT=1,SubmitBase.KEY_DRAWTEXTURE=2,SubmitBase.KEY_VG=3,SubmitBase.KEY_TRIANGLES=4,SubmitBase.ID=1,SubmitBase.RENDERBASE=new SubmitBase;class RenderInfo{}RenderInfo.loopStTm=0,RenderInfo.loopCount=0;class CharSubmitCache{constructor(){this._data=[],this._ndata=0,this._clipid=-1,this._clipMatrix=new Matrix,this._enable=!1}clear(){this._tex=null,this._imgId=-1,this._ndata=0,this._enable=!1,this._colorFiler=null}destroy(){this.clear(),this._data.length=0,this._data=null}add(e,t,r,i,a,s){this._ndata>0&&(this._tex!=t||this._imgId!=r||this._clipid>=0&&this._clipid!=e._clipInfoID)&&this.submit(e),this._clipid=e._clipInfoID,e._globalClipMatrix.copyTo(this._clipMatrix),this._tex=t,this._imgId=r,this._colorFiler=e._colorFiler,this._data[this._ndata]=i,this._data[this._ndata+1]=a,this._data[this._ndata+2]=s,this._ndata+=3}getPos(){return 0==CharSubmitCache.__nPosPool?new Array(8):CharSubmitCache.__posPool[--CharSubmitCache.__nPosPool]}enable(e,t){e!==this._enable&&(this._enable=e,this._enable||this.submit(t))}submit(t){var r=this._ndata;if(r){var i=t._mesh,a=t._colorFiler;t._colorFiler=this._colorFiler;var s=SubmitBase.create(t,i,Value2D.create(e.RenderSpriteData.Texture2D));s.shaderValue.textureHost=this._tex,s._key.other=this._imgId,t._colorFiler=a,s.clipInfoID=this._clipid;for(var n=0;n<r;n+=3)i.addQuad(this._data[n],this._data[n+1],this._data[n+2],!0),CharSubmitCache.__posPool[CharSubmitCache.__nPosPool++]=this._data[n];r/=3,s._numEle+=6*r,t._drawCount+=r,this._ndata=0,RenderInfo.loopCount%100==0&&(this._data.length=0)}}}CharSubmitCache.__posPool=[],CharSubmitCache.__nPosPool=0;class CharRenderInfo{constructor(){this.isRandomTouch=!0,this.char="",this.deleted=!1,this.uv=new Array(8),this.pos=0,this.orix=0,this.oriy=0,this.touchTick=0,this.isSpace=!1}touch(){var e=RenderInfo.loopCount;this.touchTick!=e&&(this.texture.touchRect(this,e),this.touchTick=e)}}var le,he=[0,0,0,0];class MeasureFont{constructor(e){this.charRender=e}getFontSizeInfo(e,t){let r="bold "+t+"px "+e;he[0]=t/2,he[1]=t/2,he[2]=t,he[3]=t;this.charRender.scale(1,1),MeasureFont.tmpRI.height=t,this.charRender.fontsz=t;var i=this.charRender.getCharBmp("g",r,0,"red",null,MeasureFont.tmpRI,16,16,16,16);return this.bmpData32=new Uint32Array(i.data.buffer),this.updateBbx(i,he,!1),i=this.charRender.getCharBmp("有",r,0,"red",null,MeasureFont.tmpRI,16,16,16,16),this.bmpData32=new Uint32Array(i.data.buffer),he[2]<16+MeasureFont.tmpRI.width&&(he[2]=16+MeasureFont.tmpRI.width),this.updateBbx(i,he,!1),Math.max(16-he[0],0)<<24|Math.max(16-he[1],0)<<16|he[2]-he[0]<<8|he[3]-he[1]}checkBmpLine(e,t,r,i){this.bmpData32.buffer!=e.data.buffer&&(this.bmpData32=new Uint32Array(e.data.buffer));for(var a=e.width*t+r,s=r;s<i;s++)if(0!=this.bmpData32[a++])return!0;return!1}updateBbx(e,t,r=!1){var i=e.width,a=e.height,s=0,n=t[1],o=0,l=n;if(this.checkBmpLine(e,n,0,i))for(;;){if((l=(n+o)/2|0)+1>=n){t[1]=l;break}this.checkBmpLine(e,l,0,i)?n=l:o=l}if(t[3]>a)t[3]=a;else if(l=n=t[3],o=a,this.checkBmpLine(e,n,0,i))for(;;){if((l=(n+o)/2|0)-1<=n){t[3]=l;break}this.checkBmpLine(e,l,0,i)?n=l:o=l}if(!r){var h=t[0],d=i*t[1];for(l=t[1];l<t[3];l++){for(s=0;s<h;s++)if(0!=this.bmpData32[d+s]){h=s;break}d+=i}t[0]=h;var u=t[2];for(d=i*t[1],l=t[1];l<t[3];l++){for(s=u;s<i;s++)if(0!=this.bmpData32[d+s]){u=s;break}d+=i}t[2]=u}}}MeasureFont.tmpRI=new CharRenderInfo;class AtlasGrid{constructor(e=0,t=0,r=0){this.atlasID=0,this._width=0,this._height=0,this._texCount=0,this._rowInfo=null,this._cells=null,this._used=0,this._cells=null,this._rowInfo=null,this.atlasID=r,this._init(e,t)}addRect(e,t,r,i){return!!this._get(t,r,i)&&(this._fill(i.x,i.y,t,r,e),this._texCount++,!0)}_release(){this._cells=null,this._rowInfo=null}_init(e,t){return this._width=e,this._height=t,this._release(),0!=this._width&&(this._cells=new Uint8Array(this._width*this._height*3),this._rowInfo=new Uint8Array(this._height),this._used=0,this._clear(),!0)}_get(e,t,r){if(e>this._width||t>this._height)return!1;for(var i=-1,a=-1,s=this._width,n=this._height,o=this._cells,l=0;l<n;l++)if(!(this._rowInfo[l]<e))for(var h=0;h<s;){var d=3*(l*s+h);if(0!=o[d]||o[d+1]<e||o[d+2]<t)h+=o[d+1];else{i=h,a=l;for(var u=0;u<e;u++)if(o[3*u+d+2]<t){i=-1;break}if(!(i<0))return r.x=i,r.y=a,!0;h+=o[d+1]}}return!1}_fill(e,t,r,i,a){var s=this._width,n=this._height;this._check(e+r<=s&&t+i<=n);for(var o=t;o<i+t;++o){this._check(this._rowInfo[o]>=r),this._rowInfo[o]-=r;for(var l=0;l<r;l++){var h=3*(e+o*s+l);this._check(0==this._cells[h]),this._cells[h]=a,this._cells[h+1]=r,this._cells[h+2]=i}}if(e>0)for(o=0;o<i;++o){var d=0;for(l=e-1;l>=0&&0==this._cells[3*((t+o)*s+l)];--l,++d);for(l=d;l>0;--l)this._cells[3*((t+o)*s+e-l)+1]=l,this._check(l>0)}if(t>0)for(l=e;l<e+r;++l){for(d=0,o=t-1;o>=0&&0==this._cells[3*(l+o*s)];--o,d++);for(o=d;o>0;--o)this._cells[3*(l+(t-o)*s)+2]=o,this._check(o>0)}this._used+=r*i/(this._width*this._height)}_check(e){0==e&&console.log("xtexMerger 错误啦")}_clear(){this._texCount=0;for(var e=0;e<this._height;e++)this._rowInfo[e]=this._width;for(var t=0;t<this._height;t++)for(var r=0;r<this._width;r++){var i=3*(t*this._width+r);this._cells[i]=0,this._cells[i+1]=this._width-r,this._cells[i+2]=this._width-t}}}e.WrapMode=void 0,(le=e.WrapMode||(e.WrapMode={}))[le.Repeat=0]="Repeat",le[le.Clamp=1]="Clamp",le[le.Mirrored=2]="Mirrored";class TextTexture extends Texture2D{constructor(t=TextRender.atlasWidth,r=TextRender.atlasWidth){super(t,r,e.TextureFormat.R8G8B8A8,!1,!1,!0,!0),this._discardTm=0,this.genID=0,this.curUsedCovRate=0,this.curUsedCovRateAtlas=0,this.lastTouchTm=0,this.ri=null,this.setPixelsData(null,!0,!1),this.lock=!0,this.filterMode=e.FilterMode.Bilinear,this.wrapModeU=e.WrapMode.Clamp,this.wrapModeV=e.WrapMode.Clamp,TextRender.debugUV&&this.fillWhite()}addChar(e,t,r,i=null){if(TextRender.isWan1Wan)return this.addCharCanvas(e,t,r,i);var a,s,n,o,l=e.data;return e.data instanceof Uint8ClampedArray&&(l=new Uint8Array(l.buffer)),LayaGL.textureContext.setTextureSubPixelsData(this._texture,l,0,!1,t,r,e.width,e.height,!0,!1),a=t/this.width,s=r/this.height,n=(t+e.width)/this.width,o=(r+e.height)/this.height,(i=i||new Array(8))[0]=a,i[1]=s,i[2]=n,i[3]=s,i[4]=n,i[5]=o,i[6]=a,i[7]=o,i}addCharCanvas(e,t,r,i=null){var a,s,n,o;return LayaGL.textureContext.setTextureSubImageData(this._texture,e,t,r,!0,!1),LayaEnv.isConch?(a=t/this.width,s=r/this.height,n=(t+e.width)/this.width,o=(r+e.height)/this.height):(a=(t+1)/this.width,s=(r+1)/this.height,n=(t+e.width-1)/this.width,o=(r+e.height-1)/this.height),(i=i||new Array(8))[0]=a,i[1]=s,i[2]=n,i[3]=s,i[4]=n,i[5]=o,i[6]=a,i[7]=o,i}fillWhite(){var e=new Uint8Array(this.width*this.height*4);e.fill(255),LayaGL.textureContext.setTextureImageData(this._getSource(),e,!0,!1)}discard(){ILaya.stage.setGlobalRepaint(),this.destroy()}static getTextTexture(e,t){return new TextTexture(e,t)}_disposeResource(){this.destroy()}static clean(){var e=RenderInfo.loopStTm;if(0===TextTexture.cleanTm&&(TextTexture.cleanTm=e),e-TextTexture.cleanTm>=TextRender.checkCleanTextureDt){for(let r=0;r<TextTexture.poolLen;r++){var t=TextTexture.pool[r];e-t._discardTm>=TextRender.destroyUnusedTextureDt&&(t.destroy(),TextTexture.pool[r]=TextTexture.pool[TextTexture.poolLen-1],TextTexture.poolLen--,r--)}TextTexture.cleanTm=e}}touchTexture(){let e=RenderInfo.loopCount;this.lastTouchTm!=e&&(this.curUsedCovRate=0,this.curUsedCovRateAtlas=0,this.lastTouchTm=e)}touchRect(e,t){this.lastTouchTm!=t&&(this.curUsedCovRate=0,this.curUsedCovRateAtlas=0,this.lastTouchTm=t);var r=TextRender.atlasWidth*TextRender.atlasWidth,i=TextAtlas.atlasGridW*TextAtlas.atlasGridW;this.curUsedCovRate+=e.bmpWidth*e.bmpHeight/r,this.curUsedCovRateAtlas+=Math.ceil(e.bmpWidth/TextAtlas.atlasGridW)*Math.ceil(e.bmpHeight/TextAtlas.atlasGridW)/(r/i)}}TextTexture.pool=new Array(10),TextTexture.poolLen=0,TextTexture.cleanTm=0,TextTexture.EVENT_REUSE="texture_recycling";class TextAtlas{constructor(){this.texWidth=1024,this.texHeight=1024,this.texture=null,this.charMaps={},this.texHeight=this.texWidth=TextRender.atlasWidth,this.texture=TextTexture.getTextTexture(this.texWidth,this.texHeight),this.texWidth/TextAtlas.atlasGridW>256&&(TextAtlas.atlasGridW=Math.ceil(this.texWidth/256)),this.atlasgrid=new AtlasGrid(this.texWidth/TextAtlas.atlasGridW,this.texHeight/TextAtlas.atlasGridW,this.texture.id)}setProtecteDist(e){}getAEmpty(e,t,r){var i=this.atlasgrid.addRect(1,Math.ceil(e/TextAtlas.atlasGridW),Math.ceil(t/TextAtlas.atlasGridW),r);return i&&(r.x*=TextAtlas.atlasGridW,r.y*=TextAtlas.atlasGridW),i}get usedRate(){return this.atlasgrid._used}destroy(){for(var e in this.charMaps){this.charMaps[e].deleted=!0}this.texture.discard()}printDebugInfo(){}}TextAtlas.atlasGridW=16;class FontInfo{constructor(e){this._family="Arial",this._size=14,this._italic=!1,this._bold=!1,this.setFont(e||"14px Arial")}static parse(e){if(e===me)return de;let t=FontInfo._cache[e];return t||(t=FontInfo._cache[e]=new FontInfo(e)),me=e,de=t,t}setFont(e){this._font=e;var t=e.split(" "),r=t.length;if(r<2)1==r&&t[0].indexOf("px")>0&&(this._size=parseInt(t[0]));else{var i=-1;for(let a=0;a<r;a++)if(t[a].indexOf("px")>0||t[a].indexOf("pt")>0){i=a,this._size=parseInt(t[a]),this._size<=0&&(console.debug("font parse error:"+e),this._size=14);break}var a=i+1,s=t[a];for(a++;a<r;a++)s+=" "+t[a];this._family=s.split(",")[0],this._italic=t.indexOf("italic")>=0,this._bold=t.indexOf("bold")>=0}}}FontInfo._cache={};var de,ue,ce,_e,pe,ge,me="";class WordText{constructor(){this.pagecharsCtx=null,this.width=-1,this.pageChars=[],this.scalex=1,this.scaley=1}setText(e){this.text=e,this._nativeObj?this._nativeObj._text=e:this.width=-1,this.cleanCache()}toString(){return this.text}get length(){return this.text?this.text.length:0}cleanCache(){if(this._nativeObj)return void this._nativeObj.cleanCache();let e=this.pageChars;if(e.length>0){for(var t in e){let r=e[t];if(!r)continue;let i=r.tex;1==r.words.length&&i&&i.ri&&i.destroy()}this.pageChars=[]}this.scalex=1,this.scaley=1}get splitRender(){return this._splitRender}set splitRender(e){this._splitRender=e,this._nativeObj&&(this._nativeObj.splitRender=e)}}class ICharRender{constructor(){this.fontsz=16}getWidth(e,t){return 0}scale(e,t){}get canvasWidth(){return 0}set canvasWidth(e){}getCharBmp(e,t,r,i,a,s,n,o,l,h,d=null){return null}}class CharRender_Canvas extends ICharRender{constructor(e,t,r=!0,i=!0,a=!1){super(),this.ctx=null,this.lastScaleX=1,this.lastScaleY=1,this.maxTexW=0,this.maxTexH=0,this.scaleFontSize=!0,this.showDbgInfo=!1,this.supportImageData=!0,this.maxTexW=e,this.maxTexH=t,this.scaleFontSize=r,this.supportImageData=i,this.showDbgInfo=a,CharRender_Canvas.canvas||(CharRender_Canvas.canvas=Browser.createElement("canvas"),CharRender_Canvas.canvas.width=1024,CharRender_Canvas.canvas.height=512,CharRender_Canvas.canvas.style.left="-10000px",CharRender_Canvas.canvas.style.position="absolute",window.document.body.appendChild(CharRender_Canvas.canvas),this.ctx=CharRender_Canvas.canvas.getContext("2d",{willReadFrequently:!0}))}get canvasWidth(){return CharRender_Canvas.canvas.width}set canvasWidth(e){CharRender_Canvas.canvas.width!=e&&(CharRender_Canvas.canvas.width=e,e>2048&&console.warn("画文字设置的宽度太大，超过2048了"),this.ctx.setTransform(1,0,0,1,0,0),this.ctx.scale(this.lastScaleX,this.lastScaleY))}getWidth(e,t){return this.ctx?(this.ctx._lastFont!=e&&(this.ctx.font=e,this.ctx._lastFont=e),this.ctx.measureText(t).width):0}scale(e,t){if(!this.supportImageData)return this.lastScaleX=e,void(this.lastScaleY=t);this.lastScaleX==e&&this.lastScaleY==t||(this.ctx.setTransform(e,0,0,t,0,0),this.lastScaleX=e,this.lastScaleY=t)}getCharBmp(e,t,r,i,a,s,n,o,l,h,d=null){if(!this.supportImageData)return this.getCharCanvas(e,t,r,i,a,s,n,o,l,h);var u=this.ctx,c=this.fontsz;u.font!=t&&(u.font=t,u._lastFont=t),s.width=u.measureText(e).width;var _=s.width*this.lastScaleX,p=s.height*this.lastScaleY;_+=(n+l)*this.lastScaleX,p+=(o+h)*this.lastScaleY,_=Math.ceil(_),p=Math.ceil(p);var g=(_=Math.min(_,CharRender_Canvas.canvas.width))+2*r+1,m=(p=Math.min(p,CharRender_Canvas.canvas.height))+2*r+1;d&&(g=Math.max(g,d[0]+d[2]+1),m=Math.max(m,d[1]+d[3]+1)),u.clearRect(0,0,g/this.lastScaleX+1,m/this.lastScaleY+1),u.save(),u.textBaseline="middle",r>0&&(u.lineJoin="round",u.strokeStyle=a,u.lineWidth=r,u.strokeText(e,n,o+c/2)),i&&(u.fillStyle=i,u.fillText(e,n,o+c/2)),this.showDbgInfo&&(u.strokeStyle="#ff0000",u.strokeRect(1,1,_-2,p-2),u.strokeStyle="#00ff00",u.strokeRect(n,o,s.width,s.height)),d&&(d[2]<=0&&(d[2]=Math.ceil(-d[2]+(s.width+2*r)*this.lastScaleX)),d[2]<=0&&(d[2]=1));var f=d?u.getImageData(d[0],d[1],d[2],d[3]+1):u.getImageData(0,0,_,p+1);return u.restore(),s.bmpWidth=f.width,s.bmpHeight=f.height,f}getCharCanvas(e,t,r,i,a,s,n,o,l,h){var d=this.ctx;d.font!=t&&(d.font=t,d._lastFont=t),s.width=d.measureText(e).width;var u=s.width*this.lastScaleX,c=s.height*this.lastScaleY;u+=(n+l)*this.lastScaleX,c+=(o+h)*this.lastScaleY+1,u=Math.min(u,this.maxTexW),c=Math.min(c,this.maxTexH),CharRender_Canvas.canvas.width=Math.min(u+1,this.maxTexW),CharRender_Canvas.canvas.height=Math.min(c+1,this.maxTexH),d.font=t,d.clearRect(0,0,u+1+r,c+1+r),d.setTransform(1,0,0,1,0,0),d.save(),this.scaleFontSize&&d.scale(this.lastScaleX,this.lastScaleY),d.translate(n,o),d.textAlign="left";var _=this.fontsz;return d.textBaseline="middle",r>0?(d.lineJoin="round",d.strokeStyle=a,d.fillStyle=i,d.lineWidth=r,d.fillAndStrokeText?d.fillAndStrokeText(e,0,_/2):(d.strokeText(e,0,_/2),d.fillText(e,0,_/2))):i&&(d.fillStyle=i,d.fillText(e,0,_/2)),this.showDbgInfo&&(d.strokeStyle="#ff0000",d.strokeRect(0,0,u,c),d.strokeStyle="#00ff00",d.strokeRect(0,0,s.width,s.height)),d.restore(),s.bmpWidth=CharRender_Canvas.canvas.width,s.bmpHeight=CharRender_Canvas.canvas.height,CharRender_Canvas.canvas}}CharRender_Canvas.canvas=null;class TextRender extends EventDispatcher{constructor(){super(),this.fontSizeInfo={},this.mapFont={},this.fontID=0,this.fontScaleX=1,this.fontScaleY=1,this._curStrPos=0,this.textAtlases=[],this.isoTextures=[],this.lastFont=null,this.fontSizeW=0,this.fontSizeH=0,this.fontSizeOffX=0,this.fontSizeOffY=0,this.renderPerChar=!0,this.tmpAtlasPos=new Point,this._fontMeasure=null;var e=!1,t=ILaya.Laya.MiniAdpter;t&&t.systemInfo&&t.systemInfo.system&&(e="ios 10.1.1"===t.systemInfo.system.toLowerCase()),(ILaya.Browser.onMiniGame||ILaya.Browser.onTTMiniGame||ILaya.Browser.onBLMiniGame||ILaya.Browser.onAlipayMiniGame||ILaya.Browser.onTBMiniGame)&&!e&&(TextRender.isWan1Wan=!0),this.charRender=new CharRender_Canvas(2048,2048,TextRender.scaleFontWithCtx,!TextRender.isWan1Wan,!1),TextRender.textRenderInst=this,ILaya.Laya.textRender=this}set fontMeasure(e){this._fontMeasure=e}get fontMeasure(){return this._fontMeasure}_wan1wansz(e,t){let r="bold "+t+"px "+e;var i=1.5*this.charRender.getWidth(r,"有")<<8|1.5*t;return this.fontSizeInfo[e]=i,i}getFontSizeInfo(e){var t=this.fontSizeInfo[e];return t||(t=TextRender.isWan1Wan?this._wan1wansz(e,TextRender.standardFontSize):this._fontMeasure.getFontSizeInfo(e,TextRender.standardFontSize),this.fontSizeInfo[e]=t),t}setFont(e){if(this.lastFont!=e){this.lastFont=e;var t=this.getFontSizeInfo(e._family),r=t>>24,i=t>>16&255,a=t>>8&255,s=255&t,n=e._size/TextRender.standardFontSize;this.fontSizeOffX=Math.ceil(r*n),this.fontSizeOffY=Math.ceil(i*n),this.fontSizeW=Math.ceil(a*n),this.fontSizeH=Math.ceil(s*n),e._font.indexOf("italic")>=0?this.fontStr=e._font.replace("italic",""):this.fontStr=e._font}}getNextChar(e){var t=e.length,r=this._curStrPos;if(!e.substring)return null;if(r>=t)return null;for(var i=r,a=0;i<t;i++){var s=e.charCodeAt(i);if(s>>>11==27){if(1==a)break;a=1,i++}else if(65038===s||65039===s);else if(8205==s)a=2;else if(0==a)a=1;else if(1==a)break}return this._curStrPos=i,e.substring(r,i)}filltext(e,t,r,i,a,s,n,o,l){if(!(t.length<=0)){var h=FontInfo.parse(a),d=0;switch(l){case"center":d=Const.ENUM_TEXTALIGN_CENTER;break;case"right":d=Const.ENUM_TEXTALIGN_RIGHT}this._fast_filltext(e,t,r,i,h,s,n,o,d)}}_fast_filltext(e,t,r,i,a,s,n,o,l){if(t&&!(t.length>=1))return;if(o<0&&(o=0),this.setFont(a),this.fontScaleX=this.fontScaleY=1,TextRender.scaleFontWithCtx){let t=e.getMatScaleX(),r=e.getMatScaleY();if(t<1e-4||r<.1)return;t>1&&(this.fontScaleX=Math.min(TextRender.maxFontScale,t)),r>1&&(this.fontScaleY=Math.min(TextRender.maxFontScale,r))}a._italic&&(e._italicDeg=13);let h=t,d=t instanceof WordText,u=t&&t.toString(),c=d?h.pageChars:[],_=0;switch(d?(u=h.text,_=h.width,_<0&&(_=h.width=this.charRender.getWidth(this.fontStr,u))):_=u?this.charRender.getWidth(this.fontStr,u):0,l){case Const.ENUM_TEXTALIGN_CENTER:r-=_/2;break;case Const.ENUM_TEXTALIGN_RIGHT:r-=_}d&&(this.hasFreedText(c)||h.pagecharsCtx!=e)&&(c=h.pageChars=[]);let p=this.renderPerChar=!d||TextRender.forceSplitRender||d&&h.splitRender;if(!c||c.length<1){if(d&&(h.scalex=this.fontScaleX,h.scaley=this.fontScaleY),p){let e,t=0,r=0;for(this._curStrPos=0;e=this.getNextChar(u),e;){let i=this.getCharRenderInfo(e,a,s,n,o,!1);if(!i)break;if(i.isSpace);else{var g=c[i.texture.id];if(g)g=g.words;else{var m={texgen:i.texture.genID,tex:i.texture,words:new Array};c[i.texture.id]=m,g=m.words}g.push({ri:i,x:t,y:r,w:i.bmpWidth/this.fontScaleX,h:i.bmpHeight/this.fontScaleY}),t+=i.width}}}else{let e=a._size/3|0,t=TextRender.noAtlas||(_+e+e)*this.fontScaleX>TextRender.atlasWidth,r=this.getCharRenderInfo(u,a,s,n,o,t);c[0]={texgen:r.texture.genID,tex:r.texture,words:[{ri:r,x:0,y:0,w:r.bmpWidth/this.fontScaleX,h:r.bmpHeight/this.fontScaleY}]}}d&&(h.pagecharsCtx=e)}this._drawResortedWords(e,r,i,c),e._italicDeg=0}_drawResortedWords(e,t,r,i){var a=!!e._charSubmitCache&&e._charSubmitCache._enable,s=e._curMat;for(var n in i){var o=i[n];if(o){var l=o.words,h=l.length;if(!(h<=0))for(var d=i[n].tex,u=0;u<h;u++){var c=l[u],_=c.ri;_.isSpace||(e.touchRes(_),e.drawTexAlign=!0,e._inner_drawTexture(d,d.id,t+c.x-_.orix,r+c.y-_.oriy,c.w,c.h,s,_.uv,1,a,4294967295))}}}}hasFreedText(e){for(let i in e){var t=e[i];if(t){var r=t.tex;if(r.destroyed||r.genID!=t.texgen)return!0}}return!1}getCharRenderInfo(e,t,r,i,a,s=!1){var n=this.mapFont[t._family];null==n&&(this.mapFont[t._family]=n=this.fontID++);var o=e+"_"+n+"_"+t._size+"_"+r;a>0&&(o+="_"+i+a),t._bold&&(o+="P"),1==this.fontScaleX&&1==this.fontScaleY||(o+=(20*this.fontScaleX|0)+"_"+(20*this.fontScaleY|0));var l,h,d=0,u=this.textAtlases.length;if(!s)for(d=0;d<u;d++)if(l=(h=this.textAtlases[d]).charMaps[o])return l.touch(),l;l=new CharRenderInfo,this.charRender.scale(this.fontScaleX,this.fontScaleY),l.char=e,l.height=t._size;var c=t._size/3|0,_=null;a||(a=0);var p=Math.ceil((this.charRender.getWidth(this.fontStr,e)+2*a)*this.fontScaleX);if(p>this.charRender.canvasWidth&&(this.charRender.canvasWidth=Math.min(2048,p+2*c)),s){if(this.charRender.fontsz=t._size,_=this.charRender.getCharBmp(e,this.fontStr,a,r,i,l,c,c,c,c,null)){var g=TextTexture.getTextTexture(_.width,_.height);g.addChar(_,0,0,l.uv),l.texture=g,l.orix=c,l.oriy=c,g.ri=l,this.isoTextures.push(g)}}else{var m=e.length,f=1*a,S=Math.ceil((this.fontSizeW+2*f)*this.fontScaleX),y=Math.ceil((this.fontSizeH+2*f)*this.fontScaleY);TextRender.imgdtRect[0]=(c-this.fontSizeOffX-f)*this.fontScaleX|0,TextRender.imgdtRect[1]=(c-this.fontSizeOffY-f)*this.fontScaleY|0,this.renderPerChar||1==m?(TextRender.imgdtRect[2]=Math.max(p,S),TextRender.imgdtRect[3]=Math.max(p,y)):(TextRender.imgdtRect[2]=-this.fontSizeOffX*this.fontScaleX,TextRender.imgdtRect[3]=y),this.charRender.fontsz=t._size,(_=this.charRender.getCharBmp(e,this.fontStr,a,r,i,l,c,c,c,c,TextRender.imgdtRect))&&(h=this.addBmpData(_,l),TextRender.isWan1Wan?(l.orix=c,l.oriy=c):(l.orix=this.fontSizeOffX+f,l.oriy=this.fontSizeOffY+f),h.charMaps[o]=l)}return l}addBmpData(e,t){for(var r,i=e.width,a=e.height,s=this.textAtlases.length,n=!1,o=0;o<s&&!(n=(r=this.textAtlases[o]).getAEmpty(i,a,this.tmpAtlasPos));o++);if(!n){if(r=new TextAtlas,this.textAtlases.push(r),!(n=r.getAEmpty(i,a,this.tmpAtlasPos)))throw"err1";this.cleanAtlases()}return n&&(r.texture.addChar(e,this.tmpAtlasPos.x,this.tmpAtlasPos.y,t.uv),t.texture=r.texture),r}GC(){for(var e=0,t=this.textAtlases.length,r=TextRender.destroyAtlasDt,i=0,a=RenderInfo.loopCount,s=-1,n=0,o=null,l=null;e<t;e++){if(o=(l=this.textAtlases[e]).texture){i+=o.curUsedCovRateAtlas;var h=l.usedRate-o.curUsedCovRateAtlas;n<h&&(n=h,s=e)}a-l.texture.lastTouchTm>r&&(TextRender.showLog&&console.log(l.texture.id),l.destroy(),this.textAtlases[e]=this.textAtlases[t-1],t--,e--,s=-1)}for(this.textAtlases.length=t,t=this.isoTextures.length,e=0;e<t;e++)a-(o=this.isoTextures[e]).lastTouchTm>TextRender.destroyUnusedTextureDt&&(o.ri.deleted=!0,o.ri.texture=null,o.destroy(),this.isoTextures[e]=this.isoTextures[t-1],t--,e--);this.isoTextures.length=t;var d=this.textAtlases.length>1&&this.textAtlases.length-i>=2;(TextRender.atlasWidth*TextRender.atlasWidth*4*this.textAtlases.length>TextRender.cleanMem||d||TextRender.simClean)&&(TextRender.simClean=!1,TextRender.showLog&&console.log("清理使用率低的贴图。总使用率:",i,":",this.textAtlases.length,"最差贴图:"+s),s>=0&&((l=this.textAtlases[s]).destroy(),this.textAtlases[s]=this.textAtlases[this.textAtlases.length-1],this.textAtlases.length=this.textAtlases.length-1,this.event("GC")))}cleanAtlases(){}printDbgInfo(){for(var e in console.log("图集个数:"+this.textAtlases.length+",每个图集大小:"+TextRender.atlasWidth+"x"+TextRender.atlasWidth," 用canvas:",TextRender.isWan1Wan),console.log("图集占用空间:"+TextRender.atlasWidth*TextRender.atlasWidth*4/1024/1024*this.textAtlases.length+"M"),console.log("缓存用到的字体:"),this.mapFont){var t=this.getFontSizeInfo(e),r=t>>24,i=t>>16&255,a=t>>8&255,s=255&t;console.log("    "+e," off:",r,i," size:",a,s)}var n=0;console.log("缓存数据:");var o=0,l=0;this.textAtlases.forEach((function(e){var t=e.texture.id,r=RenderInfo.loopCount-e.texture.lastTouchTm,i=r>0?r+"帧以前":"当前帧";for(var a in o+=e.texture.curUsedCovRate,l+=e.texture.curUsedCovRateAtlas,console.log("--图集(id:"+t+",当前使用率:"+(1e3*e.texture.curUsedCovRate|0)+"‰","当前图集使用率:",(100*e.texture.curUsedCovRateAtlas|0)+"%","图集使用率:",100*e.usedRate|0,"%, 使用于:"+i+")--:"),e.charMaps){var s=e.charMaps[a];console.log("     off:",s.orix,s.oriy," bmp宽高:",s.bmpWidth,s.bmpHeight,"无效:",s.deleted,"touchdt:",RenderInfo.loopCount-s.touchTick,"位置:",s.uv[0]*TextRender.atlasWidth|0,s.uv[1]*TextRender.atlasWidth|0,"字符:",s.char,"key:",a),n++}})),console.log("独立贴图文字("+this.isoTextures.length+"个):"),this.isoTextures.forEach((function(e){console.log("    size:",e.width,e.height,"touch间隔:",RenderInfo.loopCount-e.lastTouchTm,"char:",e.ri.char)})),console.log("总缓存:",n,"总使用率:",o,"总当前图集使用率:",l)}showAtlas(e,t,r,i,a,s){if(!this.textAtlases[e])return console.log("没有这个图集"),null;var n=new Sprite,o=this.textAtlases[e].texture,l={width:TextRender.atlasWidth,height:TextRender.atlasWidth,sourceWidth:TextRender.atlasWidth,sourceHeight:TextRender.atlasWidth,offsetX:0,offsetY:0,getIsReady:function(){return!0},_addReference:function(){},_removeReference:function(){},_getSource:function(){return o._getSource()},bitmap:{id:o.id},_uv:Texture.DEF_UV};return n.size=function(e,r){return this.width=e,this.height=r,n.graphics.clear(),n.graphics.drawRect(0,0,n.width,n.height,t),n.graphics.drawTexture(l,0,0,n.width,n.height),this},n.graphics.drawRect(0,0,a,s,t),n.graphics.drawTexture(l,0,0,a,s),n.pos(r,i),ILaya.stage.addChild(n),n}}TextRender.useOldCharBook=!1,TextRender.atlasWidth=1024,TextRender.noAtlas=!1,TextRender.forceSplitRender=!1,TextRender.forceWholeRender=!1,TextRender.scaleFontWithCtx=!0,TextRender.maxFontScale=4,TextRender.standardFontSize=32,TextRender.destroyAtlasDt=10,TextRender.checkCleanTextureDt=2e3,TextRender.destroyUnusedTextureDt=3e3,TextRender.cleanMem=104857600,TextRender.isWan1Wan=!1,TextRender.showLog=!1,TextRender.debugUV=!1,TextRender.imgdtRect=[0,0,0,0],TextRender.simClean=!1;class MeshTexture extends Mesh2D{constructor(){super(MeshTexture.const_stride,4,4)}static __init__(){MeshTexture.VertexDeclarition=new VertexDeclaration(48,[new VertexElement(0,VertexElementFormat.Vector4,0),new VertexElement(16,VertexElementFormat.Vector4,1),new VertexElement(32,VertexElementFormat.Vector4,2)])}onVBRealloc(e){this._vbFloat32Array=new Float32Array(e)}onIBRealloc(e){this._ibU16Array=new Uint16Array(e)}addData(e,t,r,i,a,s=null){let n=e.length/2;this.expVBSize(n*MeshTexture.const_stride);var o=e.length>>1,l=this._vertNum*MeshTexture.const_stride>>2,h=this._vbFloat32Array,d=0,u=i.a,c=i.b,_=i.c,p=i.d,g=i.tx,m=i.ty,f=0;let S=0,y=0,T=1,x=1;s&&(S=s[0],y=s[1],T=s[2],x=s[3]);let D=(a>>>16&255)/255,v=(a>>>8&255)/255,C=(255&a)/255,E=(a>>>24)/255;for(f=0;f<o;f++){var R=e[d],w=e[d+1];h[l]=R*u+w*_+g,h[l+1]=R*c+w*p+m,h[l+2]=S+t[d]*T,h[l+3]=y+t[d+1]*x,h[l+4]=C,h[l+5]=v,h[l+6]=D,h[l+7]=E,h[l+8]=255,l+=12,d+=2}var M=this._vertNum,b=this._indexNum;this.expIBSize(r.byteLength);var I=this._ibU16Array;if(M>0)for(let e=b,t=0,i=b+r.length;e<i;e++,t++)I[e]=r[t]+M;else I.set(r);this._vertNum+=o,this._indexNum+=r.length}get vertexDeclarition(){return MeshTexture.VertexDeclarition}}MeshTexture.const_stride=48,MeshTexture.VertexDeclarition=null;class MeshVG extends Mesh2D{constructor(){super(MeshVG.const_stride,4,4),this._vbFloat32Array=null}static __init__(){MeshVG.vertexDeclaration=new VertexDeclaration(24,[new VertexElement(0,VertexElementFormat.Vector2,0),new VertexElement(8,VertexElementFormat.Vector4,1)])}onVBRealloc(e){this._vbFloat32Array=new Float32Array(e)}onIBRealloc(e){}addVertAndIBToMesh(e,t,r){var i=this._vertNum*MeshVG.const_stride;this.expVBSize(e.length/2*MeshVG.const_stride);var a=i>>2,s=this._vbFloat32Array,n=0;let o=(t>>>16&255)/255,l=(t>>>8&255)/255,h=(255&t)/255,d=(t>>>24)/255;for(var u=e.length/2,c=0;c<u;c++)s[a++]=e[n],s[a++]=e[n+1],n+=2,s[a++]=h,s[a++]=l,s[a++]=o,s[a++]=d;this.expIBSize(2*r.length),new Uint16Array(this._IBBuff,2*this._indexNum,r.length).set(new Uint16Array(r)),this._vertNum+=u,this._indexNum+=r.length}get vertexDeclarition(){return MeshVG.vertexDeclaration}}MeshVG.const_stride=24,MeshVG.vertexDeclaration=null;class RenderState2D{static restoreTempArray(){RenderState2D.TEMPMAT4_ARRAY[0]=1,RenderState2D.TEMPMAT4_ARRAY[1]=0,RenderState2D.TEMPMAT4_ARRAY[4]=0,RenderState2D.TEMPMAT4_ARRAY[5]=1,RenderState2D.TEMPMAT4_ARRAY[12]=0,RenderState2D.TEMPMAT4_ARRAY[13]=0}static clear(){RenderState2D.worldAlpha=1}}RenderState2D.TEMPMAT4_ARRAY=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],RenderState2D.worldMatrix4=RenderState2D.TEMPMAT4_ARRAY,RenderState2D.worldMatrix=new Matrix,RenderState2D.matWVP=null,RenderState2D.worldAlpha=1,RenderState2D.worldScissorTest=!1,RenderState2D.width=0,RenderState2D.height=0,RenderState2D.InvertY=!1,e.BufferTargetType=void 0,(ue=e.BufferTargetType||(e.BufferTargetType={}))[ue.ARRAY_BUFFER=0]="ARRAY_BUFFER",ue[ue.ELEMENT_ARRAY_BUFFER=1]="ELEMENT_ARRAY_BUFFER",ue[ue.UNIFORM_BUFFER=2]="UNIFORM_BUFFER",ue[ue.COPY_READ_BUFFER=3]="COPY_READ_BUFFER",ue[ue.COPY_WRITE_BUFFER=4]="COPY_WRITE_BUFFER",ue[ue.TRANSFORM_FEEDBACK_BUFFER=5]="TRANSFORM_FEEDBACK_BUFFER",e.BufferUsage=void 0,(ce=e.BufferUsage||(e.BufferUsage={}))[ce.Static=0]="Static",ce[ce.Dynamic=1]="Dynamic",ce[ce.Stream=2]="Stream",e.DrawType=void 0,(_e=e.DrawType||(e.DrawType={}))[_e.DrawArray=0]="DrawArray",_e[_e.DrawArrayInstance=1]="DrawArrayInstance",_e[_e.DrawElement=2]="DrawElement",_e[_e.DrawElementInstance=3]="DrawElementInstance",e.IndexFormat=void 0,(pe=e.IndexFormat||(e.IndexFormat={}))[pe.UInt8=0]="UInt8",pe[pe.UInt16=1]="UInt16",pe[pe.UInt32=2]="UInt32",e.MeshTopology=void 0,(ge=e.MeshTopology||(e.MeshTopology={}))[ge.Points=0]="Points",ge[ge.Lines=1]="Lines",ge[ge.LineLoop=2]="LineLoop",ge[ge.LineStrip=3]="LineStrip",ge[ge.Triangles=4]="Triangles",ge[ge.TriangleStrip=5]="TriangleStrip",ge[ge.TriangleFan=6]="TriangleFan";class Render2D{constructor(e=null){this._renderTexture=null,this._renderTexture=e}setRenderTarget(e){}get out(){return this._renderTexture}}class Render2DSimple extends Render2D{constructor(e=null){super(e),Render2DSimple.rendercontext2D||(Render2DSimple.rendercontext2D=LayaGL.render2DRenderPassFactory.createRenderContext2D()),this._renderElement=LayaGL.render2DRenderPassFactory.createRenderElement2D()}clone(e){return new Render2DSimple(e)}_createMesh(){let t=this.geo=LayaGL.renderDeviceFactory.createRenderGeometryElement(e.MeshTopology.Triangles,e.DrawType.DrawElement),r=LayaGL.renderDeviceFactory.createBufferState();t.bufferState=r;let i=LayaGL.renderDeviceFactory.createVertexBuffer(e.BufferUsage.Dynamic);i.vertexDeclaration=this._tex_vert_decl;let a=LayaGL.renderDeviceFactory.createIndexBuffer(e.BufferUsage.Dynamic);r.applyState([i],a),t.indexFormat=e.IndexFormat.UInt16}setVertexDecl(e){this._tex_vert_decl!=e&&(this._tex_vert_decl=e,this._createMesh())}renderStart(e,t){this._renderTexture?(Render2DSimple.rendercontext2D.invertY=this._renderTexture._invertY,Render2DSimple.rendercontext2D.setRenderTarget(this._renderTexture._renderTarget,e,t)):(Render2DSimple.rendercontext2D.invertY=!1,Render2DSimple.rendercontext2D.setOffscreenView(RenderState2D.width,RenderState2D.height),Render2DSimple.rendercontext2D.setRenderTarget(null,e,t)),RenderTexture2D._clear=!1}setRenderTarget(e){Render2DSimple.rendercontext2D.setRenderTarget(null==e?void 0:e._renderTarget,!1,RenderTexture2D._clearColor)}drawMesh(e,t){Stat.draw2D++,this._renderElement.geometry=e,this._renderElement.value2DShaderData=t.shaderData,this._renderElement.subShader=t._shader.getSubShaderAt(0),this._renderElement.materialShaderData=t.shaderData,Render2DSimple.rendercontext2D.drawRenderElementOne(this._renderElement)}draw(e,t,r,i,a,s){Stat.draw2D++,this.setVertexDecl(e.vertexDeclarition);let n=this.geo,o=n.bufferState,l=o._vertexBuffers[0],h=o._bindedIndexBuffer;l.setDataLength(r),l.setData(e.vbBuffer,t,0,r),h._setIndexDataLength(a),h._setIndexData(new Uint16Array(e.ibBuffer,i,a/2),0),n.clearRenderParams(),n.setDrawElemenParams(a/2,0),this._renderElement.geometry=n,this._renderElement.value2DShaderData=s.shaderData,this._renderElement.subShader=s._defaultShader.getSubShaderAt(0),this._renderElement.materialShaderData=null,Render2DSimple.rendercontext2D.drawRenderElementOne(this._renderElement)}renderEnd(){}}const fe=new Matrix(Const.MAX_CLIP_SIZE,0,0,Const.MAX_CLIP_SIZE,0,0);class Context{constructor(){if(this._alpha=1,this._material=null,this._fillStyle=DrawStyle.DEFAULT,this._strokeStyle=DrawStyle.DEFAULT,this._tmpMatrix=new Matrix,this._drawTexToDrawTri_Vert=new Float32Array(8),this._drawTexToDrawTri_Index=new Uint16Array([0,1,2,0,2,3]),this._tempUV=new Float32Array(8),this._drawTriUseAbsMatrix=!1,this._other=null,this._path=null,this._drawCount=1,this._width=Const.MAX_CLIP_SIZE,this._height=Const.MAX_CLIP_SIZE,this._renderCount=0,this.stopMerge=!0,this._curSubmit=SubmitBase.RENDERBASE,this._submitKey=new SubmitKey,this._meshQuatTex=new MeshQuadTexture,this._meshVG=new MeshVG,this._meshTex=new MeshTexture,this._transedPoints=new Array(8),this._temp4Points=new Array(8),this._clipRect=Context.MAXCLIPRECT,this._globalClipMatrix=fe.clone(),this._clipInfoID=0,this._clipID_Gen=0,this._matBuffer=new Float32Array(6),this._lastMatScaleX=1,this._lastMatScaleY=1,this._lastMat_a=1,this._lastMat_b=0,this._lastMat_c=0,this._lastMat_d=1,this._nBlendType=0,this._save=null,this._charSubmitCache=null,this._saveMark=null,this._shader2D=new Shader2D,this.sprite=null,this._italicDeg=0,this._lastTex=null,this._fillColor=0,this._flushCnt=0,this.defTexture=null,this._colorFiler=null,this.drawTexAlign=!1,this._incache=!1,this._isMain=!1,this._render2D=null,this._clearColor=new Color(0,0,0,0),this._clear=!1,this._shaderValueNeedRelease=[],this.render2D=new Render2DSimple,Context._contextcount++,!this.defTexture){var t=new Texture2D(2,2,e.TextureFormat.R8G8B8A8,!0,!1,!1);t.setPixelsData(new Uint8Array(16),!1,!1),t.lock=!0,this.defTexture=new Texture(t)}this._lastTex=this.defTexture,this._other=ContextParams.DEFAULT,this._curMat=Matrix.create(),this._charSubmitCache=new CharSubmitCache,this._mesh=this._meshQuatTex,this._mesh.clearMesh(),this._save=[SaveMark.Create(this)],this._save.length=10,this.clear()}static __init__(){if(Context.MAXCLIPRECT=new Rectangle(0,0,Const.MAX_CLIP_SIZE,Const.MAX_CLIP_SIZE),ContextParams.DEFAULT=new ContextParams,!Context._textRender){let e=Context._textRender=new TextRender;e.fontMeasure=new MeasureFont(e.charRender)}}copyState(e){}set isMain(e){this._isMain=e}get isMain(){return this._isMain}set render2D(e){this._render2D=e}get render2D(){return this._render2D}set material(e){this._material=e}get material(){return this._material}get lineJoin(){return""}set lineJoin(e){}get lineCap(){return""}set lineCap(e){}get miterLimit(){return""}set miterLimit(e){}touchRes(e){e.touch()}transformByMatrix(e,t,r){this.transform(e.a,e.b,e.c,e.d,e.tx+t,e.ty+r)}drawRect(e,t,r,i,a,s,n){var o=this;null!=a&&(o.fillStyle=a,o.fillRect(e,t,r,i)),null!=s&&(o.strokeStyle=s,o.lineWidth=n,o.strokeRect(e,t,r,i))}alpha(e){this.globalAlpha*=e}_transform(e,t,r){this.translate(t,r),this.transform(e.a,e.b,e.c,e.d,e.tx,e.ty),this.translate(-t,-r)}_rotate(e,t,r){this.translate(t,r),this.rotate(e),this.translate(-t,-r)}_scale(e,t,r,i){this.translate(r,i),this.scale(e,t),this.translate(-r,-i)}_drawLine(e,t,r,i,a,s,n,o,l){this.beginPath(),this.strokeStyle=n,this.lineWidth=o,this.moveTo(e+r,t+i),this.lineTo(e+a,t+s),this.stroke()}_drawLines(e,t,r,i,a,s){this.beginPath(),this.strokeStyle=i,this.lineWidth=a,this.addPath(r.slice(),!1,!1,e,t),this.stroke()}drawCurves(e,t,r,i,a){this.beginPath(),this.strokeStyle=i,this.lineWidth=a,this.moveTo(e+r[0],t+r[1]);for(var s=2,n=r.length;s<n;)this.quadraticCurveTo(e+r[s++],t+r[s++],e+r[s++],t+r[s++]);this.stroke()}_fillAndStroke(e,t,r,i=!1){null!=e&&(this.fillStyle=e,this.fill()),null!=t&&r>0&&(this.strokeStyle=t,this.lineWidth=r,this.stroke())}_drawCircle(e,t,r,i,a,s,n){this.beginPath(!0),this.arc(e,t,r,r,0,2*Math.PI,!1,!0,40),this.closePath(),this._fillAndStroke(i,a,s)}_drawEllipse(e,t,r,i,a,s,n){this.beginPath(!0),this.arc(e,t,r,i,0,2*Math.PI,!1,!0,40),this.closePath(),this._fillAndStroke(a,s,n)}_drawRoundRect(e,t,r,i,a,s,n,o,l,h,d){this.beginPath(!0);var u=this._getPath();0>=a?u.addPoint(e,t):this.arc(e+a,t+a,a,a,Math.PI,Math.PI+.5*Math.PI);let c=e+r-s;0>=s?u.addPoint(c,t):this.arc(c,t+s,s,s,Math.PI+.5*Math.PI,2*Math.PI),c=e+r-o;let _=t+i-o;0>=o?u.addPoint(c,_):this.arc(c,_,o,o,0,.5*Math.PI),c=e+n,_=t+i-n,0>=n?u.addPoint(c,_):this.arc(c,_,n,n,Math.PI-.5*Math.PI,Math.PI),u.addPoint(e,t+a),this.closePath(),this._fillAndStroke(l,h,d)}_drawPie(e,t,r,i,a,s,n,o,l){this.beginPath(),this.moveTo(e,t),this.arc(e,t,r,r,i,a),this.closePath(),this._fillAndStroke(s,n,o)}_drawPoly(e,t,r,i,a,s,n,o){this.beginPath(),this.addPath(r.slice(),!0,n,e,t),this.closePath(),this._fillAndStroke(i,a,s,n)}_drawPath(e,t,r,i,a){this.beginPath();for(var s=0,n=r.length;s<n;s++){var o=r[s];switch(o[0]){case"moveTo":this.moveTo(e+o[1],t+o[2]);break;case"lineTo":this.lineTo(e+o[1],t+o[2]);break;case"arcTo":this.arcTo(e+o[1],t+o[2],e+o[3],t+o[4],o[5]);break;case"closePath":this.closePath()}}null!=i&&(this.fillStyle=i.fillStyle,this.fill()),null!=a&&(this.strokeStyle=a.strokeStyle,this.lineWidth=a.lineWidth||1,this.lineJoin=a.lineJoin,this.lineCap=a.lineCap,this.miterLimit=a.miterLimit,this.stroke())}static set2DRenderConfig(){}clearBG(e,t,r,i){null==e||null==e?this._clear=!1:(this._clearColor.setValue(e,t,r,i),this._clear=!0)}_releaseMem(){this._curMat&&this._curMat.destroy(),this._curMat=null,this._shader2D.destroy(),this._shader2D=null,this._charSubmitCache.clear(),this._path=null,this._save=null,this.sprite=null}destroy(){--Context._contextcount,this.sprite=null,this._charSubmitCache&&this._charSubmitCache.destroy(),this.defTexture&&(this.defTexture.bitmap&&this.defTexture.bitmap.destroy(),this.defTexture.destroy())}clear(){this._submitKey.clear(),this._drawCount=1,this._other=ContextParams.DEFAULT,this._alpha=1,this._nBlendType=0,this._clipRect=Context.MAXCLIPRECT,this._fillStyle=this._strokeStyle=DrawStyle.DEFAULT,this._curMat.identity(),this._other.clear(),this._saveMark=this._save[0],this._save._length=1}size(e,t){this._width==e&&this._height==t||(this._width=e,this._height=t,this.isMain&&(LayaGL.renderEngine.viewport(0,0,e,t),LayaGL.renderEngine.scissor(0,0,e,t),RenderState2D.width=e,RenderState2D.height=t)),0===e&&0===t&&this._releaseMem()}get width(){return this._width}set width(e){this.size(e,this._height)}get height(){return this._height}set height(e){this.size(this._width,e)}getMatScaleX(){return this._lastMat_a==this._curMat.a&&this._lastMat_b==this._curMat.b||(this._lastMatScaleX=this._curMat.getScaleX(),this._lastMat_a=this._curMat.a,this._lastMat_b=this._curMat.b),this._lastMatScaleX}getMatScaleY(){return this._lastMat_c==this._curMat.c&&this._lastMat_d==this._curMat.d||(this._lastMatScaleY=this._curMat.getScaleY(),this._lastMat_c=this._curMat.c,this._lastMat_d=this._curMat.d),this._lastMatScaleY}getFillColor(){return this._fillColor}set fillStyle(e){this._fillStyle.equal(e)||(SaveBase.save(this,SaveBase.TYPE_FILESTYLE,this._shader2D,!1),this._fillStyle=DrawStyle.create(e),this._submitKey.other=-this._fillStyle.toInt())}get fillStyle(){return this._fillStyle}set globalAlpha(e){(e=Math.floor(1e3*e)/1e3)!=this._alpha&&(SaveBase.save(this,SaveBase.TYPE_ALPHA,this._shader2D,!1),this._alpha=e)}get globalAlpha(){return this._alpha}set textAlign(e){this._other.textAlign===e||(this._other=this._other.make(),SaveBase.save(this,SaveBase.TYPE_TEXTALIGN,this._other,!1),this._other.textAlign=e)}get textAlign(){return this._other.textAlign}set textBaseline(e){this._other.textBaseline===e||(this._other=this._other.make(),SaveBase.save(this,SaveBase.TYPE_TEXTBASELINE,this._other,!1),this._other.textBaseline=e)}get textBaseline(){return this._other.textBaseline}set globalCompositeOperation(e){this._drawToRender2D(this._curSubmit);var t=BlendMode.TOINT[e];null==t||this._nBlendType===t||(SaveBase.save(this,SaveBase.TYPE_GLOBALCOMPOSITEOPERATION,this,!0),this._curSubmit=SubmitBase.RENDERBASE,this._nBlendType=t)}get globalCompositeOperation(){return BlendMode.NAMES[this._nBlendType]}set strokeStyle(e){this._strokeStyle.equal(e)||(SaveBase.save(this,SaveBase.TYPE_STROKESTYLE,this._shader2D,!1),this._strokeStyle=DrawStyle.create(e),this._submitKey.other=-this._strokeStyle.toInt())}get strokeStyle(){return this._strokeStyle}translate(e,t){0===e&&0===t||(SaveTranslate.save(this),this._curMat._bTransform?(SaveTransform.save(this),this._curMat.tx+=e*this._curMat.a+t*this._curMat.c,this._curMat.ty+=e*this._curMat.b+t*this._curMat.d):(this._curMat.tx=e,this._curMat.ty=t))}set lineWidth(e){this._other.lineWidth===e||(this._other=this._other.make(),SaveBase.save(this,SaveBase.TYPE_LINEWIDTH,this._other,!1),this._other.lineWidth=e)}get lineWidth(){return this._other.lineWidth}save(){this._save[this._save._length++]=SaveMark.Create(this)}restore(){var e=this._save._length,t=this._nBlendType;if(!(e<1)){for(var r=e-1;r>=0;r--){var i=this._save[r];if(i.restore(this),i.isSaveMark())return void(this._save._length=r)}t!=this._nBlendType&&(this.stopMerge=!0)}}fillText(e,t,r,i,a,s,n=0,o=""){Context._textRender.filltext(this,e,t,r,i,a,o,n,s)}drawText(e,t,r,i,a,s){Context._textRender.filltext(this,e,t,r,i,a,null,0,s)}strokeWord(e,t,r,i,a,s,n){Context._textRender.filltext(this,e,t,r,i,null,a,s,n)}fillBorderText(e,t,r,i,a,s,n,o){Context._textRender.filltext(this,e,t,r,i,a,s,n,o)}_fast_filltext(e,t,r,i,a,s,n,o){Context._textRender._fast_filltext(this,e,t,r,i,a,s,n,o)}_fillRect(t,r,i,a,s){var n=this._curSubmit,o=this._mesh.vertexNum+4<Context._MAXVERTNUM&&n&&n._key.submitType===SubmitBase.KEY_DRAWTEXTURE&&n._key.blendShader===this._nBlendType&&!this.isStopMerge(n)&&this._curSubmit.material==this.material;o||(this._drawToRender2D(this._curSubmit),this._mesh=this._meshQuatTex);let l=this._mesh;this.transformQuad(t,r,i,a,0,this._curMat,this._transedPoints),this.clipedOff(this._transedPoints)||(o||(n=this._curSubmit=SubmitBase.create(this,l,Value2D.create(e.RenderSpriteData.Texture2D)),this.fillShaderValue(n.shaderValue),this._copyClipInfo(n.shaderValue),n.clipInfoID=this._clipInfoID,!this._lastTex||this._lastTex.destroyed?n.shaderValue.textureHost=this.defTexture:n.shaderValue.textureHost=this._lastTex,n._key.other=this._lastTex&&this._lastTex.bitmap?this._lastTex.bitmap.id:-1),l.addQuad(this._transedPoints,Texture.NO_UV,s,!1),this._curSubmit._numEle+=6)}fillRect(e,t,r,i,a){var s=a?DrawStyle.create(a):this._fillStyle,n=this.mixRGBandAlpha(s.toInt());this._fillRect(e,t,r,i,n)}fillTexture(e,t,r,i,a,s,n,o){e._getSource()?this._fillTexture(e,e.width,e.height,e.uvrect,t,r,i,a,s,n.x,n.y,o):this.sprite&&ILaya.systemTimer.callLater(this,this._repaintSprite)}_fillTexture(t,r,i,a,s,n,o,l,h,d,u,c){var _=this._curSubmit;this._drawToRender2D(this._curSubmit),this._mesh=this._meshQuatTex;var p=!0,g=!0;switch(h){case"repeat":break;case"repeat-x":g=!1;break;case"repeat-y":p=!1;break;case"no-repeat":p=g=!1}var m=this._temp4Points,f=0,S=0,y=0,T=0,x=0,D=0;if(d<0?(y=s,f=-d%r/r):y=s+d,u<0?(T=n,S=-u%i/i):T=n+u,x=s+o,D=n+l,!p&&(x=Math.min(x,s+d+r)),!g&&(D=Math.min(D,n+u+i)),!(x<s||D<n||y>x||T>D)){var v=(x-s-d)/r,C=(D-n-u)/i;if(this.transformQuad(y,T,x-y,D-T,0,this._curMat,this._transedPoints),m[0]=f,m[1]=S,m[2]=v,m[3]=S,m[4]=v,m[5]=C,m[6]=f,m[7]=C,!this.clipedOff(this._transedPoints)){var E=Value2D.create(e.RenderSpriteData.Texture2D);E.shaderData.addDefine(ShaderDefines2D.FILLTEXTURE);var R=a.concat();Vector4.tempVec4.setValue(R[0],R[1],R[2],R[3]),E.u_TexRange=Vector4.tempVec4,_=this._curSubmit=SubmitBase.create(this,this._mesh,E),this.fillShaderValue(E),_.clipInfoID=this._clipInfoID,_.shaderValue.textureHost=t;var w=this._mixRGBandAlpha(c,this._alpha);this._mesh.addQuad(this._transedPoints,m,w,!0),this._curSubmit._numEle+=6}this.breakNextMerge()}}setColorFilter(e){SaveBase.save(this,SaveBase.TYPE_COLORFILTER,this,!0),this._colorFiler=e,this.stopMerge=!0}drawTexture(e,t,r,i,a,s=4294967295){this._drawTextureM(e,t,r,i,a,null,1,null,s)}drawTextures(e,t,r,i,a){if(e._getSource())for(var s=t.length/2,n=0,o=e.bitmap.id,l=0;l<s;l++){const s="number"==typeof a[l]?a[l]:4294967295;this._inner_drawTexture(e,o,t[n++]+r,t[n++]+i,0,0,null,null,1,!1,s)}else this.sprite&&ILaya.systemTimer.callLater(this,this._repaintSprite)}_drawTextureM(e,t,r,i,a,s,n,o,l){var h=this.sprite;return!!e._getSource((function(){h&&h.repaint()}))&&this._inner_drawTexture(e,e.bitmap.id,t,r,i,a,s,o,n,!1,l)}_drawRenderTexture(e,t,r,i,a,s,n,o,l=4294967295){return this._inner_drawTexture(e,-1,t,r,i,a,s,o,n,!1,l)}_copyClipInfo(e){let t=this._globalClipMatrix;this._globalClipMatrix.copyTo(e.localClipMatrix);var r=e.clipMatDir;r.x=t.a,r.y=t.b,r.z=t.c,r.w=t.d,e.clipMatDir=r;var i=e.clipMatPos;i.x=t.tx,i.y=t.ty,e.clipMatPos=i}isStopMerge(e){return this.stopMerge||e.clipInfoID!==this._clipInfoID}drawCallOptimize(e){return this._charSubmitCache.enable(e,this),e}_drawToRender2D(e){let t=this._mesh;if(t.indexNum<=0)return;let r=e.shaderValue,i=r.shaderData;switch(e._key.blendShader){case 1:case 3:case 5:i.setInt(Shader3D.BLEND_SRC,RenderState.BLENDPARAM_ONE),i.setInt(Shader3D.BLEND_DST,RenderState.BLENDPARAM_ONE);break;case 2:i.setInt(Shader3D.BLEND_SRC,RenderState.BLENDPARAM_DST_COLOR),i.setInt(Shader3D.BLEND_DST,RenderState.BLENDPARAM_ONE_MINUS_SRC_ALPHA);break;case 6:i.setInt(Shader3D.BLEND_SRC,RenderState.BLENDPARAM_ZERO),i.setInt(Shader3D.BLEND_DST,RenderState.BLENDPARAM_SRC_ALPHA);break;case 7:i.setInt(Shader3D.BLEND_SRC,RenderState.BLENDPARAM_ZERO),i.setInt(Shader3D.BLEND_DST,RenderState.BLENDPARAM_ZERO);break;case 9:i.setInt(Shader3D.BLEND_SRC,RenderState.BLENDPARAM_SRC_ALPHA),i.setInt(Shader3D.BLEND_DST,RenderState.BLENDPARAM_ONE_MINUS_SRC_ALPHA);break;default:i.setInt(Shader3D.BLEND_SRC,RenderState.BLENDPARAM_ONE),i.setInt(Shader3D.BLEND_DST,RenderState.BLENDPARAM_ONE_MINUS_SRC_ALPHA)}if(e._colorFiler){var a=e._colorFiler;r.setFilter(a),Matrix4x4.TEMPMatrix0.cloneByArray(a._mat),i.setMatrix4x4(ShaderDefines2D.UNIFORM_COLORMAT,Matrix4x4.TEMPMatrix0),Vector4.tempVec4.setValue(a._alpha[0],a._alpha[1],a._alpha[2],a._alpha[3]),i.setVector(ShaderDefines2D.UNIFORM_COLORALPHA,Vector4.tempVec4)}this._drawMesh(t,0,t.vertexNum,e._startIdx,t.indexNum,e.shaderValue),this.stopMerge=!1}_drawMesh(e,t,r,i,a,s){if(e.indexNum){this._render2D.draw(e,t,r*e.vertexDeclarition.vertexStride,i,2*a,s)}e.clearMesh(),s._needRelease||(s._needRelease=!0,this._shaderValueNeedRelease.push(s))}_inner_drawTexture(t,r,i,a,s,n,o,l,h,d,u){if(s<=0||n<=0)return!1;var c=this._curSubmit._key;if(l=l||t._uv,c.submitType===SubmitBase.KEY_TRIANGLES&&c.other===r){var _=this._drawTexToDrawTri_Vert;_[0]=i,_[1]=a,_[2]=i+s,_[3]=a,_[4]=i+s,_[5]=a+n,_[6]=i,_[7]=a+n,this._drawTriUseAbsMatrix=!0;var p=this._tempUV;return p[0]=l[0],p[1]=l[1],p[2]=l[2],p[3]=l[3],p[4]=l[4],p[5]=l[5],p[6]=l[6],p[7]=l[7],this.drawTriangles(t,0,0,_,p,this._drawTexToDrawTri_Index,o||this._curMat,h,null,null),this._drawTriUseAbsMatrix=!1,!0}var g=this._curSubmit,m=d?this._charSubmitCache.getPos():this._transedPoints;if(this.transformQuad(i,a,s||t.width,n||t.height,this._italicDeg,o||this._curMat,m),this.drawTexAlign){var f=Math.round;m[0]=f(m[0]),m[1]=f(m[1]),m[2]=f(m[2]),m[3]=f(m[3]),m[4]=f(m[4]),m[5]=f(m[5]),m[6]=f(m[6]),m[7]=f(m[7]),this.drawTexAlign=!1}var S=this._mixRGBandAlpha(u,this._alpha*h);if(d)return this._charSubmitCache.add(this,t,r,m,l,S),!0;this._drawCount++;var y=r>=0&&c.submitType===SubmitBase.KEY_DRAWTEXTURE&&c.other===r&&!this.isStopMerge(this._curSubmit)&&this._mesh.vertexNum+4<Context._MAXVERTNUM&&this._curSubmit.material==this.material;if(y||(this._drawToRender2D(this._curSubmit),this._mesh=this._meshQuatTex),this._lastTex=t,!y){let i=Value2D.create(e.RenderSpriteData.Texture2D);this.fillShaderValue(i),i.textureHost=t,this._curSubmit=g=SubmitBase.create(this,this._mesh,i),g._key.other=r,this._copyClipInfo(g.shaderValue),g.clipInfoID=this._clipInfoID}return this._mesh.addQuad(m,l,S,!0),g._numEle+=6,!0}fillShaderValue(e){e.size=new Vector2(this._width,this._height),this._copyClipInfo(e)}clipedOff(e){return this._clipRect.width<=0||this._clipRect.height<=0}transformQuad(e,t,r,i,a,s,n){var o=0;0!=a&&(o=Math.tan(a*Math.PI/180)*i);var l=e+r,h=t+i,d=s.tx,u=s.ty,c=s.a,_=s.b,p=s.c,g=s.d,m=e+o,f=t,S=l+o,y=t,T=l,x=h,D=e,v=h;s._bTransform?(n[0]=m*c+f*p+d,n[1]=m*_+f*g+u,n[2]=S*c+y*p+d,n[3]=S*_+y*g+u,n[4]=T*c+x*p+d,n[5]=T*_+x*g+u,n[6]=D*c+v*p+d,n[7]=D*_+v*g+u):(n[0]=m+d,n[1]=f+u,n[2]=S+d,n[3]=y+u,n[4]=T+d,n[5]=x+u,n[6]=D+d,n[7]=v+u)}breakNextMerge(){this.stopMerge=!0}_repaintSprite(){this.sprite&&this.sprite.repaint()}drawTextureWithTransform(e,t,r,i,a,s,n,o,l,h,d,u=4294967295){var c,_=this._curMat;if(h&&(c=this.globalCompositeOperation,this.globalCompositeOperation=h),!s)return this._drawTextureM(e,t+n,r+o,i,a,_,l,d,u),void(h&&(this.globalCompositeOperation=c));var p=this._tmpMatrix;p.a=s.a,p.b=s.b,p.c=s.c,p.d=s.d,p.tx=s.tx+n,p.ty=s.ty+o,p._bTransform=s._bTransform,s&&_._bTransform?(Matrix.mul(p,_,p),(s=p)._bTransform=!0):(p.tx+=_.tx,p.ty+=_.ty,s=p),this._drawTextureM(e,t,r,i,a,s,l,d,u),h&&(this.globalCompositeOperation=c)}drawGeo(e,t,r,i){this.drawLeftData();let a=this._curMat,s=this._matBuffer;s[0]=a.a,s[1]=a.b,s[2]=a.tx+a.a*r+a.c*i,s[3]=a.c,s[4]=a.d,s[5]=a.ty+a.b*r+a.d*i,t.setBuffer("u_NMatrix",s),t.setVector2("u_size",new Vector2(this._width,this._height)),this._render2D.drawMesh(e,t)}drawGeos(e,t,r,i){this.drawLeftData();let a=this._curMat,s=this._matBuffer;s[0]=a.a,s[1]=a.b,s[2]=a.tx+a.a*r+a.c*i,s[3]=a.c,s[4]=a.d,s[5]=a.ty+a.b*r+a.d*i;for(let r=0,i=t.length;r<i;r++){let i=t[r][0];i.setBuffer("u_NMatrix",s),i.setVector2("u_size",new Vector2(this._width,this._height)),e.clearRenderParams(),e.setDrawElemenParams(t[r][1],t[r][2]),this._render2D.drawMesh(e,i)}}drawTriangles(t,r,i,a,s,n,o,l,h,d=4294967295){if(null==l&&(l=1),t._getSource()){var u=null;h&&(u=this.globalCompositeOperation,this.globalCompositeOperation=h),this._drawCount++;var c=this._tmpMatrix,_=t.bitmap,p=this._curSubmit._key,g=p.submitType===SubmitBase.KEY_TRIANGLES&&p.other===_.id&&p.blendShader==this._nBlendType&&this._mesh.vertexNum+a.length/2<Context._MAXVERTNUM&&this._curSubmit.material==this.material;if(g||(this._drawToRender2D(this._curSubmit),this._mesh=this._meshTex),!g){var m=this._curSubmit=SubmitBase.create(this,this._mesh,Value2D.create(e.RenderSpriteData.Texture2D));m.shaderValue.textureHost=t,this.fillShaderValue(m.shaderValue),m._key.submitType=SubmitBase.KEY_TRIANGLES,m._key.other=_.id,this._copyClipInfo(m.shaderValue),m.clipInfoID=this._clipInfoID}var f=this._mixRGBandAlpha(d,this._alpha*l);this._drawTriUseAbsMatrix?this._mesh.addData(a,s,n,o,f,null):(o?(c.a=o.a,c.b=o.b,c.c=o.c,c.d=o.d,c.tx=o.tx+r,c.ty=o.ty+i):(c.a=1,c.b=0,c.c=0,c.d=1,c.tx=r,c.ty=i),Matrix.mul(c,this._curMat,c),this._mesh.addData(a,s,n,c||this._curMat,f,null)),this._curSubmit._numEle+=n.length,h&&(this.globalCompositeOperation=u)}else this.sprite&&ILaya.systemTimer.callLater(this,this._repaintSprite)}transform(e,t,r,i,a,s){SaveTransform.save(this),Matrix.mul(Matrix.TEMP.setTo(e,t,r,i,a,s),this._curMat,this._curMat),this._curMat._checkTransform()}rotate(e){SaveTransform.save(this),this._curMat.rotateEx(e)}scale(e,t){SaveTransform.save(this),this._curMat.scaleEx(e,t)}clipRect(e,t,r,i,a){if(SaveClipRect.save(this),this._clipRect==Context.MAXCLIPRECT?this._clipRect=new Rectangle(e,t,r,i):(this._clipRect.width=r,this._clipRect.height=i,this._clipRect.x=e,this._clipRect.y=t),this._clipID_Gen++,this._clipID_Gen%=1e4,this._clipInfoID=this._clipID_Gen,a)fe.copyTo(this._globalClipMatrix);else{var s=this._globalClipMatrix,n=s.tx,o=s.ty,l=n+s.a,h=o+s.d;if(this._clipRect.width>=Const.MAX_CLIP_SIZE?(s.a=s.d=Const.MAX_CLIP_SIZE,s.b=s.c=s.tx=s.ty=0):this._curMat._bTransform?(s.tx=this._clipRect.x*this._curMat.a+this._clipRect.y*this._curMat.c+this._curMat.tx,s.ty=this._clipRect.x*this._curMat.b+this._clipRect.y*this._curMat.d+this._curMat.ty,s.a=this._clipRect.width*this._curMat.a,s.b=this._clipRect.width*this._curMat.b,s.c=this._clipRect.height*this._curMat.c,s.d=this._clipRect.height*this._curMat.d):(s.tx=this._clipRect.x+this._curMat.tx,s.ty=this._clipRect.y+this._curMat.ty,s.a=this._clipRect.width,s.b=s.c=0,s.d=this._clipRect.height),s.a>0&&s.d>0){var d=s.tx+s.a,u=s.ty+s.d;d<=n||u<=o||s.tx>=l||s.ty>=h?(s.a=-.1,s.d=-.1):(s.tx<n&&(s.a-=n-s.tx,s.tx=n),d>l&&(s.a-=d-l),s.ty<o&&(s.d-=o-s.ty,s.ty=o),u>h&&(s.d-=u-h),s.a<=0&&(s.a=-.1),s.d<=0&&(s.d=-.1))}}}startRender(){for(let e of this._shaderValueNeedRelease)e.release(),e._needRelease=!1;this._shaderValueNeedRelease.length=0,this._render2D.renderStart(this._clear,this._clearColor),this.clear()}endRender(){this.flush(),this._render2D.renderEnd(),this._curSubmit=SubmitBase.RENDERBASE}drawLeftData(){this._drawToRender2D(this._curSubmit)}flush(){this.drawLeftData(),this._clipID_Gen=0,this._path&&this._path.reset(),this._curSubmit=SubmitBase.RENDERBASE,this._flushCnt++,this._flushCnt%60==0&&this.isMain&&TextRender.textRenderInst&&TextRender.textRenderInst.GC()}beginPath(e=!1){this._getPath().beginPath(e)}closePath(){this._path.closePath()}addPath(e,t,r,i,a){let s=e.length;for(let t=0;t<s-1;t+=2)e[t]+=i,e[t+1]+=a;t&&s>5&&(e[s-2]!=e[0]||e[s-1]!=e[1])&&e.push(e[0],e[1]),this._getPath().push(e,r)}fill(){var e=this._curMat,t=this._getPath(),r=this._curSubmit;r._key.submitType===SubmitBase.KEY_VG&&r._key.blendShader===this._nBlendType&&!this.isStopMerge(r)&&this._curSubmit.material==this.material||(this._drawToRender2D(r),this._mesh=this._meshVG,this._curSubmit=this.addVGSubmit(this._mesh),this.fillShaderValue(this._curSubmit.shaderValue));for(var i,a=this.mixRGBandAlpha(this.fillStyle.toInt()),s=0,n=0,o=t.paths.length;n<o;n++){var l=t.paths[n],h=l.path.length/2;if(!(h<3||3==h&&!l.convex)){var d,u,c,_,p=l.path.concat(),g=0;if(e._bTransform)for(g=0;g<h;g++)u=(d=g<<1)+1,c=p[d],_=p[u],p[d]=e.a*c+e.c*_+e.tx,p[u]=e.b*c+e.d*_+e.ty;else for(g=0;g<h;g++)u=(d=g<<1)+1,c=p[d],_=p[u],p[d]=c+e.tx,p[u]=_+e.ty;this._mesh.vertexNum+h>Context._MAXVERTNUM&&(this._curSubmit._numEle+=s,s=0,this._mesh=new MeshVG,this._curSubmit=this.addVGSubmit(this._mesh),this.fillShaderValue(this._curSubmit.shaderValue));var m=this._mesh.vertexNum;if(l.convex){var f=h-2;i=new Array(3*f);for(var S=0,y=0;y<f;y++)i[S++]=m,i[S++]=y+1+m,i[S++]=y+2+m}else if(i=Earcut.earcut(p,null,2),m>0)for(var T=0;T<i.length;T++)i[T]+=m;this._mesh.addVertAndIBToMesh(p,a,i),s+=i.length}}this._curSubmit._numEle+=s}addVGSubmit(t){var r=SubmitBase.create(this,t,Value2D.create(e.RenderSpriteData.Primitive));return this.fillShaderValue(r.shaderValue),r._key.submitType=SubmitBase.KEY_VG,this._copyClipInfo(r.shaderValue),r.clipInfoID=this._clipInfoID,r}stroke(){if(!(this.lineWidth<=0)){var e=this.mixRGBandAlpha(this.strokeStyle._color.numColor),t=this._getPath(),r=this._curSubmit;r._key.submitType===SubmitBase.KEY_VG&&r._key.blendShader===this._nBlendType&&!this.isStopMerge(r)&&this._curSubmit.material==this.material||(this._drawToRender2D(this._curSubmit),this._mesh=this._meshVG,this._curSubmit=this.addVGSubmit(this._mesh),this.fillShaderValue(this._curSubmit.shaderValue));for(var i=0,a=0,s=t.paths.length;a<s;a++){var n=t.paths[a];if(!(n.path.length<=0)){var o=[],l=[],h=2*n.path.length;if(!(h<2)){this._mesh.vertexNum+h>Context._MAXVERTNUM&&(this._curSubmit._numEle+=i,i=0,this._drawToRender2D(this._curSubmit),this._mesh=new MeshVG,this._curSubmit=this.addVGSubmit(this._mesh),this.fillShaderValue(this._curSubmit.shaderValue)),BasePoly.createLine2(n.path,o,this.lineWidth,this._mesh.vertexNum,l,n.loop);var d,u,c,_,p=l.length/2,g=this._curMat,m=0;if(g._bTransform)for(m=0;m<p;m++)u=(d=m<<1)+1,c=l[d],_=l[u],l[d]=g.a*c+g.c*_+g.tx,l[u]=g.b*c+g.d*_+g.ty;else for(m=0;m<p;m++)u=(d=m<<1)+1,c=l[d],_=l[u],l[d]=c+g.tx,l[u]=_+g.ty;this._mesh.addVertAndIBToMesh(l,e,o),i+=o.length}}}this._curSubmit._numEle+=i}}moveTo(e,t){var r=this._getPath();r.newPath(),r._lastOriX=e,r._lastOriY=t,r.addPoint(e,t)}lineTo(e,t){var r=this._getPath();Math.abs(e-r._lastOriX)<.001&&Math.abs(t-r._lastOriY)<.001||(r._lastOriX=e,r._lastOriY=t,r.addPoint(e,t))}arcTo(e,t,r,i,a){var s=0,n=0,o=0,l=this._path._lastOriX-e,h=this._path._lastOriY-t,d=Math.sqrt(l*l+h*h);if(!(d<=1e-6)){var u=l/d,c=h/d,_=r-e,p=i-t,g=_*_+p*p,m=Math.sqrt(g);if(!(m<=1e-6)){var f=_/m,S=p/m,y=u+f,T=c+S,x=Math.sqrt(y*y+T*T);if(!(x<=1e-6)){var D=y/x,v=T/x,C=Math.acos(D*u+v*c),E=Math.PI/2-C,R=(d=a*Math.tan(E))*u+e,w=d*c+t,M=Math.sqrt(d*d+a*a),b=e+D*M,I=t+v*M,L=0,A=0;if(u*S-c*f>=0){var B=2*E/Context.SEGNUM;L=Math.sin(B),A=Math.cos(B)}else B=2*-E/Context.SEGNUM,L=Math.sin(B),A=Math.cos(B);var P=this._path._lastOriX,N=this._path._lastOriY,F=R,U=w;(Math.abs(F-this._path._lastOriX)>.1||Math.abs(U-this._path._lastOriY)>.1)&&(n=F,o=U,P=F,N=U,this._path._lastOriX=n,this._path._lastOriY=o,this._path.addPoint(n,o));var O=R-b,G=w-I;for(s=0;s<Context.SEGNUM;s++){var V=O*A+G*L,k=-O*L+G*A;n=V+b,o=k+I,(Math.abs(P-n)>.1||Math.abs(N-o)>.1)&&(this._path._lastOriX=n,this._path._lastOriY=o,this._path.addPoint(n,o),P=n,N=o),O=V,G=k}}}}}arc(e,t,r,i,a,s,n=!1,o=!0,l=10){var h,d,u=0,c=0,_=0,p=0,g=0;if(c=s-a,n)if(Math.abs(c)>=2*Math.PI)c=2*-Math.PI;else for(;c>0;)c-=2*Math.PI;else if(Math.abs(c)>=2*Math.PI)c=2*Math.PI;else for(;c<0;)c+=2*Math.PI;var m=this.getMatScaleX(),f=this.getMatScaleY(),S=r*(m>f?m:f),y=2*Math.PI*S;d=0|Math.max(y/l,l);var T=this._getPath();for(h=0;h<=d;h++)u=a+c*(h/d),_=Math.cos(u),g=t+Math.sin(u)*i,(p=e+_*r)==this._path._lastOriX&&g==this._path._lastOriY||T.addPoint(p,g);_=Math.cos(s),g=t+Math.sin(s)*i,(p=e+_*r)==this._path._lastOriX&&g==this._path._lastOriY||T.addPoint(p,g)}quadraticCurveTo(e,t,r,i){for(var a=Bezier.I.getBezierPoints([this._path._lastOriX,this._path._lastOriY,e,t,r,i],30,2),s=0,n=a.length/2;s<n;s++)this.lineTo(a[2*s],a[2*s+1]);this.lineTo(r,i)}mixRGBandAlpha(e){return this._mixRGBandAlpha(e,this._alpha)}_mixRGBandAlpha(e,t){if(t>=1)return e;var r=(4278190080&e)>>>24;return 0!=r?r*=t:r=255*t,16777215&e|r<<24}strokeRect(e,t,r,i,a){if(this.lineWidth>0){var s=this.mixRGBandAlpha(this.strokeStyle._color.numColor),n=this.lineWidth/2;this._fillRect(e-n,t-n,r+this.lineWidth,this.lineWidth,s),this._fillRect(e-n,t-n+i,r+this.lineWidth,this.lineWidth,s),this._fillRect(e-n,t+n,this.lineWidth,i-this.lineWidth,s),this._fillRect(e-n+r,t+n,this.lineWidth,i-this.lineWidth,s)}}drawParticle(e,t,r){}_getPath(){return this._path||(this._path=new Path)}get canvas(){return this._canvas}_fillTexture_h(e,t,r,i,a,s,n,o,l){i<=0&&console.error("_fillTexture_h error: oriw must>0");for(var h=s,d=Math.floor(o/i),u=o%i,c=0;c<d;c++)this._inner_drawTexture(e,t,h,n,i,a,this._curMat,r,1,!1,l),h+=i;if(u>0){var _=r[2]-r[0],p=r[0]+_*(u/i),g=Context.tmpuv1;g[0]=r[0],g[1]=r[1],g[2]=p,g[3]=r[3],g[4]=p,g[5]=r[5],g[6]=r[6],g[7]=r[7],this._inner_drawTexture(e,t,h,n,u,a,this._curMat,g,1,!1,l)}}_fillTexture_v(e,t,r,i,a,s,n,o,l){a<=0&&console.error("_fillTexture_v error: orih must>0");for(var h=n,d=Math.floor(o/a),u=o%a,c=0;c<d;c++)this._inner_drawTexture(e,t,s,h,i,a,this._curMat,r,1,!1,l),h+=a;if(u>0){var _=r[7]-r[1],p=r[1]+_*(u/a),g=Context.tmpuv1;g[0]=r[0],g[1]=r[1],g[2]=r[2],g[3]=r[3],g[4]=r[4],g[5]=p,g[6]=r[6],g[7]=p,this._inner_drawTexture(e,t,s,h,i,u,this._curMat,g,1,!1,l)}}drawTextureWithSizeGrid(e,t,r,i,a,s,n,o,l){if(e._getSource()){t+=n,r+=o;var h=e.uv,d=e.bitmap.width,u=e.bitmap.height,c=s[0],_=s[3],p=s[1],g=s[2],m=s[4];i==e.width&&(_=p=0),a==e.height&&(c=g=0);var f=c/u,S=_/d,y=p/d,T=g/u,x=e.bitmap.id,D=this._curMat,v=this._tempUV,C=1,E=1;_+p>i&&(C=i/(_+p)),c+g>a&&(E=a/(c+g)),_*=C,p*=C,c*=E,g*=E;var R=h[0],w=h[1],M=h[4],b=h[5],I=R,L=w,A=M,B=b;if(_&&c&&(A=R+S,B=w+f,v[0]=R,v[1]=w,v[2]=A,v[3]=w,v[4]=A,v[5]=B,v[6]=R,v[7]=B,this._inner_drawTexture(e,x,t,r,_,c,D,v,1,!1,l)),p&&c&&(I=M-y,L=w,A=M,B=w+f,v[0]=I,v[1]=L,v[2]=A,v[3]=L,v[4]=A,v[5]=B,v[6]=I,v[7]=B,this._inner_drawTexture(e,x,i-p+t,0+r,p,c,D,v,1,!1,l)),_&&g&&(I=R,L=b-T,A=R+S,B=b,v[0]=I,v[1]=L,v[2]=A,v[3]=L,v[4]=A,v[5]=B,v[6]=I,v[7]=B,this._inner_drawTexture(e,x,0+t,a-g+r,_,g,D,v,1,!1,l)),p&&g&&(I=M-y,L=b-T,A=M,B=b,v[0]=I,v[1]=L,v[2]=A,v[3]=L,v[4]=A,v[5]=B,v[6]=I,v[7]=B,this._inner_drawTexture(e,x,i-p+t,a-g+r,p,g,D,v,1,!1,l)),c&&(I=R+S,L=w,A=M-y,B=w+f,v[0]=I,v[1]=L,v[2]=A,v[3]=L,v[4]=A,v[5]=B,v[6]=I,v[7]=B,m?this._fillTexture_h(e,x,v,e.width-_-p,c,_+t,r,i-_-p,l):this._inner_drawTexture(e,x,_+t,r,i-_-p,c,D,v,1,!1,l)),g&&(I=R+S,L=b-T,A=M-y,B=b,v[0]=I,v[1]=L,v[2]=A,v[3]=L,v[4]=A,v[5]=B,v[6]=I,v[7]=B,m?this._fillTexture_h(e,x,v,e.width-_-p,g,_+t,a-g+r,i-_-p,l):this._inner_drawTexture(e,x,_+t,a-g+r,i-_-p,g,D,v,1,!1,l)),_&&(I=R,L=w+f,A=R+S,B=b-T,v[0]=I,v[1]=L,v[2]=A,v[3]=L,v[4]=A,v[5]=B,v[6]=I,v[7]=B,m?this._fillTexture_v(e,x,v,_,e.height-c-g,t,c+r,a-c-g,l):this._inner_drawTexture(e,x,t,c+r,_,a-c-g,D,v,1,!1,l)),p&&(I=M-y,L=w+f,A=M,B=b-T,v[0]=I,v[1]=L,v[2]=A,v[3]=L,v[4]=A,v[5]=B,v[6]=I,v[7]=B,m?this._fillTexture_v(e,x,v,p,e.height-c-g,i-p+t,c+r,a-c-g,l):this._inner_drawTexture(e,x,i-p+t,c+r,p,a-c-g,D,v,1,!1,l)),I=R+S,L=w+f,A=M-y,B=b-T,v[0]=I,v[1]=L,v[2]=A,v[3]=L,v[4]=A,v[5]=B,v[6]=I,v[7]=B,m){var P=Context.tmpUVRect;P[0]=I,P[1]=L,P[2]=A-I,P[3]=B-L,this._fillTexture(e,e.width-_-p,e.height-c-g,P,_+t,c+r,i-_-p,a-c-g,"repeat",0,0,l)}else this._inner_drawTexture(e,x,_+t,c+r,i-_-p,a-c-g,D,v,1,!1,l)}}}Context.tmpuv1=[0,0,0,0,0,0,0,0],Context._MAXVERTNUM=65535,Context.MAXCLIPRECT=null,Context.SEGNUM=32,Context._contextcount=0,Context._textRender=null,Context.tmpUVRect=[0,0,0,0];class ContextParams{constructor(){this.lineWidth=1}clear(){this.lineWidth=1,this.textAlign=this.textBaseline=null}make(){return this===ContextParams.DEFAULT?new ContextParams:this}}class LayaGLQuickRunner{static __init__(){LayaGLQuickRunner.map[SpriteConst.ALPHA|SpriteConst.TRANSFORM|SpriteConst.GRAPHICS]=LayaGLQuickRunner.alpha_transform_drawLayaGL,LayaGLQuickRunner.map[SpriteConst.ALPHA|SpriteConst.GRAPHICS]=LayaGLQuickRunner.alpha_drawLayaGL,LayaGLQuickRunner.map[SpriteConst.TRANSFORM|SpriteConst.GRAPHICS]=LayaGLQuickRunner.transform_drawLayaGL,LayaGLQuickRunner.map[SpriteConst.TRANSFORM|SpriteConst.CHILDS]=LayaGLQuickRunner.transform_drawNodes,LayaGLQuickRunner.map[SpriteConst.ALPHA|SpriteConst.TRANSFORM|SpriteConst.TEXTURE]=LayaGLQuickRunner.alpha_transform_drawTexture,LayaGLQuickRunner.map[SpriteConst.ALPHA|SpriteConst.TEXTURE]=LayaGLQuickRunner.alpha_drawTexture,LayaGLQuickRunner.map[SpriteConst.TRANSFORM|SpriteConst.TEXTURE]=LayaGLQuickRunner.transform_drawTexture,LayaGLQuickRunner.map[SpriteConst.GRAPHICS|SpriteConst.CHILDS]=LayaGLQuickRunner.drawLayaGL_drawNodes}static transform_drawTexture(e,t,r,i){var a=e.texture;t.save(),t.transformByMatrix(e.transform,r,i);var s=e._isWidthSet?e._width:a.sourceWidth,n=e._isHeightSet?e._height:a.sourceHeight,o=s/a.sourceWidth,l=n/a.sourceHeight;if(s=a.width*o,n=a.height*l,s<=0||n<=0)return null;var h=-e.pivotX+a.offsetX*o,d=-e.pivotY+a.offsetY*l;e._getBit(NodeFlags.HIDE_BY_EDITOR)||t.drawTexture(a,h,d,s,n),t.restore()}static alpha_drawTexture(e,t,r,i){var a=e._style,s=a.alpha,n=e.texture;if(s>.01||e._needRepaint()){var o=t.globalAlpha;t.globalAlpha*=s;var l=e._isWidthSet?e._width:n.sourceWidth,h=e._isHeightSet?e._height:n.sourceHeight,d=l/n.sourceWidth,u=h/n.sourceHeight;if(l=n.width*d,h=n.height*u,l<=0||h<=0)return null;var c=r-a.pivotX+n.offsetX*d,_=i-a.pivotY+n.offsetY*u;e._getBit(NodeFlags.HIDE_BY_EDITOR)||t.drawTexture(n,c,_,l,h),t.globalAlpha=o}}static alpha_transform_drawTexture(e,t,r,i){var a=e._style,s=a.alpha,n=e.texture;if(s>.01||e._needRepaint()){var o=t.globalAlpha;t.globalAlpha*=s,t.save(),t.transformByMatrix(e.transform,r,i);var l=e._isWidthSet?e._width:n.sourceWidth,h=e._isHeightSet?e._height:n.sourceHeight,d=l/n.sourceWidth,u=h/n.sourceHeight;if(l=n.width*d,h=n.height*u,l<=0||h<=0)return null;var c=-a.pivotX+n.offsetX*d,_=-a.pivotY+n.offsetY*u;e._getBit(NodeFlags.HIDE_BY_EDITOR)||t.drawTexture(n,c,_,l,h),t.restore(),t.globalAlpha=o}}static alpha_transform_drawLayaGL(e,t,r,i){var a=e._style,s=a.alpha;if(s>.01||e._needRepaint()){var n=t.globalAlpha;t.globalAlpha*=s,t.save(),t.transformByMatrix(e.transform,r,i),e._getBit(NodeFlags.HIDE_BY_EDITOR)||e._graphics&&e._graphics._render(e,t,-a.pivotX,-a.pivotY),t.restore(),t.globalAlpha=n}}static alpha_drawLayaGL(e,t,r,i){var a=e._style,s=a.alpha;if(s>.01||e._needRepaint()){var n=t.globalAlpha;t.globalAlpha*=s,e._getBit(NodeFlags.HIDE_BY_EDITOR)||e._graphics&&e._graphics._render(e,t,r-a.pivotX,i-a.pivotY),t.globalAlpha=n}}static transform_drawLayaGL(e,t,r,i){var a=e._style;t.save(),t.transformByMatrix(e.transform,r,i),e._getBit(NodeFlags.HIDE_BY_EDITOR)||e._graphics&&e._graphics._render(e,t,-a.pivotX,-a.pivotY),t.restore()}static transform_drawNodes(e,t,r,i){var a=e._getBit(NodeFlags.DRAWCALL_OPTIMIZE)&&t.drawCallOptimize(!0),s=e._style;t.save(),t.transformByMatrix(e.transform,r,i),r=-s.pivotX,i=-s.pivotY;var n=e._children,o=n.length;let l,h,d,u,c,_,p;s.viewport&&(l=s.viewport,h=l.x,d=l.y,u=l.right,c=l.bottom);for(let e=0;e<o;++e){let a=n[e],s=a._visible||a._getBit(NodeFlags.DISABLE_VISIBILITY);l&&((_=a._x)>=u||_+a.width<=h||(p=a._y)>=c||p+a.height<=d)&&(s=!1),s&&a.render(t,r,i)}t.restore(),a&&t.drawCallOptimize(!1)}static drawLayaGL_drawNodes(e,t,r,i){var a=e._getBit(NodeFlags.DRAWCALL_OPTIMIZE)&&t.drawCallOptimize(!0),s=e._style;r-=s.pivotX,i-=s.pivotY,e._getBit(NodeFlags.HIDE_BY_EDITOR)||e._graphics&&e._graphics._render(e,t,r,i);var n=e._children,o=n.length;let l,h,d,u,c,_,p;s.viewport&&(l=s.viewport,h=l.x,d=l.y,u=l.right,c=l.bottom);for(let e=0;e<o;++e){let a=n[e],s=a._visible||a._getBit(NodeFlags.DISABLE_VISIBILITY);l&&((_=a._x)>=u||_+a.width<=h||(p=a._y)>=c||p+a.height<=d)&&(s=!1),s&&a.render(t,r,i)}a&&t.drawCallOptimize(!1)}}LayaGLQuickRunner.map=[];var Se=0;class DefferTouchResContext extends Context{constructor(){super(...arguments),this.cache=null,this.mustTouchRes=[],this.randomTouchRes=[],this.genID=Se++}touchRes(e){e.isRandomTouch?this.randomTouchRes.push(e):this.mustTouchRes.push(e)}}class RenderToCache extends Render2D{constructor(){super(null),this.renderResult=[]}clone(e){return null}_createMesh(){}setVertexDecl(e){this._tex_vert_decl!=e&&(this._tex_vert_decl=e,this._createMesh())}renderStart(){}draw(e,t,r,i,a,s){this.setVertexDecl(e.vertexDeclarition);let n=new RenderObject2D(e,t,r,i,a,s);s.shaderData.addDefine(ShaderDefines2D.WORLDMAT),this.renderResult.push(n)}drawMesh(e,t){throw"not implement"}renderEnd(){}}class RenderObject2D{constructor(e,t,r,i,a,s){this.vertexDeclarition=e.vertexDeclarition,this.vbBuffer=new ArrayBuffer(r),this.ibBuffer=new ArrayBuffer(a),new Uint8Array(this.vbBuffer).set(new Uint8Array(e.vbBuffer,t,r)),new Uint8Array(this.ibBuffer).set(new Uint8Array(e.ibBuffer,i,a)),this.mtl=s,this.vboff=0,this.vblen=r,this.iboff=0,this.iblen=a}}class Cache_Info{constructor(){this.page=null}}function mergeClipMatrix(e,t,r){let i=e.tx+e.a,a=e.ty+e.d,s=t.tx+t.a,n=t.ty+t.d,o=r.tx=Math.max(e.tx,t.tx),l=r.ty=Math.max(e.ty,t.ty);if(r.b=r.c=0,r.tx=o,r.ty=l,i<=t.tx||a<=t.ty||s<=e.tx||n<=e.ty)r.a=-.1,r.d=-.1;else{let e=Math.min(i,s),t=Math.min(a,n);r.a=e-o,r.d=t-l}return r}class RenderPageContex{constructor(e,t,r){this.alpha=1,this.width=0,this.height=0,this.blend=0;let i=this.curMatrix=e._curMat.clone();i.tx+=i.a*t+i.c*r,i.ty+=i.b*t+i.d*r,this.alpha=e.globalAlpha,this.render2d=e.render2D,this.width=e.width,this.height=e.height,this.clipInfo=e._globalClipMatrix.clone(),this.blend=e._nBlendType}_copyClipInfo(e){let t=this.clipInfo;var r=e.clipMatDir;r.x=t.a,r.y=t.b,r.z=t.c,r.w=t.d,e.clipMatDir=r;var i=e.clipMatPos;i.x=t.tx,i.y=t.ty,e.clipMatPos=i}clipRect(e){let t=e.x,r=e.y,i=e.width,a=e.height;var s=this.clipInfo,n=s.tx,o=s.ty,l=n+s.a,h=o+s.d;if(i>=Const.MAX_CLIP_SIZE)s.a=s.d=Const.MAX_CLIP_SIZE,s.b=s.c=s.tx=s.ty=0;else{let e=this.curMatrix;e._bTransform?(s.tx=t*e.a+r*e.c+e.tx,s.ty=t*e.b+r*e.d+e.ty,s.a=i*e.a,s.b=i*e.b,s.c=a*e.c,s.d=a*e.d):(s.tx=t+e.tx,s.ty=r+e.ty,s.a=i,s.b=s.c=0,s.d=a)}if(s.a>0&&s.d>0){var d=s.tx+s.a,u=s.ty+s.d;d<=n||u<=o||s.tx>=l||s.ty>=h?(s.a=-.1,s.d=-.1):(s.tx<n&&(s.a-=n-s.tx,s.tx=n),d>l&&(s.a-=d-l),s.ty<o&&(s.d-=o-s.ty,s.ty=o),u>h&&(s.d-=u-h),s.a<=0&&(s.a=-.1),s.d<=0&&(s.d=-.1))}}setBlendMode(e){this.blend=BlendMode.TOINT[e]}_applyBlend(e){let t=e.shaderData;switch(this.blend){case 1:case 3:case 5:t.setInt(Shader3D.BLEND_SRC,RenderState.BLENDPARAM_ONE),t.setInt(Shader3D.BLEND_DST,RenderState.BLENDPARAM_ONE);break;case 2:t.setInt(Shader3D.BLEND_SRC,RenderState.BLENDPARAM_DST_COLOR),t.setInt(Shader3D.BLEND_DST,RenderState.BLENDPARAM_ONE_MINUS_SRC_ALPHA);break;case 6:t.setInt(Shader3D.BLEND_SRC,RenderState.BLENDPARAM_ZERO),t.setInt(Shader3D.BLEND_DST,RenderState.BLENDPARAM_SRC_ALPHA);break;case 7:t.setInt(Shader3D.BLEND_SRC,RenderState.BLENDPARAM_ZERO),t.setInt(Shader3D.BLEND_DST,RenderState.BLENDPARAM_ZERO);break;case 9:t.setInt(Shader3D.BLEND_SRC,RenderState.BLENDPARAM_SRC_ALPHA),t.setInt(Shader3D.BLEND_DST,RenderState.BLENDPARAM_ONE_MINUS_SRC_ALPHA);break;default:t.setInt(Shader3D.BLEND_SRC,RenderState.BLENDPARAM_ONE),t.setInt(Shader3D.BLEND_DST,RenderState.BLENDPARAM_ONE_MINUS_SRC_ALPHA)}}}class CachePage{constructor(){this.sprite=null,this.meshes=null,this.defferTouchRes=null,this.defferTouchResRand=null,this.children=null}render(e,t,r){let i=e.transform,a=t.curMatrix;if(r)a.copyTo(Te);else{let r=e._x,s=e._y;i?(i.copyTo(De),De.tx=r,De.ty=s,Matrix.mul(De,a,Te)):(Te.a=a.a,Te.b=a.b,Te.c=a.c,Te.d=a.d,Te.tx=a.a*r+a.c*s+a.tx,Te.ty=a.b*r+a.d*s+a.ty),t.alpha*=e.alpha,e.blendMode&&t.setBlendMode(e.blendMode)}ye.setValue(t.width,t.height);let s=ve,n=s.elements;n[0]=Te.a,n[1]=Te.b,n[4]=Te.c,n[5]=Te.d,n[12]=Te.tx,n[13]=Te.ty,this.meshes.forEach((e=>{let r=t.render2d,i=e.mtl;i.textureHost instanceof TextTexture&&i.textureHost.touchTexture(),i.size=ye;let a=i.localClipMatrix;Matrix.mul(a,Te,Ce),mergeClipMatrix(t.clipInfo,Ce,Ce);let n=i.clipMatDir,o=i.clipMatPos;n.x=Ce.a,n.y=Ce.b,n.z=Ce.c,n.w=Ce.d,i.clipMatDir=n,o.x=Ce.tx,o.y=Ce.ty,i.clipMatPos=o,i.mmat=s,i.vertAlpha=t.alpha,t._applyBlend(i),r.draw(e,e.vboff,e.vblen,e.iboff,e.iblen,i)})),this.defferTouchRes.forEach((e=>{e.touch()})),this.defferTouchResRand.forEach((e=>e.touch())),this.children&&this.children.forEach((e=>{let r=t.curMatrix.clone(),i=t.alpha,a=e.parent._cacheStyle.cacheInfo,s=a.mat;Matrix.mul(s,r,t.curMatrix),t.alpha*=a.alpha;let n=t.blend;null!=a.blend&&t.setBlendMode(a.blend);let o=t.clipInfo.clone(),l=a.clipMatrix;Matrix.mul(l,t.curMatrix,Ce),mergeClipMatrix(t.clipInfo,Ce,t.clipInfo),e._cacheStyle.cacheInfo.page.render(e,t,!1),t.curMatrix=r,t.alpha=i,t.blend=n,t.clipInfo=o}))}}var ye=new Vector2;class SpriteCache{static curMatSubSpriteMat(e,t,r){if(e._renderType&SpriteConst.TRANSFORM)e.transform.copyTo(xe),xe.tx=e._x,xe.ty=e._y,xe.invert(),Matrix.mul(xe,t,r);else{t.copyTo(r);let i=-e._x,a=-e._y;r.tx+=r.a*i+r.c*a,r.ty+=r.b*i+r.d*a}return r}static renderCacheAsNormal(e,t,r,i,a){let s=!1;var n=t._getCacheStyle().cacheInfo.page;if(!n||t._needRepaint()||ILaya.stage.isGlobalRepaint()){if(t.alpha<=1e-6&&(t.alpha=.001),s=!0,e instanceof DefferTouchResContext){let r=e.cache;r.children?r.children.indexOf(t)<0&&r.children.push(t):r.children=[t];let s=t.parent,n=s._cacheStyle.cacheInfo;if(n.page=r,e.genID!=n.contextID){n.contextID=e.genID;let o=e._curMat.clone();0==i&&0==a||(o.tx+=i*o.a+a*o.c,o.ty+=i*o.b+a*o.d),n.mat=SpriteCache.curMatSubSpriteMat(t,o,o),n.alpha=e.globalAlpha/t.alpha;let l=r.sprite;if(s.blendMode)n.blend=s.blendMode;else{let e=s;for(;e!=l;)if(e=e.parent,e.blendMode){n.blend=e.blendMode;break}}n.clipMatrix=e._globalClipMatrix.clone()}}(n=t._cacheStyle.cacheInfo.page=new CachePage).sprite=t,Stat.canvasNormal++;let o=new DefferTouchResContext;o.cache=n;let l=new RenderToCache;o.render2D=l,o.startRender(),r._fun(t,o,0,0),o.endRender(),n.meshes=l.renderResult,n.defferTouchRes=o.mustTouchRes,n.defferTouchResRand=o.randomTouchRes}if(!(e instanceof DefferTouchResContext)){let r=new RenderPageContex(e,i,a);n.render(t,r,!0)}return s}}var Te=new Matrix,xe=new Matrix,De=new Matrix,ve=new Matrix4x4,Ce=new Matrix;class RenderSprite{constructor(e,t){if(LayaGLQuickRunner.map[e]&&LayaEnv.isPlaying)return this._fun=LayaGLQuickRunner.map[e],void(this._next=RenderSprite.NORENDER);switch(this._next=t||RenderSprite.NORENDER,e){case 0:return void(this._fun=this._no);case SpriteConst.ALPHA:return void(this._fun=this._alpha);case SpriteConst.TRANSFORM:return void(this._fun=this._transform);case SpriteConst.BLEND:return void(this._fun=this._blend);case SpriteConst.CANVAS:return void(this._fun=this._canvas);case SpriteConst.MASK:return void(this._fun=this._mask);case SpriteConst.CLIP:return void(this._fun=this._clip);case SpriteConst.GRAPHICS:return void(this._fun=this._graphics);case SpriteConst.CHILDS:return void(this._fun=this._children);case SpriteConst.CUSTOM:return void(this._fun=this._custom);case SpriteConst.TEXTURE:return void(this._fun=this._texture);case SpriteConst.FILTERS:return void(this._fun=Filter._filter);case SpriteConst.HITAREA:return void(this._fun=this._hitarea);case 69905:return void(this._fun=RenderSprite._initRenderFun)}}static __init__(){LayaGLQuickRunner.__init__();var e=new RenderSprite(69905,null);let t=RenderSprite.renders.length=2*SpriteConst.CHILDS;for(let r=0;r<t;r++)RenderSprite.renders[r]=e;RenderSprite.renders[0]=new RenderSprite(0,null)}static _initRenderFun(e,t,r,i){var a=e._renderType;(RenderSprite.renders[a]=RenderSprite._getTypeRender(a))._fun(e,t,r,i)}static _getTypeRender(e){if(LayaGLQuickRunner.map[e]&&LayaEnv.isPlaying)return new RenderSprite(e,null);for(var t=null,r=SpriteConst.CHILDS;r>0;)r&e&&(t=new RenderSprite(r,t)),r>>=1;return t}_no(e,t,r,i){}_custom(e,t,r,i){e.customRender(t,r,i),this._next._fun(e,t,0,0)}_clip(e,t,r,i){let a=this._next;if(a==RenderSprite.NORENDER)return;if(e._getBit(NodeFlags.DISABLE_INNER_CLIPPING))return void a._fun(e,t,r,i);let s=e._style.scrollRect,n=s.width,o=s.height;0===n&&(n=.001),0===o&&(o=.001),t.save(),t.clipRect(r,i,n,o),a._fun(e,t,r-s.x,i-s.y),t.restore()}_texture(e,t,r,i){if(!e._getBit(NodeFlags.HIDE_BY_EDITOR)){var a=e.texture;if(a._getSource()){var s=e._isWidthSet?e._width:a.sourceWidth,n=e._isHeightSet?e._height:a.sourceHeight,o=s/a.sourceWidth,l=n/a.sourceHeight;if(s=a.width*o,n=a.height*l,s>0&&n>0){let h=r-e.pivotX+a.offsetX*o,d=i-e.pivotY+a.offsetY*l;t.material=e.graphics.material,t.drawTexture(a,h,d,s,n,4294967295),t.material=null}}}this._next!=RenderSprite.NORENDER&&this._next._fun(e,t,r,i)}_graphics(e,t,r,i){if(!e._getBit(NodeFlags.HIDE_BY_EDITOR)){let a=e._style,s=e._graphics;s&&s._render(e,t,r-a.pivotX,i-a.pivotY)}this._next!=RenderSprite.NORENDER&&this._next._fun(e,t,r,i)}_hitarea(e,t,r,i){if(e.hitArea){var a=e._style,s=e.hitArea._hit,n=t.globalAlpha;t.globalAlpha*=.5,s&&s._render(e,t,r-a.pivotX,i-a.pivotY),(s=e.hitArea._unHit)&&s._render(e,t,r-a.pivotX,i-a.pivotY),t.globalAlpha=n}this._next!=RenderSprite.NORENDER&&this._next._fun(e,t,r,i)}_alpha(e,t,r,i){var a=e._style.alpha;if(a>.01||e._needRepaint()){var s=t.globalAlpha;t.globalAlpha*=a,this._next!=RenderSprite.NORENDER&&this._next._fun(e,t,r,i),t.globalAlpha=s}}_transform(e,t,r,i){var a=e.transform,s=this._next;a&&s!=RenderSprite.NORENDER?(t.save(),t.transform(a.a,a.b,a.c,a.d,a.tx+r,a.ty+i),s._fun(e,t,0,0),t.restore()):s!=RenderSprite.NORENDER&&s._fun(e,t,r,i)}_children(e,t,r,i){let a=e._style,s=e._children,n=s.length;r-=e.pivotX,i-=e.pivotY;let o,l,h,d,u,c,_,p=e._getBit(NodeFlags.DRAWCALL_OPTIMIZE)&&t.drawCallOptimize(!0);a.viewport&&(o=a.viewport,l=o.x,h=o.y,d=o.right,u=o.bottom);for(let a=0;a<n;++a){let n=s[a],p=n._visible||n._getBit(NodeFlags.DISABLE_VISIBILITY);p&&(o&&((c=n._x)>=d||c+n.width<=l||(_=n._y)>=u||_+n.height<=h)?p=!1:e._cacheStyle.mask!=n||n._getBit(NodeFlags.DISABLE_VISIBILITY)||(p=!1)),p&&(n._getBit(NodeFlags.DISABLE_OUTER_CLIPPING)&&t.clipRect(0,0,1,1,!0),n.render(t,r,i))}p&&t.drawCallOptimize(!1)}_renderNextToCacheRT(t,r){var i=t._getCacheStyle();if(t._needRepaint()||!i.renderTexture||ILaya.stage.isGlobalRepaint()){i.renderTexture&&i.renderTexture.destroy();let a=t._cacheStyle._calculateCacheRect(t,"bitmap",0,0),s=i.cacheRect;if(s.width<=0||s.height<=0)return!1;Stat.canvasBitmap++;let n=s.width*a.x,o=s.height*a.y,l=new RenderTexture2D(n,o,e.RenderTargetFormat.R8G8B8A8),h=new Context;return h.copyState(r),h.size(n,o),h.render2D=new Render2DSimple(l),h.startRender(),this._next._fun(t,h,-s.x,-s.y),h.endRender(),h.render2D.setRenderTarget(r.render2D.out),i.renderTexture=l,!0}return!1}_canvas(e,t,r,i){var a=e._cacheStyle,s=this._next;if(a.mask&&a.mask._getBit(NodeFlags.DISABLE_VISIBILITY))return void s._fun(e,t,r,i);if("bitmap"===e.cacheAs){t.drawLeftData(),this._renderNextToCacheRT(e,t);var n=a.cacheRect;t.material=e.graphics.material;let s=a.renderTexture;s&&t._drawRenderTexture(s,r+n.x,i+n.y,s.width,s.height,null,1,[0,1,1,1,1,0,0,0]),t.material=null}else{if(!RenderSprite.cacheNormalEnable)return void s._fun(e,t,r,i);t.drawLeftData(),SpriteCache.renderCacheAsNormal(t,e,this._next,r,i)}}static RenderToRenderTexture(t,r,i,a,s=null){let n=t._getCacheStyle()._calculateCacheRect(t,"bitmap",0,0),o=t._cacheStyle.cacheRect,l=new Context;r&&l.copyState(r);let h=s;if(h)l.size(h.width,h.height),l.clearBG(RenderTexture2D._clearColor.r,RenderTexture2D._clearColor.g,RenderTexture2D._clearColor.b,RenderTexture2D._clearColor.a);else{let t=o.width*n.x,r=o.height*n.y;h=new RenderTexture2D(t,r,e.RenderTargetFormat.R8G8B8A8),l.size(t,r),l.clearBG(0,0,0,0)}return l.render2D=l.render2D.clone(h),l.startRender(),t.render(l,i-t.x-o.x,a-t.y-o.y),l.endRender(),r&&l.render2D.setRenderTarget(r.render2D.out),h}static RenderToCacheTexture(e,t,r,i){var a=e._getCacheStyle();return!(!e._needRepaint()&&a.renderTexture&&!ILaya.stage.isGlobalRepaint())&&(a.renderTexture&&a.renderTexture.destroy(),a.renderTexture=RenderSprite.RenderToRenderTexture(e,t,r,i),!0)}_blend(e,t,r,i){var a=e._style;t.save(),t.globalCompositeOperation=a.blendMode,this._next._fun(e,t,r,i),t.restore()}_mask(t,r,i,a){let s=t._getCacheStyle();if(t._needRepaint()||!s.renderTexture||s.renderTexture.destroyed||ILaya.stage.isGlobalRepaint()){s.renderTexture&&s.renderTexture.destroy(),t._cacheStyle._calculateCacheRect(t,"bitmap",0,0);let i=s.cacheRect;if(i.width<=0||i.height<=0)return;let a=t.mask,n=a._getCacheStyle();n._calculateCacheRect(a,"bitmap",0,0);let o=n.cacheRect,l=Math.max(i.x,o.x+a.x),h=Math.max(i.y,o.y+a.y),d=Math.min(i.x+i.width,a.x+o.x+o.width),u=Math.min(i.y+i.height,a.y+o.y+o.height),c=d-l;if(c<=0)return;let _=u-h;if(_<=0)return;RenderSprite.RenderToCacheTexture(a,r,0,0);let p=new RenderTexture2D(c,_,e.RenderTargetFormat.R8G8B8A8),g=new Context;g.clearBG(0,0,0,0),g.size(c,_),g.render2D=new Render2DSimple(p),g.startRender(),this._next._fun(t,g,-l,-h);let m=n.renderTexture;g.globalCompositeOperation="mask",g._drawRenderTexture(m,a.x-l+o.x,a.y-h+o.y,o.width,o.height,null,1,[0,1,1,1,1,0,0,0]),g.endRender(),g.render2D.setRenderTarget(r.render2D.out),s.renderTexture=p,s.cacheRect.x=l,s.cacheRect.y=h,s.cacheRect.width=p.width,s.cacheRect.height=p.height}let n=s.renderTexture,o=s.cacheRect;r._drawRenderTexture(n,i+o.x,a+o.y,n.width,n.height,null,1,[0,1,1,1,1,0,0,0])}}RenderSprite.cacheNormalEnable=!0,RenderSprite.renders=[],RenderSprite.NORENDER=new RenderSprite(0,null);class HTMLCanvas extends Resource{constructor(e=!1){super(),this._source=e?Browser.createElement("canvas"):this,this.lock=!0}get source(){return this._source}get width(){return this._width}set width(e){this._width=e}get height(){return this._height}set height(e){this._height=e}_getSource(){return this._source}clear(){this._ctx&&(this._ctx.clear?this._ctx.clear():this._ctx.clearRect(0,0,this._width,this._height)),this._texture&&(this._texture.destroy(),this._texture=null)}destroy(){super.destroy(),this._setCPUMemory(0),this._ctx&&this._ctx.destroy&&this._ctx.destroy(),this._ctx=null}release(){}get context(){return this._ctx||(this._source==this?this._ctx=new Context:this._ctx=this._source.getContext(LayaEnv.isConch?"layagl":"2d"),this._ctx._canvas=this),this._ctx}_setContext(e){this._ctx=e}getContext(e,t=null){return this.context}getMemSize(){return 0}size(e,t){(this._width!=e||this._height!=t||this._source&&(this._source.width!=e||this._source.height!=t))&&(this._width=e,this._height=t,this._setCPUMemory(e*t*4),this._ctx&&this._ctx.size&&this._ctx.size(e,t),this._source&&(this._source.height=t,this._source.width=e),this._texture&&(this._texture.destroy(),this._texture=null))}getTexture(){if(!this._texture){var t=new Texture2D(this.source.width,this.source.height,e.TextureFormat.R8G8B8A8,!0,!1,!1);t.setImageData(this.source,!1,!1),this._texture=new Texture(t)}return this._texture}toBase64(e,t){if(this._source){if(LayaEnv.isConch){var r=window,i=this._ctx._targets.sourceWidth,a=this._ctx._targets.sourceHeight,s=this._ctx._targets.getData(0,0,i,a);return r.conchToBase64FlipY?r.conchToBase64FlipY(e,t,s.buffer,i,a):r.conchToBase64(e,t,s.buffer,i,a)}return this._source.toDataURL(e,t)}return null}toBase64Async(e,t,r){var i=this._ctx._targets.sourceWidth,a=this._ctx._targets.sourceHeight;this._ctx._targets.getDataAsync(0,0,i,a,(function(s){let n=window;var o=n.conchToBase64FlipY?n.conchToBase64FlipY(e,t,s.buffer,i,a):n.conchToBase64(e,t,s.buffer,i,a);r(o)}))}}class BoundsStyle{reset(){return this.bounds&&this.bounds.recover(),this.userBounds&&this.userBounds.recover(),this.bounds=null,this.userBounds=null,this.temBM=null,this}recover(){Pool.recover("BoundsStyle",this.reset())}static create(){return Pool.getItemByClass("BoundsStyle",BoundsStyle)}}class CacheStyle{constructor(){this.renderTexOffx=0,this.renderTexOffy=0,this.cacheInfo=new Cache_Info,this.reset()}onInvisible(){}recover(){this!==CacheStyle.EMPTY&&Pool.recover("SpriteCache",this.reset())}reset(){return this.userSetCache="none",this.staticCache=!1,this.mask=null,this.maskParent=null,this.cacheRect&&this.cacheRect.recover(),this.cacheRect=null,this}static create(){return Pool.getItemByClass("SpriteCache",CacheStyle)}_calculateCacheRect(e,t,r,i){var a,s=e._getCacheStyle();if(s.cacheRect||(s.cacheRect=Rectangle.create()),"bitmap"===t?((a=e.getSelfBounds()).width=a.width,a.height=a.height,a.x=a.x-e.pivotX,a.y=a.y-e.pivotY,a.x=a.x,a.y=a.y,a.x=Math.floor(a.x+r)-r,a.y=Math.floor(a.y+i)-i,a.width=Math.floor(a.width),a.height=Math.floor(a.height),s.cacheRect.copyFrom(a)):s.cacheRect.setTo(-e._style.pivotX,-e._style.pivotY,1,1),a=s.cacheRect,e._style.scrollRect){var n=e._style.scrollRect;a.x-=n.x,a.y-=n.y}return CacheStyle._scaleInfo.setTo(1,1),CacheStyle._scaleInfo}}CacheStyle.EMPTY=new CacheStyle,CacheStyle._scaleInfo=new Point,CacheStyle.CANVAS_EXTEND_EDGE=16;class SpriteStyle{constructor(){this.reset()}reset(){return this.scaleX=this.scaleY=1,this.skewX=this.skewY=0,this.pivotX=this.pivotY=this.rotation=0,this.alpha=1,this.scrollRect&&this.scrollRect.recover(),this.scrollRect=null,this.viewport&&this.viewport.recover(),this.viewport=null,this.hitArea=null,this.dragging=null,this.blendMode=null,this}recover(){this!==SpriteStyle.EMPTY&&Pool.recover("SpriteStyle",this.reset())}static create(){return Pool.getItemByClass("SpriteStyle",SpriteStyle)}}SpriteStyle.EMPTY=new SpriteStyle;class AlphaCmd{static create(e){var t=Pool.getItemByClass("AlphaCmd",AlphaCmd);return t.alpha=e,t}recover(){Pool.recover("AlphaCmd",this)}run(e,t,r){e.alpha(this.alpha)}get cmdID(){return AlphaCmd.ID}}AlphaCmd.ID="Alpha";class DrawCircleCmd{constructor(){this.lineWidth=0}static create(e,t,r,i,a,s){var n=Pool.getItemByClass("DrawCircleCmd",DrawCircleCmd);return n.x=e,n.y=t,n.radius=r,n.fillColor=i,n.lineColor=a,n.lineWidth=s,n}recover(){this.fillColor=null,this.lineColor=null,Pool.recover("DrawCircleCmd",this)}run(e,t,r){let i=this.lineWidth>=1&&this.lineColor?this.lineWidth/2:0;if(this.percent&&e.sprite){let a=e.sprite.width,s=e.sprite.height;e._drawCircle(this.x*a+t,this.y*s+r,this.radius*Math.min(a,s)-i,this.fillColor,this.lineColor,this.lineWidth,0)}else e._drawCircle(this.x+t,this.y+r,this.radius-i,this.fillColor,this.lineColor,this.lineWidth,0)}get cmdID(){return DrawCircleCmd.ID}getBoundPoints(e){return Rectangle._getBoundPointS(this.x-this.radius,this.y-this.radius,this.radius+this.radius,this.radius+this.radius,this.percent?e:null)}}DrawCircleCmd.ID="DrawCircle",ClassUtils.regClass("DrawCircleCmd",DrawCircleCmd);class DrawCurvesCmd{static create(e,t,r,i,a){var s=Pool.getItemByClass("DrawCurvesCmd",DrawCurvesCmd);return s.x=e,s.y=t,s.points=r,s.lineColor=i,s.lineWidth=a,s}recover(){this.points=null,this.lineColor=null,Pool.recover("DrawCurvesCmd",this)}run(e,t,r){this.points&&e.drawCurves(this.x+t,this.y+r,this.points,this.lineColor,this.lineWidth)}get cmdID(){return DrawCurvesCmd.ID}getBoundPoints(e){return Bezier.I.getBezierPoints(this.points)}}DrawCurvesCmd.ID="DrawCurves",ClassUtils.regClass("DrawCurvesCmd",DrawCurvesCmd);class DrawImageCmd{constructor(){this.color=4294967295}static create(e,t,r,i,a,s){null==i&&(i=e.sourceWidth),null==a&&(a=e.sourceHeight);let n=i/e.sourceWidth,o=a/e.sourceHeight;i=e.width*n,a=e.height*o,t+=e.offsetX*n,r+=e.offsetY*o;var l=Pool.getItemByClass("DrawImageCmd",DrawImageCmd);return l.texture=e,e._addReference(),l.x=t,l.y=r,l.width=i,l.height=a,l.color=null!=s?ColorUtils.create(s).numColor:4294967295,l}recover(){this.texture&&this.texture._removeReference(),this.texture=null,Pool.recover("DrawImageCmd",this)}run(e,t,r){this.texture&&e.drawTexture(this.texture,this.x+t,this.y+r,this.width,this.height,this.color)}get cmdID(){return DrawImageCmd.ID}}DrawImageCmd.ID="DrawImage";class DrawLineCmd{constructor(){this.lineWidth=0}static create(e,t,r,i,a,s){var n=Pool.getItemByClass("DrawLineCmd",DrawLineCmd);return n.fromX=e,n.fromY=t,n.toX=r,n.toY=i,n.lineColor=a,n.lineWidth=s,n}recover(){Pool.recover("DrawLineCmd",this)}run(e,t,r){let i=this.lineWidth<1||this.lineWidth%2==0?0:.5;if(this.percent&&e.sprite){let a=e.sprite.width,s=e.sprite.height;e._drawLine(t,r,this.fromX*a+i,this.fromY*s+i,this.toX*a+i,this.toY*s+i,this.lineColor,this.lineWidth,0)}else e._drawLine(t,r,this.fromX+i,this.fromY+i,this.toX+i,this.toY+i,this.lineColor,this.lineWidth,0)}get cmdID(){return DrawLineCmd.ID}getBoundPoints(e){let t;Ee.length=0,t=.5*this.lineWidth;let r=this.fromX,i=this.fromY,a=this.toX,s=this.toY;return this.percent&&(r*=e.width,i*=e.height,a*=e.width,s*=e.height),r==a?Ee.push(r+t,i,a+t,s,r-t,i,a-t,s):i==s?Ee.push(r,i+t,a,s+t,r,i-t,a,s-t):Ee.push(r,i,a,s),Ee}}DrawLineCmd.ID="DrawLine";const Ee=[];ClassUtils.regClass("DrawLineCmd",DrawLineCmd);class DrawLinesCmd{constructor(){this.lineWidth=0}static create(e,t,r,i,a){var s=Pool.getItemByClass("DrawLinesCmd",DrawLinesCmd);return s.x=e,s.y=t,s.points=r,s.lineColor=i,s.lineWidth=a,s}recover(){this.points=null,this.lineColor=null,Pool.recover("DrawLinesCmd",this)}run(e,t,r){let i=this.lineWidth<1||this.lineWidth%2==0?0:.5;this.points&&e._drawLines(this.x+i+t,this.y+i+r,this.points,this.lineColor,this.lineWidth,0)}get cmdID(){return DrawLinesCmd.ID}}DrawLinesCmd.ID="DrawLines",ClassUtils.regClass("DrawLinesCmd",DrawLinesCmd);class DrawPathCmd{static create(e,t,r,i,a){var s=Pool.getItemByClass("DrawPathCmd",DrawPathCmd);return s.x=e,s.y=t,s.paths=r,s.brush=i,s.pen=a,s}recover(){this.paths=null,this.brush=null,this.pen=null,Pool.recover("DrawPathCmd",this)}run(e,t,r){this.paths&&e._drawPath(this.x+t,this.y+r,this.paths,this.brush,this.pen)}get cmdID(){return DrawPathCmd.ID}getBoundPoints(e){let t=Re;t.length=0;let r=this.paths,i=r.length;for(let e=0;e<i;e++){let i=r[e];i.length>1&&(t.push(i[1],i[2]),i.length>3&&t.push(i[3],i[4]))}return t}}DrawPathCmd.ID="DrawPath";const Re=[];ClassUtils.regClass("DrawPathCmd",DrawPathCmd);class DrawPieCmd{constructor(){this.radius=0,this.lineWidth=0}static create(e,t,r,i,a,s,n,o){var l=Pool.getItemByClass("DrawPieCmd",DrawPieCmd);return l.x=e,l.y=t,l.radius=r,l._startAngle=i,l._endAngle=a,l.fillColor=s,l.lineColor=n,l.lineWidth=o,l}recover(){this.fillColor=null,this.lineColor=null,Pool.recover("DrawPieCmd",this)}run(e,t,r){let i=this.lineWidth>=1&&this.lineColor?this.lineWidth/2:0,a=this.lineColor?this.lineWidth:0;e._drawPie(this.x+i+t,this.y+i+r,this.radius-a,this._startAngle,this._endAngle,this.fillColor,this.lineColor,this.lineWidth,0)}get cmdID(){return DrawPieCmd.ID}get startAngle(){return 180*this._startAngle/Math.PI}set startAngle(e){this._startAngle=e*Math.PI/180}get endAngle(){return 180*this._endAngle/Math.PI}set endAngle(e){this._endAngle=e*Math.PI/180}getBoundPoints(e){let t=we;we.length=0;let r=Math.PI/180,i=this.endAngle-this.startAngle,a=this.x,s=this.y,n=this.radius;if(i>=360||i<=-360)return t.push(a-n,s-n),t.push(a+n,s-n),t.push(a+n,s+n),t.push(a-n,s+n),t;t.push(a,s);var o=i%360;o<0&&(o+=360);var l=this.startAngle+o,h=this.startAngle*r,d=l*r;t.push(a+n*Math.cos(h),s+n*Math.sin(h)),t.push(a+n*Math.cos(d),s+n*Math.sin(d));for(var u=90*Math.ceil(this.startAngle/90),c=90*Math.floor(l/90),_=u;_<=c;_+=90){var p=_*r;t.push(a+n*Math.cos(p),s+n*Math.sin(p))}return t}}DrawPieCmd.ID="DrawPie";const we=[];ClassUtils.regClass("DrawPieCmd",DrawPieCmd);class DrawPolyCmd{static create(e,t,r,i,a,s){var n=Pool.getItemByClass("DrawPolyCmd",DrawPolyCmd);return n.x=e,n.y=t,n.points=r,n.fillColor=i,n.lineColor=a,n.lineWidth=s,n}recover(){this.points=null,this.fillColor=null,this.lineColor=null,Pool.recover("DrawPolyCmd",this)}run(e,t,r){let i=this.points.length<=6,a=this.lineWidth>=1&&this.lineColor?this.lineWidth%2==0?0:.5:0;this.points&&e._drawPoly(this.x+a+t,this.y+a+r,this.points,this.fillColor,this.lineColor,this.lineWidth,i,0)}get cmdID(){return DrawPolyCmd.ID}}DrawPolyCmd.ID="DrawPoly",ClassUtils.regClass("DrawPolyCmd",DrawPolyCmd);class DrawRectCmd{constructor(){this.lineWidth=0}static create(e,t,r,i,a,s,n,o){var l=Pool.getItemByClass("DrawRectCmd",DrawRectCmd);return l.x=e,l.y=t,l.width=r,l.height=i,l.fillColor=a,l.lineColor=s,l.lineWidth=n,l.percent=o,l}recover(){this.fillColor=null,this.lineColor=null,Pool.recover("DrawRectCmd",this)}run(e,t,r){let i=this.lineWidth>=1&&this.lineColor?this.lineWidth/2:0,a=this.lineColor?this.lineWidth:0;if(this.percent&&e.sprite){let s=e.sprite.width,n=e.sprite.height;e.drawRect(this.x*s+i+t,this.y*n+i+r,this.width*s-a,this.height*n-a,this.fillColor,this.lineColor,this.lineWidth)}else e.drawRect(this.x+i+t,this.y+i+r,this.width-a,this.height-a,this.fillColor,this.lineColor,this.lineWidth)}get cmdID(){return DrawRectCmd.ID}getBoundPoints(e){return Rectangle._getBoundPointS(this.x,this.y,this.width,this.height,this.percent?e:null)}}DrawRectCmd.ID="DrawRect",ClassUtils.regClass("DrawRectCmd",DrawRectCmd);class DrawTextureCmd{constructor(){this.color=4294967295,this.uv=null}static create(e,t,r,i,a,s,n,o,l,h){null==i&&(i=e.sourceWidth),null==a&&(a=e.sourceHeight);let d=i/e.sourceWidth,u=a/e.sourceHeight;i=e.width*d,a=e.height*u,t+=e.offsetX*d,r+=e.offsetY*u;var c=Pool.getItemByClass("DrawTextureCmd",DrawTextureCmd);return c.texture=e,e._addReference(),c.x=t,c.y=r,c.width=i,c.height=a,c.matrix=s,c.alpha=n,c.blendMode=l,c.uv=h||null,c.color=null!=o?ColorUtils.create(o).numColor:4294967295,c}recover(){this.texture&&this.texture._removeReference(),this.texture=null,this.matrix=null,Pool.recover("DrawTextureCmd",this)}run(e,t,r){this.texture&&e.drawTextureWithTransform(this.texture,this.x,this.y,this.width,this.height,this.matrix,t,r,this.alpha,this.blendMode,this.uv,this.color)}get cmdID(){return DrawTextureCmd.ID}}DrawTextureCmd.ID="DrawTexture",ClassUtils.regClass("DrawTextureCmd",DrawTextureCmd);class FillTextureCmd{constructor(){this.color=4294967295}static create(e,t,r,i,a,s,n,o){var l=Pool.getItemByClass("FillTextureCmd",FillTextureCmd);return l.texture=e,e._addReference(),l.x=t,l.y=r,l.width=i,l.height=a,l.type=s,l.offset=n,l.color=null!=o?ColorUtils.create(o).numColor:4294967295,l}recover(){this.texture&&this.texture._removeReference(),this.texture=null,this.offset=null,Pool.recover("FillTextureCmd",this)}run(e,t,r){if(this.texture)if(this.percent&&e.sprite){let i=e.sprite.width,a=e.sprite.height;e.fillTexture(this.texture,this.x*i+t,this.y*a+r,this.width*i,this.height*a,this.type,this.offset||Point.EMPTY,this.color)}else e.fillTexture(this.texture,this.x+t,this.y+r,this.width,this.height,this.type,this.offset||Point.EMPTY,this.color)}get cmdID(){return FillTextureCmd.ID}getBoundPoints(e){return this.width&&this.height?Rectangle._getBoundPointS(this.x,this.y,this.width,this.height,this.percent?e:null):Rectangle._getBoundPointS(this.x,this.y,this.texture.width,this.texture.height)}}FillTextureCmd.ID="FillTexture",ClassUtils.regClass("FillTextureCmd",FillTextureCmd);class RestoreCmd{static create(){return Pool.getItemByClass("RestoreCmd",RestoreCmd)}recover(){Pool.recover("RestoreCmd",this)}run(e,t,r){e.restore()}get cmdID(){return RestoreCmd.ID}}RestoreCmd.ID="Restore";class RotateCmd{static create(e,t,r){var i=Pool.getItemByClass("RotateCmd",RotateCmd);return i.angle=e,i.pivotX=t,i.pivotY=r,i}recover(){Pool.recover("RotateCmd",this)}run(e,t,r){e._rotate(this.angle,this.pivotX+t,this.pivotY+r)}get cmdID(){return RotateCmd.ID}}RotateCmd.ID="Rotate";class ScaleCmd{static create(e,t,r,i){var a=Pool.getItemByClass("ScaleCmd",ScaleCmd);return a.scaleX=e,a.scaleY=t,a.pivotX=r,a.pivotY=i,a}recover(){Pool.recover("ScaleCmd",this)}run(e,t,r){e._scale(this.scaleX,this.scaleY,this.pivotX+t,this.pivotY+r)}get cmdID(){return ScaleCmd.ID}}ScaleCmd.ID="Scale";class TransformCmd{static create(e,t,r){var i=Pool.getItemByClass("TransformCmd",TransformCmd);return i.matrix=e,i.pivotX=t,i.pivotY=r,i}recover(){this.matrix=null,Pool.recover("TransformCmd",this)}run(e,t,r){e._transform(this.matrix,this.pivotX+t,this.pivotY+r)}get cmdID(){return TransformCmd.ID}}TransformCmd.ID="Transform";class TranslateCmd{static create(e,t){var r=Pool.getItemByClass("TranslateCmd",TranslateCmd);return r.tx=e,r.ty=t,r}recover(){Pool.recover("TranslateCmd",this)}run(e,t,r){e.translate(this.tx,this.ty)}get cmdID(){return TranslateCmd.ID}}TranslateCmd.ID="Translate";class DrawTrianglesCmd{static create(e,t,r,i,a,s,n,o,l,h){var d=Pool.getItemByClass("DrawTrianglesCmd",DrawTrianglesCmd);return d.texture=e,d.x=t,d.y=r,d.vertices=i,d.uvs=a,d.indices=s,d.matrix=n,d.alpha=o,d.color=null!=l?ColorUtils.create(l).numColor:4294967295,d.blendMode=h,d}recover(){this.texture=null,this.vertices=null,this.uvs=null,this.indices=null,this.matrix=null,Pool.recover("DrawTrianglesCmd",this)}run(e,t,r){e.drawTriangles(this.texture,this.x+t,this.y+r,this.vertices,this.uvs,this.indices,this.matrix,this.alpha,this.blendMode,this.color)}get cmdID(){return DrawTrianglesCmd.ID}getBoundPoints(e){let t=this.vertices;var r=t.length;if(r<2)return[];for(var i=t[0],a=t[1],s=i,n=a,o=2;o<r;){var l=t[o++],h=t[o++];i>l&&(i=l),a>h&&(a=h),s<l&&(s=l),n<h&&(n=h)}return[i,a,s,a,s,n,i,n]}}DrawTrianglesCmd.ID="DrawTriangles",ClassUtils.regClass("DrawTrianglesCmd",DrawTrianglesCmd);class Draw9GridTextureCmd{constructor(){this.color=4294967295}static create(e,t,r,i,a,s,n=!1,o=null){let l=Pool.getItemByClass("Draw9GridTextureCmd",Draw9GridTextureCmd);return l.texture=e,e._addReference(),l.x=t,l.y=r,l.width=i,l.height=a,l.sizeGrid=s,l.percent=n,l.color=null!=o?ColorUtils.create(o).numColor:4294967295,l}recover(){this.texture._removeReference(),Pool.recover("Draw9GridTextureCmd",this)}run(e,t,r){if(this.texture){let i=this.sizeGrid||this.texture._sizeGrid||Me;if(this.percent&&e.sprite){let a=e.sprite.width,s=e.sprite.height;e.drawTextureWithSizeGrid(this.texture,this.x*a,this.y*s,this.width*a,this.height*s,i,t,r,this.color)}else e.drawTextureWithSizeGrid(this.texture,this.x,this.y,this.width,this.height,i,t,r,this.color)}}get cmdID(){return Draw9GridTextureCmd.ID}getBoundPoints(e){let t=this.x,r=this.y,i=this.width,a=this.height;return this.percent&&(t*=e.width,r*=e.height,i*=e.width,a*=e.height),[t,r,i,r,i,a,t,a]}}Draw9GridTextureCmd.ID="Draw9GridTexture";const Me=[0,0,0,0,0];ClassUtils.regClass("Draw9GridTextureCmd",Draw9GridTextureCmd);class SaveCmd{static create(){return Pool.getItemByClass("SaveCmd",SaveCmd)}recover(){Pool.recover("SaveCmd",this)}run(e,t,r){e.save()}get cmdID(){return SaveCmd.ID}}SaveCmd.ID="Save";const be=new Matrix,Ie=new Matrix,Le=[];class GraphicsBounds{constructor(){this._cacheBoundsType=!1}destroy(){this._graphics=null,this._cacheBoundsType=!1,this._temp&&(this._temp.length=0),this._rstBoundPoints&&(this._rstBoundPoints.length=0),this._bounds&&this._bounds.recover(),this._bounds=null,Pool.recover("GraphicsBounds",this)}static create(){return Pool.getItemByClass("GraphicsBounds",GraphicsBounds)}reset(){this._temp&&(this._temp.length=0)}getBounds(e=!1){return(!this._bounds||!this._temp||this._temp.length<1||e!=this._cacheBoundsType)&&(this._bounds=Rectangle._getWrapRec(this.getBoundPoints(e),this._bounds)),this._cacheBoundsType=e,this._bounds}getBoundPoints(e=!1){return(!this._temp||this._temp.length<1||e!=this._cacheBoundsType)&&(this._temp=this._getCmdPoints(e)),this._cacheBoundsType=e,this._rstBoundPoints=Utils.copyArray(this._rstBoundPoints,this._temp)}_getCmdPoints(e=!1){let t=this._graphics.cmds,r=this._graphics._sp;this._affectBySize=!1;let i=this._temp||(this._temp=[]);if(i.length=0,0==t.length)return i;let a=Le;a.length=0;let s=Ie;s.identity();let n=be;for(let e=0,o=t.length;e<o;e++){let o=t[e];switch(o.percent&&(this._affectBySize=!0),o.cmdID){case AlphaCmd.ID:case SaveCmd.ID:a.push(s),s=s.clone();break;case RestoreCmd.ID:s=a.pop();break;case ScaleCmd.ID:n.identity(),n.translate(-o.pivotX,-o.pivotY),n.scale(o.scaleX,o.scaleY),n.translate(o.pivotX,o.pivotY),this._switchMatrix(s,n);break;case RotateCmd.ID:n.identity(),n.translate(-o.pivotX,-o.pivotY),n.rotate(o.angle),n.translate(o.pivotX,o.pivotY),this._switchMatrix(s,n);break;case TranslateCmd.ID:n.identity(),n.translate(o.tx,o.ty),this._switchMatrix(s,n);break;case TransformCmd.ID:n.identity(),n.translate(-o.pivotX,-o.pivotY),n.concat(o.matrix),n.translate(o.pivotX,o.pivotY),this._switchMatrix(s,n);break;case DrawImageCmd.ID:case FillTextureCmd.ID:addPointArrToRst(i,Rectangle._getBoundPointS(o.x,o.y,o.width,o.height),s);break;case DrawTextureCmd.ID:s.copyTo(n),o.matrix&&n.concat(o.matrix),addPointArrToRst(i,Rectangle._getBoundPointS(o.x,o.y,o.width,o.height),n);break;case DrawRectCmd.ID:case DrawCircleCmd.ID:case DrawLineCmd.ID:addPointArrToRst(i,o.getBoundPoints(r),s);break;case DrawCurvesCmd.ID:addPointArrToRst(i,o.getBoundPoints(r),s,o.x,o.y);break;case DrawLinesCmd.ID:case DrawPolyCmd.ID:addPointArrToRst(i,o.points,s,o.x,o.y);break;case DrawPathCmd.ID:addPointArrToRst(i,o.getBoundPoints(r),s,o.x,o.y);break;case DrawPieCmd.ID:case DrawTrianglesCmd.ID:case Draw9GridTextureCmd.ID:addPointArrToRst(i,o.getBoundPoints(r),s)}}return i.length>200?i=Utils.copyArray(i,Rectangle._getWrapRec(i)._getBoundPoints()):i.length>8&&(i=GrahamScan.scanPList(i)),i}_switchMatrix(e,t){t.concat(e),t.copyTo(e)}}function addPointArrToRst(e,t,r,i=0,a=0){let s=t.length;for(let n=0;n<s;n+=2)addPointToRst(e,t[n]+i,t[n+1]+a,r)}function addPointToRst(e,t,r,i){var a=Point.TEMP;a.setTo(t||0,r||0),i.transformPoint(a),e.push(a.x,a.y)}class ClipRectCmd{static create(e,t,r,i){var a=Pool.getItemByClass("ClipRectCmd",ClipRectCmd);return a.x=e,a.y=t,a.width=r,a.height=i,a}recover(){Pool.recover("ClipRectCmd",this)}run(e,t,r){e.clipRect(this.x+t,this.y+r,this.width,this.height)}get cmdID(){return ClipRectCmd.ID}}ClipRectCmd.ID="ClipRect";class DrawTexturesCmd{static create(e,t,r){var i=Pool.getItemByClass("DrawTexturesCmd",DrawTexturesCmd);return i.texture=e,e._addReference(),i.pos=t,i.colors=r||[],i}recover(){this.texture._removeReference(),this.texture=null,this.pos=null,Pool.recover("DrawTexturesCmd",this)}run(e,t,r){e.drawTextures(this.texture,this.pos,t,r,this.colors)}get cmdID(){return DrawTexturesCmd.ID}}DrawTexturesCmd.ID="DrawTextures";class FillTextCmd{constructor(){this.x=0,this.y=0,this._strokeColor="#000000"}set text(e){this._text=e}get text(){return this._text}set strokeColor(e){this._strokeColor=e}get strokeColor(){return this._strokeColor}set stroke(e){this._stroke=e}get stroke(){return this._stroke}set align(e){this._align=e}get align(){return this._align}static create(e,t,r,i,a,s,n,o){var l=Pool.getItemByClass("FillTextCmd",FillTextCmd);switch(l._text=null,l._wordText=null,l.x=t,l.y=r,l.font=i,l.color=a,l._stroke=n,l._strokeColor=o,s){case"center":l._align=Const.ENUM_TEXTALIGN_CENTER;break;case"right":l._align=Const.ENUM_TEXTALIGN_RIGHT;break;default:l._align=Const.ENUM_TEXTALIGN_DEFAULT}return e instanceof WordText?(l._wordText=e,e.cleanCache()):l._text=e,l}recover(){Pool.recover("FillTextCmd",this)}run(e,t,r){ILaya.stage.isGlobalRepaint()&&this._wordText&&this._wordText.cleanCache(),null==this._text&&(this._text=""),null==this._fontObj&&(this.font=null),null==this._color&&(this._color="#ffffff"),e._fast_filltext(this._wordText||this._text,this.x+t,this.y+r,this._fontObj,this._color,this._strokeColor,this._stroke,this._align)}get cmdID(){return FillTextCmd.ID}get font(){return this._font}set font(e){this._font=e,e||(e=Config.defaultFontSize+"px "+Config.defaultFont),this._fontObj=FontInfo.parse(e),this._wordText&&this._wordText.cleanCache()}get color(){return this._color}set color(e){this._color=e,this._wordText&&this._wordText.cleanCache()}}FillTextCmd.ID="FillText",ClassUtils.regClass("FillTextCmd",FillTextCmd);class CacheManger{constructor(){}static regCacheByFunction(e,t){var r;CacheManger.unRegCacheByFunction(e,t),r={tryDispose:e,getCacheList:t},CacheManger._cacheList.push(r)}static unRegCacheByFunction(e,t){var r,i;for(i=CacheManger._cacheList.length,r=0;r<i;r++)if(CacheManger._cacheList[r].tryDispose==e&&CacheManger._cacheList[r].getCacheList==t)return void CacheManger._cacheList.splice(r,1)}static forceDispose(){var e,t=CacheManger._cacheList.length;for(e=0;e<t;e++)CacheManger._cacheList[e].tryDispose(!0)}static beginCheck(e=15e3){ILaya.systemTimer.loop(e,null,CacheManger._checkLoop)}static stopCheck(){ILaya.systemTimer.clear(null,CacheManger._checkLoop)}static _checkLoop(){var e=CacheManger._cacheList;if(!(e.length<1)){var t,r,i=ILaya.Browser.now();for(r=t=e.length;t>0&&(CacheManger._index++,CacheManger._index=CacheManger._index%r,e[CacheManger._index].tryDispose(!1),!(ILaya.Browser.now()-i>CacheManger.loopTimeLimit));)t--}}}CacheManger.loopTimeLimit=2,CacheManger._cacheList=[],CacheManger._index=0;class VectorGraphManager{constructor(){this.useDic={},this.shapeDic={},this.shapeLineDic={},this._id=0,this._checkKey=!1,this._freeIdArray=[],CacheManger.regCacheByFunction(this.startDispose.bind(this),this.getCacheList.bind(this))}static getInstance(){return VectorGraphManager.instance=VectorGraphManager.instance||new VectorGraphManager}getId(){return this._id++}addShape(e,t){this.shapeDic[e]=t,this.useDic[e]||(this.useDic[e]=!0)}addLine(e,t){this.shapeLineDic[e]=t,this.shapeLineDic[e]||(this.shapeLineDic[e]=!0)}getShape(e){this._checkKey&&null!=this.useDic[e]&&(this.useDic[e]=!0)}deleteShape(e){this.shapeDic[e]&&(this.shapeDic[e]=null,delete this.shapeDic[e]),this.shapeLineDic[e]&&(this.shapeLineDic[e]=null,delete this.shapeLineDic[e]),null!=this.useDic[e]&&delete this.useDic[e]}getCacheList(){var e,t=[];for(e in this.shapeDic)t.push(this.shapeDic[e]);for(e in this.shapeLineDic)t.push(this.shapeLineDic[e]);return t}startDispose(e){var t;for(t in this.useDic)this.useDic[t]=!1;this._checkKey=!0}endDispose(){if(this._checkKey){var e;for(e in this.useDic)this.useDic[e]||this.deleteShape(e);this._checkKey=!1}}}class DrawEllipseCmd{constructor(){this.lineWidth=0}static create(e,t,r,i,a,s,n,o){var l=Pool.getItemByClass("DrawEllipseCmd",DrawEllipseCmd);return l.x=e,l.y=t,l.width=r,l.height=i,l.fillColor=a,l.lineColor=s,l.lineWidth=n,l.percent=o,l}recover(){this.fillColor=null,this.lineColor=null,Pool.recover("DrawEllipseCmd",this)}run(e,t,r){let i=this.lineWidth>=1&&this.lineColor?this.lineWidth/2:0;if(this.percent&&e.sprite){let a=e.sprite.width,s=e.sprite.height;e._drawEllipse(this.x*a+t,this.y*s+r,this.width*a-i,this.height*s-i,this.fillColor,this.lineColor,this.lineWidth)}else e._drawEllipse(this.x+t,this.y+r,this.width-i,this.height-i,this.fillColor,this.lineColor,this.lineWidth)}get cmdID(){return DrawEllipseCmd.ID}getBoundPoints(e){return Rectangle._getBoundPointS(this.x-this.width,this.y-this.height,2*this.width,2*this.height,this.percent?e:null)}}DrawEllipseCmd.ID="DrawEllipse",ClassUtils.regClass("DrawEllipseCmd",DrawEllipseCmd);class DrawRoundRectCmd{constructor(){this.lineWidth=0}static create(e,t,r,i,a,s,n,o,l,h,d,u){var c=Pool.getItemByClass("DrawRoundRectCmd",DrawRoundRectCmd);return c.x=e,c.y=t,c.width=r,c.height=i,c.lt=a,c.rt=s,c.lb=n,c.rb=o,c.fillColor=l,c.lineColor=h,c.lineWidth=d,c.percent=u,c}recover(){this.fillColor=null,this.lineColor=null,Pool.recover("DrawRoundRectCmd",this)}run(e,t,r){let i=this.lineWidth>=1&&this.lineColor?this.lineWidth/2:0,a=this.lineColor?this.lineWidth:0;if(this.percent&&e.sprite){let s=e.sprite.width,n=e.sprite.height;e._drawRoundRect(this.x*s+i+t,this.y*n+i+r,this.width*s-a,this.height*n-a,this.lt,this.rt,this.lb,this.rb,this.fillColor,this.lineColor,this.lineWidth)}else e._drawRoundRect(this.x+i+t,this.y+i+r,this.width-a,this.height-a,this.lt,this.rt,this.lb,this.rb,this.fillColor,this.lineColor,this.lineWidth)}get cmdID(){return DrawRoundRectCmd.ID}getBoundPoints(e){return Rectangle._getBoundPointS(this.x,this.y,this.width,this.height,this.percent?e:null)}}DrawRoundRectCmd.ID="DrawRoundRect",ClassUtils.regClass("DrawRoundRectCmd",DrawRoundRectCmd);class DrawGeoCmd{static create(e,t){var r=Pool.getItemByClass("DrawGeoCmd"+t.id,DrawGeoCmd);return r.init(e,t),r}static creatGEO(t,r,i,a,s){let n=LayaGL.renderDeviceFactory.createRenderGeometryElement(e.MeshTopology.Triangles,e.DrawType.DrawElement),o=LayaGL.renderDeviceFactory.createBufferState();n.bufferState=o;let l=LayaGL.renderDeviceFactory.createVertexBuffer(e.BufferUsage.Dynamic);l.vertexDeclaration=t;let h=LayaGL.renderDeviceFactory.createIndexBuffer(e.BufferUsage.Dynamic);return o.applyState([l],h),n.indexFormat=e.IndexFormat.UInt16,l.setDataLength(i),l.setData(r.buffer,0,0,i),h._setIndexDataLength(s),h._setIndexData(new Uint16Array(a.buffer,0,s/2),0),n.clearRenderParams(),n.setDrawElemenParams(s/2,0),n}init(e,t){this.material=t,this.geo=e}recover(){Pool.recover("DrawGeoCmd"+this.material.id,this)}run(e,t,r){e.drawGeo(this.geo,this.material,t,r)}get cmdID(){return DrawGeoCmd.ID}}DrawGeoCmd.ID="DrawGeoCmd";class DrawGeosCmd{static create(e,t){var r=Pool.getItemByClass("DrawGeosCmd",DrawGeosCmd);return r.init(e,t),r}init(e,t){this.elements=t,this.geo=e}recover(){Pool.recover("DrawGeosCmd",this)}run(e,t,r){e.drawGeos(this.geo,this.elements,t,r)}get cmdID(){return DrawGeosCmd.ID}}DrawGeosCmd.ID="DrawGeoCmd";class Graphics{constructor(){this._sp=null,this._render=this._renderEmpty,this._cmds=[],this._vectorgraphArray=null,this._graphicBounds=null,this._createData()}static add2DGlobalUniformData(e,t,r){LayaGL.renderDeviceFactory.createGlobalUniformMap("Sprite2DGlobal").addShaderUniform(e,t,r)}static get globalShaderData(){return Value2D.globalShaderData}_createData(){}_clearData(){}_destroyData(){}destroy(){this.clear(!0),this._graphicBounds&&this._graphicBounds.destroy(),this._graphicBounds=null,this._vectorgraphArray=null,this._sp&&(this._sp._renderType=0,this._sp=null),this._destroyData()}clear(e=!0){if(e)for(let e=0,t=this._cmds.length;e<t;e++)this._cmds[e].recover();if(this._cmds.length=0,this._render=this._renderEmpty,this._clearData(),this._sp&&(this._sp._renderType&=~SpriteConst.GRAPHICS),this._repaint(),this._vectorgraphArray){for(let e=0,t=this._vectorgraphArray.length;e<t;e++)VectorGraphManager.getInstance().deleteShape(this._vectorgraphArray[e]);this._vectorgraphArray.length=0}}_clearBoundsCache(e){this._graphicBounds&&(e&&!this._graphicBounds._affectBySize||this._graphicBounds.reset())}_initGraphicBounds(){this._graphicBounds||(this._graphicBounds=GraphicsBounds.create(),this._graphicBounds._graphics=this)}_repaint(){this._clearBoundsCache(),this._sp&&this._sp.repaint()}_isOnlyOne(){return 1===this._cmds.length}get cmds(){return this._cmds}set cmds(e){this._sp&&(this._sp._renderType|=SpriteConst.GRAPHICS),this._cmds=e;let t=e.length;this._render=0===t?this._renderEmpty:1===t?this._renderOne:this._renderAll,this._repaint()}addCmd(e){if(null!=e)return this._sp&&(this._sp._renderType|=SpriteConst.GRAPHICS),this._cmds.push(e),this._render=1===this._cmds.length?this._renderOne:this._renderAll,this._repaint(),e;console.warn("null cmd")}removeCmd(e){let t=this.cmds.indexOf(e);if(-1!=t){this._cmds.splice(t,1);let e=this._cmds.length;this._render=0===e?this._renderEmpty:1===e?this._renderOne:this._renderAll,this._repaint()}}getBounds(e=!1){return this._initGraphicBounds(),this._graphicBounds.getBounds(e)}getBoundPoints(e=!1){return this._initGraphicBounds(),this._graphicBounds.getBoundPoints(e)}get material(){return this._material}set material(e){this._material!=e&&(this._material&&this._material._removeReference(),this._material=e,null!=e&&e._addReference())}drawImage(e,t=0,r=0,i=null,a=null,s=null){return e&&e.bitmap?this.addCmd(DrawImageCmd.create(e,t,r,i,a,s)):null}drawTexture(e,t=0,r=0,i=null,a=null,s=null,n=1,o=null,l=null,h){return!e||n<.01?null:e.bitmap?this.addCmd(DrawTextureCmd.create(e,t,r,i,a,s,n,o,l,h)):null}drawTextures(e,t,r){return e?this.addCmd(DrawTexturesCmd.create(e,t,r)):null}drawGeo(e,t){return this.addCmd(DrawGeoCmd.create(e,t))}drawGeos(e,t){return this.addCmd(DrawGeosCmd.create(e,t))}drawTriangles(e,t,r,i,a,s,n=null,o=1,l=null,h=null){return this.addCmd(DrawTrianglesCmd.create(e,t,r,i,a,s,n,o,l,h))}fillTexture(e,t,r,i=0,a=0,s="repeat",n=null,o=null){return e&&e.bitmap?this.addCmd(FillTextureCmd.create(e,t,r,i,a,s,n||Point.EMPTY,o)):null}clipRect(e,t,r,i){return this.addCmd(ClipRectCmd.create(e,t,r,i))}fillText(e,t,r,i,a,s){return this.addCmd(FillTextCmd.create(e,t,r,i,a,s,0,""))}fillBorderText(e,t,r,i,a,s,n,o){return this.addCmd(FillTextCmd.create(e,t,r,i,a,s,n,o))}strokeText(e,t,r,i,a,s,n){return this.addCmd(FillTextCmd.create(e,t,r,i,null,n,s,a))}alpha(e){return this.addCmd(AlphaCmd.create(e))}transform(e,t=0,r=0){return this.addCmd(TransformCmd.create(e,t,r))}rotate(e,t=0,r=0){return this.addCmd(RotateCmd.create(e,t,r))}scale(e,t,r=0,i=0){return this.addCmd(ScaleCmd.create(e,t,r,i))}translate(e,t){return this.addCmd(TranslateCmd.create(e,t))}save(){return this.addCmd(SaveCmd.create())}restore(){return this.addCmd(RestoreCmd.create())}replaceTextColor(e){this._repaint();let t=this._cmds;for(let r=t.length-1;r>-1;r--){let i=t[r];switch(i.cmdID){case FillTextCmd.ID:i.color=e;break;case DrawImageCmd.ID:i.color=null!=e?ColorUtils.create(e).numColor:4294967295}}}loadImage(e,t=0,r=0,i=null,a=null,s=null){let n=ILaya.loader.getRes(e);n?(this.drawImage(n,t,r,i,a),s&&s.call(this._sp)):ILaya.loader.load(e).then((e=>{this.drawImage(e,t,r,i,a),s&&s.call(this._sp)}))}_renderEmpty(e,t,r,i){}_renderAll(e,t,r,i){t.sprite=e,t.material=this._material;var a=this._cmds;for(let e=0,s=a.length;e<s;e++)a[e].run(t,r,i);t.material=null}_renderOne(e,t,r,i){t.sprite=e,t.material=this._material,this._cmds[0].run(t,r,i),t.material=null}drawLine(e,t,r,i,a,s=1){return this.addCmd(DrawLineCmd.create(e,t,r,i,a,s))}drawLines(e,t,r,i,a=1){return!r||r.length<4?null:this.addCmd(DrawLinesCmd.create(e,t,r,i,a))}drawCurves(e,t,r,i,a=1){return this.addCmd(DrawCurvesCmd.create(e,t,r,i,a))}drawRect(e,t,r,i,a,s=null,n=1,o){return this.addCmd(DrawRectCmd.create(e,t,r,i,a,s,n,o))}drawRoundRect(e,t,r,i,a,s,n,o,l,h=null,d=1,u){return this.addCmd(DrawRoundRectCmd.create(e,t,r,i,a,s,n,o,l,h,d,u))}drawCircle(e,t,r,i,a=null,s=1){return this.addCmd(DrawCircleCmd.create(e,t,r,i,a,s))}drawEllipse(e,t,r,i,a,s,n,o){return this.addCmd(DrawEllipseCmd.create(e,t,r,i,a,s,n,o))}drawPie(e,t,r,i,a,s,n=null,o=1){return this.addCmd(DrawPieCmd.create(e,t,r,Utils.toRadian(i),Utils.toRadian(a),s,n,o))}drawPoly(e,t,r,i,a=null,s=1){return this.addCmd(DrawPolyCmd.create(e,t,r,i,a,s))}drawPath(e,t,r,i=null,a=null){return this.addCmd(DrawPathCmd.create(e,t,r,i,a))}draw9Grid(e,t=0,r=0,i=0,a=0,s,n){this.addCmd(Draw9GridTextureCmd.create(e,t,r,i,a,s,!1,n))}}const Ae=[];class Node extends EventDispatcher{constructor(){super(),this._bits=0,this._hideFlags=0,this._children=Ae,this._parent=null,this._destroyed=!1,this.name="",this._initialize()}get url(){return this._url}set url(e){this._url=e}get hideFlags(){return this._hideFlags}set hideFlags(e){this._hideFlags=e}get is3D(){return this._is3D}get destroyed(){return this._destroyed}_initialize(){this._extra={}}_setBit(e,t){e===NodeFlags.DISPLAY&&(this._getBit(e)!=t&&this._updateDisplayedInstage());t?this._bits|=e:this._bits&=~e}_getBit(e){return 0!=(this._bits&e)}_setUpNoticeChain(){this._getBit(NodeFlags.DISPLAY)&&this._setBitUp(NodeFlags.DISPLAY)}_setBitUp(e){var t=this;for(t._setBit(e,!0),t=t._parent;t;){if(t._getBit(e))return;t._setBit(e,!0),t=t._parent}}onStartListeningToType(e){e!==Event.DISPLAY&&e!==Event.UNDISPLAY||this._getBit(NodeFlags.DISPLAY)||this._setBitUp(NodeFlags.DISPLAY)}bubbleEvent(e,t){let r=Be.length>0?Be.pop():[];r.length=0;let i=this;for(;i;)i.activeInHierarchy&&r.push(i),i=i.parent;if(t instanceof Event){t._stopped=!1;for(let i of r)if(t.setTo(e,i,this),i.event(e,t),t._stopped)break}else for(let i of r)i.event(e,t);Be.push(r)}hasHideFlag(e){return 0!=(this._hideFlags&e)}destroy(e=!0){this._destroyed=!0,this.destroyAllComponent(),this._parent&&this._parent.removeChild(this),this._children&&(e?this.destroyChildren():this.removeChildren()),this.onDestroy(),this._children=null,this.offAll()}onDestroy(){}destroyChildren(){if(this._children)for(let e=0,t=this._children.length;e<t;e++)this._children[0]&&this._children[0].destroy(!0)}addChild(e){if(!e||this._destroyed||e===this)return e;if(e._zOrder&&this._setBit(NodeFlags.HAS_ZORDER,!0),e._parent===this){var t=this.getChildIndex(e);t!==this._children.length-1&&(this._children.splice(t,1),this._children.push(e),this._childChanged())}else e._parent&&e._parent.removeChild(e),this._children===Ae&&(this._children=[]),this._children.push(e),e._setParent(this);return e}addChildren(...e){for(var t=0,r=e.length;t<r;)this.addChild(e[t++])}addChildAt(e,t){if(!e||this._destroyed||e===this)return e;if(e._zOrder&&this._setBit(NodeFlags.HAS_ZORDER,!0),t>=0&&t<=this._children.length){if(e._parent===this){var r=this.getChildIndex(e);this._children.splice(r,1),this._children.splice(t,0,e),this._childChanged()}else e._parent&&e._parent.removeChild(e),this._children===Ae&&(this._children=[]),this._children.splice(t,0,e),e._setParent(this);return e}throw new Error("appendChildAt:The index is out of bounds")}getChildIndex(e){return this._children.indexOf(e)}getChildByName(e){for(let t of this._children)if(t&&t.name===e)return t;return null}getChildAt(e){return this._children[e]||null}setChildIndex(e,t){var r=this._children;if(t<0||t>=r.length)throw new Error("setChildIndex:The index is out of bounds.");var i=this.getChildIndex(e);if(i<0)throw new Error("setChildIndex:node is must child of this object.");return r.splice(i,1),r.splice(t,0,e),this._childChanged(),e}_childChanged(e=null){}removeChild(e){if(!this._children)return e;var t=this._children.indexOf(e);return this.removeChildAt(t)}removeSelf(){return this._parent&&this._parent.removeChild(this),this}removeChildByName(e){var t=this.getChildByName(e);return t&&this.removeChild(t),t}removeChildAt(e){var t=this.getChildAt(e);return t&&(this._children.splice(e,1),t._setParent(null)),t}removeChildren(e=0,t=2147483647){if(this._children&&this._children.length>0){var r=this._children;if(0===e&&t>=r.length-1){var i=r;this._children=Ae}else i=r.splice(e,t-e+1);for(var a=0,s=i.length;a<s;a++)i[a]._setParent(null)}return this}replaceChild(e,t){var r=this._children.indexOf(t);return r>-1?(this._children.splice(r,1,e),t._setParent(null),e._setParent(this),e):null}get numChildren(){return this._children?this._children.length:0}get parent(){return this._parent}isAncestorOf(e){let t=e.parent;for(;t;){if(t==this)return!0;t=t.parent}return!1}_setParent(e){if(this._parent!==e)if(e)this._parent=e,this._onAdded(),this.event(Event.ADDED),this._getBit(NodeFlags.DISPLAY)&&(this._setUpNoticeChain(),e.displayedInStage&&this._displayChild(this,!0)),e._childChanged(this);else{this._onRemoved(),this.event(Event.REMOVED);let t=this._parent;this._getBit(NodeFlags.DISPLAY)&&this._displayChild(this,!1),this._parent=e,t._childChanged(this)}}get displayedInStage(){return this._getBit(NodeFlags.DISPLAY)||this._setBitUp(NodeFlags.DISPLAY),this._getBit(NodeFlags.DISPLAYED_INSTAGE)}_updateDisplayedInstage(){var e;e=this;for(var t=ILaya.stage,r=!1;e;){if(e._getBit(NodeFlags.DISPLAY)){r=e._getBit(NodeFlags.DISPLAYED_INSTAGE);break}if(e===t||e._getBit(NodeFlags.DISPLAYED_INSTAGE)){r=!0;break}e=e._parent}this._setBit(NodeFlags.DISPLAYED_INSTAGE,r)}_setDisplay(e){this._getBit(NodeFlags.DISPLAYED_INSTAGE)!==e&&(this._setBit(NodeFlags.DISPLAYED_INSTAGE,e),e?this.event(Event.DISPLAY):this.event(Event.UNDISPLAY))}_displayChild(e,t){var r=e._children;if(r)for(var i=0,a=r.length;i<a;i++){var s=r[i];s&&(s._getBit(NodeFlags.DISPLAY)&&(s._children.length>0?this._displayChild(s,t):s._setDisplay(t)))}e._setDisplay(t)}contains(e){if(e===this)return!0;for(;e;){if(e._parent===this)return!0;e=e._parent}return!1}timerLoop(e,t,r,i=null,a=!0,s=!1){this.timer.loop(e,t,r,i,a,s)}timerOnce(e,t,r,i=null,a=!0){this.timer._create(!1,!1,e,t,r,i,a)}frameLoop(e,t,r,i=null,a=!0){this.timer._create(!0,!0,e,t,r,i,a)}frameOnce(e,t,r,i=null,a=!0){this.timer._create(!0,!1,e,t,r,i,a)}clearTimer(e,t){this.timer.clear(e,t)}callLater(e,t=null){this.timer.callLater(this,e,t)}runCallLater(e){this.timer.runCallLater(this,e)}get scene(){return this._scene}get active(){return!this._getBit(NodeFlags.NOT_READY)&&!this._getBit(NodeFlags.NOT_ACTIVE)}set active(e){if(e=!!e,!this._getBit(NodeFlags.NOT_ACTIVE)!==e){if(this._activeChangeScripts&&0!==this._activeChangeScripts.length)throw e?"Node: can't set the main inActive node active in hierarchy,if the operate is in main inActive node or it's children script's onDisable Event.":"Node: can't set the main active node inActive in hierarchy,if the operate is in main active node or it's children script's onEnable Event.";this._setBit(NodeFlags.NOT_ACTIVE,!e),this._parent&&this._parent.activeInHierarchy&&this._processActive(e,!0)}}get activeInHierarchy(){return this._getBit(NodeFlags.ACTIVE_INHIERARCHY)}_onActive(){Stat.spriteCount++}_onInActive(){Stat.spriteCount--}_onActiveInScene(){this.event(Node.EVENT_SET_ACTIVESCENE,this._scene)}_onInActiveInScene(){this.event(Node.EVENT_SET_IN_ACTIVESCENE,this._scene)}onAwake(){}onEnable(){}onDisable(){}_parse(e,t){}_setBelongScene(e){if(!this._scene||this.scene!=e){this._scene=e,this._onActiveInScene();for(let t=0,r=this._children.length;t<r;t++)this._children[t]._setBelongScene(e)}}_setUnBelongScene(){if(this._scene!==this){this._onInActiveInScene(),this._scene=null;for(let e=0,t=this._children.length;e<t;e++)this._children[e]._setUnBelongScene()}}_processActive(e,t){this._activeChangeScripts||(this._activeChangeScripts=[]);let r=this._activeChangeScripts;e?this._activeHierarchy(r,t):this._inActiveHierarchy(r,t);for(let t=0,i=r.length;t<i;t++){let i=r[t];i.owner&&i._setActive(e)}r.length=0}_activeHierarchy(e,t){if(this._setBit(NodeFlags.ACTIVE_INHIERARCHY,!0),this._components)for(let t=0,r=this._components.length;t<r;t++){let r=this._components[t];r._isScript()?r._enabled&&e.push(r):r._setActive(!0)}this._onActive();for(let r=0,i=this._children.length;r<i;r++){let i=this._children[r];!i._getBit(NodeFlags.NOT_ACTIVE)&&!i._getBit(NodeFlags.NOT_READY)&&i._activeHierarchy(e,t)}this._getBit(NodeFlags.AWAKED)||(this._setBit(NodeFlags.AWAKED,!0),this.onAwake()),this.onEnable()}_inActiveHierarchy(e,t){if(this._onInActive(),this._components)for(let t=0,r=this._components.length;t<r;t++){let r=this._components[t];r._isScript()?r._enabled&&e.push(r):r._setActive(!1)}this._setBit(NodeFlags.ACTIVE_INHIERARCHY,!1);for(let r=0,i=this._children.length;r<i;r++){let i=this._children[r];i&&!i._getBit(NodeFlags.NOT_ACTIVE)&&i._inActiveHierarchy(e,t)}this.onDisable()}_onAdded(){if(this._activeChangeScripts&&0!==this._activeChangeScripts.length)throw"Node: can't set the main inActive node active in hierarchy,if the operate is in main inActive node or it's children script's onDisable Event.";{let e=this._parent.scene;e&&this._setBelongScene(e),this._parent.activeInHierarchy&&this.active&&this._processActive(!0)}}_onRemoved(){if(this._activeChangeScripts&&0!==this._activeChangeScripts.length)throw"Node: can't set the main active node inActive in hierarchy,if the operate is in main active node or it's children script's onEnable Event.";this._parent.activeInHierarchy&&this.active&&this._processActive(!1),this._parent.scene&&this._setUnBelongScene()}_addComponentInstance(e){var t;this._components||(this._components=[]),this._components.push(e),e._setOwner(this),this.activeInHierarchy&&e._setActive(!0),null===(t=this._componentsChanged)||void 0===t||t.call(this,e,0)}_destroyComponent(e){var t;if(!this._components)return;let r=this._components.indexOf(e);-1!=r&&(this._components.splice(r,1),e._destroy(),null===(t=this._componentsChanged)||void 0===t||t.call(this,e,1))}destroyAllComponent(){var e;if(this._components){for(let e=0,t=this._components.length;e<t;e++){let t=this._components[e];t&&!t.destroyed&&t._destroy()}this._components.length=0,null===(e=this._componentsChanged)||void 0===e||e.call(this,null,2)}}_cloneTo(e,t,r){var i=e;if(this._components)for(let e=0,t=this._components.length;e<t;e++){var a=i.addComponent(this._components[e].constructor);this._components[e]._cloneTo(a)}}addComponentInstance(e){if(e.owner)throw"Node:the component has belong to other node.";return e._singleton&&this.getComponent(e.constructor)?console.warn("Node:the component is singleton, can't add the second one.",e):this._addComponentInstance(e),e}addComponent(e){let t=Pool.createByClass(e);if(!t)throw"missing "+e.toString();return t._singleton&&this.getComponent(e)?console.warn("Node:the component is singleton, can't add the second one.",t):this._addComponentInstance(t),t}getComponent(e){if(this._components)for(let t=0,r=this._components.length;t<r;t++){let r=this._components[t];if(r instanceof e)return r}return null}get components(){return this._components||Ae}getComponents(e){var t;if(this._components)for(let r=0,i=this._components.length;r<i;r++){let i=this._components[r];i instanceof e&&(t=t||[]).push(i)}return t}get timer(){return this._scene?this._scene.timer:ILaya.timer}onAfterDeserialize(){}}Node.EVENT_SET_ACTIVESCENE="ActiveScene",Node.EVENT_SET_IN_ACTIVESCENE="InActiveScene";const Be=[],Pe=.5*Math.PI,Ne=2*Math.PI;class Ease{static linearNone(e,t,r,i){return r*e/i+t}static linearIn(e,t,r,i){return r*e/i+t}static linearInOut(e,t,r,i){return r*e/i+t}static linearOut(e,t,r,i){return r*e/i+t}static bounceIn(e,t,r,i){return r-Ease.bounceOut(i-e,0,r,i)+t}static bounceInOut(e,t,r,i){return e<.5*i?.5*Ease.bounceIn(2*e,0,r,i)+t:.5*Ease.bounceOut(2*e-i,0,r,i)+.5*r+t}static bounceOut(e,t,r,i){return(e/=i)<1/2.75?r*(7.5625*e*e)+t:e<2/2.75?r*(7.5625*(e-=1.5/2.75)*e+.75)+t:e<2.5/2.75?r*(7.5625*(e-=2.25/2.75)*e+.9375)+t:r*(7.5625*(e-=2.625/2.75)*e+.984375)+t}static backIn(e,t,r,i,a=1.70158){return r*(e/=i)*e*((a+1)*e-a)+t}static backInOut(e,t,r,i,a=1.70158){return(e/=.5*i)<1?.5*r*(e*e*((1+(a*=1.525))*e-a))+t:r/2*((e-=2)*e*((1+(a*=1.525))*e+a)+2)+t}static backOut(e,t,r,i,a=1.70158){return r*((e=e/i-1)*e*((a+1)*e+a)+1)+t}static elasticIn(e,t,r,i,a=0,s=0){var n;return 0==e?t:1==(e/=i)?t+r:(s||(s=.3*i),!a||r>0&&a<r||r<0&&a<-r?(a=r,n=s/4):n=s/Ne*Math.asin(r/a),-a*Math.pow(2,10*(e-=1))*Math.sin((e*i-n)*Ne/s)+t)}static elasticInOut(e,t,r,i,a=0,s=0){var n;return 0==e?t:2==(e/=.5*i)?t+r:(s||(s=i*(.3*1.5)),!a||r>0&&a<r||r<0&&a<-r?(a=r,n=s/4):n=s/Ne*Math.asin(r/a),e<1?a*Math.pow(2,10*(e-=1))*Math.sin((e*i-n)*Ne/s)*-.5+t:a*Math.pow(2,-10*(e-=1))*Math.sin((e*i-n)*Ne/s)*.5+r+t)}static elasticOut(e,t,r,i,a=0,s=0){var n;return 0==e?t:1==(e/=i)?t+r:(s||(s=.3*i),!a||r>0&&a<r||r<0&&a<-r?(a=r,n=s/4):n=s/Ne*Math.asin(r/a),a*Math.pow(2,-10*e)*Math.sin((e*i-n)*Ne/s)+r+t)}static strongIn(e,t,r,i){return r*(e/=i)*e*e*e*e+t}static strongInOut(e,t,r,i){return(e/=.5*i)<1?.5*r*e*e*e*e*e+t:.5*r*((e-=2)*e*e*e*e+2)+t}static strongOut(e,t,r,i){return r*((e=e/i-1)*e*e*e*e+1)+t}static sineInOut(e,t,r,i){return.5*-r*(Math.cos(Math.PI*e/i)-1)+t}static sineIn(e,t,r,i){return-r*Math.cos(e/i*Pe)+r+t}static sineOut(e,t,r,i){return r*Math.sin(e/i*Pe)+t}static quintIn(e,t,r,i){return r*(e/=i)*e*e*e*e+t}static quintInOut(e,t,r,i){return(e/=.5*i)<1?.5*r*e*e*e*e*e+t:.5*r*((e-=2)*e*e*e*e+2)+t}static quintOut(e,t,r,i){return r*((e=e/i-1)*e*e*e*e+1)+t}static quartIn(e,t,r,i){return r*(e/=i)*e*e*e+t}static quartInOut(e,t,r,i){return(e/=.5*i)<1?.5*r*e*e*e*e+t:.5*-r*((e-=2)*e*e*e-2)+t}static quartOut(e,t,r,i){return-r*((e=e/i-1)*e*e*e-1)+t}static cubicIn(e,t,r,i){return r*(e/=i)*e*e+t}static cubicInOut(e,t,r,i){return(e/=.5*i)<1?.5*r*e*e*e+t:.5*r*((e-=2)*e*e+2)+t}static cubicOut(e,t,r,i){return r*((e=e/i-1)*e*e+1)+t}static quadIn(e,t,r,i){return r*(e/=i)*e+t}static quadInOut(e,t,r,i){return(e/=.5*i)<1?.5*r*e*e+t:.5*-r*(--e*(e-2)-1)+t}static quadOut(e,t,r,i){return-r*(e/=i)*(e-2)+t}static expoIn(e,t,r,i){return 0==e?t:r*Math.pow(2,10*(e/i-1))+t-.001*r}static expoInOut(e,t,r,i){return 0==e?t:e==i?t+r:(e/=.5*i)<1?.5*r*Math.pow(2,10*(e-1))+t:.5*r*(2-Math.pow(2,-10*--e))+t}static expoOut(e,t,r,i){return e==i?t+r:r*(1-Math.pow(2,-10*e/i))+t}static circIn(e,t,r,i){return-r*(Math.sqrt(1-(e/=i)*e)-1)+t}static circInOut(e,t,r,i){return(e/=.5*i)<1?.5*-r*(Math.sqrt(1-e*e)-1)+t:.5*r*(Math.sqrt(1-(e-=2)*e)+1)+t}static circOut(e,t,r,i){return r*Math.sqrt(1-(e=e/i-1)*e)+t}}class Handler{constructor(e=null,t=null,r=null,i=!1){this.once=!1,this._id=0,this.setTo(e,t,r,i)}setTo(e,t,r,i=!1){return this._id=Handler._gid++,this.caller=e,this.method=t,this.args=r,this.once=i,this}run(){if(null==this.method)return null;var e=this._id,t=this.method.apply(this.caller,this.args);return this._id===e&&this.once&&this.recover(),t}runWith(e){if(null==this.method)return null;var t=this._id;if(null==e)var r=this.method.apply(this.caller,this.args);else r=this.args||e.unshift?this.args?this.method.apply(this.caller,this.args.concat(e)):this.method.apply(this.caller,e):this.method.call(this.caller,e);return this._id===t&&this.once&&this.recover(),r}clear(){return this.caller=null,this.method=null,this.args=null,this}recover(){this._id>0&&(this._id=0,Handler._pool.push(this.clear()))}static create(e,t,r=null,i=!0){return Handler._pool.length?Handler._pool.pop().setTo(e,t,r,i):new Handler(e,t,r,i)}}Handler._pool=[],Handler._gid=1;class Tween{constructor(){this.gid=0,this.repeat=1,this._count=0}static to(e,t,r,i=null,a=null,s=0,n=!1,o=!0){return Pool.getItemByClass("tween",Tween)._create(e,t,r,i,a,s,n,!0,o,!0)}static from(e,t,r,i=null,a=null,s=0,n=!1,o=!0){return Pool.getItemByClass("tween",Tween)._create(e,t,r,i,a,s,n,!1,o,!0)}to(e,t,r,i=null,a=null,s=0,n=!1){return this._create(e,t,r,i,a,s,n,!0,!1,!0)}from(e,t,r,i=null,a=null,s=0,n=!1){return this._create(e,t,r,i,a,s,n,!1,!1,!0)}_create(e,t,r,i,a,s,n,o,l,h){if(!e)throw new Error("Tween:target is null");this._target=e,this._duration=r,this._ease=i||t.ease||Tween.easeNone,this._complete=a||t.complete,this._delay=s,this._props=[],this._usedTimer=0,this._startTimer=Browser.now(),this._usedPool=l,this._delayParam=null,this.update=t.update;var d=e.$_GID||(e.$_GID=Utils.getGID());return Tween.tweenMap[d]?(n&&Tween.clearTween(e),Tween.tweenMap[d].push(this)):Tween.tweenMap[d]=[this],h?s<=0?this.firstStart(e,t,o):(this._delayParam=[e,t,o],ILaya.timer.once(s,this,this.firstStart,this._delayParam)):this._initProps(e,t,o),this}firstStart(e,t,r){this._delayParam=null,e.destroyed?this.clear():(this._initProps(e,t,r),this._beginLoop())}_initProps(e,t,r){for(var i in t)if("number"==typeof e[i]){var a=r?e[i]:t[i],s=r?t[i]:e[i];this._props.push([i,a,s-a]),r||(e[i]=a)}}_beginLoop(){ILaya.timer.frameLoop(1,this,this._doEase)}_doEase(){this._updateEase(Browser.now())}_updateEase(e){var t=this._target;if(t){if(t.destroyed)return Tween.clearTween(t);var r=this._usedTimer=e-this._startTimer-this._delay;if(!(r<0)){if(r>=this._duration)return this.complete();for(var i=r>0?this._ease(r,0,1,this._duration):0,a=this._props,s=0,n=a.length;s<n;s++){var o=a[s];t[o[0]]=o[1]+i*o[2]}this.update&&this.update.run()}}}set progress(e){var t=e*this._duration;this._startTimer=Browser.now()-this._delay-t}complete(){if(this._target){ILaya.timer.runTimer(this,this.firstStart);for(var e=this._target,t=this._props,r=this._complete,i=0,a=t.length;i<a;i++){var s=t[i];e[s[0]]=s[1]+s[2]}this.update&&this.update.run(),this._count++,0!=this.repeat&&this._count>=this.repeat?(this.clear(),r&&r.run()):this.restart()}}pause(){var e;ILaya.timer.clear(this,this._beginLoop),ILaya.timer.clear(this,this._doEase),ILaya.timer.clear(this,this.firstStart),(e=Browser.now()-this._startTimer-this._delay)<0&&(this._usedTimer=e)}setStartTime(e){this._startTimer=e}static clearAll(e){if(e&&e.$_GID){var t=Tween.tweenMap[e.$_GID];if(t){for(var r=0,i=t.length;r<i;r++)t[r]._clear();t.length=0}}}static clear(e){e.clear()}static clearTween(e){Tween.clearAll(e)}clear(){this._target&&(this._remove(),this._clear())}_clear(){this.pause(),ILaya.timer.clear(this,this.firstStart),this._complete=null,this._target=null,this._ease=null,this._props=null,this._delayParam=null,this.repeat=1,this._usedPool&&(this.update=null,Pool.recover("tween",this))}recover(){this._usedPool=!0,this._clear()}_remove(){var e=Tween.tweenMap[this._target.$_GID];if(e)for(var t=0,r=e.length;t<r;t++)if(e[t]===this){e.splice(t,1);break}}restart(){if(this.pause(),this._usedTimer=0,this._startTimer=Browser.now(),this._delayParam)ILaya.timer.once(this._delay,this,this.firstStart,this._delayParam);else{for(var e=this._props,t=0,r=e.length;t<r;t++){var i=e[t];this._target[i[0]]=i[1]}ILaya.timer.once(this._delay,this,this._beginLoop)}}resume(){this._usedTimer>=this._duration||(this._startTimer=Browser.now()-this._usedTimer-this._delay,this._delayParam?this._usedTimer<0?ILaya.timer.once(-this._usedTimer,this,this.firstStart,this._delayParam):this.firstStart.apply(this,this._delayParam):this._beginLoop())}static easeNone(e,t,r,i){return r*e/i+t}}Tween.tweenMap=[];class Dragging{constructor(){this.ratio=.92,this.maxOffset=60,this._dragging=!1,this._clickOnly=!0}start(e,t,r,i,a,s,n=.92){this.clearTimer(),this.target=e,this.area=t,this.hasInertia=r,this.elasticDistance=t?i:0,this.elasticBackTime=a,this.data=s,this.ratio=n,this._parent=e.parent,this._clickOnly=!0,this._dragging=!0,this._elasticRateX=this._elasticRateY=1,this._lastX=this._parent.mouseX,this._lastY=this._parent.mouseY,ILaya.stage.on(Event.MOUSE_UP,this,this.onStageMouseUp),ILaya.stage.on(Event.MOUSE_OUT,this,this.onStageMouseUp),ILaya.systemTimer.frameLoop(1,this,this.loop)}clearTimer(){ILaya.systemTimer.clear(this,this.loop),ILaya.systemTimer.clear(this,this.tweenMove),this._tween&&(this._tween.recover(),this._tween=null)}stop(){this._dragging&&(ILaya.stage.off(Event.MOUSE_UP,this,this.onStageMouseUp),ILaya.stage.off(Event.MOUSE_OUT,this,this.onStageMouseUp),this._dragging=!1,this.target&&this.area&&this.backToArea(),this.clear())}loop(){var e=this._parent.getMousePoint(),t=e.x,r=e.y,i=t-this._lastX,a=r-this._lastY;if(this._clickOnly){if(!(Math.abs(i*ILaya.stage._canvasTransform.getScaleX())>1||Math.abs(a*ILaya.stage._canvasTransform.getScaleY())>1))return;this._clickOnly=!1,this._offsets||(this._offsets=[]),this._offsets.length=0,this.target.event(Event.DRAG_START,this.data)}else this._offsets.push(i,a);0===i&&0===a||(this._lastX=t,this._lastY=r,this.target.x+=i*this._elasticRateX,this.target.y+=a*this._elasticRateY,this.area&&this.checkArea(),this.target.event(Event.DRAG_MOVE,this.data))}checkArea(){if(this.elasticDistance<=0)this.backToArea();else{if(this.target._x<this.area.x)var e=this.area.x-this.target._x;else e=this.target._x>this.area.x+this.area.width?this.target._x-this.area.x-this.area.width:0;if(this._elasticRateX=Math.max(0,1-e/this.elasticDistance),this.target._y<this.area.y)var t=this.area.y-this.target.y;else t=this.target._y>this.area.y+this.area.height?this.target._y-this.area.y-this.area.height:0;this._elasticRateY=Math.max(0,1-t/this.elasticDistance)}}backToArea(){this.target.x=Math.min(Math.max(this.target._x,this.area.x),this.area.x+this.area.width),this.target.y=Math.min(Math.max(this.target._y,this.area.y),this.area.y+this.area.height)}onStageMouseUp(e){if(ILaya.stage.off(Event.MOUSE_UP,this,this.onStageMouseUp),ILaya.stage.off(Event.MOUSE_OUT,this,this.onStageMouseUp),ILaya.systemTimer.clear(this,this.loop),!this._clickOnly&&this.target)if(this.hasInertia){this._offsets.length<1&&this._offsets.push(this._parent.mouseX-this._lastX,this._parent.mouseY-this._lastY),this._offsetX=this._offsetY=0;for(var t=this._offsets.length,r=Math.min(t,6),i=this._offsets.length-r,a=t-1;a>i;a--)this._offsetY+=this._offsets[a--],this._offsetX+=this._offsets[a];this._offsetX=this._offsetX/r*2,this._offsetY=this._offsetY/r*2,Math.abs(this._offsetX)>this.maxOffset&&(this._offsetX=this._offsetX>0?this.maxOffset:-this.maxOffset),Math.abs(this._offsetY)>this.maxOffset&&(this._offsetY=this._offsetY>0?this.maxOffset:-this.maxOffset),ILaya.systemTimer.frameLoop(1,this,this.tweenMove)}else this.elasticDistance>0?this.checkElastic():this.clear()}checkElastic(){var e=NaN,t=NaN;if(this.target.x<this.area.x?e=this.area.x:this.target._x>this.area.x+this.area.width&&(e=this.area.x+this.area.width),this.target.y<this.area.y?t=this.area.y:this.target._y>this.area.y+this.area.height&&(t=this.area.y+this.area.height),isNaN(e)&&isNaN(t))this.clear();else{var r={};isNaN(e)||(r.x=e),isNaN(t)||(r.y=t),this._tween=Tween.to(this.target,r,this.elasticBackTime,Ease.sineOut,Handler.create(this,this.clear),0,!1,!1)}}tweenMove(){this._offsetX*=this.ratio*this._elasticRateX,this._offsetY*=this.ratio*this._elasticRateY,this.target.x+=this._offsetX,this.target.y+=this._offsetY,this.area&&this.checkArea(),this.target.event(Event.DRAG_MOVE,this.data),(Math.abs(this._offsetX)<1&&Math.abs(this._offsetY)<1||this._elasticRateX<.5||this._elasticRateY<.5)&&(ILaya.systemTimer.clear(this,this.tweenMove),this.elasticDistance>0?this.checkElastic():this.clear())}clear(){if(this.target){this.clearTimer();var e=this.target;this.target=null,this._parent=null,e.event(Event.DRAG_END,this.data)}}}class SpriteUtils{static getGlobalRecByPoints(e,t,r,i,a){var s,n;s=Point.create().setTo(t,r),s=e.localToGlobal(s),n=Point.create().setTo(i,a),n=e.localToGlobal(n);var o=Rectangle._getWrapRec([s.x,s.y,n.x,n.y]);return s.recover(),n.recover(),o}static getGlobalPosAndScale(e){return SpriteUtils.getGlobalRecByPoints(e,0,0,1,1)}static getTransformRelativeToWindow(e,t,r){var i=ILaya.stage,a=SpriteUtils.getGlobalPosAndScale(e),s=i._canvasTransform.clone(),n=s.tx,o=s.ty;s.rotate(-Math.PI/180*i.canvasDegree),s.scale(i.clientScaleX,i.clientScaleY);var l,h,d,u,c=i.canvasDegree%180!=0;return c?(l=r+a.y,h=t+a.x,l*=s.d,h*=s.a,90==i.canvasDegree?(l=n-l,h+=o):(l+=n,h=o-h)):(l=t+a.x,h=r+a.y,l*=s.a,h*=s.d,l+=n,h+=o),h+=i._safariOffsetY,c?(d=s.d*a.height,u=s.a*a.width):(d=s.a*a.width,u=s.d*a.height),{x:l,y:h,scaleX:d,scaleY:u}}static fitDOMElementInArea(e,t,r,i,a,s){e._fitLayaAirInitialized||(e._fitLayaAirInitialized=!0,e.style.transformOrigin=e.style.webKittransformOrigin="left top",e.style.position="absolute");var n=SpriteUtils.getTransformRelativeToWindow(t,r,i);e.style.transform=e.style.webkitTransform="scale("+n.scaleX+","+n.scaleY+") rotate("+ILaya.stage.canvasDegree+"deg)",e.style.width=a+"px",e.style.height=s+"px",e.style.left=n.x+"px",e.style.top=n.y+"px"}static updateOrder(e){if(!e||e.length<2)return!1;for(var t,r,i,a=1,s=e.length;a<s;){for(i=e[t=a],r=e[t]._zOrder;--t>-1&&e[t]._zOrder>r;)e[t+1]=e[t];e[t+1]=i,a++}return!0}}class Sprite extends Node{constructor(){super(),this._x=0,this._y=0,this._width=0,this._height=0,this._anchorX=0,this._anchorY=0,this._visible=!0,this._mouseState=0,this._zOrder=0,this._renderType=0,this._transform=null,this._tfChanged=!1,this._repaint=SpriteConst.REPAINT_NONE,this._texture=null,this._sizeFlag=0,this._style=SpriteStyle.EMPTY,this._cacheStyle=CacheStyle.EMPTY,this._filterArr=null,this._boundStyle=null,this._graphics=null,this._ownGraphics=!1,this.mouseThrough=!1,this.autoSize=!1,this.hitTestPrior=!1,this._globalDeltaFlages=0,this._cacheGlobal=!1,this._globalPosx=0,this._globalPosy=0,this._globalRotate=0,this._globalScalex=1,this._globalScaley=1}destroy(e=!0){super.destroy(e),this._style&&this._style.recover(),this._cacheStyle&&this._cacheStyle.recover(),this._boundStyle&&this._boundStyle.recover(),this._transform&&this._transform.recover(),this._style=null,this._cacheStyle=null,this._boundStyle=null,this._transform=null,this._texture&&this._texture._removeReference(),this._texture=null,this._graphics&&this._ownGraphics&&this._graphics.destroy(),this._graphics=null}get scene(){return this._scene}updateZOrder(){SpriteUtils.updateOrder(this._children)&&this.repaint()}_getBoundsStyle(){return this._boundStyle||(this._boundStyle=BoundsStyle.create()),this._boundStyle}_setCustomRender(){}set customRenderEnable(e){e&&(this._renderType|=SpriteConst.CUSTOM,this._setCustomRender())}get cacheAs(){return this._getCacheStyle().userSetCache}set cacheAs(e){e!==this._cacheStyle.userSetCache&&(this._getCacheStyle().userSetCache=e,this.mask&&"normal"===e||("bitmap"==e||"normal"==e?this._renderType|=SpriteConst.CANVAS:this._renderType&=~SpriteConst.CANVAS,this.repaint()))}_checkCanvasEnable(){}get staticCache(){return this._getCacheStyle().staticCache}set staticCache(e){this._getCacheStyle().staticCache=e,e||this.reCache()}reCache(){this._repaint|=SpriteConst.REPAINT_CACHE}getRepaint(){return this._repaint}_setX(e){this._x=e}_setY(e){this._y=e}get x(){return this._x}set x(e){if(!this._destroyed&&this._x!==e){this._setX(e),this.cacheGlobal&&(this._setGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Position_X|Sprite.Sprite_GlobalDeltaFlage_Matrix,!0),this._syncGlobalFlag(Sprite.Sprite_GlobalDeltaFlage_Position_X|Sprite.Sprite_GlobalDeltaFlage_Matrix,!0)),this.parentRepaint(SpriteConst.REPAINT_CACHE);var t=this._getCacheStyle().maskParent;t&&t.repaint(SpriteConst.REPAINT_CACHE)}}get y(){return this._y}set y(e){if(!this._destroyed&&this._y!==e){this._setY(e),this.cacheGlobal&&(this._setGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Position_Y|Sprite.Sprite_GlobalDeltaFlage_Matrix,!0),this._syncGlobalFlag(Sprite.Sprite_GlobalDeltaFlage_Position_Y|Sprite.Sprite_GlobalDeltaFlage_Matrix,!0)),this.parentRepaint(SpriteConst.REPAINT_CACHE);var t=this._getCacheStyle().maskParent;t&&t.repaint(SpriteConst.REPAINT_CACHE)}}get width(){return this.get_width()}set width(e){this.set_width(e)}set_width(e){let t=this._sizeFlag;null==e?(e=0,this._sizeFlag&=-2):0==e?this._sizeFlag|=1:this._sizeFlag&=-2,this._width===e&&t==this._sizeFlag||(this._width=e,this._setWidth(e),this._setPivotX(this._anchorX*e),this._graphics&&this._graphics._clearBoundsCache(!0),this._setTranformChange(),this._shouldRefreshLayout())}get_width(){return this.autoSize?this.texture?this.texture.width:this._graphics||0!==this._children.length?this.getSelfBounds().width:0:0==this._width&&0==(1&this._sizeFlag)&&this.texture?this.texture.width:this._width}get height(){return this.get_height()}set height(e){this.set_height(e)}set_height(e){let t=this._sizeFlag;null==e?(e=0,this._sizeFlag&=-3):0==e?this._sizeFlag|=2:this._sizeFlag&=-3,this._height===e&&t==this._sizeFlag||(this._height=e,this._setHeight(e),this._setPivotY(this._anchorY*e),this._graphics&&this._graphics._clearBoundsCache(!0),this._setTranformChange(),this._shouldRefreshLayout())}get_height(){return this.autoSize?this.texture?this.texture.height:this._graphics||0!==this._children.length?this.getSelfBounds().height:0:0==this._height&&0==(2&this._sizeFlag)&&this.texture?this.texture.height:this._height}get _isWidthSet(){return 0!=this._width||0!=(1&this._sizeFlag)}get _isHeightSet(){return 0!=this._height||0!=(2&this._sizeFlag)}_setWidth(e){}_setHeight(e){}_shouldRefreshLayout(){}get displayWidth(){return this.width*this.scaleX}get displayHeight(){return this.height*this.scaleY}setSelfBounds(e){this._getBoundsStyle().userBounds=e}getBounds(){return this._getBoundsStyle().bounds=Rectangle._getWrapRec(this._boundPointsToParent())}getSelfBounds(){return this._boundStyle&&this._boundStyle.userBounds?this._boundStyle.userBounds:this._graphics||0!==this._children.length||this._texture?this._getBoundsStyle().bounds=Rectangle._getWrapRec(this._getBoundPointsM(!1)):Rectangle.TEMP.setTo(0,0,this.width,this.height)}_boundPointsToParent(e=!1){let t=0,r=0;this._style&&(t=this.pivotX,r=this.pivotY,e=e||0!==this._style.rotation,this._style.scrollRect&&(t+=this._style.scrollRect.x,r+=this._style.scrollRect.y));let i=this._getBoundPointsM(e);if(!i||i.length<1)return i;if(8!=i.length&&(i=e?GrahamScan.scanPList(i):Rectangle._getWrapRec(i,Rectangle.TEMP)._getBoundPoints()),!this.transform)return Utils.transPointList(i,this._x-t,this._y-r),i;let a=Point.TEMP,s=i.length;for(let e=0;e<s;e+=2)a.x=i[e],a.y=i[e+1],this.toParentPoint(a),i[e]=a.x,i[e+1]=a.y;return i}getGraphicBounds(e=!1){return this._graphics?this._graphics.getBounds(e):Rectangle.TEMP.setTo(0,0,0,0)}_getBoundPointsM(e=!1){if(this._boundStyle&&this._boundStyle.userBounds)return this._boundStyle.userBounds._getBoundPoints();this._boundStyle||this._getBoundsStyle();let t,r=this._boundStyle.temBM;if(r||(r=this._boundStyle.temBM=[]),this._style.scrollRect){r.length=0;var i=Rectangle.TEMP;return i.copyFrom(this._style.scrollRect),r.push(...i._getBoundPoints()),r}this._graphics?t=this._graphics.getBoundPoints():(r.length=0,t=r),this._texture&&((i=Rectangle.TEMP).setTo(0,0,this.width||this._texture.width,this.height||this._texture.height),t.push(...i._getBoundPoints()));let a=this._children;for(let r=0,i=a.length;r<i;r++){let i=a[r];if(!0===i._visible&&i._cacheStyle.maskParent!=this){let r=i._boundPointsToParent(e);r&&(t?t.push(...r):t=r)}}return t}_getCacheStyle(){return this._cacheStyle===CacheStyle.EMPTY&&(this._cacheStyle=CacheStyle.create()),this._cacheStyle}getStyle(){return this._style===SpriteStyle.EMPTY&&(this._style=SpriteStyle.create()),this._style}setStyle(e){this._style=e}get scaleX(){return this._style.scaleX}set scaleX(e){this.set_scaleX(e)}get scaleY(){return this._style.scaleY}set scaleY(e){this.set_scaleY(e)}set_scaleX(e){this.getStyle().scaleX!==e&&(this.cacheGlobal&&(this._setGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Scale_X|Sprite.Sprite_GlobalDeltaFlage_Matrix,!0),this._syncGlobalFlag(Sprite.Sprite_GlobalDeltaFlage_Scale_X|Sprite.Sprite_GlobalDeltaFlage_Matrix,!0)),this._setScaleX(e),this._setTranformChange(),this._shouldRefreshLayout())}get_scaleX(){return this._style.scaleX}set_scaleY(e){this.getStyle().scaleY!==e&&(this.cacheGlobal&&(this._setGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Scale_Y|Sprite.Sprite_GlobalDeltaFlage_Matrix,!0),this._syncGlobalFlag(Sprite.Sprite_GlobalDeltaFlage_Scale_Y|Sprite.Sprite_GlobalDeltaFlage_Matrix,!0)),this._setScaleY(e),this._setTranformChange(),this._shouldRefreshLayout())}get_scaleY(){return this._style.scaleY}_setScaleX(e){this._style.scaleX=e}_setScaleY(e){this._style.scaleY=e}get rotation(){return this._style.rotation}set rotation(e){this.getStyle().rotation!==e&&(this.cacheGlobal&&(this._setGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Rotation|Sprite.Sprite_GlobalDeltaFlage_Matrix,!0),this._syncGlobalFlag(Sprite.Sprite_GlobalDeltaFlage_Rotation|Sprite.Sprite_GlobalDeltaFlage_Matrix,!0)),this._setRotation(e),this._setTranformChange())}_setRotation(e){this.getStyle().rotation=e}get skewX(){return this._style.skewX}set skewX(e){this.getStyle().skewX!==e&&(this._setSkewX(e),this._setTranformChange())}_setSkewX(e){this._style.skewX=e}get skewY(){return this._style.skewY}set skewY(e){this.getStyle().skewY!==e&&(this._setSkewY(e),this._setTranformChange())}_setSkewY(e){this._style.skewY=e}_createTransform(){return Matrix.create()}_adjustTransform(){this._tfChanged=!1;var e=this._style,t=e.scaleX,r=e.scaleY,i=e.skewX,a=e.skewY,s=e.rotation,n=this._transform||(this._transform=this._createTransform());if(s||1!==t||1!==r||0!==i||0!==a){n._bTransform=!0;var o=.0174532922222222*(s-i),l=.0174532922222222*(s+a),h=Math.cos(l),d=Math.sin(l),u=Math.sin(o),c=Math.cos(o);n.a=t*h,n.b=t*d,n.c=-r*u,n.d=r*c,n.tx=n.ty=0}else n.identity(),this._renderType&=~SpriteConst.TRANSFORM;return n}_setTransform(e){}get transform(){return this._tfChanged?this._adjustTransform():this._transform}set transform(e){this.set_transform(e)}get_transform(){return this._tfChanged?this._adjustTransform():this._transform}set_transform(e){this._tfChanged=!1;var t=this._transform||(this._transform=this._createTransform());e.copyTo(t),this._setTransform(t),e&&(this._x=t.tx,this._y=t.ty,t.tx=t.ty=0),e?this._renderType|=SpriteConst.TRANSFORM:this._renderType&=~SpriteConst.TRANSFORM,this.parentRepaint()}_setPivotX(e){this.getStyle().pivotX=e}_getPivotX(){return this._style.pivotX}_setPivotY(e){this.getStyle().pivotY=e}_getPivotY(){return this._style.pivotY}get pivotX(){return this._getPivotX()}set pivotX(e){if(this.getStyle().pivotX!=e){this._setPivotX(e);let t=this.width;0!=t&&(this._anchorX=e/t),this._shouldRefreshLayout(),this.repaint()}}get pivotY(){return this._getPivotY()}set pivotY(e){if(this.getStyle().pivotY!=e){this._setPivotY(e);let t=this.height;0!=t&&(this._anchorY=e/t),this._shouldRefreshLayout(),this.repaint()}}get anchorX(){return this.get_anchorX()}get_anchorX(){return this._anchorX}set anchorX(e){this.set_anchorX(e)}set_anchorX(e){isNaN(e)&&(e=null),this._anchorX!=e&&(this._anchorX=e,null!=e&&(this._setPivotX(e*this.width),this._shouldRefreshLayout(),this.repaint()))}get anchorY(){return this.get_anchorY()}get_anchorY(){return this._anchorY}set anchorY(e){this.set_anchorY(e)}set_anchorY(e){isNaN(e)&&(e=null),this._anchorY!=e&&(this._anchorY=e,null!=e&&(this._setPivotY(e*this.height),this._shouldRefreshLayout(),this.repaint()))}_setAlpha(e){this._style.alpha!==e&&(this.getStyle().alpha=e,1!==e?this._renderType|=SpriteConst.ALPHA:this._renderType&=~SpriteConst.ALPHA,this.parentRepaint())}_getAlpha(){return this._style.alpha}get alpha(){return this._getAlpha()}set alpha(e){e=e<0?0:e>1?1:e,this._setAlpha(e)}get visible(){return this.get_visible()}set visible(e){this.set_visible(e)}get_visible(){return this._visible}set_visible(e){this._visible!==e&&(this._visible=e,this.parentRepaint(SpriteConst.REPAINT_ALL))}get blendMode(){return this._style.blendMode}set blendMode(e){this.getStyle().blendMode!=e&&(this.getStyle().blendMode=e,e&&"source-over"!=e?this._renderType|=SpriteConst.BLEND:this._renderType&=~SpriteConst.BLEND,this.parentRepaint())}get graphics(){return this._graphics||(this.graphics=new Graphics,this._ownGraphics=!0),this._graphics}set graphics(e){this.setGraphics(e,!1)}setGraphics(e,t){this._graphics&&(this._graphics._sp=null,this._ownGraphics&&this._graphics.destroy()),this._ownGraphics=t,this._graphics=e,e?(this._renderType|=SpriteConst.GRAPHICS,e._sp=this):this._renderType&=~SpriteConst.GRAPHICS,this.repaint()}get material(){var e;return null===(e=this._graphics)||void 0===e?void 0:e.material}set material(e){null==this._graphics&&null==e||(this.graphics.material=e)}get scrollRect(){return this._style.scrollRect}set scrollRect(e){null==this.getStyle().scrollRect&&null==e||(this.getStyle().scrollRect=e,e?this._renderType|=SpriteConst.CLIP:this._renderType&=~SpriteConst.CLIP,this.repaint())}pos(e,t,r=!1){if(this._x!==e||this._y!==t){if(this._destroyed)return this;if(r){this._setX(e),this._setY(t),this.parentRepaint(SpriteConst.REPAINT_CACHE);var i=this._cacheStyle.maskParent;if(i&&i.repaint(SpriteConst.REPAINT_CACHE),this.cacheGlobal){let e=Sprite.Sprite_GlobalDeltaFlage_Position_X|Sprite.Sprite_GlobalDeltaFlage_Position_Y;this._setGlobalCacheFlag(e,!0),this._syncGlobalFlag(e,!0)}}else this.x=e,this.y=t}return this}pivot(e,t){return this.pivotX=e,this.pivotY=t,this}size(e,t){return this.width=e,this.height=t,this}scale(e,t,r){if(this._destroyed)return this;var i=this.getStyle();return i.scaleX==e&&i.scaleY==t||(r?(this._setScaleX(e),this._setScaleY(t),this._setTranformChange(),this._shouldRefreshLayout()):(this.scaleX=e,this.scaleY=t)),this}skew(e,t){return this.skewX=e,this.skewY=t,this}render(e,t,r){RenderSprite.renders[this._renderType]._fun(this,e,t+this._x,r+this._y),this._repaint=0}drawToCanvas(e,t,r,i){return Sprite.drawToCanvas(this,e,t,r,i)}drawToTexture(e,t,r,i,a=null){return Sprite.drawToTexture(this,e,t,r,i,a)}drawToTexture3D(e,t,r){throw"not implement"}static drawToCanvas(e,t,r,i,a){if(arguments.length>5)throw"drawToCanvas 接口参数不对";let s=Sprite.drawToTexture(e,t,r,i,a);for(var n=s.getData(0,0,t,r),o=new ImageData(t,r),l=4*t,h=o.data,d=r-1,u=d*l,c=0;d>=0;d--)h.set(n.subarray(c,c+l),u),u-=l,c+=l;var _=new HTMLCanvas(!0);return _.size(t,r),_.getContext("2d").putImageData(o,0,0),s.destroy(),_}static drawToTexture(t,r,i,a,s,n=null){let o=n||new RenderTexture2D(r,i,e.RenderTargetFormat.R8G8B8A8),l=new Context;n?l.size(n.width,n.height):l.size(r,i),l.render2D=l.render2D.clone(o),l._drawingToTexture=!0;let h=RenderSprite.RenderToRenderTexture(t,l,a,s,o);return l._drawingToTexture=!1,h}customRender(e,t,r){this._repaint=SpriteConst.REPAINT_ALL}_applyFilters(){}get filters(){return this._filterArr}set filters(e){e&&0===e.length&&(e=null),this._filterArr=e?e.slice():null,e?this._renderType|=SpriteConst.FILTERS:this._renderType&=~SpriteConst.FILTERS,e&&e.length>0&&(this._getBit(NodeFlags.DISPLAY)||this._setBitUp(NodeFlags.DISPLAY)),this.repaint()}localToGlobal(e,t=!1,r=null){!0===t&&(e=new Point(e.x,e.y));var i=this;for(r=r||ILaya.stage;i&&!i._destroyed&&i!=r;)e=i.toParentPoint(e),i=i.parent;return e}globalToLocal(e,t=!1,r=null){t&&(e=new Point(e.x,e.y));var i=this,a=[];for(r=r||ILaya.stage;i&&!i._destroyed&&i!=r;)a.push(i),i=i.parent;for(var s=a.length-1;s>=0;)e=(i=a[s]).fromParentPoint(e),s--;return e}toParentPoint(e){if(!e)return e;e.x-=this.pivotX,e.y-=this.pivotY,this.transform&&this._transform.transformPoint(e),e.x+=this._x,e.y+=this._y;var t=this._style.scrollRect;return t&&(e.x-=t.x,e.y-=t.y),e}fromParentPoint(e){if(!e)return e;e.x-=this._x,e.y-=this._y;var t=this._style.scrollRect;return t&&(e.x+=t.x,e.y+=t.y),this.transform&&this._transform.invertTransformPoint(e),e.x+=this.pivotX,e.y+=this.pivotY,e}onStartListeningToType(e){super.onStartListeningToType(e),1!==this._mouseState&&Event.isMouseEvent(e)&&(this.mouseEnabled=!0,this._setBit(NodeFlags.HAS_MOUSE,!0),this._parent&&this._onDisplay())}_onDisplay(e){if(1!==this._mouseState){var t=this;for(t=t.parent;t&&1!==t._mouseState&&!t._getBit(NodeFlags.HAS_MOUSE);)t.mouseEnabled=!0,t._setBit(NodeFlags.HAS_MOUSE,!0),t=t.parent}}_setParent(e){super._setParent(e),e&&this._getBit(NodeFlags.HAS_MOUSE)&&this._onDisplay()}loadImage(e,t=null){if(e){let r=ILaya.loader.getRes(e);r?(this.texture=r,this.repaint(SpriteConst.REPAINT_ALL),t&&t.run()):(this._skinBaseUrl&&(e=URL.formatURL(e,this._skinBaseUrl)),ILaya.loader.load(e).then((e=>{this.texture=e,this.repaint(SpriteConst.REPAINT_ALL),t&&t.run()})))}else this.texture=null,this.repaint(SpriteConst.REPAINT_ALL),t&&t.run();return this}static fromImage(e){return(new Sprite).loadImage(e)}repaint(e=SpriteConst.REPAINT_CACHE){this._repaint&e||(this._repaint|=e,this.parentRepaint(e)),this._getCacheStyle(),this._cacheStyle&&(this._cacheStyle.renderTexture=null),this._cacheStyle&&this._cacheStyle.maskParent&&this._cacheStyle.maskParent.repaint(e)}_needRepaint(){return!!(this._repaint&SpriteConst.REPAINT_CACHE)}_childChanged(e=null){super._childChanged(e),this._children.length?this._renderType|=SpriteConst.CHILDS:this._renderType&=~SpriteConst.CHILDS,e&&this._getBit(NodeFlags.HAS_ZORDER)&&ILaya.systemTimer.callLater(this,this.updateZOrder),this.repaint(SpriteConst.REPAINT_ALL)}parentRepaint(e=SpriteConst.REPAINT_CACHE){var t=this._parent;!t||t._repaint&e||(t._repaint|=e,t.parentRepaint(e))}get stage(){return ILaya.stage}get hitArea(){return this._style.hitArea}set hitArea(e){this.getStyle().hitArea=e}_setMask(e){}get mask(){return this._cacheStyle.mask}set mask(e){e==this||e&&this.mask==e&&e._cacheStyle.maskParent==this||(this.mask&&(this.mask._getCacheStyle().maskParent=null),this._getCacheStyle().mask=e,this._setMask(e),e?(e._getCacheStyle().maskParent=this,this._renderType|=SpriteConst.MASK):this._renderType&=~SpriteConst.MASK,this.repaint())}get mouseEnabled(){return this._mouseState>1}set mouseEnabled(e){this._mouseState=e?2:1}startDrag(e=null,t=!1,r=0,i=300,a=null,s=.92){this._style.dragging||(this.getStyle().dragging=new Dragging),this._style.dragging.start(this,e,t,r,i,a,s)}stopDrag(){this._style.dragging&&this._style.dragging.stop()}_setDisplay(e){this._getCacheStyle(),e||this._cacheStyle.onInvisible(),super._setDisplay(e)}hitTestPoint(e,t){var r=this.globalToLocal(Point.TEMP.setTo(e,t));return e=r.x,t=r.y,(this._style.hitArea?this._style.hitArea:this._isWidthSet&&this._isHeightSet?Rectangle.TEMP.setTo(0,0,this._width,this._height):this.getSelfBounds()).contains(e,t)}getMousePoint(){return this.globalToLocal(Point.TEMP.setTo(ILaya.stage.mouseX,ILaya.stage.mouseY))}get mouseX(){return this.getMousePoint().x}get mouseY(){return this.getMousePoint().y}get zOrder(){return this._zOrder}set zOrder(e){this._zOrder!=e&&(this._zOrder=e,this._parent&&(e&&this._parent._setBit(NodeFlags.HAS_ZORDER,!0),ILaya.systemTimer.callLater(this._parent,this.updateZOrder)))}get texture(){return this._texture}_setTexture(e){}set texture(e){"string"==typeof e?this.loadImage(e):this._texture!=e&&(this._texture&&this._texture._removeReference(),this._texture=e,e&&e._addReference(),this._setTexture(e),this._setWidth(this.width),this._setHeight(this.height),e?this._renderType|=SpriteConst.TEXTURE:this._renderType&=~SpriteConst.TEXTURE,this.repaint())}get viewport(){return this._style.viewport}set viewport(e){if("string"==typeof e){let t=e.split(",");t.length>3&&(e=new Rectangle(parseFloat(t[0]),parseFloat(t[1]),parseFloat(t[2]),parseFloat(t[3])))}this.getStyle().viewport=e}_setTranformChange(){this._tfChanged=!0,this._renderType|=SpriteConst.TRANSFORM,this.parentRepaint(SpriteConst.REPAINT_CACHE)}set drawCallOptimize(e){this._setBit(NodeFlags.DRAWCALL_OPTIMIZE,e)}get drawCallOptimize(){return this._getBit(NodeFlags.DRAWCALL_OPTIMIZE)}onAfterDeserialize(){super.onAfterDeserialize(),LayaEnv.isPlaying&&(this._gcmds&&(this.graphics.cmds=this._gcmds,delete this._gcmds),this._filters&&(this.filters=this._filters,delete this._filters))}get cacheGlobal(){return this._cacheGlobal}set cacheGlobal(e){if(this._cacheGlobal!=e)if(this._cacheGlobal=e,e){if(this._setGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Position_X,!0),this._setGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Position_Y,!0),this._setGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Scale_X,!0),this._setGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Scale_Y,!0),this._setGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Rotation,!0),this._setGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Matrix,!0),this._parent==ILaya.stage||!this._parent)return;this._parent.cacheGlobal=e}else this._children.forEach((t=>{t.cacheGlobal=e}))}getGlobalMatrix(){return null==this._globalMatrix&&(this._globalMatrix=Matrix.create()),this._getGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Matrix)&&(this._globalMatrix.identity(),this._globalMatrix.translate(-this.pivotX,-this.pivotY),this._globalMatrix.scale(this.globalScaleX,this.globalScaleY),this._globalMatrix.rotate(Utils.toRadian(this.globalRotation)),this._globalMatrix.translate(this.globalPosX,this.globalPosY),this._setGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Matrix,!1)),this._globalMatrix}set globalPosX(e){this.setGlobalPos(e,this._globalPosy)}set globalPosY(e){this.setGlobalPos(this._globalPosx,e)}setGlobalPos(e,t){if(e!=this.globalPosX||t!=this.globalPosY)if(this._cacheGlobal){let r=this.parent.getGlobalMatrix().invertTransformPoint(Point.TEMP.setTo(e,t));this._setX(r.x),this._setY(r.y),this._globalPosx=e,this._globalPosy=t;let i=Sprite.Sprite_GlobalDeltaFlage_Position_X|Sprite.Sprite_GlobalDeltaFlage_Position_Y;this._setGlobalCacheFlag(i,!1),this._setGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Matrix,!0),this._syncGlobalFlag(i|Sprite.Sprite_GlobalDeltaFlage_Matrix,!0)}else{Point.TEMP.setTo(e,t);let r=this.globalToLocal(Point.TEMP,!1,null);r=this.toParentPoint(r),this.x=r.x,this.y=r.y}}get globalPosX(){if(this._cacheGlobal){if(this._getGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Matrix|Sprite.Sprite_GlobalDeltaFlage_Position_X)){this._setGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Position_X,!1);let e=this.parent.getGlobalMatrix(),t=this.toParentPoint(Point.TEMP.setTo(this.pivotX,this.pivotY));t=e.transformPoint(t),this._globalPosx=t.x,this._setGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Matrix,!0),this._syncGlobalFlag(Sprite.Sprite_GlobalDeltaFlage_Matrix,!0)}return this._globalPosx}return this.localToGlobal(Point.TEMP.setTo(0,0),!1,null).x}get globalPosY(){if(this._cacheGlobal){if(this._getGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Matrix|Sprite.Sprite_GlobalDeltaFlage_Position_Y)){this._setGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Position_Y,!1);let e=this.parent.getGlobalMatrix(),t=this.toParentPoint(Point.TEMP.setTo(this.pivotX,this.pivotY));t=e.transformPoint(t),this._globalPosy=t.y,this._setGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Matrix,!0),this._syncGlobalFlag(Sprite.Sprite_GlobalDeltaFlage_Matrix,!0)}return this._globalPosy}return this.localToGlobal(Point.TEMP.setTo(0,0),!1,null).y}get globalRotation(){if(this._cacheGlobal)return this._getGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Rotation)&&(this._setGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Rotation,!1),this._parent!=ILaya.stage&&this._parent?this._globalRotate=this.rotation+this.parent.globalRotation:this._globalRotate=this.rotation),this._globalRotate;for(var e=0,t=this;t&&t!==ILaya.stage;)e+=t.rotation,t=t.parent;return e}set globalRotation(e){e!=this.globalRotation&&(this._parent!=ILaya.stage&&this._parent?(this._setRotation(e-this.parent.globalRotation),this._setTranformChange()):(this._setRotation(e),this._setTranformChange()),this._cacheGlobal&&(this._globalRotate=e,this._setGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Rotation,!1),this._setGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Matrix,!0),this._syncGlobalFlag(Sprite.Sprite_GlobalDeltaFlage_Matrix,!0)))}get globalScaleX(){if(this._cacheGlobal)return this._getGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Scale_X)&&(this._setGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Scale_X,!1),this._setGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Matrix,!0),this._parent!=ILaya.stage&&this._parent?this._globalScalex=this.scaleX*this.parent.globalScaleX:this._globalScalex=this.scaleX,this._syncGlobalFlag(Sprite.Sprite_GlobalDeltaFlage_Matrix,!0)),this._globalScalex;for(var e=1,t=this;t&&t!==ILaya.stage;)e*=t.scaleX,t=t.parent;return e}get globalScaleY(){if(this._cacheGlobal)return this._getGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Scale_Y)&&(this._setGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Scale_Y,!1),this._setGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Matrix,!0),this._parent!=ILaya.stage&&this._parent?this._globalScaley=this.scaleY*this.parent.globalScaleY:this._globalScaley=this.scaleY,this._syncGlobalFlag(Sprite.Sprite_GlobalDeltaFlage_Matrix,!0)),this._globalScaley;for(var e=1,t=this;t&&t!==ILaya.stage;)e*=t.scaleY,t=t.parent;return e}_getGlobalCacheFlag(e){return 0!=(this._globalDeltaFlages&e)}_getGlobalCacheLocalToGlobal(e,t){return this._cacheGlobal?this.getGlobalMatrix().transformPoint(Point.TEMP.setTo(this.pivotX+e,this.pivotY+t)):this.localToGlobal(Point.TEMP.setTo(e,t),!1,null)}_getGlobalCacheGlobalToLocal(e,t){if(this._cacheGlobal){let r=this.getGlobalMatrix().invertTransformPoint(Point.TEMP.setTo(e,t));return r.x-=this.pivotX,r.y-=this.pivotY,r}return this.globalToLocal(Point.TEMP.setTo(e,t),!1,null)}_setGlobalCacheFlag(e,t){t?this._globalDeltaFlages|=e:this._globalDeltaFlages&=~e,t&&this.event("GlobaChange",e)}get globalDeltaFlages(){return this._globalDeltaFlages}_syncGlobalFlag(e,t){this.cacheGlobal&&this._children.forEach((r=>{r._setGlobalCacheFlag(e,t),r._syncGlobalFlag(e,t)}))}}Sprite.Sprite_GlobalDeltaFlage_Position_X=1,Sprite.Sprite_GlobalDeltaFlage_Position_Y=2,Sprite.Sprite_GlobalDeltaFlage_Rotation=4,Sprite.Sprite_GlobalDeltaFlage_Scale_X=8,Sprite.Sprite_GlobalDeltaFlage_Scale_Y=16,Sprite.Sprite_GlobalDeltaFlage_Matrix=32;class AnimationBase extends Sprite{constructor(){super(),this.wrapMode=0,this._interval=Config.animationInterval,this._isReverse=!1,this._frameRateChanged=!1,this._setBitUp(NodeFlags.DISPLAY)}play(e=0,t=!0,r=""){this._isPlaying=!0,this._actionName=r,this.index="string"==typeof e?this._getFrameByLabel(e):e,this.loop=t,this._isReverse=this.wrapMode===AnimationBase.WRAP_REVERSE,0==this.index&&this._isReverse&&(this.index=this.count-1),this.interval>0&&this.timerLoop(this.interval,this,this._frameLoop,null,!0,!0)}get interval(){return this._interval}set interval(e){this._interval!=e&&(this._frameRateChanged=!0,this._interval=e,this._isPlaying&&e>0&&this.timerLoop(e,this,this._frameLoop,null,!0,!0))}_getFrameByLabel(e){for(var t=0;t<this._count;t++){var r=this._labels[t];if(r&&r.indexOf(e)>-1)return t}return 0}_frameLoop(){if(this._controlNode&&!this._controlNode._destroyed){if(this._isReverse){if(this._index--,this._index<0){if(!this.loop)return this._index=0,this.stop(),void this.event(Event.COMPLETE);this.wrapMode==AnimationBase.WRAP_PINGPONG?(this._index=this._count>0?1:0,this._isReverse=!1):this._index=this._count-1,this.event(Event.COMPLETE)}}else if(this._index++,this._index>=this._count){if(!this.loop)return this._index--,this.stop(),void this.event(Event.COMPLETE);this.wrapMode==AnimationBase.WRAP_PINGPONG?(this._index=this._count-2>=0?this._count-2:0,this._isReverse=!0):this._index=0,this.event(Event.COMPLETE)}this.index=this._index}else this.clearTimer(this,this._frameLoop)}_setControlNode(e){this._controlNode&&(this._controlNode.off(Event.DISPLAY,this,this._resumePlay),this._controlNode.off(Event.UNDISPLAY,this,this._resumePlay)),this._controlNode=e,e&&e!=this&&(e.on(Event.DISPLAY,this,this._resumePlay),e.on(Event.UNDISPLAY,this,this._resumePlay))}_setDisplay(e){super._setDisplay(e),this._resumePlay()}_resumePlay(){this._isPlaying&&(this._controlNode.displayedInStage?this.play(this._index,this.loop,this._actionName):this.clearTimer(this,this._frameLoop))}stop(){this._isPlaying=!1,this.clearTimer(this,this._frameLoop)}get isPlaying(){return this._isPlaying}addLabel(e,t){this._labels||(this._labels={}),this._labels[t]||(this._labels[t]=[]),this._labels[t].push(e)}removeLabel(e){if(e){if(this._labels)for(var t in this._labels)this._removeLabelFromList(this._labels[t],e)}else this._labels=null}_removeLabelFromList(e,t){if(e)for(var r=e.length-1;r>=0;r--)e[r]==t&&e.splice(r,1)}gotoAndStop(e){this.index="string"==typeof e?this._getFrameByLabel(e):e,this.stop()}get index(){return this._index}set index(e){if(this._index=e,this._displayToIndex(e),this._labels&&this._labels[e])for(var t=this._labels[e],r=0,i=t.length;r<i;r++)this.event(Event.LABEL,t[r])}_displayToIndex(e){}get count(){return this._count}clear(){return this.stop(),this._labels=null,this}}AnimationBase.WRAP_POSITIVE=0,AnimationBase.WRAP_REVERSE=1,AnimationBase.WRAP_PINGPONG=2;class AtlasInfoManager{static enable(e,t=null){ILaya.loader.fetch(e,"json").then((e=>{e&&(AtlasInfoManager.addAtlases(e),t&&t.run())}))}static addAtlases(e){let t=AtlasInfoManager._fileLoadDic;for(let r in e){let i=e[r],a=URL.formatURL(i[0]),s=i[1],n=s.length,o={url:r};for(let e=0;e<n;e++)t[a+s[e]]=o}}static addAtlas(e,t,r){t=URL.formatURL(t);let i=AtlasInfoManager._fileLoadDic,a={url:e};for(let e of r)i[t+e]=a}static getFileLoadPath(e){return AtlasInfoManager._fileLoadDic[e]}}AtlasInfoManager._fileLoadDic={};class WorkerLoader{static workerSupported(){return!!Worker}static set enable(e){if(WorkerLoader._enable!=e){if(e){if(!Worker)return;WorkerLoader._worker||(WorkerLoader._worker=new Worker(WorkerLoader.workerPath),WorkerLoader._worker.onmessage=WorkerLoader.workerMessage,WorkerLoader._dispatcher=new EventDispatcher)}WorkerLoader._enable=e}}static get enable(){return WorkerLoader._enable}static load(e,t){return new Promise((r=>{WorkerLoader._worker.postMessage({url:e,options:t}),WorkerLoader._dispatcher.once(e,r)}))}static workerMessage(e){let t=e.data;if(t)switch(t.type){case"Image":WorkerLoader._dispatcher.event(t.url,t.imageBitmap);break;case"Disable":WorkerLoader.enable=!1}}}WorkerLoader.workerPath="libs/laya.workerloader.js",WorkerLoader._enable=!1;class AtlasResource extends Resource{constructor(e,t,r){super(),this.dir=e,this.textures=t,this.frames=r,this.lock=!0}_disposeResource(){for(let e of this.textures)e&&e.destroy();for(let e of this.frames)e.destroy();this.frames.length=0,this.textures.length=0}}class BatchProgress{constructor(e){this._callback=e,this._items=[],this._weights=[],this._progress=0}get itemCount(){return this._items.length}reset(){this._items.length=0,this._weights.length=0,this._progress=0}createCallback(e){let t=this._items.length;return this._items.push(0),null==e?this._weights.push(null):this._weights.push(Math.max(0,Math.min(e,1))),e=>this.update(t,e)}update(e,t){if(-1!=e){this._items[e]=Math.max(0,Math.min(t,1));let r=0,i=this._items,a=this._weights,s=1/i.length;for(let e=0;e<i.length;e++){let t=i[e],n=a[e];null!=t&&(r+=t*(null!=n?n:s))}(t=r)>1&&(t=1)}t>this._progress&&(this._progress=t,this._callback(t))}}class ImgUtils{static compareVersion(e,t){let r=e.split("."),i=t.split(".");const a=Math.max(r.length,i.length);for(;r.length<a;)r.push("0");for(;i.length<a;)i.push("0");for(let e=0;e<a;e++){const t=parseInt(r[e]),a=parseInt(i[e]);if(t>a)return!0;if(t<a)return!1}return!0}static get isSupport(){if(Browser._isMiniGame){var e=Browser.window.wx.getSystemInfoSync().SDKVersion;return ImgUtils.compareVersion(e,"2.14.0")}return!!Browser.onLayaRuntime||!!Browser.window.Blob&&!!Browser.window.Blob}static arrayBufferToURL(e,t){if(!ImgUtils.isSupport)return e;if(ImgUtils.data[e])return ImgUtils.data[e];var r="";if(Browser._isMiniGame||Browser.onLayaRuntime)r=Browser.window.wx.createBufferURL(t);else if(Browser.window.Blob){let e=new Blob([t],{type:"application/octet-binary"});r=Browser.window.URL.createObjectURL(e)}return ImgUtils.isSavaData&&(ImgUtils.data[e]=r),r}static _arrayBufferToURL(e){if(!ImgUtils.isSupport)return null;var t="";if(Browser._isMiniGame||Browser.onLayaRuntime)t=Browser.window.wx.createBufferURL(e);else if(Browser.window.Blob){let r=new Blob([e],{type:"application/octet-binary"});t=Browser.window.URL.createObjectURL(r)}return t}static destroy(e){if(ImgUtils.isSupport){var t=ImgUtils.data[e];t&&(Browser._isMiniGame||Browser.onLayaRuntime?Browser.window.wx.revokeBufferURL(t):Browser.window.Blob&&Browser.window.URL.revokeObjectURL(t),delete ImgUtils.data[e])}}}ImgUtils.data={},ImgUtils.isSavaData=!1;class XMLUtils{static decodeString(e){let t=e.length,r="",i=0,a=0;for(;;){if(a=e.indexOf("&",i),-1==a){r+=e.substring(i);break}r+=e.substring(i,a),i=a+1,a=i;let s=Math.min(t,a+10);for(;a<s&&";"!=e[a];a++);if(a<s&&a>i){let t=e.substring(i,a),s=0;if("#"==t[0])t.length>1?(s="x"==t[1]?parseInt(t.substring(2),16):parseInt(t.substring(1)),r+=String.fromCharCode(s),i=a+1):r+="&";else{switch(t){case"amp":s=38;break;case"apos":s=39;break;case"gt":s=62;break;case"lt":s=60;break;case"nbsp":s=32;break;case"quot":s=34}s>0?(r+=String.fromCharCode(s),i=a+1):r+="&"}}else r+="&"}return r}static encodeString(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/'/g,"&apos;").replace(/"/g,"&quot;")}static getString(e,t,r){if(null==e)return null==r?null:r;let i=e[t];return null!=i?""+i:null==r?null:r}static getInt(e,t,r){let i=this.getString(e,t);if(null!=i&&i.length>0)if("%"==i[i.length-1]){let e=parseInt(i.substring(0,i.length-1));if(!isNaN(e))return Math.ceil(e/100*r)}else{let e=parseInt(i);if(!isNaN(e))return e}return null==r?0:r}static getFloat(e,t,r){let i=this.getString(e,t);if(null==i||0==i.length)return null==r?0:r;let a=parseFloat(i);return isNaN(a)?null==r?0:r:a}static getBool(e,t,r){let i=this.getString(e,t);return null==i||0==i.length?null!=r&&r:"true"==i||"1"==i||"false"!=i&&"0"!=i&&(null!=r&&r)}}var Fe;e.XMLTagType=void 0,(Fe=e.XMLTagType||(e.XMLTagType={}))[Fe.Start=0]="Start",Fe[Fe.End=1]="End",Fe[Fe.Void=2]="Void",Fe[Fe.CDATA=3]="CDATA",Fe[Fe.Comment=4]="Comment",Fe[Fe.Instruction=5]="Instruction";class XMLIterator{static begin(e,t){XMLIterator.source=e,XMLIterator.lowerCaseName=t,this.sourceLen=e.length,this.parsePos=0,this.lastTagEnd=0,this.tagPos=0,this.tagLength=0,this.tagName=null}static nextTag(){let t,r,i="";for(this.tagType=e.XMLTagType.Start,this.lastTagEnd=this.parsePos,this.attrParsed=!1,this.lastTagName=this.tagName;-1!=(t=this.source.indexOf("<",this.parsePos))&&(this.parsePos=t,t++,t!=this.sourceLen);){if(r=this.source[t],"!"==r){if(this.sourceLen>t+7&&"<![CDATA["==this.source.substring(t-1,t+8))return t=this.source.indexOf("]]>",t),this.tagType=e.XMLTagType.CDATA,this.tagName="",this.tagPos=this.parsePos,this.tagLength=-1==t?this.sourceLen-this.parsePos:t+3-this.parsePos,this.parsePos+=this.tagLength,!0;if(this.sourceLen>t+2&&"\x3c!--"==this.source.substring(t-1,t+3))return t=this.source.indexOf("--\x3e",t),this.tagType=e.XMLTagType.Comment,this.tagName="",this.tagPos=this.parsePos,this.tagLength=-1==t?this.sourceLen-this.parsePos:t+3-this.parsePos,this.parsePos+=this.tagLength,!0;t++,this.tagType=e.XMLTagType.Instruction}else"/"==r?(t++,this.tagType=e.XMLTagType.End):"?"==r&&(t++,this.tagType=e.XMLTagType.Instruction);for(;t<this.sourceLen&&(r=this.source[t],-1==" \t\n\r\v".indexOf(r)&&">"!=r&&"/"!=r);t++);if(t==this.sourceLen)break;i+=this.source.substring(this.parsePos+1,t),i.length>0&&"/"==i[0]&&(i=i.substring(1));let a=!1,s=!1,n=-1;for(;t<this.sourceLen;t++)if(r=this.source[t],'"'==r?a||(s=!s):"'"==r&&(s||(a=!a)),">"==r){if(!a&&!s){n=-1;break}n=t}else if("<"==r)break;if(-1!=n&&(t=n),t==this.sourceLen)break;return"/"==this.source[t-1]&&(this.tagType=e.XMLTagType.Void),this.tagName=i,this.lowerCaseName&&(this.tagName=this.tagName.toLowerCase()),this.tagPos=this.parsePos,this.tagLength=t+1-this.parsePos,this.parsePos+=this.tagLength,!0}return this.tagPos=this.sourceLen,this.tagLength=0,this.tagName=null,!1}static getTagSource(){return this.source.substring(this.tagPos,this.tagPos+this.tagLength)}static getRawText(e){if(this.lastTagEnd==this.tagPos)return"";if(e){let e=this.lastTagEnd;for(;e<this.tagPos;e++){let t=this.source[e];if(-1==" \t\n\r\v".indexOf(t))break}return e==this.tagPos?"":this.source.substring(e,this.tagPos).trim()}return this.source.substring(this.lastTagEnd,this.tagPos)}static getText(e){if(this.lastTagEnd==this.tagPos)return"";if(e){let e=this.lastTagEnd;for(;e<this.tagPos;e++){let t=this.source[e];if(-1==" \t\n\r\v".indexOf(t))break}return e==this.tagPos?"":XMLUtils.decodeString(this.source.substring(e,this.tagPos)).trimEnd()}return XMLUtils.decodeString(this.source.substring(this.lastTagEnd,this.tagPos))}static get attributes(){if(!this.attrParsed){for(let e in this._attrs)delete this._attrs[e];this.parseAttributes(this._attrs),this.attrParsed=!0}return this._attrs}static getAttribute(e){return this.attributes[e]}static parseAttributes(e){let t,r=0,i=0,a=!1,s=0,n="",o=this.tagPos,l=this.tagPos+this.tagLength;if(o<l&&"<"==this.source[o])for(;o<l;o++){let e=this.source[o];if(-1!=" \t\n\r\v".indexOf(e)||">"==e||"/"==e)break}for(;o<l;o++){let h=this.source[o];if("="==h){r=-1,i=-1,s=0;for(let e=o+1;e<l;e++){let t=this.source[e];if(-1!=" \t\n\r\v".indexOf(t)){if(-1!=r&&0==s){i=e-1;break}}else if(">"==t){if(0==s){i=e-1;break}}else if('"'==t)if(-1!=r){if(1!=s){i=e-1;break}}else s=2,r=e+1;else if("'"==t)if(-1!=r){if(2!=s){i=e-1;break}}else s=1,r=e+1;else-1==r&&(r=e)}if(-1==r||-1==i)break;t=n,this.lowerCaseName&&(t=t.toLowerCase()),n="",e[t]=XMLUtils.decodeString(this.source.substring(r,i+1)),o=i+1}else-1==" \t\n\r\v".indexOf(h)?((a||"/"==h||">"==h)&&(n.length>0&&(t=n,this.lowerCaseName&&(t=t.toLowerCase()),e[t]="",n=""),a=!1),"/"!=h&&">"!=h&&(n+=h)):n.length>0&&(a=!0)}}}XMLIterator._attrs={},String.prototype.trimEnd||(String.prototype.trimEnd=function(){return this.replace(/\s+$/g,"")});class XML{constructor(e){e&&this.parse(e)}get attributes(){return this._attrs||(this._attrs={}),this._attrs}getAttrString(e,t){return XMLUtils.getString(this._attrs,e,t)}getAttrInt(e,t){return XMLUtils.getInt(this._attrs,e,t)}getAttrFloat(e,t){return XMLUtils.getFloat(this._attrs,e,t)}getAttrBool(e,t){return XMLUtils.getBool(this._attrs,e,t)}setAttribute(e,t){this._attrs||(this._attrs={}),this._attrs[e]=t}getNode(e){return this._children?this._children.find((t=>t.name==e)):null}elements(e){return this._children||(this._children=new Array),e?this._children.filter((t=>t.name==e)):this._children}parse(t){let r;this.reset();let i=new Array;for(XMLIterator.begin(t);XMLIterator.nextTag();)if(XMLIterator.tagType==e.XMLTagType.Start||XMLIterator.tagType==e.XMLTagType.Void){let t;if(r)t=new XML;else{if(null!=this.name)throw this.reset(),new Error("Invalid xml format - no root node.");t=this}t.name=XMLIterator.tagName,t._attrs=Object.assign({},XMLIterator.attributes),r&&(XMLIterator.tagType!=e.XMLTagType.Void&&i.push(r),null==r._children&&(r._children=new Array),r._children.push(t)),XMLIterator.tagType!=e.XMLTagType.Void&&(r=t)}else if(XMLIterator.tagType==e.XMLTagType.End){if(null==r||r.name!=XMLIterator.tagName)throw this.reset(),new Error("Invalid xml format - <"+XMLIterator.tagName+"> dismatched.");null!=r._children&&0!=r._children.length||(r.text=XMLIterator.getText()),r=i.length>0?i.pop():null}}reset(){this._attrs=null,null!=this._children&&this._children.length,this.text=null}}class HttpRequest extends EventDispatcher{constructor(){super(...arguments),this._http=new XMLHttpRequest}send(e,t=null,r="get",i="text",a){this._responseType=i,this._data=null,(Browser.onVVMiniGame||Browser.onQGMiniGame||Browser.onQQMiniGame||Browser.onAlipayMiniGame||Browser.onBLMiniGame||Browser.onHWMiniGame||Browser.onTTMiniGame||Browser.onTBMiniGame)&&(e=HttpRequest._urlEncode(e)),this._url=e;let s=this._http;if(s.open(r,e,!0),t?"string"==typeof t?s.setRequestHeader("Content-Type","application/x-www-form-urlencoded"):(s.setRequestHeader("Content-Type","application/json"),t instanceof ArrayBuffer||(t=JSON.stringify(t))):Browser.onBLMiniGame&&Browser.onAndroid&&(t={}),a)for(let e=0;e<a.length;e++)s.setRequestHeader(a[e++],a[e]);let n="arraybuffer"!==i?"text":"arraybuffer";s.responseType=n,s.dataType&&(s.dataType=n),s.onerror=e=>{this._onError(e)},s.onabort=e=>{this._onAbort(e)},s.onprogress=e=>{this._onProgress(e)},s.onload=e=>{this._onLoad(e)},s.send(t)}_onProgress(e){e&&e.lengthComputable&&this.event(Event.PROGRESS,e.loaded/e.total)}_onAbort(e){this.error("Request was aborted by user")}_onError(e){this.error("Request failed Status:"+this._http.status+" text:"+this._http.statusText)}_onLoad(e){var t=this._http,r=void 0!==t.status?t.status:200;200===r||204===r||0===r?this.complete():this.error("["+t.status+"]"+t.statusText+":"+t.responseURL)}error(e){this.clear(),this.event(Event.ERROR,e)}complete(){this.clear();var e=!0;try{"json"===this._responseType?this._data=JSON.parse(this._http.responseText):"xml"===this._responseType?this._data=new XML(this._http.responseText):this._data=this._http.response||this._http.responseText}catch(t){e=!1,this.error(t.message)}e&&this.event(Event.COMPLETE,this._data instanceof Array?[this._data]:this._data)}clear(){var e=this._http;e.onerror=e.onabort=e.onprogress=e.onload=null}get url(){return this._url}get data(){return this._data}get http(){return this._http}reset(){this.offAll(),this._data=null}}HttpRequest._urlEncode=encodeURI;class Downloader{constructor(){this.httpRequestPool=[]}common(e,t,r,i,a,s){let n=this.getRequestInst();n.on(Event.COMPLETE,(()=>{let e=n.data;this.returnRequestInst(n),s(e)})),n.on(Event.ERROR,null,(e=>{this.returnRequestInst(n),s(null,e)})),a&&n.on(Event.PROGRESS,a),n.send(t,null,"get",i),e.$ref=n}image(e,t,r,i,a){let s=new Browser.window.Image;s.crossOrigin="",s.onload=()=>{s.onload=null,s.onerror=null,a(s)},s.onerror=()=>{s.onload=null,s.onerror=null,a(null,"")},s.src=t,e.$ref=s}imageWithBlob(e,t,r,i,a){let s=ImgUtils.arrayBufferToURL(r,t);this.image(e,s,r,i,a)}imageWithWorker(e,t,r,i,a){WorkerLoader.enable=!0,WorkerLoader.enable?WorkerLoader.load(t,e.workerLoaderOptions).then((e=>{e?a(e):a(null,"workerloader failed!")})):this.image(e,t,r,i,a)}audio(e,t,r,i,a){let s=Browser.createElement("audio");s.crossOrigin="",s.oncanplaythrough=()=>{s.oncanplaythrough=null,s.onerror=null,a(s)},s.onerror=()=>{s.oncanplaythrough=null,s.onerror=null,a(null,"")},s.src=t,e.$ref=s}getRequestInst(){return 0==this.httpRequestPool.length||Browser.onVVMiniGame||Browser.onHWMiniGame?new HttpRequest:this.httpRequestPool.pop()}returnRequestInst(e){e.reset(),this.httpRequestPool.length<10&&this.httpRequestPool.push(e)}}var Ue=0;const Oe={ext:null,typeId:null,main:!1,loaderType:null};class Loader extends EventDispatcher{constructor(){super(),this.retryNum=1,this.retryDelay=0,this.maxLoader=5,this._loadings=new Map,this._queue=[],this._downloadings=new Set}static registerLoader(e,t,r){let i;r?(i=Loader.typeMap[r],i?i.loaderType!=t&&(i={typeId:i.typeId,loaderType:t}):Loader.typeMap[r]=i={typeId:Ue++,loaderType:t}):i={typeId:Ue++,loaderType:t};for(let a of e){let e=Loader.extMap[a];if(e&&r){let r=e.findIndex((e=>e.typeId==i.typeId));-1==r?e.push(i):e[r].loaderType=t}else Loader.extMap[a]=[i]}}get loading(){return this._loadings.size>0}load(e,t,r,i,a,s,n,o,l){let h,d,u,c,_=Ve;if(t instanceof Handler?(h=t,d=i):"string"==typeof t?d=t:null!=t&&(d=t.type,_=t),null==a&&null==s&&null==o&&null==n&&null==l||(_=_===Ve?{priority:a,cache:s,ignoreCache:o,group:n,useWorkerLoader:l}:Object.assign(_,{priority:a,cache:s,ignoreCache:o,group:n,useWorkerLoader:l})),!1===_.cache&&(_.ignoreCache=!0),u=r instanceof Handler?e=>r.runWith(e):r,Array.isArray(e)){let t;u&&(t=new BatchProgress(u));let r=[];for(let i=0;i<e.length;i++){let a=e[i];a&&("string"==typeof a?r.push(this._load1(a,d,_,null==t?void 0:t.createCallback())):r.push(this._load1(a.url,a.type||d,_!==Ve?Object.assign({},_,a):a,null==t?void 0:t.createCallback())))}c=Promise.all(r)}else c="string"==typeof e?this._load1(e,d,_,u):this._load1(e.url,e.type||d,_!==Ve?Object.assign({},_,e):e,u);return h?c.then((e=>(h.runWith(e),e))):c}_load1(e,t,r,i){if(LayaEnv.isPreview){if(e.startsWith("res://")){let a=e.substring(6);return AssetDb.inst.UUID_to_URL_async(a).then((s=>s?this._load2(s,a,t,r,i):(!r.silent&&Loader.warnFailed(e),Promise.resolve(null))))}return AssetDb.inst.URL_to_UUID_async(e).then((a=>this._load2(e,a,t,r,i)))}return this._load2(e,null,t,r,i)}_load2(e,t,r,i,a){let{ext:s,typeId:n,main:o,loaderType:l}=Loader.getURLInfo(e,r);if(!l)return!i.silent&&Loader.warnFailed(e),Promise.resolve(null);let h,d=URL.formatURL(e);if(i.group){let e=Loader.groupMap[i.group];e||(e=Loader.groupMap[i.group]=new Set),e.add(d)}if(!i.ignoreCache){let e=Loader._getRes(d,r);if(void 0!==e){if(null==e)return Promise.resolve(null);if(!(e instanceof Resource))return Promise.resolve(e);if(e.obsolute&&(h=e),!(h||e.uuid&&t&&t!=e.uuid))return Promise.resolve(e)}}let u=d;o||(u+="@"+n);let c=this._loadings.get(u);if(c)return i.initiator===c?Promise.resolve():(a&&c.onProgress.add(a),new Promise((e=>c.onComplete.add(e))));let _=AtlasInfoManager.getFileLoadPath(d);if(_)return this.load(_.url,{type:Loader.ATLAS,baseUrl:_.baseUrl}).then((()=>Loader.getRes(e,r)));c=Ge.length>0?Ge.pop():new LoadTask,c.type=r,c.url=e,c.uuid=t,c.ext=s,delete(i=Object.assign(c.options,i)).type,null==i.priority&&(i.priority=0),null==i.useWorkerLoader&&(i.useWorkerLoader=WorkerLoader.enable),a&&c.onProgress.add(a),c.loader=this,c.obsoluteInst=h;let p,g=new l;this._loadings.set(u,c);try{p=g.load(c)}catch(t){!i.silent&&Loader.warnFailed(e,t),p=Promise.resolve(null)}return p.then((r=>(r instanceof Resource&&r._setCreateURL(e,t),!1!==c.options.cache&&Loader._cacheRes(d,r,n,o),c.progress.update(-1,1),c.onComplete.invoke(r),r))).catch((t=>(!i.silent&&Loader.warnFailed(e,t),!1!==c.options.cache&&Loader._cacheRes(d,null,n,o),c.onComplete.invoke(null),null))).then((e=>(this._loadings.delete(u),c.reset(),Ge.push(c),0==this._loadings.size&&this.event(Event.COMPLETE),e)))}fetch(e,t,r,i){var a;let s={originalUrl:e,url:e,contentType:t,priority:null!==(a=(i=i||Ve).priority)&&void 0!==a?a:1,retryCnt:0,onProgress:r,onComplete:null};return i.useWorkerLoader&&(s.useWorkerLoader=!0,s.workerLoaderOptions=i.workerLoaderOptions),i.blob&&(s.blob=i.blob),i.noRetry&&(s.retryCnt=-1),i.silent&&(s.silent=!0),AssetDb.inst.resolveURL(e).then((e=>new Promise((t=>{s.url=URL.formatURL(e),s.onComplete=t,this.queueToDownload(s)}))))}queueToDownload(e){if(this._downloadings.size<this.maxLoader)return void this.download(e);let t=e.priority;if(0==t)this._queue.push(e);else{let r=this._queue.findIndex((e=>e.priority<t));-1!=r?this._queue.splice(r,0,e):this._queue.push(e)}}download(e){this._downloadings.add(e);let t=URL.postFormatURL(e.url);if("image"==e.contentType){let r=Loader.preLoadedMap[e.url];if(r){if(!(r instanceof ArrayBuffer))return void this.completeItem(e,r);e.blob=r}e.blob?Loader.downloader.imageWithBlob(e,e.blob,e.originalUrl,e.onProgress,((t,r)=>{t||(e.retryCnt=-1),this.completeItem(e,t,r)})):e.useWorkerLoader?Loader.downloader.imageWithWorker(e,t,e.originalUrl,e.onProgress,((t,r)=>{t||(e.useWorkerLoader=!1),this.completeItem(e,t,r)})):Loader.downloader.image(e,t,e.originalUrl,e.onProgress,((t,r)=>this.completeItem(e,t,r)))}else if("sound"==e.contentType)Loader.downloader.audio(e,t,e.originalUrl,e.onProgress,((t,r)=>this.completeItem(e,t,r)));else{let r=Loader.preLoadedMap[e.url];if(r)return void this.completeItem(e,r);Loader.downloader.common(e,t,e.originalUrl,e.contentType,e.onProgress,((t,r)=>this.completeItem(e,t,r)))}}completeItem(e,t,r){this._downloadings.delete(e),t?(this._downloadings.size<this.maxLoader&&this._queue.length>0&&this.download(this._queue.shift()),e.onProgress&&e.onProgress(1),e.onComplete(t)):-1!=e.retryCnt&&e.retryCnt<this.retryNum?(e.retryCnt++,e.silent||console.debug(`Retry to load ${e.url} (${e.retryCnt})`),ILaya.systemTimer.once(this.retryDelay,this,this.queueToDownload,[e],!1)):(!e.silent&&Loader.warnFailed(e.url),e.onProgress&&e.onProgress(1),this._downloadings.size<this.maxLoader&&this._queue.length>0&&this.download(this._queue.shift()),e.onComplete(null))}static getURLInfo(e,t){let r,i,a,s,n=e.startsWith("data:")?"png":Utils.getFileExtension(e);if(n.length>0&&(r=Loader.extMap[n]),t){let e=Loader.typeMap[t];if(!e)return Oe;i=e.typeId;let n=0;r?r[0].typeId===i||-1!=(n=r.findIndex((e=>e.typeId===i)))?(a=0==n,s=r[n].loaderType):(a=!1,s=e.loaderType):(a=t!=Loader.TEXTURE2D,s=e.loaderType)}else{if(!r)return Oe;a=!0,i=r[0].typeId,s=r[0].loaderType}return{ext:n,main:a,typeId:i,loaderType:s}}static warnFailed(e,t){this.warn(`Failed to load '${e}'`,t)}static warn(e,t){t?console.warn(e,t):console.warn(e)}static getRes(e,t){return e=URL.formatURL(e),Loader._getRes(e,t)||null}static _getRes(e,t){let r,i=Loader.loadedMap[e];if(i){if(t){let e=Loader.typeMap[t];if(!e)return;if(2==i.length)i[0]==e.typeId&&(r=i[1]);else{let t=i.indexOf(e.typeId);-1!=t&&(r=i[t+1])}}else r=i[1];return r instanceof Resource&&r.destroyed?void 0:r}}static getTexture2D(e){return Loader.getRes(e,Loader.TEXTURE2D)}static getBaseTexture(e){return Loader.getRes(e,Loader.TEXTURE2D)}static getAtlas(e){return Loader.getRes(e,Loader.ATLAS)}getRes(e,t){return Loader.getRes(e,t)}static createNodes(e){var t;return null===(t=Loader.getRes(e))||void 0===t?void 0:t.create()}static cacheRes(e,t,r){e=URL.formatURL(e);let i=Loader.getURLInfo(e,r);null!=i.typeId&&Loader._cacheRes(e,t,i.typeId,i.main)}static _cacheRes(e,t,r,i){let a=Loader.loadedMap[e];if(i)a?(a[0]=r,a[1]=t):a=Loader.loadedMap[e]=[r,t];else if(a){let e=a.findIndex((e=>e===r));-1!=e?a[e+1]=t:a.push(r,t)}else a=Loader.loadedMap[e]=[null,void 0,r,t]}cacheRes(e,t,r){Loader.cacheRes(e,t,r)}static clearRes(e,t){e=URL.formatURL(e),Loader._clearRes(e,t)}clearRes(e,t){e=URL.formatURL(e),Loader._clearRes(e,t)}static _clearRes(e,t){let r=Loader.loadedMap[e];if(r)if(t){if(r[1]==t)2==r.length?delete Loader.loadedMap[e]:r[1]=void 0;else{let i=r.indexOf(t);if(-1==i)return;4==r.length&&null==r[0]?delete Loader.loadedMap[e]:r.splice(i-1,2)}t instanceof Resource&&!t.destroyed&&t.destroy()}else if(delete Loader.loadedMap[e],r.length>2)for(let e=1;e<r.length;e+=2){let t=r[e];t instanceof Resource&&!t.destroyed&&t.destroy()}else{let e=r[1];e instanceof Resource&&!e.destroyed&&e.destroy()}}clearTextureRes(e){e=URL.formatURL(e);let t=Loader.loadedMap[e];if(!t)return;let r=t[1];if(r instanceof Texture)r.disposeBitmap();else if(r instanceof AtlasResource)for(let e of r.textures)e.disposeBitmap()}static setGroup(e,t){e=URL.formatURL(e);let r=Loader.groupMap[t];r||(r=Loader.groupMap[t]=new Set),r.add(e)}static clearResByGroup(e){let t=Loader.groupMap[e];if(t)for(let e of t)Loader._clearRes(e)}clearUnLoaded(){if(0==this._queue.length)return;let e=this._queue.concat();this._queue.length=0;for(let t of e)t.onComplete(null)}cancelLoadByUrls(e){if(e)for(var t=0,r=e.length;t<r;t++)this.cancelLoadByUrl(e[t])}cancelLoadByUrl(e){e=URL.formatURL(e);let t=this._queue.findIndex((t=>t.url==e));if(-1!=t){let e=this._queue[t];this._queue.splice(t,1),e.onComplete(null)}}loadPackage(e,t,r){let i,a;if("string"==typeof t?(a=t,i=r):i=t,a){a.endsWith("/")||(a+="/");let t=e+"/";return URL.basePaths[t]=a,this._loadSubFileConfig(e,null,i)}{if(LayaEnv.isPreview)return Promise.resolve();let t=ILaya.Browser.miniGameContext;return null==t?this._loadSubFileConfig(e,null,i):this._loadMiniPackage(t,e,i).then((()=>this._loadSubFileConfig(e,t,i)))}}_loadMiniPackage(e,t,r){return e.subPkgNameSeperator&&(t=t.replace(/\//g,e.subPkgNameSeperator)),t.length>0?new Promise(((i,a)=>{let s=e.loadSubpackage({name:t,success:e=>{i(e)},fail:e=>{a(e)}});s.onProgressUpdate&&s.onProgressUpdate((e=>{r&&r(e)}))})):Promise.resolve()}_loadSubFileConfig(e,t,r){return t&&t.subPkgPathSeperator&&(e=e.replace(/\//g,t.subPkgPathSeperator)),e.length>0&&(e+="/"),this.fetch(e+"fileconfig.json","json",r).then((r=>{let i=[],a=r.files;for(let e in a)if(e.length>0)for(let t of a[e])i.push(e+"/"+t);else for(let t of a[e])i.push(t);if(r.hash){let e=0,t=URL.version;for(let a of r.hash)null!=a&&(t[i[e]]=a),e++}let s,n,o=r.config,l=o.length,h=0,d=0,u=0,c=0,_=0,p=AssetDb.inst.metaMap;for(;;){if(null==s){if(h>=l)break;n=o[h],s=n.i,Array.isArray(s)?_=s.length:(u=s,_=0,c=1),d=0}if(0==c){if(d>=_){h++,s=null;continue}c=s[d++],c>0?(u=c,c=0):c=-c}else c--;let e=i[u+c];switch(n.t){case 0:p[e]=n;break;case 1:AtlasInfoManager.addAtlas(e,n.prefix,n.frames);break;case 2:AssetDb.inst.shaderNameMap[n.shaderName]=e;break;case 3:Loader.preLoadedMap[URL.formatURL(e)]=n}}return!t&&r.entry?ILaya.Browser.loadLib(e+r.entry):Promise.resolve()}))}}Loader.TEXT="text",Loader.JSON="json",Loader.XML="xml",Loader.BUFFER="arraybuffer",Loader.IMAGE="image",Loader.SOUND="sound",Loader.VIDEO="video",Loader.ATLAS="atlas",Loader.FONT="font",Loader.TTF="ttf",Loader.HIERARCHY="HIERARCHY",Loader.MESH="MESH",Loader.MATERIAL="MATERIAL",Loader.TEXTURE2D="TEXTURE2D",Loader.TEXTURECUBE="TEXTURE2D",Loader.TEXTURE2DARRAY="TEXTURE2D",Loader.ANIMATIONCLIP="ANIMATIONCLIP",Loader.TERRAINHEIGHTDATA="TERRAINHEIGHTDATA",Loader.TERRAINRES="TERRAIN",Loader.SPINE="SPINE",Loader.extMap={},Loader.typeMap={},Loader.downloader=new Downloader,Loader.groupMap={},Loader.loadedMap={},Loader.preLoadedMap={};class LoadTask{constructor(){this.options={},this.onProgress=new Delegate,this.onComplete=new Delegate,this.progress=new BatchProgress((e=>this.onProgress.invoke(e)))}reset(){for(let e in this.options)delete this.options[e];this.onProgress.clear(),this.onComplete.clear(),this.progress.reset(),this.obsoluteInst=null}}const Ge=[],Ve={};class MathUtil{static subtractVector3(e,t,r){r[0]=e[0]-t[0],r[1]=e[1]-t[1],r[2]=e[2]-t[2]}static lerp(e,t,r){return e*(1-r)+t*r}static scaleVector3(e,t,r){r[0]=e[0]*t,r[1]=e[1]*t,r[2]=e[2]*t}static lerpVector3(e,t,r,i){var a=e[0],s=e[1],n=e[2];i[0]=a+r*(t[0]-a),i[1]=s+r*(t[1]-s),i[2]=n+r*(t[2]-n)}static lerpVector4(e,t,r,i){var a=e[0],s=e[1],n=e[2],o=e[3];i[0]=a+r*(t[0]-a),i[1]=s+r*(t[1]-s),i[2]=n+r*(t[2]-n),i[3]=o+r*(t[3]-o)}static slerpQuaternionArray(e,t,r,i,a,s,n){var o,l,h,d,u,c=e[t+0],_=e[t+1],p=e[t+2],g=e[t+3],m=r[i+0],f=r[i+1],S=r[i+2],y=r[i+3];return(l=c*m+_*f+p*S+g*y)<0&&(l=-l,m=-m,f=-f,S=-S,y=-y),1-l>1e-6?(o=Math.acos(l),h=Math.sin(o),d=Math.sin((1-a)*o)/h,u=Math.sin(a*o)/h):(d=1-a,u=a),s[n+0]=d*c+u*m,s[n+1]=d*_+u*f,s[n+2]=d*p+u*S,s[n+3]=d*g+u*y,s}static getRotation(e,t,r,i){return Math.atan2(i-t,r-e)/Math.PI*180}static sortBigFirst(e,t){return e==t?0:t>e?1:-1}static sortSmallFirst(e,t){return e==t?0:t>e?-1:1}static sortNumBigFirst(e,t){return parseFloat(t)-parseFloat(e)}static sortNumSmallFirst(e,t){return parseFloat(e)-parseFloat(t)}static sortByKey(e,t=!1,r=!0){var i;return i=t?r?MathUtil.sortNumBigFirst:MathUtil.sortBigFirst:r?MathUtil.sortNumSmallFirst:MathUtil.sortSmallFirst,function(t,r){return i(t[e],r[e])}}}class FrameAnimation extends AnimationBase{constructor(){super(),void 0===FrameAnimation._sortIndexFun&&(FrameAnimation._sortIndexFun=MathUtil.sortByKey("index",!1,!0))}static _sortIndexFun(e,t){return e.index-t.index}_setUp(e,t){this._targetDic=e,this._animationData=t,this.interval=1e3/t.frameRate,t.parsed?(this._count=t.count,this._labels=t.labels,this._usedFrames=t.animationNewFrames):(this._usedFrames=[],this._calculateDatas(),t.parsed=!0,t.labels=this._labels,t.count=this._count,t.animationNewFrames=this._usedFrames)}clear(){return super.clear(),this._targetDic=null,this._animationData=null,this}_displayToIndex(e){if(this._animationData){e<0&&(e=0),e>this._count&&(e=this._count);var t,r=this._animationData.nodes,i=r.length;for(t=0;t<i;t++)this._displayNodeToFrame(r[t],e)}}_displayNodeToFrame(e,t,r=null){r||(r=this._targetDic);var i=r[e.target];if(i){var a,s,n,o,l=e.frames,h=e.keys,d=h.length;for(o=0;o<d;o++)n=(s=l[a=h[o]]).length>t?s[t]:s[s.length-1],i[a]=n;var u,c=e.funkeys;if(0!=(d=c.length))for(o=0;o<d;o++)void 0!==(u=l[a=c[o]])[t]&&i[a]&&i[a].apply(i,u[t])}}_calculateDatas(){if(this._animationData){var e,t,r=this._animationData.nodes,i=r.length;for(this._count=0,e=0;e<i;e++)t=r[e],this._calculateKeyFrames(t);this._count+=1}}_calculateKeyFrames(e){var t,r,i=e.keyframes,a=e.target;for(t in e.frames||(e.frames={}),e.keys?e.keys.length=0:e.keys=[],e.funkeys?e.funkeys.length=0:e.funkeys=[],e.initValues||(e.initValues={}),i){var s=-1!=t.indexOf("()");if(r=i[t],s&&(t=t.substr(0,t.length-2)),e.frames[t]||(e.frames[t]=[]),s){e.funkeys.push(t);for(var n=e.frames[t],o=0;o<r.length;o++){var l=r[o];n[l.index]=l.value,l.index>this._count&&(this._count=l.index)}}else this._targetDic&&this._targetDic[a]&&(e.initValues[t]=this._targetDic[a][t]),r.sort(FrameAnimation._sortIndexFun),e.keys.push(t),this._calculateNodePropFrames(r,e.frames[t],t,a)}}resetNodes(){if(this._targetDic&&this._animationData){var e,t,r,i=this._animationData.nodes,a=i.length;for(e=0;e<a;e++)if(r=(t=i[e]).initValues){var s,n=this._targetDic[t.target];if(n)for(s in r)n[s]=r[s]}}}_calculateNodePropFrames(e,t,r,i){var a,s=e.length-1;for(t.length=e[s].index+1,a=0;a<s;a++)this._dealKeyFrame(e[a]),this._calculateFrameValues(e[a],e[a+1],t);0==s&&(t[0]=e[0].value,this._usedFrames&&(this._usedFrames[e[0].index]=!0)),this._dealKeyFrame(e[a])}_dealKeyFrame(e){e.label&&""!=e.label&&this.addLabel(e.label,e.index)}_calculateFrameValues(e,t,r){var i,a,s=e.index,n=t.index,o=e.value,l=t.value-e.value,h=n-s,d=this._usedFrames;if(n>this._count&&(this._count=n),e.tween)for(null==(a=Ease[e.tweenMethod])&&(a=Ease.linearNone),i=s;i<n;i++)r[i]=a(i-s,o,l,h),d&&(d[i]=!0);else for(i=s;i<n;i++)r[i]=o;d&&(d[e.index]=!0,d[t.index]=!0),r[t.index]=t.value}}class GraphicAnimation extends FrameAnimation{constructor(){super(...arguments),this._nodeIDAniDic={}}_parseNodeList(e){this._nodeList||(this._nodeList=[]),this._nodeDefaultProps[e.compId]=e.props,e.compId&&this._nodeList.push(e.compId);var t=e.child;if(t){var r,i=t.length;for(r=0;r<i;r++)this._parseNodeList(t[r])}}_calGraphicData(e){var t;if(this._setUp(null,e),this._createGraphicData(),this._nodeIDAniDic)for(t in this._nodeIDAniDic)this._nodeIDAniDic[t]=null}_createGraphicData(){var e,t,r=[],i=this.count,a=this._usedFrames;for(a||(a=[]),e=0;e<i;e++)!a[e]&&t||(t=this._createFrameGraphic(e)),r.push(t);this._gList=r}_createFrameGraphic(e){var t=new Graphics;return GraphicAnimation._rootMatrix||(GraphicAnimation._rootMatrix=new Matrix),this._updateNodeGraphic(this._rootNode,e,GraphicAnimation._rootMatrix,t),t}_updateNodeGraphic(e,t,r,i,a=1){var s,n,o;(s=this._nodeGDic[e.compId]=this._getNodeGraphicData(e.compId,t,this._nodeGDic[e.compId])).resultTransform||(s.resultTransform=new Matrix),n=s.resultTransform,Matrix.mul(s.transform,r,n);var l=s.alpha*a;if(!(l<.01)){s.skin&&(o=this._getTextureByUrl(s.skin))&&(n._checkTransform()?(i.drawTexture(o,0,0,s.width,s.height,n,l),s.resultTransform=null):i.drawTexture(o,n.tx,n.ty,s.width,s.height,null,l));var h,d,u=e.child;if(u)for(d=u.length,h=0;h<d;h++)this._updateNodeGraphic(u[h],t,n,i,l)}}_updateNoChilds(e,t){if(e.skin){var r=this._getTextureByUrl(e.skin);if(r){var i=e.transform;i._checkTransform(),!i._bTransform?t.drawTexture(r,i.tx,i.ty,e.width,e.height,null,e.alpha):t.drawTexture(r,0,0,e.width,e.height,i.clone(),e.alpha)}}}_updateNodeGraphic2(e,t,r){var i;if(i=this._nodeGDic[e.compId]=this._getNodeGraphicData(e.compId,t,this._nodeGDic[e.compId]),e.child){var a,s,n,o=i.transform;o._checkTransform(),s=(a=!o._bTransform)&&(0!=o.tx||0!=o.ty),(n=o._bTransform||1!=i.alpha)&&r.save(),1!=i.alpha&&r.alpha(i.alpha),a?s&&r.translate(o.tx,o.ty):r.transform(o.clone());var l,h,d,u=e.child;if(i.skin&&(l=this._getTextureByUrl(i.skin))&&r.drawImage(l,0,0,i.width,i.height),u)for(d=u.length,h=0;h<d;h++)this._updateNodeGraphic2(u[h],t,r);n?r.restore():a?s&&r.translate(-o.tx,-o.ty):r.transform(o.clone().invert())}else this._updateNoChilds(i,r)}_calculateKeyFrames(e){super._calculateKeyFrames(e),this._nodeIDAniDic[e.target]=e}getNodeDataByID(e){return this._nodeIDAniDic[e]}_getParams(e,t,r,i){var a=GraphicAnimation._temParam;a.length=t.length;var s,n=t.length;for(s=0;s<n;s++)a[s]=this._getObjVar(e,t[s][0],r,t[s][1],i);return a}_getObjVar(e,t,r,i,a){if(t in e){var s=e[t];return r>=s.length&&(r=s.length-1),e[t][r]}return t in a?a[t]:i}_getNodeGraphicData(e,t,r){r||(r=new GraphicNode),r.transform?r.transform.identity():r.transform=new Matrix;var i=this.getNodeDataByID(e);if(!i)return r;var a,s,n,o=i.frames,l=this._getParams(o,GraphicAnimation._drawTextureCmd,t,this._nodeDefaultProps[e]),h=l[0],d=l[5],u=l[6],c=l[13],_=l[14],p=l[7],g=l[8],m=l[9],f=l[11],S=l[12];a=l[3],s=l[4],0!=a&&0!=s||(h=null),-1==a&&(a=0),-1==s&&(s=0),r.skin=h,r.width=a,r.height=s,h&&((n=this._getTextureByUrl(h))?(a||(a=n.sourceWidth),s||(s=n.sourceHeight)):console.warn("lost skin:",h,",you may load pics first")),r.alpha=l[10];var y=r.transform;0!=c&&(d=c*a),0!=_&&(u=_*s),0==d&&0==u||y.translate(-d,-u);var T=null;if(m||1!==p||1!==g||f||S){(T=GraphicAnimation._tempMt).identity(),T._bTransform=!0;var x=.0174532922222222*(m-f),D=.0174532922222222*(m+S),v=Math.cos(D),C=Math.sin(D),E=Math.sin(x),R=Math.cos(x);T.a=p*v,T.b=p*C,T.c=-g*E,T.d=g*R,T.tx=T.ty=0}return T&&(y=Matrix.mul(y,T,y)),y.translate(l[1],l[2]),r}_getTextureByUrl(e){return Loader.getRes(e)}setAniData(e,t=null){if(e.animations){this._nodeDefaultProps={},this._nodeGDic={},this._nodeList&&(this._nodeList.length=0),this._rootNode=e,this._parseNodeList(e);var r,i,a={},s=[],n=e.animations,o=n.length;for(r=0;r<o;r++)if(i=n[r],this._labels=null,(!t||t==i.name)&&i){try{this._calGraphicData(i)}catch(e){console.warn("parse animation fail:"+i.name+",empty animation created"),this._gList=[]}var l={};l.interval=1e3/i.frameRate,l.frames=this._gList,l.labels=this._labels,l.name=i.name,s.push(l),a[i.name]=l}this.animationList=s,this.animationDic=a}GraphicAnimation._temParam.length=0}parseByData(e){var t,r;t=e.nodeRoot,r=e.aniO,delete e.nodeRoot,delete e.aniO,this._nodeDefaultProps={},this._nodeGDic={},this._nodeList&&(this._nodeList.length=0),this._rootNode=t,this._parseNodeList(t),this._labels=null;try{this._calGraphicData(r)}catch(e){console.warn("parse animation fail:"+r.name+",empty animation created"),this._gList=[]}var i=e;return i.interval=1e3/r.frameRate,i.frames=this._gList,i.labels=this._labels,i.name=r.name,i}setUpAniData(e){if(e.animations){var t,r,i={},a=[],s=e.animations,n=s.length;for(t=0;t<n;t++)if(r=s[t]){var o={};o.name=r.name,o.aniO=r,o.nodeRoot=e,a.push(o),i[r.name]=o}this.animationList=a,this.animationDic=i}}_clear(){this.animationList=null,this.animationDic=null,this._gList=null,this._nodeGDic=null}static parseAnimationByData(e){var t;return GraphicAnimation._I||(GraphicAnimation._I=new GraphicAnimation),t=GraphicAnimation._I.parseByData(e),GraphicAnimation._I._clear(),t}static parseAnimationData(e){var t;return GraphicAnimation._I||(GraphicAnimation._I=new GraphicAnimation),GraphicAnimation._I.setUpAniData(e),(t={}).animationList=GraphicAnimation._I.animationList,t.animationDic=GraphicAnimation._I.animationDic,GraphicAnimation._I._clear(),t}}GraphicAnimation._drawTextureCmd=[["skin",null],["x",0],["y",0],["width",-1],["height",-1],["pivotX",0],["pivotY",0],["scaleX",1],["scaleY",1],["rotation",0],["alpha",1],["skewX",0],["skewY",0],["anchorX",0],["anchorY",0]],GraphicAnimation._temParam=[],GraphicAnimation._tempMt=new Matrix;class GraphicNode{constructor(){this.alpha=1}}class Animation extends AnimationBase{constructor(){super(),this._autoPlay=!1,this._setControlNode(this)}destroy(e=!0){this.stop(),super.destroy(e),this._frames=null,this._labels=null}play(e=0,t=!0,r=""){r&&this._setFramesFromCache(r,!0),super.play(e,t,r)}_setFramesFromCache(e,t=!1){if(this._url&&(e=this._url+"#"+e),e&&Animation.framesMap[e]){var r=Animation.framesMap[e];return r instanceof Array?(this._frames=Animation.framesMap[e],this._count=this._frames.length):(r.nodeRoot&&(Animation.framesMap[e]=GraphicAnimation.parseAnimationByData(r),r=Animation.framesMap[e]),this._frames=r.frames,this._count=this._frames.length,this._frameRateChanged||(this._interval=r.interval),this._labels=this._copyLabels(r.labels)),!0}return t&&console.log("ani not found:",e),!1}_copyLabels(e){if(!e)return null;var t,r;for(r in t={},e)t[r]=Utils.copyArray([],e[r]);return t}_frameLoop(){this._visible&&this._style.alpha>.01&&this._frames&&super._frameLoop()}_displayToIndex(e){this._frames&&(this.graphics=this._frames[e])}get frames(){return this._frames}set frames(e){this._frames=e,e&&(this._count=e.length,this._actionName&&this._setFramesFromCache(this._actionName,!0),this.index=this._index)}get source(){return this._source}set source(e){this._source=e,e?e.indexOf(".ani")>-1?this.loadAnimation(e):e.startsWith("res://")||e.indexOf(".json")>-1||e.indexOf("als")>-1||e.indexOf("atlas")>-1?this.loadAtlas(e):this.loadImages(e.split(",")):this.clear()}set autoPlay(e){this._autoPlay=e,e?this.play():this.stop()}get autoPlay(){return this._autoPlay}clear(){return super.clear(),this.stop(),this.graphics=null,this._frames=null,this._labels=null,this}loadImages(e,t=""){return this._url="",this._setFramesFromCache(t)||(this.frames=Animation.framesMap[t]?Animation.framesMap[t]:Animation.createFrames(e,t)),!this._isPlaying&&this._autoPlay&&this.play(),this}loadAtlas(e,t=null,r=""){if(this._url="",!this._setFramesFromCache(r)){let onLoaded=i=>{e===i&&(this.frames=Animation.framesMap[r]?Animation.framesMap[r]:Animation.createFrames(e,r),!this._isPlaying&&this._autoPlay&&this.play(),t&&t.run())};Loader.getAtlas(e)?onLoaded(e):ILaya.loader.load(e,Handler.create(null,onLoaded,[e]),null,Loader.ATLAS)}return this}loadAnimation(e,t=null,r=null){this._url=e;return this._actionName||(this._actionName=""),this._setFramesFromCache(this._actionName)?(this._setFramesFromCache(this._actionName,!0),this.index=0,t&&t.run()):!r||Loader.getAtlas(r)?this._loadAnimationData(e,t,r):ILaya.loader.load(r,Handler.create(this,this._loadAnimationData,[e,t,r]),null,Loader.ATLAS),this}_loadAnimationData(e,t=null,r=null){!r||Loader.getAtlas(r)?ILaya.loader.fetch(e,"json").then((r=>{if(this._url!==e)return;if(!r)return void(Animation.framesMap[e+"#"]&&(this._setFramesFromCache(this._actionName,!0),this.index=0,this._resumePlay(),t&&t.run()));let i;if(Animation.framesMap[e+"#"])this._setFramesFromCache(this._actionName,!0),this.index=0,this._resumePlay();else{let t=GraphicAnimation.parseAnimationData(r);if(!t)return;let a,s=t.animationList,n=s.length;for(let t=0;t<n;t++)i=s[t],Animation.framesMap[e+"#"+i.name]=i,a||(a=i);a&&(Animation.framesMap[e+"#"]=a,this._setFramesFromCache(this._actionName,!0),this.index=0),this._resumePlay()}t&&t.run()})):console.warn("atlas load fail:"+r)}static createFrames(e,t){var r;if("string"==typeof e){var i=Loader.getAtlas(e);if(i&&i.frames.length){let e=i.frames;r=[];for(var a=0,s=e.length;a<s;a++){var n=new Graphics;n.drawImage(e[a],0,0),r.push(n)}}}else if(e instanceof Array)for(r=[],a=0,s=e.length;a<s;a++)(n=new Graphics).loadImage(e[a],0,0),r.push(n);return t&&(Animation.framesMap[t]=r),r}static clearCache(e){var t,r=Animation.framesMap,i=e+"#";for(t in r)t!==e&&0!==t.indexOf(i)||delete Animation.framesMap[t]}onAfterDeserialize(){super.onAfterDeserialize(),this.images&&(this._source||this.loadImages(this.images),delete this.images)}}Animation.framesMap={};class BitmapFont extends Resource{constructor(){super(!1),this.dict={},this.fontSize=12,this.autoScaleSize=!1,this.tint=!0,this.maxWidth=0,this.lineHeight=12,this.letterSpacing=0}static loadFont(e,t){ILaya.loader.load(e,Loader.FONT).then((e=>{t&&t.runWith(e)}))}parseFont(e,t){var r;if(null==e||null==t)return;this.texture=t,t._addReference();let i=e.getNode("info");this.fontSize=i.getAttrInt("size",12),this.autoScaleSize=i.getAttrBool("autoScaleSize"),this.lineHeight=i.getAttrInt("lineHeight",this.fontSize),0==this.lineHeight&&(this.lineHeight=this.fontSize);let a=i.getAttrString("padding","").split(",");this.padding=[parseInt(a[0]),parseInt(a[1]),parseInt(a[2]),parseInt(a[3])];let s=(null===(r=e.getNode("chars"))||void 0===r?void 0:r.elements("char"))||[],n=0,o=this.dict;for(let e=0,r=s.length;e<r;e++){let r=s[e],i=r.getAttrInt("id"),a=r.getAttrInt("xoffset")/1,l=r.getAttrInt("yoffset")/1,h=r.getAttrInt("xadvance")/1,d=r.getAttrInt("x"),u=r.getAttrInt("y"),c=r.getAttrInt("width"),_=r.getAttrInt("height"),p=Texture.create(t,d,u,c,_,a,l);0==h&&(h=c),h+=this.letterSpacing,n=Math.max(n,h),o[i]={x:0,y:0,width:c,height:_,advance:h,texture:p}}this.maxWidth=n>0?n:this.fontSize,o[32]||(o[32]={x:0,y:0,advance:Math.floor(.5*this.fontSize)+this.letterSpacing})}_disposeResource(){var e;if(this.texture){for(let t in this.dict)null===(e=this.dict[t].texture)||void 0===e||e.destroy();this.texture._removeReference(),this.dict=null,this.texture=null,this.padding=null}}getTextWidth(e,t){let r=0;for(let i=0,a=e.length;i<a;i++){let a=this.dict[e.charCodeAt(i)];if(a){let e=this.autoScaleSize?t/this.fontSize:1;r+=Math.round(a.advance*e)}}return r}getMaxWidth(e){return null!=e&&this.autoScaleSize?Math.round(this.maxWidth*(e/this.fontSize)):this.maxWidth}getMaxHeight(e){return null!=e&&this.autoScaleSize?Math.round(this.lineHeight*(e/this.fontSize)):this.lineHeight}}class EffectAnimation extends FrameAnimation{constructor(){super(...arguments),this._initData={}}set target(e){this._target&&this._target.off(EffectAnimation.EFFECT_BEGIN,this,this._onOtherBegin),this._target=e,this._target&&this._target.on(EffectAnimation.EFFECT_BEGIN,this,this._onOtherBegin),this._addEvent()}get target(){return this._target}_onOtherBegin(e){e!==this&&this.stop()}set playEvent(e){this._playEvent=e,e&&this._addEvent()}_addEvent(){this._target&&this._playEvent&&(this._setControlNode(this._target),this._target.on(this._playEvent,this,this._onPlayAction))}_onPlayAction(){this.play(0,!1)}play(e=0,t=!0,r=""){this._target&&(this._target.event(EffectAnimation.EFFECT_BEGIN,[this]),this._recordInitData(),super.play(e,t,r))}_recordInitData(){var e,t,r;if(this._aniKeys)for(t=this._aniKeys.length,e=0;e<t;e++)r=this._aniKeys[e],this._initData[r]=this._target[r]}set effectClass(e){if(this._effectClass=ClassUtils.getClass(e),this._effectClass){var t=this._effectClass.uiView;if(t){var r=t.animations;if(r&&r[0]){var i=r[0];this._setUp({},i),i.nodes&&i.nodes[0]&&(this._aniKeys=i.nodes[0].keys)}}}}set effectData(e){if(e){var t=e.animations;if(t&&t[0]){var r=t[0];this._setUp({},r),r.nodes&&r.nodes[0]&&(this._aniKeys=r.nodes[0].keys)}}}_displayToIndex(e){if(this._animationData){e<0&&(e=0),e>this._count&&(e=this._count);var t,r=this._animationData.nodes,i=r.length;for(i=i>1?1:i,t=0;t<i;t++)this._displayNodeToFrame(r[t],e)}}_displayNodeToFrame(e,t,r=null){if(this._target){var i,a,s,n,o,l,h,d,u,c=this._target,_=e.frames,p=e.keys,g=p.length,m=e.secondFrames;for(n=0;n<g;n++)a=_[i=p[n]],-1==(o=m[i])?s=this._initData[i]:t<o?(d=(h=e.keyframes[i])[0]).tween?(null==(l=Ease[d.tweenMethod])&&(l=Ease.linearNone),u=h[1],s=l(t,this._initData[i],u.value-this._initData[i],u.index)):s=this._initData[i]:s=a.length>t?a[t]:a[a.length-1],c[i]=s}}_calculateKeyFrames(e){super._calculateKeyFrames(e);var t,r,i=e.keyframes;e.target;var a={};for(t in e.secondFrames=a,i)(r=i[t]).length<=1?a[t]=-1:a[t]=r[1].index}}EffectAnimation.EFFECT_BEGIN="effectbegin";class TextStyle{constructor(){this.font="",this.fontSize=12,this.color="#000000",this.bold=!1,this.italic=!1,this.underline=!1,this.underlineColor=null,this.align="left",this.valign="top",this.leading=2,this.stroke=0,this.strokeColor="#000000",this.font="",this.fontSize=12,this.color="#000000",this.bold=!1,this.italic=!1,this.underline=!1,this.underlineColor=null,this.align="left",this.valign="top",this.alignItems="middle",this.leading=2,this.stroke=0,this.strokeColor="#000000"}}var ke;e.HtmlElementType=void 0,(ke=e.HtmlElementType||(e.HtmlElementType={}))[ke.Text=0]="Text",ke[ke.Link=1]="Link",ke[ke.Image=2]="Image",ke[ke.Input=3]="Input",ke[ke.Select=4]="Select",ke[ke.Object=5]="Object",ke[ke.LinkEnd=6]="LinkEnd";class HtmlElement{constructor(){this.style=new TextStyle}getAttr(e){return null==this._attrs?null:this._attrs[e]}setAttr(e,t){null==this._attrs&&(this._attrs={}),this._attrs[e]=t}getAttrString(e,t){return XMLUtils.getString(this._attrs,e,t)}getAttrInt(e,t){return XMLUtils.getInt(this._attrs,e,t)}getAttrFloat(e,t){return XMLUtils.getFloat(this._attrs,e,t)}getAttrBool(e,t){return XMLUtils.getBool(this._attrs,e,t)}fetchAttributes(){this._attrs=Object.assign({},XMLIterator.attributes)}reset(){this.name=null,this.text=null,this.obj&&(this.obj.release(),Pool.recoverByClass(this.obj),this.obj=null),this._attrs=null}static getFromPool(t){let r;return r=this.pool.length>0?this.pool.pop():new HtmlElement,r.type=t,r.type==e.HtmlElementType.Text||r._attrs||(r._attrs={}),r}static returnToPool(e){if(Array.isArray(e)){for(let t of e)t.reset();this.pool.push(...e),e.length=0}else e.reset(),this.pool.push(e)}}HtmlElement.pool=[];class HtmlImage{constructor(){this.obj=new Sprite}get element(){return this._element}get width(){return this.obj.width}get height(){return this.obj.height}create(e,t){this._owner=e,this._element=t,this._owner.objContainer.addChild(this.obj);let r=this._element.getAttrString("src");r&&this.loadTexture(r)}loadTexture(e){let t=this._element.getAttrInt("width",-1),r=this._element.getAttrInt("height",-1);-1!=t&&(this.obj.width=t),-1!=r&&(this.obj.height=r);let i=Loader.getRes(e);i?(this.obj.texture=i,-1==t&&(this.obj.width=i.sourceWidth),-1==r&&(this.obj.height=i.sourceHeight)):ILaya.loader.load(e,{silent:!0}).then((e=>{if(this.obj.destroyed)return;let i=this.obj.width,a=this.obj.height;this.obj.texture=e,-1==t&&(this.obj.width=e?e.sourceWidth:0),-1==r&&(this.obj.height=e?e.sourceHeight:0),!this._owner||i==this.obj.width&&a==this.obj.height||this._owner.refreshLayout()}))}pos(e,t){this.obj.pos(e,t)}release(){this.obj.removeSelf(),this.obj.offAll(),this.obj.texture=null,this._owner=null,this._element=null}destroy(){this.obj.destroy()}}class HtmlLink{constructor(){this._shape=new Sprite,this._shape.hitArea=this,this._shape.on(Event.CLICK,(()=>{this._owner.bubbleEvent(Event.LINK,this._element.getAttrString("href"))})),this._rects=[],this._rectCnt=0}get element(){return this._element}get width(){return 0}get height(){return 0}create(e,t){this._owner=e,this._element=t,this._owner.objContainer.addChild(this._shape)}resetArea(){this._rectCnt=0}addRect(e,t,r,i){let a=this._rects[this._rectCnt];a||(a=this._rects[this._rectCnt]=new Rectangle),this._rectCnt++,a.setTo(e,t,r,i)}contains(e,t){for(let r=0;r<this._rectCnt;r++)if(this._rects[r].contains(e,t))return!0;return!1}pos(e,t){}release(){this._shape.removeSelf(),this._owner=null,this._element=null}destroy(){this._shape.destroy()}}class HtmlParseOptions{constructor(){this.linkUnderline=HtmlParseOptions.defaultLinkUnderline,this.linkColor=HtmlParseOptions.defaultLinkColor}}HtmlParseOptions.defaultLinkUnderline=!0,HtmlParseOptions.defaultLinkColor=null,ClassUtils.regClass("HtmlParseOptions",HtmlParseOptions);const He=new Array,We=new Array;class HtmlParser{constructor(){this._styleStack=new Array,this._style=new TextStyle,this._options=new HtmlParseOptions}parse(t,r,i,a){null==a&&(a=this._options),this._elements=i,this._styleStackTop=0,Object.assign(this._style,r),this._style.colorChanged=!1;let s,n=0,o=a.ignoreWhiteSpace,l=!1;for(XMLIterator.begin(t,!0);XMLIterator.nextTag();)switch(0==n&&(s=XMLIterator.getText(o),s.length>0&&(l&&"\n"==s[0]&&(s=s.substring(1)),this.appendText(s))),l=!1,XMLIterator.tagName){case"b":XMLIterator.tagType==e.XMLTagType.Start?(this.pushStyle(),this._style.bold=!0):this.popStyle();break;case"i":XMLIterator.tagType==e.XMLTagType.Start?(this.pushStyle(),this._style.italic=!0):this.popStyle();break;case"u":XMLIterator.tagType==e.XMLTagType.Start?(this.pushStyle(),this._style.underline=!0):this.popStyle();break;case"strike":XMLIterator.tagType==e.XMLTagType.Start?(this.pushStyle(),this._style.strikethrough=!0):this.popStyle();break;case"font":if(XMLIterator.tagType==e.XMLTagType.Start){this.pushStyle(),this._style.fontSize=XMLUtils.getInt(XMLIterator.attributes,"size",this._style.fontSize);let e=XMLIterator.getAttribute("color");null!=e&&(this._style.color=e,this._style.colorChanged=!0)}else XMLIterator.tagType==e.XMLTagType.End&&this.popStyle();break;case"br":this.appendText("\n");break;case"img":if(XMLIterator.tagType==e.XMLTagType.Start||XMLIterator.tagType==e.XMLTagType.Void){let t=HtmlElement.getFromPool(e.HtmlElementType.Image);t.fetchAttributes(),t.name=t.getAttrString("name"),t.style.align=this._style.align,t.style.underline=this._style.underline,t.style.underlineColor=this._style.underlineColor,this._elements.push(t)}break;case"a":if(XMLIterator.tagType==e.XMLTagType.Start){this.pushStyle(),this._style.underline=this._style.underline||a.linkUnderline,this._style.colorChanged||null==a.linkColor||(this._style.color=a.linkColor);let t=HtmlElement.getFromPool(e.HtmlElementType.Link);t.fetchAttributes(),t.name=t.getAttrString("name"),t.style.align=this._style.align,this._elements.push(t)}else if(XMLIterator.tagType==e.XMLTagType.End){this.popStyle();let t=HtmlElement.getFromPool(e.HtmlElementType.LinkEnd);this._elements.push(t)}break;case"input":{let t=HtmlElement.getFromPool(e.HtmlElementType.Input);t.fetchAttributes(),t.name=t.getAttrString("name"),Object.assign(t.style,this._style),this._elements.push(t)}break;case"select":if(XMLIterator.tagType==e.XMLTagType.Start||XMLIterator.tagType==e.XMLTagType.Void){let t=HtmlElement.getFromPool(e.HtmlElementType.Select);if(t.fetchAttributes(),XMLIterator.tagType==e.XMLTagType.Start){for(He.length=0,We.length=0;XMLIterator.nextTag()&&"select"!=XMLIterator.tagName;)"option"==XMLIterator.tagName&&(XMLIterator.tagType==e.XMLTagType.Start||XMLIterator.tagType==e.XMLTagType.Void?We.push(XMLUtils.getString(XMLIterator.attributes,"value","")):He.push(XMLIterator.getText()));t.setAttr("items",He.slice()),t.setAttr("values",We.slice())}t.name=t.getAttrString("name"),Object.assign(t.style,this._style),this._elements.push(t)}break;case"p":XMLIterator.tagType==e.XMLTagType.Start?(this.pushStyle(),this._style.align=XMLIterator.getAttribute("align"),this.isNewLine()||this.appendText("\n")):XMLIterator.tagType==e.XMLTagType.End&&(this.appendText("\n"),l=!0,this.popStyle());break;case"ui":case"div":case"li":XMLIterator.tagType==e.XMLTagType.Start?this.isNewLine()||this.appendText("\n"):(this.appendText("\n"),l=!0);break;case"html":case"body":o=!0;break;case"head":case"style":case"script":case"form":XMLIterator.tagType==e.XMLTagType.Start?n++:XMLIterator.tagType==e.XMLTagType.End&&n--}0==n&&(s=XMLIterator.getText(o),s.length>0&&(l&&"\n"==s[0]&&(s=s.substring(1)),this.appendText(s))),this._elements=null}pushStyle(){let e;this._styleStack.length<=this._styleStackTop?(e=new TextStyle,this._styleStack.push(e)):e=this._styleStack[this._styleStackTop],Object.assign(e,this._style),this._styleStackTop++}popStyle(){if(this._styleStackTop>0){let e=this._styleStack[this._styleStackTop-1];Object.assign(this._style,e),this._styleStackTop--}}isNewLine(){if(this._elements.length>0){let t=this._elements[this._elements.length-1];return!(!t||t.type!=e.HtmlElementType.Text)&&t.text.endsWith("\n")}return!0}appendText(t){let r;this._elements.length>0&&(r=this._elements[this._elements.length-1],r.type==e.HtmlElementType.Text&&function(e,t){for(let r in e)if(!r.startsWith("_")&&e[r]!=t[r])return!1;return!0}(r.style,this._style))?r.text+=t:(r=HtmlElement.getFromPool(e.HtmlElementType.Text),r.text=t,Object.assign(r.style,this._style),this._elements.push(r))}}HtmlParser.defaultParser=new HtmlParser,HtmlParser.classMap={[e.HtmlElementType.Image]:HtmlImage,[e.HtmlElementType.Link]:HtmlLink};class UBBParser{constructor(){this._readPos=0,this.defaultImgWidth=0,this.defaultImgHeight=0,this._handlers={},this._handlers.url=this.onTag_URL,this._handlers.img=this.onTag_IMG,this._handlers.b=this.onTag_B,this._handlers.i=this.onTag_I,this._handlers.u=this.onTag_U,this._handlers.sup=this.onTag_Simple,this._handlers.sub=this.onTag_Simple,this._handlers.color=this.onTag_COLOR,this._handlers.font=this.onTag_FONT,this._handlers.size=this.onTag_SIZE}onTag_URL(e,t,r){return t?"</a>":null!=r?'<a href="'+r+'">':'<a href="'+this.getTagText()+'">'}onTag_IMG(e,t,r){if(t)return null;var i=this.getTagText(!0);return i?this.defaultImgWidth?'<img src="'+i+'" width="'+this.defaultImgWidth+'" height="'+this.defaultImgHeight+'"/>':'<img src="'+i+'"/>':null}onTag_B(e,t,r){return t?"</b>":"<b>"}onTag_I(e,t,r){return t?"</i>":"<i>"}onTag_U(e,t,r){return t?"</u>":"<u>"}onTag_Simple(e,t,r){return t?"</"+e+">":"<"+e+">"}onTag_COLOR(e,t,r){return t?"</font>":(this.lastColor=r,'<font color="'+r+'">')}onTag_FONT(e,t,r){return t?"</font>":'<font face="'+r+'">'}onTag_SIZE(e,t,r){return t?"</font>":(this.lastSize=r,'<font size="'+r+'">')}getTagText(e){for(var t,r=this._readPos,i="";-1!=(t=this._text.indexOf("[",r));){if(92!=this._text.charCodeAt(t-1)){i+=this._text.substring(r,t);break}i+=this._text.substring(r,t-1),i+="[",r=t+1}return-1==t?null:(e&&(this._readPos=t),i)}parse(e,t){this._text=e,this.lastColor=null,this.lastSize=null;for(var r,i,a,s,n,o,l,h=0,d="";-1!=(r=e.indexOf("[",h));)if(r>0&&92==e.charCodeAt(r-1))d+=e.substring(h,r-1),d+="[",h=r+1;else{if(d+=e.substring(h,r),h=r,-1==(r=e.indexOf("]",h)))break;a="/"==e.charAt(h+1),s=e.substring(a?h+2:h+1,r),this._readPos=r+1,n=null,o=null,-1!=(i=s.indexOf("="))&&(n=s.substring(i+1),s=s.substring(0,i)),s=s.toLowerCase(),null!=(l=this._handlers[s])?t||null!=(o=l.call(this,s,a,n))&&(d+=o):d+=e.substring(h,this._readPos),h=this._readPos}return h<e.length&&(d+=e.substring(h)),this._text=null,d}}UBBParser.defaultParser=new UBBParser;class Text extends Sprite{constructor(){super(),this._overflow=Text.VISIBLE,this._singleCharRender=!1,this._prompt="",this._textWidth=0,this._textHeight=0,this._textStyle=new TextStyle,this._textStyle.fontSize=Config.defaultFontSize,this._text="",this.font="",this._elements=[],this._lines=[],this._padding=[0,0,0,0],this._fontSizeScale=1}static registerBitmapFont(e,t){t._addReference(),Text._bitmapFonts[e]=t}static unregisterBitmapFont(e,t=!0){let r=Text._bitmapFonts[e];r&&(r._removeReference(),t&&r.destroy(),delete Text._bitmapFonts[e])}destroy(e=!0){recoverLines(this._lines),HtmlElement.returnToPool(this._elements),super.destroy(e)}_getBoundPointsM(e=!1){var t=Rectangle.TEMP;return t.setTo(0,0,this.width,this.height),t._getBoundPoints()}getGraphicBounds(e=!1){var t=Rectangle.TEMP;return t.setTo(0,0,this.width,this.height),t}get_width(){return this._isWidthSet?this._width:this.textWidth}_setWidth(e){super._setWidth(e),this._updatingLayout?this.drawBg():this.markChanged()}get_height(){return this._isHeightSet?this._height:this.textHeight}_setHeight(e){super._setHeight(e),this._updatingLayout?this.drawBg():this.markChanged()}get textWidth(){return this.typeset(),this._textWidth}get textHeight(){return this.typeset(),this._textHeight}get text(){return this._text}set text(e){null==e?e="":"string"!=typeof e&&(e=""+e),!this.ignoreLang&&Text.langPacks&&(e=Text.langPacks[e]||e),this._text!=e&&(this._text=e,this.markChanged(),this.event(Event.CHANGE))}changeText(e){this.text=e}get font(){return this._textStyle.font}set font(e){if(this._textStyle.font=e,e||(e=Config.defaultFont)||(e="Arial"),this._realFont=e,this._bitmapFont=Text._bitmapFonts[e],this._bitmapFont)this._text&&this.markChanged();else if(e&&(Utils.getFileExtension(e)||e.startsWith("res://"))){let t=e,r=ILaya.loader.getRes(e);!r||r.obsolute?ILaya.loader.load(e).then((e=>{e&&this._realFont==t&&(e instanceof BitmapFont?this._bitmapFont=e:this._realFont=e.family,this._text&&this.markChanged())})):(r instanceof BitmapFont?this._bitmapFont=r:this._realFont=r.family,this._text&&this.markChanged())}else this._realFont=ILaya.Browser.onIPhone&&Config.fontFamilyMap[e]||e,this._text&&this.markChanged()}get fontSize(){return this._textStyle.fontSize}set fontSize(e){this._textStyle.fontSize!=e&&(this._textStyle.fontSize=e,this.markChanged())}get color(){return this._textStyle.color}set color(e){this.set_color(e)}set_color(e){this._textStyle.color!=e&&(this._textStyle.color=e,!this._isChanged&&this._graphics&&0==this._elements.length?this._graphics.replaceTextColor(this._textStyle.color):this.markChanged())}get bold(){return this._textStyle.bold}set bold(e){this._textStyle.bold!=e&&(this._textStyle.bold=e,this.markChanged())}get italic(){return this._textStyle.italic}set italic(e){this._textStyle.italic!=e&&(this._textStyle.italic=e,this.markChanged())}get align(){return this._textStyle.align}set align(e){this._textStyle.align!=e&&(this._textStyle.align=e,this.markChanged())}get valign(){return this._textStyle.valign}set valign(e){this._textStyle.valign!=e&&(this._textStyle.valign=e,this.markChanged())}get alignItems(){return this._textStyle.alignItems}set alignItems(e){this._textStyle.alignItems!=e&&(this._textStyle.alignItems=e,this.markChanged())}get wordWrap(){return this._wordWrap}set wordWrap(e){this._wordWrap!=e&&(this._wordWrap=e,this.markChanged())}get leading(){return this._textStyle.leading}set leading(e){this._textStyle.leading!=e&&(this._textStyle.leading=e,this.markChanged())}get padding(){return this._padding}set padding(e){if("string"==typeof e){let t=e.split(",");this._padding.length=0;for(let e=0;e<4;e++){let r=parseFloat(t[e]);isNaN(r)&&(r=0),this._padding.push(r)}}else this._padding=e;this.markChanged()}get bgColor(){return this._bgColor}set bgColor(e){this._bgColor=e,this.drawBg()}get borderColor(){return this._borderColor}set borderColor(e){this._borderColor=e,this.drawBg()}get stroke(){return this._textStyle.stroke}set stroke(e){this._textStyle.stroke!=e&&(this._textStyle.stroke=e,this.markChanged())}get strokeColor(){return this._textStyle.strokeColor}set strokeColor(e){this._textStyle.strokeColor!=e&&(this._textStyle.strokeColor=e,this.markChanged())}get overflow(){return this._overflow}set overflow(e){this._overflow!=e&&(this._overflow=e,this.markChanged())}get underline(){return this._textStyle.underline}set underline(e){this._textStyle.underline!=e&&(this._textStyle.underline=e,this.markChanged())}get underlineColor(){return this._textStyle.underlineColor}set underlineColor(e){this._textStyle.underlineColor!=e&&(this._textStyle.underlineColor=e,this.markChanged())}get singleCharRender(){return this._singleCharRender}set singleCharRender(e){this._singleCharRender=e}get html(){return this._html}set html(e){this._html!=e&&(this._html=e,this.markChanged())}get ubb(){return this._ubb}set ubb(e){this._ubb!=e&&(this._ubb=e,this.markChanged())}get maxWidth(){return this._maxWidth}set maxWidth(e){this._maxWidth!=e&&(this._maxWidth=e,this.markChanged())}get htmlParseOptions(){return this._htmlParseOptions}set htmlParseOptions(e){this._htmlParseOptions=e}parseTemplate(e){let t,r,i,a,s=0,n="";for(;-1!=(t=e.indexOf("{",s));)if(t>0&&92==e.charCodeAt(t-1))n+=e.substring(s,t-1),n+="{",s=t+1;else{if(n+=e.substring(s,t),s=t,t=e.indexOf("}",s),-1==t)break;t!=s+1?(i=e.substring(s+1,t),r=i.indexOf("="),-1!=r?(a=this._templateVars[i.substring(0,r)],n+=null==a?i.substring(r+1):a):(a=this._templateVars[i],null!=a&&(n+=a)),s=t+1):(n+=e.substring(s,s+2),s=t+1)}return s<e.length&&(n+=e.substring(s)),n}get templateVars(){return this._templateVars}set templateVars(e){(this._templateVars||e)&&(this._templateVars=!0===e?{}:!1===e?null:e,this.markChanged())}setVar(e,t){return this._templateVars||(this._templateVars={}),this._templateVars[e]=t,this.markChanged(),this}set scrollX(e){if(this.typeset(),!this._scrollPos)return;let t=this.maxScrollX;e=(e=e<0?0:e)>t?t:e,this._scrollPos.x=e,this.renderText()}get scrollX(){return this._scrollPos?this._scrollPos.x:0}set scrollY(e){if(this.typeset(),!this._scrollPos)return;let t=this.maxScrollY;e=(e=e<0?0:e)>t?t:e,this._scrollPos.y=e,this.renderText()}get scrollY(){return this._scrollPos?this._scrollPos.y:0}get maxScrollX(){let e=this.textWidth-this._width;return e<0?0:e}get maxScrollY(){let e=this.textHeight-this._height;return e<0?0:e}get lines(){return this.typeset(),this._lines}markChanged(){this._isChanged||(this._isChanged=!0,ILaya.systemTimer.callLater(this,this._typeset))}typeset(){this._isChanged&&ILaya.systemTimer.runCallLater(this,this._typeset)}refreshLayout(){ILaya.systemTimer.callLater(this,this.doLayout)}get objContainer(){return this._objContainer||(this._objContainer=new Sprite,this._objContainer.hideFlags|=HideFlags.HideAndDontSave,this.addChild(this._objContainer)),this._objContainer}_typeset(){if(this._isChanged=!1,this._hideText||this._destroyed)return;HtmlElement.returnToPool(this._elements),this._objContainer&&this._objContainer.removeChildren();let t,r=this._text;if(!r&&this._prompt&&(r=this._prompt,t=!0),!r)return this.graphics.clear(!0),this.drawBg(),this._textWidth=this._textHeight=0,this._scrollPos=null,void(this._onPostLayout&&(this._updatingLayout=!0,this._onPostLayout(),this._updatingLayout=!1));let i,a=this._html;if(r=r.replace(Ke,"\n"),this._parseEscapeChars&&(r=r.replace(qe,getReplaceStr)),!t&&this._templateVars&&(r=this.parseTemplate(r)),this._ubb&&(r=UBBParser.defaultParser.parse(r),a=!0),!t&&this._asPassword&&(r=Text._passwordChar.repeat(r.length)),t&&(i=this._textStyle.color,this._textStyle.color=this._promptColor),a)HtmlParser.defaultParser.parse(r,this._textStyle,this._elements,this._htmlParseOptions);else{let t=HtmlElement.getFromPool(e.HtmlElementType.Text);Object.assign(t.style,this._textStyle),t.text=r,this._elements.push(t)}t&&(this._textStyle.color=i),this.doLayout()}doLayout(){if(this._destroyed)return;this._updatingLayout=!0,this._fontSizeScale=1;let t,r=this._wordWrap||this._overflow==Text.ELLIPSIS,i=this._padding;if(t=this._isWidthSet?this._width-i[3]-i[1]:Number.MAX_VALUE,this._maxWidth>0){let e=this._maxWidth-i[3]-i[1];(!r||e<t)&&(t=e),r=!0}let a,s,n,o,l,h,d,u=this._isHeightSet?this._height-i[0]-i[2]:Number.MAX_VALUE,c=this._bitmapFont,_="middle"==this._textStyle.alignItems?1:"bottom"==this._textStyle.alignItems?2:0,getTextWidth=e=>{if(c)return c.getTextWidth(e,d);{let t=ILaya.Browser.context.measureText(e);return t?t.width:100}},buildLines=(e,t)=>{if(c)l=c.getMaxWidth(d),h=c.getMaxHeight(d);else{let e=(t.italic?"italic ":"")+(t.bold?"bold ":"")+d+"px "+this._realFont;t._ctxFont=e,ILaya.Browser.context.font=e;let r=ILaya.Browser.context.measureText(Text._testWord);r?(l=r.width,h=Math.ceil(r.height||d)):(l=100,h=d)}let i=e.split("\n");if(r)for(let e=0,r=i.length;e<r;e++){let a=i[e];a.length>0&&wrapText(a,t),e!=r-1&&(endLine(),startLine())}else for(let e=0,r=i.length;e<r;e++){let a=i[e];a.length>0&&addCmd(a,t,null),e!=r-1&&(endLine(),startLine())}},addCmd=(e,t,r)=>{let i=ze.length>0?ze.pop():{};i.x=a,i.y=s,"string"==typeof e?(r||(r=getTextWidth(e)),i.wt||(i.wt=new WordText),i.wt.setText(e),i.wt.width=r,i.wt.splitRender=this._singleCharRender,i.width=r,i.height=h):(i.obj=e,i.x++,i.width=e.width+2,i.height=e.height),i.style=t,i.linkEnd=!1,i.next=null,a+=Math.round(i.width),n.cmd?o.next=i:n.cmd=i,o=i},endLine=()=>{let e=0,t=n.cmd;for(;t;)t.height>e&&(e=t.height),t=t.next;for(t=n.cmd;t;)t.y=1==_?Math.floor(.5*(e-t.height)):2==_?Math.floor(e-t.height):0,t=t.next;0==e&&(e=h),e++,n.height=e,n.width=a},startLine=()=>(a=0,n&&(s+=n.height+Math.floor(this._textStyle.leading*this._fontSizeScale)),n=Xe.length>0?Xe.pop():{cmds:[]},n.x=0,n.y=s,this._lines.push(n),n),wrapText=(e,r)=>{let i=Math.max(0,t-a),s=getTextWidth(e);if(s<=i)return void addCmd(e,r,s);let n=0,o=0,h=0,d=testEmoji(e);c||d||(n=Math.floor(i/l),0==n&&(n=1),o=getTextWidth(e.substring(0,n)),i<o&&0!=a&&(endLine(),startLine(),i=t));let u=e.length;for(let l=n;l<u;l++){s=getTextWidth(e.charAt(l)),o+=s;let c=!1;if(d&&l+1<u&&testEmoji(e.charAt(l)+e.charAt(l+1))&&(o+=s>>1,l++,c=!0),o>i){if(c&&(o==s+(s>>1)?l++:l--),0==l){a>0&&(endLine(),startLine(),i=t);continue}let d=e.substring(h,l);o-=s;let p=d.charCodeAt(d.length-1);if((_=p)>=65&&_<=90||_>=97&&_<=122||39===_){let t=je.exec(d);t&&(l=t.index+h,0==t.index?l+=d.length:(o=null,d=e.substring(h,l)))}if(addCmd(d,r,o),endLine(),startLine(),i=t,h=l,!(l+n<u)){addCmd(e.substring(h,u),r),h=-1;break}0!=n&&(l+=n-1),o=getTextWidth(e.substring(h,l+1))}}var _;-1!=h&&addCmd(e.substring(h,u),r)},calcTextSize=()=>{let e=0,t=0;for(let t of this._lines)t.width>e&&(e=t.width);e>0&&(e+=i[1]+i[3]),this._textWidth=e;let r=this._lines[this._lines.length-1];r&&(t=r.y+r.height),t>0&&(t+=i[0]+i[2]),this._textHeight=t},run=()=>{a=s=l=h=0,n=null,o=null,recoverLines(this._lines),startLine();let i=this._elements;for(let s=0,n=i.length;s<n;s++){let n=i[s];if(n.type==e.HtmlElementType.Text)d=Math.floor(n.style.fontSize*this._fontSizeScale),0==d&&(d=1),buildLines(n.text,n.style);else if(n.type==e.HtmlElementType.LinkEnd)o&&(o.linkEnd=!0);else{let e=n.obj;if(!e){let t=HtmlParser.classMap[n.type];t&&(e=Pool.createByClass(t),e.create(this,n),n.obj=e)}if(e){if(r){t-a<e.width+1&&a>0&&(endLine(),startLine())}addCmd(e,n.style)}}}endLine(),calcTextSize()};if(run(),this._overflow==Text.SHRINK){if(this._lines.length>1&&this._textHeight>u){let e=0,r=this._textStyle.fontSize;this._fontSizeScale=Math.sqrt(u/this._textHeight);let i=Math.floor(this._fontSizeScale*this._textStyle.fontSize);for(;run(),this._textWidth>t||this._textHeight>u?r=i:e=i,r-e>1||r!=e&&i==r;)i=e+(r-e)/2,this._fontSizeScale=i/this._textStyle.fontSize}else if(this._textWidth>t&&(this._fontSizeScale=t/this._textWidth,run(),this._textWidth>t)){let e=Math.floor(this._textStyle.fontSize*this._fontSizeScale);e--,this._fontSizeScale=e/this._textStyle.fontSize,run()}}else if(this._overflow==Text.ELLIPSIS&&(this._textWidth>t||this._textHeight>u)){let e=this._lines.findIndex((e=>e.y+e.height>u));0==e&&(e=1);let r=!1;-1!=e&&this._lines.length>e&&(recoverLines(this._lines.splice(e,this._lines.length-e)),r=!0);let i,a=this._lines[this._lines.length-1].cmd,s=!1;for(;a;)i=a.next,s?(a.obj?a.obj=null:a.wt&&a.wt.cleanCache(),ze.push(a)):(!i&&r||a.x+a.width>t)&&(a.obj&&(a.obj=null),a.wt||(a.wt=new WordText),a.wt.setText(a.wt.text.substring(0,Math.max(0,a.wt.text.length-2))+$e),d=a.style.fontSize,a.width=a.wt.width=getTextWidth(a.wt.text),a.wt.splitRender=this._singleCharRender,a.next=null,s=!0),a=i;s&&calcTextSize()}this._onPostLayout&&this._onPostLayout();let p="center"==this._textStyle.align?1:"right"==this._textStyle.align?2:0;if(0!=p&&this._isWidthSet){let e=this._width-i[3]-i[1];for(let t of this._lines){let r=0;1==p?r=Math.floor(.5*(e-t.width)):2==p&&(r=e-t.width),r>0&&(t.x=r)}}if(this._isHeightSet&&this._textHeight<this._height){let e=0;if("middle"===this._textStyle.valign?e=Math.floor(.5*(this._height-this._textHeight)):"bottom"===this._textStyle.valign&&(e=this._height-this._textHeight),e>0)for(let t of this._lines)t.y+=e}if(this._overflow==Text.SCROLL&&(this._isWidthSet&&this._textWidth>this._width||this._isHeightSet&&this._textHeight>this._height))if(this._scrollPos){let e=this.maxScrollX,t=this.maxScrollY;this._scrollPos.x>e&&(this._scrollPos.x=e),this._scrollPos.y>t&&(this._scrollPos.y=t)}else this._scrollPos=new Point(0,0);else this._scrollPos=null;this._objContainer&&(this._objContainer.size(this._width,this._height),this._scrollPos||this._overflow==Text.HIDDEN&&this._objContainer.numChildren>0?(this._objContainer.scrollRect||(this._objContainer.scrollRect=new Rectangle),this._objContainer.scrollRect.setTo(0,0,this._width,this._height)):this._objContainer.scrollRect=null),this._updatingLayout=!1,this.renderText()}renderText(){let t=this.graphics;t.clear(!0),this.drawBg();let r=this._padding,i=r[3],a=r[0],s=this._bitmapFont,n=this._scrollPos,o=this._isWidthSet?this._width:this._textWidth,l=this._isHeightSet?this._height:this._textHeight,h=l-r[2],d=this._overflow==Text.HIDDEN||this._overflow==Text.SCROLL;d&&(t.save(),t.clipRect(0,0,o,l),this.repaint()),o-=r[3]+r[1],l-=r[0]+r[2];let u,c,_=0,p=0,g=this._lines,m=g.length;for(let r=0;r<m;r++){let l=g[r];_=i+l.x,p=a+l.y,n&&(_-=n.x,p-=n.y);let m=d&&(p+l.height<=a||p>=h),f=l.cmd;for(;f;){if(f.linkEnd&&u&&(u.addRect(c,p,_+f.x+f.width-c,l.height),u=null),f.obj)f.obj.pos(_+f.x,p+f.y),f.obj.element.type==e.HtmlElementType.Link&&(u=f.obj,u.resetArea(),c=_+f.x);else if(!m)if(s){let e=0,r=f.wt.text,i=s.tint?f.style.color:"#FFFFFF",a=Math.floor((s.autoScaleSize?f.style.fontSize:s.fontSize)*this._fontSizeScale)/s.fontSize;for(let n=0,o=r.length;n<o;n++){let o=r.charCodeAt(n),l=s.dict[o];l&&(l.texture&&t.drawImage(l.texture,_+f.x+e+l.x*a,p+f.y+l.y*a,l.width*a,l.height*a,i),e+=Math.round(l.advance*a))}}else{let e=f.style._ctxFont;f.style.stroke?t.fillBorderText(f.wt,_+f.x,p+f.y,e,f.style.color,null,f.style.stroke,f.style.strokeColor):t.fillText(f.wt,_+f.x,p+f.y,e,f.style.color,null)}if(!m&&f.style.underline){let e=Math.max(1,f.style.fontSize*this._fontSizeScale/16);t.drawLine(_+f.x,p+l.height-e,_+f.x+f.width,p+l.height-e,f.style.underlineColor||f.style.color,e)}f=f.next}u&&(u.addRect(c,p,o-c+i,l.height),c=i)}d&&t.restore()}drawBg(){let e=this._bgDrawCmd;if(this._bgColor||this._borderColor){e||(e=new DrawRectCmd,e.x=e.y=0,e.width=e.height=1,e.percent=!0,this._bgDrawCmd=e),e.fillColor=this._bgColor,e.lineColor=this._borderColor,e.lineWidth=this._borderColor?1:0;let t=this.graphics.cmds,r=t.indexOf(e);0!=r&&(-1!=r&&t.splice(r,1),t.unshift(e),this.graphics.cmds=t)}else e&&this.graphics.removeCmd(e)}}Text.VISIBLE="visible",Text.SCROLL="scroll",Text.HIDDEN="hidden",Text.SHRINK="shrink",Text.ELLIPSIS="ellipsis",Text.RightToLeft=!1,Text._testWord="游",Text._passwordChar="●",Text._bitmapFonts={};const ze=[],Xe=[];function recoverLines(e){for(let t of e){let e=t.cmd;for(;e;)e.obj?e.obj=null:e.wt&&e.wt.cleanCache(),ze.push(e),e=e.next;t.cmd=null}Xe.push(...e),e.length=0}const Ye=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g;function testEmoji(e){return null!=e&&Ye.test(e)}const je=/(?:[^\s\!-\/])+$/,Ke=/\r\n/g,qe=/\\(\w)/g,Qe={"\\n":"\n","\\t":"\t"},$e="…";function getReplaceStr(e){return Qe[e]}var Ze=!0;const Je=new Point,et=new Rectangle,tt=[],rt=[];var it;class InputManager{constructor(){this._touches=[],this._touchPool=[],this._mouseTouch=new TouchInfo(this._touches),this._pressKeys=new Set,this._keyEvent=new Event,this._keyEvent._touches=this._touches}static get inst(){return it}static getTouchPos(e){var t,r;return null==e?(null===(t=it._touches[0])||void 0===t?void 0:t.pos)||Point.EMPTY:(null===(r=it.getTouch(e))||void 0===r?void 0:r.pos)||Point.EMPTY}static get touchTarget(){return it._touchTarget}static get touches(){return it._touches}static get touchCount(){return it._touches.length}static cancelClick(e){let t=null==e?it._touches[0]:it.getTouch(e);t&&(t.clickCancelled=!0)}static hasKeyDown(e){return it._pressKeys.has(e)}static __init__(e,t){let r=it=new InputManager;r._stage=e,t.oncontextmenu=()=>!1,t.addEventListener("mousedown",(e=>{Browser.onIE||e.cancelable&&e.preventDefault(),r._touchInput||r.handleMouse(e,0)}),{passive:!1}),t.addEventListener("mouseup",(e=>{e.cancelable&&e.preventDefault(),r._touchInput||r.handleMouse(e,1)}),{passive:!1}),t.addEventListener("mousemove",(e=>{e.cancelable&&e.preventDefault(),r._touchInput||r.handleMouse(e,2)}),{passive:!1}),t.addEventListener("mouseout",(e=>{r._touchInput||r.handleMouse(e,3)}),{passive:!1}),t.addEventListener("touchstart",(e=>{r._touchInput=!0,Ze||InputManager.isTextInputting||e.cancelable&&e.preventDefault(),r.handleTouch(e,0)}),{passive:!1}),t.addEventListener("touchend",(e=>{Ze||InputManager.isTextInputting||e.cancelable&&e.preventDefault(),Ze=!1,r.handleTouch(e,1)}),{passive:!1}),t.addEventListener("touchmove",(e=>{e.cancelable&&e.preventDefault(),r.handleTouch(e,2)}),{passive:!1}),t.addEventListener("touchcancel",(e=>{e.cancelable&&e.preventDefault(),r.handleTouch(e,3)}),{passive:!1}),t.addEventListener("wheel",(e=>{r.handleMouse(e,4)}),{passive:!1}),t.addEventListener("pointerdown",(e=>{t.setPointerCapture(e.pointerId)})),t.addEventListener("pointerup",(e=>{t.releasePointerCapture(e.pointerId)}),!0);let i=Browser.document;i.addEventListener("keydown",(e=>{r.handleKeys(e)}),!0),i.addEventListener("keypress",(e=>{r.handleKeys(e)}),!0),i.addEventListener("keyup",(e=>{r.handleKeys(e)}),!0)}handleMouse(e,t){var r,i,a,s,n;this._eventType=t,this._nativeEvent=e;let o=this._mouseTouch;Je.setTo(e.pageX||e.clientX,e.pageY||e.clientY),this._stage._canvasTransform&&this._stage._canvasTransform.invertTransformPoint(Je),InputManager.mouseX=Je.x,InputManager.mouseY=Je.y;let l=Je.x/this._stage.clientScaleX,h=Je.y/this._stage.clientScaleY;if(o.event.nativeEvent=e,3!=t&&InputManager.mouseEventsEnabled){o.target=this._touchTarget=this.getNodeUnderPoint(l,h);let e=Math.round(l),t=Math.round(h);if((e!=o.pos.x||t!=o.pos.y)&&(this._stage._mouseMoveTime=Browser.now(),o.pos.setTo(e,t),o.move(),InputManager.mouseEventsEnabled)){o.target.bubbleEvent(Event.MOUSE_MOVE,o.event);for(let e of o.downTargets)e.event(Event.MOUSE_DRAG,o.event)}}else o.target=this._touchTarget=null;if(o.lastRollOver!=o.target&&this.handleRollOver(o),0==t)o.began||(o.begin(),this._touches[0]=o,o.event.button=e.button,InputManager.mouseEventsEnabled&&(this.handleFocus(),0==e.button?null===(r=o.target)||void 0===r||r.bubbleEvent(Event.MOUSE_DOWN,o.event):null===(i=o.target)||void 0===i||i.bubbleEvent(Event.RIGHT_MOUSE_DOWN,o.event)));else if(1==t){if(o.began){if(o.end(),this._touches.length=0,o.event.button=e.button,InputManager.mouseEventsEnabled){if(0==e.button?null===(a=o.target)||void 0===a||a.bubbleEvent(Event.MOUSE_UP,o.event):null===(s=o.target)||void 0===s||s.bubbleEvent(Event.RIGHT_MOUSE_UP,o.event),o.moved)for(let e of o.downTargets)e.event(Event.MOUSE_DRAG_END,o.event);let t=o.clickTest();t&&(0==e.button?(o.event.isDblClick=2==o.clickCount,t.bubbleEvent(Event.CLICK,o.event),2==o.clickCount&&t.bubbleEvent(Event.DOUBLE_CLICK,o.event),o.event.isDblClick=!1):(o.event.isDblClick=2==o.clickCount,t.bubbleEvent(Event.RIGHT_CLICK,o.event),o.event.isDblClick=!1))}o.event.button=0}}else 4==t&&InputManager.mouseEventsEnabled&&(o.event.delta=.025*e.deltaY,null===(n=o.target)||void 0===n||n.bubbleEvent(Event.MOUSE_WHEEL,o.event),o.event.delta=0)}handleTouch(e,t){var r,i;this._eventType=t,this._nativeEvent=e;let a=e.changedTouches;for(let s=0;s<a.length;++s){let n=a[s];if(!InputManager.multiTouchEnabled&&this._touches.length>0&&this._touches[0].touchId!=n.identifier)continue;Je.setTo(n.pageX,n.pageY),this._stage._canvasTransform&&this._stage._canvasTransform.invertTransformPoint(Je),InputManager.mouseX=Je.x,InputManager.mouseY=Je.y;let o=Je.x/this._stage.clientScaleX,l=Je.y/this._stage.clientScaleY,h=this.getTouch(n.identifier,0==t);if(h){if(h.event.nativeEvent=e,h.event.touchId=h.touchId,3!=t&&InputManager.mouseEventsEnabled){h.target=this._touchTarget=this.getNodeUnderPoint(o,l),this._stage._mouseMoveTime=Browser.now();let e=Math.round(o),r=Math.round(l);if((Math.abs(e-h.pos.x)>1.5||Math.abs(r-h.pos.y)>1.5)&&(h.pos.setTo(e,r),2==t&&(h.move(),InputManager.mouseEventsEnabled))){h.target.bubbleEvent(Event.MOUSE_MOVE,h.event);for(let e of h.downTargets)e.event(Event.MOUSE_DRAG,h.event)}}else h.target=this._touchTarget=null;if(h.lastRollOver!=h.target&&this.handleRollOver(h),0==t)h.began||(h.begin(),InputManager.mouseEventsEnabled&&(this.handleFocus(),null===(r=h.target)||void 0===r||r.bubbleEvent(Event.MOUSE_DOWN,h.event)));else if(1==t||3==t){if(h.began){if(h.end(),InputManager.mouseEventsEnabled){if(null===(i=h.target)||void 0===i||i.bubbleEvent(Event.MOUSE_UP,h.event),h.moved)for(let e of h.downTargets)e.event(Event.MOUSE_DRAG_END,h.event);if(3!=t){let e=h.clickTest();null!=e&&(h.event.isDblClick=2==h.clickCount,e.bubbleEvent(Event.CLICK,h.event),2==h.clickCount&&e.bubbleEvent(Event.DOUBLE_CLICK,h.event),h.event.isDblClick=!1)}}h.target=null,this.handleRollOver(h)}h.reset(),this._touches.splice(this._touches.indexOf(h),1),this._touchPool.push(h)}}}}getTouch(e,t){let r=this._touches.find((t=>t.touchId==e));return r||!t||(r=this._touchPool.length>0?this._touchPool.pop():new TouchInfo(this._touches),r.touchId=e,this._touches.push(r)),r}handleFocus(){if(InputManager.isTextInputting&&this._stage.focus&&this._stage.focus.focus&&!this._stage.focus.contains(this._touchTarget)){let e=this._stage.focus._tf||this._stage.focus,t=this._touchTarget._tf||this._touchTarget;t.nativeInput&&t.multiline==e.multiline?e._focusOut():e.focus=!1}}handleKeys(e){let t=e.type,r=e.keyCode;if("keydown"===t?(0!=r&&this._pressKeys.add(r),this._pressKeys.add(e.key)):"keyup"===t&&(0!=r&&this._pressKeys.delete(r),this._pressKeys.delete(e.key)),this._keyEvent.nativeEvent=e,InputManager.keyEventsEnabled){let e=this._stage.focus&&null!=this._stage.focus.event&&this._stage.focus.displayedInStage?this._stage.focus:this._stage,r=e;for(;r;)r.event(t,this._keyEvent.setTo(t,r,e)),r=r.parent}this._keyEvent.nativeEvent=null}getNodeUnderPoint(e,t){let r=this.getSpriteUnderPoint(this._stage,e,t);return r||(r=this.getSprite3DUnderPoint(e,t)),r||this._stage}getSpriteUnderPoint(e,t,r){let i=e._style.scrollRect;if(i&&!e._getBit(NodeFlags.DISABLE_INNER_CLIPPING)&&(et.setTo(i.x,i.y,i.width,i.height),!et.contains(t,r)))return null;let a=e._getBit(NodeFlags.EDITING_NODE);if(!a&&e.hitTestPrior&&!e.mouseThrough&&e!=this._stage&&!this.hitTest(e,t,r))return null;for(let i=e._children.length-1;i>-1;i--){let s=e._children[i],n=a||s._getBit(NodeFlags.EDITING_NODE);if(!s._destroyed&&(n?(!s.hasHideFlag(HideFlags.HideInHierarchy)||s.mouseThrough)&&!s._getBit(NodeFlags.HIDE_BY_EDITOR):s._mouseState>1)&&(s._visible||s._getBit(NodeFlags.DISABLE_VISIBILITY))){Je.setTo(t,r),s.fromParentPoint(Je);let e=this.getSpriteUnderPoint(s,Je.x,Je.y);if(e)return e}}if(a){if(!e._getBit(NodeFlags.LOCK_BY_EDITOR)&&!e.hasHideFlag(HideFlags.HideInHierarchy)&&this.hitTest(e,t,r,a))return e}else if(e!=this._stage&&(e.hitTestPrior&&!e.mouseThrough||this.hitTest(e,t,r)))return e;return null}getSprite3DUnderPoint(e,t){return null}hitTest(e,t,r,i){let a=!1;e.scrollRect&&(t-=e._style.scrollRect.x,r-=e._style.scrollRect.y);let s=e._style.hitArea,n=e.mouseThrough;return i&&(s=null,n=!1),s?s.contains(t,r,e):((e.width>0&&e.height>0||n||s)&&(a=n?e.getGraphicBounds().contains(t,r):(s||et.setTo(0,0,e.width,e.height)).contains(t,r)),a)}handleRollOver(e){if(!InputManager.mouseEventsEnabled)return void(e.lastRollOver=e.target);tt.length=0,rt.length=0;let t=e.lastRollOver;for(;t;)rt.push(t),t=t.parent;for(e.lastRollOver=e.target,t=e.target;t;){let e=rt.indexOf(t);if(-1!=e){rt.splice(e,rt.length-e);break}tt.push(t),t=t.parent}let r=rt.length;if(r>0){for(let i=0;i<r;i++)t=rt[i],t._destroyed||t.event(Event.MOUSE_OUT,e.event.setTo(Event.MOUSE_OUT,t,t));rt.length=0}if(r=tt.length,r>0){for(let i=0;i<r;i++)t=tt[i],t.activeInHierarchy&&t.event(Event.MOUSE_OVER,e.event.setTo(Event.MOUSE_OVER,t,t));tt.length=0}}}InputManager.multiTouchEnabled=!0,InputManager.mouseEventsEnabled=!0,InputManager.keyEventsEnabled=!0,InputManager.clickTestThreshold=10,InputManager.mouseX=0,InputManager.mouseY=0,InputManager.isTextInputting=!1,InputManager.isiOSWKwebView=!1;const at={};class TouchInfo{constructor(e){this.downPos=new Point,this.downTargets=[],this.event=new Event,this.event._touches=e,this.pos=this.event.touchPos,this.reset()}begin(){if(this.began=!0,this.clickCancelled=!1,this.moved=!1,this.downPos.copy(this.pos),this.downTargets.length=0,this.target){let e=this.target;for(;e;)this.downTargets.push(e),e=e.parent}}move(){this.moved=!0,(Math.abs(this.pos.x-this.downPos.x)>InputManager.clickTestThreshold||Math.abs(this.pos.y-this.downPos.y)>InputManager.clickTestThreshold)&&(this.clickCancelled=!0)}end(){this.began=!1;let e=performance.now(),t=at[this.touchId];t||(t={pos:new Point,time:0,button:0},at[this.touchId]=t),0==this.downTargets.length||this.clickCancelled||Math.abs(this.pos.x-this.downPos.x)>InputManager.clickTestThreshold||Math.abs(this.pos.y-this.downPos.y)>InputManager.clickTestThreshold?(this.clickCancelled=!0,t.time=0,this.clickCount=1):(e-t.time<350&&Math.abs(this.pos.x-t.pos.x)<InputManager.clickTestThreshold&&Math.abs(this.pos.y-t.pos.y)<InputManager.clickTestThreshold&&t.button==this.event.button?this.clickCount=2:this.clickCount=1,t.time=e,t.pos.copy(this.pos),t.button=this.event.button)}clickTest(){if(this.clickCancelled)return this.downTargets.length=0,null;let e=this.downTargets[0];if(e.activeInHierarchy)return this.downTargets.length=0,e;for(e=this.target;e;){if(-1!=this.downTargets.indexOf(e)&&e.activeInHierarchy)break;e=e.parent}return this.downTargets.length=0,e}reset(){this.pos.setTo(0,0),this.touchId=0,this.clickCount=0,this.began=!1,this.moved=!1,this.target=null,this.downTargets.length=0,this.lastRollOver=null,this.clickCancelled=!1}}class Timer{constructor(e=!0){this.scale=1,this.currFrame=0,this._delta=0,this._map={},this._handlers=[],this._temp=[],this._count=0,e&&Timer.gSysTimer&&Timer.gSysTimer.frameLoop(1,this,this._update),this.currTimer=this._getNowData(),this._lastTimer=this._getNowData()}get delta(){return this._delta}_update(){if(this.scale<=0)return this._lastTimer=this._getNowData(),void(this._delta=0);var e=this.currFrame=this.currFrame+this.scale,t=this._getNowData(),r=t-this._lastTimer>3e4;this._delta=(t-this._lastTimer)*this.scale;var i=this.currTimer=this.currTimer+this._delta;this._lastTimer=t;var a=this._handlers;this._count=0;for(var s=0,n=a.length;s<n;s++){var o=a[s];if(null!==o.method){var l=o.userFrame?e:i;if(l>=o.exeTime)if(o.repeat)if(!o.jumpFrame||r)o.exeTime+=o.delay,o.run(!1),l>o.exeTime&&(o.exeTime+=Math.ceil((l-o.exeTime)/o.delay)*o.delay);else for(;l>=o.exeTime;)o.exeTime+=o.delay,o.run(!1);else o.run(!0)}else this._count++}(this._count>30||e%200==0)&&this._clearHandlers()}_clearHandlers(){for(var e=this._handlers,t=0,r=e.length;t<r;t++){var i=e[t];null!==i.method?this._temp.push(i):this._recoverHandler(i)}this._handlers=this._temp,e.length=0,this._temp=e}_recoverHandler(e){this._map[e.key]==e&&delete this._map[e.key],e.clear(),Timer._pool.push(e)}_getNowData(){return Date.now()}_create(e,t,r,i,a,s,n){if(!r)return a.apply(i,s),null;if(n){var o=this._getHandler(i,a);if(o)return o.repeat=t,o.userFrame=e,o.delay=r,o.caller=i,o.method=a,o.args=s,o.exeTime=r+(e?this.currFrame:this.currTimer+this._getNowData()-this._lastTimer),o}return(o=Timer._pool.length>0?Timer._pool.pop():new TimerHandler).repeat=t,o.userFrame=e,o.delay=r,o.caller=i,o.method=a,o.args=s,o.exeTime=r+(e?this.currFrame:this.currTimer+this._getNowData()-this._lastTimer),this._indexHandler(o),this._handlers.push(o),o}_indexHandler(e){var t=e.caller,r=e.method,i=t?t.$_GID||(t.$_GID=Utils.getGID()):0,a=r.$_TID||(r.$_TID=Timer._mid++);e.key=i+"_"+a,this._map[e.key]=e}once(e,t,r,i=null,a=!0){this._create(!1,!1,e,t,r,i,a)}loop(e,t,r,i=null,a=!0,s=!1){var n=this._create(!1,!0,e,t,r,i,a);n&&(n.jumpFrame=s)}frameOnce(e,t,r,i=null,a=!0){this._create(!0,!1,e,t,r,i,a)}frameLoop(e,t,r,i=null,a=!0){this._create(!0,!0,e,t,r,i,a)}toString(){return" handlers:"+this._handlers.length+" pool:"+Timer._pool.length}clear(e,t){var r=this._getHandler(e,t);r&&r.clear()}clearAll(e){if(e)for(var t=0,r=this._handlers.length;t<r;t++){var i=this._handlers[t];i.caller===e&&i.clear()}}_getHandler(e,t){var r=(e?e.$_GID||(e.$_GID=Utils.getGID()):0)+"_"+(t.$_TID||(t.$_TID=Timer._mid++));return this._map[r]}callLater(e,t,r=null){CallLater.I.callLater(e,t,r)}runCallLater(e,t){CallLater.I.runCallLater(e,t)}clearCallLater(e,t){CallLater.I.clear(e,t)}runTimer(e,t){var r=this._getHandler(e,t);r&&null!=r.method&&(this._map[r.key]=null,r.run(!0))}pause(){this.scale=0}resume(){this.scale=1}destroy(){for(var e=0,t=this._handlers.length;e<t;e++){this._handlers[e].clear()}this._handlers.length=0,this._map={},this._temp.length=0}}Timer.gSysTimer=null,Timer._pool=[],Timer._mid=1;class TimerHandler{clear(){this.caller=null,this.method=null,this.args=null}run(e){var t=this.caller;if(t&&t.destroyed)return this.clear();var r=this.method,i=this.args;e&&this.clear(),null!=r&&(i?r.apply(t,i):r.call(t))}}class CallLater{constructor(){this._pool=[],this._map={},this._laters=[]}_update(){let e=this._laters,t=e.length;if(t>0){for(let r=0,i=t-1;r<=i;r++){let t=e[r];this._map[t.key]=null,null!==t.method&&(t.run(),t.clear()),this._pool.push(t),r===i&&(i=e.length-1)}e.length=0}}_getHandler(e,t){var r=e?e.$_GID||(e.$_GID=Utils.getGID()):0,i=t.$_TID||(t.$_TID=Timer._mid++);return this._map[r+"."+i]}callLater(e,t,r=null){if(null==this._getHandler(e,t)){let s;s=this._pool.length?this._pool.pop():new LaterHandler,s.caller=e,s.method=t,s.args=r;var i=e?e.$_GID:0,a=t.$_TID;s.key=i+"."+a,this._map[s.key]=s,this._laters.push(s)}}runCallLater(e,t){var r=this._getHandler(e,t);r&&null!=r.method&&(this._map[r.key]=null,r.run(),r.clear())}clear(e,t){var r=this._getHandler(e,t);return!!r&&(this._map[r.key]=null,r.key="",r.clear(),!0)}clearAll(e){if(e)for(var t=0,r=this._laters.length;t<r;t++){var i=this._laters[t];i.caller===e&&(this._map[i.key]=null,i.key="",i.clear())}}}CallLater.I=new CallLater;class LaterHandler{clear(){this.caller=null,this.method=null,this.args=null}run(){var e=this.caller;if(e&&e.destroyed)return this.clear();var t=this.method,r=this.args;null!=t&&(r?t.apply(e,r):t.call(e))}}class WebGL{static _nativeRender_enable(){}static enable(){return!0}static onStageResize(e,t){RenderState2D.width=e,RenderState2D.height=t,LayaGL.renderEngine.resizeOffScreen(e,t)}}WebGL.isNativeRender_enable=!1;class RunDriver{}RunDriver.changeWebGLSize=function(e,t){WebGL.onStageResize(e,t)};class ComponentDriver{constructor(){this._onUpdates=new Set,this._onLateUpdates=new Set,this._onPreRenders=new Set,this._onPostRenders=new Set,this._toStarts=new Set,this._toDestroys=new Set}callStart(){for(let e of this._toStarts)if(2==e._status){e._status=3;try{e.onStart()}catch(e){console.log(e)}}this._toStarts.clear()}callUpdate(){for(let e of this._onUpdates)if(3==e._status)try{e.onUpdate()}catch(e){console.log(e)}}callLateUpdate(){for(let e of this._onLateUpdates)if(3==e._status)try{e.onLateUpdate()}catch(e){console.log(e)}}callPreRender(){for(let e of this._onPreRenders)if(3==e._status)try{e.onPreRender()}catch(e){console.log(e)}}callPostRender(){for(let e of this._onPostRenders)if(3==e._status)try{e.onPostRender()}catch(e){console.log(e)}}callDestroy(){for(let e of this._toDestroys)try{e._destroy(!0)}catch(e){console.log(e)}this._toDestroys.clear()}add(e){1==e._status&&(e.onStart?(e._status=2,this._toStarts.add(e)):e._status=3),e.onUpdate&&this._onUpdates.add(e),e.onLateUpdate&&this._onLateUpdates.add(e),e.onPreRender&&this._onPreRenders.add(e),e.onPostRender&&this._onPostRenders.add(e)}remove(e){2==e._status&&(e._status=1),e.onUpdate&&this._onUpdates.delete(e),e.onLateUpdate&&this._onLateUpdates.delete(e),e.onPreRender&&this._onPreRenders.delete(e),e.onPostRender&&this._onPostRenders.delete(e)}destroy(){}}class Stage extends Sprite{constructor(){super(),this.offset=new Point,this._frameRate="fast",this.designWidth=0,this.designHeight=0,this.canvasRotation=!1,this.canvasDegree=0,this.renderingEnabled=!0,this.screenAdaptationEnabled=!0,this._canvasTransform=new Matrix,this._screenMode="none",this._scaleMode="noscale",this._alignV="top",this._alignH="left",this._bgColor="gray",this._mouseMoveTime=0,this._renderCount=0,this._safariOffsetY=0,this._frameStartTime=0,this._previousOrientation=Browser.window.orientation,this._wgColor=new Color(0,0,0,0),this._scene3Ds=[],this._globalRepaintSet=!1,this._globalRepaintGet=!1,this.useRetinalCanvas=!1,this._needUpdateCanvasSize=!1,super.set_transform(this._createTransform()),this.mouseEnabled=!0,this.hitTestPrior=!0,this.autoSize=!1,this._setBit(NodeFlags.DISPLAYED_INSTAGE,!0),this._setBit(NodeFlags.ACTIVE_INHIERARCHY,!0),this._isFocused=!0,this._isVisibility=!0,this.useRetinalCanvas=!!LayaEnv.isConch||Config.useRetinalCanvas;var e=Browser.window;e.addEventListener("focus",(()=>{this._isFocused=!0,this.event(Event.FOCUS),this.event(Event.FOCUS_CHANGE)})),e.addEventListener("blur",(()=>{this._isFocused=!1,this.event(Event.BLUR),this.event(Event.FOCUS_CHANGE),this._isInputting()&&(Input.inputElement.target.focus=!1)}));var t="visibilityState",r="visibilitychange",i=e.document;void 0!==i.hidden?(r="visibilitychange",t="visibilityState"):void 0!==i.mozHidden?(r="mozvisibilitychange",t="mozVisibilityState"):void 0!==i.msHidden?(r="msvisibilitychange",t="msVisibilityState"):void 0!==i.webkitHidden&&(r="webkitvisibilitychange",t="webkitVisibilityState"),e.document.addEventListener(r,(()=>{"hidden"==Browser.document[t]?(this._isVisibility=!1,this._isInputting()&&(Input.inputElement.target.focus=!1)):this._isVisibility=!0,this.renderingEnabled=this._isVisibility,this.event(Event.VISIBILITY_CHANGE)})),e.addEventListener("resize",(()=>{var e=Browser.window.orientation;null!=e&&e!=this._previousOrientation&&this._isInputting()&&(Input.inputElement.target.focus=!1),this._previousOrientation=e,this._isInputting()||(Browser.onSafari&&(this._safariOffsetY=Browser.getSafariToolbarOffset()),this.screenAdaptationEnabled&&(this.event(Event.WILL_RESIZE),this.updateCanvasSize()))})),e.addEventListener("orientationchange",(e=>{this.screenAdaptationEnabled&&(this.event(Event.WILL_RESIZE),this.updateCanvasSize())})),this._componentDriver=new ComponentDriver}_isInputting(){return Browser.onMobile&&InputManager.isTextInputting}set_width(e){this.designWidth=e,super.set_width(e),this.updateCanvasSize(!0)}get_width(){return this.needUpdateCanvasSize(),super.get_width()}set_height(e){this.designHeight=e,super.set_height(e),this.updateCanvasSize(!0)}get_height(){return this.needUpdateCanvasSize(),super.get_height()}get transform(){return this._tfChanged&&this._adjustTransform(),this._transform=this._transform||this._createTransform()}set transform(e){super.set_transform(e)}get isFocused(){return this._isFocused}get isVisibility(){return this._isVisibility}updateCanvasSize(e){e?this._needUpdateCanvasSize||(this._needUpdateCanvasSize=!0,ILaya.systemTimer.callLater(this,this.updateCanvasSize)):this.setScreenSize(Browser.clientWidth*Browser.pixelRatio,Browser.clientHeight*Browser.pixelRatio)}needUpdateCanvasSize(){this._needUpdateCanvasSize&&this.updateCanvasSize()}setScreenSize(e,t){this._needUpdateCanvasSize=!1;var r=!1;if(this._screenMode!==Stage.SCREEN_NONE&&(r=(e/t<1?Stage.SCREEN_VERTICAL:Stage.SCREEN_HORIZONTAL)!==this._screenMode)){var i=t;t=e,e=i}this.canvasRotation=r;var a=Render._mainCanvas,s=this._canvasTransform.identity(),n=this._scaleMode,o=e/this.designWidth,l=t/this.designHeight,h=this.useRetinalCanvas?e:this.designWidth,d=this.useRetinalCanvas?t:this.designHeight,u=e,c=t,_=Browser.pixelRatio;switch(this._width=this.designWidth,this._height=this.designHeight,n){case Stage.SCALE_NOSCALE:o=l=1,u=this.designWidth,c=this.designHeight;break;case Stage.SCALE_SHOWALL:o=l=Math.min(o,l),h=u=Math.round(this.designWidth*o),d=c=Math.round(this.designHeight*l);break;case Stage.SCALE_NOBORDER:o=l=Math.max(o,l),u=Math.round(this.designWidth*o),c=Math.round(this.designHeight*l);break;case Stage.SCALE_FULL:o=l=_,h=e,d=t,this._width=e/_,this._height=t/_;break;case Stage.SCALE_FIXED_WIDTH:l=o,this._height=d=Math.round(t/o);break;case Stage.SCALE_FIXED_HEIGHT:o=l,this._width=h=Math.round(e/l);break;case Stage.SCALE_FIXED_AUTO:e/t<this.designWidth/this.designHeight?(l=o,this._height=d=Math.round(t/o)):(o=l,this._width=h=Math.round(e/l))}this.useRetinalCanvas&&(u=h=e,c=d=t),o*=this.scaleX,l*=this.scaleY,1===o&&1===l?this.transform.identity():(this.transform.a=this._formatData(o/(u/h)),this.transform.d=this._formatData(l/(c/d))),a.size(h,d),RunDriver.changeWebGLSize(h,d),s.scale(u/h/_,c/d/_),this._alignH===Stage.ALIGN_LEFT?this.offset.x=0:this._alignH===Stage.ALIGN_RIGHT?this.offset.x=e-u:this.offset.x=.5*(e-u)/_,this._alignV===Stage.ALIGN_TOP?this.offset.y=0:this._alignV===Stage.ALIGN_BOTTOM?this.offset.y=t-c:this.offset.y=.5*(t-c)/_,this.offset.x=Math.round(this.offset.x),this.offset.y=Math.round(this.offset.y),s.translate(this.offset.x,this.offset.y),this._safariOffsetY&&s.translate(0,this._safariOffsetY),this.canvasDegree=0,r&&(this._screenMode===Stage.SCREEN_HORIZONTAL?(s.rotate(Math.PI/2),s.translate(t/_,0),this.canvasDegree=90):(s.rotate(-Math.PI/2),s.translate(0,e/_),this.canvasDegree=-90)),s.a=this._formatData(s.a),s.d=this._formatData(s.d),s.tx=this._formatData(s.tx),s.ty=this._formatData(s.ty),super.set_transform(this.transform),Stage._setStageStyle(a,h,d,s),this._safariOffsetY&&s.translate(0,-this._safariOffsetY),this.visible=!0,this._repaint|=SpriteConst.REPAINT_CACHE,this.event(Event.RESIZE)}static _setStageStyle(e,t,r,i){var a=e.source.style;a.transformOrigin=a.webkitTransformOrigin=a.msTransformOrigin=a.mozTransformOrigin=a.oTransformOrigin="0px 0px 0px",a.transform=a.webkitTransform=a.msTransform=a.mozTransform=a.oTransform="matrix("+i.toString()+")",a.width=t,a.height=r,i.translate(parseInt(a.left)||0,parseInt(a.top)||0)}setScreenSizeForScene(e,t,r){var i=!1;if(r!==Stage.SCREEN_NONE&&(i=(e/t<1?Stage.SCREEN_VERTICAL:Stage.SCREEN_HORIZONTAL)!==r)){var a=t;t=e,e=a}this.canvasRotation=i,Render._mainCanvas.source.style,this._canvasTransform.clone().identity();var s=this._scaleMode,n=e/this.designWidth,o=t/this.designHeight,l=this.useRetinalCanvas?e:this.designWidth,h=this.useRetinalCanvas?t:this.designHeight,d=e,u=t;Browser.pixelRatio;let c=this.designWidth,_=this.designHeight;switch(s){case Stage.SCALE_NOSCALE:n=o=1,d=this.designWidth,u=this.designHeight;break;case Stage.SCALE_SHOWALL:n=o=Math.min(n,o),l=d=Math.round(this.designWidth*n),h=u=Math.round(this.designHeight*o);break;case Stage.SCALE_NOBORDER:n=o=Math.max(n,o),d=Math.round(this.designWidth*n),u=Math.round(this.designHeight*o);break;case Stage.SCALE_FULL:n=o=1,c=l=e,_=h=t;break;case Stage.SCALE_FIXED_WIDTH:o=n,_=h=Math.round(t/n);break;case Stage.SCALE_FIXED_HEIGHT:n=o,c=l=Math.round(e/o);break;case Stage.SCALE_FIXED_AUTO:e/t<this.designWidth/this.designHeight?(o=n,_=h=Math.round(t/n)):(n=o,c=l=Math.round(e/o))}return this.useRetinalCanvas&&(d=l=e,u=h=t),{stageWidth:c,stageHeight:_,canvasWidth:l,canvasHeight:h,scaleX:n/(d/l),scaleY:o/(u/h)}}_formatData(e){return Math.abs(e)<1e-6?0:Math.abs(1-e)<.001?e>0?1:-1:e}get scaleMode(){return this._scaleMode}set scaleMode(e){this._scaleMode=e,this.updateCanvasSize(!0)}get alignH(){return this.needUpdateCanvasSize(),this._alignH}set alignH(e){this._alignH=e,this.updateCanvasSize(!0)}get alignV(){return this.needUpdateCanvasSize(),this._alignV}set alignV(e){this._alignV=e,this.updateCanvasSize(!0)}get bgColor(){return this._bgColor}set bgColor(e){if(this._bgColor=e,e){let t=ColorUtils.create(e).arrColor;this._wgColor.setValue(t[0],t[1],t[2],t[3])}else this._wgColor=null;Stage._setStyleBgColor(e)}static _setStyleBgColor(e){Render.canvas.style.background=e||"none"}get mouseX(){return Math.round(InputManager.mouseX/this.clientScaleX)}get mouseY(){return Math.round(InputManager.mouseY/this.clientScaleY)}getMousePoint(){return Point.TEMP.setTo(this.mouseX,this.mouseY)}get clientScaleX(){return this.needUpdateCanvasSize(),this._transform?this._transform.getScaleX():1}get clientScaleY(){return this.needUpdateCanvasSize(),this._transform?this._transform.getScaleY():1}get screenMode(){return this._screenMode}set screenMode(e){this._screenMode=e}repaint(e=SpriteConst.REPAINT_CACHE){this._repaint|=e}parentRepaint(e=SpriteConst.REPAINT_CACHE){}_loop(){return this._globalRepaintGet=this._globalRepaintSet,this._globalRepaintSet=!1,this.render(Render._context,0,0),!0}getFrameTm(){return this._frameStartTime}getTimeFromFrameStart(){return Browser.now()-this._frameStartTime}get visible(){return super.visible}set visible(e){this.visible!==e&&(super.set_visible(e),Stage._setVisibleStyle(e))}static _setVisibleStyle(e){Render._mainCanvas.source.style.visibility=e?"visible":"hidden"}render(e,t,r){if(this._frameRate===Stage.FRAME_SLEEP){var i=Browser.now();if(i-this._frameStartTime<1e3)return;this._frameStartTime=i}else{if(!this._visible)return this._renderCount++,void(this._renderCount%5==0&&(CallLater.I._update(),Stat.loopCount++,RenderInfo.loopCount=Stat.loopCount,this._runComponents(),this._updateTimers()));this._frameStartTime=Browser.now(),RenderInfo.loopStTm=this._frameStartTime}this._renderCount++;var a=(this._frameRate===Stage.FRAME_MOUSE?this._frameStartTime-this._mouseMoveTime<2e3?Stage.FRAME_FAST:Stage.FRAME_SLOW:this._frameRate)!==Stage.FRAME_SLOW,s=this._renderCount%2==0;if(Stat.renderSlow=!a,a||s){if(CallLater.I._update(),Stat.loopCount++,RenderInfo.loopCount=Stat.loopCount,this.renderingEnabled){for(let e=0,t=this._scene3Ds.length;e<t;e++)this._scene3Ds[e]._update();this._runComponents(),this._componentDriver.callPreRender(),e.render2D.renderStart(!Config.preserveDrawingBuffer,this._wgColor);for(let e=0,t=this._scene3Ds.length;e<t;e++)this._scene3Ds[e].renderSubmit();this._render2d(e,t,r),this._componentDriver.callPostRender(),VectorGraphManager.instance&&VectorGraphManager.getInstance().endDispose()}else this._runComponents();this._updateTimers()}}_render2d(e,t,r){Stat.draw2D=0,e.startRender(),super.render(e,t,r),Stat.render(e,t,r),e.endRender()}_runComponents(){this._componentDriver.callStart(),this._componentDriver.callUpdate(),this._componentDriver.callLateUpdate(),this._componentDriver.callDestroy()}_updateTimers(){ILaya.systemTimer._update(),ILaya.physicsTimer._update(),ILaya.timer._update()}set fullScreenEnabled(e){var t=Browser.document,r=Render.canvas;e?(r.addEventListener("mousedown",requestFullscreen),r.addEventListener("touchstart",requestFullscreen),t.addEventListener("fullscreenchange",fullScreenChanged),t.addEventListener("mozfullscreenchange",fullScreenChanged),t.addEventListener("webkitfullscreenchange",fullScreenChanged),t.addEventListener("msfullscreenchange",fullScreenChanged)):(r.removeEventListener("mousedown",requestFullscreen),r.removeEventListener("touchstart",requestFullscreen),t.removeEventListener("fullscreenchange",fullScreenChanged),t.removeEventListener("mozfullscreenchange",fullScreenChanged),t.removeEventListener("webkitfullscreenchange",fullScreenChanged),t.removeEventListener("msfullscreenchange",fullScreenChanged))}exitFullscreen(){var e=Browser.document;e.exitFullscreen?e.exitFullscreen():e.mozCancelFullScreen?e.mozCancelFullScreen():e.webkitExitFullscreen&&e.webkitExitFullscreen()}get frameRate(){return this._frameRate}set frameRate(e){this._frameRate=e}isGlobalRepaint(){return this._globalRepaintGet}setGlobalRepaint(){this._globalRepaintSet=!0}}function requestFullscreen(){var e=Browser.document.documentElement;e.requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen&&e.msRequestFullscreen();var t=Render.canvas;t.removeEventListener("mousedown",requestFullscreen),t.removeEventListener("touchstart",requestFullscreen)}function fullScreenChanged(){ILaya.stage.event(Event.FULL_SCREEN_CHANGE)}Stage.SCALE_NOSCALE="noscale",Stage.SCALE_EXACTFIT="exactfit",Stage.SCALE_SHOWALL="showall",Stage.SCALE_NOBORDER="noborder",Stage.SCALE_FULL="full",Stage.SCALE_FIXED_WIDTH="fixedwidth",Stage.SCALE_FIXED_HEIGHT="fixedheight",Stage.SCALE_FIXED_AUTO="fixedauto",Stage.ALIGN_LEFT="left",Stage.ALIGN_RIGHT="right",Stage.ALIGN_CENTER="center",Stage.ALIGN_TOP="top",Stage.ALIGN_MIDDLE="middle",Stage.ALIGN_BOTTOM="bottom",Stage.SCREEN_NONE="none",Stage.SCREEN_HORIZONTAL="horizontal",Stage.SCREEN_VERTICAL="vertical",Stage.FRAME_FAST="fast",Stage.FRAME_SLOW="slow",Stage.FRAME_MOUSE="mouse",Stage.FRAME_SLEEP="sleep";class SoundChannel extends EventDispatcher{constructor(){super(...arguments),this.isStopped=!1}set volume(e){}get volume(){return 1}get position(){return 0}get duration(){return 0}play(){}stop(){this.completeHandler&&this.completeHandler.runWith(!1)}pause(){}resume(){}__runComplete(e){e&&e.runWith(!0)}}class AudioSoundChannel extends SoundChannel{constructor(e){super(),this._audio=null,this._onEnd=this.__onEnd.bind(this),this._resumePlay=this.__resumePlay.bind(this),e.addEventListener("ended",this._onEnd),this._audio=e,this._src=e.src}__onEnd(e){if(1==this.loops)return this.completeHandler&&(ILaya.systemTimer.once(10,this,this.__runComplete,[this.completeHandler],!1),this.completeHandler=null),this.stop(),void this.event(Event.COMPLETE);this.loops>0&&this.loops--,this.startTime=0,this.play()}__resumePlay(){if(this._audio&&this._audio.removeEventListener("canplay",this._resumePlay),!this.isStopped)try{this._audio.currentTime=this.startTime,Browser.container.appendChild(this._audio),this._audio.play()}catch(e){this.event(Event.ERROR)}}play(){this.isStopped=!1;try{this._audio.playbackRate=SoundManager.playbackRate,this._audio.currentTime=this.startTime}catch(e){return void this._audio.addEventListener("canplay",this._resumePlay)}if(SoundManager.addChannel(this),Browser.container.appendChild(this._audio),"play"in this._audio){let e=this._audio.play();e&&e.catch((e=>{}))}}get position(){return this._audio?this._audio.currentTime:0}get duration(){return this._audio?this._audio.duration:0}stop(){super.stop(),this.isStopped=!0,SoundManager.removeChannel(this),this.completeHandler=null,this._audio&&("pause"in this._audio&&LayaEnv.isConch&&this._audio.stop(),this._audio.pause(),this._audio.removeEventListener("ended",this._onEnd),this._audio.removeEventListener("canplay",this._resumePlay),ILaya.Browser.onIE||this._audio!=AudioSound._musicAudio&&Pool.recover("audio:"+this.url,this._audio),Browser.removeElement(this._audio),this._audio=null,SoundManager.autoReleaseSound&&SoundManager.disposeSoundLater(this.url))}pause(){this.isStopped=!0,SoundManager.removeChannel(this),this._audio&&("pause"in this._audio&&this._audio.pause(),SoundManager.autoReleaseSound&&SoundManager.disposeSoundLater(this.url))}resume(){var e=this._audio;e&&(this.isStopped=!1,0==e.readyState&&(e.src=this._src,e.addEventListener("canplay",this._resumePlay),e.load()),SoundManager.addChannel(this),"play"in e&&e.play())}set volume(e){this._audio&&(this._audio.volume=e)}get volume(){return this._audio?this._audio.volume:1}}class AudioSound extends EventDispatcher{constructor(){super(...arguments),this.loaded=!1}dispose(){var e=AudioSound._audioCache[this.url];Pool.clearBySign("audio:"+this.url),e&&(LayaEnv.isConch||(e.src=""),delete AudioSound._audioCache[this.url])}static _initMusicAudio(){AudioSound._musicAudio||(AudioSound._musicAudio||(AudioSound._musicAudio=Browser.createElement("audio")),LayaEnv.isConch||Browser.document.addEventListener("mousedown",AudioSound._makeMusicOK))}static _makeMusicOK(){Browser.document.removeEventListener("mousedown",AudioSound._makeMusicOK),AudioSound._musicAudio.src?AudioSound._musicAudio.play():(AudioSound._musicAudio.src="",AudioSound._musicAudio.load())}load(e){var t;if(this.url=e,e==SoundManager._bgMusic?(AudioSound._initMusicAudio(),(t=AudioSound._musicAudio).originalUrl!=e&&(delete AudioSound._audioCache[t.originalUrl],t=null)):t=AudioSound._audioCache[e],t&&t.readyState>=2)this.event(Event.COMPLETE);else{t||(e==SoundManager._bgMusic?(AudioSound._initMusicAudio(),t=AudioSound._musicAudio):t=Browser.createElement("audio"),AudioSound._audioCache[e]=t,AssetDb.inst.resolveURL(e,(e=>{t.src=URL.postFormatURL(URL.formatURL(e))}))),t.originalUrl=e,t.addEventListener("canplaythrough",onLoaded),t.addEventListener("error",onErr);var r=this;this.audio=t,t.load?t.load():onErr()}function onLoaded(){offs(),r.loaded=!0,r.event(Event.COMPLETE)}function onErr(){t.load=null,offs(),r.event(Event.ERROR)}function offs(){t.removeEventListener("canplaythrough",onLoaded),t.removeEventListener("error",onErr)}}play(e=0,t=0){if(!this.url)return null;var r,i;if(this.url==SoundManager._bgMusic?""!=(r=AudioSound._musicAudio).src&&r.originalUrl!=this.url&&(delete AudioSound._audioCache[r.originalUrl],AudioSound._audioCache[this.url]=r):r=AudioSound._audioCache[this.url],!r)return null;i=Pool.getItem("audio:"+this.url),LayaEnv.isConch?i||(i=Browser.createElement("audio"),AssetDb.inst.resolveURL(this.url,(e=>{i.src=URL.postFormatURL(URL.formatURL(e))}))):this.url==SoundManager._bgMusic?(AudioSound._initMusicAudio(),i=AudioSound._musicAudio,AssetDb.inst.resolveURL(this.url,(e=>{i.src=URL.postFormatURL(URL.formatURL(e))}))):i=i||r.cloneNode(!0),i.originalUrl=this.url;var a=new AudioSoundChannel(i);return a.url=this.url,a.loops=t,a.startTime=e,a.play(),SoundManager.addChannel(a),a}get duration(){var e;return(e=AudioSound._audioCache[this.url])?e.duration:0}}AudioSound._audioCache={};class WebAudioSoundChannel extends SoundChannel{constructor(){super(),this.bufferSource=null,this._currentTime=0,this._volume=1,this._startTime=0,this._pauseTime=0,this.context=WebAudioSound.ctx,this._onPlayEnd=this.__onPlayEnd.bind(this),this.context.createGain?this.gain=this.context.createGain():this.gain=this.context.createGainNode()}play(){if(SoundManager.addChannel(this),this.isStopped=!1,this._clearBufferSource(),this.audioBuffer){if(this.startTime>=this.duration)return this.stop();var e=this.context,t=this.gain,r=e.createBufferSource();this.bufferSource=r,r.buffer=this.audioBuffer,r.connect(t),t&&t.disconnect(),t.connect(e.destination),r.onended=this._onPlayEnd,this._startTime=Browser.now(),this.gain.gain.setTargetAtTime?this.gain.gain.setTargetAtTime(this._volume,this.context.currentTime,WebAudioSoundChannel.SetTargetDelay):this.gain.gain.value=this._volume,0==this.loops&&(r.loop=!0),r.playbackRate.setTargetAtTime?r.playbackRate.setTargetAtTime(SoundManager.playbackRate,this.context.currentTime,WebAudioSoundChannel.SetTargetDelay):r.playbackRate.value=SoundManager.playbackRate,r.start(0,this.startTime),this._currentTime=0}}__onPlayEnd(){if(1==this.loops)return this.completeHandler&&(ILaya.timer.once(10,this,this.__runComplete,[this.completeHandler],!1),this.completeHandler=null),this.stop(),void this.event(Event.COMPLETE);this.loops>0&&this.loops--,this.startTime=0,this.play()}get position(){return this.bufferSource?(Browser.now()-this._startTime)/1e3+this.startTime:0}get duration(){return this.audioBuffer?this.audioBuffer.duration:0}_clearBufferSource(){if(this.bufferSource){var e=this.bufferSource;e.stop?e.stop(0):e.noteOff(0),e.disconnect(0),e.onended=null,WebAudioSoundChannel._tryCleanFailed||this._tryClearBuffer(e),this.bufferSource=null}}_tryClearBuffer(e){try{e.buffer=null}catch(e){WebAudioSoundChannel._tryCleanFailed=!0}}stop(){super.stop(),this._clearBufferSource(),this.audioBuffer=null,this.gain&&this.gain.disconnect(),this.isStopped=!0,SoundManager.removeChannel(this),this.completeHandler=null,SoundManager.autoReleaseSound&&SoundManager.disposeSoundLater(this.url)}pause(){this.isStopped||(this._pauseTime=this.position),this._clearBufferSource(),this.gain&&this.gain.disconnect(),this.isStopped=!0,SoundManager.removeChannel(this),SoundManager.autoReleaseSound&&SoundManager.disposeSoundLater(this.url)}resume(){this.startTime=this._pauseTime,this.play()}set volume(e){this._volume=e,this.isStopped||(this.gain.gain.setTargetAtTime?this.gain.gain.setTargetAtTime(e,this.context.currentTime,WebAudioSoundChannel.SetTargetDelay):this.gain.gain.value=e)}get volume(){return this._volume}}WebAudioSoundChannel._tryCleanFailed=!1,WebAudioSoundChannel.SetTargetDelay=.001;class WebAudioSound extends EventDispatcher{constructor(){super(...arguments),this.loaded=!1,this._disposed=!1}static _playEmptySound(){if(null!=WebAudioSound.ctx){var e=WebAudioSound.ctx.createBufferSource();e.buffer=WebAudioSound._miniBuffer,e.connect(WebAudioSound.ctx.destination),e.start(0,0,0)}}static _unlock(){WebAudioSound._unlocked||(WebAudioSound._playEmptySound(),"running"==WebAudioSound.ctx.state&&(window.document.removeEventListener("mousedown",WebAudioSound._unlock,!0),window.document.removeEventListener("touchend",WebAudioSound._unlock,!0),window.document.removeEventListener("touchstart",WebAudioSound._unlock,!0),WebAudioSound._unlocked=!0))}static initWebAudio(){WebAudioSound.ctx=new(window.AudioContext||window.webkitAudioContext||window.mozAudioContext),"running"!=WebAudioSound.ctx.state&&(WebAudioSound._unlock(),window.document.addEventListener("mousedown",WebAudioSound._unlock,!0),window.document.addEventListener("touchend",WebAudioSound._unlock,!0),window.document.addEventListener("touchstart",WebAudioSound._unlock,!0))}load(e){this.url=e,this.audioBuffer=ILaya.loader.getRes(e),this.audioBuffer?this._loaded(this.audioBuffer):ILaya.loader.load(e,Loader.SOUND).then((e=>this._loaded(e)))}_loaded(e){this._disposed||(this.audioBuffer=e,this.loaded=!0,this.event(Event.COMPLETE))}__playAfterLoaded(){if(this.__toPlays){var e,t,r,i;for(t=(r=this.__toPlays).length,e=0;e<t;e++)(i=r[e])[2]&&!i[2].isStopped&&this.play(i[0],i[1],i[2]);this.__toPlays.length=0}}play(e=0,t=0,r=null){return r=r||new WebAudioSoundChannel,this.audioBuffer||this.url&&(this.__toPlays||(this.__toPlays=[]),this.__toPlays.push([e,t,r]),this.once(Event.COMPLETE,this,this.__playAfterLoaded),this.load(this.url)),r.url=this.url,r.loops=t,r.audioBuffer=this.audioBuffer,r.startTime=e,r.play(),SoundManager.addChannel(r),r}get duration(){return this.audioBuffer?this.audioBuffer.duration:0}dispose(){this._disposed=!0,this.audioBuffer&&(ILaya.loader.clearRes(this.url,this.audioBuffer),this.audioBuffer=null),this.__toPlays=[]}}WebAudioSound._miniBuffer=WebAudioSound.ctx?WebAudioSound.ctx.createBuffer(1,1,22050):void 0,WebAudioSound._unlocked=!1;class SoundManager{static __init__(){var e=ILaya.Browser.window,t=!!(e.AudioContext||e.webkitAudioContext||e.mozAudioContext);return t&&WebAudioSound.initWebAudio(),SoundManager._soundClass=t?WebAudioSound:AudioSound,Browser.onTBMiniGame||AudioSound._initMusicAudio(),SoundManager._musicClass=AudioSound,t}static addChannel(e){SoundManager._channels.indexOf(e)>=0||SoundManager._channels.push(e)}static removeChannel(e){for(let t=SoundManager._channels.length-1;t>=0;t--)SoundManager._channels[t]==e&&SoundManager._channels.splice(t,1)}static disposeSoundLater(e){SoundManager._lastSoundUsedTimeDic[e]=ILaya.Browser.now(),SoundManager._isCheckingDispose||(SoundManager._isCheckingDispose=!0,ILaya.timer.loop(5e3,null,SoundManager._checkDisposeSound))}static _checkDisposeSound(){let e=ILaya.Browser.now(),t=!1;for(let r in SoundManager._lastSoundUsedTimeDic)e-SoundManager._lastSoundUsedTimeDic[r]>3e4?(delete SoundManager._lastSoundUsedTimeDic[r],SoundManager.disposeSoundIfNotUsed(r)):t=!0;t||(SoundManager._isCheckingDispose=!1,ILaya.timer.clear(null,SoundManager._checkDisposeSound))}static disposeSoundIfNotUsed(e){for(let t=SoundManager._channels.length-1;t>=0;t--)if(SoundManager._channels[t].url==e)return;SoundManager.destroySound(e)}static set autoStopMusic(e){ILaya.stage.off(Event.BLUR,null,SoundManager._stageOnBlur),ILaya.stage.off(Event.FOCUS,null,SoundManager._stageOnFocus),ILaya.stage.off(Event.VISIBILITY_CHANGE,null,SoundManager._visibilityChange),SoundManager._autoStopMusic=e,e&&(ILaya.stage.on(Event.BLUR,null,SoundManager._stageOnBlur),ILaya.stage.on(Event.FOCUS,null,SoundManager._stageOnFocus),ILaya.stage.on(Event.VISIBILITY_CHANGE,null,SoundManager._visibilityChange))}static get autoStopMusic(){return SoundManager._autoStopMusic}static _visibilityChange(){ILaya.stage.isVisibility?SoundManager._stageOnFocus():SoundManager._stageOnBlur()}static _stageOnBlur(){SoundManager._isActive=!1,SoundManager._musicChannel&&(SoundManager._musicChannel.isStopped||(SoundManager._blurPaused=!0,SoundManager._musicChannel.pause())),SoundManager.stopAllSound(),ILaya.stage.once(Event.MOUSE_DOWN,null,SoundManager._stageOnFocus)}static _recoverWebAudio(){WebAudioSound.ctx&&"running"!=WebAudioSound.ctx.state&&WebAudioSound.ctx.resume&&WebAudioSound.ctx.resume()}static _stageOnFocus(){SoundManager._isActive=!0,SoundManager._recoverWebAudio(),ILaya.stage.off(Event.MOUSE_DOWN,null,SoundManager._stageOnFocus),SoundManager._blurPaused&&SoundManager._musicChannel&&SoundManager._musicChannel.isStopped&&(SoundManager._blurPaused=!1,SoundManager._musicChannel.resume())}static set muted(e){e!=SoundManager._muted&&(e&&SoundManager.stopAllSound(),SoundManager.musicMuted=e,SoundManager._muted=e)}static get muted(){return SoundManager._muted}static set soundMuted(e){SoundManager._soundMuted=e}static get soundMuted(){return SoundManager._soundMuted}static set musicMuted(e){e!=SoundManager._musicMuted&&(e?(SoundManager._bgMusic&&SoundManager._musicChannel&&!SoundManager._musicChannel.isStopped?LayaEnv.isConch?SoundManager._musicChannel._audio&&(SoundManager._musicChannel._audio.muted=!0):SoundManager._musicChannel.pause():SoundManager._musicChannel=null,SoundManager._musicMuted=e):(SoundManager._musicMuted=e,SoundManager._bgMusic&&SoundManager._musicChannel&&(LayaEnv.isConch?SoundManager._musicChannel._audio&&(SoundManager._musicChannel._audio.muted=!1):SoundManager._musicChannel.resume())))}static get musicMuted(){return SoundManager._musicMuted}static get useAudioMusic(){return SoundManager._useAudioMusic}static set useAudioMusic(e){SoundManager._useAudioMusic=e,SoundManager._musicClass=e?AudioSound:null}static playSound(e,t=1,r=null,i=null,a=0){if(!SoundManager._isActive||!e)return null;if(SoundManager._muted)return null;if(SoundManager._recoverWebAudio(),e==SoundManager._bgMusic){if(SoundManager._musicMuted)return null}else if(SoundManager._soundMuted)return null;let s;Browser._isMiniGame||(s=SoundManager._soundCache[e]),i||(i=SoundManager._soundClass),s||(s=new i,s.load(e),Browser._isMiniGame||(SoundManager._soundCache[e]=s));let n=s.play(a,t);return n?(n.url=e,n.volume=e==SoundManager._bgMusic?SoundManager.musicVolume:SoundManager.soundVolume,n.completeHandler=r,n):null}static destroySound(e){let t=SoundManager._soundCache[e];t&&(delete SoundManager._soundCache[e],t.dispose())}static playMusic(e,t=0,r=null,i=0){return SoundManager._bgMusic=e,SoundManager._musicChannel&&SoundManager._musicChannel.stop(),SoundManager._musicChannel=SoundManager.playSound(e,t,r,SoundManager._musicClass,i)}static stopSound(e){for(let t=SoundManager._channels.length-1;t>=0;t--){let r=SoundManager._channels[t];r.url==e&&r.stop()}}static stopAll(){var e;for(SoundManager._bgMusic=null,e=SoundManager._channels.length-1;e>=0;e--)SoundManager._channels[e].stop()}static stopAllSound(){for(let e=SoundManager._channels.length-1;e>=0;e--){let t=SoundManager._channels[e];t.url!=SoundManager._bgMusic&&t.stop()}}static stopMusic(){SoundManager._musicChannel&&SoundManager._musicChannel.stop(),SoundManager._bgMusic=null}static setSoundVolume(e,t=null){if(t)SoundManager._setVolume(t,e);else{SoundManager.soundVolume=e;for(let t=SoundManager._channels.length-1;t>=0;t--){let r=SoundManager._channels[t];r.url!=SoundManager._bgMusic&&(r.volume=e)}}}static setMusicVolume(e){SoundManager.musicVolume=e,SoundManager._setVolume(SoundManager._bgMusic,e)}static _setVolume(e,t){for(let r=SoundManager._channels.length-1;r>=0;r--){let i=SoundManager._channels[r];i.url==e&&(i.volume=t)}}}SoundManager.musicVolume=1,SoundManager.soundVolume=1,SoundManager.playbackRate=1,SoundManager._useAudioMusic=!0,SoundManager._muted=!1,SoundManager._soundMuted=!1,SoundManager._musicMuted=!1,SoundManager._bgMusic=null,SoundManager._musicChannel=null,SoundManager._channels=[],SoundManager._blurPaused=!1,SoundManager._isActive=!0,SoundManager._lastSoundUsedTimeDic={},SoundManager._isCheckingDispose=!1,SoundManager._soundCache={},SoundManager.autoReleaseSound=!0;class LocalStorage{static __init__(){return LocalStorage._baseClass||(LocalStorage._baseClass=Storage,Storage.init()),LocalStorage.items=LocalStorage._baseClass.items,LocalStorage.support=LocalStorage._baseClass.support,LocalStorage.support}static setItem(e,t){LocalStorage._baseClass.setItem(e,t)}static getItem(e){return LocalStorage._baseClass.getItem(e)}static setJSON(e,t){LocalStorage._baseClass.setJSON(e,t)}static getJSON(e){return LocalStorage._baseClass.getJSON(e)}static removeItem(e){LocalStorage._baseClass.removeItem(e)}static clear(){LocalStorage._baseClass.clear()}}LocalStorage.support=!1;class Storage{static init(){try{Storage.support=!0,Storage.items=window.localStorage,Storage.setItem("laya","1"),Storage.removeItem("laya")}catch(e){Storage.support=!1}Storage.support||console.log("LocalStorage is not supprot or browser is private mode.")}static setItem(e,t){try{Storage.support&&Storage.items.setItem(e,t)}catch(e){console.warn("set localStorage failed",e)}}static getItem(e){return Storage.support?Storage.items.getItem(e):null}static setJSON(e,t){try{Storage.support&&Storage.items.setItem(e,JSON.stringify(t))}catch(e){console.warn("set localStorage failed",e)}}static getJSON(e){try{return JSON.parse(Storage.support?Storage.items.getItem(e):null)}catch(t){return Storage.items.getItem(e)}}static removeItem(e){Storage.support&&Storage.items.removeItem(e)}static clear(){Storage.support&&Storage.items.clear()}}Storage.support=!1;class PrimitiveSV extends Value2D{constructor(){super(e.RenderSpriteData.Primitive),PrimitiveSV.prototype.initialize.call(this)}initialize(){this._defaultShader=Shader3D.find("Sprite2DPrimitive")}reinit(){super.initialize(),this.initialize()}}class TextureSV extends Value2D{constructor(){super(e.RenderSpriteData.Texture2D),TextureSV.prototype.initialize.call(this)}initialize(){this._blurInfo=new Vector2,this._u_blurInfo1=new Vector4,this._u_blurInfo2=new Vector4,this._u_TexRange=new Vector4,this._colorMat=new Matrix4x4,this._colorAlpha=new Vector4,this._strength_sig2_2sig2_gauss1=new Vector4,this._defaultShader=Shader3D.find("Sprite2DTexture"),this.blurInfo=this._blurInfo,this.u_blurInfo1=this._u_blurInfo1,this.u_blurInfo2=this._u_blurInfo2,this.u_TexRange=this._u_TexRange,this.colorMat=this._colorMat,this.colorAlpha=this._colorAlpha,this.strength_sig2_2sig2_gauss1=this._strength_sig2_2sig2_gauss1}reinit(){super.initialize(),this.initialize()}get blurInfo(){return this.shaderData.getVector2(ShaderDefines2D.UNIFORM_BLURINFO)}set blurInfo(e){this.shaderData.setVector2(ShaderDefines2D.UNIFORM_BLURINFO,e)}get u_blurInfo1(){return this.shaderData.getVector(ShaderDefines2D.UNIFORM_BLURINFO1)}set u_blurInfo1(e){this.shaderData.setVector(ShaderDefines2D.UNIFORM_BLURINFO1,e)}get u_blurInfo2(){return this.shaderData.getVector(ShaderDefines2D.UNIFORM_BLURINFO2)}set u_blurInfo2(e){this.shaderData.setVector(ShaderDefines2D.UNIFORM_BLURINFO2,e)}get u_TexRange(){return this.shaderData.getVector(ShaderDefines2D.UNIFORM_TEXRANGE)}set u_TexRange(e){this.shaderData.setVector(ShaderDefines2D.UNIFORM_TEXRANGE,e)}get colorMat(){return this.shaderData.getMatrix4x4(ShaderDefines2D.UNIFORM_COLORMAT)}set colorMat(e){this.shaderData.setMatrix4x4(ShaderDefines2D.UNIFORM_COLORMAT,e)}get colorAlpha(){return this.shaderData.getVector(ShaderDefines2D.UNIFORM_COLORALPHA)}set colorAlpha(e){this.shaderData.setVector(ShaderDefines2D.UNIFORM_COLORALPHA,e)}get strength_sig2_2sig2_gauss1(){return this.shaderData.getVector(ShaderDefines2D.UNIFORM_STRENGTH_SIG2_2SIG2_GAUSS1)}set strength_sig2_2sig2_gauss1(e){this.shaderData.setVector(ShaderDefines2D.UNIFORM_STRENGTH_SIG2_2SIG2_GAUSS1,e)}clear(){this.shaderData.getDefineData().clear(),this.shaderData.destroy()}}class Mouse{static set cursor(e){Mouse._style.cursor=e}static get cursor(){return Mouse._style.cursor}static __init__(){Mouse._style=Browser.document.body.style}static hide(){"none"!=Mouse.cursor&&(Mouse._preCursor=Mouse.cursor,Mouse.cursor="none")}static show(){"none"==Mouse.cursor&&(Mouse._preCursor?Mouse.cursor=Mouse._preCursor:Mouse.cursor="auto")}}class MeshParticle2D extends Mesh2D{constructor(e){super(MeshParticle2D.const_stride,4*e*MeshParticle2D.const_stride,4)}static __init__(){LayaGL.renderEngine.getParams(e.RenderParams.FLOAT),MeshParticle2D.vertexDeclaration=new VertexDeclaration(116,[new VertexElement(0,VertexElementFormat.Vector4,0),new VertexElement(16,VertexElementFormat.Vector3,1),new VertexElement(28,VertexElementFormat.Vector3,2),new VertexElement(40,VertexElementFormat.Vector4,3),new VertexElement(56,VertexElementFormat.Vector4,4),new VertexElement(72,VertexElementFormat.Vector3,5),new VertexElement(84,VertexElementFormat.Vector2,6),new VertexElement(92,VertexElementFormat.Vector4,7),new VertexElement(108,VertexElementFormat.Single,8),new VertexElement(112,VertexElementFormat.Single,9)])}setMaxParticleNum(e){}onVBRealloc(e){}onIBRealloc(e){}get vertexDeclarition(){return MeshParticle2D.vertexDeclaration}}MeshParticle2D.const_stride=116,MeshParticle2D.vertexDeclaration=null;class WeakObject{constructor(){this._obj={},WeakObject._maps.push(this)}static __init__(){WeakObject.I=new WeakObject,WeakObject.supportWeakMap||ILaya.systemTimer.loop(WeakObject.delInterval,null,WeakObject.clearCache)}static clearCache(){for(var e=0,t=WeakObject._maps.length;e<t;e++){WeakObject._maps[e]._obj={}}}set(e,t){null!=e&&(WeakObject.supportWeakMap||("string"==typeof e||"number"==typeof e?this._obj[e]=t:(e.$_GID||(e.$_GID=Utils.getGID()),this._obj[e.$_GID]=t)))}get(e){return null==e?null:WeakObject.supportWeakMap?void 0:"string"==typeof e||"number"==typeof e?this._obj[e]:this._obj[e.$_GID]}del(e){null!=e&&(WeakObject.supportWeakMap||("string"==typeof e||"number"==typeof e?delete this._obj[e]:delete this._obj[this._obj.$_GID]))}has(e){return null!=e&&(!WeakObject.supportWeakMap&&("string"==typeof e||"number"==typeof e?null!=this._obj[e]:null!=this._obj[this._obj.$_GID]))}}WeakObject.supportWeakMap=!1,WeakObject.delInterval=6e5,WeakObject._maps=[];class Config3D{static setResolution(e,t){Config3D.customResolution=!0,Config3D._resoluWidth=e,Config3D._resoluHeight=t}}Config3D.enableDynamicBatch=!0,Config3D.enableStaticBatch=!0,Config3D.enableUniformBufferObject=!0,Config3D.pixelRatio=1,Config3D.customResolution=!1,Config3D.defaultCacheRTMemory=256,Config3D.defaultPhysicsMemory=16,Config3D.enableMultiLight=!0,Config3D.maxLightCount=32,Config3D.lightClusterCount=new Vector3(12,12,12),Config3D.maxMorphTargetCount=32,Config3D.useBVHCull=!1,Config3D.BVH_max_SpatialCount=7,Config3D.BVH_limit_size=32,Config3D.BVH_Min_Build_nums=10,Config3D._resoluWidth=-1,Config3D._resoluHeight=-1,Config3D.debugFrustumCulling=!1,Config.isStencil=!0;class UniformBufferBase{constructor(e,t,r){this._mapArray=[],this._blockName=e,this._singgle=r,this._glPointerID=t}add(e){-1==this._mapArray.indexOf(e)&&this._mapArray.push(e)}splitBuffer(e){let t=this._mapArray.indexOf(e);-1!=t&&this._mapArray.splice(t,1)}}class UniformBufferObject{constructor(t,r,i,a,s){this._isSingle=!1,this.bufferType=e.BufferTargetType.UNIFORM_BUFFER,this.bufferUsage=i,this._glPointer=t,this.byteLength=a,this._name=r,this._isSingle=s,this._glBuffer=LayaGL.renderEngine.createBuffer(e.BufferTargetType.UNIFORM_BUFFER,i),this.bind(),this._isSingle&&this._bindUniformBufferBase(),this._glBuffer.setDataLength(this.byteLength)}static create(e,t,r,i=!1){UniformBufferObject._Map.get(e)||UniformBufferObject._Map.set(e,new UniformBufferBase(e,LayaGL.renderEngine.getUBOPointer(e),i));let a=UniformBufferObject._Map.get(e);if(a._singgle&&a._mapArray.length>0)return null;{let s=LayaGL.renderOBJCreate.createUniformBufferObject(a._glPointerID,e,t,r,i);return a._singgle&&a.add(s),s}}static getBuffer(e,t){let r=UniformBufferObject._Map.get(e);return r?r._mapArray[t]:null}_bindUniformBufferBase(){this._glBuffer.bindBufferBase(this._glPointer)}_bindBufferRange(e,t){this.bind(),this._glBuffer.bindBufferRange(this._glPointer,e,t)}_reset(e){this._glBuffer&&(this._glBuffer.destroy(),this._glBuffer=null),this.byteLength=e,this._glBuffer=LayaGL.renderEngine.createBuffer(this.bufferType,this.bufferUsage),this._isSingle&&this._bindUniformBufferBase(),this._glBuffer.setDataLength(this.byteLength)}bind(){return this._glBuffer.bindBuffer()}setData(e,t=0,r=Number.MAX_SAFE_INTEGER){if(!(r<0))if(this.bind(),!(0==t&&r==this.byteLength)){var i=new Uint8Array(e.buffer,t,r);this._glBuffer.setData(i,t)}else this._glBuffer.setDataEx(e,t,e.length)}setDataByUniformBufferData(e){this._updateDataInfo==e?(this.setData(e._buffer,4*e._updateFlag.x,4*(e._updateFlag.y-e._updateFlag.x)),e._resetUpdateFlag()):(this.setData(e._buffer,0,this.byteLength),e._resetUpdateFlag(),this._updateDataInfo=e)}setDataByByUniformBufferDataOffset(e,t){let r=e.getbyteLength(),i=e._realByte;e._resetUpdateFlag(),this.bind(),this._glBuffer.setDataEx(e._buffer,t*r,i/4)}destroy(){this._glBuffer&&(this._glBuffer.destroy(),this._glBuffer=null)}}var st;UniformBufferObject.UBONAME_SCENE="SceneUniformBlock",UniformBufferObject.UBONAME_CAMERA="CameraUniformBlock",UniformBufferObject.UBONAME_SPRITE3D="SpriteUniformBlock",UniformBufferObject.UBONAME_SHADOW="ShadowUniformBlock",UniformBufferObject._Map=new Map,e.MaterialRenderMode=void 0,(st=e.MaterialRenderMode||(e.MaterialRenderMode={}))[st.RENDERMODE_OPAQUE=0]="RENDERMODE_OPAQUE",st[st.RENDERMODE_CUTOUT=1]="RENDERMODE_CUTOUT",st[st.RENDERMODE_TRANSPARENT=2]="RENDERMODE_TRANSPARENT",st[st.RENDERMODE_ADDTIVE=3]="RENDERMODE_ADDTIVE",st[st.RENDERMODE_ALPHABLENDED=4]="RENDERMODE_ALPHABLENDED",st[st.RENDERMODE_CUSTOME=5]="RENDERMODE_CUSTOME";class Material extends Resource{constructor(){super(),this._shaderValues=LayaGL.renderDeviceFactory.createShaderData(this),this.renderQueue=Material.RENDERQUEUE_OPAQUE,this._matRenderNode=0,this.alphaTest=!1,this.cull=RenderState.CULL_BACK,this.blend=RenderState.BLEND_DISABLE,this.blendSrc=RenderState.BLENDPARAM_ONE,this.blendDst=RenderState.BLENDPARAM_ZERO,this.blendSrcRGB=RenderState.BLENDPARAM_ONE,this.blendDstRGB=RenderState.BLENDPARAM_ZERO,this.blendSrcAlpha=RenderState.BLENDPARAM_ONE,this.blendDstAlpha=RenderState.BLENDPARAM_ZERO,this.blendEquation=RenderState.BLENDEQUATION_ADD,this.blendEquationRGB=RenderState.BLENDEQUATION_ADD,this.blendEquationAlpha=RenderState.BLENDEQUATION_ADD,this.depthTest=RenderState.DEPTHTEST_LEQUAL,this.depthWrite=!0,this.stencilRef=1,this.stencilTest=RenderState.STENCILTEST_OFF,this.stencilWrite=!1,this.stencilOp=new Vector3(RenderState.STENCILOP_KEEP,RenderState.STENCILOP_KEEP,RenderState.STENCILOP_REPLACE),this.destroyedImmediately=Config.destroyResourceImmediatelyDefault}static load(e,t){ILaya.loader.load(e,t,null,Loader.MATERIAL)}static __initDefine__(){Material.SHADERDEFINE_ALPHATEST=Shader3D.getDefineByName("ALPHATEST"),Material.SHADERDEFINE_MAINTEXTURE=Shader3D.getDefineByName("MAINTEXTURE"),Material.SHADERDEFINE_ADDTIVEFOG=Shader3D.getDefineByName("ADDTIVEFOG"),Material.ALPHATESTVALUE=Shader3D.propertyNameToID("u_AlphaTestValue"),Shader3D.CULL=Shader3D.propertyNameToID("s_Cull"),Shader3D.BLEND=Shader3D.propertyNameToID("s_Blend"),Shader3D.BLEND_SRC=Shader3D.propertyNameToID("s_BlendSrc"),Shader3D.BLEND_DST=Shader3D.propertyNameToID("s_BlendDst"),Shader3D.BLEND_SRC_RGB=Shader3D.propertyNameToID("s_BlendSrcRGB"),Shader3D.BLEND_DST_RGB=Shader3D.propertyNameToID("s_BlendDstRGB"),Shader3D.BLEND_SRC_ALPHA=Shader3D.propertyNameToID("s_BlendSrcAlpha"),Shader3D.BLEND_DST_ALPHA=Shader3D.propertyNameToID("s_BlendDstAlpha"),Shader3D.BLEND_EQUATION=Shader3D.propertyNameToID("s_BlendEquation"),Shader3D.BLEND_EQUATION_RGB=Shader3D.propertyNameToID("s_BlendEquationRGB"),Shader3D.BLEND_EQUATION_ALPHA=Shader3D.propertyNameToID("s_BlendEquationAlpha"),Shader3D.DEPTH_TEST=Shader3D.propertyNameToID("s_DepthTest"),Shader3D.DEPTH_WRITE=Shader3D.propertyNameToID("s_DepthWrite"),Shader3D.STENCIL_Ref=Shader3D.propertyNameToID("s_StencilRef"),Shader3D.STENCIL_TEST=Shader3D.propertyNameToID("s_StencilTest"),Shader3D.STENCIL_WRITE=Shader3D.propertyNameToID("s_StencilWrite"),Shader3D.STENCIL_Op=Shader3D.propertyNameToID("s_StencilOp")}get renderQueue(){return this._renderQueue}set renderQueue(e){this._renderQueue=e,this.ownerELement&&(this.ownerELement.material=this)}get shaderData(){return this._shaderValues}get alphaTestValue(){return this._shaderValues.getNumber(Material.ALPHATESTVALUE)}set alphaTestValue(e){this._shaderValues.setNumber(Material.ALPHATESTVALUE,e)}get alphaTest(){return this.shaderData.hasDefine(Material.SHADERDEFINE_ALPHATEST)}set alphaTest(e){e?this._shaderValues.addDefine(Material.SHADERDEFINE_ALPHATEST):this._shaderValues.removeDefine(Material.SHADERDEFINE_ALPHATEST)}addDefine(e){this._shaderValues.addDefine(e)}removeDefine(e){this._shaderValues.removeDefine(e)}setDefine(e,t){t?this._shaderValues.addDefine(e):this._shaderValues.removeDefine(e)}hasDefine(e){return this._shaderValues.hasDefine(e)}get depthWrite(){return this._shaderValues.getBool(Shader3D.DEPTH_WRITE)}set depthWrite(e){this._shaderValues.setBool(Shader3D.DEPTH_WRITE,e)}get cull(){return this._shaderValues.getInt(Shader3D.CULL)}set cull(e){this._shaderValues.setInt(Shader3D.CULL,e)}get blend(){return this._shaderValues.getInt(Shader3D.BLEND)}set blend(e){this._shaderValues.setInt(Shader3D.BLEND,e)}get blendSrc(){return this._shaderValues.getInt(Shader3D.BLEND_SRC)}set blendSrc(e){this._shaderValues.setInt(Shader3D.BLEND_SRC,e)}get blendDst(){return this._shaderValues.getInt(Shader3D.BLEND_DST)}set blendDst(e){this._shaderValues.setInt(Shader3D.BLEND_DST,e)}get blendSrcAlpha(){return this._shaderValues.getInt(Shader3D.BLEND_SRC_ALPHA)}set blendSrcAlpha(e){this._shaderValues.setInt(Shader3D.BLEND_SRC_ALPHA,e)}get blendSrcRGB(){return this._shaderValues.getInt(Shader3D.BLEND_SRC_RGB)}set blendSrcRGB(e){this._shaderValues.setInt(Shader3D.BLEND_SRC_RGB,e)}get blendDstRGB(){return this._shaderValues.getInt(Shader3D.BLEND_DST_RGB)}set blendDstRGB(e){this._shaderValues.setInt(Shader3D.BLEND_DST_RGB,e)}get blendDstAlpha(){return this._shaderValues.getInt(Shader3D.BLEND_DST_ALPHA)}set blendDstAlpha(e){this._shaderValues.setInt(Shader3D.BLEND_DST_ALPHA,e)}get blendEquation(){return this._shaderValues.getInt(Shader3D.BLEND_EQUATION)}set blendEquation(e){this._shaderValues.setInt(Shader3D.BLEND_EQUATION,e)}get blendEquationRGB(){return this._shaderValues.getInt(Shader3D.BLEND_EQUATION_RGB)}set blendEquationRGB(e){this._shaderValues.setInt(Shader3D.BLEND_EQUATION_RGB,e)}get blendEquationAlpha(){return this._shaderValues.getInt(Shader3D.BLEND_EQUATION_ALPHA)}set blendEquationAlpha(e){this._shaderValues.setInt(Shader3D.BLEND_EQUATION_ALPHA,e)}get depthTest(){return this._shaderValues.getInt(Shader3D.DEPTH_TEST)}set depthTest(e){this._shaderValues.setInt(Shader3D.DEPTH_TEST,e)}get stencilTest(){return this._shaderValues.getInt(Shader3D.STENCIL_TEST)}set stencilTest(e){this._shaderValues.setInt(Shader3D.STENCIL_TEST,e)}get stencilWrite(){return this._shaderValues.getBool(Shader3D.STENCIL_WRITE)}set stencilWrite(e){this._shaderValues.setBool(Shader3D.STENCIL_WRITE,e)}set stencilRef(e){this._shaderValues.setInt(Shader3D.STENCIL_Ref,e)}get stencilRef(){return this._shaderValues.getInt(Shader3D.STENCIL_Ref)}set stencilOp(e){this._shaderValues.setVector3(Shader3D.STENCIL_Op,e)}get stencilOp(){return this._shaderValues.getVector3(Shader3D.STENCIL_Op)}get MaterialProperty(){let e={};var t=this._shaderValues.getData();for(let r in t)e[LayaGL.renderEngine.propertyIDToName(parseInt(r))]=t[r];return e}get MaterialDefine(){let e=new Array,t=this._shaderValues.getDefineData();return Shader3D._getNamesByDefineData(t,e),e}set materialRenderMode(t){switch(this._matRenderNode=t,t){case e.MaterialRenderMode.RENDERMODE_OPAQUE:this.alphaTest=!1,this.renderQueue=Material.RENDERQUEUE_OPAQUE,this.depthWrite=!0,this.blend=RenderState.BLEND_DISABLE,this.depthTest=RenderState.DEPTHTEST_LESS;break;case e.MaterialRenderMode.RENDERMODE_CUTOUT:this.renderQueue=Material.RENDERQUEUE_ALPHATEST,this.alphaTest=!0,this.depthWrite=!0,this.blend=RenderState.BLEND_DISABLE,this.depthTest=RenderState.DEPTHTEST_LESS;break;case e.MaterialRenderMode.RENDERMODE_TRANSPARENT:this.renderQueue=Material.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.blend=RenderState.BLEND_ENABLE_ALL,this.blendSrc=RenderState.BLENDPARAM_SRC_ALPHA,this.blendDst=RenderState.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=RenderState.DEPTHTEST_LESS;break;case e.MaterialRenderMode.RENDERMODE_ADDTIVE:this.renderQueue=Material.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.blend=RenderState.BLEND_ENABLE_ALL,this.blendSrc=RenderState.BLENDPARAM_SRC_ALPHA,this.blendDst=RenderState.BLENDPARAM_ONE,this.depthTest=RenderState.DEPTHTEST_LESS,this._shaderValues.addDefine(Material.SHADERDEFINE_ADDTIVEFOG);break;case e.MaterialRenderMode.RENDERMODE_ALPHABLENDED:this.renderQueue=Material.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.blend=RenderState.BLEND_ENABLE_ALL,this.blendSrc=RenderState.BLENDPARAM_SRC_ALPHA,this.blendDst=RenderState.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=RenderState.DEPTHTEST_LESS,this._shaderValues.removeDefine(Material.SHADERDEFINE_ADDTIVEFOG);break;case e.MaterialRenderMode.RENDERMODE_CUSTOME:break;default:console.warn(`Material : renderMode value error - (${t}).`)}}get materialRenderMode(){return this._matRenderNode}_bindShaderInfo(t){let r=t.getSubShaderAt(0)._uniformBufferDataMap;if(r)for(let t of r.keys()){let i=r.get(t).clone(),a=UniformBufferObject.create(t,e.BufferUsage.Dynamic,i.getbyteLength(),!1);this._shaderValues.setUniformBuffer(Shader3D.propertyNameToID(t),a),this._shaderValues._addCheckUBO(t,a,i)}}_releaseUBOData(){this._shaderValues._releaseUBOData()}_disposeResource(){this._releaseUBOData(),this._shaderValues.destroy(),this._shaderValues=null}get shader(){return this._shader}effectiveProperty(){return this._shader.getSubShaderAt(0)._uniformTypeMap}setShaderName(e){this._shader=Shader3D.find(e),this._shader||(console.warn(`Material: unknown shader name '${e}'`),this._shader=Shader3D.find("BLINNPHONG")),Config3D._uniformBlock&&(this._releaseUBOData(),this._bindShaderInfo(this._shader));let t=this._shader.getSubShaderAt(0),r=t._uniformDefaultValue,i=t._uniformTypeMap;this.applyUniformDefaultValue(i,r),this.ownerELement&&(this.ownerELement.material=this)}applyUniformDefaultValue(e,t){e.forEach(((e,r)=>{if(t&&null!=t[r]){let i=t[r];this.setShaderData(r,e,i)}else{let t=ShaderDataDefaultValue(e);t&&this.setShaderData(r,e,t)}}))}getBoolByIndex(e){return this.shaderData.getBool(e)}setBoolByIndex(e,t){this.shaderData.setBool(e,t)}getBool(e){let t=Shader3D.propertyNameToID(e);return this.getBoolByIndex(t)}setBool(e,t){let r=Shader3D.propertyNameToID(e);this.setBoolByIndex(r,t)}getFloatByIndex(e){return this.shaderData.getNumber(e)}setFloatByIndex(e,t){this.shaderData.setNumber(e,t)}getFloat(e){let t=Shader3D.propertyNameToID(e);return this.getFloatByIndex(t)}setFloat(e,t){let r=Shader3D.propertyNameToID(e);this.setFloatByIndex(r,t)}getIntByIndex(e){return this.shaderData.getInt(e)}setIntByIndex(e,t){this.shaderData.setInt(e,t)}getInt(e){let t=Shader3D.propertyNameToID(e);return this.getIntByIndex(t)}setInt(e,t){let r=Shader3D.propertyNameToID(e);this.setIntByIndex(r,t)}getVector2ByIndex(e){return this.shaderData.getVector2(e)}setVector2ByIndex(e,t){this.shaderData.setVector2(e,t)}getVector2(e){let t=Shader3D.propertyNameToID(e);return this.getVector2ByIndex(t)}setVector2(e,t){let r=Shader3D.propertyNameToID(e);this.setVector2ByIndex(r,t)}getVector3ByIndex(e){return this.shaderData.getVector3(e)}setVector3ByIndex(e,t){this.shaderData.setVector3(e,t)}getVector3(e){let t=Shader3D.propertyNameToID(e);return this.getVector3ByIndex(t)}setVector3(e,t){let r=Shader3D.propertyNameToID(e);this.setVector3ByIndex(r,t)}setVector4ByIndex(e,t){this.shaderData.setVector(e,t)}getVector4ByIndex(e){return this.shaderData.getVector(e)}setVector4(e,t){let r=Shader3D.propertyNameToID(e);this.setVector4ByIndex(r,t)}getVector4(e){let t=Shader3D.propertyNameToID(e);return this.getVector4ByIndex(t)}getColorByIndex(e){return this.shaderData.getColor(e)}setColorByIndex(e,t){this.shaderData.setColor(e,t)}getColor(e){let t=Shader3D.propertyNameToID(e);return this.shaderData.getColor(t)}setColor(e,t){let r=Shader3D.propertyNameToID(e);this.setColorByIndex(r,t)}getMatrix4x4ByIndex(e){return this.shaderData.getMatrix4x4(e)}setMatrix4x4ByIndex(e,t){this.shaderData.setMatrix4x4(e,t)}getMatrix4x4(e){let t=Shader3D.propertyNameToID(e);return this.getMatrix4x4ByIndex(t)}setMatrix4x4(e,t){let r=Shader3D.propertyNameToID(e);this.setMatrix4x4ByIndex(r,t)}getMatrix3x3ByIndex(e){return this.shaderData.getMatrix3x3(e)}setMatrix3x3ByIndex(e,t){this.shaderData.setMatrix3x3(e,t)}getMatrix3x3(e){let t=Shader3D.propertyNameToID(e);return this.getMatrix3x3ByIndex(t)}setMatrix3x3(e,t){let r=Shader3D.propertyNameToID(e);this.setMatrix3x3ByIndex(r,t)}setTextureByIndex(e,t){this.shaderData.setTexture(e,t),t&&!t._texture&&t.once(Event.READY,this,this.reSetTexture,[e,t])}reSetTexture(e,t){this.setTextureByIndex(e,t)}getTextureByIndex(e){return this.shaderData.getTexture(e)}setTexture(e,t){let r=Shader3D.propertyNameToID(e);this.setTextureByIndex(r,t)}getTexture(e){let t=Shader3D.propertyNameToID(e);return this.getTextureByIndex(t)}getBufferByIndex(e){return this.shaderData.getBuffer(e)}setBufferByIndex(e,t){this.shaderData.setBuffer(e,t)}getBuffer(e){let t=Shader3D.propertyNameToID(e);return this.getBufferByIndex(t)}setBuffer(e,t){let r=Shader3D.propertyNameToID(e);this.setBufferByIndex(r,t)}setShaderDataByIndex(e,t,r){this.shaderData.setShaderData(e,t,r)}setShaderData(e,t,r){let i=Shader3D.propertyNameToID(e);this.setShaderDataByIndex(i,t,r)}getShaderData(e,t){let r=Shader3D.propertyNameToID(e);return this.getShaderDataByIndex(r,t)}getShaderDataByIndex(e,t){return this._shaderValues.getShaderData(e,t)}cloneTo(e){var t=e;t.name=this.name,t.renderQueue=this.renderQueue,t.setShaderName(this._shader._name),this._shaderValues.cloneTo(t._shaderValues)}clone(){var e=new Material;return this.cloneTo(e),e}get _defineDatas(){return this._shaderValues.getDefineData()}oldparseEndEvent(){}}Material.RENDERQUEUE_OPAQUE=2e3,Material.RENDERQUEUE_ALPHATEST=2450,Material.RENDERQUEUE_TRANSPARENT=3e3;class Laya{static init(...t){if(Laya._inited)return Promise.resolve();if(Laya._inited=!0,!WebGL.enable())throw new Error("Must support webGL!");let r;r="number"==typeof t[0]?{designWidth:t[0],designHeight:t[1]}:t[0],Browser.__init__(),URL.__init__();let i=window.Laya3D;i&&(RunDriver.changeWebGLSize=i._changeWebGLSize,Render.is3DMode=!0);let a=Browser.mainCanvas=new HTMLCanvas(!0);Laya._setStyleInfo(a),Browser.onKGMiniGame||Browser.onAlipayMiniGame||Browser.onTBMiniGame||Browser.container.appendChild(a.source),Browser.canvas=new HTMLCanvas(!0),Browser.context=Browser.canvas.getContext("2d"),Browser.supportWebAudio=SoundManager.__init__(),Browser.supportLocalStorage=LocalStorage.__init__(),e.systemTimer=new Timer(!1),e.physicsTimer=new Timer(!1),e.timer=new Timer(!1),e.loader=new Loader,Laya.systemTimer=Timer.gSysTimer=e.systemTimer,Laya.timer=e.timer,Laya.physicsTimer=e.physicsTimer,Laya.loader=e.loader,ILaya.systemTimer=e.systemTimer,ILaya.physicsTimer=e.physicsTimer,ILaya.timer=e.timer,ILaya.loader=e.loader,WeakObject.__init__(),Mouse.__init__(),LayaEnv.isConch&&Laya.enableNative(),CacheManger.beginCheck();let s=[];LayaEnv.beforeInit&&s.push((()=>LayaEnv.beforeInit(r))),s.push((()=>Promise.all(Laya._beforeInitCallbacks.map((e=>e(r)))))),s.push((()=>LayaGL.renderOBJCreate.createEngine(null,Browser.mainCanvas))),s.push((()=>Laya.initRender2D(r))),i&&s.push((()=>i.__init__())),s.push((()=>Promise.all(Laya._initCallbacks.map((e=>e()))))),s.push((()=>Promise.all(Laya._afterInitCallbacks.map((e=>e()))))),LayaEnv.afterInit&&s.push((()=>LayaEnv.afterInit()));let n=Promise.resolve();for(let e of s)n=n.then(e);return n}static _setStyleInfo(e){let t=e.source.style;t.position="absolute",t.top=t.left="0px",t.background="#000000"}static initRender2D(t){e.stage=window.stage=ILaya.stage=Laya.stage=new Stage,VertexElementFormat.__init__(),Shader3D.init(),MeshQuadTexture.__int__(),MeshVG.__init__(),MeshTexture.__init__(),Laya.render=Laya.createRender(),e.render=Laya.render,e.stage.size(t.designWidth,t.designHeight),t.scaleMode&&(e.stage.scaleMode=t.scaleMode),t.screenMode&&(e.stage.screenMode=t.screenMode),t.alignV&&(e.stage.alignV=t.alignV),t.alignH&&(e.stage.alignH=t.alignH),Config.isAlpha?e.stage.bgColor="#000000":t.backgroundColor&&(e.stage.bgColor=t.backgroundColor),LayaEnv.isConch&&window.conch.setGlobalRepaint&&window.conch.setGlobalRepaint(e.stage.setGlobalRepaint.bind(e.stage)),RenderStateContext.__init__(),MeshParticle2D.__init__(),RenderSprite.__init__(),Material.__initDefine__(),DrawStyle._Defaultinit(),InputManager.__init__(e.stage,Render.canvas),window.conch&&"conchUseWXAdapter"in Browser.window&&(Input.isAppUseNewInput=!0),Input.__init__(),SoundManager.autoStopMusic=!0,Value2D._initone(e.RenderSpriteData.Texture2D,TextureSV),Value2D._initone(e.RenderSpriteData.Primitive,PrimitiveSV)}static createRender(){return new Render(0,0,Browser.mainCanvas)}static alertGlobalError(e){var t=0;Browser.window.onerror=e?function(e,r,i,a,s){t++<5&&s&&this.alert("出错啦，请把此信息截图给研发商\n"+e+"\n"+s.stack)}:null}static _runScript(e){return Browser.window[Laya._evcode](e)}static enableDebugPanel(e="libs/laya.debugtool.js"){if(window.Laya.DebugPanel)window.Laya.DebugPanel.enable();else{var t=Browser.createElement("script");t.onload=function(){window.Laya.DebugPanel.enable()},t.src=e,Browser.document.body.appendChild(t)}}static enableNative(){Laya.isNativeRender_enable||(Laya.isNativeRender_enable=!0,Object.defineProperty(RenderTexture2D.prototype,"uv",{get:function(){return this._uv},set:function(e){this._uv=e}}),HTMLCanvas.prototype.getTexture=function(){return this._texture||(this._texture=this.context._targets,this._texture.uv=RenderTexture2D.flipyuv,this._texture.bitmap=this._texture),this._texture})}static addInitCallback(e){Laya._initCallbacks.push(e)}static addBeforeInitCallback(e){Laya._beforeInitCallbacks.push(e)}static addAfterInitCallback(e){Laya._afterInitCallbacks.push(e)}}Laya.stage=null,Laya.systemTimer=null,Laya.physicsTimer=null,Laya.timer=null,Laya.loader=null,Laya._inited=!1,Laya._initCallbacks=[],Laya._beforeInitCallbacks=[],Laya._afterInitCallbacks=[],Laya._evcode="eval",Laya.isNativeRender_enable=!1,ILaya.Laya=Laya,ILaya.Loader=Loader,ILaya.Context=Context,ILaya.Browser=Browser;var nt=Laya.init;e.stage=void 0,e.systemTimer=void 0,e.physicsTimer=void 0,e.timer=void 0,e.loader=void 0,e.render=void 0;var ot=Laya.alertGlobalError,lt=Laya.enableDebugPanel,ht=Laya.addInitCallback,dt=Laya.addBeforeInitCallback,ut=Laya.addAfterInitCallback;class Render{constructor(e,t,r){this._first=!0,this._startTm=0,this._timeId=0,Render._Render=this,Render._mainCanvas=r;let i=Render._mainCanvas.source;i.id="layaCanvas",i.width=e,i.height=t,LayaEnv.isConch&&document.body.appendChild(i),this.initRender(Render._mainCanvas,e,t),Config._enableWindowRAFFunction?window.requestAnimationFrame(loop):requestAnimationFrame(loop);let a=this;performance.now();let s=Config.FPS,n=Render.ifps=1e3/s;function loop(e){performance.now(),a._first&&(a._startTm=Math.floor(e/n)*n,a._first=!1),e-=a._startTm;let t=Math.floor(e/n);(t-Render.lastFrm>0||LayaEnv.isConch||!Config.fixedFrames)&&(Render.lastFrm=t,ILaya.stage._loop()),Render._customRequestAnimationFrame&&Render._loopFunction?Render._customRequestAnimationFrame(Render._loopFunction):Config._enableWindowRAFFunction?window.requestAnimationFrame(loop):requestAnimationFrame(loop)}ILaya.stage.on("visibilitychange",this,this._onVisibilitychange),LayaEnv.isConch&&Laya.timer.frameOnce(2,null,Render.gc)}static customRequestAnimationFrame(e,t){Render._customRequestAnimationFrame=e,Render._loopFunction=t}static set customRenderEngine(e){Render._customEngine=e}static get customRenderEngine(){return Render._customEngine}static gc(){LayaEnv.isConch&&window.gc({type:"major",execution:"async"})}_onVisibilitychange(){ILaya.stage.isVisibility?0!=this._timeId&&window.clearInterval(this._timeId):this._timeId=window.setInterval(this._enterFrame,1e3)}static vsyncTime(){return Render.lastFrm*Render.ifps}initRender(e,t,r){e.size(t,r),ShaderDefines2D.__init__(),Context.__init__();var i=new Context;return i.isMain=!0,Render._context=i,e._setContext(i),Shader2D.__init__(),BlendMode._init_(),!0}_enterFrame(e=null){ILaya.stage._loop()}static get context(){return Render._context}static get canvas(){return Render._mainCanvas.source}}Render.lastFrm=0,Render.ifps=1e3/60;const ct={Int8Array:Int8Array,Uint8Array:Uint8Array,Int16Array:Int16Array,Uint16Array:Uint16Array,Int32Array:Int32Array,Uint32Array:Uint32Array,Float32Array:Float32Array,Float64Array:Float64Array};var _t,pt,gt;class SerializeUtil{static decodeObj(e,t,r){r?(_t=r.outErrors,pt=r.getNodeByRef,gt=r.getNodeData):(_t=null,pt=null,gt=null),SerializeUtil.isDeserializing=!0;try{return SerializeUtil._decodeObj(e,t)}finally{SerializeUtil.isDeserializing=!1}}static _decodeObj(e,t){if(null==e)return null;if(Array.isArray(e)){let t=[];for(let r=0;r<e.length;r++){let i=e[r];if(null!=i)try{t[r]=SerializeUtil._decodeObj(i)}catch(e){_t&&_t.push(e),t[r]=null}else t[r]=null}return t}if("object"==typeof e){if(null!=e._$uuid){let t=URL.getResURLByUUID(e._$uuid);return ILaya.loader.getRes(t,SerializeUtil.getLoadTypeByEngineType(e._$type))}if(null!=e._$ref){let t=null==pt?void 0:pt(e._$ref);if(t&&e._$type){let r=ClassUtils.getClass(e._$type);return r?t.getComponent(r):null}return t}let r=e._$type;if("any"===r)return e._$type?e.value:e;let i=ct[r];if(null!=i)return e._$type?new i(e.value):new i(e);if(!t){let e=ClassUtils.getClass(r);if(!e)return null;t=new e}for(let r in e){if(r.startsWith("_$"))continue;let i=e[r];if(null==i||"object"!=typeof i||Array.isArray(i)||i._$type||i._$uuid||i._$ref)try{let e=SerializeUtil._decodeObj(i);t[r]=e,null!=e&&null!=i&&i._$tmpl&&(t[i._$tmpl]=gt(e))}catch(e){_t&&_t.push(e)}else{let e=t[r];if(e)try{SerializeUtil._decodeObj(i,e)}catch(e){_t&&_t.push(e)}}}return t.onAfterDeserialize&&t.onAfterDeserialize(),t}return e}static getLoadTypeByEngineType(e){switch(e){case"Texture2D":case"RenderTexture":return Loader.TEXTURE2D;case"TextureCube":return Loader.TEXTURECUBE;case"Prefab":return Loader.HIERARCHY;default:return null}}static bakeOverrideData(e){let t=null;for(let r=e.length,i=r-1;i>=0;i--){let a=e[i];if(a&&a.length>0)for(let e of a){let a,s=e._$override||e._$parent;if(Array.isArray(s)?a=s[r-i-1]:i==r-1&&(a=s),null!=a){t||(t={});let s=t[a];s||(t[a]=s=[]),s.push(r-i,e)}}}return t}static applyOverrideData(e,t){return function test(e){if(t[e._$id])return!0;let r=e._$child;return!(!r||!r.find((e=>test(e))))}(e)&&(e=function cloneTree(e){let t=Object.assign({},e),r=t._$child;r&&(t._$child=r.map((e=>cloneTree(e))));let i=t._$comp;return i&&(t._$comp=i.map((e=>Object.assign({},e)))),t}(e),function visit(e){let r=e._$child;if(r)for(let e of r)e._$id&&visit(e);let i=t[e._$id];if(i)for(let t=0;t<i.length;t+=2){let a,s=i[t],n=i[t+1];if(a=n._$override){let t;if(Array.isArray(a))if(s==a.length-1){let i=a[s];r?t=r.find((e=>e._$override==i)):e._$child=r=[],t||(t={_$override:i},r.push(t))}else if(s<a.length-1){let i=a.slice(s);r?t=r.find((e=>{let t=e._$override;return Array.isArray(t)&&arrayEquals(t,i)})):e._$child=r=[],t||(t={_$override:i},r.push(t))}else t=e;else t=e;if(mergeData(t,n),n._$comp){let e=t._$comp;e||(t._$comp=e=[]);for(let t of n._$comp){let r=t._$type||t._$override,i=e.find((e=>e._$override==r||e._$type==r));i||(i={},t._$type?i._$type=r:i._$override=r,e.push(i)),mergeData(i,t)}}}else if(a=n._$parent){let t;if(r||(e._$child=r=[]),s<a.length){t=s==a.length-1?a[s]:a.slice(s);let e=Object.assign({},n);e._$parent=t,r.push(e)}else{let t=Object.assign({},n);delete t._$parent,e._$prefab?r.push(t):(delete t._$index,n._$index<r.length?r.splice(n._$index,0,t):r.push(t))}}}}(e)),e}}function mergeData(e,t){for(let r in t){if(r.startsWith("_$"))continue;let i=t[r];if(null==i||"object"!=typeof i||Array.isArray(i)||(i._$type||i._$uuid||i._$ref))e[r]=i;else{let t=e[r];null!=t&&"object"==typeof t?(e[r]=t=Object.assign({},t),mergeData(t,i)):e[r]=i}}}function arrayEquals(e,t){if(e.length===t.length){for(var r=0;r<e.length;r++)if(e[r]!==t[r])return!1;return!0}return!1}SerializeUtil.isDeserializing=!1;class Input extends Text{constructor(){super(),this._multiline=!1,this._editable=!0,this._maxChars=0,this._type="text",Input.IOS_IFRAME=ILaya.Browser.onIOS&&ILaya.Browser.window.top!=ILaya.Browser.window.self,this._width=100,this._height=20,this.multiline=!1,this.overflow=Text.SCROLL,this._promptColor="#A9A9A9",this.on(Event.MOUSE_DOWN,this,this._onMouseDown),this.on(Event.UNDISPLAY,this,this._onUnDisplay)}static __init__(){if(Input._createInputElement(),ILaya.Browser.onMobile){var e=!1;(ILaya.Browser.onMiniGame||ILaya.Browser.onBDMiniGame||ILaya.Browser.onQGMiniGame||ILaya.Browser.onKGMiniGame||ILaya.Browser.onVVMiniGame||ILaya.Browser.onAlipayMiniGame||ILaya.Browser.onQQMiniGame||ILaya.Browser.onBLMiniGame||ILaya.Browser.onTTMiniGame||ILaya.Browser.onHWMiniGame||ILaya.Browser.onTBMiniGame)&&(e=!0),Render.canvas.addEventListener(Input.IOS_IFRAME?e?"touchend":"click":"touchend",Input._popupInputMethod)}}static _popupInputMethod(e){InputManager.isTextInputting&&Input.inputElement.focus()}static _createInputElement(){Input._initInput(Input.area=ILaya.Browser.createElement("textarea")),Input._initInput(Input.input=ILaya.Browser.createElement("input")),Input.inputContainer=ILaya.Browser.createElement("div"),Input.inputContainer.style.position="absolute",Input.inputContainer.style.zIndex="1E5",ILaya.Browser.container.appendChild(Input.inputContainer),Input.inputContainer.setPos=function(e,t){Input.inputContainer.style.left=e+"px",Input.inputContainer.style.top=t+"px"}}static _initInput(e){var t=e.style;t.cssText="position:absolute;overflow:hidden;resize:none;transform-origin:0 0;-webkit-transform-origin:0 0;-moz-transform-origin:0 0;-o-transform-origin:0 0;",t.resize="none",t.backgroundColor="transparent",t.border="none",t.outline="none",t.zIndex="1",e.addEventListener("input",Input._processInputting),e.addEventListener("mousemove",Input._stopEvent,{passive:!1}),e.addEventListener("mousedown",Input._stopEvent,{passive:!1}),e.addEventListener("touchmove",Input._stopEvent,{passive:!1}),e.setFontFace=function(t){e.style.fontFamily=t},LayaEnv.isConch&&!Input.isAppUseNewInput||(e.setColor=function(t){e.style.color=t},e.setFontSize=function(t){e.style.fontSize=t+"px"})}static _processInputting(e){var t=Input.inputElement.target;if(t){var r=Input.inputElement.value;t._restrictPattern&&(r=r.replace(/\u2006|\x27/g,""),t._restrictPattern.test(r)&&(r=r.replace(t._restrictPattern,""),Input.inputElement.value=r)),null==r&&(r=""),t._text=r,t.event(Event.INPUT)}}static _stopEvent(e){"touchmove"==e.type&&e.preventDefault(),e.stopPropagation&&e.stopPropagation()}setSelection(e,t){this.focus=!0,Input.inputElement.selectionStart=e,Input.inputElement.selectionEnd=t}get multiline(){return this._multiline}set multiline(e){this._multiline=e,SerializeUtil.isDeserializing||(this.valign=e?"top":"middle")}get nativeInput(){return this._multiline?Input.area:Input.input}_onUnDisplay(e=null){this.focus=!1}_onMouseDown(e){this.focus=!0}_syncInputTransform(){var e=this.nativeInput,t=SpriteUtils.getTransformRelativeToWindow(this,this._padding[3],this._padding[0]),r=this._width-this._padding[1]-this._padding[3],i=this._height-this._padding[0]-this._padding[2];LayaEnv.isConch&&!Input.isAppUseNewInput?(e.setScale(t.scaleX,t.scaleY),e.setSize(r,i),e.setPos(t.x,t.y)):(Input.inputContainer.style.transform=Input.inputContainer.style.webkitTransform="scale("+t.scaleX+","+t.scaleY+") rotate("+ILaya.stage.canvasDegree+"deg)",e.style.width=r+"px",e.style.height=i+"px",Input.inputContainer.style.left=t.x+"px",Input.inputContainer.style.top=t.y+"px")}select(){this.nativeInput.select()}get focus(){return this._focus}set focus(e){var t=this.nativeInput;this._focus!==e&&(e?(t.target?t.target._focusOut():this._setInputMethod(),(t=this.nativeInput).target=this,this._focusIn()):(t.target=null,this._focusOut(),ILaya.Browser.document.body.scrollTop=0,t.blur(),LayaEnv.isConch&&!Input.isAppUseNewInput?t.setPos(-1e4,-1e4):Input.inputContainer.contains(t)&&Input.inputContainer.removeChild(t)))}_setInputMethod(){Input.input.parentElement&&Input.inputContainer.removeChild(Input.input),Input.area.parentElement&&Input.inputContainer.removeChild(Input.area),ILaya.Browser.onAndroid&&(Input.input=Input.inputElement=ILaya.Browser.createElement("input"),Input._initInput(Input.input)),Input.inputElement=this._multiline?Input.area:Input.input,Input.inputContainer.appendChild(Input.inputElement),Text.RightToLeft&&(Input.inputElement.style.direction="rtl")}_focusIn(){InputManager.isTextInputting=!0;var e=this.nativeInput;Input.input&&(Input.input.type=this._type),this._focus=!0;var t=e.style;t.whiteSpace=this.wordWrap?"pre-wrap":"nowrap",this._setPromptColor(),e.readOnly=!this._editable,LayaEnv.isConch&&!Input.isAppUseNewInput&&(e.setType(this._type),e.setForbidEdit(!this._editable)),e.maxLength=this._maxChars<=0?1e5:this._maxChars,e.value=this._text,e.placeholder=this._prompt,ILaya.stage.off(Event.KEY_DOWN,this,this._onKeyDown),ILaya.stage.on(Event.KEY_DOWN,this,this._onKeyDown),ILaya.stage.focus=this,this.event(Event.FOCUS),ILaya.Browser.onPC&&e.focus(),LayaEnv.isConch&&Input.isAppUseNewInput||ILaya.Browser.onMiniGame||ILaya.Browser.onBDMiniGame||ILaya.Browser.onQGMiniGame||ILaya.Browser.onKGMiniGame||ILaya.Browser.onVVMiniGame||ILaya.Browser.onAlipayMiniGame||ILaya.Browser.onQQMiniGame||ILaya.Browser.onBLMiniGame||ILaya.Browser.onTTMiniGame||ILaya.Browser.onHWMiniGame||ILaya.Browser.onTBMiniGame||(this.graphics.clear(!0),this.drawBg(),this._hideText=!0),e.setColor(this.color),e.setFontSize(this.fontSize),e.setFontFace(this._realFont),LayaEnv.isConch&&!Input.isAppUseNewInput&&e.setMultiAble&&e.setMultiAble(this._multiline),t.lineHeight=this.leading+this.fontSize+"px",t.fontStyle=this.italic?"italic":"normal",t.fontWeight=this.bold?"bold":"normal",t.textAlign=this.align,t.padding="0 0",this._syncInputTransform(),!LayaEnv.isConch&&ILaya.Browser.onPC&&ILaya.systemTimer.frameLoop(1,this,this._syncInputTransform)}_setPromptColor(){Input.promptStyleDOM=ILaya.Browser.getElementById("promptStyle"),Input.promptStyleDOM||(Input.promptStyleDOM=ILaya.Browser.createElement("style"),Input.promptStyleDOM.setAttribute("id","promptStyle"),ILaya.Browser.document.head.appendChild(Input.promptStyleDOM)),Input.promptStyleDOM.innerText="input::-webkit-input-placeholder, textarea::-webkit-input-placeholder {color:"+this._promptColor+"}input:-moz-placeholder, textarea:-moz-placeholder {color:"+this._promptColor+"}input::-moz-placeholder, textarea::-moz-placeholder {color:"+this._promptColor+"}input:-ms-input-placeholder, textarea:-ms-input-placeholder {color:"+this._promptColor+"}"}_focusOut(){InputManager.isTextInputting&&(InputManager.isiOSWKwebView||(InputManager.isTextInputting=!1),this._focus=!1,this._hideText=!1,this.text=this.nativeInput.value,this.markChanged(),this.typeset(),ILaya.stage.off(Event.KEY_DOWN,this,this._onKeyDown),ILaya.stage.focus=null,this.event(Event.BLUR),this.event(Event.CHANGE),LayaEnv.isConch&&!Input.isAppUseNewInput&&this.nativeInput.blur(),ILaya.Browser.onPC&&ILaya.systemTimer.clear(this,this._syncInputTransform))}_onKeyDown(e){13===e.keyCode&&(ILaya.Browser.onMobile&&!this._multiline&&(this.focus=!1),this.event(Event.ENTER))}miniGameTxt(e){e+="",this._multiline||(e=e.replace(/\r?\n/g,"")),this.text=e}set text(e){null==e?e="":"string"!=typeof e&&(e=""+e),this._focus?(this.nativeInput.value=e,this.event(Event.CHANGE)):(this._multiline||(e=e.replace(/\r?\n/g,"")),super.text=e)}get text(){return this._focus?this.nativeInput.value:super.text}set_color(e){this._focus&&this.nativeInput.setColor(e),super.set_color(e)}set bgColor(e){super.bgColor=e,LayaEnv.isConch&&!Input.isAppUseNewInput&&this.nativeInput.setBgColor(e)}get bgColor(){return super.bgColor}get restrict(){return this._restrict}set restrict(e){this._restrict=e,e?((e="[^"+e+"]").indexOf("^^")>-1&&(e=e.replace("^^","")),this._restrictPattern=new RegExp(e,"g")):this._restrictPattern=null}set editable(e){this._editable=e,LayaEnv.isConch&&!Input.isAppUseNewInput&&Input.input.setForbidEdit(!e)}get editable(){return this._editable}get maxChars(){return this._maxChars}set maxChars(e){this._maxChars=e}get prompt(){return this._prompt}set prompt(e){var t;e=(null===(t=Text.langPacks)||void 0===t?void 0:t[e])||e,this._prompt!=e&&(this._prompt=e,this.markChanged())}get promptColor(){return this._promptColor}set promptColor(e){this._promptColor!=e&&(this._promptColor=e,this.markChanged())}get type(){return this._type}set type(e){this._asPassword="password"===e,this._type=e,this.markChanged()}}Input.TYPE_TEXT="text",Input.TYPE_PASSWORD="password",Input.TYPE_EMAIL="email",Input.TYPE_URL="url",Input.TYPE_NUMBER="number",Input.TYPE_RANGE="range",Input.TYPE_DATE="date",Input.TYPE_MONTH="month",Input.TYPE_WEEK="week",Input.TYPE_TIME="time",Input.TYPE_DATE_TIME="datetime",Input.TYPE_DATE_TIME_LOCAL="datetime-local",Input.TYPE_SEARCH="search",Input.IOS_IFRAME=!1,Input.isAppUseNewInput=!1;class Widget extends Component{constructor(){super(),this._top=null,this._bottom=null,this._left=null,this._right=null,this._centerX=null,this._centerY=null,this.runInEditor=!0,this.hideFlags|=HideFlags.HideAndDontSave}onReset(){this._top=this._bottom=this._left=this._right=this._centerX=this._centerY=null}_onEnable(){this.owner.parent?this._onAdded():this.owner.once(Event.ADDED,this,this._onAdded)}_onDisable(){this.owner.off(Event.ADDED,this,this._onAdded),this.owner.parent&&this.owner.parent.off(Event.RESIZE,this,this._onParentResize)}_onAdded(){this.owner.parent&&this.owner.parent.on(Event.RESIZE,this,this._onParentResize),this.resetLayoutX(),this.resetLayoutY()}_onParentResize(){var e=this.resetLayoutX(),t=this.resetLayoutY();(e||t)&&this.owner.event(Event.RESIZE)}resetLayoutX(){var e=this.owner;if(!e)return!1;var t=e.parent;if(t)if(null!=this._centerX)e.x=Math.round(.5*(t.width-e.displayWidth)+this._centerX+e.pivotX*e.scaleX);else if(null!=this._left){if(e.x=Math.round(this._left+e.pivotX*e.scaleX),null!=this._right){if(!t._width)return!1;var r=(t._width-this._left-this._right)/(e.scaleX||.01);if(r!=e._width)return e.width=r,!0}}else null!=this._right&&(e.x=Math.round(t.width-e.displayWidth-this._right+e.pivotX*e.scaleX));return!1}resetLayoutY(){var e=this.owner;if(!e)return!1;var t=e.parent;if(t)if(null!=this._centerY)e.y=Math.round(.5*(t.height-e.displayHeight)+this._centerY+e.pivotY*e.scaleY);else if(null!=this._top){if(e.y=Math.round(this._top+e.pivotY*e.scaleY),null!=this._bottom){if(!t._height)return!1;var r=(t._height-this._top-this._bottom)/(e.scaleY||.01);if(r!=e._height)return e.height=r,!0}}else null!=this._bottom&&(e.y=Math.round(t.height-e.displayHeight-this._bottom+e.pivotY*e.scaleY));return!1}resetLayout(){this.owner&&(this.resetLayoutX(),this.resetLayoutY())}get top(){return this._top}set top(e){isNaN(e)&&(e=null),this._top!=e&&(this._top=e,this.resetLayoutY())}get bottom(){return this._bottom}set bottom(e){isNaN(e)&&(e=null),this._bottom!=e&&(this._bottom=e,this.resetLayoutY())}get left(){return this._left}set left(e){isNaN(e)&&(e=null),this._left!=e&&(this._left=e,this.resetLayoutX())}get right(){return this._right}set right(e){isNaN(e)&&(e=null),this._right!=e&&(this._right=e,this.resetLayoutX())}get centerX(){return this._centerX}set centerX(e){isNaN(e)&&(e=null),this._centerX!=e&&(this._centerX=e,this.resetLayoutX())}get centerY(){return this._centerY}set centerY(e){isNaN(e)&&(e=null),this._centerY!=e&&(this._centerY=e,this.resetLayoutY())}}Widget.EMPTY=null,Widget.EMPTY=new Widget;const mt=new Rectangle,ft=new Point;class HitArea{contains(e,t,r){return!!HitArea._isHitGraphic(e,t,r,this._hit)&&!HitArea._isHitGraphic(e,t,r,this._unHit)}static _isHitGraphic(e,t,r,i){if(!i)return!1;let a=i.cmds;if(0==a.length)return!1;let s=a.length;for(let i=0;i<s;i++){let s=a[i];if(s){if("Translate"===s.cmdID)e-=s.tx,t-=s.ty;if(HitArea._isHitCmd(e,t,r,s))return!0}}return!1}static _isHitCmd(e,t,r,i){if(!i)return!1;var a=!1;switch(i.cmdID){case"DrawRect":i.percent?mt.setTo(i.x*r.width,i.y*r.height,i.width*r.width,i.height*r.height):mt.setTo(i.x,i.y,i.width,i.height),a=mt.contains(e,t);break;case"DrawCircle":let s=i.radius;i.percent?(e-=i.x*r.width,t-=i.y*r.height,s*=r.width):(e-=i.x,t-=i.y),a=e*e+t*t<s*s;break;case"DrawPoly":e-=i.x,t-=i.y,a=HitArea._ptInPolygon(e,t,i.points)}return a}static _ptInPolygon(e,t,r){var i=ft;i.setTo(e,t);var a,s,n,o,l,h=0;l=r.length;for(var d=0;d<l;d+=2){if(a=r[d],s=r[d+1],n=r[(d+2)%l],s!=(o=r[(d+3)%l]))if(!(i.y<Math.min(s,o)))if(!(i.y>=Math.max(s,o)))(i.y-s)*(n-a)/(o-s)+a>i.x&&h++}return h%2==1}get hit(){return this._hit||(this._hit=new Graphics),this._hit}set hit(e){this._hit=e}get unHit(){return this._unHit||(this._unHit=new Graphics),this._unHit}set unHit(e){this._unHit=e}onAfterDeserialize(){LayaEnv.isPlaying&&(this._hitCmds&&(this.hit.cmds=this._hitCmds,delete this._hitCmds),this._unHitCmds&&(this.unHit.cmds=this._unHitCmds,delete this._unHitCmds))}}ClassUtils.regClass("HitArea",HitArea);class Prefab extends Resource{constructor(e){super(),this.version=e,this._deps=[]}create(e,t){return this.json?LegacyUIParser.createByData(null,this.json):null}get deps(){return this._deps}addDep(e){e instanceof Resource&&(e._addReference(),this._deps.push(e),!LayaEnv.isPlaying&&e instanceof Prefab&&e.on("obsolute",this,this.onDepObsolute))}addDeps(e){for(let t of e)t instanceof Resource&&(t._addReference(),this._deps.push(t),!LayaEnv.isPlaying&&t instanceof Prefab&&t.on("obsolute",this,this.onDepObsolute))}_disposeResource(){for(let e of this._deps)e._removeReference(),!LayaEnv.isPlaying&&e instanceof Prefab&&e.off("obsolute",this,this.onDepObsolute)}get obsolute(){return this._obsolute}set obsolute(e){this._obsolute!=e&&(this._obsolute=e,e&&!LayaEnv.isPlaying&&this.event("obsolute"))}onDepObsolute(){this.obsolute=!0}}var St,yt,Tt=Prefab;class PrefabImpl extends Prefab{constructor(e,t,r){super(r),this.api=e,this.data=t}create(e,t){let r=this.api.parse(this.data,e,t);return Array.isArray(r)?(1==r.length&&(r[0].url=this.url),r[0]):(r.url=this.url,r)}}class LegacyUIParser{static parse(e,t){let r=null==t?void 0:t.root;if(!r){let t=LayaEnv.isPlaying&&e.props.runtime?e.props.runtime:e.type,i=ClassUtils.getClass(t);r="instance"==e.props.renderType?i.instance||(i.instance=new i):new i}return r&&r._viewCreated?r:LegacyUIParser.createByData(r,e)}static getBindFun(e){let t=LegacyUIParser._funMap;t||(t=LegacyUIParser._funMap=new WeakObject);var r=LegacyUIParser._funMap.get(e);if(null==r){var i='"'+e+'"',a="(function(data){if(data==null)return;with(data){try{\nreturn "+(i=i.replace(/^"\${|}"$/g,"").replace(/\${/g,'"+').replace(/}/g,'+"'))+"\n}catch(e){}}})";r=window.Laya._runScript(a),LegacyUIParser._funMap.set(e,r)}return r}static createByData(e,t){var r=InitTool.create();if("_idMap"in(e=LegacyUIParser.createComp(t,e,e,null,r))&&(e._idMap=r._idMap),t.animations){var i,a,s,n=[],o=t.animations,l=o.length;for(i=0;i<l;i++){switch(a=new FrameAnimation,s=o[i],a._setUp(r._idMap,s),e[s.name]=a,a._setControlNode(e),s.action){case 1:a.play(0,!1);break;case 2:a.play(0,!0)}n.push(a)}e._aniList=n}return e instanceof Scene&&e._width>0&&null==t.props.hitTestPrior&&!e.mouseThrough&&(e.hitTestPrior=!0),r.finish(),e._setBit(NodeFlags.NOT_READY,!1),e.parent&&e.parent.activeInHierarchy&&e.active&&e._processActive(!0),e}static createInitTool(){return InitTool.create()}static createComp(e,t=null,r=null,i=null,a=null){if(!(t=t||LegacyUIParser.getCompInstance(e)))return e.props&&e.props.runtime?console.warn("runtime not found:"+e.props.runtime):console.warn("can not create:"+e.type),null;var s=e.child;if(s)for(var n=t instanceof(St||(St=ClassUtils.getClass("List"))),o=0,l=s.length;o<l;o++){var h=s[o];if(!("itemRender"in t)||"render"!=h.props.name&&"render"!==h.props.renderType)if("Graphic"==h.type)this._addGraphicsToSprite(h,t);else if(this._isDrawType(h.type))this._addGraphicToSprite(h,t,!0);else{if(n){var d=[],u=LegacyUIParser.createComp(h,null,r,d,a);d.length&&(u._$bindData=d)}else u=LegacyUIParser.createComp(h,null,r,i,a);"Script"==h.type?u instanceof Component?t.addComponentInstance(u):"owner"in u?u.owner=t:"target"in u&&(u.target=t):"mask"==h.props.renderType||"mask"==h.props.name?t.mask=u:u instanceof Node&&t.addChild(u)}else t.itemRender=h}var c=e.props;for(var _ in c){var p=c[_];"string"==typeof p&&(p.indexOf("@node:")>=0||p.indexOf("@Prefab:")>=0)?a&&a.addNodeRef(t,_,p):LegacyUIParser.setCompValue(t,_,p,r,i)}return t._afterInited&&t._afterInited(),e.compId&&a&&a._idMap&&(a._idMap[e.compId]=t),t}static setCompValue(e,t,r,i=null,a=null){if("string"==typeof r&&r.indexOf("${")>-1){if(LegacyUIParser._sheet||(LegacyUIParser._sheet=ClassUtils.getClass("laya.data.Table")),!LegacyUIParser._sheet)return void console.warn("Can not find class Sheet");if(a)a.push(e,t,r);else if(i){-1==r.indexOf("].")&&(r=r.replace(".","[0]."));var s,n,o=new DataWatcher(e,t,r);o.exe(i);for(var l=r.replace(/\[.*?\]\./g,".");null!=(s=LegacyUIParser._parseWatchData.exec(l));){for(var h=s[1];null!=(n=LegacyUIParser._parseKeyWord.exec(h));){var d=n[0],u=i._watchMap[d]||(i._watchMap[d]=[]);u.push(o),LegacyUIParser._sheet.I.notifer.on(d,i,i.changeData,[d])}(u=i._watchMap[h]||(i._watchMap[h]=[])).push(o),LegacyUIParser._sheet.I.notifer.on(h,i,i.changeData,[h])}}}else"var"===t&&i?i[r]=e:e[t]="true"===r||"false"!==r&&r}static getCompInstance(e){if("UIView"==e.type&&e.props&&e.props.pageData)return LegacyUIParser.createByData(null,e.props.pageData);var t=LayaEnv.isPlaying&&e.props&&e.props.runtime||e.type,r=ClassUtils.getClass(t);if(!r)throw"Can not find class "+t;if("Script"===e.type&&r.prototype._doAwake){var i=Pool.createByClass(r);return i._destroyed=!1,i}if(e.props&&"renderType"in e.props&&"instance"==e.props.renderType)return r.instance||(r.instance=new r),r.instance;let a=new r;return a instanceof(yt||(yt=ClassUtils.getClass("View")))&&(a._scene=a),a}static collectResourceLinks(e){let t=new Set,r=[];function addInnerUrl(e){t.has(e)||(t.add(e),r.push(e))}if(e.loadList)for(let t of e.loadList)addInnerUrl(t);if(e.loadList3D)for(let t of e.loadList3D)addInnerUrl(t);return function check(e){let t=e.props;for(let e in t){let r=t[e];if("string"==typeof r&&r.indexOf("@Prefab:")>=0){addInnerUrl(r.replace("@Prefab:",""))}}let r=e.child;if(r)for(let e=0,t=r.length;e<t;e++){check(r[e])}}(e),r}static createByJson(e,t=null,r=null,i=null,a=null){"string"==typeof e&&(e=JSON.parse(e));var s=e.props;if(!t&&!(t=a?a.runWith(e):ClassUtils.getInstance(LayaEnv.isPlaying&&s.runtime||e.type)))return null;var n=e.child;if(n)for(var o=0,l=n.length;o<l;o++){var h=n[o];if("render"!==h.props.name&&"render"!==h.props.renderType||!t._$set_itemRender)if("Graphic"==h.type)this._addGraphicsToSprite(h,t);else if(this._isDrawType(h.type))this._addGraphicToSprite(h,t,!0);else{var d=this.createByJson(h,null,r,i,a);"Script"===h.type?"owner"in d?d.owner=t:"target"in d&&(d.target=t):"mask"==h.props.renderType?t.mask=d:t.addChild(d)}else t.itemRender=h}if(s)for(var u in s){var c=s[u];"var"===u&&r?r[c]=t:c instanceof Array&&t[u]instanceof Function?t[u].apply(t,c):t[u]=c}return i&&e.customProps&&i.runWith([t,e]),t.created&&t.created(),t}static _addGraphicsToSprite(e,t){var r=e.child;if(r&&!(r.length<1)){var i,a,s=this._getGraphicsFromSprite(e,t),n=0,o=0;for(e.props&&(n=this._getObjVar(e.props,"x",0),o=this._getObjVar(e.props,"y",0)),0!=n&&0!=o&&s.translate(n,o),a=r.length,i=0;i<a;i++)this._addGraphicToGraphics(r[i],s);0!=n&&0!=o&&s.translate(-n,-o)}}static _addGraphicToSprite(e,t,r=!1){var i=r?this._getGraphicsFromSprite(e,t):t.graphics;this._addGraphicToGraphics(e,i)}static _getGraphicsFromSprite(e,t){if(!e||!e.props)return t.graphics;var r=e.props.renderType;if("hit"===r||"unHit"===r){var i=t._style.hitArea||(t.hitArea=new HitArea);i[r]||(i[r]=new Graphics);var a=i[r]}return a||(a=t.graphics),a}static _getTransformData(e){var t;("pivotX"in e||"pivotY"in e)&&(t=t||new Matrix).translate(-this._getObjVar(e,"pivotX",0),-this._getObjVar(e,"pivotY",0));var r=this._getObjVar(e,"scaleX",1),i=this._getObjVar(e,"scaleY",1),a=this._getObjVar(e,"rotation",0);return this._getObjVar(e,"skewX",0),this._getObjVar(e,"skewY",0),1==r&&1==i&&0==a||((t=t||new Matrix).scale(r,i),t.rotate(.0174532922222222*a)),t}static _addGraphicToGraphics(e,t){var r,i;if((r=e.props)&&(i=this.DrawTypeDic[e.type])){var a=t,s=this._getParams(r,i[1],i[2],i[3]),n=this._tM;(n||1!=this._alpha)&&(a.save(),n&&a.transform(n),1!=this._alpha&&a.alpha(this._alpha)),a[i[0]].apply(a,s),(n||1!=this._alpha)&&a.restore()}}static _adptLineData(e){return e[2]=parseFloat(e[0])+parseFloat(e[2]),e[3]=parseFloat(e[1])+parseFloat(e[3]),e}static _adptTextureData(e){return e[0]=ILaya.Loader.getRes(e[0]),e}static _adptLinesData(e){return e[2]=this._getPointListByStr(e[2]),e}static _isDrawType(e){return"Image"!==e&&e in this.DrawTypeDic}static _getParams(e,t,r=0,i=null){var a,s,n,o=this._temParam;for(o.length=t.length,s=t.length,a=0;a<s;a++)o[a]=this._getObjVar(e,t[a][0],t[a][1]);return this._alpha=this._getObjVar(e,"alpha",1),(n=this._getTransformData(e))?(r||(r=0),n.translate(o[r],o[r+1]),o[r]=o[r+1]=0,this._tM=n):this._tM=null,i&&this[i]&&(o=this[i](o)),o}static _getPointListByStr(e){var t,r,i=e.split(",");for(r=i.length,t=0;t<r;t++)i[t]=parseFloat(i[t]);return i}static _getObjVar(e,t,r){return t in e?e[t]:r}}LegacyUIParser._parseWatchData=/\${(.*?)}/g,LegacyUIParser._parseKeyWord=/[a-zA-Z_][a-zA-Z0-9_]*(?:(?:\.[a-zA-Z_][a-zA-Z0-9_]*)+)/g,LegacyUIParser.DrawTypeDic={Rect:["drawRect",[["x",0],["y",0],["width",0],["height",0],["fillColor",null],["lineColor",null],["lineWidth",1]]],Circle:["drawCircle",[["x",0],["y",0],["radius",0],["fillColor",null],["lineColor",null],["lineWidth",1]]],Pie:["drawPie",[["x",0],["y",0],["radius",0],["startAngle",0],["endAngle",0],["fillColor",null],["lineColor",null],["lineWidth",1]]],Image:["drawTexture",[["x",0],["y",0],["width",0],["height",0]]],Texture:["drawTexture",[["skin",null],["x",0],["y",0],["width",0],["height",0]],1,"_adptTextureData"],FillTexture:["fillTexture",[["skin",null],["x",0],["y",0],["width",0],["height",0],["repeat",null]],1,"_adptTextureData"],FillText:["fillText",[["text",""],["x",0],["y",0],["font",null],["color",null],["textAlign",null]],1],Line:["drawLine",[["x",0],["y",0],["toX",0],["toY",0],["lineColor",null],["lineWidth",0]],0,"_adptLineData"],Lines:["drawLines",[["x",0],["y",0],["points",""],["lineColor",null],["lineWidth",0]],0,"_adptLinesData"],Curves:["drawCurves",[["x",0],["y",0],["points",""],["lineColor",null],["lineWidth",0]],0,"_adptLinesData"],Poly:["drawPoly",[["x",0],["y",0],["points",""],["fillColor",null],["lineColor",null],["lineWidth",1]],0,"_adptLinesData"]},LegacyUIParser._temParam=[];class DataWatcher{constructor(e,t,r){this.comp=e,this.prop=t,this.value=r}exe(e){var t=LegacyUIParser.getBindFun(this.value);this.comp[this.prop]=t.call(this,e)}}class InitTool{reset(){this._nodeRefList=null,this._initList=null,this._idMap=null}recover(){this.reset(),Pool.recover("InitTool",this)}static create(){var e=Pool.getItemByClass("InitTool",InitTool);return e._idMap={},e}addNodeRef(e,t,r){this._nodeRefList||(this._nodeRefList=[]),this._nodeRefList.push([e,t,r])}setNodeRef(){if(this._nodeRefList)if(this._idMap){var e,t,r;for(t=this._nodeRefList.length,e=0;e<t;e++)(r=this._nodeRefList[e])[0][r[1]]=this.getReferData(r[2]);this._nodeRefList=null}else this._nodeRefList=null}getReferData(e){if(e.indexOf("@Prefab:")>=0)return new PrefabImpl(LegacyUIParser,Loader.getRes(e.replace("@Prefab:","")),2);if(e.indexOf("@arr:")>=0){var t,r,i,a;i=(t=(e=e.replace("@arr:","")).split(",")).length;var s=[];for(r=0;r<i;r++)(a=t[r])?s.push(this._idMap[a.replace("@node:","")]):s.push(null);return s}return this._idMap[e.replace("@node:","")]}addInitItem(e){this._initList||(this._initList=[]),this._initList.push(e)}doInits(){this._initList&&(this._initList=null)}finish(){this.setNodeRef(),this.doInits(),this.recover()}}class Scene extends Sprite{constructor(e=!0){super(),this.autoDestroyAtClosed=!1,this._viewCreated=!1,this._timer=ILaya.timer,this._widget=Widget.EMPTY,this._scene=this,e&&this.createChildren()}createChildren(){}static setUIMap(e){let t=ILaya.loader.getRes(e);if(!t)throw"请提前加载uimap的json，再使用该接口设置！";for(let e in t)ILaya.Loader.loadedMap[e+".scene"]=t[e]}loadScene(e){Scene.unDestroyedScenes.add(this);let t=e.indexOf(".")>-1?e:e+".scene",r=ILaya.loader.getRes(t);r?this._viewCreated||(r.create({root:this}),this._viewCreated=!0,Scene.unDestroyedScenes.add(this)):(this._setBit(NodeFlags.NOT_READY,!0),ILaya.loader.load(t,null,(e=>{Scene._loadPage&&Scene._loadPage.event("progress",e)})).then((r=>{if(!r)throw"Can not find scene:"+e;this._viewCreated?this._setBit(NodeFlags.NOT_READY,!1):(this.url=t,Scene.hideLoadingPage(),r.create({root:this}),this._viewCreated=!0,Scene.unDestroyedScenes.add(this))})))}createView(e){e&&!this._viewCreated&&(this._viewCreated=!0,LegacyUIParser.createByData(this,e))}getNodeByID(e){return this._idMap?this._idMap[e]:null}open(e=!0,t=null){e&&Scene.closeAll(),Scene.root.addChild(this),this._scene3D&&ILaya.stage.addChildAt(this._scene3D,0),this.onOpened(t)}onOpened(e){}close(e=null){this.onClosed(e),this.autoDestroyAtClosed?(this.destroy(),this._scene3D&&this._scene3D.destroy()):(this.removeSelf(),this._scene3D&&this._scene3D.removeSelf())}onClosed(e=null){}destroy(e=!0){super.destroy(e),this._scene3D&&(this._scene3D.destroy(),this._scene3D=null),this._idMap=null,Scene.unDestroyedScenes.delete(this)}get_width(){if(this._isWidthSet)return this._width;for(var e=0,t=this.numChildren-1;t>-1;t--){var r=this.getChildAt(t);r._visible&&(e=Math.max(r._x+r.width*r.scaleX,e))}return e}get_height(){if(this._isHeightSet)return this._height;for(var e=0,t=this.numChildren-1;t>-1;t--){var r=this.getChildAt(t);r._visible&&(e=Math.max(r._y+r.height*r.scaleY,e))}return e}get timer(){return this._timer}set timer(e){this._timer=e}get scene3D(){return this._scene3D}get top(){return this._widget.top}set top(e){e!=this._widget.top&&(this._getWidget().top=e)}get bottom(){return this._widget.bottom}set bottom(e){e!=this._widget.bottom&&(this._getWidget().bottom=e)}get left(){return this._widget.left}set left(e){e!=this._widget.left&&(this._getWidget().left=e)}get right(){return this._widget.right}set right(e){e!=this._widget.right&&(this._getWidget().right=e)}get centerX(){return this._widget.centerX}set centerX(e){e!=this._widget.centerX&&(this._getWidget().centerX=e)}get centerY(){return this._widget.centerY}set centerY(e){e!=this._widget.centerY&&(this._getWidget().centerY=e)}_shouldRefreshLayout(){super._shouldRefreshLayout(),this.callLater(this._sizeChanged)}_sizeChanged(){this.event(Event.RESIZE),this._widget!==Widget.EMPTY&&this._widget.resetLayout()}freshLayout(){this._widget!=Widget.EMPTY&&this._widget.resetLayout()}_getWidget(){return this._widget===Widget.EMPTY&&(this._widget=this.addComponent(Widget)),this._widget}static get root(){let e=Scene._root;return e||(e=Scene._root=ILaya.stage.addChild(new Sprite),e.name="root",e.mouseThrough=!0,ILaya.stage.on("resize",null,(()=>{e.size(ILaya.stage.width,ILaya.stage.height),e.event(Event.RESIZE)})),e.size(ILaya.stage.width,ILaya.stage.height),e.event(Event.RESIZE)),e}static load(e,t=null,r=null){return ILaya.loader.load(e,null,(e=>{Scene._loadPage&&Scene._loadPage.event("progress",e),r&&r.runWith(e)})).then((r=>{if(!r)throw"Can not find scene:"+e;let i,a=[],s=r.create(null,a);if(a.length>0&&console.warn(`Error loading ${e}: \n${a.join("\n")}`),s instanceof Scene)i=s;else{if(!s._is3D)throw"Not a scene:"+e;i=new Scene,i.left=i.right=i.top=i.bottom=0,i._scene3D=s}return i._viewCreated=!0,i._scene3D&&(i._scene3D._scene2D=i),Scene.unDestroyedScenes.add(i),Scene.hideLoadingPage(),t&&t.runWith(i),i}))}static open(e,t=!0,r=null,i=null,a=null){if(r instanceof Handler){var s=i;i=r,r=s}return Scene.showLoadingPage(),Scene.load(e,Handler.create(null,this._onSceneLoaded,[t,i,r]),a)}static _onSceneLoaded(e,t,r,i){i.open(e,r),t&&t.runWith(i)}static close(e,t){let r=!1;for(let i of Scene.unDestroyedScenes)if(i&&i.parent&&i.url===e&&(null==t||i.name==t)){i.close(),r=!0;break}return r}static closeAll(){let e=Scene.root;for(let r=0,i=e.numChildren;r<i;r++){var t=e.getChildAt(0);t instanceof Scene?t.close():t.removeSelf()}}static destroy(e,t){let r=!1;for(let i of Scene.unDestroyedScenes)if(i.url===e&&(null==t||i.name==t)&&!i._destroyed){i.destroy(),r=!0;break}return r}static gc(){Resource.destroyUnusedResources()}static setLoadingPage(e){Scene._loadPage=e}static showLoadingPage(e=null,t=500){Scene._loadPage&&(ILaya.systemTimer.clear(null,Scene._showLoading),ILaya.systemTimer.clear(null,Scene._hideLoading),ILaya.systemTimer.once(t,null,Scene._showLoading,[e],!1))}static _showLoading(e){ILaya.stage.addChild(Scene._loadPage),Scene._loadPage instanceof Scene&&Scene._loadPage.onOpened(e)}static _hideLoading(){Scene._loadPage instanceof Scene?Scene._loadPage.close():Scene._loadPage.removeSelf()}static hideLoadingPage(e=500){Scene._loadPage&&(ILaya.systemTimer.clear(null,Scene._showLoading),ILaya.systemTimer.clear(null,Scene._hideLoading),ILaya.systemTimer.once(e,null,Scene._hideLoading))}}Scene.unDestroyedScenes=new Set;class BlurFilter extends Filter{constructor(e=4){super(),this.shaderData=new TextureSV,this.strength=e}render(t,r,i){let a=50;this.left=-50,this.top=-50;let s=r+100,n=i+100;this.width=s,this.height=n,this.texture&&!this.texture.destroyed&&this.texture.width==s&&this.texture.height==n||(this.texture&&this.texture.destroy(),this.texture=new RenderTexture2D(s,n,e.RenderTargetFormat.R8G8B8A8));let o=this._render2D.clone(this.texture);o.renderStart(!0,new Color(0,0,0,0));let l=this._rectMeshVB,h=this._rectMesh.vertexDeclarition.vertexStride/4;l[0]=50,l[1]=a,l[h]=50+r,l[h+1]=a,l[2*h]=50+r,l[2*h+1]=a+i,l[3*h]=a,l[3*h+1]=a+i;let d=this.shaderData;d.shaderData.addDefine(ShaderDefines2D.FILTERBLUR),d.size=new Vector2(s,n),d.textureHost=t,d.blurInfo=new Vector2(s,n);var u=this.strength/3,c=u*u;d.strength_sig2_2sig2_gauss1=new Vector4(this.strength,c,2*c,1/(2*Math.PI*c)),o.draw(this._rectMesh,0,4*this._rectMesh.vertexDeclarition.vertexStride,0,12,d),o.renderEnd()}}const xt=[0,.01,.02,.04,.05,.06,.07,.08,.1,.11,.12,.14,.15,.16,.17,.18,.2,.21,.22,.24,.25,.27,.28,.3,.32,.34,.36,.38,.4,.42,.44,.46,.48,.5,.53,.56,.59,.62,.65,.68,.71,.74,.77,.8,.83,.86,.89,.92,.95,.98,1,1.06,1.12,1.18,1.24,1.3,1.36,1.42,1.48,1.54,1.6,1.66,1.72,1.78,1.84,1.9,1.96,2,2.12,2.25,2.37,2.5,2.62,2.75,2.87,3,3.2,3.4,3.6,3.8,4,4.3,4.7,4.9,5,5.5,6,6.5,6.8,7,7.3,7.5,7.8,8,8.4,8.7,9,9.4,9.6,9.8,10],Dt=[.3086,.6094,.082,0,0,.3086,.6094,.082,0,0,.3086,.6094,.082,0,0,0,0,0,1,0],vt=[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1];class ColorFilter extends Filter{constructor(e=null){super(),e||(e=this._copyMatrix(vt)),this._mat=new Float32Array(16),this._alpha=new Float32Array(4),this.setByMatrix(e)}render(e,t,r){}gray(){return this.setByMatrix(Dt)}color(e=0,t=0,r=0,i=1){return this.setByMatrix([e,0,0,0,1,0,t,0,0,1,0,0,r,0,1,0,0,0,i,0])}setColor(e){var t=ColorUtils.create(e).arrColor,r=[0,0,0,0,256*t[0],0,0,0,0,256*t[1],0,0,0,0,256*t[2],0,0,0,1,0];return this.setByMatrix(r)}setByMatrix(e){this._matrix!=e&&this._copyMatrix(e);for(var t=0,r=0,i=0;i<20;i++)i%5!=4?this._mat[t++]=e[i]:this._alpha[r++]=e[i];return this}get type(){return Filter.COLOR}get typeDefine(){return ShaderDefines2D.FILTERCOLOR}adjustColor(e,t,r,i){return this.adjustHue(i),this.adjustContrast(t),this.adjustBrightness(e),this.adjustSaturation(r),this}adjustBrightness(e){return 0==(e=this._clampValue(e,100))||isNaN(e)?this:this._multiplyMatrix([1,0,0,0,e,0,1,0,0,e,0,0,1,0,e,0,0,0,1,0,0,0,0,0,1])}adjustContrast(e){if(0==(e=this._clampValue(e,100))||isNaN(e))return this;var t,r=(t=e<0?127+e/100*127:127*(t=0==(t=e%1)?xt[e]:xt[e<<0]*(1-t)+xt[1+(e<<0)]*t)+127)/127,i=.5*(127-t);return this._multiplyMatrix([r,0,0,0,i,0,r,0,0,i,0,0,r,0,i,0,0,0,1,0,0,0,0,0,1])}adjustSaturation(e){if(0==(e=this._clampValue(e,100))||isNaN(e))return this;var t=1+(e>0?3*e/100:e/100),r=1-t,i=.3086*r,a=.6094*r,s=.082*r;return this._multiplyMatrix([i+t,a,s,0,0,i,a+t,s,0,0,i,a,s+t,0,0,0,0,0,1,0,0,0,0,0,1])}adjustHue(e){if(0==(e=this._clampValue(e,180)/180*Math.PI)||isNaN(e))return this;var t=Math.cos(e),r=Math.sin(e),i=.213,a=.715,s=.072;return this._multiplyMatrix([i+t*(1-i)+r*-i,a+t*-a+r*-a,s+t*-s+r*(1-s),0,0,i+t*-i+.143*r,a+t*(1-a)+.14*r,s+t*-s+-.283*r,0,0,i+t*-i+-.787*r,a+t*-a+r*a,s+t*(1-s)+r*s,0,0,0,0,0,1,0,0,0,0,0,1])}reset(){return this.setByMatrix(this._copyMatrix(vt))}_multiplyMatrix(e){var t=[];this._matrix=this._fixMatrix(this._matrix);for(var r=0;r<5;r++){for(var i=0;i<5;i++)t[i]=this._matrix[i+5*r];for(i=0;i<5;i++){for(var a=0,s=0;s<5;s++)a+=e[i+5*s]*t[s];this._matrix[i+5*r]=a}}return this.setByMatrix(this._matrix)}_clampValue(e,t){return Math.min(t,Math.max(-t,e))}_fixMatrix(e=null){return null==e?vt:(e.length<25?e=e.slice(0,e.length).concat(vt.slice(e.length,25)):e.length>25&&(e=e.slice(0,25)),e)}_copyMatrix(e){this._matrix||(this._matrix=[]);for(var t=0;t<25;t++)this._matrix[t]=e[t];return this._matrix}onAfterDeserialize(){let e=ColorUtils.create(this._color||"#FFFFFF").arrColor;this.color(e[0],e[1],e[2],e[3]),this.adjustColor(this._brightness||0,this._contrast||0,this._saturation||0,this._hue||0)}}class GlowFilter extends Filter{constructor(e,t=4,r=6,i=6){super(),this._elements=new Float32Array(9),this._sv_blurInfo1=new Array(4),this._sv_blurInfo2=[0,0,1,0],this._color=new ColorUtils(e||"#000"),this.blur=Math.min(t,20),this.offX=r,this.offY=i,this._sv_blurInfo1[0]=this._sv_blurInfo1[1]=this.blur,this._sv_blurInfo1[2]=r,this._sv_blurInfo1[3]=-i,this.shaderDataBlur=new TextureSV,this.shaderDataCopy=new TextureSV,this.shaderDataCopy1=new TextureSV}_fillQuad(e,t,r,i,a=[0,0,1,1]){let s=this._rectMeshVB,n=this._rectMesh.vertexDeclarition.vertexStride/4;s[0]=e,s[1]=t,s[2]=a[0],s[3]=a[1],s[n]=e+r,s[n+1]=t,s[n+2]=a[2],s[n+3]=a[1],s[2*n]=e+r,s[2*n+1]=t+i,s[2*n+2]=a[2],s[2*n+3]=a[3],s[3*n]=t,s[3*n+1]=t+i,s[3*n+2]=a[0],s[3*n+3]=a[3]}render(t,r,i){this.left=-50,this.top=-50;let a=r+100,s=i+100;this.width=a,this.height=s,this.textureExtend&&!this.textureExtend.destroyed&&this.textureExtend.width==a&&this.textureExtend.height==s||(this.textureExtend&&this.textureExtend.destroy(),this.textureExtend=new RenderTexture2D(a,s,e.RenderTargetFormat.R8G8B8A8));let n=this._render2D.clone(this.textureExtend);n.renderStart(!0,new Color(0,0,0,0)),this.shaderDataCopy1.size=new Vector2(a,s),this.shaderDataCopy1.textureHost=t,this._fillQuad(50,50,t.width,t.height),n.draw(this._rectMesh,0,4*this._rectMesh.vertexDeclarition.vertexStride,0,12,this.shaderDataCopy1),n.renderEnd(),this.texture&&!this.texture.destroyed&&this.texture.width==a&&this.texture.height==s||(this.texture&&this.texture.destroy(),this.texture=new RenderTexture2D(a,s,e.RenderTargetFormat.R8G8B8A8)),n=n.clone(this.texture),n.renderStart(!0,new Color(0,0,0,0)),this._fillQuad(0,0,a,s,[0,1,1,0]);let o=this.shaderDataBlur;o.shaderData.addDefine(ShaderDefines2D.FILTERGLOW),o.size=new Vector2(a,s),o.textureHost=this.textureExtend,o.blurInfo=new Vector2(a,s),o.u_blurInfo1=new Vector4(this._sv_blurInfo1[0],this._sv_blurInfo1[1],this._sv_blurInfo1[2],this._sv_blurInfo1[3]),o.u_blurInfo2=new Vector4(t.width,t.height,this._sv_blurInfo2[2],this._sv_blurInfo2[3]);let l=this.getColor();o.color=new Vector4(l[0],l[1],l[2],l[3]),n.draw(this._rectMesh,0,4*this._rectMesh.vertexDeclarition.vertexStride,0,12,o);let h=this.shaderDataCopy;h.size=new Vector2(a,s),h.textureHost=t,this._fillQuad(50,50,t.width,t.height),n.draw(this._rectMesh,0,4*this._rectMesh.vertexDeclarition.vertexStride,0,12,h),n.renderEnd()}get typeDefine(){return ShaderDefines2D.FILTERGLOW}get offY(){return this._elements[6]}set offY(e){this._elements[6]=e,this._sv_blurInfo1[3]=-e}get offX(){return this._elements[5]}set offX(e){this._elements[5]=e,this._sv_blurInfo1[2]=e}get color(){return this._color.strColor}set color(e){this._color=new ColorUtils(e)}getColor(){return this._color.arrColor}get blur(){return this._elements[4]}set blur(e){this._elements[4]=e,this._sv_blurInfo1[0]=this._sv_blurInfo1[1]=e}}class SoundNode extends Sprite{constructor(){super(),this._loop=1,this.on(Event.ADDED,this,this._onParentChange),this.on(Event.REMOVED,this,this._onParentChange)}get source(){return this._source}set source(e){this._source=e,e?this._autoPlay&&(!this._channel||this._channel.isStopped)&&LayaEnv.isPlaying&&this.play():this.stop()}get isMusic(){return this._isMusic}set isMusic(e){this._isMusic=e}get loop(){return this._loop}set loop(e){this._loop=e}get autoPlay(){return this._autoPlay}set autoPlay(e){this._autoPlay=e,e&&this._source&&(!this._channel||this._channel.isStopped)&&LayaEnv.isPlaying&&this.play()}_onParentChange(){this.target=this.parent}play(e,t){this._source&&((null==e||isNaN(e))&&(e=this._loop),this.stop(),this._isMusic?this._channel=SoundManager.playMusic(this._source,e,t):this._channel=SoundManager.playSound(this._source,e,t))}stop(){this._channel&&!this._channel.isStopped&&this._channel.stop(),this._channel=null}_setPlayAction(e,t,r,i=!0){this[r]&&e&&(i?e.on(t,this,this[r]):e.off(t,this,this[r]))}_setPlayActions(e,t,r,i=!0){if(!e)return;if(!t)return;let a=t.split(","),s=a.length;for(let t=0;t<s;t++)this._setPlayAction(e,a[t],r,i)}set playEvent(e){this._playEvents=e,e&&this._tar&&this._setPlayActions(this._tar,e,"play")}set target(e){this._tar&&(this._setPlayActions(this._tar,this._playEvents,"play",!1),this._setPlayActions(this._tar,this._stopEvents,"stop",!1)),this._tar=e,this._tar&&(this._setPlayActions(this._tar,this._playEvents,"play",!0),this._setPlayActions(this._tar,this._stopEvents,"stop",!0))}set stopEvent(e){this._stopEvents=e,e&&this._tar&&this._setPlayActions(this._tar,e,"stop")}}class VideoTexture extends BaseTexture{constructor(){let t=ILaya.Browser.createElement("video");super(t.videoWidth,t.videoHeight,e.RenderTargetFormat.R8G8B8),this._requestVideoFrame=!1,this._frameRender=!0,this._isLoaded=!1,this._needUpdate=!1,this.immediatelyPlay=!1,this.element=t,this._listeningEvents={},this._dimension=e.TextureDimension.Tex2D;var r=this.element.style;if(r.position="absolute",r.top="0px",r.left="0px",t.setAttribute("crossorigin","anonymous"),ILaya.Browser.onMobile&&(t["x5-playsInline"]=!0,t["x5-playsinline"]=!0,t.x5PlaysInline=!0,t.playsInline=!0,t["webkit-playsInline"]=!0,t["webkit-playsinline"]=!0,t.webkitPlaysInline=!0,t.playsinline=!0,t.style.playsInline=!0,t.crossOrigin="anonymous",t.setAttribute("playsinline","true"),t.setAttribute("x5-playsinline","true"),t.setAttribute("webkit-playsinline","true"),t.autoplay=!0),t.addEventListener("loadedmetadata",(()=>{this.loadedmetadata()})),"requestVideoFrameCallback"in t){const i=this;function updateVideo(){i._needUpdate=!0,t.requestVideoFrameCallback(updateVideo)}t.requestVideoFrameCallback(updateVideo),this._requestVideoFrame=!0}else this._needUpdate=!0}isNeedUpdate(){return!this._requestVideoFrame||this._needUpdate}loadedmetadata(){this._isLoaded||(this._width=this.element.videoWidth,this._height=this.element.videoHeight,Browser.onLayaRuntime?this._texture=LayaGL.textureContext.createTextureInternal(this._dimension,this.element.videoWidth,this.element.videoHeight,e.TextureFormat.R8G8B8A8,!1,!1,!1):this._texture=LayaGL.textureContext.createTextureInternal(this._dimension,this.element.videoWidth,this.element.videoHeight,e.TextureFormat.R8G8B8,!1,!1,!1),this.wrapModeU=e.WrapMode.Clamp,this.wrapModeV=e.WrapMode.Clamp,this.filterMode=e.FilterMode.Bilinear,LayaGL.textureContext.initVideoTextureData(this._texture),this._texture.gammaCorrection=2.2,this.immediatelyPlay&&this.play(),this._isLoaded=!0,this.event(Event.READY,this))}get source(){return this._source}get gammaCorrection(){return 2.2}set source(e){this._source=e,e&&AssetDb.inst.resolveURL(e,(e=>{for(;this.element.childElementCount;)this.element.firstChild.remove();e.startsWith("blob:")?this.element.src=e:this.appendSource(e)}))}appendSource(e){var t=ILaya.Browser.createElement("source");t.src=URL.postFormatURL(URL.formatURL(e));let r=Utils.getFileExtension(e);t.type="m3u8"==r?"application/vnd.apple.mpegurl":"video/"+r,this.element.appendChild(t)}render(){0!=this.element.readyState&&(this.isNeedUpdate()||Browser.onLayaRuntime)&&(LayaGL.textureContext.updateVideoTexture(this._texture,this.element,!1,!1),this._needUpdate=!1)}set frameRender(e){this._frameRender&&!e&&ILaya.timer.clear(this,this.render),!this._frameRender&&e&&ILaya.timer.frameLoop(1,this,this.render),this._frameRender=e}get frameRender(){return this._frameRender}play(){this._texture?(this.element.play().catch((()=>{this.event("NotAllowedError")})),this._frameRender&&ILaya.timer.frameLoop(1,this,this.render)):this.immediatelyPlay=!0}_getSource(){return this._texture?this._texture.resource:null}get defaultTexture(){return Texture2D.whiteTexture}pause(){this.element.pause(),this._frameRender&&ILaya.timer.clear(this,this.render)}load(){this.element.load()}canPlayType(e){return e="m3u8"==e?"application/vnd.apple.mpegurl":"video/"+e,this.element.canPlayType(e)}get buffered(){return this.element.buffered}get currentSrc(){return this.element.currentSrc}get currentTime(){return this.element.currentTime}set currentTime(e){this.element&&(this.element.currentTime=e,this.render())}set volume(e){this.element&&(this.element.volume=e)}get volume(){return this.element.volume}get readyState(){return this.element.readyState}get videoWidth(){return this.element.videoWidth}get videoHeight(){return this.element.videoHeight}get duration(){return this.element.duration}get ended(){return this.element.ended}get error(){return this.element.error}get loop(){return this.element.loop}set loop(e){this.element&&(this.element.loop=e)}get playbackRate(){return this.element.playbackRate}set playbackRate(e){this.element&&(this.element.playbackRate=e)}get muted(){return this.element.muted}set muted(e){this.element&&(this.element.muted=e)}get paused(){return this.element.paused}get preload(){return this.element.preload}set preload(e){this.element&&(this.element.preload=e)}get seekable(){return this.element.seekable}get seeking(){return this.element.seeking}onStartListeningToType(e){if(Ct.has(e)){let t=this._listeningEvents[e];t||(t=this._listeningEvents[e]=()=>{this.event(e)}),this.element.addEventListener(e,t)}}destroy(){if(LayaEnv.isConch,this.element)if(LayaEnv.isConch)this.element._destroy();else for(this.element.pause(),this.element.src="";this.element.childElementCount;)this.element.firstChild.remove();ILaya.timer.clear(this,this.render),super.destroy()}}const Ct=new Set(["abort","canplay","canplaythrough","durationchange","emptied","error","loadeddata","loadedmetadata","loadstart","pause","play","playing","progress","ratechange","seeked","seeking","stalled","suspend","timeupdate","volumechange","waiting","ended"]);class VideoNode extends Sprite{constructor(){if(super(),this.texture=this._internalTex=new Texture,LayaEnv.isPlaying&&ILaya.Browser.onMobile){let func=()=>{ILaya.Browser.document.removeEventListener("touchend",func),this._videoTexture&&(Browser.onIOS?this._videoTexture.load():(this._videoTexture.play(),this._videoTexture.pause()))};ILaya.Browser.document.addEventListener("touchend",func)}}get videoTexture(){return this._videoTexture}set videoTexture(e){this._videoTexture&&(this._videoTexture._removeReference(),this._videoTexture.off(Event.READY,this,this.onVideoMetaLoaded)),this._videoTexture=e,e?(this._videoTexture._addReference(),this._videoTexture.on(Event.READY,this,this.onVideoMetaLoaded),this._videoTexture._isLoaded&&this._internalTex.setTo(this._videoTexture)):this._internalTex.setTo(null)}get source(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.source}set source(e){e?(this._videoTexture||(this.videoTexture=new VideoTexture),this._videoTexture.source=e):this._videoTexture&&(this._videoTexture.source=e)}load(e){this.source=e}play(){this._videoTexture&&this._videoTexture.play()}pause(){this._videoTexture&&this._videoTexture.pause()}reload(){this._videoTexture&&this._videoTexture.load()}canPlayType(e){return this._videoTexture||(this.videoTexture=new VideoTexture),this._videoTexture.canPlayType(e)}onVideoMetaLoaded(){this._internalTex.setTo(this._videoTexture)}get buffered(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.buffered}get currentSrc(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.currentSrc}get currentTime(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.currentTime}set currentTime(e){this._videoTexture&&(this._videoTexture.currentTime=e)}set volume(e){this._videoTexture&&(this._videoTexture.volume=e)}get volume(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.volume}get readyState(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.readyState}get videoWidth(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.videoWidth}get videoHeight(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.videoHeight}get duration(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.duration}get ended(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.ended}get error(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.error}get loop(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.loop}set loop(e){this._videoTexture&&(this._videoTexture.loop=e)}get playbackRate(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.playbackRate}set playbackRate(e){this._videoTexture&&(this._videoTexture.playbackRate=e)}get muted(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.muted}set muted(e){this._videoTexture&&(this._videoTexture.muted=e)}get paused(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.paused}get preload(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.preload}set preload(e){this._videoTexture&&(this._videoTexture.preload=e)}get seekable(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.seekable}get seeking(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.seeking}_setX(e){if(super._setX(e),this._videoTexture&&LayaEnv.isConch){var t=SpriteUtils.getTransformRelativeToWindow(this,0,0);this._videoTexture.element.style.left=t.x}}_setY(e){if(super._setY(e),this._videoTexture&&LayaEnv.isConch){var t=SpriteUtils.getTransformRelativeToWindow(this,0,0);this._videoTexture.element.style.top=t.y}}set_width(e){if(super.set_width(e),this._videoTexture)if(LayaEnv.isConch){var t=SpriteUtils.getTransformRelativeToWindow(this,0,0);this._videoTexture.element.width=e*t.scaleX}else this._videoTexture.element.width=this.width/ILaya.Browser.pixelRatio}set_height(e){if(super.set_height(e),this._videoTexture)if(LayaEnv.isConch){var t=SpriteUtils.getTransformRelativeToWindow(this,0,0);this._videoTexture.element.height=e*t.scaleY}else this._videoTexture.element.height=this.height/ILaya.Browser.pixelRatio}destroy(e=!0){this.videoTexture=null,super.destroy(e)}}class AnimatorPlayState2D{constructor(){this._currentState=null,this._frontPlay=!0}get duration(){return this._duration}get animatorState(){return this._currentState}_resetPlayState(e,t){this._finish=!1,this._startPlayTime=e,this._elapsedTime=e,this._lastIsFront=!0,this._parentPlayTime=null,this._playNum=0,this._playAllTime=0;var r=this._elapsedTime/t%1;this._normalizedPlayTime=r<0?r+1:r,this._frontPlay=!0}_cloneTo(e){e._finish=this._finish,e._startPlayTime=this._startPlayTime,e._elapsedTime=this._elapsedTime,e._playNum=this._playNum,e._parentPlayTime=this._parentPlayTime,e._normalizedPlayTime=this._normalizedPlayTime,e._lastIsFront=this._lastIsFront,e._frontPlay=this._frontPlay,e._playAllTime=this._playAllTime}}class AnimatorControllerLayer2D{constructor(e){this._referenceCount=0,this._playStateInfo=new AnimatorPlayState2D,this._crossPlayStateInfo=new AnimatorPlayState2D,this._crossMark=0,this._crossNodesOwnersCount=0,this._crossNodesOwnersIndicesMap={},this._srcCrossClipNodeIndices=[],this._destCrossClipNodeIndices=[],this.playOnWake=!0,this.defaultWeight=1,this.blendingMode=AnimatorControllerLayer2D.BLENDINGMODE_OVERRIDE,this.enable=!0,this._states=[],this._playType=-1,this.name=e}set states(e){if(this._states!==e){for(let e=this.states.length-1;e>=0;e--)this.removeState(this.states[e]);for(let t=e.length-1;t>=0;t--)this.addState(e[t])}}get states(){return this._states}set defaultStateName(e){if(this._defaultState=this.getStateByName(e),null==this._defaultState)if(0==this._states.length)this._defaultStateNameCatch=e;else for(var t=this._states.length-1;t>=0;t--)if(this._states[t].name==e){this._defaultState=this._states[t];break}}get defaultStateName(){return this._defaultState?this._defaultState.name:null}get defaultState(){return this._defaultState}set defaultState(e){this._defaultState=e}_removeClip(e,t,r){e.splice(t,1)}_getReferenceCount(){return this._referenceCount}_addReference(e){for(var t=0,r=this._states.length;t<r;t++)this._states[t]._addReference(e);this._referenceCount+=e}_removeReference(e=1){for(var t=0,r=this._states.length;t<r;t++)this._states[t]._removeReference(e);this._referenceCount-=e}_clearReference(){this._removeReference(-this._referenceCount)}getCurrentPlayState(){return this._playStateInfo}getStateByName(e){for(let t=this._states.length-1;t>=0;t--)if(this._states[t].name==e)return this._states[t];return null}addState(e){var t=e.name;if(this.getStateByName(t))throw"AnimatorControllerLayer:this stat's name has exist.";this._states.push(e),t==this._defaultStateNameCatch&&(this._defaultState=e,this._defaultStateNameCatch=null)}removeState(e){for(var t=this._states,r=-1,i=0,a=t.length;i<a;i++)if(t[i]===e){r=i;break}-1!=r&&this._removeClip(t,r,e)}clone(){var e=new AnimatorControllerLayer2D(this.name);return this.cloneTo(e),e}cloneTo(e){e.name=this.name}destroy(){this._removeReference();for(var e=0,t=this._states.length;e<t;e++)this._states[e].destroy();this._states.length=0}}var Et,Rt,wt,Mt,bt,It;AnimatorControllerLayer2D.BLENDINGMODE_OVERRIDE=0,AnimatorControllerLayer2D.BLENDINGMODE_ADDTIVE=1,e.AniParmType=void 0,(Et=e.AniParmType||(e.AniParmType={}))[Et.Float=0]="Float",Et[Et.Bool=1]="Bool",Et[Et.Trigger=2]="Trigger",e.AniStateConditionType=void 0,(Rt=e.AniStateConditionType||(e.AniStateConditionType={}))[Rt.Number=0]="Number",Rt[Rt.Bool=1]="Bool",Rt[Rt.Trigger=2]="Trigger",e.AniStateConditionNumberCompressType=void 0,(wt=e.AniStateConditionNumberCompressType||(e.AniStateConditionNumberCompressType={}))[wt.Less=0]="Less",wt[wt.Greater=1]="Greater";class AnimatorControllerParse{static parse(e){let t=e,r=t.controllerLayers;null==r&&(r=[]);let i=[];for(let e=r.length-1;e>=0;e--){let a=r[e],s=a.states;s||(s=[],a.states=s),a.defaultStateName=null;let n=this.checkStates(s,i,t);n?a.defaultStateName=n.enterName:r.splice(e,1)}return{ret:t,clipsID:i}}static checkStates(e,t,r){let i=null,a=null;for(let s=e.length-1;s>=0;s--){let n=e[s];n.states?null==this.checkStates(n.states,t,r)?e.splice(s,1):(null==i&&(i=[]),i.push(n)):"-1"==n.id?a=n:"-2"==n.id||"-3"==n.id||(null==n.clip||null==n.clip._$uuid||""==n.clip._$uuid?e.splice(s,1):(0>t.indexOf(n.clip._$uuid)&&t.push(n.clip._$uuid),this.checkNext(n,e,r),null==i&&(i=[]),i.push(n)))}let s=null;if(i&&a){let e=this.checkDefault(a,i);null!=e&&(s={states:i,enterName:e})}return s}static checkNext(e,t,r){let i=e.soloTransitions;if(i)for(let e=i.length-1;e>=0;e--){let a=i[e],s=this.getStateByID(t,a.id);!s||null==s.clip&&"-3"!=s.id&&null==s.states?i.splice(e,1):(a.name=s.name,a.conditions=this.checkConditions(a.conditions,r))}}static checkConditions(t,r){if(!t||0==t.length||null==r.animatorParams||0==r.animatorParams.length)return[];let i=r.animatorParams;for(let r=t.length-1;r>=0;r--){let a=t[r],s=null;for(let e=i.length-1;e>=0;e--)if(i[e].id==a.id){s=i[e];break}if(null==s)t.splice(r,1);else if(a.name=s.name,s.type==e.AniParmType.Float){let e=Number(a.checkValue);isNaN(e)&&(a.checkValue=0),e=Number(a.type),isNaN(e)&&(a.type=0)}}return t}static checkDefault(e,t){let r=e.soloTransitions,i=null;r&&0<r.length&&(i=r[0].id);let a=null;if(null!=i&&(a=this.getStateByID(t,i)),null!=a&&(null!=a.clip||null!=a.states))return a.name;for(let e=t.length-1;e>=0;e--)if(t[e].clip)return t[e].name;return null}static getStateByID(e,t){if(e)for(let r=e.length-1;r>=0;r--)if(e[r].id==t)return e[r];return null}}e.AnimatorUpdateMode=void 0,(Mt=e.AnimatorUpdateMode||(e.AnimatorUpdateMode={}))[Mt.Normal=0]="Normal",Mt[Mt.LowFrame=1]="LowFrame",Mt[Mt.UnScaleTime=2]="UnScaleTime";class Animator2D extends Component{constructor(){super(),this._speed=1,this._updateMode=e.AnimatorUpdateMode.Normal,this._lowUpdateDelty=20,this._isPlaying=!0,this._controllerLayers=[],this._parameters={}}set controller(e){this._controller=e,e&&e.updateTo(this)}get controller(){return this._controller}set parameters(e){this._parameters=e}get parameters(){return this._parameters}set speed(e){this._speed=e}get speed(){return this._speed}get isPlaying(){return this._isPlaying}_updateStateFinish(e,t){t._finish&&e._eventExit()}_setClipDatasToNode(e,t,r,i=null){for(var a=e._realtimeDatas,s=e._clip._nodes,n=0,o=s.count;n<o;n++)if(null!=a[n]){var l=s.getNodeByIndex(n),h=this.getOwner(l);h&&this._applyFloat(h,t,r,a[n])}}_applyFloat(e,t,r,i){var a=e.pro;a&&a.ower&&(a.ower[a.key]=t&&"number"==typeof i?a.defVal+r*i:"number"==typeof i?r*i:i)}getOwner(e){var t;if(this._ownerMap&&(t=this._ownerMap.get(e)))return t;for(var r=this.owner,i=0,a=e.ownerPathCount;i<a;i++){var s=e.getOwnerPathByIndex(i);if(""!=s&&!(r=r.getChildByName(s)))break}if(t={ower:r},r){var n=r,o=e.propertyCount;if(1==o){var l=e.getPropertyByIndex(0);t.pro={ower:r,key:l,defVal:r[l]}}else for(var h=0;h<o;h++){l=e.getPropertyByIndex(h);if(h==o-1||null==n){t.pro={ower:n,key:l,defVal:n?n[l]:null};break}if(null==n[l]&&r==n){n=null;var d=ClassUtils.getClass(l);d&&(n=r.getComponent(d))}else n=n[l]}}return null==this._ownerMap&&(this._ownerMap=new Map),this._ownerMap.set(e,t),t}_updateClipDatas(e,t,r){var i=e._clip,a=i._duration,s=e.clipStart*a+r._normalizedPlayTime*r._duration,n=e._currentFrameIndices;i._evaluateClipDatasRealTime(s,n,t,!0,e._realtimeDatas)}_updatePlayer(e,t,r,i,a){let s=!1;var n=e._clip._duration*(e.clipEnd-e.clipStart),o=t._elapsedTime;let l=t._playAllTime;t._playAllTime+=Math.abs(r),r=o+r,t._lastElapsedTime=o,t._elapsedTime=r;var h=r/n;let d=1;e.yoyo&&(d=2);let u=t._playAllTime/(n*d);Math.floor(l/(n*d))<Math.floor(u)&&(s=!0);var c=h%1;let _=c<0?c+1:c;if(t._normalizedPlayTime=_,t._duration=n,1!=d&&(_=(c=(h=t._playAllTime/(n*d))%1)<0?c+1:c,e.yoyo&&(.5>_?t._frontPlay||(0>e.speed?(t._elapsedTime=e.clipEnd*l,t._normalizedPlayTime=e.clipEnd):(t._elapsedTime=e.clipStart*l,t._normalizedPlayTime=e.clipStart),t._frontPlay=!0):t._frontPlay&&(t._frontPlay=!1,0>e.speed?(t._elapsedTime=e.clipStart*l,t._normalizedPlayTime=e.clipStart):(t._elapsedTime=e.clipEnd*l,t._normalizedPlayTime=e.clipEnd)))),e._eventStateUpdate(_),!this._applyTransition(a,e._eventtransition(_,this.parameters,s))&&s){let r=t._playAllTime/(n*d);if(0<i&&i<=r)return t._finish=!0,void(0>e.speed?e.yoyo?(t._elapsedTime=e.clipEnd*l,t._normalizedPlayTime=e.clipEnd):(t._elapsedTime=e.clipStart*l,t._normalizedPlayTime=e.clipStart):e.yoyo?(t._elapsedTime=e.clipStart*l,t._normalizedPlayTime=e.clipStart):(t._elapsedTime=e.clipEnd*l,t._normalizedPlayTime=e.clipEnd));e._eventLoop()}}_updateEventScript(e,t){let r=e._clip,i=r._animationEvents;if(!i||0==i.length)return;let a=r._duration,s=t._normalizedPlayTime*a,n=t._frontPlay,o=t._parentPlayTime,l=t._parentPlayTime;null==l&&(l=n?a*t.animatorState.clipStart:a*t.animatorState.clipEnd),n?s<l&&(this._eventScript(i,l,a*t.animatorState.clipEnd,n),l=a*t.animatorState.clipStart):s>l&&(this._eventScript(i,l,a*t.animatorState.clipStart,n),l=a*t.animatorState.clipEnd),this._eventScript(i,l,s,n),o==t._parentPlayTime&&(t._parentPlayTime=s)}_eventScript(e,t,r,i){let a=this.owner.components;if(i)for(let i=0,s=e.length;i<s;i++){let s=e[i];if(s.time>t&&s.time<=r)for(let e=0,t=a.length;e<t;e++){let t=a[e];if(t._isScript()){let e=t[s.eventName];e&&e.apply(t,s.params)}}else if(s.time>r)break}else for(let i=e.length-1;i>=0;i--){let s=e[i];if(s.time<t&&s.time>=r)for(let e=0,t=a.length;e<t;e++){let t=a[e];if(t._isScript()){let e=t[s.eventName];e&&e.apply(t,s.params)}}else if(s.time<r)break}}_applyTransition(e,t){return!!t&&this.crossFade(t.destState.name,e,t.transstartoffset,t.transduration)}_applyUpdateMode(t){let r;switch(this._updateMode){case e.AnimatorUpdateMode.Normal:r=t;break;case e.AnimatorUpdateMode.LowFrame:r=Stat.loopCount%this._lowUpdateDelty==0?t*this._lowUpdateDelty:0;break;case e.AnimatorUpdateMode.UnScaleTime:r=0}return r}gotoAndStopByFrame(e,t,r){var i=this._controllerLayers[t];if(i){var a=i.getStateByName(e);if(!a||!a._clip)return;let s=r/(a._clip._duration*a._clip._frameRate);1<s&&(s=1),this.gotoAndStop(e,t,s)}}gotoAndStop(e,t,r){var i=this._controllerLayers[t];if(i){var a=i.getStateByName(e);if(!a||!a._clip)return;var s=i._playStateInfo,n=s._currentState,o=a._clip._duration,l=a._clip._duration*(a.clipEnd-a.clipStart);s._resetPlayState(o*r,l),s._normalizedPlayTime=r,i._playType=0,n!==a&&(s._currentState=a),a._eventStart(this,t);let h=i.blendingMode!=AnimatorControllerLayer2D.BLENDINGMODE_OVERRIDE;this._updateClipDatas(a,h,s),this._setClipDatasToNode(a,h,i.defaultWeight,i),this.stop()}}play(e,t=0,r=Number.NEGATIVE_INFINITY){if(this._checkEnterIndex){let e=this._checkEnterIndex.indexOf(t);0<=e&&this._checkEnterIndex.splice(e,1)}this._isPlaying=!0;var i=this._controllerLayers[t];if(i){var a=i.defaultState;if(!e&&!a)throw new Error("Animator:must have default clip value,please set clip property.");var s=i._playStateInfo,n=s._currentState,o=e?i.getStateByName(e):a;if(!o._clip)return;var l=o._clip._duration,h=o._clip._duration*(o.clipEnd-o.clipStart);n!==o?(r!==Number.NEGATIVE_INFINITY?s._resetPlayState(l*r,h):s._resetPlayState(0,h),i._playType=0,s._currentState=o):r!==Number.NEGATIVE_INFINITY&&(s._resetPlayState(l*r,h),i._playType=0),o._eventStart(this,t)}}stop(){this._isPlaying=!1}onUpdate(){if(this._isPlaying){if(this._checkEnterIndex)for(let t=this._checkEnterIndex.length-1;t>=0;t--){let r=this._checkEnterIndex[t];if(this._controllerLayers[r]._enterTransition.check(0,this.parameters,!0)){var e=this.getDefaultState(r);this.play(null,r,e.cycleOffset)}}var t=this.owner.timer._delta/1e3;if(t=this._applyUpdateMode(t),0!=this.speed&&0!=t)for(var r=0,i=this._controllerLayers.length;r<i;r++){var a=this._controllerLayers[r];if(a.enable){var s=a._playStateInfo,n=a.blendingMode!=AnimatorControllerLayer2D.BLENDINGMODE_OVERRIDE;if(0===a._playType){var o=s._currentState,l=this._speed*o.speed,h=s._finish,d=o.loop;-1>=d&&(d=o._clip.islooping?0:1);let e=1;s._frontPlay||(e=-1),h||this._updatePlayer(o,s,t*l*e,d,r),o=(s=a._playStateInfo)._currentState,this._updateClipDatas(o,n,s),h||(this._setClipDatasToNode(o,n,a.defaultWeight,a),this._updateEventScript(o,s)),h||this._updateStateFinish(o,s)}}}}}addControllerLayer(e){this._controllerLayers.push(e)}crossFade(e,t=0,r=Number.NEGATIVE_INFINITY,i){var a=this._controllerLayers[t];if(a){if(a.getStateByName(e))return this.play(e,t,r),!0;console.warn("Invalid layerIndex "+t+".")}return!1}onAfterDeserialize(){let e=this.controllerLayers;if(e&&null==this.controller){delete this.controllerLayers,this._controllerLayers.length=0;for(let t of e)this.addControllerLayer(t)}}onEnable(){if(this._checkEnterIndex?this._checkEnterIndex.length=0:this._checkEnterIndex=[],this._isPlaying)for(var e=0,t=this._controllerLayers.length;e<t;e++)if(this._controllerLayers[e].playOnWake){var r=this.getDefaultState(e);if(r){let t=this._controllerLayers[e]._enterTransition;t?(this._isPlaying=!0,t.check(0,this.parameters,!0)?this.play(null,e,r.cycleOffset):this._checkEnterIndex.push(e)):this.play(null,e,r.cycleOffset)}}}getDefaultState(e=0){return this._controllerLayers[e].defaultState}setParamsTrigger(t){this._parameters[t]={name:t,type:e.AniParmType.Trigger,value:!0}}setParamsNumber(t,r){this._parameters[t]={name:t,type:e.AniParmType.Float,value:r}}setParamsBool(t,r){this._parameters[t]={name:t,type:e.AniParmType.Float,value:r}}getParamsvalue(e){let t=this._parameters[e];return t?t.value:null}onDestroy(){for(var e=0,t=this._controllerLayers.length;e<t;e++)this._controllerLayers[e].destroy();this._controllerLayers.length=0,this._isPlaying=!1,this._parameters=null}}class AnimatorState2D extends EventDispatcher{constructor(){super(...arguments),this._referenceCount=0,this._clip=null,this._currentFrameIndices=null,this.cycleOffset=0,this.speed=1,this.clipStart=0,this.clipEnd=1,this.loop=-1,this.yoyo=!1,this.transitions=[],this.soloTransitions=[],this._scripts=null,this._realtimeDatas=[]}get clip(){return this._clip}set clip(e){if(this._clip!=e){if(this._clip&&this._referenceCount>0&&this._clip._removeReference(this._referenceCount),e){var t=e._nodes.count;this._currentFrameIndices=new Int16Array(t),this._resetFrameIndices(),this._referenceCount>0&&e._addReference(this._referenceCount),this._realtimeDatas.length=t}this._clip=e}}_eventStateUpdate(e){if(this.event(AnimatorState2D.EVENT_OnStateUpdate,e),this._scripts)for(var t=0,r=this._scripts.length;t<r;t++)this._scripts[t].onStateUpdate(e)}_eventStart(e,t){if(this.event(AnimatorState2D.EVENT_OnStateEnter),this._scripts)for(var r=0,i=this._scripts.length;r<i;r++)this._scripts[r].setPlayScriptInfo(e,t,this),this._scripts[r].onStateEnter()}_eventExit(){if(this.event(AnimatorState2D.EVENT_OnStateExit),this._scripts)for(let e=0,t=this._scripts.length;e<t;e++)this._scripts[e].onStateExit()}_eventLoop(){if(this.event(AnimatorState2D.EVENT_OnStateLoop),this._scripts)for(let e=0,t=this._scripts.length;e<t;e++)this._scripts[e].onStateLoop&&this._scripts[e].onStateLoop()}_eventtransition(e,t,r){let i=this.soloTransitions.length;if(i>0){for(var a=0;a<i;a++)if(this.soloTransitions[a].check(e,t,r))return this.soloTransitions[a];return null}let s=this.transitions.length;for(a=0;a<s;a++)if(this.transitions[a].check(e,t,r))return this.transitions[a];return null}_resetFrameIndices(){for(var e=0,t=this._currentFrameIndices.length;e<t;e++)this._currentFrameIndices[e]=-1}_getReferenceCount(){return this._referenceCount}_addReference(e){this._clip&&this._clip._addReference(e),this._referenceCount+=e}_removeReference(e){this._clip&&this._clip._removeReference(e),this._referenceCount-=e}_clearReference(){this._removeReference(-this._referenceCount)}addScript(e){var t=new e;return this._scripts=this._scripts||[],this._scripts.push(t),t}getScript(e){if(this._scripts)for(var t=0,r=this._scripts.length;t<r;t++){var i=this._scripts[t];if(i instanceof e)return i}return null}getScripts(e){var t=null;if(this._scripts)for(var r=0,i=this._scripts.length;r<i;r++){var a=this._scripts[r];a instanceof e&&(t=t||[]).push(a)}return t}clone(){var e=new AnimatorState2D;return this.cloneTo(e),e}cloneTo(e){var t=e;t.name=this.name,t.speed=this.speed,t.clip=this._clip}destroy(){this._clip=null,this._currentFrameIndices=null,this._scripts=null,this._realtimeDatas.length=0}}AnimatorState2D.EVENT_OnStateEnter="OnStartEnter",AnimatorState2D.EVENT_OnStateUpdate="OnStateUpdate",AnimatorState2D.EVENT_OnStateExit="OnStateExit",AnimatorState2D.EVENT_OnStateLoop="OnStateLoop";class KeyframeNode2D{constructor(){this._ownerPath=[],this._propertys=[],this._keyFrames=[]}get keyFramesCount(){return this._keyFrames.length}_setOwnerPathCount(e){this._ownerPath.length=e}_setOwnerPathByIndex(e,t){this._ownerPath[e]=t}_setPropertyCount(e){this._propertys.length=e}_setPropertyByIndex(e,t){this._propertys[e]=t}_setKeyframeCount(e){this._keyFrames.length=e}_joinOwnerPath(e){return this._ownerPath.join(e)}_joinProperty(e){return this._propertys.join(e)}getKeyframeByIndex(e){return this._keyFrames[e]}get ownerPathCount(){return this._ownerPath.length}get propertyCount(){return this._propertys.length}getOwnerPathByIndex(e){return this._ownerPath[e]}getPropertyByIndex(e){return this._propertys[e]}}class Keyframe2D{clone(){var e=new Keyframe2D;return this.cloneTo(e),e}cloneTo(e){e.time=this.time}}Keyframe2D.defaultWeight=.33333;class Animation2DEvent{constructor(){}}class AnimationClip2DParse01{static READ_DATA(){this._DATA.offset=this._reader.getUint32(),this._DATA.size=this._reader.getUint32()}static READ_BLOCK(){for(var e=this._BLOCK.count=this._reader.getUint16(),t=this._BLOCK.blockStarts=[],r=this._BLOCK.blockLengths=[],i=0;i<e;i++)t.push(this._reader.getUint32()),r.push(this._reader.getUint32())}static READ_STRINGS(){var e=this._reader.getUint32(),t=this._reader.getUint16(),r=this._reader.pos;this._reader.pos=e+this._DATA.offset;for(var i=0;i<t;i++)this._strings[i]=this._reader.readUTFString();this._reader.pos=r}static parse(e,t,r){this._clip=e,this._reader=t,this._version=r,this.READ_DATA(),this.READ_BLOCK(),this.READ_STRINGS();for(var i=0,a=this._BLOCK.count;i<a;i++){var s=t.getUint16(),n=this._strings[s],o=this["READ_"+n];if(!o)throw new Error("model file err,no this function:"+s+" "+n);o.call(this)}this._version=null,this._reader=null,this._clip=null,this._strings.length=0}static timeToFrame(e,t){return Math.round(e*t)}static READ_ANIMATIONS2D(){var e,t,r,i=this._reader,a=this._clip,s=[],n=i.getUint16();for(s.length=n,e=0;e<n;e++)s[e]=i.getFloat32();a._duration=s[i.getInt16()],a.islooping=!!i.getByte(),a._frameRate=i.getInt16();var o=i.getInt16(),l=a._nodes;l.count=o;var h=a._nodesMap={},d=a._nodesDic={};for(e=0;e<o;e++){r=new KeyframeNode2D,l.setNodeByIndex(e,r),r._indexInList=e;var u=i.getUint16();for(r._setOwnerPathCount(u),t=0;t<u;t++)r._setOwnerPathByIndex(t,this._strings[i.getUint16()]);var c=r._joinOwnerPath("/"),_=h[c];_||(h[c]=_=[]),_.push(r);var p=i.getUint16();for(r._setPropertyCount(p),t=0;t<p;t++)r._setPropertyByIndex(t,this._strings[i.getUint16()]);var g=c+"."+r._joinProperty(".");d[g]=r,r.fullPath=g,r.nodePath=c;var m=i.getUint16();for(t=0;t<m;t++){var f=new Keyframe2D;f.time=s[i.getUint16()],f.data={f:this.timeToFrame(f.time,a._frameRate),val:0},1==i.getByte()&&(f.data.tweenType=this._strings[i.getUint16()]),1==i.getByte()&&(f.data.tweenInfo={},f.data.tweenInfo.inTangent=s[i.getUint16()],f.data.tweenInfo.outTangent=s[i.getUint16()],1==i.getByte()&&(f.data.tweenInfo.inWeight=s[i.getUint16()]),1==i.getByte()&&(f.data.tweenInfo.outWeight=s[i.getUint16()]));var S=i.getByte();if(0==S?f.data.val=s[i.getUint16()]:1==S?f.data.val=this._strings[i.getUint16()]:2==S&&(f.data.val=!!i.getByte()),1==i.getByte())try{f.data.extend=JSON.parse(this._strings[i.getUint16()])}catch(e){}r._keyFrames.push(f)}}var y=i.getUint16();for(e=0;e<y;e++){var T=new Animation2DEvent;T.time=s[i.getUint16()],T.eventName=this._strings[i.getUint16()];var x=[],D=i.getUint16();for(D>0&&(T.params=x=[]),t=0;t<D;t++){switch(i.getByte()){case 0:x.push(!!i.getByte());break;case 1:x.push(i.getInt32());break;case 2:x.push(s[i.getUint16()]);break;case 3:x.push(this._strings[i.getUint16()]);break;default:throw new Error("unknown type.")}}a.addEvent(T)}}}AnimationClip2DParse01._strings=[],AnimationClip2DParse01._DATA={offset:0,size:0},AnimationClip2DParse01._BLOCK={count:0};class KeyframeNodeList2D{constructor(){this._nodes=[]}get count(){return this._nodes.length}set count(e){this._nodes.length=e}getNodeByIndex(e){return this._nodes[e]}setNodeByIndex(e,t){this._nodes[e]=t}}class AnimationClip2D extends Resource{constructor(){super(),this._nodes=new KeyframeNodeList2D,this._animationEvents=[]}static _parse(e){var t=new AnimationClip2D,r=new Byte(e),i=r.readUTFString();if("LAYAANIMATION2D:01"!==i)throw"unknown animationClip version.";return AnimationClip2DParse01.parse(t,r,i),t}duration(){return this._duration}_evaluateClipDatasRealTime(e,t,r,i,a){for(var s=this._nodes,n=0,o=s.count;n<o;n++){var l,h=s.getNodeByIndex(n)._keyFrames,d=h.length;if(0!=d){var u=t[n];if(i)for(-1!=u&&e<h[u].time&&(u=-1,t[n]=u),l=u+1;l<d&&!(h[l].time>e);)u++,l++,t[n]=u;else for((l=u+1)!=d&&e>h[l].time&&(u=d-1,t[n]=u),l=u+1;u>-1&&!(h[u].time<e);)u--,l--,t[n]=u;var c=l==d;if(-1!=u){var _=h[u];if(c)a[n]=_.data.val;else{var p,g=h[l],m=g.time-_.time;p=0!==m?(e-_.time)/m:0,a[n]=this._getTweenVal(_,g,p,m)}}else a[n]=h[0].data.val;r&&"number"==typeof h[0].data.val&&(a[n]=a[n]-h[0].data.val)}}}_getTweenVal(e,t,r,i){var a=e.data,s=t.data;if("number"!=typeof a.val||"number"!=typeof s.val)return a.val;var n=AnimationClip2D.tween[a.tweenType],o=a.val,l=s.val;if(null!=n)return n(r,o,l-o,1);var h=0,d=0,u=NaN,c=NaN;return null!=a.tweenInfo&&(h=a.tweenInfo.outTangent,u=a.tweenInfo.outWeight),null!=s.tweenInfo&&(d=s.tweenInfo.inTangent,c=s.tweenInfo.inWeight),(isNaN(u)||0>=u)&&(u=Keyframe2D.defaultWeight),(isNaN(c)||0>=c)&&(c=Keyframe2D.defaultWeight),isNaN(h)&&(h=0),isNaN(d)&&(d=0),Math.abs(h)==Number.MAX_VALUE&&(h=0>h?-1/0:1/0),Math.abs(d)==Number.MAX_VALUE&&(d=0>d?-1/0:1/0),!a.tweenInfo&&!s.tweenInfo||Keyframe2D.defaultWeight==c&&Keyframe2D.defaultWeight==u?AnimationClip2D.tween.hermiteInterpolate(h,d,o,l,r,i):this.hermiteCurveSplineWeight(o,e.time,u,h,l,t.time,c,d,r)}_binarySearchEventIndex(e){for(var t,r=0,i=this._animationEvents.length-1;r<=i;){t=r+i>>1;var a=this._animationEvents[t].time;if(a==e)return t;a>e?i=t-1:r=t+1}return r}hermiteCurveSplineWeight(e,t,r,i,a,s,n,o,l){let h=222e-18,d=l,u=e,c=r,_=n,p=s-t,g=a-u;g=Math.max(Math.abs(g),h)*(g<0?-1:1);let m=i,f=o;if(!Number.isFinite(m)||!Number.isFinite(f))return e;m=m*p/g,f=f*p/g;let S=1-_,y=.5,T=0;if(Math.abs(c-.33333334)<1e-4&&Math.abs(_-.33333334)<1e-4)y=d,T=1-y;else for(;;){T=1-y;let e=3*T*T*y*c+3*T*y*y*S+y*y*y-d;if(Math.abs(e)<=2.5*h)break;let t=3*T*T*c+6*T*y*(S-c)+3*y*y*(1-S),r=6*T*(S-2*c)+6*y*(1-2*S+c);y-=(6*e*t*t-3*e*e*r)/(6*t*t*t-6*e*t*r+e*e*(18*c-18*S+6))}return(3*T*T*y*c*m+3*T*y*y*(1-_*f)+y*y*y)*g+u}addEvent(e){var t=this._binarySearchEventIndex(e.time);this._animationEvents.splice(t,0,e)}}AnimationClip2D.tween={Linear:function(e,t,r,i){return r*e/i+t},Quad_EaseIn:function(e,t,r,i){return r*(e/=i)*e+t},Quad_EaseOut:function(e,t,r,i){return-r*(e/=i)*(e-2)+t},Quad_EaseInOut:function(e,t,r,i){return(e/=i/2)<1?r/2*e*e+t:-r/2*(--e*(e-2)-1)+t},Cubic_EaseIn:function(e,t,r,i){return r*(e/=i)*e*e+t},Cubic_EaseOut:function(e,t,r,i){return r*((e=e/i-1)*e*e+1)+t},Cubic_EaseInOut:function(e,t,r,i){return(e/=i/2)<1?r/2*e*e*e+t:r/2*((e-=2)*e*e+2)+t},Quart_EaseIn:function(e,t,r,i){return r*(e/=i)*e*e*e+t},Quart_EaseOut:function(e,t,r,i){return-r*((e=e/i-1)*e*e*e-1)+t},Quart_EaseInOut:function(e,t,r,i){return(e/=i/2)<1?r/2*e*e*e*e+t:-r/2*((e-=2)*e*e*e-2)+t},Quint_EaseIn:function(e,t,r,i){return r*(e/=i)*e*e*e*e+t},Quint_EaseOut:function(e,t,r,i){return r*((e=e/i-1)*e*e*e*e+1)+t},Quint_EaseInOut:function(e,t,r,i){return(e/=i/2)<1?r/2*e*e*e*e*e+t:r/2*((e-=2)*e*e*e*e+2)+t},Sine_EaseIn:function(e,t,r,i){return-r*Math.cos(e/i*(Math.PI/2))+r+t},Sine_EaseOut:function(e,t,r,i){return r*Math.sin(e/i*(Math.PI/2))+t},Sine_EaseInOut:function(e,t,r,i){return-r/2*(Math.cos(Math.PI*e/i)-1)+t},Expo_EaseIn:function(e,t,r,i){return 0==e?t:r*Math.pow(2,10*(e/i-1))+t},Expo_EaseOut:function(e,t,r,i){return e==i?t+r:r*(1-Math.pow(2,-10*e/i))+t},Expo_EaseInOut:function(e,t,r,i){return 0==e?t:e==i?t+r:(e/=i/2)<1?r/2*Math.pow(2,10*(e-1))+t:r/2*(2-Math.pow(2,-10*--e))+t},Circ_EaseIn:function(e,t,r,i){return-r*(Math.sqrt(1-(e/=i)*e)-1)+t},Circ_EaseOut:function(e,t,r,i){return r*Math.sqrt(1-(e=e/i-1)*e)+t},Circ_EaseInOut:function(e,t,r,i){return(e/=i/2)<1?-r/2*(Math.sqrt(1-e*e)-1)+t:r/2*(Math.sqrt(1-(e-=2)*e)+1)+t},Elastic_EaseIn:function(e,t,r,i,a,s){if(0==e)return t;if(1==(e/=i))return t+r;if(s||(s=.3*i),!a||a<Math.abs(r)){a=r;var n=s/4}else n=s/(2*Math.PI)*Math.asin(r/a);return-a*Math.pow(2,10*(e-=1))*Math.sin((e*i-n)*(2*Math.PI)/s)+t},Elastic_EaseOut:function(e,t,r,i,a,s){if(0==e)return t;if(1==(e/=i))return t+r;if(s||(s=.3*i),!a||a<Math.abs(r)){a=r;var n=s/4}else n=s/(2*Math.PI)*Math.asin(r/a);return a*Math.pow(2,-10*e)*Math.sin((e*i-n)*(2*Math.PI)/s)+r+t},Elastic_EaseInOut:function(e,t,r,i,a,s){if(0==e)return t;if(2==(e/=i/2))return t+r;if(s||(s=i*(.3*1.5)),!a||a<Math.abs(r)){a=r;var n=s/4}else n=s/(2*Math.PI)*Math.asin(r/a);return e<1?a*Math.pow(2,10*(e-=1))*Math.sin((e*i-n)*(2*Math.PI)/s)*-.5+t:a*Math.pow(2,-10*(e-=1))*Math.sin((e*i-n)*(2*Math.PI)/s)*.5+r+t},Back_EaseIn:function(e,t,r,i,a){return null==a&&(a=1.70158),r*(e/=i)*e*((a+1)*e-a)+t},Back_EaseOut:function(e,t,r,i,a){return null==a&&(a=1.70158),r*((e=e/i-1)*e*((a+1)*e+a)+1)+t},Back_EaseInOut:function(e,t,r,i,a){return null==a&&(a=1.70158),(e/=i/2)<1?r/2*(e*e*((1+(a*=1.525))*e-a))+t:r/2*((e-=2)*e*((1+(a*=1.525))*e+a)+2)+t},Bounce_EaseIn:function(e,t,r,i){return r-AnimationClip2D.tween.Bounce_EaseOut(i-e,0,r,i)+t},Bounce_EaseOut:function(e,t,r,i){return(e/=i)<1/2.75?r*(7.5625*e*e)+t:e<2/2.75?r*(7.5625*(e-=1.5/2.75)*e+.75)+t:e<2.5/2.75?r*(7.5625*(e-=2.25/2.75)*e+.9375)+t:r*(7.5625*(e-=2.625/2.75)*e+.984375)+t},Bounce_EaseInOut:function(e,t,r,i){return e<i/2?.5*AnimationClip2D.tween.Bounce_EaseIn(2*e,0,r,i)+t:.5*AnimationClip2D.tween.Bounce_EaseOut(2*e-i,0,r,i)+.5*r+t},hermiteInterpolate:function(e,t,r,i,a,s){if(Math.abs(e)==1/0||Math.abs(t)==1/0)return r;var n=a*a,o=n*a;return(2*o-3*n+1)*r+(o-2*n+a)*e*s+(o-n)*t*s+(-2*o+3*n)*i}};class Animation2DParm{}e.AniConditionType=void 0,(bt=e.AniConditionType||(e.AniConditionType={}))[bt.Greater=0]="Greater",bt[bt.Less=1]="Less",bt[bt.Equals=2]="Equals",bt[bt.NotEqual=3]="NotEqual";class Animation2DCondition{}class AnimatorStateCondition{constructor(e=null){e&&(this._id=AnimatorStateCondition.conditionNameToID(e),this._name=e)}static conditionNameToID(e){if(null!=AnimatorStateCondition._conditionNameMap[e])return AnimatorStateCondition._conditionNameMap[e];var t=this._propertyNameCounter++;return this._conditionNameMap[e]=t,this._conditionNameMap[t]=e,t}static conditionIDToName(e){return this._conditionNameMap[e]}get id(){return this._id}get name(){return this._name}set name(e){this._id=AnimatorStateCondition.conditionNameToID(e),this._name=e}get type(){return this._type}checkState(e){return!1}}AnimatorStateCondition._conditionNameMap={},AnimatorStateCondition._propertyNameCounter=0;class AnimatorStateNumberCondition extends AnimatorStateCondition{constructor(t){super(t),this._numberValue=0,this._numberCompareFlag=e.AniStateConditionNumberCompressType.Greater,this._type=e.AniStateConditionType.Number}get numberValue(){return this._numberValue}set numberValue(e){this._numberValue=e}get compareFlag(){return this._numberCompareFlag}set compareFlag(e){this._numberCompareFlag=e}checkState(t){return e.AniStateConditionNumberCompressType.Greater==this._numberCompareFlag?t>this._numberValue:t<this._numberValue}}class AnimatorStateBoolCondition extends AnimatorStateCondition{constructor(t){super(t),this._compareFlag=!0,this._type=e.AniStateConditionType.Bool}get compareFlag(){return this._compareFlag}set compareFlag(e){this._compareFlag=e}checkState(e){return this._compareFlag==e}}class AnimatorStateTriggerCondition extends AnimatorStateCondition{constructor(t){super(t),this._type=e.AniStateConditionType.Trigger}checkState(e){return e}}class AnimatorTransition2D{constructor(){this.conditions=[],this.exitByTime=!0,this.exitTime=1,this.transduration=0,this.transstartoffset=0,this.mute=!1}addCondition(e){-1==this.conditions.indexOf(e)&&this.conditions.push(e)}removeCondition(e){let t=this.conditions.indexOf(e);-1!=t&&this.conditions.splice(t,0)}check(t,r,i){if(this.mute)return!1;if(this.exitByTime&&t<this.exitTime&&!i)return!1;if(null==this.conditions||0==this.conditions.length)return!0;for(var a=0;a<this.conditions.length;a++){let t=this.conditions[a];if(t.checkState(r[t.name].value))return t.type==e.AniStateConditionType.Trigger&&(r[t.name].value=!1),!0}return!1}}class AnimatorController2D extends Resource{constructor(e){super();let t=AnimatorControllerParse.parse(e);this.data=t.ret,this.clipsID=t.clipsID}getLayers(){let e=this.data.controllerLayers,t=[];for(let r=e.length-1;r>=0;r--){let i=e[r],a=new AnimatorControllerLayer2D(i.name);t.unshift(a);for(let e in i)if("name"!=e&&"states"!=e&&null!=i[e])try{a[e]=i[e]}catch(e){}this.getState(i.states,a,this.data)}return t}createState(e,t,r){if(!e)return null;let i={},a=null;for(let s=e.length-1;s>=0;s--){let n=e[s],o=n.states;if(o){let e=this.createState(o,t,r);e&&(t[n.id]=e.states[e.id]);continue}if(0>Number(n.id)){if("-1"==n.id){let e=n.soloTransitions;e&&0<e.length&&(a=e[0].id)}continue}let l=new AnimatorState2D;t[n.id]=l,i[n.id]=l;for(let e in n)try{if("scripts"==e){let t=n[e];if(t&&Array.isArray(t))for(let e=t.length-1;e>=0;e--){let r=t[e];r&&0==r.indexOf("res://")&&(r=r.substring(6));let i=ClassUtils.getClass(r);i&&l.addScript(i)}continue}if("soloTransitions"==e)continue;null!=n[e]&&(l[e]=n[e])}catch(e){}r.addState(l)}return{id:a,states:i}}getState(e,t,r){if(e){let i={};this.createState(e,i,t),this.setTransitions(e,i,t,r)}}setExitTransition(e,t,r,i,a){for(let s in e){let n=r[s];if(n){let o=n.transitions,l=n.soloTransitions,h=e[s];for(let e=t.length-1;e>=0;e--){let n=t[e];if("-3"!=n.id)for(let e=h.length-1;e>=0;e--){let t=h[e],a=new AnimatorTransition2D;a.destState=r[n.id],n.conditions&&this.addConditions(n.conditions,a,i),t.conditions&&this.addConditions(t.conditions,a,i);for(let e in n)"solo"!=e&&"id"!=e&&"conditions"!=e&&(a[e]=n[e]);n.solo?l.unshift(a):o.unshift(a)}else null==a[s]&&(a[s]=[]),a[s].push(n)}}}}_getAnimatorTransition2D(e,t,r){let i=new AnimatorTransition2D;t[e.id]&&(i.destState=t[e.id]),e.conditions&&this.addConditions(e.conditions,i,r);for(let t in e)"solo"!=t&&"id"!=t&&"conditions"!=t&&(i[t]=e[t]);return i}setTransitions(e,t,r,i,a){if(!e)return null;let s={};for(let a=e.length-1;a>=0;a--){let n=e[a];if(n.states){let e=this.setTransitions(n.states,t,r,i,n);if(e){let r=n.soloTransitions;r&&this.setExitTransition(e,r,t,i,s)}}}for(let n=e.length-1;n>=0;n--){let o=e[n];if(o.states)continue;if("-1"==o.id){if(o.soloTransitions&&0<o.soloTransitions.length){null==a?(r.defaultState=t[o.soloTransitions[0].id],r._enterTransition=this._getAnimatorTransition2D(o.soloTransitions[0],t,i)):t[a.id]=t[o.soloTransitions[0].id];continue}}else{if("-2"==o.id){let e=o.soloTransitions;if(e)for(let r=e.length-1;r>=0;r--){let a=e[r];if(t[a.id])for(let e in t){let r=t[e],s=this._getAnimatorTransition2D(a,t,i);a.solo?r.soloTransitions.unshift(s):r.transitions.unshift(s)}}continue}if("-3"==o.id)continue}let l=o.soloTransitions;if(l&&t[o.id]){let e=t[o.id].transitions,r=t[o.id].soloTransitions;for(let a=l.length-1;a>=0;a--){let n=l[a];if("-3"==n.id){null==s[o.id]&&(s[o.id]=[]),s[o.id].push(n);continue}let h=this._getAnimatorTransition2D(n,t,i);n.solo?r.unshift(h):e.unshift(h)}}}return s}addConditions(t,r,i){let a=i.animatorParams;if(null!=a&&0!=a.length)for(let i=0,s=t.length;i<s;i++){let s,n=t[i],o=null;for(let e=a.length-1;e>=0;e--)if(a[e].id==n.id){o=a[e];break}if(null==o)return;if(o.type==e.AniParmType.Bool){let e=new AnimatorStateBoolCondition(o.name);e.compareFlag=Boolean(n.checkValue),s=e}else if(o.type==e.AniParmType.Float){let e=new AnimatorStateNumberCondition(o.name);e.numberValue=Number(n.checkValue),e.compareFlag=n.type,s=e}else if(o.type==e.AniParmType.Trigger){s=new AnimatorStateTriggerCondition(o.name)}r.addCondition(s)}}updateTo(e){let t=e._controllerLayers;for(let e=0,r=t.length;e<r;e++)t[e].destroy();t.length=0;let r=this.getLayers();for(let t=0,i=r.length;t<i;t++)e.addControllerLayer(r[t]);let i=this.data.animatorParams;if(i){let t={};for(let e=i.length-1;e>=0;e--){let r=i[e],a=new Animation2DParm;a.name=r.name,a.type=r.type,a.value=r.val,t[r.name]=a}e.parameters=t}}}class Script extends Component{_isScript(){return!0}setupScript(){let e,t=this.owner;this.onTriggerEnter!=Script.prototype.onTriggerEnter&&t.on(Event.TRIGGER_ENTER,this,this.onTriggerEnter),this.onTriggerStay!=Script.prototype.onTriggerStay&&t.on(Event.TRIGGER_STAY,this,this.onTriggerStay),this.onTriggerExit!=Script.prototype.onTriggerExit&&t.on(Event.TRIGGER_EXIT,this,this.onTriggerExit),this.onCollisionEnter!=Script.prototype.onCollisionEnter&&t.on(Event.COLLISION_ENTER,this,this.onCollisionEnter),this.onCollisionStay!=Script.prototype.onCollisionStay&&t.on(Event.COLLISION_STAY,this,this.onCollisionStay),this.onCollisionExit!=Script.prototype.onCollisionExit&&t.on(Event.COLLISION_EXIT,this,this.onCollisionExit),(e=this.onJointBreak)&&t.on(Event.JOINT_BREAK,this,e),(e=this.onMouseDown)&&t.on(Event.MOUSE_DOWN,this,e),(e=this.onMouseUp)&&t.on(Event.MOUSE_UP,this,e),(e=this.onRightMouseDown)&&t.on(Event.RIGHT_MOUSE_DOWN,this,e),(e=this.onRightMouseUp)&&t.on(Event.RIGHT_MOUSE_UP,this,e),(e=this.onMouseMove)&&t.on(Event.MOUSE_MOVE,this,e),(e=this.onMouseDrag)&&t.on(Event.MOUSE_DRAG,this,e),(e=this.onMouseDragEnd)&&t.on(Event.MOUSE_DRAG_END,this,e),(e=this.onMouseOver)&&t.on(Event.MOUSE_OVER,this,e),(e=this.onMouseOut)&&t.on(Event.MOUSE_OUT,this,e),(e=this.onMouseClick)&&t.on(Event.CLICK,this,e),(e=this.onMouseDoubleClick)&&t.on(Event.DOUBLE_CLICK,this,e),(e=this.onMouseRightClick)&&t.on(Event.RIGHT_CLICK,this,e),(e=this.onKeyDown)&&ILaya.stage.on(Event.KEY_DOWN,this,e),(e=this.onKeyPress)&&ILaya.stage.on(Event.KEY_PRESS,this,e),(e=this.onKeyUp)&&ILaya.stage.on(Event.KEY_UP,this,e),t.event(Event._Add_Script)}}e.TextResourceFormat=void 0,(It=e.TextResourceFormat||(e.TextResourceFormat={}))[It.Buffer=0]="Buffer",It[It.Plain=1]="Plain",It[It.JSON=2]="JSON",It[It.XML=3]="XML";class TextResource extends Resource{constructor(e,t){super(),this.data=e,this.format=t}}Loader.registerLoader(["txt","csv"],class{load(t){return t.loader.fetch(t.url,"text",t.progress.createCallback(),t.options).then((t=>t?new TextResource(t,e.TextResourceFormat.Plain):null))}},Loader.TEXT),Loader.registerLoader(["bin","bytes","fui"],class{load(t){return t.loader.fetch(t.url,"arraybuffer",t.progress.createCallback(),t.options).then((t=>t?new TextResource(t,e.TextResourceFormat.Buffer):null))}},Loader.BUFFER),Loader.registerLoader(["json"],class{load(t){return t.loader.fetch(t.url,"json",t.progress.createCallback(),t.options).then((t=>t?new TextResource(t,e.TextResourceFormat.JSON):null))}},Loader.JSON),Loader.registerLoader(["xml"],class{load(t){return t.loader.fetch(t.url,"xml",t.progress.createCallback(),t.options).then((t=>t?new TextResource(t,e.TextResourceFormat.XML):null))}},Loader.XML);Loader.registerLoader(["atlas"],class{load(e){return e.loader.fetch(e.url,"json",e.progress.createCallback(.2),e.options).then((t=>{if(!t)return null;let r=[];if(t.meta&&t.meta.image){let i="",a=e.url.lastIndexOf("/");-1!=a&&(i=e.url.substring(0,a+1));let s="";a=e.url.lastIndexOf("?"),-1!=a&&(s=e.url.substring(a));let n=t.meta.image.split(",");for(let t of n)r.push(e.loader.load(i+t+s,null,e.progress.createCallback()))}else r.push(e.loader.load(Utils.replaceFileExtension(e.url,"png"),null,e.progress.createCallback()));return Promise.all(r).then((r=>{let i=e.options.baseUrl||"",a=t.frames,s=t.meta&&null!=t.meta.prefix?t.meta.prefix:e.url.substring(0,e.url.lastIndexOf("."))+"/",n=[],o=1;t.meta&&t.meta.scale&&1!=t.meta.scale&&(o=parseFloat(t.meta.scale));for(let e of r)e&&(e._addReference(),e.scaleRate=o);for(let t in a){let o=a[t],l=r[o.frame.idx?o.frame.idx:0];if(!l)continue;let h=i+s+(o.filename||t),d=Texture.create(l,o.frame.x,o.frame.y,o.frame.w,o.frame.h,o.spriteSourceSize.x,o.spriteSourceSize.y,o.sourceSize.w,o.sourceSize.h);d.lock=!0,d._sizeGrid=o.sizeGrid,d._stateNum=o.stateNum,e.loader.cacheRes(h,d),d.url=h,n.push(d)}return new AtlasResource(s,r,n)}))}))}},Loader.ATLAS);const Lt=[];class HierarchyParser{static parse(e,t,r){r=r||Lt;let i,a,s,n,o,l,h,d={},u=[],c=[],_=[];function createChildren(e,t){for(let r of e._$child)if(r._$child){let e=createNode(r,t);createChildren(r,r._$prefab?e:t),u.push(r),c.push(e)}else{let e=createNode(r,t);u.push(r),c.push(e)}}function createNode(e,t,i){let a,n;if(n=e._$override){if(t&&s)if(Array.isArray(n)){a=t;for(let e=0,t=n.length;e<t;e++){let t=s.get(a);if(a=null==t?void 0:t[n[e]],!a)break}}else{let r=s.get(t);r&&(a=r[e._$override])}}else{if(n=e._$prefab){let t=Loader.getRes(URL.getResURLByUUID(n),Loader.HIERARCHY);if(t){s||(s=new Map);let i=[],n=e._$id;if(o)for(let e=0,t=o.length;e<t;e++){let r=o[e];r&&r.length>0?i[e]=r.filter((r=>{let i=r._$override||r._$parent;return Array.isArray(i)&&i.length>t-e&&i[t-e-1]==n})):i[e]=r}i.push(e._$child),a=t.create({inPrefab:!0,prefabNodeDict:s,overrideData:i},r)}}else if(n=e._$type){let e=ClassUtils.getClass(i||n);if(e)try{a=new e,null==i||a instanceof Node||(r.push(new Error(`runtime class invalid - '${i}', must derive from Node`)),a=null)}catch(e){r.push(e)}else r.push(new Error(`unknown type '${i||n}'`))}a&&(d[e._$id]=a)}return a}function findNodeInPrefab(e,t,r=0){if(!t)return e;let i=null==s?void 0:s.get(e);if(!i)return null;if(Array.isArray(t)){let e;for(let a=r,n=t.length;a<n;a++){if(!i)return null;if(e=i[t[a]],!e)break;i=s.get(e)}return e}return i[t]}if(t&&(a=t.inPrefab,a&&(s=t.prefabNodeDict),n=t.skinBaseUrl,o=t.overrideData),e._$type||e._$prefab){h=e._$runtime,h&&h.startsWith("res://")&&(h=h.substring(6));let t=createNode(e,null,h);t&&(e._$child&&createChildren(e,e._$prefab?t:null),u.push(e),c.push(t),t instanceof Scene&&(i=t))}else e._$child&&createChildren(e,null);let p=u.length,g=0,m=[];for(let e=0;e<p;e++){let t=u[e],r=c[e],a=t._$child;if(a){let e=a.length;if(r)if(t._$prefab)for(let t=0;t<e;t++){let i=g-e+t,a=_[i];if(a&&!a.parent){let e=m[i],t=findNodeInPrefab(r,e._$parent);if(t){let r=e._$index;null!=r&&r<t.numChildren?t.addChildAt(a,r):t.addChild(a)}else r.addChildAt(a,0)}}else for(let t=0;t<e;t++){let a=_[g-e+t];a&&(r===i&&a._is3D?i._scene3D=a:r.addChild(a))}g-=e}_[g]=r,m[g]=t,g++}_.length=g,_=_.filter((e=>null!=e));let f=_[0],S=[];for(let e=0;e<p;e++){let t=u[e]._$comp;if(!t)continue;let i=c[e];if(i)for(let e of t){let t;if(e._$override){let r=ClassUtils.getClass(e._$override);r&&(t=i.getComponent(r))}else{let a=ClassUtils.getClass(e._$type);if(a&&(t=i.getComponent(a),!t))try{t=i.addComponent(a)}catch(e){r.push(e)}}t&&S.push(e,t)}}const y={outErrors:r,getNodeByRef:function(e){if(Array.isArray(e)){let t=d[e[0]];return t&&e.length>1?findNodeInPrefab(t,e,1):t}return d[e]},getNodeData:function(e){e.visible=!1;let t=c.indexOf(e),r=u[t];return o?(void 0===l&&(l=SerializeUtil.bakeOverrideData(o)),l?SerializeUtil.applyOverrideData(r,l):r):r}};for(let e=0;e<p;e++){let t=u[e],i=c[e];if(i&&(null!=n&&i instanceof Sprite&&(i._skinBaseUrl=n),SerializeUtil.decodeObj(t,i,y),h&&t._$var&&i.name))try{f[i.name]=i}catch(e){r.push(e)}}p=S.length;for(let e=0;e<p;e+=2)SerializeUtil.decodeObj(S[e],S[e+1],y);return a&&s&&f&&s.set(f,d),r==Lt&&(Lt.length=0),_}static collectResourceLinks(e,t){let r={},i=[];function addInnerUrl(e,a){if(!e)return"";let s=r[e];if(void 0===s){let n;n=e.length>=36&&45===e.charCodeAt(8)&&45===e.charCodeAt(13)?"res://"+e:URL.join(t,e),i.push({url:n,type:a}),r[e]=s=[n,a]}else-1==s.indexOf(a,1)&&(s.push(a),i.push({url:s[0],type:a}));return s[0]}if(function check(e){for(let t in e){let r=e[t];if(null!=r)if(Array.isArray(r))for(let e of r)null!=e&&"object"==typeof e&&(null!=e._$uuid?e._$uuid=addInnerUrl(e._$uuid,SerializeUtil.getLoadTypeByEngineType(e._$type)):null!=e._$prefab?(e._$prefab=addInnerUrl(e._$prefab,Loader.HIERARCHY),check(e)):check(e));else"object"==typeof r&&(null!=r._$uuid?r._$uuid=addInnerUrl(r._$uuid,SerializeUtil.getLoadTypeByEngineType(r._$type)):null!=r._$prefab?(r._$prefab=addInnerUrl(r._$prefab,Loader.HIERARCHY),check(r)):check(r))}}(e),e._$preloads)for(let t of e._$preloads)i.push(t);return i}}class HierarchyLoader{load(e){let t=e.url;return("gltf"==e.ext||"fbx"==e.ext||"glb"==e.ext)&&(t=AssetDb.inst.getSubAssetURL(t,e.uuid,"0","lh")),e.loader.fetch(t,"json",e.progress.createCallback(.2),e.options).then((t=>t?null!=t._$ver?this._load(HierarchyLoader.v3,e,t,3):"ls"==e.ext||"lh"==e.ext?this._load(HierarchyLoader.v2,e,t,2):"scene"==e.ext||"prefab"==e.ext?this._load(HierarchyLoader.legacySceneOrPrefab,e,t,2):null:null))}_load(e,t,r,i){let a=URL.getPath(t.url),s=e.collectResourceLinks(r,a);return t.loader.load(s,{initiator:t},t.progress.createCallback()).then((t=>{let a=new PrefabImpl(e,r,i);return a.addDeps(t),a}))}}HierarchyLoader.v3=HierarchyParser,HierarchyLoader.v2=null,HierarchyLoader.legacySceneOrPrefab=LegacyUIParser,Loader.registerLoader(["lh","ls","scene","prefab"],HierarchyLoader,Loader.HIERARCHY);class HDRTextureInfo{constructor(e,t,r,i,a,s,n){this.source=e,this.byteOffset=t,this.decreaseX=r,this.decreaseY=i,this.width=a,this.height=s,this.format=n}static _parseHDRTexture(e,t=null,r=null){let i=HDRTextureInfo.getHDRInfo(e),a=new Texture2D(i.width,i.height,i.format,!1,!1,!1);return a.setHDRData(i),t&&(null!=t.wrapModeU&&(a.wrapModeU=t.wrapModeU),null!=t.wrapModeV&&(a.wrapModeV=t.wrapModeV),null!=t.filterMode&&(a.filterMode=t.filterMode),null!=t.anisoLevel&&(a.anisoLevel=t.anisoLevel)),a}static getHDRInfo(t){let r=new Uint8Array(t),i=0;const readLine=()=>{let e=HDRTextureInfo.getLineString(r,i);return i+=e.length+1,e};if("#?RADIANCE"!=readLine())throw"HDR image: identifier wrong.";let a=new Map,s="";do{if(s=readLine(),"#"!=s[0]){let e=s.split("=");a.set(e[0],e[1])}}while(""!=s);if("32-bit_rle_rgbe"!=a.get("FORMAT"))throw"HDR image: unsupported format.";let n=readLine().split(" "),o="-Y"==n[0],l="-X"==n[2],h=parseInt(n[1]),d=parseInt(n[3]);return new HDRTextureInfo(t,i,l,o,d,h,e.TextureFormat.R32G32B32A32)}static getLineString(e,t){let r=e.length,i=t,a="",s="";for(;i<r&&"\n"!=s;)a=`${a}${s}`,s=String.fromCharCode(e[i]),i++;return a}get_32_bit_rle_rgbe(){let e=this.width,t=this.height;this.decreaseX,this.decreaseY;let r=new Uint8Array(this.source,this.byteOffset),i=0,a=new ArrayBuffer(4*e),s=new Uint8Array(a),n=new ArrayBuffer(e*t*4*3),o=new Float32Array(n);for(let a=t;a>0;a--){r[i++],r[i++];let n=r[i++]<<8|r[i++];if(n!=e)throw"HDR info: scanlineLength wrong.";let l=0;for(let e=0;e<4;e++){let t=(e+1)*n;for(;l<t;){let e=r[i++],a=r[i++];if(e>128){let r=e-128;if(r>t-l)throw"HDR info: ??";for(;r-- >0;)s[l++]=a}else{let n=e;if(0==n||n>t-l)throw"HDR info: ??";if(s[l++]=a,--n>0)for(let e=0;e<n;e++)s[l++]=r[i++]}}}for(let e=0;e<n;e++){let r=s[e],i=s[e+n],l=s[e+2*n],h=s[e+3*n],d=(t-a)*n*3+3*e;const Ldexp=(e,t)=>t>1023?e*Math.pow(2,1023)*Math.pow(2,t-1023):t<-1074?e*Math.pow(2,-1074)*Math.pow(2,t+1074):e*Math.pow(2,t);if(h>0){let e=Ldexp(1,h-136);o[d]=r*e,o[d+1]=i*e,o[d+2]=l*e}else o[d]=0,o[d+1]=0,o[d+2]=0}}return o}readScanLine(){let t=this.width,r=this.height,i=this.decreaseX,a=this.decreaseY,s=3;this.format==e.TextureFormat.R32G32B32A32&&(s=4);let n=new Float32Array(t*r*s),o=new Uint8Array(4*t),l=new Uint8Array(this.source,this.byteOffset),h=l.length,d=0;const getc=()=>{if(d>=h)throw"HDR info: data wrong.";return l[d++]},wrong=()=>{throw"HDR info: data wrong."};for(let e=r-1;e>=0;e--){this.readcolors(o,getc,wrong);for(let l=0;l<t;l++){let h=4*l,d=o[h],u=o[h+1],c=o[h+2],_=o[h+3],p=e,g=l;a&&(p=r-1-e),i&&(g=t-1-l);let m=p*t*s+g*s;if(0==_)n[m]=0,n[m+1]=0,n[m+2]=0,4==s&&(n[m+3]=1);else{let e=ldexp(1,_-136);n[m]=(d+.5)*e,n[m+1]=(u+.5)*e,n[m+2]=(c+.5)*e,4==s&&(n[m+3]=1)}}}return n}readcolors(e,t,r){const setScanLineData=(t,r,i)=>{e[4*t+r]=i};let i=this.width,a=t(),s=t(),n=t(),o=t();if(i<8||i>32767)this.olddreadcolors(e,t,a,s,n,o);else if(2!=a||2!=s||128&n)this.olddreadcolors(e,t,a,s,n,o);else{(n<<8|o)!=i&&r();for(let e=0;e<4;e++)for(let a=0;a<i;){let s=t();if(s>128){s&=127;let n=t();for(a+s>i&&r();s--;)setScanLineData(a++,e,n)}else for(a+s>i&&r();s--;){setScanLineData(a++,e,t())}}}}olddreadcolors(e,t,r,i,a,s){let n=0,o=this.width;e[0]=r,e[1]=i,e[2]=a,e[3]=s;for(let r=1;r<o;r++){let i=t(),a=t(),s=t(),o=t(),l=4*r;if(e[l]=i,e[l+1]=a,e[l+2]=s,e[l+3]=o,1==i&&1==a&&1==s){let t=l-4;for(let r=o<<n;r>0;r--)e[l]=e[t],e[l+1]=e[t+1],e[l+2]=e[t+2],e[l+3]=e[t+3];n+=8}else n=0}}color_color(e,t){let r=0;0==t.w?e.x=e.y=e.z=0:(r=ldexp(1,t.w-136),e.x=t.x*r,e.y=t.y*r,e.z=t.z*r)}}function ldexp(e,t){return e*Math.pow(2,t)}var At,Bt;HDRTextureInfo.HDRTEXTURE="HDRTEXTURE",e.DepthTextureMode=void 0,(At=e.DepthTextureMode||(e.DepthTextureMode={}))[At.None=0]="None",At[At.Depth=1]="Depth",At[At.DepthNormals=2]="DepthNormals",At[At.DepthAndDepthNormals=3]="DepthAndDepthNormals",At[At.MotionVectors=4]="MotionVectors";class RenderTexture extends BaseTexture{constructor(t,r,i,a,s=!1,n=1,o=!1,l=!1){super(t,r,i),this._inPool=!1,this._isCameraTarget=!1,this._generateDepthTexture=!1,this._gammaSpace=l,this._depthStencilFormat=null==a?e.RenderTargetFormat.None:a,this._generateMipmap=s,this._multiSamples=n,this._generateDepthTexture=o,this._createRenderTarget()}static createFromPool(e,t,r,i,a=!1,s=1,n=!1,o=!1){a=a&&0==(e&e-1)&&0==(t&t-1);let l=RenderTexture._pool.length;for(let h=0;h<l;h++){let d=RenderTexture._pool[h];if(d.width==e&&d.height==t&&d.colorFormat==r&&d.depthStencilFormat==i&&d._generateMipmap==a&&d.multiSamples==s&&d.generateDepthTexture==n&&d._gammaSpace==o){d._inPool=!1;let e=RenderTexture._pool[l-1];return RenderTexture._pool[h]=e,RenderTexture._pool.length-=1,RenderTexture._poolMemory-=d._renderTarget.gpuMemory/1024/1024,d}}let h=new RenderTexture(e,t,r,i,a,s,n,o);return h.lock=!0,h}static recoverToPool(e){e._inPool||e.destroyed||(RenderTexture._pool.push(e),RenderTexture._poolMemory+=e._renderTarget.gpuMemory/1024/1024,e._inPool=!0)}static clearPool(){if(!(RenderTexture._poolMemory<Config3D.defaultCacheRTMemory)){for(var e in RenderTexture._pool)RenderTexture._pool[e].destroy();RenderTexture._pool=[],RenderTexture._poolMemory=0}}static get bindCanvasRender(){return RenderTexture._bindCanvasRender}static set bindCanvasRender(e){e!=this._bindCanvasRender&&(this._bindCanvasRender=e)}get generateDepthTexture(){return this._generateDepthTexture}set generateDepthTexture(t){this.depthStencilFormat!=e.RenderTargetFormat.None?(t&&!this._depthStencilTexture&&(this._depthStencilTexture=new BaseTexture(this.width,this.height,this.depthStencilFormat),this._depthStencilTexture._dimension=e.TextureDimension.Tex2D,this._depthStencilTexture._texture=LayaGL.textureContext.createRenderTargetDepthTexture(this._renderTarget,e.TextureDimension.Tex2D,this.width,this.height)),this._generateDepthTexture=t):this._generateDepthTexture=!1}get depthStencilTexture(){return this._depthStencilTexture}get colorFormat(){return this._renderTarget.colorFormat}get depthStencilFormat(){return this._renderTarget.depthStencilFormat}get multiSamples(){return this._renderTarget._samples}get isCube(){return this._renderTarget._isCube}get samples(){return this._renderTarget._samples}get generateMipmap(){return this._renderTarget._generateMipmap}_createRenderTarget(){this._dimension=e.TextureDimension.Tex2D,this._renderTarget=LayaGL.textureContext.createRenderTargetInternal(this.width,this.height,this._format,this._depthStencilFormat,this._generateMipmap,this._gammaSpace,this._multiSamples),this._generateMipmap=this._renderTarget._generateMipmap,this._renderTarget._texturesResolve?this._texture=this._renderTarget._texturesResolve[0]:this._texture=this._renderTarget._textures[0],this.generateDepthTexture=this._generateDepthTexture}recreate(t,r,i,a,s=!1,n=1,o=!1,l=!1){this._width=t,this._height=r,this._format=i,this._gammaSpace=l,this._depthStencilFormat=null==a?e.RenderTargetFormat.None:a,this._generateMipmap=s,this._multiSamples=n,this._generateDepthTexture=o,this._disposeResource(),this._createRenderTarget()}getData(e,t,r,i,a){return LayaGL.textureContext.readRenderTargetPixelData(this._renderTarget,e,t,r,i,a),a}getDataAsync(e,t,r,i,a){return LayaGL.textureContext.readRenderTargetPixelDataAsync(this._renderTarget,e,t,r,i,a)}_disposeResource(){var e;this._renderTarget.dispose(),this._renderTarget=null,null===(e=this._depthStencilTexture)||void 0===e||e.destroy(),this._depthStencilTexture=null}}RenderTexture._pool=[],RenderTexture._poolMemory=0;const Pt={premultiplyAlpha:!0},Nt=[null,null,e.TextureFormat.R8G8B8A8,!1,!1,!0];const Ft=["ktx","pvr","dds","hdr","lanit.ls"],Ut=["mp4","webm"];Loader.registerLoader(["tga","tif","tiff","png","jpg","jpeg","rendertexture",...Ut,...Ft],class{wrapTex2D(e,t){if(!t)return null;let r=e.obsoluteInst;return r?(r.setTo(t),r.obsolute=!1,r._sizeGrid=t._sizeGrid,r._stateNum=t._stateNum,r.event("reload"),r._clipCache&&r._clipCache.forEach((e=>{e.event("reload"),e._sizeGrid=r._sizeGrid,e._stateNum=r._stateNum}))):(r=new Texture(t),r._sizeGrid=t._sizeGrid,r._stateNum=t._stateNum),r}load(e){let t=e.loader.getRes(e.url,Loader.TEXTURE2D);if(!t||t.obsolute){let t={url:e.url,type:Loader.TEXTURE2D};return e.options.propertyParams?null==e.options.propertyParams.premultiplyAlpha&&(t.propertyParams=Object.assign({},Pt,e.options.propertyParams)):t.propertyParams=Pt,e.options.constructParams?null==e.options.constructParams[5]&&(t.constructParams=Object.assign([],Nt,e.options.constructParams)):t.constructParams=Nt,e.loader.load(t,e.options,e.progress.createCallback()).then((t=>this.wrapTex2D(e,t)))}return Promise.resolve(this.wrapTex2D(e,t))}},Loader.IMAGE),Loader.registerLoader([],class{constructor(){Bt||(Bt={"WhiteTexture.png":Texture2D.whiteTexture,"BlackTexture.png":Texture2D.blackTexture,"GrayTexture.png":Texture2D.grayTexture,"NormalTexture.png":Texture2D.normalTexture})}load(e){if(-1!=e.url.indexOf("internal/")){let t=Bt[Utils.getBaseName(e.url)];if(t)return Promise.resolve(t)}let t;return e.url.startsWith("data:")||(t=AssetDb.inst.metaMap[e.url],t||!LayaEnv.isPreview)?this.load2(e,t):AssetDb.inst.getMeta(e.url,e.uuid).then((t=>this.load2(e,t)))}load2(t,r){var i,a,s;let n,o,l=t.ext,h=t.url;if(r){let e=Browser.platform,d=(null===(i=r.platforms)||void 0===i?void 0:i[e])||0,u=(null===(a=r.files)||void 0===a?void 0:a[d])||{};u.file&&(h=AssetDb.inst.getSubAssetURL(h,t.uuid,u.file,u.ext),l=u.ext),n=[0,0,null!==(s=u.format)&&void 0!==s?s:1,r.mipmap,r.readWrite,r.sRGB],o={wrapModeU:r.wrapMode,wrapModeV:r.wrapMode,filterMode:r.filterMode,anisoLevel:r.anisoLevel,premultiplyAlpha:!!r.pma,hdrEncodeFormat:r.hdrEncodeFormat}}else n=t.options.constructParams,o=t.options.propertyParams;let d=-1!=Ft.indexOf(l)?l:null;if(null!=d)return t.loader.fetch(h,"arraybuffer",t.progress.createCallback(),t.options).then((i=>{if(!i)return null;let a;switch(d){case"dds":let t=DDSTextureInfo.getDDSTextureInfo(i);if(t.isCube){let e=ClassUtils.getClass("TextureCube");if(!e)return null;{let r=!!n&&!!n[5],i=new e(t.width,t.format,t.mipmapCount>1,r);i.setDDSData(t),a=i}}else a=Texture2D._parseDDS(i,o,n);break;case"ktx":let r=KTXTextureInfo.getKTXTextureInfo(i);if(r.dimension==e.TextureDimension.Cube){let e=ClassUtils.getClass("TextureCube");if(!e)return null;{let t=new e(r.width,r.format,r.mipmapCount>1,r.sRGB);t.setKTXData(r),a=t}}else r.dimension==e.TextureDimension.Tex2D&&(a=Texture2D._parseKTX(i,o,n));break;case"pvr":a=Texture2D._parsePVR(i,o,n);break;case"hdr":a=HDRTextureInfo._parseHDRTexture(i,o,n);break;case"lanit.ls":a=Texture2D._SimpleAnimatorTextureParse(i,o,n)}let s=t.obsoluteInst;return s&&Object.getPrototypeOf(s)==Object.getPrototypeOf(a)&&(a=this.move(s,a)),o&&o.hdrEncodeFormat&&(a.hdrEncodeFormat=o.hdrEncodeFormat),r&&(a._sizeGrid=r.sizeGrid,a._stateNum=r.stateNum),a}));{let e=t.options,i=o&&o.premultiplyAlpha?"premultiply":"none";return e.useWorkerLoader&&"none"===i&&(e=Object.assign({workerLoaderOptions:{premultiplyAlpha:i}},e)),t.loader.fetch(h,"image",t.progress.createCallback(),e).then((t=>LayaGL.textureContext.needBitmap?t instanceof ImageBitmap?t:createImageBitmap(t,e.workerLoaderOptions||{premultiplyAlpha:i}):t)).then((e=>{if(!e)return null;let i=Texture2D._parseImage(e,o,n),a=t.obsoluteInst;return a&&Object.getPrototypeOf(a)==Object.getPrototypeOf(i)&&(i=this.move(a,i)),r&&(i._sizeGrid=r.sizeGrid,i._stateNum=r.stateNum),i}))}}move(e,t){return e._texture=t._texture,e._format=t.format,e.width=t.width,e.height=t.height,e.obsolute=!1,delete Resource._idResourcesMap[t.id],e}},Loader.TEXTURE2D),Loader.registerLoader(["rendertexture"],class{load(e){return e.loader.fetch(e.url,"json",e.progress.createCallback(),e.options).then((t=>{if(!t)return null;let r=e.obsoluteInst;return r?r.recreate(t.width,t.height,t.colorFormat,t.depthFormat,t.generateMipmap,t.multiSamples,t.generateDepthTexture,t.sRGB):r=new RenderTexture(t.width,t.height,t.colorFormat,t.depthFormat,t.generateMipmap,t.multiSamples,t.generateDepthTexture,t.sRGB),null!=t.anisoLevel&&(r.anisoLevel=t.anisoLevel),null!=t.filterMode&&(r.filterMode=t.filterMode),null!=t.wrapModeU&&(r.wrapModeU=t.wrapModeU),null!=t.wrapModeV&&(r.wrapModeV=t.wrapModeV),r}))}},Loader.TEXTURE2D),Loader.registerLoader(Ut,class{load(e){let t=e.obsoluteInst||new VideoTexture;return t.source=e.url,Promise.resolve(t)}},Loader.TEXTURE2D);Loader.registerLoader(["mc"],class{load(e){return e.loader.fetch(e.url,"arraybuffer",e.progress.createCallback(),e.options).then((e=>e?AnimationClip2D._parse(e):null))}});Loader.registerLoader(["mcc"],class{load(e){return e.loader.fetch(e.url,"json",e.progress.createCallback(.2),e.options).then((t=>{let r=new AnimatorController2D(t);if(r.data&&r.data.controllerLayers){let t=r.data.controllerLayers,i=[];for(let r=t.length-1;r>=0;r--){let a=t[r].states;this.loadStates(a,i,e)}return Promise.all(i).then((()=>r))}return r}))}loadStates(e,t,r){let i=URL.getPath(r.url);for(let a=e.length-1;a>=0;a--){if(e[a].clip&&e[a].clip._$uuid){let s=URL.getResURLByUUID(e[a].clip._$uuid);s.startsWith("res://")||(s=URL.join(i,s)),t.push(r.loader.load(s).then((t=>{e[a].clip=t})))}e[a].states&&this.loadStates(e[a].states,t,r)}}});class NullLoader{load(e){return Promise.resolve(null)}}Loader.registerLoader(["lighting"],NullLoader);Loader.registerLoader(["fnt"],class{load(e){let t=Utils.replaceFileExtension(e.url,"png");return Promise.all([e.loader.fetch(e.url,"xml",e.progress.createCallback(.2),e.options),e.loader.load(t,e.options,e.progress.createCallback(.8))]).then((([e,t])=>{if(!e||!t)return null;let r=new BitmapFont;return r.parseFont(e,t),r}))}},Loader.FONT);const Ot="LayaTTFFont";Loader.registerLoader(["ttf","woff","woff2","otf"],class{load(e){let t=Utils.replaceFileExtension(Utils.getBaseName(e.url),"");if(LayaEnv.isConch)return e.loader.fetch(e.url,"arraybuffer").then((e=>(e&&window.conch.registerFont(t,e),{family:t})));if(window.FontFace){let r=new window.FontFace(t,"url('"+URL.postFormatURL(URL.formatURL(e.url))+"')");return document.fonts.add(r),r.load().then((()=>r))}{let r="40px "+t,i=Browser.measureText(Ot,r).width,a=Browser.createElement("style");return a.type="text/css",document.body.appendChild(a),a.textContent="@font-face { font-family:'"+t+"'; src:url('"+URL.postFormatURL(URL.formatURL(e.url))+"');}",new Promise((e=>{let checkComplete=()=>{Browser.measureText(Ot,r).width!=i&&complete()},complete=()=>{ILaya.systemTimer.clear(this,checkComplete),ILaya.systemTimer.clear(this,complete),e({family:t})};ILaya.systemTimer.once(1e4,this,complete),ILaya.systemTimer.loop(20,this,checkComplete)}))}}},Loader.TTF);class MaterialParser{static parse(e){let t=e.props;switch(e.version){case"LAYAMATERIAL:01":case"LAYAMATERIAL:02":case"LAYAMATERIAL:03":let t=MaterialParser.parseLegacy(e);return t.oldparseEndEvent(),t;case"LAYAMATERIAL:04":break;default:throw new Error(`unkonwn material version: ${e.version}`)}let r,i=new Material;i.setShaderName(t.type);for(let e in t)switch(e){case"type":case"name":break;case"defines":let s=t[e];for(let e=0,t=s.length;e<t;e++){let t=Shader3D.getDefineByName(s[e]);i._shaderValues.addDefine(t)}break;case"textures":let n=t[e];for(let e=0,t=n.length;e<t;e++){let t=n[e],r=t.path;r&&i._shaderValues.setTexture(Shader3D.propertyNameToID(t.name),Loader.getBaseTexture(r))}break;case"renderQueue":r=t[e];break;case"alphaTest":i.alphaTest=t[e];break;case"materialRenderMode":i.materialRenderMode=t[e];break;default:let o=t[e],l=Shader3D.propertyNameToID(e);switch(l){case Shader3D.CULL:i.cull=o;break;case Shader3D.BLEND:i.blend=o;break;case Shader3D.BLEND_SRC:i.blendSrc=o;break;case Shader3D.BLEND_DST:i.blendDst=o;break;case Shader3D.BLEND_DST_ALPHA:i.blendDstAlpha=o;break;case Shader3D.BLEND_SRC_ALPHA:i.blendSrcAlpha=o;break;case Shader3D.BLEND_SRC_RGB:i.blendSrcRGB=o;break;case Shader3D.BLEND_SRC_RGB:i.blendDstRGB=o;break;case Shader3D.DEPTH_TEST:i.depthTest=o;break;case Shader3D.DEPTH_WRITE:i.depthWrite=!!t[e];break;case Shader3D.STENCIL_TEST:i.stencilTest=o;break;case Shader3D.STENCIL_Op:i.stencilOp=o;break;case Shader3D.STENCIL_Ref:i.stencilRef=o;break;case Shader3D.STENCIL_WRITE:i.stencilWrite=o;break;default:if(o.length){var a=o;switch(a.length){case 2:i._shaderValues.setVector2(l,new Vector2(a[0],a[1]));break;case 3:i._shaderValues.setVector3(l,new Vector3(a[0],a[1],a[2]));break;case 4:i._shaderValues.getColor(l)?i._shaderValues.setColor(l,new Color(a[0],a[1],a[2],a[3])):i._shaderValues.setVector(l,new Vector4(a[0],a[1],a[2],a[3]));break;case 9:let e=new Matrix3x3;e.elements=new Float32Array(a),i._shaderValues.setMatrix3x3(l,e);break;case 16:let t=new Matrix4x4;t.elements=new Float32Array(a),i._shaderValues.setMatrix4x4(l,t);break;default:i._shaderValues.setBuffer(l,a)}}else i._shaderValues.setNumber(l,t[e])}}return null!=r&&(i.renderQueue=r),i}static collectLinks(e,t){var r;let i=[],a=null===(r=e.props)||void 0===r?void 0:r.textures;if(a)for(let e=0,r=a.length;e<r;e++){let r=a[e],s=r.path;s&&(r.path=URL.join(t,s),i.push({url:r.path,type:Loader.TEXTURE2D,constructParams:r.constructParams,propertyParams:r.propertyParams}))}return i}static parseLegacy(e){let t,r=e,i=r.props,a=i.type,s=ClassUtils.getClass(a);switch(!s&&a&&a.startsWith("Laya.")&&(s=ClassUtils.getClass(a.substring(5))),s?t=new s:(t=new Material,t.setShaderName(a)),r.version){case"LAYAMATERIAL:01":case"LAYAMATERIAL:02":for(let e in i)switch(e){case"type":break;case"vectors":let r=i[e];for(let e=0,i=r.length;e<i;e++){let i=r[e],a=i.value;switch(a.length){case 2:t[i.name]=new Vector2(a[0],a[1]);break;case 3:t[i.name]instanceof Color?t[i.name]=new Color(a[0],a[1],a[2],1):t[i.name]=new Vector3(a[0],a[1],a[2]);break;case 4:t[i.name]instanceof Color?t[i.name]=new Color(a[0],a[1],a[2],a[3]):t[i.name]=new Vector4(a[0],a[1],a[2],a[3]);break;default:throw new Error("unkonwn material color length: "+a.length)}}break;case"colors":let a=i[e];for(let e=0,r=a.length;e<r;e++){let r=a[e],i=r.value;t[r.name]=new Color(i[0],i[1],i[2],i[3])}break;case"textures":let s=i[e];for(let e=0,r=s.length;e<r;e++){let r=s[e],i=r.path;i&&(t[r.name]=Loader.getBaseTexture(i))}break;case"defines":let n=i[e];for(let e=0,r=n.length;e<r;e++){let r=Shader3D.getDefineByName(n[e]);t._shaderValues.addDefine(r)}break;case"renderStates":let o=i[e][0];t.blend=o.blend,t.cull=this._getRenderStateParams(o.cull),t.depthTest=this._getRenderStateParams(o.depthTest),t.depthWrite=o.depthWrite,t.blendSrc=this._getRenderStateParams(o.srcBlend),t.blendDst=this._getRenderStateParams(o.dstBlend);break;case"cull":t.cull=this._getRenderStateParams(i[e]);break;case"blend":t.blend=this._getRenderStateParams(i[e]);break;case"depthWrite":t.depthWrite=!!i[e];break;case"srcBlend":case"blendSrc":t.blendSrc=this._getRenderStateParams(i[e]);break;case"dstBlend":case"blendDst":t.blendDst=this._getRenderStateParams(i[e]);break;case"depthTest":t.depthTest=this._getRenderStateParams(i[e]);break;default:t[e]=i[e]}break;case"LAYAMATERIAL:03":for(let e in i)switch(e){case"type":case"name":break;case"defines":let r=i[e];for(let e=0,i=r.length;e<i;e++){let i=Shader3D.getDefineByName(r[e]);t._shaderValues.addDefine(i)}break;case"textures":let a=i[e];for(let e=0,r=a.length;e<r;e++){let r=a[e],i=r.path;i&&t._shaderValues.setTexture(Shader3D.propertyNameToID(r.name),Loader.getBaseTexture(i))}break;case"renderQueue":t.renderQueue=i[e];break;default:let s=i[e],o=Shader3D.propertyNameToID(e);switch(o){case Shader3D.CULL:t.cull=this._getRenderStateParams(s);break;case Shader3D.BLEND:t.blend=this._getRenderStateParams(s);break;case Shader3D.BLEND_SRC:t.blendSrc=this._getRenderStateParams(s);break;case Shader3D.BLEND_DST:t.blendDst=this._getRenderStateParams(s);break;case Shader3D.DEPTH_TEST:t.depthTest=this._getRenderStateParams(s);break;case Shader3D.DEPTH_WRITE:t.depthWrite=!!i[e];break;default:if(s.length){var n=s;switch(n.length){case 2:t._shaderValues.setVector2(o,new Vector2(n[0],n[1]));break;case 3:t._shaderValues.setVector3(o,new Vector3(n[0],n[1],n[2]));break;case 4:t._shaderValues.getColor(o)?t._shaderValues.setColor(o,new Color(n[0],n[1],n[2],n[3])):t._shaderValues.setVector(o,new Vector4(n[0],n[1],n[2],n[3]));break;default:throw new Error("unkonwn material color length: "+n.length)}}else t._shaderValues.setNumber(o,i[e])}}break;default:throw new Error("unkonwn material version: "+r.version)}return t}static _getRenderStateParams(t){switch(t){case 768:return e.BlendFactor.SourceColor;case 769:return e.BlendFactor.OneMinusSourceColor;case 774:return e.BlendFactor.DestinationColor;case 775:return e.BlendFactor.OneMinusDestinationColor;case 770:return e.BlendFactor.SourceAlpha;case 771:return e.BlendFactor.OneMinusSourceAlpha;case 772:return e.BlendFactor.DestinationAlpha;case 773:return e.BlendFactor.OneMinusDestinationAlpha;case 776:return e.BlendFactor.SourceAlphaSaturate;case 32774:return e.BlendEquationSeparate.ADD;case 32778:return e.BlendEquationSeparate.SUBTRACT;case 32779:return e.BlendEquationSeparate.REVERSE_SUBTRACT;case 512:return e.CompareFunction.Never;case 513:return e.CompareFunction.Less;case 514:return e.CompareFunction.Equal;case 515:return e.CompareFunction.LessEqual;case 516:return e.CompareFunction.Greater;case 517:return e.CompareFunction.NotEqual;case 518:return e.CompareFunction.GreaterEqual;case 519:return e.CompareFunction.Always;default:return t}}}Loader.registerLoader(["lmat"],class{load(e){return e.loader.fetch(e.url,"json",e.progress.createCallback(.3),e.options).then((t=>{if(!t)return null;let r=URL.getPath(e.url),i=MaterialParser.collectLinks(t,r);if("LAYAMATERIAL:04"===t.version){let a=t.props.type;if(!Shader3D.find(a)){let s=AssetDb.inst.shaderName_to_URL(a);if(!s)return AssetDb.inst.shaderName_to_URL_async(a).then((s=>(s?i.push(s):t.props.shaderPath?i.push(URL.join(r,t.props.shaderPath)):Loader.warn(`unknown shaderName: ${a}`),this.load2(e,t,i))));i.push(s)}}return this.load2(e,t,i)}))}load2(e,t,r){if(0==r.length){let r=MaterialParser.parse(t),i=e.obsoluteInst;return i&&(r=this.move(i,r)),Promise.resolve(r)}return e.loader.load(r,e.options,e.progress.createCallback()).then((()=>{let r=MaterialParser.parse(t),i=e.obsoluteInst;return e.obsoluteInst&&(r=this.move(i,r)),r}))}move(e,t){return e._shaderValues.reset(),e.setShaderName(t._shader.name),t._shaderValues.cloneTo(e._shaderValues),e.renderQueue=t.renderQueue,e.materialRenderMode=t.materialRenderMode,e.obsolute=!1,t.destroy(),e}},Loader.MATERIAL);class ParseJSON{static parse(e){return this.parseStart(e)}static findIndex(e,t,r,i){var a=e.indexOf(r,t+1);return 0>a&&(a=i),{str:e.substring(t+1,a),i:a}}static finCurrObj(){if(this.type=1,null==this.cobj)return null;if(0==this.currArr.length)return this.cobj.k&&(this.ret[this.cobj.k]=this.cobj.val),null;var e=this.currArr.pop();if(this.cobj.k)if(Array.isArray(e.val)){if(null!=this.cobj.k){var t={};t[this.cobj.k]=this.cobj.val,e.val.push(t)}}else e.val[this.cobj.k]=this.cobj.val;else Array.isArray(this.cobj.val)&&(Array.isArray(e.val)?e.val.push(this.cobj.val):e.val=this.cobj.val);return e}static formatVal(e){if(null==e)return null;var t=Number(e);return isNaN(t)?"false"!=e.toLowerCase()&&("true"==e.toLowerCase()||("null"==e?null:e)):t}static finCurrStr(){null!=this.currStr&&(this.currStr=this.currStr.trim(),""!=this.currStr&&(null!=this.cobj&&(Array.isArray(this.cobj.val)?this.cobj.val.push(this.formatVal(this.currStr)):(this.cobj.val=this.formatVal(this.currStr),this.cobj=this.finCurrObj())),this.currStr=""))}static parseStart(e){this.len=e.length;var t=0;for(this.ret={},this.currStr=null,this.currArr=[],this.cobj=null,this.type=0;t<this.len;){var r=e.charAt(t);if("/"==r){if(t+1<this.len){t+=1;var i=e.charAt(t),a=null;if("/"==i?a="\n":"*"==i&&(a="*/"),null!=a){this.finCurrStr();var s=e.indexOf(a,t);0>s?(console.log("没有找到注释结尾，应该是一直注释到最后了"),t=this.len):t=s+a.length-1}}}else if("}"==r)null!=this.cobj&&(this.finCurrStr(),null!=this.cobj&&(this.cobj=this.finCurrObj())),this.currStr="",this.type=1;else if("{"==r)this.currStr="",this.type=1;else if("'"==r||'"'==r||"‘"==r||"“"==r){"‘"==r?r="’":"“"==r&&(r="”");var n=this.findIndex(e,t,r,this.len);2==this.type&&null!=this.cobj&&Array.isArray(this.cobj.val)?(null!=this.currStr&&(this.currStr=this.currStr.trim(),""!=this.currStr&&this.cobj.val.push(this.formatVal(this.currStr))),this.cobj.val.push(n.str),this.currStr=""):null!=this.currStr&&(this.currStr+=n.str),t=n.i}else if(";"==r||","==r||"\n"==r)this.finCurrStr();else if("]"==r)null!=this.currStr&&null!=this.cobj&&Array.isArray(this.cobj.val)&&(this.currStr=this.currStr.trim(),""!=this.currStr&&this.cobj.val.push(this.formatVal(this.currStr))),null!=this.cobj&&(this.cobj=this.finCurrObj(),this.cobj=this.finCurrObj()),this.currStr="";else if("["==r)2!=this.type?console.warn("没有key值，忽略掉一个数组"):(null!=this.cobj&&this.currArr.push(this.cobj),this.cobj={val:[]});else if(":"==r){if(null!=this.currStr&&1==this.type){if(this.type=2,null!=this.cobj&&this.currArr.push(this.cobj),null!=this.cobj&&Array.isArray(this.cobj.val)){var o=this.cobj;this.cobj={val:{}},o.val.push(this.cobj.val),this.currArr.push(this.cobj)}this.cobj={k:this.currStr.trim(),val:{}},this.currStr=""}}else null!=this.currStr&&(this.currStr+=r);t++}return this.ret}}var Gt;e.TextureCubeFace=void 0,(Gt=e.TextureCubeFace||(e.TextureCubeFace={}))[Gt.PositiveX=0]="PositiveX",Gt[Gt.NegativeX=1]="NegativeX",Gt[Gt.PositiveY=2]="PositiveY",Gt[Gt.NegativeY=3]="NegativeY",Gt[Gt.PositiveZ=4]="PositiveZ",Gt[Gt.NegativeZ=5]="NegativeZ";const Vt=new Uint8Array(4);class TextureCube extends BaseTexture{constructor(t,r,i=!0,a=!1,s=!1){super(t,t,r),this._dimension=e.TextureDimension.Cube,this._texture=LayaGL.textureContext.createTextureInternal(this._dimension,t,t,r,i,a,s)}static get blackTexture(){return TextureCube._blackTexture}static get grayTexture(){return TextureCube._grayTexture}static get whiteTexture(){return TextureCube._whiteTexture}static get errorTexture(){return TextureCube._errorTexture}static __init__(){var t=new TextureCube(1,e.TextureFormat.R8G8B8A8,!1),r=new TextureCube(1,e.TextureFormat.R8G8B8A8,!1),i=new TextureCube(1,e.TextureFormat.R8G8B8A8,!1),a=Vt;a[0]=0,a[1]=0,a[2]=0,a[3]=255,t.setPixelsData([a,a,a,a,a,a],!1,!1),t.lock=!0,a[0]=128,a[1]=128,a[2]=128,a[3]=255,r.setPixelsData([a,a,a,a,a,a],!1,!1),r.lock=!0,a[0]=255,a[1]=255,a[2]=255,a[3]=255,i.setPixelsData([a,a,a,a,a,a],!1,!1),i.lock=!0,TextureCube._grayTexture=r,TextureCube._blackTexture=t,TextureCube._whiteTexture=i,TextureCube._errorTexture=i}setImageData(e,t,r){let i=!1,a=e.findIndex((e=>null!=e));if(-1!=a){let t=e[a];e.every((e=>null!=e&&e.width==t.width&&e.height==t.height))||(i=!0)}else i=!0;let s=this._texture;if(i){let e=Vt;LayaGL.textureContext.setCubePixelsData(s,[e,e,e,e,e,e],t,r)}else LayaGL.textureContext.setCubeImageData(s,e,t,r)}setPixelsData(e,t,r){let i=this._texture;LayaGL.textureContext.setCubePixelsData(i,e,t,r)}updateSubPixelsData(e,t,r,i,a,s,n,o,l){let h=this._texture;LayaGL.textureContext.setCubeSubPixelData(h,e,s,n,t,r,i,a,o,l)}setDDSData(e){let t=this._texture;LayaGL.textureContext.setCubeDDSData(t,e)}setKTXData(e){let t=this._texture;LayaGL.textureContext.setCubeKTXData(t,e)}get defaultTexture(){return TextureCube.grayTexture}}const kt=["GLSL Start","GLSL End"],Ht=["#defineGLSL","#endGLSL"],Wt=["Shader3D Start","Shader3D End"],zt={Color:e.ShaderDataType.Color,Int:e.ShaderDataType.Int,Bool:e.ShaderDataType.Bool,Float:e.ShaderDataType.Float,Vector2:e.ShaderDataType.Vector2,Vector3:e.ShaderDataType.Vector3,Vector4:e.ShaderDataType.Vector4,Matrix4x4:e.ShaderDataType.Matrix4x4,Matrix3x3:e.ShaderDataType.Matrix3x3,Texture2D:e.ShaderDataType.Texture2D,TextureCube:e.ShaderDataType.TextureCube,Texture2DArray:e.ShaderDataType.Texture2DArray,Texture3D:e.ShaderDataType.Texture3D};class ShaderParser{static parse(e,t){let r=ShaderParser.getShaderBlock(e),i=ShaderParser.getCGBlock(e);return ShaderParser.bindCG(r,i),Shader3D.parse(r,t)}static compileToTree(e,t,r){if(r==e.length)return[t];let i=e[r],a=t.split(i);if(1==a.length)return a;let s=[];for(let t=0,n=a.length;t<n;t++)s=s.concat(ShaderParser.compileToTree(e,a[t],r+1)),t!=n-1&&s.push(i);return s}static getMapKey(e){let t=e.indexOf("\n");return e=(e=(e=e.slice(0,t).replace("\r","")).slice(0,t).replace(" ","")).trim()}static getShaderBlock(e){let t=null;try{let r=e.indexOf(Wt[0]);if(-1==r)throw new Error(`no '${Wt[0]}' tag`);let i=e.indexOf(Wt[1]);if(-1==i)throw new Error(`no '${Wt[1]}' tag`);let a=e.substring(r+Wt[0].length,i);t=ParseJSON.parse(a)}catch(t){console.error("Shader parse error: "+t+"\n"+e.substring(0,100)+"...")}return t}static getCGBlock(e){let t={};try{let r=e.indexOf(kt[0]);if(-1==r)throw new Error(`no '${Wt[0]}' tag`);let i=e.indexOf(kt[1]);if(-1==i)throw new Error(`no '${Wt[1]}' tag`);let a=e.substring(r,i),s=ShaderParser.compileToTree(Ht,a,0);for(let e=0,r=s.length;e<r;e++){if(s[e]==Ht[0]){e+=1;let r=s[e];t[ShaderParser.getMapKey(r)]=r.slice(r.indexOf("\n"),r.length-1)}}}catch(t){console.error("Shader parse error: "+t+"\n"+e.substring(0,100)+"...")}return t}static bindCG(e,t){let r=e.shaderPass;r&&r.forEach((e=>{e.VS&&(e.VS=t[e.VS]),e.FS&&(e.FS=t[e.FS])}));let i=e.attributeMap;if(i){let t=0;for(let r in i)if(i[r]instanceof Array){let t=i[r],a=ShaderParser.getShaderDataType(t[0]);if(null==a){console.warn(`${e.name}: unkown attribute type '${t[0]}'`);continue}i[r]=[t[1],a]}else{let a=ShaderParser.getShaderDataType(i[r]);if(null==a){console.warn(`${e.name}: unkown attribute type '${i[r]}'`);continue}i[r]=[t,a],t++}}let a=e.uniformMap;if(a){let t={};e.defaultValue=t;let r={};e.uniformMap=r;for(let i in a){let s=a[i];if(!1===s.serializable)continue;let n=ShaderParser.getShaderDataType(s.type);if(null!=n)if(null!=s.default&&(t[i]=ShaderParser.getDefaultData(n,s.default)),s.block){let e=r[s.block];e||(r[s.block]=e={}),e[i]=n}else r[i]=n;else console.warn(`${e.name}: unkown uniform type '${s.type}'`)}}}static getShaderDataType(e){return zt[e]}static getDefaultData(t,r){switch(t){case e.ShaderDataType.Int:case e.ShaderDataType.Float:case e.ShaderDataType.Bool:return r;case e.ShaderDataType.Vector2:return new Vector2(r[0],r[1]);case e.ShaderDataType.Vector3:return new Vector3(r[0],r[1],r[2]);case e.ShaderDataType.Vector4:return new Vector4(r[0],r[1],r[2],r[3]);case e.ShaderDataType.Color:return new Color(r[0],r[1],r[2],r[3]);case e.ShaderDataType.Matrix4x4:let t=new Matrix4x4;return t.cloneByArray(r),t;case e.ShaderDataType.Matrix3x3:let i=new Matrix3x3;return i.cloneByArray(r),i;case e.ShaderDataType.Texture2D:let a=null;return"white"==r?a=Texture2D.whiteTexture:"black"==r?a=Texture2D.blackTexture:"gray"==r?a=Texture2D.grayTexture:"normal"==r&&(a=Texture2D.normalTexture),a;case e.ShaderDataType.TextureCube:let s=TextureCube.grayTexture;return"white"==r?s=TextureCube.whiteTexture:"black"==r?s=TextureCube.blackTexture:"gray"==r&&(s=TextureCube.grayTexture),s}}}Loader.registerLoader(["shader","bps"],class{load(e){let t=e.url;return"bps"===e.ext&&(t=AssetDb.inst.getSubAssetURL(t,e.uuid,"0","shader")),e.loader.fetch(t,"text",e.progress.createCallback(),e.options).then((t=>{if(!t)return null;let r=ShaderParser.getShaderBlock(t),i=ShaderParser.getCGBlock(t);if(ShaderParser.bindCG(r,i),!r.name||!r.uniformMap)return null;let a=URL.getPath(e.url),s=r.shaderPass;return Promise.all(s.map((e=>ShaderCompile.compileAsync(e.VS,e.FS,a)))).then((t=>{var i;if(-1!=t.findIndex((e=>null==e)))return Loader.warn("some pass null "+e.url),null;let a=Shader3D.add(r.name,r.enableInstancing,r.supportReflectionProbe);a._surportVolumetricGI=r.surportVolumetricGI;let n=new SubShader(r.attributeMap?r.attributeMap:SubShader.DefaultAttributeMap,r.uniformMap,r.defaultValue);a.addSubShader(n);for(let e in s){let r=n._addShaderPass(t[e],s[e].pipeline);r.statefirst=null!==(i=s[e].statefirst)&&void 0!==i&&i,ShaderCompile.getRenderState(s[e].renderState,r.renderState)}return a}))}))}});Loader.registerLoader(["mp3","wav","ogg"],class{load(e){return e.loader.fetch(e.url,"arraybuffer",e.progress.createCallback(),e.options).then((e=>e?WebAudioSound.ctx.decodeAudioData(e):null))}},Loader.SOUND);let Xt=ClassUtils.regClass;Xt("Record",Object),Xt("Node",Node),Xt("Sprite",Sprite),Xt("Widget",Widget),Xt("Text",Text),Xt("Input",Input),Xt("AnimationBase",AnimationBase),Xt("Animation",Animation),Xt("FrameAnimation",FrameAnimation),Xt("EffectAnimation",EffectAnimation),Xt("SoundNode",SoundNode),Xt("VideoNode",VideoNode),Xt("Scene",Scene),Xt("Stage",Stage),Xt("Component",Component),Xt("Script",Script),Xt("BitmapFont",BitmapFont),Xt("BlurFilter",BlurFilter),Xt("ColorFilter",ColorFilter),Xt("GlowFilter",GlowFilter),Xt("Point",Point),Xt("Rectangle",Rectangle),Xt("Texture",Texture),Xt("Texture2D",Texture2D),Xt("Prefab",Prefab),Xt("Animator2D",Animator2D),Xt("AnimatorControllerLayer2D",AnimatorControllerLayer2D),Xt("AnimatorState2D",AnimatorState2D),Xt("AnimationClip2D",AnimationClip2D),Xt("AnimatorController2D",AnimatorController2D),Xt("Animation2DParm",Animation2DParm),Xt("Animation2DCondition",Animation2DCondition),Xt("Vector2",Vector2),Xt("Vector3",Vector3),Xt("Vector4",Vector4),Xt("Quaternion",Quaternion),Xt("Color",Color),Xt("Matrix",Matrix),Xt("Matrix3x3",Matrix3x3),Xt("Matrix4x4",Matrix4x4);class BlendState{constructor(e){this.blendType=0}static create(e,t,r){}}BlendState._blend_All_pool={},BlendState._blend_seperate_pool={};class BlendComponent{constructor(e,t,r,i){this._hashIndex=0,this._hashIndex=i,this._blendOperationGLData=e,this._sourceBlendFactor=t,this._destinationFactor=r}static getHash(e,t,r){return e+(t<<3)+(r<<7)}static getBlendComponent(e,t,r){let i=BlendComponent.getHash(e,t,r);return BlendComponent._pool[i]||(BlendComponent._pool[i]=new BlendComponent(e,t,r,i)),BlendComponent._pool[i]}}BlendComponent._pool={};class Buffer{constructor(e,t){this._byteLength=0,this._bufferType=e,this._bufferUsage=t}get bufferUsage(){return this._bufferUsage}destroy(){}}class VertexAttributeLayout{constructor(e){this.VAElements=new Array,this.attributeByteSize=new Array,this.instanceMode=new Array;for(let t=0;t<e.length;t++){let r=[],i=e[t].vertexDeclaration.vertexStride,a=e[t].vertexDeclaration._VAElements;for(let e=0;e<a.length;e++)r.push({format:a[e].format,stride:a[e].stride,shaderLocation:a[e].shaderLocation});this.attributeByteSize.push(i),this.VAElements.push(r),this.instanceMode.push(e[t].instanceBuffer)}this.id=VertexAttributeLayout.IPoint,VertexAttributeLayout._pool[VertexAttributeLayout.IPoint++]=this}static getVertexLayoutByPool(e){let t=VertexAttributeLayout._pool;for(var r in t){let i=t[r];if(i.deepthEqaul(e))return i}return new VertexAttributeLayout(e)}deepthEqaul(e){if(e.length!=this.VAElements.length)return!1;for(var t=0;t<e.length;t++){let a=e[t]._vertexDeclaration._VAElements,s=this.VAElements[t];if(a.length!=s.length)return!1;for(var r=0,i=a.length;r<i;r++){let e=a[r],t=s[r];if(e.format!=t.format||e.stride!=t.stride||e.shaderLocation!=t.shaderLocation)return!1}}return!0}}VertexAttributeLayout.IPoint=0,VertexAttributeLayout._pool={};class EffectBase extends Component{constructor(){super(...arguments),this.duration=1e3,this.delay=0,this.repeat=0,this.autoDestroyAtComplete=!0}_onAwake(){this.target=this.target||this.owner,this.autoDestroyAtComplete&&(this._comlete=Handler.create(this.target,this.target.destroy,null,!1)),this.eventName?this.owner.on(this.eventName,this,this._exeTween):this._exeTween()}_exeTween(){this._tween=this._doTween(),this._tween.repeat=this.repeat}_doTween(){return null}onReset(){this.duration=1e3,this.delay=0,this.repeat=0,this.ease=null,this.target=null,this.eventName&&(this.owner.off(this.eventName,this,this._exeTween),this.eventName=null),this._comlete&&(this._comlete.recover(),this._comlete=null),this._tween&&(this._tween.clear(),this._tween=null)}}class KeyLocation{}KeyLocation.STANDARD=0,KeyLocation.LEFT=1,KeyLocation.RIGHT=2,KeyLocation.NUM_PAD=3;class Keyboard{}Keyboard.NUMBER_0=48,Keyboard.NUMBER_1=49,Keyboard.NUMBER_2=50,Keyboard.NUMBER_3=51,Keyboard.NUMBER_4=52,Keyboard.NUMBER_5=53,Keyboard.NUMBER_6=54,Keyboard.NUMBER_7=55,Keyboard.NUMBER_8=56,Keyboard.NUMBER_9=57,Keyboard.A=65,Keyboard.B=66,Keyboard.C=67,Keyboard.D=68,Keyboard.E=69,Keyboard.F=70,Keyboard.G=71,Keyboard.H=72,Keyboard.I=73,Keyboard.J=74,Keyboard.K=75,Keyboard.L=76,Keyboard.M=77,Keyboard.N=78,Keyboard.O=79,Keyboard.P=80,Keyboard.Q=81,Keyboard.R=82,Keyboard.S=83,Keyboard.T=84,Keyboard.U=85,Keyboard.V=86,Keyboard.W=87,Keyboard.X=88,Keyboard.Y=89,Keyboard.Z=90,Keyboard.F1=112,Keyboard.F2=113,Keyboard.F3=114,Keyboard.F4=115,Keyboard.F5=116,Keyboard.F6=117,Keyboard.F7=118,Keyboard.F8=119,Keyboard.F9=120,Keyboard.F10=121,Keyboard.F11=122,Keyboard.F12=123,Keyboard.F13=124,Keyboard.F14=125,Keyboard.F15=126,Keyboard.NUMPAD=21,Keyboard.NUMPAD_0=96,Keyboard.NUMPAD_1=97,Keyboard.NUMPAD_2=98,Keyboard.NUMPAD_3=99,Keyboard.NUMPAD_4=100,Keyboard.NUMPAD_5=101,Keyboard.NUMPAD_6=102,Keyboard.NUMPAD_7=103,Keyboard.NUMPAD_8=104,Keyboard.NUMPAD_9=105,Keyboard.NUMPAD_ADD=107,Keyboard.NUMPAD_DECIMAL=110,Keyboard.NUMPAD_DIVIDE=111,Keyboard.NUMPAD_ENTER=108,Keyboard.NUMPAD_MULTIPLY=106,Keyboard.NUMPAD_SUBTRACT=109,Keyboard.SEMICOLON=186,Keyboard.EQUAL=187,Keyboard.COMMA=188,Keyboard.MINUS=189,Keyboard.PERIOD=190,Keyboard.SLASH=191,Keyboard.BACKQUOTE=192,Keyboard.LEFTBRACKET=219,Keyboard.BACKSLASH=220,Keyboard.RIGHTBRACKET=221,Keyboard.QUOTE=222,Keyboard.ALTERNATE=18,Keyboard.BACKSPACE=8,Keyboard.CAPS_LOCK=20,Keyboard.COMMAND=15,Keyboard.CONTROL=17,Keyboard.DELETE=46,Keyboard.ENTER=13,Keyboard.ESCAPE=27,Keyboard.PAGE_UP=33,Keyboard.PAGE_DOWN=34,Keyboard.END=35,Keyboard.HOME=36,Keyboard.LEFT=37,Keyboard.UP=38,Keyboard.RIGHT=39,Keyboard.DOWN=40,Keyboard.SHIFT=16,Keyboard.SPACE=32,Keyboard.TAB=9,Keyboard.INSERT=45;class QuickTestTool{constructor(){}static getMCDName(e){return QuickTestTool._typeToNameDic[e]}static showRenderTypeInfo(e,t=!1){if(t||!QuickTestTool.showedDic[e]){if(QuickTestTool.showedDic[e]=!0,!QuickTestTool._rendertypeToStrDic[e]){var r,i=[];for(r=1;r<=e;)r&e&&i.push(QuickTestTool.getMCDName(r&e)),r<<=1;QuickTestTool._rendertypeToStrDic[e]=i.join(",")}console.log("cmd:",QuickTestTool._rendertypeToStrDic[e])}}static __init__(){QuickTestTool._typeToNameDic[SpriteConst.ALPHA]="ALPHA",QuickTestTool._typeToNameDic[SpriteConst.TRANSFORM]="TRANSFORM",QuickTestTool._typeToNameDic[SpriteConst.TEXTURE]="TEXTURE",QuickTestTool._typeToNameDic[SpriteConst.GRAPHICS]="GRAPHICS",QuickTestTool._typeToNameDic[SpriteConst.CHILDS]="CHILDS",QuickTestTool._typeToNameDic[SpriteConst.TRANSFORM|SpriteConst.ALPHA]="TRANSFORM|ALPHA",QuickTestTool._typeToNameDic[SpriteConst.CANVAS]="CANVAS",QuickTestTool._typeToNameDic[SpriteConst.BLEND]="BLEND",QuickTestTool._typeToNameDic[SpriteConst.FILTERS]="FILTERS",QuickTestTool._typeToNameDic[SpriteConst.MASK]="MASK",QuickTestTool._typeToNameDic[SpriteConst.CLIP]="CLIP",QuickTestTool._typeToNameDic[SpriteConst.LAYAGL3D]="LAYAGL3D"}render(e,t,r){QuickTestTool._addType(this._renderType),QuickTestTool.showRenderTypeInfo(this._renderType),RenderSprite.renders[this._renderType]._fun(this,e,t+this._x,r+this._y),this._repaint=0}_stageRender(e,t,r){QuickTestTool._countStart(),QuickTestTool._PreStageRender.call(ILaya.stage,e,t,r),QuickTestTool._countEnd()}static _countStart(){var e;for(e in QuickTestTool._countDic)QuickTestTool._countDic[e]=0}static _countEnd(){QuickTestTool._i++,QuickTestTool._i>60&&(QuickTestTool.showCountInfo(),QuickTestTool._i=0)}static _addType(e){QuickTestTool._countDic[e]?QuickTestTool._countDic[e]+=1:QuickTestTool._countDic[e]=1}static showCountInfo(){var e;for(e in console.log("==================="),QuickTestTool._countDic)console.log("count:"+QuickTestTool._countDic[e]),QuickTestTool.showRenderTypeInfo(e,!0)}static enableQuickTest(){QuickTestTool.__init__(),Sprite.prototype.render=QuickTestTool.prototype.render,QuickTestTool._PreStageRender=Stage.prototype.render,Stage.prototype.render=QuickTestTool.prototype._stageRender}}QuickTestTool.showedDic={},QuickTestTool._rendertypeToStrDic={},QuickTestTool._typeToNameDic={},QuickTestTool._countDic={},QuickTestTool._i=0;var Yt,jt,Kt,qt,Qt,$t;e.RenderClearFlag=void 0,(Yt=e.RenderClearFlag||(e.RenderClearFlag={}))[Yt.Nothing=0]="Nothing",Yt[Yt.Color=1]="Color",Yt[Yt.Depth=2]="Depth",Yt[Yt.Stencil=4]="Stencil",e.RenderDrawMode=void 0,(jt=e.RenderDrawMode||(e.RenderDrawMode={}))[jt.TRIANGLES=0]="TRIANGLES",jt[jt.POINTS=1]="POINTS",jt[jt.LINES=2]="LINES",e.RenderIndexMode=void 0,(Kt=e.RenderIndexMode||(e.RenderIndexMode={}))[Kt.UNSIGNED_BYTE=0]="UNSIGNED_BYTE",Kt[Kt.UNSIGNED_SHORT=1]="UNSIGNED_SHORT",Kt[Kt.UNSIGNED_INT=2]="UNSIGNED_INT",e.RenderStateType=void 0,(qt=e.RenderStateType||(e.RenderStateType={}))[qt.DepthTest=0]="DepthTest",qt[qt.DepthMask=1]="DepthMask",qt[qt.DepthFunc=2]="DepthFunc",qt[qt.StencilTest=3]="StencilTest",qt[qt.StencilMask=4]="StencilMask",qt[qt.StencilFunc=5]="StencilFunc",qt[qt.StencilOp=6]="StencilOp",qt[qt.BlendType=7]="BlendType",qt[qt.BlendEquation=8]="BlendEquation",qt[qt.BlendEquationSeparate=9]="BlendEquationSeparate",qt[qt.BlendFunc=10]="BlendFunc",qt[qt.BlendFuncSeperate=11]="BlendFuncSeperate",qt[qt.CullFace=12]="CullFace",qt[qt.FrontFace=13]="FrontFace",e.TextureCompareMode=void 0,(Qt=e.TextureCompareMode||(e.TextureCompareMode={}))[Qt.None=0]="None",Qt[Qt.LEQUAL=1]="LEQUAL",Qt[Qt.GEQUAL=2]="GEQUAL",Qt[Qt.LESS=3]="LESS",Qt[Qt.GREATER=4]="GREATER",Qt[Qt.EQUAL=5]="EQUAL",Qt[Qt.NOTEQUAL=6]="NOTEQUAL",Qt[Qt.ALWAYS=7]="ALWAYS",Qt[Qt.NEVER=8]="NEVER",e.TextureDecodeFormat=void 0,($t=e.TextureDecodeFormat||(e.TextureDecodeFormat={}))[$t.Normal=0]="Normal",$t[$t.RGBM=1]="RGBM";class GLSLCodeGenerator{static glslAttributeString(e){let t="";for(const r in e){let i=getAttributeType(e[r][1]);""!=i&&(t=`${t}attribute ${i} ${r};\n`)}return t}static glslUniformString(e,t){if(t){let t="",r="";for(const i in e)if("object"==typeof e[i]){let r=e[i];t+=`uniform ${i} {\n`;for(const e in r){let i=getAttributeType(r[e]);""!=i&&(t+=`${i} ${e};\n`)}t+="};\n"}else{let t=getAttributeType(e[i]);""!=t&&(r+=`uniform ${t} ${i};\n`)}return t+r}{let t="";for(const r in e)if("object"==typeof e[r]){let i=e[r];for(const e in i){let r=getAttributeType(i[e]);""!=r&&(t+=`uniform ${r} ${e};\n`)}}else{let i=getAttributeType(e[r]);""!=i&&(t+=`uniform ${i} ${r};\n`)}return t}}static GLShaderLanguageProcess3D(t,r,i,a,s){var n,o,l=Config3D.lightClusterCount,h={},d="";let u=Config3D._uniformBlock,c=GLSLCodeGenerator.glslAttributeString(r),_=GLSLCodeGenerator.glslUniformString(i,u);LayaGL.renderEngine.getParams(e.RenderParams.SHADER_CAPAILITY_LEVEL)>30?(t.push("GRAPHICS_API_GLES3"),n=`#version 300 es\n#if defined(GL_FRAGMENT_PRECISION_HIGH)\n    precision highp float;\n    precision highp int;\n    precision highp sampler2DArray;\n    precision highp sampler3D;\n#else\n    precision mediump float;\n    precision mediump int;\n    precision mediump sampler2DArray;\n    precision mediump sampler3D;\n#endif\nlayout(std140, column_major) uniform;\n#define attribute in\n#define varying out\n#define textureCube texture\n#define texture2D texture\n${c}\n${_}\n`,o=`#version 300 es\n#if defined(GL_FRAGMENT_PRECISION_HIGH)\n    precision highp float;\n    precision highp int;\n    precision highp sampler2DArray;\n\tprecision highp sampler3D;\n#else\n    precision mediump float;\n    precision mediump int;\n    precision mediump sampler2DArray;\n\tprecision mediump sampler3D;\n#endif\nlayout(std140, column_major) uniform;\n#define varying in\nout highp vec4 pc_fragColor;\n#define gl_FragColor pc_fragColor\n#define gl_FragDepthEXT gl_FragDepth\n#define texture2D texture\n#define textureCube texture\n#define texture2DProj textureProj\n#define texture2DLodEXT textureLod\n#define texture2DProjLodEXT textureProjLod\n#define textureCubeLodEXT textureLod\n#define texture2DGradEXT textureGrad\n#define texture2DProjGradEXT textureProjGrad\n#define textureCubeGradEXT textureGrad\n${_}`):(n=`#if defined(GL_FRAGMENT_PRECISION_HIGH)\n    precision highp float;\n    precision highp int;\n#else\n    precision mediump float;\n    precision mediump int;\n#endif\n${c}\n${_}`,o=`#ifdef GL_EXT_shader_texture_lod\n    #extension GL_EXT_shader_texture_lod : enable\n#endif\n\n#ifdef GL_OES_standard_derivatives\n\t#extension GL_OES_standard_derivatives : enable \n#endif\n\n#if defined(GL_FRAGMENT_PRECISION_HIGH)\n    precision highp float;\n    precision highp int;\n#else\n    precision mediump float;\n    precision mediump int;\n#endif\n\n#if !defined(GL_EXT_shader_texture_lod)\n    #define texture1DLodEXT texture1D\n    #define texture2DLodEXT texture2D\n    #define texture2DProjLodEXT texture2DProj\n    #define texture3DLodEXT texture3D\n    #define textureCubeLodEXT textureCube\n#endif\n${_}`),d+="#define MAX_LIGHT_COUNT "+Config3D.maxLightCount+"\n",d+="#define MAX_LIGHT_COUNT_PER_CLUSTER "+Config3D._maxAreaLightCountPerClusterAverage+"\n",d+="#define CLUSTER_X_COUNT "+l.x+"\n",d+="#define CLUSTER_Y_COUNT "+l.y+"\n",d+="#define CLUSTER_Z_COUNT "+l.z+"\n",d+="#define MORPH_MAX_COUNT "+Config3D.maxMorphTargetCount+"\n",d+="#define SHADER_CAPAILITY_LEVEL "+LayaGL.renderEngine.getParams(e.RenderParams.SHADER_CAPAILITY_LEVEL)+"\n";for(var p=0,g=t.length;p<g;p++){var m=t[p];d+="#define "+m+"\n",h[m]=!0}var f=a.toscript(h,[]),S="";0==f[0].indexOf("#version")&&(S=f[0]+"\n",f.shift());var y=s.toscript(h,[]),T="";return 0==y[0].indexOf("#version")&&(T=y[0]+"\n",y.shift()),{vs:S+n+d+f.join("\n"),fs:T+o+d+y.join("\n")}}}function getAttributeType(t){switch(t){case e.ShaderDataType.Int:return"int";case e.ShaderDataType.Bool:return"bool";case e.ShaderDataType.Float:return"float";case e.ShaderDataType.Vector2:return"vec2";case e.ShaderDataType.Vector3:return"vec3";case e.ShaderDataType.Vector4:case e.ShaderDataType.Color:return"vec4";case e.ShaderDataType.Matrix4x4:return"mat4";case e.ShaderDataType.Matrix3x3:return"mat3";case e.ShaderDataType.Texture2D:return"sampler2D";case e.ShaderDataType.TextureCube:return"samplerCube";case e.ShaderDataType.Texture2DArray:return LayaGL.renderEngine.getCapable(e.RenderCapable.Texture3D)?"sampler2DArray":"";case e.ShaderDataType.Texture3D:return LayaGL.renderEngine.getCapable(e.RenderCapable.Texture3D)?"sampler3D":"";default:return""}}class ShaderVariable{constructor(){this.onID=ShaderVariable.pointID++,this.textureID=-1}}ShaderVariable.pointID=0;class Viewport{constructor(e,t,r,i){this.minDepth=0,this.maxDepth=1,this.x=null!=e?e:0,this.y=null!=t?t:0,this.width=null!=r?r:0,this.height=null!=i?i:0}project(e,t,r){Vector3.transformV3ToV4(e,t,r);var i=r.x,a=r.y,s=r.z,n=r.w;1!==n&&(i/=n,a/=n,s/=n),r.x=.5*(i+1)*this.width+this.x,r.y=.5*(1-a)*this.height+this.y,r.z=s*(this.maxDepth-this.minDepth)+this.minDepth}unprojectFromMat(e,t,r){var i=t.elements;r.x=(e.x-this.x)/this.width*2-1,r.y=-((e.y-this.y)/this.height*2-1),r.z=(e.z-this.minDepth)/(this.maxDepth-this.minDepth);var a=r.x*i[3]+r.y*i[7]+r.z*i[11]+i[15];Vector3.transformV3ToV3(r,t,r),1!==a&&(r.x=r.x/a,r.y=r.y/a,r.z=r.z/a)}unprojectFromWVP(e,t,r,i,a){Matrix4x4.multiply(t,r,Viewport._tempMatrix4x4),i&&Matrix4x4.multiply(Viewport._tempMatrix4x4,i,Viewport._tempMatrix4x4),Viewport._tempMatrix4x4.invert(Viewport._tempMatrix4x4),this.unprojectFromMat(e,Viewport._tempMatrix4x4,a)}set(e,t,r,i){this.x=e,this.y=t,this.width=r,this.height=i}cloneTo(e){e.x=this.x,e.y=this.y,e.width=this.width,e.height=this.height,e.minDepth=this.minDepth,e.maxDepth=this.maxDepth}}Viewport._tempMatrix4x4=new Matrix4x4,Viewport._tempViewport=new Viewport(0,0,0,0);class Texture2DArray extends BaseTexture{constructor(t,r,i,a,s=!0,n,o=!1){super(t,r,a),this._dimension=e.TextureDimension.Texture2DArray,this._gammaSpace=o,this.depth=i;let l=LayaGL.textureContext;this._texture=l.createTexture3DInternal(this._dimension,t,r,i,a,s,o,!1)}static get defaultTexture(){return this._defaultTexture}static __init__(){LayaGL.renderEngine.getCapable(e.RenderCapable.Texture3D)&&(this._defaultTexture=new Texture2DArray(1,1,1,e.TextureFormat.R8G8B8A8,!1,!1,!1),this._defaultTexture.lock=!0,this._defaultTexture.setPixelsData(new Uint8Array([255,255,255,255]),!1,!1))}setImageData(e,t,r){let i=this._texture;LayaGL.textureContext.setTexture3DImageData(i,e,this.depth,t,r)}setPixelsData(e,t,r){let i=this._texture;LayaGL.textureContext.setTexture3DPixelsData(i,e,this.depth,t,r)}setSubPixelsData(e,t,r,i,a,s,n,o,l,h,d){let u=this._texture;LayaGL.textureContext.setTexture3DSubPixelsData(u,n,o,l,e,t,r,i,a,s,h,d)}}class Texture3D extends BaseTexture{constructor(t,r,i,a,s=!0,n=!1){super(t,r,a),this._dimension=e.TextureDimension.Tex3D,this.depth=i,this._gammaSpace=n;let o=LayaGL.textureContext;this._texture=o.createTexture3DInternal(this._dimension,t,r,i,a,s,n,!1)}static get defaultTexture(){return this._defaultTexture}static __init__(){LayaGL.renderEngine.getCapable(e.RenderCapable.Texture3D)&&(this._defaultTexture=new Texture3D(1,1,1,e.TextureFormat.R8G8B8A8,!1,!1),this._defaultTexture.lock=!0,this._defaultTexture.setPixelsData(new Uint8Array([255,255,255,255])))}setPixelsData(e){let t=this._texture;LayaGL.textureContext.setTexture3DPixelsData(t,e,this.depth,!1,!1)}setSubPixelsData(e,t,r,i,a,s,n,o,l){let h=this._texture;LayaGL.textureContext.setTexture3DSubPixelsData(h,n,o,l,e,t,r,i,a,s,!1,!1)}}class WebGLRTMgr{static getRT(t,r){return r|=0,(t|=0)>=1e4&&console.error("getRT error! w too big"),new RenderTexture2D(t,r,e.RenderTargetFormat.R8G8B8A8,e.RenderTargetFormat.None)}static releaseRT(e){e.destroy()}}WebGLRTMgr.dict={};class PerfTools{static begin(e){}static end(e){}}class PerformanceDefine{}function PERF_BEGIN(e){PerfTools.begin(e)}function PERF_END(e){PerfTools.end(e)}function PERF_FRAMECLEAR(){}window.PerformanceDefine=PerformanceDefine,window.PERF_BEGIN=PERF_BEGIN,window.PERF_BEGIN=PERF_END,window.PERF_FRAMECLEAR=PERF_FRAMECLEAR;class Base64Tool{static init(){if(!Base64Tool.lookup){Base64Tool.lookup=new Uint8Array(256);for(var e=0;e<Base64Tool.chars.length;e++)Base64Tool.lookup[Base64Tool.chars.charCodeAt(e)]=e}}static isBase64String(e){return Base64Tool.reg.test(e)}static encode(e){var t,r=new Uint8Array(e),i=r.length,a="";for(t=0;t<i;t+=3)a+=Base64Tool.chars[r[t]>>2],a+=Base64Tool.chars[(3&r[t])<<4|r[t+1]>>4],a+=Base64Tool.chars[(15&r[t+1])<<2|r[t+2]>>6],a+=Base64Tool.chars[63&r[t+2]];return i%3==2?a=a.substring(0,a.length-1)+"=":i%3==1&&(a=a.substring(0,a.length-2)+"=="),a}static decode(e){Base64Tool.init();var t,r,i,a,s,n=.75*e.length,o=e.length,l=0;"="===e[e.length-1]&&(n--,"="===e[e.length-2]&&n--);var h=new ArrayBuffer(n),d=new Uint8Array(h);for(t=0;t<o;t+=4)r=Base64Tool.lookup[e.charCodeAt(t)],i=Base64Tool.lookup[e.charCodeAt(t+1)],a=Base64Tool.lookup[e.charCodeAt(t+2)],s=Base64Tool.lookup[e.charCodeAt(t+3)],l+1>n||(d[l++]=r<<2|i>>4,l+1>n||(d[l++]=(15&i)<<4|a>>2,l+1>n||(d[l++]=(3&a)<<6|63&s)));return h}}Base64Tool.chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Base64Tool.reg=/^\s*data:([a-z]+\/[a-z0-9-+.]+(;[a-z-]+=[a-z0-9-]+)?)?(;base64)?,([a-z0-9!$&',()*+;=\-._~:@\/?%\s]*?)\s*$/i,Base64Tool.reghead=/^\s*data:([a-z]+\/[a-z0-9-+.]+(;[a-z-]+=[a-z0-9-]+)?)?(;base64)?,/i,Base64Tool.lookup=null,ArrayBuffer.prototype.slice||(ArrayBuffer.prototype.slice=function(e,t){var r=new Uint8Array(this,e,t-e),i=new Uint8Array(r.length);return i.set(r),i.buffer}),Float32Array.prototype.slice||(Float32Array.prototype.slice=function(){for(var e=this.length,t=new Float32Array(this.length),r=0;r<e;r++)t[r]=this[r];return t}),Uint16Array.prototype.slice||(Uint16Array.prototype.slice=function(...e){var t,r,i;if(0===e.length)for(t=this.length,r=new Uint16Array(t),i=0;i<t;i++)r[i]=this[i];else if(2===e.length){var a=e[0],s=e[1];if(s>a)for(t=s-a,r=new Uint16Array(t),i=a;i<s;i++)r[i-a]=this[i];else r=new Uint16Array(0)}return r}),Uint8Array.prototype.slice||(Uint8Array.prototype.slice=function(){for(var e=this.length,t=new Uint8Array(this.length),r=0;r<e;r++)t[r]=this[r];return t});class Log{static enable(){Log._logdiv||(Log._logdiv=Browser.createElement("div"),Log._logdiv.style.cssText="border:white;padding:4px;overflow-y:auto;z-index:1000000;background:rgba(100,100,100,0.6);color:white;position: absolute;left:0px;top:0px;width:50%;height:50%;",Browser.document.body.appendChild(Log._logdiv),Log._btn=Browser.createElement("button"),Log._btn.innerText="Hide",Log._btn.style.cssText="z-index:1000001;position: absolute;left:10px;top:10px;",Log._btn.onclick=Log.toggle,Browser.document.body.appendChild(Log._btn))}static toggle(){var e=Log._logdiv.style;""===e.display?(Log._btn.innerText="Show",e.display="none"):(Log._btn.innerText="Hide",e.display="")}static print(e){Log._logdiv&&(Log._count>=Log.maxCount&&Log.clear(),Log._count++,Log._logdiv.innerText+=e+"\n",Log.autoScrollToBottom&&Log._logdiv.scrollHeight-Log._logdiv.scrollTop-Log._logdiv.clientHeight<50&&(Log._logdiv.scrollTop=Log._logdiv.scrollHeight))}static clear(){Log._logdiv.innerText="",Log._count=0}}Log._count=0,Log.maxCount=50,Log.autoScrollToBottom=!0;class PerfData{constructor(e,t,r,i){this.scale=1,this.datas=new Array(300),this.datapos=0,this.id=e,this.color=t,this.name=r,this.scale=i}addData(e){this.datas[this.datapos]=e,this.datapos++,this.datapos%=300}}class PerfHUD extends Sprite{constructor(){super(),this.datas=[],this.xdata=new Array(PerfHUD.DATANUM),this.ydata=new Array(PerfHUD.DATANUM),this.hud_width=800,this.hud_height=200,this.gMinV=0,this.gMaxV=100,this.textSpace=40,this.sttm=0,PerfHUD.inst=this,this._renderType|=SpriteConst.CUSTOM,this._setCustomRender(),this.addDataDef(0,16777215,"frame",1),this.addDataDef(1,65280,"update",1),this.addDataDef(2,16711680,"flush",1),PerfHUD._now=performance?performance.now.bind(performance):Date.now}now(){return PerfHUD._now()}start(){this.sttm=PerfHUD._now()}end(e){var t=PerfHUD._now()-this.sttm;this.updateValue(e,t)}config(e,t){this.hud_width=e,this.hud_height=t}addDataDef(e,t,r,i){this.datas[e]=new PerfData(e,t,r,i)}updateValue(e,t){this.datas[e].addData(t)}v2y(e){return this._y,this.hud_height,this.gMinV,this.gMaxV,this._y+this.hud_height*(1-(e-this.gMinV)/this.gMaxV)}drawHLine(e,t,r,i){var a=this._x;this._x,this.hud_width;var s=this.v2y(t);e.fillText(i,a,s-6,null,"green",null),a+=this.textSpace,e.fillStyle=r,e.fillRect(a,s,this._x+this.hud_width,1,null)}customRender(e,t,r){var i=performance.now();PerfHUD._lastTm<=0&&(PerfHUD._lastTm=i),this.updateValue(0,i-PerfHUD._lastTm),PerfHUD._lastTm=i,e.save(),e.fillRect(this._x,this._y,this.hud_width,this.hud_height+4,"#000000cc"),e.globalAlpha=.9,this.drawHLine(e,0,"green","    0"),this.drawHLine(e,10,"green","  10"),this.drawHLine(e,16.667,"red"," "),this.drawHLine(e,20,"green","50|20"),this.drawHLine(e,33.334,"yellow",""),this.drawHLine(e,16.667*3,"yellow",""),this.drawHLine(e,66.668,"yellow",""),this.drawHLine(e,50,"green","20|50"),this.drawHLine(e,100,"green","10|100");for(var a=0,s=this.datas.length;a<s;a++){var n=this.datas[a];if(n){var o=n.datas.length,l=(this.hud_width-this.textSpace)/o,h=n.datapos,d=this._x+this.textSpace;e.fillStyle=n.color;for(var u=o;h<u;h++){var c=this.v2y(n.datas[h]*n.scale);e.fillRect(d,c,l,this.hud_height+this._y-c,null),d+=l}for(h=0;h<n.datapos;h++)c=this.v2y(n.datas[h]*n.scale),e.fillRect(d,c,l,this.hud_height+this._y-c,null),d+=l}}e.restore()}}PerfHUD._lastTm=0,PerfHUD._now=null,PerfHUD.DATANUM=300,PerfHUD.drawTexTm=0;class PoolCache{constructor(){this.maxCount=1e3}getCacheList(){return Pool.getPoolBySign(this.sign)}tryDispose(e){var t;(t=Pool.getPoolBySign(this.sign)).length>this.maxCount&&t.splice(this.maxCount,t.length-this.maxCount)}static addPoolCacheManager(e,t=100){var r;(r=new PoolCache).sign=e,r.maxCount=t,CacheManger.regCacheByFunction(r.tryDispose.bind(r),r.getCacheList.bind(r))}}class TimeLine extends EventDispatcher{constructor(){super(...arguments),this._tweenDic={},this._tweenDataList=[],this._currTime=0,this._lastTime=0,this._startTime=0,this._index=0,this._gidIndex=0,this._firstTweenDic={},this._startTimeSort=!1,this._endTimeSort=!1,this._loopKey=!1,this.scale=1,this._frameRate=60,this._frameIndex=0,this._total=0}static to(e,t,r,i=null,a=0){return(new TimeLine).to(e,t,r,i,a)}static from(e,t,r,i=null,a=0){return(new TimeLine).from(e,t,r,i,a)}to(e,t,r,i=null,a=0){return this._create(e,t,r,i,a,!0)}from(e,t,r,i=null,a=0){return this._create(e,t,r,i,a,!1)}_create(e,t,r,i,a,s){var n=Pool.getItemByClass("tweenData",tweenData);return n.isTo=s,n.type=0,n.target=e,n.duration=r,n.data=t,n.startTime=this._startTime+a,n.endTime=n.startTime+n.duration,n.ease=i,this._startTime=Math.max(n.endTime,this._startTime),this._tweenDataList.push(n),this._startTimeSort=!0,this._endTimeSort=!0,this}addLabel(e,t){var r=Pool.getItemByClass("tweenData",tweenData);return r.type=1,r.data=e,r.endTime=r.startTime=this._startTime+t,this._labelDic||(this._labelDic={}),this._labelDic[e]=r,this._tweenDataList.push(r),this}removeLabel(e){if(this._labelDic&&this._labelDic[e]){var t=this._labelDic[e];if(t){var r=this._tweenDataList.indexOf(t);r>-1&&this._tweenDataList.splice(r,1)}delete this._labelDic[e]}}gotoTime(e){if(null!=this._tweenDataList&&0!=this._tweenDataList.length){var t,r,i,a;for(var s in this._firstTweenDic)if(r=this._firstTweenDic[s])for(var n in r)n in r.diyTarget&&(r.diyTarget[n]=r[n]);for(s in this._tweenDic)(t=this._tweenDic[s]).clear(),delete this._tweenDic[s];if(this._index=0,this._gidIndex=0,this._currTime=e,this._lastTime=Browser.now(),null==this._endTweenDataList||this._endTimeSort){function Compare(e,t){return e.endTime>t.endTime?1:e.endTime<t.endTime?-1:0}this._endTimeSort=!1,this._endTweenDataList=i=this._tweenDataList.concat(),i.sort(Compare)}else i=this._endTweenDataList;for(var o=0,l=i.length;o<l;o++)if(0==(a=i[o]).type){if(!(e>=a.endTime))break;this._index=Math.max(this._index,o+1);var h=a.data;if(a.isTo)for(var d in h)a.target[d]=h[d]}for(o=0,l=this._tweenDataList.length;o<l;o++)0==(a=this._tweenDataList[o]).type&&e>=a.startTime&&e<a.endTime&&(this._index=Math.max(this._index,o+1),this._gidIndex++,(t=Pool.getItemByClass("tween",Tween))._create(a.target,a.data,a.duration,a.ease,Handler.create(this,this._animComplete,[this._gidIndex]),0,!1,a.isTo,!0,!1),t.setStartTime(this._currTime-(e-a.startTime)),t._updateEase(this._currTime),t.gid=this._gidIndex,this._tweenDic[this._gidIndex]=t)}}gotoLabel(e){if(null!=this._labelDic){var t=this._labelDic[e];t&&this.gotoTime(t.startTime)}}pause(){ILaya.timer.clear(this,this._update)}resume(){this.play(this._currTime,this._loopKey)}play(e=0,t=!1){if(this._tweenDataList){if(this._startTimeSort){function Compare(e,t){return e.startTime>t.startTime?1:e.startTime<t.startTime?-1:0}this._startTimeSort=!1,this._tweenDataList.sort(Compare);for(var r=0,i=this._tweenDataList.length;r<i;r++){var a=this._tweenDataList[r];if(null!=a&&0==a.type){var s=a.target,n=s.$_GID||(s.$_GID=Utils.getGID()),o=null;for(var l in null==this._firstTweenDic[n]?((o={}).diyTarget=s,this._firstTweenDic[n]=o):o=this._firstTweenDic[n],a.data)null==o[l]&&(o[l]=s[l])}}}"string"==typeof e?this.gotoLabel(e):this.gotoTime(e),this._loopKey=t,this._lastTime=Browser.now(),ILaya.timer.frameLoop(1,this,this._update)}}_update(){if(this._currTime>=this._startTime){if(!this._loopKey){for(var e in this._tweenDic)(t=this._tweenDic[e]).complete();return this.pause(),void this._complete()}if(this._complete(),!this._tweenDataList)return;this.gotoTime(0)}var t,r=Browser.now(),i=r-this._lastTime,a=this._currTime+=i*this.scale;for(e in this._lastTime=r,this._tweenDic)(t=this._tweenDic[e])._updateEase(a);if(0!=this._tweenDataList.length&&this._index<this._tweenDataList.length){var s=this._tweenDataList[this._index];a>=s.startTime&&(this._index++,0==s.type?(this._gidIndex++,(t=Pool.getItemByClass("tween",Tween))._create(s.target,s.data,s.duration,s.ease,Handler.create(this,this._animComplete,[this._gidIndex]),0,!1,s.isTo,!0,!1),t.setStartTime(a),t.gid=this._gidIndex,this._tweenDic[this._gidIndex]=t,t._updateEase(a)):this.event(Event.LABEL,s.data))}}_animComplete(e){this._tweenDic[e]&&delete this._tweenDic[e]}_complete(){this.event(Event.COMPLETE)}get index(){return this._frameIndex}set index(e){this._frameIndex=e,this.gotoTime(this._frameIndex/this._frameRate*1e3)}get total(){return this._total=Math.floor(this._startTime/1e3*this._frameRate),this._total}reset(){var e,t,r;if(this._labelDic)for(e in this._labelDic)delete this._labelDic[e];for(e in this._tweenDic)this._tweenDic[e].clear(),delete this._tweenDic[e];for(e in this._firstTweenDic)delete this._firstTweenDic[e];if(this._endTweenDataList=null,this._tweenDataList&&this._tweenDataList.length)for(r=this._tweenDataList.length,t=0;t<r;t++)this._tweenDataList[t]&&this._tweenDataList[t].destroy();this._tweenDataList.length=0,this._currTime=0,this._lastTime=0,this._startTime=0,this._index=0,this._gidIndex=0,this.scale=1,ILaya.timer.clear(this,this._update)}destroy(){this.reset(),this._labelDic=null,this._tweenDic=null,this._tweenDataList=null,this._firstTweenDic=null}}class tweenData{constructor(){this.type=0,this.isTo=!0}destroy(){this.target=null,this.ease=null,this.data=null,this.isTo=!0,this.type=0,Pool.recover("tweenData",this)}}class Socket extends EventDispatcher{constructor(e=null,t=0,r=null,i=null,a=!1){super(),this.disableInput=!1,this.protocols=[],this._byteClass=r||Byte,this.protocols=i,this.endian=Socket.BIG_ENDIAN,e&&t>0&&t<65535&&this.connect(e,t,a)}get input(){return this._input}get output(){return this._output}get connected(){return this._connected}get endian(){return this._endian}set endian(e){this._endian=e,null!=this._input&&(this._input.endian=e),null!=this._output&&(this._output.endian=e)}connect(e,t,r=!1){this.connectByUrl(`${r?"wss":"ws"}://${e}:${t}`)}connectByUrl(e){null!=this._socket&&this.close(),this._socket&&this.cleanSocket(),this.protocols&&0!=this.protocols.length?this._socket=new Browser.window.WebSocket(e,this.protocols):this._socket=new Browser.window.WebSocket(e),this._socket.binaryType="arraybuffer",this._output=new this._byteClass,this._output.endian=this.endian,this._input=new this._byteClass,this._input.endian=this.endian,this._addInputPosition=0,this._socket.onopen=e=>{this._onOpen(e)},this._socket.onmessage=e=>{this._onMessage(e)},this._socket.onclose=e=>{this._onClose(e)},this._socket.onerror=e=>{this._onError(e)}}cleanSocket(){this.close(),this._connected=!1,this._socket.onopen=null,this._socket.onmessage=null,this._socket.onclose=null,this._socket.onerror=null,this._socket=null}close(){if(null!=this._socket)try{this._socket.close()}catch(e){}}_onOpen(e){this._connected=!0,this.event(Event.OPEN,e)}_onMessage(e){if(e&&e.data){var t=e.data;if(this.disableInput&&t)this.event(Event.MESSAGE,t);else{this._input.length>0&&this._input.bytesAvailable<1&&(this._input.clear(),this._addInputPosition=0);var r=this._input.pos;!this._addInputPosition&&(this._addInputPosition=0),this._input.pos=this._addInputPosition,t&&("string"==typeof t?this._input.writeUTFBytes(t):this._input.writeArrayBuffer(t),this._addInputPosition=this._input.pos,this._input.pos=r),this.event(Event.MESSAGE,t)}}}_onClose(e){this._connected=!1,this.event(Event.CLOSE,e)}_onError(e){this.event(Event.ERROR,e)}send(e){this._socket.send(e)}flush(){if(this._output&&this._output.length>0){var e;try{this._socket&&this._socket.send(this._output.__getBuffer().slice(0,this._output.length))}catch(t){e=t}this._output.endian=this.endian,this._output.clear(),e&&this.event(Event.ERROR,e)}}}Socket.LITTLE_ENDIAN="littleEndian",Socket.BIG_ENDIAN="bigEndian";class DrawParticleCmd{static create(e){var t=Pool.getItemByClass("DrawParticleCmd",DrawParticleCmd);return t._templ=e,t}recover(){this._templ=null,Pool.recover("DrawParticleCmd",this)}run(e,t,r){e.drawParticle(t,r,this._templ)}get cmdID(){return DrawParticleCmd.ID}}DrawParticleCmd.ID="DrawParticleCmd";class WebGLCacheAsNormalCanvas{constructor(e,t){this.submitStartPos=0,this.submitEndPos=0,this.touches=[],this.submits=[],this.sprite=null,this.meshlist=[],this.cachedClipInfo=new Matrix,this.oldTx=0,this.oldTy=0,this.invMat=new Matrix,this.context=e,this.sprite=t,e._globalClipMatrix.copyTo(this.cachedClipInfo)}startRec(){}endRec(){}isTextNeedRestore(){var e=!1,t=this.touches;if(t)for(var r=0;r<t.length;r++)if(t[r].deleted){e=!0;break}return e}flushsubmit(){SubmitBase.RENDERBASE,this.submits.forEach((e=>{SubmitBase.RENDERBASE}))}releaseMem(){}}WebGLCacheAsNormalCanvas.matI=new Matrix;class ArabicReshaper{characterMapContains(e){for(var t=0;t<ArabicReshaper.charsMap.length;++t)if(ArabicReshaper.charsMap[t][0]===e)return!0;return!1}getCharRep(e){for(var t=0;t<ArabicReshaper.charsMap.length;++t)if(ArabicReshaper.charsMap[t][0]===e)return ArabicReshaper.charsMap[t];return!1}getCombCharRep(e,t){for(var r=0;r<ArabicReshaper.combCharsMap.length;++r)if(ArabicReshaper.combCharsMap[r][0][0]===e&&ArabicReshaper.combCharsMap[r][0][1]===t)return ArabicReshaper.combCharsMap[r];return!1}isTransparent(e){for(var t=0;t<ArabicReshaper.transChars.length;++t)if(ArabicReshaper.transChars[t]===e)return!0;return!1}getOriginalCharsFromCode(e){var t;for(t=0;t<ArabicReshaper.charsMap.length;++t)if(ArabicReshaper.charsMap[t].indexOf(e)>-1)return String.fromCharCode(ArabicReshaper.charsMap[t][0]);for(t=0;t<ArabicReshaper.combCharsMap.length;++t)if(ArabicReshaper.combCharsMap[t].indexOf(e)>-1)return String.fromCharCode(ArabicReshaper.combCharsMap[t][0][0])+String.fromCharCode(ArabicReshaper.combCharsMap[t][0][1]);return String.fromCharCode(e)}convertArabic(e){for(var t,r,i="",a=0;a<e.length;++a){var s=e.charCodeAt(a);if(this.characterMapContains(s)){for(var n=null,o=null,l=a-1,h=a+1;l>=0&&this.isTransparent(e.charCodeAt(l));--l);for((!(t=!!(n=l>=0?e.charCodeAt(l):null)&&this.getCharRep(n))||null==t[2]&&null==t[3])&&(n=null);h<e.length&&this.isTransparent(e.charCodeAt(h));++h);if((!(t=!!(o=h<e.length?e.charCodeAt(h):null)&&this.getCharRep(o))||null==t[3]&&null==t[4])&&(o=null),1604===s&&null!=o&&(1570===o||1571===o||1573===o||1575===o)){r=this.getCombCharRep(s,o),i+=null!=n?String.fromCharCode(r[4]):String.fromCharCode(r[1]),++a;continue}if(t=this.getCharRep(s),null!=n&&null!=o&&null!=t[3]){i+=String.fromCharCode(t[3]);continue}if(null!=n&&null!=t[4]){i+=String.fromCharCode(t[4]);continue}if(null!=o&&null!=t[2]){i+=String.fromCharCode(t[2]);continue}i+=String.fromCharCode(t[1])}else i+=String.fromCharCode(s)}return i}convertArabicBack(e){var t,r,i="";for(r=0;r<e.length;++r)t=e.charCodeAt(r),i+=this.getOriginalCharsFromCode(t);return i}}ArabicReshaper.charsMap=[[1569,65152,null,null,null],[1570,65153,null,null,65154],[1571,65155,null,null,65156],[1572,65157,null,null,65158],[1573,65159,null,null,65160],[1574,65161,65163,65164,65162],[1575,65165,null,null,65166],[1576,65167,65169,65170,65168],[1577,65171,null,null,65172],[1578,65173,65175,65176,65174],[1579,65177,65179,65180,65178],[1580,65181,65183,65184,65182],[1581,65185,65187,65188,65186],[1582,65189,65191,65192,65190],[1583,65193,null,null,65194],[1584,65195,null,null,65196],[1585,65197,null,null,65198],[1586,65199,null,null,65200],[1587,65201,65203,65204,65202],[1588,65205,65207,65208,65206],[1589,65209,65211,65212,65210],[1590,65213,65215,65216,65214],[1591,65217,65219,65220,65218],[1592,65221,65223,65224,65222],[1593,65225,65227,65228,65226],[1594,65229,65231,65232,65230],[1600,1600,1600,1600,1600],[1601,65233,65235,65236,65234],[1602,65237,65239,65240,65238],[1603,65241,65243,65244,65242],[1604,65245,65247,65248,65246],[1605,65249,65251,65252,65250],[1606,65253,65255,65256,65254],[1607,65257,65259,65260,65258],[1608,65261,null,null,65262],[1609,65263,null,null,65264],[1610,65265,65267,65268,65266],[1662,64342,64344,64345,64343],[1740,64508,64510,64511,64509],[1670,64378,64380,64381,64379],[1705,64398,64400,64401,64399],[1711,64402,64404,64405,64403],[1688,64394,null,null,64395]],ArabicReshaper.combCharsMap=[[[1604,1570],65269,null,null,65270],[[1604,1571],65271,null,null,65272],[[1604,1573],65273,null,null,65274],[[1604,1575],65275,null,null,65276]],ArabicReshaper.transChars=[1552,1554,1555,1556,1557,1611,1612,1613,1614,1615,1616,1617,1618,1619,1620,1621,1622,1623,1624,1648,1750,1751,1752,1753,1754,1755,1756,1759,1760,1761,1762,1763,1764,1767,1768,1770,1771,1772,1773];class BufferState{constructor(){this._deviceBufferState=LayaGL.renderDeviceFactory.createBufferState()}applyState(e,t){this._vertexBuffers=e,this._bindedIndexBuffer=t,this._deviceBufferState&&(1==e.length?(BufferState.vertexBufferArray.length=1,BufferState.vertexBufferArray[0]=e[0]._deviceBuffer):(BufferState.vertexBufferArray.length=0,e.forEach((e=>{BufferState.vertexBufferArray.push(e._deviceBuffer)}))),this._deviceBufferState.applyState(BufferState.vertexBufferArray,t?t._deviceBuffer:null))}destroy(){this._deviceBufferState&&(this._deviceBufferState.destroy(),this._deviceBufferState=null)}}BufferState.vertexBufferArray=[];class MatirxArray{static ArrayMul(e,t,r){if(e)if(t)for(var i,a,s,n,o=0;o<4;o++)i=e[o],a=e[o+4],s=e[o+8],n=e[o+12],r[o]=i*t[0]+a*t[1]+s*t[2]+n*t[3],r[o+4]=i*t[4]+a*t[5]+s*t[6]+n*t[7],r[o+8]=i*t[8]+a*t[9]+s*t[10]+n*t[11],r[o+12]=i*t[12]+a*t[13]+s*t[14]+n*t[15];else MatirxArray.copyArray(e,r);else MatirxArray.copyArray(t,r)}static copyArray(e,t){if(e&&t)for(var r=0;r<e.length;r++)t[r]=e[r]}}return e.AlphaCmd=AlphaCmd,e.Animation=Animation,e.Animation2DCondition=Animation2DCondition,e.Animation2DEvent=Animation2DEvent,e.Animation2DParm=Animation2DParm,e.AnimationBase=AnimationBase,e.AnimationClip2D=AnimationClip2D,e.AnimationClip2DParse01=AnimationClip2DParse01,e.Animator2D=Animator2D,e.AnimatorController2D=AnimatorController2D,e.AnimatorControllerLayer2D=AnimatorControllerLayer2D,e.AnimatorControllerParse=AnimatorControllerParse,e.AnimatorPlayState2D=AnimatorPlayState2D,e.AnimatorState2D=AnimatorState2D,e.AnimatorState2DScript=class{constructor(){this.playStateInfo={animator:null,layerindex:-1,playState:null}}setPlayScriptInfo(e,t,r){this.playStateInfo.animator=e,this.playStateInfo.layerindex=t,this.playStateInfo.playState=r}onStateEnter(){}onStateUpdate(e){}onStateExit(){}onStateLoop(){}},e.AnimatorStateBoolCondition=AnimatorStateBoolCondition,e.AnimatorStateCondition=AnimatorStateCondition,e.AnimatorStateNumberCondition=AnimatorStateNumberCondition,e.AnimatorStateTriggerCondition=AnimatorStateTriggerCondition,e.AnimatorTransition2D=AnimatorTransition2D,e.ArabicReshaper=ArabicReshaper,e.AssetDb=AssetDb,e.AtlasGrid=AtlasGrid,e.AtlasInfoManager=AtlasInfoManager,e.AtlasResource=AtlasResource,e.AudioSound=AudioSound,e.AudioSoundChannel=AudioSoundChannel,e.Base64Tool=Base64Tool,e.BasePoly=BasePoly,e.BaseTexture=BaseTexture,e.BatchProgress=BatchProgress,e.Bezier=Bezier,e.BitmapFont=BitmapFont,e.BlendComponent=BlendComponent,e.BlendMode=BlendMode,e.BlendState=BlendState,e.BlurFilter=BlurFilter,e.BoundsStyle=BoundsStyle,e.Browser=Browser,e.Buffer=Buffer,e.BufferState=BufferState,e.ButtonEffect=class{constructor(){this._curState=0,this.effectScale=1.5,this.tweenTime=300}set target(e){this._tar=e,e.on(Event.MOUSE_DOWN,this,this.toChangedState),e.on(Event.MOUSE_UP,this,this.toInitState),e.on(Event.MOUSE_OUT,this,this.toInitState)}toChangedState(){this._curState=1,this._curTween&&Tween.clear(this._curTween),this._curTween=Tween.to(this._tar,{scaleX:this.effectScale,scaleY:this.effectScale},this.tweenTime,Ease[this.effectEase],Handler.create(this,this.tweenComplete))}toInitState(){2!=this._curState&&(this._curTween&&Tween.clear(this._curTween),this._curState=2,this._curTween=Tween.to(this._tar,{scaleX:1,scaleY:1},this.tweenTime,Ease[this.backEase],Handler.create(this,this.tweenComplete)))}tweenComplete(){this._curState=0,this._curTween=null}},e.Byte=Byte,e.CacheManger=CacheManger,e.CachePage=CachePage,e.CacheStyle=CacheStyle,e.Cache_Info=Cache_Info,e.CallLater=CallLater,e.CharRenderInfo=CharRenderInfo,e.CharRender_Canvas=CharRender_Canvas,e.CharSubmitCache=CharSubmitCache,e.ClassUtils=ClassUtils,e.ClipRectCmd=ClipRectCmd,e.Color=Color,e.ColorFilter=ColorFilter,e.ColorUtils=ColorUtils,e.CommandEncoder=class{constructor(){this._idata=[]}getArrayData(){return this._idata}getCount(){return this._idata.length}addShaderUniform(e){this._idata.push(e)}},e.CommandUniformMap=class{constructor(e){}addShaderUniform(e,t,r,i=null){throw"need override it"}addShaderUniformArray(e,t,r,i,a=""){throw"need override it"}addShaderBlockUniform(e,t,r){throw"need override it"}},e.Component=Component,e.ComponentDriver=ComponentDriver,e.Config=Config,e.Config3D=Config3D,e.Const=Const,e.Context=Context,e.DDSTextureInfo=DDSTextureInfo,e.DefferTouchResContext=DefferTouchResContext,e.Delegate=Delegate,e.DepthState=class{},e.Downloader=Downloader,e.Dragging=Dragging,e.Draw9GridTextureCmd=Draw9GridTextureCmd,e.DrawCircleCmd=DrawCircleCmd,e.DrawCurvesCmd=DrawCurvesCmd,e.DrawEllipseCmd=DrawEllipseCmd,e.DrawGeoCmd=DrawGeoCmd,e.DrawGeosCmd=DrawGeosCmd,e.DrawImageCmd=DrawImageCmd,e.DrawLineCmd=DrawLineCmd,e.DrawLinesCmd=DrawLinesCmd,e.DrawParticleCmd=DrawParticleCmd,e.DrawPathCmd=DrawPathCmd,e.DrawPieCmd=DrawPieCmd,e.DrawPolyCmd=DrawPolyCmd,e.DrawRectCmd=DrawRectCmd,e.DrawRoundRectCmd=DrawRoundRectCmd,e.DrawStyle=DrawStyle,e.DrawTextureCmd=DrawTextureCmd,e.DrawTexturesCmd=DrawTexturesCmd,e.DrawTrianglesCmd=DrawTrianglesCmd,e.Earcut=Earcut,e.EarcutNode=EarcutNode,e.Ease=Ease,e.EffectAnimation=EffectAnimation,e.EffectBase=EffectBase,e.Event=Event,e.EventDispatcher=EventDispatcher,e.FadeIn=class extends EffectBase{_doTween(){return this.target.alpha=0,Tween.to(this.target,{alpha:1},this.duration,Ease[this.ease],this._comlete,this.delay)}},e.FadeOut=class extends EffectBase{_doTween(){return this.target.alpha=1,Tween.to(this.target,{alpha:0},this.duration,Ease[this.ease],this._comlete,this.delay)}},e.FillTextCmd=FillTextCmd,e.FillTextureCmd=FillTextureCmd,e.Filter=Filter,e.FontInfo=FontInfo,e.FrameAnimation=FrameAnimation,e.GLSLCodeGenerator=GLSLCodeGenerator,e.GlowFilter=GlowFilter,e.GrahamScan=GrahamScan,e.GraphicAnimation=GraphicAnimation,e.Graphics=Graphics,e.GraphicsBounds=GraphicsBounds,e.HDRTextureInfo=HDRTextureInfo,e.HTMLCanvas=HTMLCanvas,e.HalfFloatUtils=HalfFloatUtils,e.Handler=Handler,e.HideFlags=HideFlags,e.HierarchyLoader=HierarchyLoader,e.HierarchyParser=HierarchyParser,e.HierarchyResource=Tt,e.HitArea=HitArea,e.HtmlElement=HtmlElement,e.HtmlImage=HtmlImage,e.HtmlLink=HtmlLink,e.HtmlParseOptions=HtmlParseOptions,e.HtmlParser=HtmlParser,e.HttpRequest=HttpRequest,e.ICharRender=ICharRender,e.ILaya=ILaya,e.ImgUtils=ImgUtils,e.IncludeFile=IncludeFile,e.IndexBuffer=class extends Buffer{constructor(t,r){super(t,r),this._indexType=e.IndexFormat.UInt16}},e.Input=Input,e.InputManager=InputManager,e.KTXTextureInfo=KTXTextureInfo,e.KeyLocation=KeyLocation,e.Keyboard=Keyboard,e.Keyframe2D=Keyframe2D,e.KeyframeNode2D=KeyframeNode2D,e.KeyframeNodeList2D=KeyframeNodeList2D,e.Laya=Laya,e.LayaEnv=LayaEnv,e.LayaGL=LayaGL,e.LayaGLQuickRunner=LayaGLQuickRunner,e.LegacyUIParser=LegacyUIParser,e.Loader=Loader,e.LocalStorage=LocalStorage,e.Log=Log,e.Material=Material,e.MaterialParser=MaterialParser,e.MathUtil=MathUtil,e.MathUtils3D=MathUtils3D,e.MatirxArray=MatirxArray,e.Matrix=Matrix,e.Matrix3x3=Matrix3x3,e.Matrix4x4=Matrix4x4,e.MeasureFont=MeasureFont,e.Mesh2D=Mesh2D,e.MeshParticle2D=MeshParticle2D,e.MeshQuadTexture=MeshQuadTexture,e.MeshTexture=MeshTexture,e.MeshVG=MeshVG,e.Mouse=Mouse,e.Node=Node,e.NodeFlags=NodeFlags,e.NullLoader=NullLoader,e.PERF_BEGIN=PERF_BEGIN,e.PERF_END=PERF_END,e.PERF_FRAMECLEAR=PERF_FRAMECLEAR,e.ParseJSON=ParseJSON,e.Path=Path,e.PerfData=PerfData,e.PerfHUD=PerfHUD,e.PerfTools=PerfTools,e.PerformanceDefine=PerformanceDefine,e.Point=Point,e.Pool=Pool,e.PoolCache=PoolCache,e.Prefab=Prefab,e.PrefabImpl=PrefabImpl,e.PrimitiveSV=PrimitiveSV,e.Quaternion=Quaternion,e.QuickTestTool=QuickTestTool,e.Rectangle=Rectangle,e.Render=Render,e.Render2D=Render2D,e.Render2DSimple=Render2DSimple,e.RenderInfo=RenderInfo,e.RenderObject2D=RenderObject2D,e.RenderSprite=RenderSprite,e.RenderState=RenderState,e.RenderState2D=RenderState2D,e.RenderStateContext=RenderStateContext,e.RenderTexture=RenderTexture,e.RenderTexture2D=RenderTexture2D,e.RenderTextureCube=class extends RenderTexture{constructor(e,t,r,i,a){super(e,e,t,r,i,a),this.faceIndex=0}_createRenderTarget(){this._dimension=e.TextureDimension.Cube,this._renderTarget=LayaGL.textureContext.createRenderTargetCubeInternal(this.width,this._format,this._depthStencilFormat,this._generateMipmap,this._gammaSpace,this._multiSamples),this._texture=this._renderTarget._textures[0]}},e.RenderToCache=RenderToCache,e.Resource=Resource,e.RestoreCmd=RestoreCmd,e.RotateCmd=RotateCmd,e.RunDriver=RunDriver,e.SaveBase=SaveBase,e.SaveClipRect=SaveClipRect,e.SaveCmd=SaveCmd,e.SaveMark=SaveMark,e.SaveTransform=SaveTransform,e.SaveTranslate=SaveTranslate,e.ScaleCmd=ScaleCmd,e.Scene=Scene,e.Script=Script,e.SerializeUtil=SerializeUtil,e.Shader2D=Shader2D,e.Shader3D=Shader3D,e.ShaderCompile=ShaderCompile,e.ShaderCompileDefineBase=ShaderCompileDefineBase,e.ShaderData=class{constructor(e=null){this._ownerResource=e}_addCheckUBO(e,t,r){throw new Error("Method not implemented.")}_releaseUBOData(){throw new Error("Method not implemented.")}getDefineData(){throw new Error("Method not implemented.")}getData(){throw new Error("Method not implemented.")}addDefine(e){throw new Error("Method not implemented.")}addDefines(e){throw new Error("Method not implemented.")}removeDefine(e){throw new Error("Method not implemented.")}hasDefine(e){throw new Error("Method not implemented.")}clearDefine(){throw new Error("Method not implemented.")}getBool(e){throw new Error("Method not implemented.")}setBool(e,t){throw new Error("Method not implemented.")}getInt(e){throw new Error("Method not implemented.")}setInt(e,t){throw new Error("Method not implemented.")}getNumber(e){throw new Error("Method not implemented.")}setNumber(e,t){throw new Error("Method not implemented.")}getVector2(e){throw new Error("Method not implemented.")}setVector2(e,t){throw new Error("Method not implemented.")}getVector3(e){throw new Error("Method not implemented.")}setVector3(e,t){throw new Error("Method not implemented.")}getVector(e){throw new Error("Method not implemented.")}setVector(e,t){throw new Error("Method not implemented.")}getColor(e){throw new Error("Method not implemented.")}setColor(e,t){throw new Error("Method not implemented.")}getMatrix4x4(e){throw new Error("Method not implemented.")}setMatrix4x4(e,t){throw new Error("Method not implemented.")}getMatrix3x3(e){throw new Error("Method not implemented.")}setMatrix3x3(e,t){throw new Error("Method not implemented.")}getBuffer(e){throw new Error("Method not implemented.")}setBuffer(e,t){throw new Error("Method not implemented.")}setTexture(e,t){throw new Error("Method not implemented.")}getTexture(e){throw new Error("Method not implemented.")}setUniformBuffer(e,t){throw new Error("Method not implemented.")}getUniformBuffer(e){throw new Error("Method not implemented.")}setShaderData(t,r,i){switch(r){case e.ShaderDataType.Int:this.setInt(t,i);break;case e.ShaderDataType.Bool:this.setBool(t,i);break;case e.ShaderDataType.Float:this.setNumber(t,i);break;case e.ShaderDataType.Vector2:this.setVector2(t,i);break;case e.ShaderDataType.Vector3:this.setVector3(t,i);break;case e.ShaderDataType.Vector4:this.setVector(t,i);break;case e.ShaderDataType.Color:this.setColor(t,i);break;case e.ShaderDataType.Matrix4x4:this.setMatrix4x4(t,i);break;case e.ShaderDataType.Matrix3x3:this.setMatrix3x3(t,i);break;case e.ShaderDataType.Texture2D:case e.ShaderDataType.TextureCube:this.setTexture(t,i);break;case e.ShaderDataType.Buffer:this.setBuffer(t,i);break;default:throw new Error(`unkown shader data type: ${r}`)}}getShaderData(t,r){switch(r){case e.ShaderDataType.Int:return this.getInt(t);case e.ShaderDataType.Bool:return this.getBool(t);case e.ShaderDataType.Float:return this.getNumber(t);case e.ShaderDataType.Vector2:return this.getVector2(t);case e.ShaderDataType.Vector3:return this.getVector3(t);case e.ShaderDataType.Vector4:return this.getVector(t);case e.ShaderDataType.Color:return this.getColor(t);case e.ShaderDataType.Matrix4x4:return this.getMatrix4x4(t);case e.ShaderDataType.Texture2D:case e.ShaderDataType.TextureCube:return this.getTexture(t);case e.ShaderDataType.Buffer:return this.getBuffer(t);case e.ShaderDataType.Matrix3x3:return this.getMatrix3x3(t);case e.ShaderDataType.Matrix4x4:return this.getMatrix4x4(t);default:throw"unkone shader data type."}}_setInternalTexture(e,t){throw new Error("Method not implemented.")}cloneTo(e){throw new Error("Method not implemented.")}_cloneUBO(e){throw new Error("Method not implemented.")}clone(){throw new Error("Method not implemented.")}reset(){throw new Error("Method not implemented.")}destroy(){throw new Error("Method not implemented.")}},e.ShaderDataDefaultValue=ShaderDataDefaultValue,e.ShaderDefine=class{constructor(e,t){this._index=e,this._value=t}},e.ShaderDefines2D=ShaderDefines2D,e.ShaderNode=ShaderNode,e.ShaderParser=ShaderParser,e.ShaderPass=ShaderPass,e.ShaderProcessInfo=ShaderProcessInfo,e.ShaderVariable=ShaderVariable,e.ShaderVariant=ShaderVariant,e.ShaderVariantCollection=ShaderVariantCollection,e.SingletonList=class{constructor(){this.elements=[],this.length=0}_add(e){this.length===this.elements.length?this.elements.push(e):this.elements[this.length]=e}add(e){let t=this.elements.indexOf(e);"number"!=typeof e&&-1!=t&&t<this.length||(this.length===this.elements.length?this.elements.push(e):this.elements[this.length]=e,this.length++)}indexof(e){let t=this.elements.indexOf(e);return-1!=t&&t<this.length?t:-1}remove(e){let t=this.elements.indexOf(e);-1!=t&&t<this.length&&(this.elements[t]=this.elements[this.length-1],this.length--)}clear(){this.elements=[],this.length=0}clean(){this.elements.length=this.length}destroy(){this.elements=null}},e.Socket=Socket,e.Sound=class extends EventDispatcher{load(e){}play(e=0,t=0){return null}get duration(){return 0}dispose(){}},e.SoundChannel=SoundChannel,e.SoundManager=SoundManager,e.SoundNode=SoundNode,e.Sprite=Sprite,e.SpriteCache=SpriteCache,e.SpriteConst=SpriteConst,e.SpriteStyle=SpriteStyle,e.SpriteUtils=SpriteUtils,e.Stage=Stage,e.Stat=Stat,e.StencilState=class{},e.StringKey=class{constructor(){this._strsToID={},this._idToStrs=[],this._length=0}add(e){var t=this._strsToID[e];return null!=t?t:(this._idToStrs[this._length]=e,this._strsToID[e]=this._length++)}getID(e){var t=this._strsToID[e];return null==t?-1:t}getName(e){var t=this._idToStrs[e];return null==t?void 0:t}},e.SubShader=SubShader,e.SubUniformBufferData=class extends UnifromBufferData{constructor(e,t){super(e),this._isInPool=!1,this._needUpdate=!1,this._realByte=0,this._offset=t,this._realByte=this._bytelength,this._bytelength=256*Math.ceil(this._bytelength/256)}},e.SubmitBase=SubmitBase,e.SubmitKey=SubmitKey,e.System=class{static changeDefinition(e,t){window.Laya[e]=t;var r=e+"=classObj";window.eval(r)}},e.Text=Text,e.TextAtlas=TextAtlas,e.TextRender=TextRender,e.TextResource=TextResource,e.TextStyle=TextStyle,e.TextTexture=TextTexture,e.Texture=Texture,e.Texture2D=Texture2D,e.Texture2DArray=Texture2DArray,e.Texture3D=Texture3D,e.TextureCube=TextureCube,e.TextureSV=TextureSV,e.TimeLine=TimeLine,e.Timer=Timer,e.TransformCmd=TransformCmd,e.TranslateCmd=TranslateCmd,e.Tween=Tween,e.TypedArrayClasses=ct,e.UBBParser=UBBParser,e.URL=URL,e.UniformBufferBase=UniformBufferBase,e.UniformBufferObject=UniformBufferObject,e.UnifromBufferData=UnifromBufferData,e.Utils=Utils,e.Value2D=Value2D,e.Value2DManager=class{},e.Vector2=Vector2,e.Vector3=Vector3,e.Vector4=Vector4,e.VectorGraphManager=VectorGraphManager,e.VertexAttributeLayout=VertexAttributeLayout,e.VertexBuffer=class extends Buffer{constructor(e,t){super(e,t),this._instanceBuffer=!1,this._vertexDeclaration=null}get vertexDeclaration(){return this._vertexDeclaration}set vertexDeclaration(e){this._vertexDeclaration=e}get instanceBuffer(){return this._instanceBuffer}set instanceBuffer(e){this._instanceBuffer=e}},e.VertexDeclaration=VertexDeclaration,e.VertexElement=VertexElement,e.VertexElementFormat=VertexElementFormat,e.VertexMesh=VertexMesh,e.VertexStateContext=VertexStateContext,e.VideoNode=VideoNode,e.VideoTexture=VideoTexture,e.Viewport=Viewport,e.WeakObject=WeakObject,e.WebAudioSound=WebAudioSound,e.WebAudioSoundChannel=WebAudioSoundChannel,e.WebGL=WebGL,e.WebGLCacheAsNormalCanvas=WebGLCacheAsNormalCanvas,e.WebGLRTMgr=WebGLRTMgr,e.Widget=Widget,e.WordText=WordText,e.WorkerLoader=WorkerLoader,e.XML=XML,e.XMLIterator=XMLIterator,e.XMLUtils=XMLUtils,e.addAfterInitCallback=ut,e.addBeforeInitCallback=dt,e.addInitCallback=ht,e.alertGlobalError=ot,e.classInfo=function(e){return dummy},e.enableDebugPanel=lt,e.init=nt,e.property=function(e){return dummy},e.regClass=function(e){return function(t){ClassUtils.regClass(e,t)}},e.runInEditor=function(e){},e}({});
//# sourceMappingURL=laya.core.js.map