!function(e,t){"use strict";class WebDefineDatas{constructor(){this._mask=[],this._length=0}_intersectionDefineDatas(e){for(var t=e._mask,r=this._mask,a=this._length-1;a>=0;a--){var i=r[a]&t[a];0==i&&a==this._length-1?this._length--:r[a]=i}}add(e){var t=e._index,r=t+1,a=this._mask,i=this._length;if(i<r){for(a.length<r&&(a.length=r);i<t;i++)a[i]=0;a[t]=e._value,this._length=r}else a[t]|=e._value}remove(e){var t=e._index,r=this._mask,a=this._length-1;if(!(t>a)){var i=r[t]&~e._value;t==a&&0===i?this._length--:r[t]=i}}addDefineDatas(e){var t=e._mask,r=e._length,a=this._mask,i=this._length;if(i<r){a.length=r;for(var n=0;n<i;n++)a[n]|=t[n];for(;n<r;n++)a[n]=t[n];this._length=r}else for(n=0;n<r;n++)a[n]|=t[n]}removeDefineDatas(e){for(var t=e._mask,r=this._mask,a=this._length-1,i=Math.min(e._length,a);i>=0;i--){var n=r[i]&~t[i];i==a&&0===n?(a--,this._length--):r[i]=n}}has(e){var t=e._index;return!(t>=this._length)&&0!=(this._mask[t]&e._value)}clear(){this._length=0}cloneTo(e){var t=e,r=t._mask,a=this._mask,i=this._length;r.length=i;for(var n=0;n<i;n++)r[n]=a[n];t._length=i}clone(){var e=new WebDefineDatas;return this.cloneTo(e),e}destroy(){delete this._mask}}var r,a;e.WebGLExtension=void 0,(r=e.WebGLExtension||(e.WebGLExtension={}))[r.OES_vertex_array_object=0]="OES_vertex_array_object",r[r.ANGLE_instanced_arrays=1]="ANGLE_instanced_arrays",r[r.OES_texture_half_float=2]="OES_texture_half_float",r[r.OES_texture_half_float_linear=3]="OES_texture_half_float_linear",r[r.OES_texture_float=4]="OES_texture_float",r[r.OES_element_index_uint=5]="OES_element_index_uint",r[r.OES_texture_float_linear=6]="OES_texture_float_linear",r[r.EXT_color_buffer_half_float=7]="EXT_color_buffer_half_float",r[r.EXT_shader_texture_lod=8]="EXT_shader_texture_lod",r[r.WEBGL_depth_texture=9]="WEBGL_depth_texture",r[r.EXT_sRGB=10]="EXT_sRGB",r[r.EXT_color_buffer_float=11]="EXT_color_buffer_float",r[r.EXT_texture_filter_anisotropic=12]="EXT_texture_filter_anisotropic",r[r.WEBGL_compressed_texture_s3tc=13]="WEBGL_compressed_texture_s3tc",r[r.WEBGL_compressed_texture_s3tc_srgb=14]="WEBGL_compressed_texture_s3tc_srgb",r[r.WEBGL_compressed_texture_pvrtc=15]="WEBGL_compressed_texture_pvrtc",r[r.WEBGL_compressed_texture_etc1=16]="WEBGL_compressed_texture_etc1",r[r.WEBGL_compressed_texture_etc=17]="WEBGL_compressed_texture_etc",r[r.WEBGL_compressed_texture_astc=18]="WEBGL_compressed_texture_astc",r[r.OES_standard_derivatives=19]="OES_standard_derivatives";class GLObject{constructor(e){this._destroyed=!1,this._engine=e,this._gl=this._engine.gl,this._id=this._engine._IDCounter++}get destroyed(){return this._destroyed}destroy(){this._destroyed||(this._destroyed=!0)}}class WebGLInternalRT extends GLObject{constructor(e,r,a,i,n,s){super(e),this._gpuMemory=0,this.colorFormat=r,this.depthStencilFormat=a,this._isCube=i,this._generateMipmap=n,this._samples=s,this._textures=[],this._depthTexture=null,this._framebuffer=this._gl.createFramebuffer(),s>1&&(this._msaaFramebuffer=this._gl.createFramebuffer()),this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.RC_ALLRenderTexture,1)}get gpuMemory(){return this._gpuMemory}set gpuMemory(e){this._changeTexMemory(e),this._gpuMemory=e}_changeTexMemory(e){this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.M_GPUMemory,-this._gpuMemory+e),this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.M_ALLRenderTexture,-this._gpuMemory+e)}dispose(){this._textures.forEach((e=>{e&&e.dispose()})),this._textures=null,this._depthTexture&&this._depthTexture.dispose(),this._depthTexture=null,this._framebuffer&&this._gl.deleteFramebuffer(this._framebuffer),this._framebuffer=null,this._depthbuffer&&this._gl.deleteRenderbuffer(this._depthbuffer),this._depthbuffer=null,this._msaaFramebuffer&&this._gl.deleteFramebuffer(this._msaaFramebuffer),this._msaaFramebuffer=null,this._msaaRenderbuffer&&this._gl.deleteRenderbuffer(this._msaaRenderbuffer),this._msaaRenderbuffer=null,this._changeTexMemory(0),this.gpuMemory=0,this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.RC_ALLRenderTexture,-1)}}class WebGLInternalTex extends GLObject{constructor(e,r,a,i,n,s,_,o,l){super(e),this._gpuMemory=0,this._baseMipmapLevel=0,this._maxMipmapLevel=0,this.resource=this._gl.createTexture(),this.width=a,this.height=i,this.depth=n;const isPot=e=>0==(e&e-1);switch(this.isPotSize=isPot(a)&&isPot(i),s==t.TextureDimension.Tex3D&&(this.isPotSize=this.isPotSize&&isPot(this.depth)),s){case t.TextureDimension.Tex2D:this._statistics_M_Texture=t.GPUEngineStatisticsInfo.M_Texture2D,this._statistics_RC_Texture=t.GPUEngineStatisticsInfo.RC_Texture2D;break;case t.TextureDimension.Tex3D:this._statistics_M_Texture=t.GPUEngineStatisticsInfo.M_Texture3D,this._statistics_RC_Texture=t.GPUEngineStatisticsInfo.RC_Texture3D;break;case t.TextureDimension.Cube:this._statistics_M_Texture=t.GPUEngineStatisticsInfo.M_TextureCube,this._statistics_RC_Texture=t.GPUEngineStatisticsInfo.RC_TextureCube;break;case t.TextureDimension.Texture2DArray:this._statistics_M_Texture=t.GPUEngineStatisticsInfo.M_Texture2DArray,this._statistics_RC_Texture=t.GPUEngineStatisticsInfo.RC_Texture2DArray}this._mipmap=_&&this.isPotSize,this._mipmapCount=this._mipmap?Math.max(Math.ceil(Math.log2(a))+1,Math.ceil(Math.log2(i))+1):1,this._maxMipmapLevel=this._mipmapCount-1,this._baseMipmapLevel=0,this.useSRGBLoad=o,this.gammaCorrection=l,this.target=r,this.filterMode=t.FilterMode.Bilinear,this.wrapU=t.WrapMode.Repeat,this.wrapV=t.WrapMode.Repeat,this.wrapW=t.WrapMode.Repeat,this.anisoLevel=4,this.compareMode=t.TextureCompareMode.None,WebGLEngine.instance._addStatisticsInfo(this._statistics_RC_Texture,1)}get mipmap(){return this._mipmap}get mipmapCount(){return this._mipmapCount}_getSource(){return this.resource}get gpuMemory(){return this._gpuMemory}set gpuMemory(e){this._changeTexMemory(e),this._gpuMemory=e}get filterMode(){return this._filterMode}set filterMode(e){if(this._filterMode!=e&&this.resource){let t=this._gl,r=this.mipmap,a=this.getFilteMinrParam(e,r);this._setTexParameteri(t.TEXTURE_MIN_FILTER,a);let i=this.getFilterMagParam(e);this._setTexParameteri(t.TEXTURE_MAG_FILTER,i),this._filterMode=e}}get wrapU(){return this._warpU}set wrapU(e){if(this._warpU!=e&&this.resource){let t=this._gl,r=this.getWrapParam(e);this._setWrapMode(t.TEXTURE_WRAP_S,r),this._warpU=e}}get wrapV(){return this._warpV}set wrapV(e){if(this._warpV!=e&&this.resource){let t=this._gl,r=this.getWrapParam(e);this._setWrapMode(t.TEXTURE_WRAP_T,r),this._warpV=e}}get wrapW(){return this._warpW}set wrapW(e){if(this._warpW!=e&&this.resource){if(this._engine.getCapable(t.RenderCapable.Texture3D)){let t=this._gl,r=this.getWrapParam(e);this._setWrapMode(t.TEXTURE_WRAP_R,r)}this._warpW=e}}get anisoLevel(){return this._anisoLevel}set anisoLevel(r){let a=this._engine._supportCapatable.getExtension(e.WebGLExtension.EXT_texture_filter_anisotropic);if(a){this._gl;let e=this._engine.getParams(t.RenderParams.Max_AnisoLevel_Count),i=Math.max(1,Math.min(e,r));this._setTexParametexf(a.TEXTURE_MAX_ANISOTROPY_EXT,i),this._anisoLevel=i}else this._anisoLevel=1}set baseMipmapLevel(e){this._engine.isWebGL2&&this._setTexParameteri(this._gl.TEXTURE_BASE_LEVEL,e),this._baseMipmapLevel=e}get baseMipmapLevel(){return this._baseMipmapLevel}set maxMipmapLevel(e){this._engine.isWebGL2&&this._setTexParameteri(this._gl.TEXTURE_MAX_LEVEL,e),this._maxMipmapLevel=e}get maxMipmapLevel(){return this._maxMipmapLevel}get compareMode(){return this._compareMode}set compareMode(e){this._compareMode=e}_setTexParameteri(e,t){let r=this._gl,a=this.target;this._engine._bindTexture(a,this.resource),r.texParameteri(a,e,t),this._engine._bindTexture(a,null)}_setTexParametexf(e,t){let r=this._gl,a=this.target;this._engine._bindTexture(a,this.resource),r.texParameterf(a,e,t),this._engine._bindTexture(a,null)}getFilteMinrParam(e,r){let a=this._gl;switch(e){case t.FilterMode.Point:return r?a.NEAREST_MIPMAP_NEAREST:a.NEAREST;case t.FilterMode.Bilinear:return r?a.LINEAR_MIPMAP_NEAREST:a.LINEAR;case t.FilterMode.Trilinear:return r?a.LINEAR_MIPMAP_LINEAR:a.LINEAR;default:return r?a.LINEAR_MIPMAP_NEAREST:a.LINEAR}}getFilterMagParam(e){let r=this._gl;switch(e){case t.FilterMode.Point:return r.NEAREST;case t.FilterMode.Bilinear:case t.FilterMode.Trilinear:default:return r.LINEAR}}getWrapParam(e){let r=this._gl;switch(e){case t.WrapMode.Repeat:return r.REPEAT;case t.WrapMode.Clamp:return r.CLAMP_TO_EDGE;case t.WrapMode.Mirrored:return r.MIRRORED_REPEAT;default:return r.REPEAT}}_setWrapMode(e,t){let r=this._gl;this.isPotSize||(t=r.CLAMP_TO_EDGE),this._setTexParameteri(e,t)}_changeTexMemory(e){this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.M_GPUMemory,-this._gpuMemory+e),this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.M_ALLTexture,-this._gpuMemory+e),this._engine._addStatisticsInfo(this._statistics_M_Texture,-this._gpuMemory+e)}dispose(){this._gl.deleteTexture(this.resource),this._changeTexMemory(0),this._gpuMemory=0,WebGLEngine.instance._addStatisticsInfo(this._statistics_RC_Texture,-1)}}class GLTextureContext extends GLObject{constructor(t){super(t),this._glParam={internalFormat:0,format:0,type:0},this.needBitmap=!1,this._sRGB=this._engine._supportCapatable.getExtension(e.WebGLExtension.EXT_sRGB),this._oesTextureHalfFloat=this._engine._supportCapatable.getExtension(e.WebGLExtension.OES_texture_half_float),this._compressdTextureS3tc_srgb=this._engine._supportCapatable.getExtension(e.WebGLExtension.WEBGL_compressed_texture_s3tc_srgb),this._compressedTextureEtc1=this._engine._supportCapatable.getExtension(e.WebGLExtension.WEBGL_compressed_texture_etc1),this._compressedTextureS3tc=this._engine._supportCapatable.getExtension(e.WebGLExtension.WEBGL_compressed_texture_s3tc),this._compressedTextureETC=this._engine._supportCapatable.getExtension(e.WebGLExtension.WEBGL_compressed_texture_etc),this._compressedTextureASTC=this._engine._supportCapatable.getExtension(e.WebGLExtension.WEBGL_compressed_texture_astc),this._webgl_depth_texture=this._engine._supportCapatable.getExtension(e.WebGLExtension.WEBGL_depth_texture)}createTexture3DInternal(e,t,r,a,i,n,s,_){return null}setTexture3DImageData(e,t,r,a,i){return null}setTexture3DPixelsData(e,t,r,a,i){return null}setTexture3DSubPixelsData(e,t,r,a,i,n,s,_,o,l,h,u){return null}glTextureParam(e,r){let a=this._gl;switch(this._glParam.internalFormat=null,this._glParam.format=null,this._glParam.type=null,e){case t.TextureFormat.R8G8B8:this._glParam.internalFormat=r?this._sRGB.SRGB_EXT:a.RGB,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.R8G8B8A8:this._glParam.internalFormat=r?this._sRGB.SRGB_ALPHA_EXT:a.RGBA,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.R5G6B5:this._glParam.internalFormat=a.RGB,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_SHORT_5_6_5;break;case t.TextureFormat.R32G32B32A32:this._glParam.internalFormat=a.RGBA,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.FLOAT;break;case t.TextureFormat.R32G32B32:this._glParam.internalFormat=a.RGB,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.FLOAT;break;case t.TextureFormat.R16G16B16A16:this._glParam.internalFormat=a.RGBA,this._glParam.format=this._glParam.internalFormat,this._glParam.type=this._oesTextureHalfFloat.HALF_FLOAT_OES;break;case t.TextureFormat.R16G16B16:this._glParam.internalFormat=a.RGB,this._glParam.format=this._glParam.internalFormat,this._glParam.type=this._oesTextureHalfFloat.HALF_FLOAT_OES;break;case t.TextureFormat.DXT1:this._glParam.internalFormat=r?this._compressdTextureS3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:this._compressedTextureS3tc.COMPRESSED_RGBA_S3TC_DXT1_EXT,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.DXT3:this._glParam.internalFormat=r?this._compressdTextureS3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT:this._compressedTextureS3tc.COMPRESSED_RGBA_S3TC_DXT3_EXT,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.DXT5:this._glParam.internalFormat=r?this._compressdTextureS3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:this._compressedTextureS3tc.COMPRESSED_RGBA_S3TC_DXT5_EXT,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ETC1RGB:this._glParam.internalFormat=this._compressedTextureEtc1.COMPRESSED_RGB_ETC1_WEBGL,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ETC2RGBA:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_RGBA8_ETC2_EAC,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ETC2RGB:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_RGB8_ETC2,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ETC2SRGB:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_SRGB8_ETC2,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ETC2SRGB_Alpha8:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ASTC4x4:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_4x4_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ASTC6x6:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_6x6_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ASTC8x8:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_8x8_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ASTC10x10:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_10x10_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ASTC12x12:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_12x12_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ASTC4x4SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ASTC6x6SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ASTC8x8SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ASTC10x10SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ASTC12x12SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;default:throw"Unknown Texture Format."}return this._glParam}glRenderTextureParam(e,r){let a=this._gl;switch(this._glParam.internalFormat=null,this._glParam.format=null,this._glParam.type=null,e){case t.RenderTargetFormat.R8G8B8:this._glParam.internalFormat=r?this._sRGB.SRGB_EXT:a.RGB,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.RenderTargetFormat.R8G8B8A8:this._glParam.internalFormat=r?this._sRGB.SRGB_EXT:a.RGBA,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.RenderTargetFormat.R16G16B16:this._glParam.internalFormat=a.RGB,this._glParam.format=this._glParam.internalFormat,this._glParam.type=this._oesTextureHalfFloat.HALF_FLOAT_OES;break;case t.RenderTargetFormat.R16G16B16A16:this._glParam.internalFormat=a.RGBA,this._glParam.format=this._glParam.internalFormat,this._glParam.type=this._oesTextureHalfFloat.HALF_FLOAT_OES;break;case t.RenderTargetFormat.R32G32B32:this._glParam.internalFormat=a.RGB,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.FLOAT;break;case t.RenderTargetFormat.R32G32B32A32:this._glParam.internalFormat=a.RGBA,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.FLOAT;break;case t.RenderTargetFormat.DEPTH_16:this._glParam.internalFormat=a.DEPTH_COMPONENT,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_SHORT;break;case t.RenderTargetFormat.DEPTHSTENCIL_24_8:this._glParam.internalFormat=a.DEPTH_STENCIL,this._glParam.format=this._glParam.internalFormat,this._glParam.type=this._webgl_depth_texture.UNSIGNED_INT_24_8_WEBGL;break;case t.RenderTargetFormat.DEPTH_32:this._glParam.internalFormat=a.DEPTH_COMPONENT,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_INT;break;case t.RenderTargetFormat.STENCIL_8:default:throw"render texture format wrong."}return this._glParam}glRenderBufferParam(e,r){let a=this._gl;switch(e){case t.RenderTargetFormat.DEPTH_16:return{internalFormat:a.DEPTH_COMPONENT16,attachment:a.DEPTH_ATTACHMENT};case t.RenderTargetFormat.DEPTHSTENCIL_24_8:case t.RenderTargetFormat.DEPTH_32:return{internalFormat:a.DEPTH_STENCIL,attachment:a.DEPTH_STENCIL_ATTACHMENT};case t.RenderTargetFormat.STENCIL_8:return{internalFormat:a.STENCIL_INDEX8,attachment:a.STENCIL_ATTACHMENT};default:return null}}glRenderTargetAttachment(e){let r=this._gl;switch(e){case t.RenderTargetFormat.DEPTH_16:return r.DEPTH_ATTACHMENT;case t.RenderTargetFormat.DEPTHSTENCIL_24_8:return r.DEPTH_STENCIL_ATTACHMENT;case t.RenderTargetFormat.DEPTH_32:return r.DEPTH_ATTACHMENT;case t.RenderTargetFormat.STENCIL_8:return r.STENCIL_ATTACHMENT;case t.RenderTargetFormat.R8G8B8:case t.RenderTargetFormat.R8G8B8A8:case t.RenderTargetFormat.R16G16B16:case t.RenderTargetFormat.R16G16B16A16:case t.RenderTargetFormat.R32G32B32:case t.RenderTargetFormat.R32G32B32A32:return r.COLOR_ATTACHMENT0;default:throw"render format."}}getTarget(e){let r=this._gl;switch(e){case t.TextureDimension.Tex2D:return r.TEXTURE_2D;case t.TextureDimension.Cube:return r.TEXTURE_CUBE_MAP;default:throw"texture dimension wrong in WebGL1."}}getFormatPixelsParams(e){let r={channels:0,bytesPerPixel:0,dataTypedCons:Uint8Array,typedSize:1};switch(e){case t.TextureFormat.R8G8B8A8:return r.channels=4,r.bytesPerPixel=4,r.dataTypedCons=Uint8Array,r.typedSize=1,r;case t.TextureFormat.R8G8B8:return r.channels=3,r.bytesPerPixel=3,r.dataTypedCons=Uint8Array,r.typedSize=1,r;case t.TextureFormat.R5G6B5:return r.channels=3,r.bytesPerPixel=2,r.dataTypedCons=Uint16Array,r.typedSize=2,r;case t.TextureFormat.R16G16B16:return r.channels=3,r.bytesPerPixel=6,r.dataTypedCons=Uint16Array,r.typedSize=2,r;case t.TextureFormat.R16G16B16A16:return r.channels=4,r.bytesPerPixel=8,r.dataTypedCons=Uint16Array,r.typedSize=2,r;case t.TextureFormat.R32G32B32:return r.channels=3,r.bytesPerPixel=12,r.dataTypedCons=Float32Array,r.typedSize=4,r;case t.TextureFormat.R32G32B32A32:return r.channels=4,r.bytesPerPixel=16,r.dataTypedCons=Float32Array,r.typedSize=4,r;default:return r}}getGLtexMemory(e,t=1){let r=this._gl,a=0,i=0,n=0,s=this._sRGB?this._sRGB.SRGB_EXT:r.RGB,_=this._sRGB?this._sRGB.SRGB_ALPHA_EXT:r.RGBA;switch(e.internalFormat){case s:case r.RGB:a=3;break;case _:case r.RGBA:a=4;break;default:a=0}switch(e.type){case r.UNSIGNED_BYTE:i=1;break;case r.UNSIGNED_SHORT_5_6_5:i=2/3;break;case r.FLOAT:i=4;break;case this._oesTextureHalfFloat.HALF_FLOAT_OES:i=2;break;default:i=0}return n=a*i*e.width*e.height,e.mipmap&&(n*=1.333),e.target==r.TEXTURE_CUBE_MAP?n*=6:e.target==r.TEXTURE_2D&&(n*=1),n}getGLRTTexMemory(e,r,a,i,n,s,_){let getpixelbyte=e=>{let r=0;switch(e){case t.RenderTargetFormat.R8G8B8:r=3;break;case t.RenderTargetFormat.R8G8B8A8:r=4;break;case t.RenderTargetFormat.R16G16B16A16:r=8;break;case t.RenderTargetFormat.R32G32B32:r=12;break;case t.RenderTargetFormat.R32G32B32A32:r=16;break;case t.RenderTargetFormat.R16G16B16:r=6;break;case t.RenderTargetFormat.DEPTH_16:r=2;break;case t.RenderTargetFormat.STENCIL_8:r=1;break;case t.RenderTargetFormat.DEPTHSTENCIL_24_8:case t.RenderTargetFormat.DEPTH_32:r=4}return r},o=getpixelbyte(a);return s>1&&(o*=2),_&&(o*=6),n&&(o*=1.333),o*e*r+getpixelbyte(i)*e*r}supportSRGB(e,r){switch(e){case t.TextureFormat.R8G8B8:case t.TextureFormat.R8G8B8A8:return this._engine.getCapable(t.RenderCapable.Texture_SRGB)&&!r;case t.TextureFormat.DXT1:case t.TextureFormat.DXT3:case t.TextureFormat.DXT5:return this._engine.getCapable(t.RenderCapable.COMPRESS_TEXTURE_S3TC_SRGB)&&!r;default:return!1}}supportGenerateMipmap(e){switch(e){case t.RenderTargetFormat.DEPTH_16:case t.RenderTargetFormat.DEPTHSTENCIL_24_8:case t.RenderTargetFormat.DEPTH_32:case t.RenderTargetFormat.STENCIL_8:return!1;default:return!0}}isSRGBFormat(e){switch(e){case t.TextureFormat.ETC2SRGB:case t.TextureFormat.ETC2SRGB_Alpha8:case t.TextureFormat.ASTC4x4SRGB:case t.TextureFormat.ASTC6x6SRGB:case t.TextureFormat.ASTC8x8SRGB:case t.TextureFormat.ASTC10x10SRGB:case t.TextureFormat.ASTC12x12SRGB:return!0;default:return!1}}createTextureInternal(e,t,r,a,i,n,s){let _=this.isSRGBFormat(a)||n&&this.supportSRGB(a,i);s&&(_=!1);let o=1;!_&&n&&(o=2.2);let l=this.getTarget(e),h=new WebGLInternalTex(this._engine,l,t,r,1,e,i,_,o),u=this.glTextureParam(a,_);return h.internalFormat=u.internalFormat,h.format=u.format,h.type=u.type,h}setTextureImageData(e,t,r,a){e.width==t.width&&e.height==t.height||console.warn("setTextureImageData: size not match");let i=e.target,n=e.internalFormat,s=e.format,_=e.type;e.width,e.height;let o=e._gl;r&&o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),a&&o.pixelStorei(o.UNPACK_FLIP_Y_WEBGL,!0),this._engine._bindTexture(e.target,e.resource),o.texImage2D(i,0,n,s,_,t),e.gpuMemory=this.getGLtexMemory(e),e.mipmap&&o.generateMipmap(e.target),this._engine._bindTexture(e.target,null),r&&o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a&&o.pixelStorei(o.UNPACK_FLIP_Y_WEBGL,!1)}setTextureSubImageData(e,t,r,a,i,n){let s=e.target;e.internalFormat;let _=e.format,o=e.type;t.width,t.height;let l=e._gl;i&&l.pixelStorei(l.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),n&&l.pixelStorei(l.UNPACK_FLIP_Y_WEBGL,!0),this._engine._bindTexture(e.target,e.resource),l.texSubImage2D(s,0,r,a,_,o,t),e.gpuMemory=this.getGLtexMemory(e),e.mipmap&&l.generateMipmap(e.target),this._engine._bindTexture(e.target,null),i&&l.pixelStorei(l.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),n&&l.pixelStorei(l.UNPACK_FLIP_Y_WEBGL,!1)}initVideoTextureData(e){let t=e.target;e.internalFormat;let r=e.format,a=e.type,i=e.width,n=e.height,s=e._gl;this._engine._bindTexture(e.target,e.resource),s.texImage2D(t,0,e.internalFormat,i,n,0,r,a,null),e.gpuMemory=this.getGLtexMemory(e),e.mipmap&&s.generateMipmap(e.target),this._engine._bindTexture(e.target,null)}setTexturePixelsData(e,t,r,a){let i=e.target,n=e.internalFormat,s=e.format,_=e.type,o=e.width,l=e.height,h=o%4==0&&l%4==0,u=e._gl;r&&u.pixelStorei(u.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),a&&u.pixelStorei(u.UNPACK_FLIP_Y_WEBGL,!0),h||u.pixelStorei(u.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),u.texImage2D(i,0,n,o,l,0,s,_,t),e.gpuMemory=this.getGLtexMemory(e),e.mipmap&&u.generateMipmap(e.target),this._engine._bindTexture(e.target,null),r&&u.pixelStorei(u.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a&&u.pixelStorei(u.UNPACK_FLIP_Y_WEBGL,!1),h||u.pixelStorei(u.UNPACK_ALIGNMENT,4)}setTextureSubPixelsData(e,t,r,a,i,n,s,_,o,l){a=a&&0==r;let h=e.target;e.internalFormat;let u=e.format,m=e.type,d=s%4==0&&_%4==0,E=e._gl;o&&E.pixelStorei(E.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),l&&E.pixelStorei(E.UNPACK_FLIP_Y_WEBGL,!0),d||E.pixelStorei(E.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),E.texSubImage2D(h,r,i,n,s,_,u,m,t),e.mipmap&&a&&E.generateMipmap(e.target),this._engine._bindTexture(e.target,null),o&&E.pixelStorei(E.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),l&&E.pixelStorei(E.UNPACK_FLIP_Y_WEBGL,!1),d||E.pixelStorei(E.UNPACK_ALIGNMENT,4)}setTextureDDSData(e,t){let r=e.target,a=e.internalFormat,i=e.format,n=e.type,s=e.width,_=e.height,o=t.source,l=t.dataOffset,h=t.bpp,u=t.blockBytes,m=t.mipmapCount,d=t.compressed;e.maxMipmapLevel=m-1;let E=s%4==0&&_%4==0,c=e._gl;E||c.pixelStorei(c.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource);let g=this.getFormatPixelsParams(t.format),f=g.bytesPerPixel/g.channels,T=g.dataTypedCons,p=s,x=_,R=0;for(let e=0;e<m;e++){if(d){let t=Math.max(4,p)/4*Math.max(4,x)/4*u,i=new Uint8Array(o,l,t);c.compressedTexImage2D(r,e,a,p,x,0,i),R+=i.length,l+=h?p*x*(h/8):t}else{let t=p*x*g.channels,s=new T(o,l,t);R+=s.length,c.texImage2D(r,e,a,p,x,0,i,n,s),l+=t*f}p*=.5,x*=.5,p=Math.max(1,p),x=Math.max(1,x)}e.gpuMemory=R,this._engine._bindTexture(e.target,null),E||c.pixelStorei(c.UNPACK_ALIGNMENT,4)}setTextureKTXData(e,t){let r=t.source,a=t.compress,i=e.target,n=e.internalFormat,s=e.format,_=e.type,o=e.mipmapCount,l=e.width,h=e.height;e.maxMipmapLevel=o-1;let u=l%4==0&&h%4==0,m=e._gl;u||m.pixelStorei(m.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource);let d=l,E=h,c=t.headerOffset+t.bytesOfKeyValueData,g=0;for(let e=0;e<t.mipmapCount;e++){let o=new Int32Array(r,c,1)[0];if(c+=4,a){let t=new Uint8Array(r,c,o);m.compressedTexImage2D(i,e,n,d,E,0,t),g+=t.length}else{let a=this.getFormatPixelsParams(t.format),l=o/a.typedSize,h=new a.dataTypedCons(r,c,l);m.texImage2D(i,e,n,d,E,0,s,_,h),g+=h.byteLength}c+=o,c+=3-(o+3)%4,d=Math.max(1,.5*d),E=Math.max(1,.5*E)}for(let r=t.mipmapCount;r<e.mipmapCount;r++)a||m.texImage2D(i,r,n,d,E,0,s,_,null),d=Math.max(1,.5*d),E=Math.max(1,.5*E);e.gpuMemory=g,this._engine._bindTexture(e.target,null),u||m.pixelStorei(m.UNPACK_ALIGNMENT,4)}setTextureHDRData(e,t){let r=t.readScanLine();this.setTexturePixelsData(e,r,!1,!1)}setCubeImageData(e,t,r,a){let i=e._gl;const n=[i.TEXTURE_CUBE_MAP_POSITIVE_Z,i.TEXTURE_CUBE_MAP_NEGATIVE_Z,i.TEXTURE_CUBE_MAP_POSITIVE_X,i.TEXTURE_CUBE_MAP_NEGATIVE_X,i.TEXTURE_CUBE_MAP_POSITIVE_Y,i.TEXTURE_CUBE_MAP_NEGATIVE_Y];let s=e.internalFormat,_=e.format,o=e.type;e.width,e.height,r&&i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),a&&i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!0),this._engine._bindTexture(e.target,e.resource);for(let e=0;e<n.length;e++){let r=n[e];i.texImage2D(r,0,s,_,o,t[e])}e.mipmap&&i.generateMipmap(e.target),this._engine._bindTexture(e.target,null),e.gpuMemory=this.getGLtexMemory(e),r&&i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a&&i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!1)}setCubePixelsData(e,t,r,a){let i=e._gl;const n=[i.TEXTURE_CUBE_MAP_POSITIVE_Z,i.TEXTURE_CUBE_MAP_NEGATIVE_Z,i.TEXTURE_CUBE_MAP_POSITIVE_X,i.TEXTURE_CUBE_MAP_NEGATIVE_X,i.TEXTURE_CUBE_MAP_POSITIVE_Y,i.TEXTURE_CUBE_MAP_NEGATIVE_Y];e.target;let s=e.internalFormat,_=e.format,o=e.type,l=e.width,h=e.height,u=l%4==0;if(r&&i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),a&&i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!0),u||i.pixelStorei(i.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),t){for(let e=0;e<n.length;e++){let r=n[e];i.texImage2D(r,0,s,l,h,0,_,o,t[e])}e.mipmap&&i.generateMipmap(e.target)}else{for(let e=0;e<n.length;e++){let t=n[e];i.texImage2D(t,0,s,l,h,0,_,o,null)}e.mipmap&&i.generateMipmap(e.target)}this._engine._bindTexture(e.target,null),e.gpuMemory=this.getGLtexMemory(e),r&&i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a&&i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!1),u||i.pixelStorei(i.UNPACK_ALIGNMENT,4)}setCubeSubPixelData(e,t,r,a,i,n,s,_,o,l){a=a&&0==r;let h=e._gl;const u=[h.TEXTURE_CUBE_MAP_POSITIVE_Z,h.TEXTURE_CUBE_MAP_NEGATIVE_Z,h.TEXTURE_CUBE_MAP_POSITIVE_X,h.TEXTURE_CUBE_MAP_NEGATIVE_X,h.TEXTURE_CUBE_MAP_POSITIVE_Y,h.TEXTURE_CUBE_MAP_NEGATIVE_Y];e.target,e.internalFormat;let m=e.format,d=e.type,E=s%4==0;o&&h.pixelStorei(h.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),l&&h.pixelStorei(h.UNPACK_FLIP_Y_WEBGL,!0),E||h.pixelStorei(h.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource);for(let e=0;e<u.length;e++){let a=u[e];h.texSubImage2D(a,r,i,n,s,_,m,d,t[e])}e.mipmap&&a&&h.generateMipmap(e.target),this._engine._bindTexture(e.target,null),o&&h.pixelStorei(h.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),l&&h.pixelStorei(h.UNPACK_FLIP_Y_WEBGL,!1),E||h.pixelStorei(h.UNPACK_ALIGNMENT,4)}setCubeDDSData(e,t){let r=e.internalFormat,a=e.format,i=e.type,n=e.width,s=e.height,_=t.source,o=t.dataOffset,l=t.bpp,h=t.blockBytes,u=t.mipmapCount;e.maxMipmapLevel=u-1;let m=n%4==0&&s%4==0;m=!0;let d=e._gl;this._engine._bindTexture(e.target,e.resource);const E=[d.TEXTURE_CUBE_MAP_POSITIVE_X,d.TEXTURE_CUBE_MAP_NEGATIVE_X,d.TEXTURE_CUBE_MAP_POSITIVE_Y,d.TEXTURE_CUBE_MAP_NEGATIVE_Y,d.TEXTURE_CUBE_MAP_POSITIVE_Z,d.TEXTURE_CUBE_MAP_NEGATIVE_Z];let c=this.getFormatPixelsParams(t.format),g=c.bytesPerPixel/c.channels,f=c.dataTypedCons,T=0;if(t.compressed)for(let t=0;t<6;t++){let a=E[t],i=n,m=s;for(let t=0;t<u;t++){let n=Math.max(4,i)/4*Math.max(4,m)/4*h,s=new Uint8Array(_,o,n);(e.mipmap||0==t)&&d.compressedTexImage2D(a,t,r,i,m,0,s),T+=s.byteLength,o+=l?i*m*(l/8):n,i*=.5,m*=.5,i=Math.max(1,i),m=Math.max(1,m)}}else for(let e=0;e<6;e++){let t=E[e],l=n,h=s;for(let e=0;e<u;e++){let n=l*h*c.channels,s=new f(_,o,n);d.texImage2D(t,e,r,l,h,0,a,i,s),T+=s.byteLength,o+=n*g,l*=.5,h*=.5,l=Math.max(1,l),h=Math.max(1,h)}}e.gpuMemory=T,this._engine._bindTexture(e.target,null)}setCubeKTXData(e,t){let r=t.source,a=t.compress,i=e.internalFormat,n=e.format,s=e.type,_=t.mipmapCount,o=e.width,l=e.height;e.maxMipmapLevel=_-1;let h=o%4==0&&l%4==0,u=e._gl;const m=[u.TEXTURE_CUBE_MAP_POSITIVE_X,u.TEXTURE_CUBE_MAP_NEGATIVE_X,u.TEXTURE_CUBE_MAP_POSITIVE_Y,u.TEXTURE_CUBE_MAP_NEGATIVE_Y,u.TEXTURE_CUBE_MAP_POSITIVE_Z,u.TEXTURE_CUBE_MAP_NEGATIVE_Z];h||u.pixelStorei(u.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource);let d=o,E=l,c=t.headerOffset+t.bytesOfKeyValueData,g=0;for(let e=0;e<t.mipmapCount;e++){let _=new Int32Array(r,c,1)[0];c+=4;for(let o=0;o<6;o++){let l=m[o];if(a){let t=new Uint8Array(r,c,_);u.compressedTexImage2D(l,e,i,d,E,0,t),g+=t.byteLength}else{let a=this.getFormatPixelsParams(t.format),o=_/a.typedSize,h=new a.dataTypedCons(r,c,o);u.texImage2D(l,e,i,d,E,0,n,s,h),g+=h.byteLength}c+=_,c+=3-(_+3)%4}d=Math.max(1,.5*d),E=Math.max(1,.5*E)}for(let r=t.mipmapCount;r<e.mipmapCount;r++){for(let e=0;e<6;e++){let t=m[e];a||u.texImage2D(t,r,i,d,E,0,n,s,null)}d=Math.max(1,.5*d),E=Math.max(1,.5*E)}this._engine._bindTexture(e.target,null),e.gpuMemory=g,h||u.pixelStorei(u.UNPACK_ALIGNMENT,4)}setTextureCompareMode(e,r){return t.TextureCompareMode.None}bindRenderTarget(e,t=0){this.currentActiveRT&&this.unbindRenderTarget(this.currentActiveRT);let r=this._gl,a=e._framebuffer;if(r.bindFramebuffer(r.FRAMEBUFFER,a),e._isCube){let a=e._textures[0];r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_CUBE_MAP_POSITIVE_X+t,a.resource,0)}this.currentActiveRT=e}bindoutScreenTarget(){this.currentActiveRT&&this.unbindRenderTarget(this.currentActiveRT)}unbindRenderTarget(e){let t=e._gl;e._generateMipmap&&e._textures.forEach((e=>{let r=e.target;this._engine._bindTexture(r,e.resource),t.generateMipmap(r),this._engine._bindTexture(r,null)})),t.bindFramebuffer(t.FRAMEBUFFER,null),this.currentActiveRT=null}createRenderTextureCubeInternal(e,r,a,i,n){i=i&&this.supportGenerateMipmap(a);let s=this.getTarget(e),_=new WebGLInternalTex(this._engine,s,r,r,1,e,i,false,1),o=this.glRenderTextureParam(a,false);_.internalFormat=o.internalFormat,_.format=o.format,_.type=o.type;let l=_.internalFormat,h=_.format,u=_.type,m=_._gl;const d=[m.TEXTURE_CUBE_MAP_POSITIVE_Z,m.TEXTURE_CUBE_MAP_NEGATIVE_Z,m.TEXTURE_CUBE_MAP_POSITIVE_X,m.TEXTURE_CUBE_MAP_NEGATIVE_X,m.TEXTURE_CUBE_MAP_POSITIVE_Y,m.TEXTURE_CUBE_MAP_NEGATIVE_Y];this._engine._bindTexture(_.target,_.resource);for(let e=0;e<d.length;e++){let t=d[e];m.texImage2D(t,0,l,r,r,0,h,u,null)}return this._engine._bindTexture(_.target,null),a!=t.RenderTargetFormat.DEPTH_16&&a!=t.RenderTargetFormat.DEPTH_32&&a!=t.RenderTargetFormat.DEPTHSTENCIL_24_8||(_.filterMode=t.FilterMode.Point),_}createRenderTargetInternal(e,r,a,i,n,s,_){let o=this.createRenderTextureInternal(t.TextureDimension.Tex2D,e,r,a,n,s),l=new WebGLInternalRT(this._engine,a,i,!1,o.mipmap,1);l.gpuMemory=this.getGLRTTexMemory(e,r,a,i,n,1,!1),l.colorFormat=a,l.depthStencilFormat=i,l._textures.push(o);let h=l._framebuffer,u=l._gl;u.bindFramebuffer(u.FRAMEBUFFER,h);let m=this.glRenderTargetAttachment(a);u.framebufferTexture2D(u.FRAMEBUFFER,m,u.TEXTURE_2D,o.resource,0);let d=this.glRenderBufferParam(i,!1);if(d){let t=this.createRenderbuffer(e,r,d.internalFormat,l._samples);l._depthbuffer=t,u.framebufferRenderbuffer(u.FRAMEBUFFER,d.attachment,u.RENDERBUFFER,t)}return u.bindFramebuffer(u.FRAMEBUFFER,null),l}createRenderTargetCubeInternal(e,r,a,i,n,s){let _=this.createRenderTextureCubeInternal(t.TextureDimension.Cube,e,r,i,n),o=new WebGLInternalRT(this._engine,r,a,!0,_.mipmap,1);o.gpuMemory=this.getGLRTTexMemory(e,e,r,a,i,1,!0),o._textures.push(_);let l=o._framebuffer,h=o._gl;h.bindFramebuffer(h.FRAMEBUFFER,l);let u=this.glRenderBufferParam(a,!1);if(u){let t=this.createRenderbuffer(e,e,u.internalFormat,o._samples);o._depthbuffer=t,h.framebufferRenderbuffer(h.FRAMEBUFFER,u.attachment,h.RENDERBUFFER,t)}return h.bindFramebuffer(h.FRAMEBUFFER,null),o}createRenderbuffer(e,t,r,a){let i=this._gl,n=i.createRenderbuffer();return i.bindRenderbuffer(i.RENDERBUFFER,n),i.renderbufferStorage(i.RENDERBUFFER,r,e,t),i.bindRenderbuffer(i.RENDERBUFFER,null),n}createRenderTextureInternal(e,r,a,i,n,s){n=n&&this.supportGenerateMipmap(i);let _=this.getTarget(e),o=new WebGLInternalTex(this._engine,_,r,a,1,e,n,false,1),l=this.glRenderTextureParam(i,false);o.internalFormat=l.internalFormat,o.format=l.format,o.type=l.type;let h=o.internalFormat,u=o.format,m=o.type,d=o._gl;return this._engine._bindTexture(o.target,o.resource),d.texImage2D(_,0,h,r,a,0,u,m,null),this._engine._bindTexture(o.target,null),i!=t.RenderTargetFormat.DEPTH_16&&i!=t.RenderTargetFormat.DEPTH_32&&i!=t.RenderTargetFormat.DEPTHSTENCIL_24_8||(o.filterMode=t.FilterMode.Point),o}createRenderTargetDepthTexture(e,r,a,i){let n=e._gl;if(e.depthStencilFormat==t.RenderTargetFormat.None)return null;let s=e._depthbuffer;s&&n.deleteRenderbuffer(s),e._depthbuffer=null;let _=e.depthStencilFormat,o=e._generateMipmap,l=e.isSRGB;e._depthTexture&&n.deleteTexture(e._depthTexture);let h=this.createRenderTextureInternal(r,a,i,_,o,l);e._depthTexture=h;let u=this.glRenderTargetAttachment(e.depthStencilFormat),m=e._framebuffer;return n.bindFramebuffer(n.FRAMEBUFFER,m),n.framebufferTexture2D(n.FRAMEBUFFER,u,n.TEXTURE_2D,h.resource,0),n.bindFramebuffer(n.FRAMEBUFFER,null),h}readRenderTargetPixelData(e,r,a,i,n,s){let _=e._gl;if(this.bindRenderTarget(e),!(_.checkFramebufferStatus(_.FRAMEBUFFER)==_.FRAMEBUFFER_COMPLETE))return this.unbindRenderTarget(e),null;switch(e.colorFormat){case t.RenderTargetFormat.R8G8B8:_.readPixels(r,a,i,n,_.RGB,_.UNSIGNED_BYTE,s);break;case t.RenderTargetFormat.R8G8B8A8:_.readPixels(r,a,i,n,_.RGBA,_.UNSIGNED_BYTE,s);break;case t.RenderTargetFormat.R16G16B16:_.readPixels(r,a,i,n,_.RGB,_.FLOAT,s);break;case t.RenderTargetFormat.R16G16B16A16:_.readPixels(r,a,i,n,_.RGBA,_.FLOAT,s);break;case t.RenderTargetFormat.R32G32B32:_.readPixels(r,a,i,n,_.RGB,_.FLOAT,s);break;case t.RenderTargetFormat.R32G32B32A32:_.readPixels(r,a,i,n,_.RGBA,_.FLOAT,s)}return this.unbindRenderTarget(e),s}readRenderTargetPixelDataAsync(e,t,r,a,i,n){return Promise.resolve(this.readRenderTargetPixelData(e,t,r,a,i,n))}updateVideoTexture(e,t,r,a){let i=e._gl,n=e.target,s=e.internalFormat,_=e.format,o=e.type;e.width,e.height,r&&i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),a&&i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!0),i.pixelStorei(i.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),i.texImage2D(n,0,s,_,o,t),this._engine._bindTexture(e.target,null),r&&i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a&&i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!1),i.pixelStorei(i.UNPACK_ALIGNMENT,4)}getRenderTextureData(e,r,a,i,n){if(e.colorFormat==t.RenderTargetFormat.None)return null;let s=e._gl;if(s.bindFramebuffer(s.FRAMEBUFFER,e._framebuffer),!(s.checkFramebufferStatus(s.FRAMEBUFFER)===s.FRAMEBUFFER_COMPLETE))return s.bindFramebuffer(s.FRAMEBUFFER,null),null;let _,o,l=i*n;var h;switch(e.colorFormat){case t.RenderTargetFormat.R8G8B8:_=s.RGB,o=s.UNSIGNED_BYTE,h=new Uint8Array(3*l);break;case t.RenderTargetFormat.R8G8B8A8:_=s.RGBA,o=s.UNSIGNED_BYTE,h=new Uint8Array(4*l);break;case t.RenderTargetFormat.R16G16B16:_=s.RGB,o=s.UNSIGNED_SHORT_4_4_4_4,h=new Uint16Array(3*l);break;case t.RenderTargetFormat.R16G16B16A16:_=s.RGBA,o=s.UNSIGNED_SHORT_4_4_4_4,h=new Uint16Array(4*l);break;case t.RenderTargetFormat.R32G32B32:_=s.RGB,o=s.FLOAT,h=new Float32Array(3*l);break;case t.RenderTargetFormat.R32G32B32A32:_=s.RGBA,o=s.FLOAT,h=new Float32Array(4*l);break;default:return null}return s.readPixels(r,a,i,n,_,o,h),s.bindFramebuffer(s.FRAMEBUFFER,null),h}}class GL2TextureContext extends GLTextureContext{constructor(e){super(e)}getTarget(e){let r=-1;switch(e){case t.TextureDimension.Cube:r=this._gl.TEXTURE_CUBE_MAP;break;case t.TextureDimension.Tex2D:r=this._gl.TEXTURE_2D;break;case t.TextureDimension.Texture2DArray:r=this._gl.TEXTURE_2D_ARRAY;break;case t.TextureDimension.Tex3D:r=this._gl.TEXTURE_3D;break;default:throw"Unknow Texture Target"}return r}glTextureParam(e,r){let a=this._gl;switch(this._glParam.internalFormat=null,this._glParam.format=null,this._glParam.type=null,e){case t.TextureFormat.R8G8B8:this._glParam.internalFormat=r?a.SRGB8:a.RGB8,this._glParam.format=a.RGB,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.R8G8B8A8:this._glParam.internalFormat=r?a.SRGB8_ALPHA8:a.RGBA8,this._glParam.format=a.RGBA,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.R5G6B5:this._glParam.internalFormat=a.RGB565,this._glParam.format=a.RGB,this._glParam.type=a.UNSIGNED_SHORT_5_6_5;break;case t.TextureFormat.R32G32B32A32:this._glParam.internalFormat=a.RGBA32F,this._glParam.format=a.RGBA,this._glParam.type=a.FLOAT;break;case t.TextureFormat.R32G32B32:this._glParam.internalFormat=a.RGB32F,this._glParam.format=a.RGB,this._glParam.type=a.FLOAT;break;case t.TextureFormat.R16G16B16:this._glParam.internalFormat=a.RGB16F,this._glParam.format=a.RGB,this._glParam.type=a.HALF_FLOAT;break;case t.TextureFormat.R16G16B16A16:this._glParam.internalFormat=a.RGBA16F,this._glParam.format=a.RGBA,this._glParam.type=a.HALF_FLOAT;break;case t.TextureFormat.DXT1:this._glParam.internalFormat=r?this._compressdTextureS3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:this._compressedTextureS3tc.COMPRESSED_RGBA_S3TC_DXT1_EXT;break;case t.TextureFormat.DXT3:this._glParam.internalFormat=r?this._compressdTextureS3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT:this._compressedTextureS3tc.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case t.TextureFormat.DXT5:this._glParam.internalFormat=r?this._compressdTextureS3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:this._compressedTextureS3tc.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;case t.TextureFormat.ETC1RGB:this._glParam.internalFormat=this._compressedTextureEtc1.COMPRESSED_RGB_ETC1_WEBGL;break;case t.TextureFormat.ETC2RGBA:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_RGBA8_ETC2_EAC;break;case t.TextureFormat.ETC2RGB:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_RGB8_ETC2;break;case t.TextureFormat.ETC2SRGB:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_SRGB8_ETC2;break;case t.TextureFormat.ETC2SRGB_Alpha8:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;break;case t.TextureFormat.ASTC4x4:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_4x4_KHR;break;case t.TextureFormat.ASTC6x6:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_6x6_KHR;break;case t.TextureFormat.ASTC8x8:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_8x8_KHR;break;case t.TextureFormat.ASTC10x10:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_10x10_KHR;break;case t.TextureFormat.ASTC12x12:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_12x12_KHR;break;case t.TextureFormat.ASTC4x4SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case t.TextureFormat.ASTC6x6SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;break;case t.TextureFormat.ASTC8x8SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;break;case t.TextureFormat.ASTC10x10SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;break;case t.TextureFormat.ASTC12x12SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;break;default:throw"Unknown Texture Format."}return this._glParam}glRenderBufferParam(e,r){let a=this._gl;switch(e){case t.RenderTargetFormat.DEPTH_16:return{internalFormat:a.DEPTH_COMPONENT16,attachment:a.DEPTH_ATTACHMENT};case t.RenderTargetFormat.DEPTHSTENCIL_24_8:return{internalFormat:a.DEPTH24_STENCIL8,attachment:a.DEPTH_STENCIL_ATTACHMENT};case t.RenderTargetFormat.DEPTH_32:return{internalFormat:a.DEPTH_COMPONENT32F,attachment:a.DEPTH_ATTACHMENT};case t.RenderTargetFormat.STENCIL_8:return{internalFormat:a.STENCIL_INDEX8,attachment:a.STENCIL_ATTACHMENT};case t.RenderTargetFormat.R8G8B8:return{internalFormat:r?a.SRGB8:a.RGB8,attachment:a.COLOR_ATTACHMENT0};case t.RenderTargetFormat.R8G8B8A8:return{internalFormat:r?a.SRGB8_ALPHA8:a.RGBA8,attachment:a.COLOR_ATTACHMENT0};case t.RenderTargetFormat.R16G16B16:return{internalFormat:a.RGB16F,attachment:a.COLOR_ATTACHMENT0};case t.RenderTargetFormat.R16G16B16A16:return{internalFormat:a.RGBA16F,attachment:a.COLOR_ATTACHMENT0};case t.RenderTargetFormat.R32G32B32:return{internalFormat:a.RGB32F,attachment:a.COLOR_ATTACHMENT0};case t.RenderTargetFormat.R32G32B32A32:return{internalFormat:a.RGBA32F,attachment:a.COLOR_ATTACHMENT0};default:return null}}glRenderTextureParam(e,r){let a=this._gl;switch(this._glParam.internalFormat=null,this._glParam.format=null,this._glParam.type=null,e){case t.RenderTargetFormat.R8G8B8:this._glParam.internalFormat=r?a.SRGB8:a.RGB8,this._glParam.format=a.RGB,this._glParam.type=a.UNSIGNED_BYTE;break;case t.RenderTargetFormat.R8G8B8A8:this._glParam.internalFormat=r?a.SRGB8_ALPHA8:a.RGBA8,this._glParam.format=a.RGBA,this._glParam.type=a.UNSIGNED_BYTE;break;case t.RenderTargetFormat.R16G16B16:this._glParam.internalFormat=a.RGB16F,this._glParam.format=a.RGB,this._glParam.type=a.HALF_FLOAT;break;case t.RenderTargetFormat.R16G16B16A16:this._glParam.internalFormat=a.RGBA16F,this._glParam.format=a.RGBA,this._glParam.type=a.HALF_FLOAT;break;case t.RenderTargetFormat.R32G32B32:this._glParam.internalFormat=a.RGB32F,this._glParam.format=a.RGB,this._glParam.type=a.FLOAT;break;case t.RenderTargetFormat.R32G32B32A32:this._glParam.internalFormat=a.RGBA32F,this._glParam.format=a.RGBA,this._glParam.type=a.FLOAT;break;case t.RenderTargetFormat.DEPTH_16:this._glParam.internalFormat=a.DEPTH_COMPONENT16,this._glParam.format=a.DEPTH_COMPONENT,this._glParam.type=a.UNSIGNED_INT;break;case t.RenderTargetFormat.DEPTHSTENCIL_24_8:this._glParam.internalFormat=a.DEPTH24_STENCIL8,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_INT_24_8;break;case t.RenderTargetFormat.DEPTH_32:this._glParam.internalFormat=a.DEPTH_COMPONENT32F,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_INT;break;case t.RenderTargetFormat.STENCIL_8:break;default:throw"depth texture format wrong."}return this._glParam}getGLtexMemory(e,t=1){let r=this._gl,a=0,i=0,n=0;switch(e.internalFormat){case r.SRGB8:case r.RGB8:case r.RGB565:case r.RGB32F:case r.RGB16F:a=3;break;case r.SRGB8_ALPHA8:case r.RGBA8:case r.RGBA32F:case r.RGBA16F:a=4;break;default:a=0}switch(e.type){case r.UNSIGNED_BYTE:i=1;break;case r.UNSIGNED_SHORT_5_6_5:i=2/3;break;case r.FLOAT:i=4;break;case r.HALF_FLOAT:i=2;break;default:i=0}return n=a*i*e.width*e.height,e.mipmap&&(n*=1.333),e.target==r.TEXTURE_CUBE_MAP?n*=6:e.target==r.TEXTURE_2D?n*=1:e.target==r.TEXTURE_2D_ARRAY&&(n*=t),n}supportSRGB(e,r){switch(e){case t.TextureFormat.R8G8B8:return this._engine.getCapable(t.RenderCapable.Texture_SRGB)&&!r;case t.TextureFormat.R8G8B8A8:return this._engine.getCapable(t.RenderCapable.Texture_SRGB);case t.TextureFormat.DXT1:case t.TextureFormat.DXT3:case t.TextureFormat.DXT5:return this._engine.getCapable(t.RenderCapable.COMPRESS_TEXTURE_S3TC_SRGB)&&!r;default:return!1}}setTextureImageData(e,t,r,a){e.width==t.width&&e.height==t.height||console.warn("setTextureImageData: size not match");let i=e.target,n=e.internalFormat,s=e.format,_=e.type,o=e.width,l=e.height,h=e.mipmapCount,u=this._gl;r&&u.pixelStorei(u.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),a&&u.pixelStorei(u.UNPACK_FLIP_Y_WEBGL,!0),this._engine._bindTexture(e.target,e.resource),u.texStorage2D(i,h,n,o,l),u.texSubImage2D(i,0,0,0,o,l,s,_,t),e.gpuMemory=this.getGLtexMemory(e),e.mipmap&&u.generateMipmap(e.target),this._engine._bindTexture(e.target,null),r&&u.pixelStorei(u.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a&&u.pixelStorei(u.UNPACK_FLIP_Y_WEBGL,!1)}setTextureSubImageData(e,t,r,a,i,n){let s=e.target;e.internalFormat;let _=e.format,o=e.type;e.width,e.height,e.mipmapCount;let l=this._gl;i&&l.pixelStorei(l.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),n&&l.pixelStorei(l.UNPACK_FLIP_Y_WEBGL,!0),this._engine._bindTexture(e.target,e.resource),l.texSubImage2D(s,0,r,a,t.width,t.height,_,o,t),e.gpuMemory=this.getGLtexMemory(e),e.mipmap&&l.generateMipmap(e.target),this._engine._bindTexture(e.target,null),i&&l.pixelStorei(l.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),n&&l.pixelStorei(l.UNPACK_FLIP_Y_WEBGL,!1)}setTexturePixelsData(e,t,r,a){let i=e.target,n=e.internalFormat,s=e.format,_=e.type,o=e.width,l=e.height,h=e.mipmapCount,u=o%4==0&&l%4==0,m=this._gl;r&&m.pixelStorei(m.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),a&&m.pixelStorei(m.UNPACK_FLIP_Y_WEBGL,!0),u||m.pixelStorei(m.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),m.texStorage2D(i,h,n,o,l),e.gpuMemory=this.getGLtexMemory(e),t&&(m.texSubImage2D(i,0,0,0,o,l,s,_,t),e.mipmap&&m.generateMipmap(e.target)),this._engine._bindTexture(e.target,null),r&&m.pixelStorei(m.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a&&m.pixelStorei(m.UNPACK_FLIP_Y_WEBGL,!1),u||m.pixelStorei(m.UNPACK_ALIGNMENT,4)}createTexture3DInternal(e,t,r,a,i,n,s,_){let o=this.isSRGBFormat(i)||s&&this.supportSRGB(i,n);_&&(o=!1);let l=1;!o&&s&&(l=2.2);let h=this.getTarget(e),u=new WebGLInternalTex(this._engine,h,t,r,a,e,n,o,l),m=this.glTextureParam(i,o);return u.internalFormat=m.internalFormat,u.format=m.format,u.type=m.type,u}setTexture3DImageData(e,t,r,a,i){let n=e.target,s=e.internalFormat,_=e.format,o=e.type,l=e.width,h=e.height,u=e.mipmapCount,m=this._gl;a&&m.pixelStorei(m.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),i&&m.pixelStorei(m.UNPACK_FLIP_Y_WEBGL,!0),this._engine._bindTexture(e.target,e.resource),m.texStorage3D(n,u,s,l,h,r),e.gpuMemory=this.getGLtexMemory(e,r);for(let e=0;e<r;e++)m.texSubImage3D(n,0,0,0,e,l,h,1,_,o,t[e]);e.gpuMemory=this.getGLtexMemory(e),e.mipmap&&m.generateMipmap(e.target),this._engine._bindTexture(e.target,null),a&&m.pixelStorei(m.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),i&&m.pixelStorei(m.UNPACK_FLIP_Y_WEBGL,!1)}setTexture3DPixelsData(e,t,r,a,i){let n=e.target,s=e.internalFormat,_=e.format,o=e.type,l=e.width,h=e.height,u=e.mipmapCount,m=l%4==0&&h%4==0,d=this._gl;a&&d.pixelStorei(d.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),i&&d.pixelStorei(d.UNPACK_FLIP_Y_WEBGL,!0),m||d.pixelStorei(d.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),d.texStorage3D(n,u,s,l,h,r),e.gpuMemory=this.getGLtexMemory(e,r),t&&(d.texSubImage3D(n,0,0,0,0,l,h,r,_,o,t),e.mipmap&&d.generateMipmap(e.target)),this._engine._bindTexture(e.target,null),a&&d.pixelStorei(d.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),i&&d.pixelStorei(d.UNPACK_FLIP_Y_WEBGL,!1),m||d.pixelStorei(d.UNPACK_ALIGNMENT,4)}setTexture3DSubPixelsData(e,t,r,a,i,n,s,_,o,l,h,u){a=a&&0==r;let m=e.target;e.internalFormat;let d=e.format,E=e.type,c=_%4==0&&o%4==0,g=this._gl;h&&g.pixelStorei(g.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),u&&g.pixelStorei(g.UNPACK_FLIP_Y_WEBGL,!0),c||g.pixelStorei(g.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),g.texSubImage3D(m,r,i,n,s,_,o,l,d,E,t),e.mipmap&&a&&g.generateMipmap(e.target),this._engine._bindTexture(e.target,null),h&&g.pixelStorei(g.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),u&&g.pixelStorei(g.UNPACK_FLIP_Y_WEBGL,!1),c||g.pixelStorei(g.UNPACK_ALIGNMENT,4)}setTextureHDRData(e,t){let r=t.readScanLine();this.setTexturePixelsData(e,r,!1,!1)}setTextureKTXData(e,t){let r=e.target,a=e.internalFormat,i=e.format,n=e.type,s=e.mipmapCount,_=e.width,o=e.height;e.maxMipmapLevel=s-1;let l=t.source,h=t.compress,u=_%4==0&&o%4==0,m=this._gl;u||m.pixelStorei(m.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),h||m.texStorage2D(r,t.mipmapCount,a,_,o);let d=_,E=o,c=t.headerOffset+t.bytesOfKeyValueData,g=0;for(let e=0;e<t.mipmapCount;e++){let s=new Int32Array(l,c,1)[0];if(c+=4,h){let t=new Uint8Array(l,c,s);m.compressedTexImage2D(r,e,a,d,E,0,t),g+=t.length}else{let a=this.getFormatPixelsParams(t.format),_=s/a.typedSize,o=new a.dataTypedCons(l,c,_);m.texSubImage2D(r,e,0,0,d,E,i,n,o),g+=o.length}c+=s,c+=3-(s+3)%4,d=Math.max(1,.5*d),E=Math.max(1,.5*E)}this._engine._bindTexture(e.target,null),e.gpuMemory=g,u||m.pixelStorei(m.UNPACK_ALIGNMENT,4)}setCubeImageData(e,t,r,a){let i=this._gl;const n=[i.TEXTURE_CUBE_MAP_POSITIVE_Z,i.TEXTURE_CUBE_MAP_NEGATIVE_Z,i.TEXTURE_CUBE_MAP_POSITIVE_X,i.TEXTURE_CUBE_MAP_NEGATIVE_X,i.TEXTURE_CUBE_MAP_POSITIVE_Y,i.TEXTURE_CUBE_MAP_NEGATIVE_Y];let s=e.target,_=e.internalFormat,o=e.format,l=e.type,h=e.width,u=e.height,m=e.mipmapCount;r&&i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),a&&i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!0),this._engine._bindTexture(e.target,e.resource),i.texStorage2D(s,m,_,h,u),e.gpuMemory=this.getGLtexMemory(e);for(let e=0;e<n.length;e++){let r=n[e];i.texSubImage2D(r,0,0,0,o,l,t[e])}e.mipmap&&i.generateMipmap(e.target),this._engine._bindTexture(e.target,null),r&&i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a&&i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!1)}setCubePixelsData(e,t,r,a){let i=this._gl;const n=[i.TEXTURE_CUBE_MAP_POSITIVE_Z,i.TEXTURE_CUBE_MAP_NEGATIVE_Z,i.TEXTURE_CUBE_MAP_POSITIVE_X,i.TEXTURE_CUBE_MAP_NEGATIVE_X,i.TEXTURE_CUBE_MAP_POSITIVE_Y,i.TEXTURE_CUBE_MAP_NEGATIVE_Y];let s=e.target,_=e.internalFormat,o=e.format,l=e.type,h=e.width,u=e.height,m=e.mipmapCount,d=h%4==0;if(r&&i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),a&&i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!0),d||i.pixelStorei(i.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),i.texStorage2D(s,m,_,h,u),t){for(let e=0;e<n.length;e++){let r=n[e];i.texSubImage2D(r,0,0,0,h,u,o,l,t[e])}e.mipmap&&i.generateMipmap(e.target)}this._engine._bindTexture(e.target,null),e.gpuMemory=this.getGLtexMemory(e),r&&i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a&&i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!1),d||i.pixelStorei(i.UNPACK_ALIGNMENT,4)}setCubeKTXData(e,t){let r=this._gl;const a=[r.TEXTURE_CUBE_MAP_POSITIVE_X,r.TEXTURE_CUBE_MAP_NEGATIVE_X,r.TEXTURE_CUBE_MAP_POSITIVE_Y,r.TEXTURE_CUBE_MAP_NEGATIVE_Y,r.TEXTURE_CUBE_MAP_POSITIVE_Z,r.TEXTURE_CUBE_MAP_NEGATIVE_Z];let i=e.target,n=e.internalFormat,s=e.format,_=e.type;e.mipmapCount;let o=e.width,l=e.height;e.maxMipmapLevel=t.mipmapCount-1;let h=t.source,u=t.compress,m=o,d=l,E=t.headerOffset+t.bytesOfKeyValueData,c=o%4==0&&l%4==0;c||r.pixelStorei(r.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),u||r.texStorage2D(i,t.mipmapCount,n,o,l);let g=0;for(let e=0;e<t.mipmapCount;e++){let i=new Int32Array(h,E,1)[0];E+=4;for(let o=0;o<6;o++){let l=a[o];if(u){let t=new Uint8Array(h,E,i);r.compressedTexImage2D(l,e,n,m,d,0,t),g+=t.byteLength}else{let a=this.getFormatPixelsParams(t.format),n=i/a.typedSize,o=new a.dataTypedCons(h,E,n);r.texSubImage2D(l,e,0,0,m,d,s,_,o),g+=o.byteLength}E+=i,E+=3-(i+3)%4}m=Math.max(1,.5*m),d=Math.max(1,.5*d)}e.gpuMemory=g,this._engine._bindTexture(e.target,null),c||r.pixelStorei(r.UNPACK_ALIGNMENT,4)}getCubeKTXRGBMData(e,t){let r=this._gl;const a=[r.TEXTURE_CUBE_MAP_POSITIVE_X,r.TEXTURE_CUBE_MAP_NEGATIVE_X,r.TEXTURE_CUBE_MAP_POSITIVE_Y,r.TEXTURE_CUBE_MAP_NEGATIVE_Y,r.TEXTURE_CUBE_MAP_POSITIVE_Z,r.TEXTURE_CUBE_MAP_NEGATIVE_Z];let i=e.target,n=e.internalFormat,s=e.format,_=e.type,o=e.mipmapCount,l=e.width,h=e.height;e.maxMipmapLevel=o-1;let u=t.source,m=t.compress,d=l,E=h,c=t.headerOffset+t.bytesOfKeyValueData,g=l%4==0&&h%4==0;g||r.pixelStorei(r.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),m||r.texStorage2D(i,t.mipmapCount,n,l,h);let f=0;for(let e=0;e<t.mipmapCount;e++){let i=new Int32Array(u,c,1)[0];c+=4;for(let n=0;n<6;n++){let o=a[n],l=this.getFormatPixelsParams(t.format),h=i/l.typedSize,m=new l.dataTypedCons(u,c,h);r.texSubImage2D(o,e,0,0,d,E,s,_,m),f+=m.byteLength}c+=i,c+=3-(i+3)%4}d=Math.max(1,.5*d),E=Math.max(1,.5*E),e.gpuMemory=f,this._engine._bindTexture(e.target,null),g||r.pixelStorei(r.UNPACK_ALIGNMENT,4)}setTextureCompareMode(e,r){let a=this._gl;switch(r){case t.TextureCompareMode.LEQUAL:e._setTexParameteri(a.TEXTURE_COMPARE_FUNC,a.LEQUAL),e._setTexParameteri(a.TEXTURE_COMPARE_MODE,a.COMPARE_REF_TO_TEXTURE);break;case t.TextureCompareMode.GEQUAL:e._setTexParameteri(a.TEXTURE_COMPARE_FUNC,a.GEQUAL),e._setTexParameteri(a.TEXTURE_COMPARE_MODE,a.COMPARE_REF_TO_TEXTURE);break;case t.TextureCompareMode.LESS:e._setTexParameteri(a.TEXTURE_COMPARE_FUNC,a.LESS),e._setTexParameteri(a.TEXTURE_COMPARE_MODE,a.COMPARE_REF_TO_TEXTURE);break;case t.TextureCompareMode.GREATER:e._setTexParameteri(a.TEXTURE_COMPARE_FUNC,a.GREATER),e._setTexParameteri(a.TEXTURE_COMPARE_MODE,a.COMPARE_REF_TO_TEXTURE);break;case t.TextureCompareMode.EQUAL:e._setTexParameteri(a.TEXTURE_COMPARE_FUNC,a.EQUAL),e._setTexParameteri(a.TEXTURE_COMPARE_MODE,a.COMPARE_REF_TO_TEXTURE);break;case t.TextureCompareMode.NOTEQUAL:e._setTexParameteri(a.TEXTURE_COMPARE_FUNC,a.NOTEQUAL),e._setTexParameteri(a.TEXTURE_COMPARE_MODE,a.COMPARE_REF_TO_TEXTURE);break;case t.TextureCompareMode.ALWAYS:e._setTexParameteri(a.TEXTURE_COMPARE_FUNC,a.ALWAYS),e._setTexParameteri(a.TEXTURE_COMPARE_MODE,a.COMPARE_REF_TO_TEXTURE);break;case t.TextureCompareMode.NEVER:e._setTexParameteri(a.TEXTURE_COMPARE_FUNC,a.NEVER),e._setTexParameteri(a.TEXTURE_COMPARE_MODE,a.COMPARE_REF_TO_TEXTURE);break;case t.TextureCompareMode.None:default:e._setTexParameteri(a.TEXTURE_COMPARE_FUNC,a.LEQUAL),e._setTexParameteri(a.TEXTURE_COMPARE_MODE,a.NONE)}return r}createRenderbuffer(e,t,r,a){let i=this._gl,n=i.createRenderbuffer();return i.bindRenderbuffer(i.RENDERBUFFER,n),a>1?i.renderbufferStorageMultisample(i.RENDERBUFFER,a,r,e,t):i.renderbufferStorage(i.RENDERBUFFER,r,e,t),i.bindRenderbuffer(i.RENDERBUFFER,null),n}createRenderTextureInternal(e,r,a,i,n,s){n=n&&this.supportGenerateMipmap(i);let _=this.isSRGBFormat(i)||s&&this.supportSRGB(i,n),o=this.getTarget(e),l=new WebGLInternalTex(this._engine,o,r,a,1,e,n,_,1),h=this.glRenderTextureParam(i,_);l.internalFormat=h.internalFormat,l.format=h.format,l.type=h.type;let u=l.internalFormat;l.format,l.type;let m=this._gl;return this._engine._bindTexture(l.target,l.resource),m.texStorage2D(o,l.mipmapCount,u,r,a),this._engine._bindTexture(l.target,null),i!=t.RenderTargetFormat.DEPTH_16&&i!=t.RenderTargetFormat.DEPTH_32&&i!=t.RenderTargetFormat.DEPTHSTENCIL_24_8||(l.filterMode=t.FilterMode.Point),l}createRenderTargetInternal(e,r,a,i,n,s,_){let o=this.createRenderTextureInternal(t.TextureDimension.Tex2D,e,r,a,n,s),l=new WebGLInternalRT(this._engine,a,i,!1,o.mipmap,_);l.gpuMemory=this.getGLRTTexMemory(e,r,a,i,n,_,!1),l._textures.push(o);let h=l._gl;if(l._samples>1){let t=l._msaaFramebuffer,n=this.glRenderBufferParam(a,s),_=l._msaaRenderbuffer=this.createRenderbuffer(e,r,n.internalFormat,l._samples);h.bindFramebuffer(h.FRAMEBUFFER,t),h.framebufferRenderbuffer(h.FRAMEBUFFER,n.attachment,h.RENDERBUFFER,_);let u=this.glRenderBufferParam(i,!1);if(u){let t=this.createRenderbuffer(e,r,u.internalFormat,l._samples);l._depthbuffer=t,h.framebufferRenderbuffer(h.FRAMEBUFFER,u.attachment,h.RENDERBUFFER,t)}h.bindFramebuffer(h.FRAMEBUFFER,null);let m=l._framebuffer;h.bindFramebuffer(h.FRAMEBUFFER,m);let d=this.glRenderTargetAttachment(a);h.framebufferTexture2D(h.FRAMEBUFFER,d,h.TEXTURE_2D,o.resource,0),h.bindFramebuffer(h.FRAMEBUFFER,null)}else{let t=l._framebuffer;h.bindFramebuffer(h.FRAMEBUFFER,t);let n=this.glRenderTargetAttachment(a);h.framebufferTexture2D(h.FRAMEBUFFER,n,h.TEXTURE_2D,o.resource,0);let s=this.glRenderBufferParam(i,!1);if(s){let t=this.createRenderbuffer(e,r,s.internalFormat,l._samples);l._depthbuffer=t,h.framebufferRenderbuffer(h.FRAMEBUFFER,s.attachment,h.RENDERBUFFER,t)}h.bindFramebuffer(h.FRAMEBUFFER,null)}return l}createRenderTargetCubeInternal(e,r,a,i,n,s){let _=this.createRenderTextureCubeInternal(t.TextureDimension.Cube,e,r,i,n),o=new WebGLInternalRT(this._engine,r,a,!0,_.mipmap,s);o.gpuMemory=this.getGLRTTexMemory(e,e,r,a,i,s,!0),o.colorFormat=r,o.depthStencilFormat=a,o._textures.push(_),o.isSRGB=n;let l=o._gl;if(o._samples>1){let t=o._msaaFramebuffer,i=this.glRenderBufferParam(r,!1),n=o._msaaRenderbuffer=this.createRenderbuffer(e,e,i.internalFormat,o._samples);l.bindFramebuffer(l.FRAMEBUFFER,t),l.framebufferRenderbuffer(l.FRAMEBUFFER,i.attachment,l.RENDERBUFFER,n);let s=this.glRenderBufferParam(a,!1);if(s){let t=this.createRenderbuffer(e,e,s.internalFormat,o._samples);o._depthbuffer=t,l.framebufferRenderbuffer(l.FRAMEBUFFER,s.attachment,l.RENDERBUFFER,t)}l.bindFramebuffer(l.FRAMEBUFFER,null)}else{let t=o._framebuffer;l.bindFramebuffer(l.FRAMEBUFFER,t);let r=this.glRenderBufferParam(a,!1);if(r){let t=this.createRenderbuffer(e,e,r.internalFormat,o._samples);o._depthbuffer=t,l.framebufferRenderbuffer(l.FRAMEBUFFER,r.attachment,l.RENDERBUFFER,t)}l.bindFramebuffer(l.FRAMEBUFFER,null)}return o}createRenderTextureCubeInternal(e,t,r,a,i){a=a&&this.supportGenerateMipmap(r);let n=this.isSRGBFormat(r)||i&&this.supportSRGB(r,a),s=this.getTarget(e),_=new WebGLInternalTex(this._engine,s,t,t,1,e,a,n,1),o=this.glRenderTextureParam(r,n);_.internalFormat=o.internalFormat,_.format=o.format,_.type=o.type;let l=_.internalFormat;_.format,_.type;let h=this._gl;return this._engine._bindTexture(_.target,_.resource),h.texStorage2D(s,_.mipmapCount,l,t,t),this._engine._bindTexture(_.target,null),_}bindRenderTarget(e,t=0){this.currentActiveRT&&this.unbindRenderTarget(this.currentActiveRT);let r=this._gl;if(e._isCube){let a=e._framebuffer;r.bindFramebuffer(r.FRAMEBUFFER,a);let i=e._textures[0];r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_CUBE_MAP_POSITIVE_X+t,i.resource,0)}if(e._samples>1)r.bindFramebuffer(r.FRAMEBUFFER,e._msaaFramebuffer);else{let t=e._framebuffer;r.bindFramebuffer(r.FRAMEBUFFER,t)}this.currentActiveRT=e}unbindRenderTarget(e){let t=this._gl;if(e._samples>1){t.bindFramebuffer(t.READ_FRAMEBUFFER,e._msaaFramebuffer),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,e._framebuffer);let r=e._textures[0],a=t.COLOR_BUFFER_BIT;e._depthTexture&&(a|=t.DEPTH_BUFFER_BIT),t.blitFramebuffer(0,0,r.width,r.height,0,0,r.width,r.height,a,t.NEAREST)}e._generateMipmap&&e._textures.forEach((e=>{let r=e.target;this._engine._bindTexture(r,e.resource),t.generateMipmap(r),this._engine._bindTexture(r,null)})),t.bindFramebuffer(t.FRAMEBUFFER,null),this.currentActiveRT=null}}class GLBuffer extends GLObject{constructor(e,r,a){super(e),this._byteLength=0,this._glTargetType=r,this._glBufferUsageType=a,this._getGLTarget(this._glTargetType),this._getGLUsage(this._glBufferUsageType),this._glBuffer=this._gl.createBuffer(),WebGLEngine.instance._addStatisticsInfo(t.GPUEngineStatisticsInfo.RC_GPUBuffer,1)}_getGLUsage(e){switch(e){case t.BufferUsage.Static:this._glUsage=this._gl.STATIC_DRAW;break;case t.BufferUsage.Dynamic:this._glUsage=this._gl.DYNAMIC_DRAW;break;case t.BufferUsage.Stream:this._glUsage=this._gl.STREAM_DRAW;break;default:console.error("usage is not standard")}}_getGLTarget(e){switch(e){case t.BufferTargetType.ARRAY_BUFFER:this._glTarget=this._gl.ARRAY_BUFFER;break;case t.BufferTargetType.UNIFORM_BUFFER:this._glTarget=this._gl.UNIFORM_BUFFER;break;case t.BufferTargetType.ELEMENT_ARRAY_BUFFER:this._glTarget=this._gl.ELEMENT_ARRAY_BUFFER}}_memorychange(e){this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.M_GPUBuffer,-this._byteLength+e)}bindBuffer(){return this._engine._getbindBuffer(this._glTargetType)!=this&&(this._gl.bindBuffer(this._glTarget,this._glBuffer),this._engine._setbindBuffer(this._glTargetType,this),!0)}unbindBuffer(){this._engine._getbindBuffer(this._glTargetType)==this&&(this._gl.bindBuffer(this._glTarget,null),this._engine._setbindBuffer(this._glTargetType,null))}orphanStorage(){this.bindBuffer(),this.setDataLength(this._byteLength)}setDataLength(e){let t=this._gl;this.bindBuffer(),this._memorychange(e),this._byteLength=e,t.bufferData(this._glTarget,this._byteLength,this._glUsage),this.unbindBuffer()}setData(e,r){let a=this._gl;this.bindBuffer(),a.bufferSubData(this._glTarget,r,e),WebGLEngine.instance._addStatisticsInfo(t.GPUEngineStatisticsInfo.C_GeometryBufferUploadCount,1),this.unbindBuffer()}setDataEx(e,r,a){let i=this._gl;this.bindBuffer(),i.bufferSubData(this._glTarget,r,e,0,a),WebGLEngine.instance._addStatisticsInfo(t.GPUEngineStatisticsInfo.C_GeometryBufferUploadCount,1),this.unbindBuffer()}bindBufferBase(e){if(this._engine._getBindUBOBuffer(e)!=this){this._gl.bindBufferBase(this._glTarget,e,this._glBuffer),this._engine._setBindUBOBuffer(e,this)}}bindBufferRange(e,t,r){this._gl.bindBufferRange(this._glTarget,e,this._glBuffer,t,r)}resizeBuffer(e){this.bindBuffer();const t=this._gl;this._byteLength=e,t.bufferData(this._glTarget,this._byteLength,this._glUsage)}destroy(){super.destroy();const e=this._gl;WebGLEngine.instance._addStatisticsInfo(t.GPUEngineStatisticsInfo.RC_GPUBuffer,-1),e.deleteBuffer(this._glBuffer),this._memorychange(0),this._byteLength=0,this._engine=null,this._glBuffer=null,this._glTarget=null,this._glUsage=null,this._gl=null}}e.WebGLMode=void 0,(a=e.WebGLMode||(e.WebGLMode={}))[a.Auto=0]="Auto",a[a.WebGL2=1]="WebGL2",a[a.WebGL1=2]="WebGL1";class GLParams{constructor(e){this._engine=e,this._gl=this._engine.gl,this._initParams()}_initParams(){const r=this._gl;this._glParamsData=new Map,this._glParamsData.set(t.RenderParams.Max_Active_Texture_Count,r.getParameter(r.MAX_VERTEX_TEXTURE_IMAGE_UNITS));const a=r.getParameter(r.MAX_VERTEX_UNIFORM_VECTORS),i=r.getParameter(r.MAX_FRAGMENT_UNIFORM_VECTORS);if(this._glParamsData.set(t.RenderParams.Max_Uniform_Count,Math.min(a,i)),this._glParamsData.set(t.RenderParams.MAX_Texture_Size,r.getParameter(r.MAX_TEXTURE_SIZE)),this._glParamsData.set(t.RenderParams.MAX_Texture_Image_Uint,r.getParameter(r.MAX_TEXTURE_IMAGE_UNITS)),this._engine.getCapable(t.RenderCapable.Texture_anisotropic)){const a=this._engine._supportCapatable.getExtension(e.WebGLExtension.EXT_texture_filter_anisotropic);this._glParamsData.set(t.RenderParams.Max_AnisoLevel_Count,r.getParameter(a.MAX_TEXTURE_MAX_ANISOTROPY_EXT))}this._engine.isWebGL2?this._glParamsData.set(t.RenderParams.SHADER_CAPAILITY_LEVEL,35):this._glParamsData.set(t.RenderParams.SHADER_CAPAILITY_LEVEL,30),this._glParamsData.set(t.RenderParams.FLOAT,r.FLOAT),this._glParamsData.set(t.RenderParams.UNSIGNED_BYTE,r.UNSIGNED_BYTE),this._glParamsData.set(t.RenderParams.UNSIGNED_SHORT,r.UNSIGNED_SHORT),this._glParamsData.set(t.RenderParams.BYTE,r.BYTE)}getParams(e){return this._glParamsData.get(e)}}class GLRenderDrawContext extends GLObject{constructor(t){super(t),this._engine.isWebGL2||(this._angleInstancedArrays=this._engine._supportCapatable.getExtension(e.WebGLExtension.ANGLE_instanced_arrays))}getMeshTopology(e){switch(e){case t.MeshTopology.Points:return this._gl.POINTS;case t.MeshTopology.Lines:return this._gl.LINES;case t.MeshTopology.LineLoop:return this._gl.LINE_LOOP;case t.MeshTopology.LineStrip:return this._gl.LINE_STRIP;case t.MeshTopology.Triangles:return this._gl.TRIANGLES;case t.MeshTopology.TriangleStrip:return this._gl.TRIANGLE_STRIP;case t.MeshTopology.TriangleFan:return this._gl.TRIANGLE_FAN}}getIndexType(e){switch(e){case t.IndexFormat.UInt8:return this._gl.UNSIGNED_BYTE;case t.IndexFormat.UInt16:return this._gl.UNSIGNED_SHORT;case t.IndexFormat.UInt32:return this._gl.UNSIGNED_INT}}drawElementsInstanced(e,r,a,i,n){this._engine.isWebGL2?this._gl.drawElementsInstanced(e,r,a,i,n):this._angleInstancedArrays.drawElementsInstancedANGLE(e,r,a,i,n),this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.C_DrawCallCount,1),this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.C_Instancing_DrawCallCount,1),this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.C_TriangleCount,r/3*n)}drawArraysInstanced(e,r,a,i){this._engine.isWebGL2?this._gl.drawArraysInstanced(e,r,a,i):this._angleInstancedArrays.drawArraysInstancedANGLE(e,r,a,i),this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.C_DrawCallCount,1),this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.C_Instancing_DrawCallCount,1),this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.C_TriangleCount,(a-2)*i)}drawArrays(e,r,a){this._gl.drawArrays(e,r,a),this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.C_DrawCallCount,1),this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.C_TriangleCount,a-2)}drawElements(e,r,a,i){this._gl.drawElements(e,r,a,i),this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.C_DrawCallCount,1),this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.C_TriangleCount,r/3)}drawElements2DTemp(e,r,a,i){e=this.getMeshTopology(e),a=this.getIndexType(a),this._gl.drawElements(e,r,a,i),this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.C_DrawCallCount,1),this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.C_TriangleCount,r/3)}drawGeometryElement(e){e.bufferState.bind();let r=e.drawParams.elements,a=e.drawParams.length;switch(e.drawType){case t.DrawType.DrawArray:for(let t=0;t<a;t+=2)this.drawArrays(e._glmode,r[t],r[t+1]);break;case t.DrawType.DrawElement:for(let t=0;t<a;t+=2)this.drawElements(e._glmode,r[t+1],e._glindexFormat,r[t]);break;case t.DrawType.DrawArrayInstance:for(let t=0;t<a;t+=2)this.drawArraysInstanced(e._glmode,r[t],r[t+1],e.instanceCount);break;case t.DrawType.DrawElementInstance:for(let t=0;t<a;t+=2)this.drawElementsInstanced(e._glmode,r[t+1],e._glindexFormat,r[t],e.instanceCount)}}}class GLRenderState{constructor(e){this._engine=e,this._gl=this._engine.gl}_initState(){this.setDepthFunc(t.CompareFunction.Less),this.setBlendEquationSeparate(t.BlendEquationSeparate.ADD,t.BlendEquationSeparate.ADD),this._blendEquation=t.BlendEquationSeparate.ADD,this._sFactor=t.BlendFactor.One,this._dFactor=t.BlendFactor.Zero,this._sFactorAlpha=t.BlendFactor.One,this._dFactorAlpha=t.BlendFactor.One}_getBlendFactor(e){const r=this._gl;switch(e){case t.BlendFactor.Zero:return r.ZERO;case t.BlendFactor.One:return r.ONE;case t.BlendFactor.SourceColor:return r.SRC_COLOR;case t.BlendFactor.OneMinusSourceColor:return r.ONE_MINUS_SRC_COLOR;case t.BlendFactor.DestinationColor:return r.DST_COLOR;case t.BlendFactor.OneMinusDestinationColor:return r.ONE_MINUS_DST_COLOR;case t.BlendFactor.SourceAlpha:return r.SRC_ALPHA;case t.BlendFactor.OneMinusSourceAlpha:return r.ONE_MINUS_SRC_ALPHA;case t.BlendFactor.DestinationAlpha:return r.DST_ALPHA;case t.BlendFactor.OneMinusDestinationAlpha:return r.ONE_MINUS_DST_ALPHA;case t.BlendFactor.SourceAlphaSaturate:return r.SRC_ALPHA_SATURATE;case t.BlendFactor.BlendColor:return r.CONSTANT_COLOR;case t.BlendFactor.OneMinusBlendColor:return r.ONE_MINUS_CONSTANT_COLOR}}_getBlendOperation(e){const r=this._gl;switch(e){case t.BlendEquationSeparate.ADD:return r.FUNC_ADD;case t.BlendEquationSeparate.SUBTRACT:return r.FUNC_SUBTRACT;case t.BlendEquationSeparate.REVERSE_SUBTRACT:return r.FUNC_REVERSE_SUBTRACT;default:throw"Unknow type"}}_getGLCompareFunction(e){const r=this._gl;switch(e){case t.CompareFunction.Never:return r.NEVER;case t.CompareFunction.Less:return r.LESS;case t.CompareFunction.Equal:return r.EQUAL;case t.CompareFunction.LessEqual:return r.LEQUAL;case t.CompareFunction.Greater:return r.GREATER;case t.CompareFunction.NotEqual:return r.NOTEQUAL;case t.CompareFunction.GreaterEqual:return r.GEQUAL;case t.CompareFunction.Always:return r.ALWAYS;default:return r.LEQUAL}}_getGLStencilOperation(e){const r=this._gl;switch(e){case t.StencilOperation.Keep:return r.KEEP;case t.StencilOperation.Zero:return r.ZERO;case t.StencilOperation.Replace:return r.REPLACE;case t.StencilOperation.IncrementSaturate:return r.INCR;case t.StencilOperation.DecrementSaturate:return r.DECR;case t.StencilOperation.Invert:return r.INVERT;case t.StencilOperation.IncrementWrap:return r.INCR_WRAP;case t.StencilOperation.DecrementWrap:return r.DECR_WRAP}}_getGLFrontfaceFactor(e){return e==t.CullMode.Front?this._gl.CCW:this._gl.CW}setDepthTest(e){e!==this._depthTest&&(this._depthTest=e,e?this._gl.enable(this._gl.DEPTH_TEST):this._gl.disable(this._gl.DEPTH_TEST))}setDepthMask(e){e!==this._depthMask&&(this._depthMask=e,this._gl.depthMask(e))}setDepthFunc(e){e!==this._depthFunc&&(this._depthFunc=e,this._gl.depthFunc(this._getGLCompareFunction(e)))}setStencilTest(e){e!==this._stencilTest&&(this._stencilTest=e,e?this._gl.enable(this._gl.STENCIL_TEST):this._gl.disable(this._gl.STENCIL_TEST))}setStencilMask(e){e!==this._stencilMask&&(this._stencilMask=e,e?this._gl.stencilMask(255):this._gl.stencilMask(0))}setStencilFunc(e,t){e==this._stencilFunc&&t==this._stencilRef||(this._stencilFunc=e,this._stencilRef=t,this._gl.stencilFunc(this._getGLCompareFunction(e),t,255))}setstencilOp(e,t,r){this._stencilOp_fail==e&&this._stencilOp_zfail==t&&this._stencilOp_zpass==r||(this._stencilOp_fail=e,this._stencilOp_zfail=t,this._stencilOp_zpass=r,this._gl.stencilOp(this._getGLStencilOperation(e),this._getGLStencilOperation(t),this._getGLStencilOperation(r)))}setBlend(e){e!==this._blend&&(this._blend=e,e?this._gl.enable(this._gl.BLEND):this._gl.disable(this._gl.BLEND))}setBlendEquation(e){e!==this._blendEquation&&(this._blendEquation=e,this._blendEquationRGB=this._blendEquationAlpha=null,this._gl.blendEquation(this._getBlendOperation(e)))}setBlendEquationSeparate(e,t){e===this._blendEquationRGB&&t===this._blendEquationAlpha||(this._blendEquationRGB=e,this._blendEquationAlpha=t,this._blendEquation=null,this._gl.blendEquationSeparate(this._getBlendOperation(e),this._getBlendOperation(t)))}setBlendFunc(e,t,r=!1){(r||e!==this._sFactor||t!==this._dFactor)&&(this._sFactor=e,this._dFactor=t,this._sFactorRGB=null,this._dFactorRGB=null,this._sFactorAlpha=null,this._dFactorAlpha=null,this._gl.blendFunc(this._getBlendFactor(e),this._getBlendFactor(t)))}setBlendFuncSeperate(e,t,r,a){e===this._sFactorRGB&&t===this._dFactorRGB&&r===this._sFactorAlpha&&a===this._dFactorAlpha||(this._sFactorRGB=e,this._dFactorRGB=t,this._sFactorAlpha=r,this._dFactorAlpha=a,this._sFactor=null,this._dFactor=null,this._gl.blendFuncSeparate(this._getBlendFactor(e),this._getBlendFactor(t),this._getBlendFactor(r),this._getBlendFactor(a)))}setCullFace(e){e!==this._cullFace&&(this._cullFace=e,e?this._gl.enable(this._gl.CULL_FACE):this._gl.disable(this._gl.CULL_FACE))}setFrontFace(e){e!==this._frontFace&&(this._frontFace=e,this._gl.frontFace(this._getGLFrontfaceFactor(e)))}}class GLShaderInstance extends GLObject{constructor(e,t,r,a){super(e),this._complete=!0,this._vs=t,this._ps=r,this._attributeMap=a,this._uniformMap=[],this._create()}_create(){WebGLEngine.instance._addStatisticsInfo(t.GPUEngineStatisticsInfo.C_ShaderCompile,1);let e=performance.now();const r=this._gl;if(WebGLEngine.instance.lost)return void console.log("lost webgl context");for(var a in this._program=r.createProgram(),this._vshader=this._createShader(r,this._vs,r.VERTEX_SHADER),this._pshader=this._createShader(r,this._ps,r.FRAGMENT_SHADER),r.attachShader(this._program,this._vshader),r.attachShader(this._program,this._pshader),this._attributeMap)r.bindAttribLocation(this._program,this._attributeMap[a][0],a);r.linkProgram(this._program);if(!r.getProgramParameter(this._program,r.LINK_STATUS)){var i=r.getProgramInfoLog(this._program);return console.error(new Error("Could not compile WebGL program. \n\n"+i)),void(this._complete=!1)}const n=r.getProgramParameter(this._program,r.ACTIVE_UNIFORMS);let s,_;for(this.useProgram(),this._curActTexIndex=0,_=0;_<n;_++){var o=r.getActiveUniform(this._program,_),l=o.name;let e=r.getUniformLocation(this._program,l);(e||0==e)&&(s=new t.ShaderVariable,s.location=e,l.indexOf("[0]")>0?(s.name=l=l.substr(0,l.length-3),s.isArray=!0):(s.name=l,s.isArray=!1),s.type=o.type,this._addShaderUnifiormFun(s),this._uniformMap.push(s),s.dataOffset=this._engine.propertyNameToID(l))}if(this._engine.isWebGL2){this._uniformObjectMap={};var h=r.getProgramParameter(this._program,r.ACTIVE_UNIFORM_BLOCKS);for(_=0;_<h;_++){let e=r;var u=e.getActiveUniformBlockName(this._program,_);s=new t.ShaderVariable,s.name=u,s.isArray=!1,s.type=r.UNIFORM_BUFFER,s.dataOffset=this._engine.propertyNameToID(u);let a=s.location=e.getUniformBlockIndex(this._program,u);e.uniformBlockBinding(this._program,a,this._engine.getUBOPointer(u)),this._uniformObjectMap[s.name]=s,this._uniformMap.push(s),this._addShaderUnifiormFun(s)}}WebGLEngine.instance._addStatisticsInfo(t.GPUEngineStatisticsInfo.T_ShaderCompile,performance.now()-e|0)}_legalUBObyteLength(e){return 16*Math.ceil(e/16)}_createShader(e,r,a){var i=e.createShader(a);return e.shaderSource(i,r),e.compileShader(i),this._engine._isShaderDebugMode&&!e.getShaderParameter(i,e.COMPILE_STATUS)&&(t.LayaEnv.isPlaying?console.error(e.getShaderInfoLog(i)):console.warn(e.getShaderInfoLog(i))),i}_addShaderUnifiormFun(e){var t=this._gl;e.caller=this;var r=e.isArray;switch(e.type){case t.BOOL:e.fun=this._uniform1i,e.uploadedValue=new Array(1);break;case t.INT:e.fun=r?this._uniform1iv:this._uniform1i,e.uploadedValue=new Array(1);break;case t.FLOAT:e.fun=r?this._uniform1fv:this._uniform1f,e.uploadedValue=new Array(1);break;case t.FLOAT_VEC2:e.fun=r?this._uniform_vec2v:this._uniform_vec2,e.uploadedValue=new Array(2);break;case t.FLOAT_VEC3:e.fun=r?this._uniform_vec3v:this._uniform_vec3,e.uploadedValue=new Array(3);break;case t.FLOAT_VEC4:e.fun=r?this._uniform_vec4v:this._uniform_vec4,e.uploadedValue=new Array(4);break;case t.FLOAT_MAT2:e.fun=this._uniformMatrix2fv;break;case t.FLOAT_MAT3:e.fun=this._uniformMatrix3fv;break;case t.FLOAT_MAT4:e.fun=r?this._uniformMatrix4fv:this._uniformMatrix4f;break;case t.SAMPLER_2D:case t.SAMPLER_2D_SHADOW:t.uniform1i(e.location,this._curActTexIndex),e.textureID=this._engine._glTextureIDParams[this._curActTexIndex++],e.fun=this._uniform_sampler2D;break;case t.SAMPLER_2D_ARRAY:t.uniform1i(e.location,this._curActTexIndex),e.textureID=this._engine._glTextureIDParams[this._curActTexIndex++],e.fun=this._uniform_sampler2DArray;break;case 35679:t.uniform1i(e.location,this._curActTexIndex),e.textureID=this._engine._glTextureIDParams[this._curActTexIndex++],e.fun=this._uniform_sampler3D;break;case t.SAMPLER_CUBE:t.uniform1i(e.location,this._curActTexIndex),e.textureID=this._engine._glTextureIDParams[this._curActTexIndex++],e.fun=this._uniform_samplerCube;break;case t.UNIFORM_BUFFER:e.fun=this._uniform_UniformBuffer;break;default:throw new Error("compile shader err!")}}getUniformMap(){return this._uniformMap}bind(){return this.useProgram()}useProgram(){return this._engine._glUseProgram!==this&&(this._gl.useProgram(this._program),this._engine._glUseProgram=this,WebGLEngine.instance._addStatisticsInfo(t.GPUEngineStatisticsInfo.C_SetRenderPassCount,1),!0)}_uniform1f(e,t){var r=e.uploadedValue;return r[0]!==t?(this._gl.uniform1f(e.location,r[0]=t),1):0}_uniform1fv(e,t){if(t.length<4){var r=e.uploadedValue;return r[0]!==t[0]||r[1]!==t[1]||r[2]!==t[2]||r[3]!==t[3]?(this._gl.uniform1fv(e.location,t),r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],1):0}return this._gl.uniform1fv(e.location,t),1}_uniform_vec2(e,t){var r=e.uploadedValue;return r[0]!==t.x||r[1]!==t.y?(this._gl.uniform2f(e.location,r[0]=t.x,r[1]=t.y),1):0}_uniform_vec2v(e,t){if(t.length<2){var r=e.uploadedValue;return r[0]!==t[0]||r[1]!==t[1]||r[2]!==t[2]||r[3]!==t[3]?(this._gl.uniform2fv(e.location,t),r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],1):0}return this._gl.uniform2fv(e.location,t),1}_uniform_vec3(e,t){var r=e.uploadedValue;return r[0]!==t.x||r[1]!==t.y||r[2]!==t.z?(this._gl.uniform3f(e.location,r[0]=t.x,r[1]=t.y,r[2]=t.z),1):0}_uniform_vec3v(e,t){return this._gl.uniform3fv(e.location,t),1}_uniform_vec4(e,t){var r=e.uploadedValue;return r[0]!==t.x||r[1]!==t.y||r[2]!==t.z||r[3]!==t.w?(this._gl.uniform4f(e.location,r[0]=t.x,r[1]=t.y,r[2]=t.z,r[3]=t.w),1):0}_uniform_vec4v(e,t){return this._gl.uniform4fv(e.location,t),1}_uniformMatrix2fv(e,t){return this._gl.uniformMatrix2fv(e.location,!1,t),1}_uniformMatrix3fv(e,t){let r=t.elements;return this._gl.uniformMatrix3fv(e.location,!1,r),1}_uniformMatrix4f(e,t){var r=t.elements;return this._gl.uniformMatrix4fv(e.location,!1,r),1}_uniformMatrix4fv(e,t){return this._gl.uniformMatrix4fv(e.location,!1,t),1}_uniform1i(e,t){var r=e.uploadedValue;return r[0]!==t?(this._gl.uniform1i(e.location,r[0]=t),1):0}_uniform1iv(e,t){return this._gl.uniform1iv(e.location,t),1}_uniform_ivec2(e,t){var r=e.uploadedValue;return r[0]!==t[0]||r[1]!==t[1]?(this._gl.uniform2i(e.location,r[0]=t[0],r[1]=t[1]),1):0}_uniform_ivec2v(e,t){return this._gl.uniform2iv(e.location,t),1}_uniform_vec3i(e,t){var r=e.uploadedValue;return r[0]!==t[0]||r[1]!==t[1]||r[2]!==t[2]?(this._gl.uniform3i(e.location,r[0]=t[0],r[1]=t[1],r[2]=t[2]),1):0}_uniform_vec3vi(e,t){return this._gl.uniform3iv(e.location,t),1}_uniform_vec4i(e,t){var r=e.uploadedValue;return r[0]!==t[0]||r[1]!==t[1]||r[2]!==t[2]||r[3]!==t[3]?(this._gl.uniform4i(e.location,r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3]),1):0}_uniform_vec4vi(e,t){return this._gl.uniform4iv(e.location,t),1}_uniform_sampler2D(e,r){var a=r?r._getSource():t.Texture2D.errorTexture._getSource(),i=this._gl;return this._bindTexture(e.textureID,i.TEXTURE_2D,a),0}_uniform_sampler2DArray(e,r){var a=r?r._getSource():t.Texture2D.errorTexture._getSource(),i=this._gl;return this._bindTexture(e.textureID,i.TEXTURE_2D_ARRAY,a),0}_uniform_sampler3D(e,r){var a=r?r._getSource():t.Texture2D.errorTexture._getSource(),i=this._gl;return this._bindTexture(e.textureID,i.TEXTURE_3D,a),0}_uniform_samplerCube(e,r){var a=r?r._getSource():t.TextureCube.errorTexture._getSource(),i=this._gl;return this._bindTexture(e.textureID,i.TEXTURE_CUBE_MAP,a),0}_uniform_UniformBuffer(e,t){return t._bindUniformBufferBase(),1}_bindTexture(e,t,r){const a=this._gl;this._engine._activedTextureID!==e&&(a.activeTexture(e),this._engine._activedTextureID=e);const i=this._engine._activedTextureID-this._gl.TEXTURE0;this._engine._activeTextures[i]!==r&&(a.bindTexture(t,r),this._engine._activeTextures[i]=r)}destroy(){super.destroy();const e=this._gl;e.deleteShader(this._vshader),e.deleteShader(this._pshader),e.deleteProgram(this._program),this._vshader=null,this._pshader=null,this._program=null,this._attributeMap=null,this._uniformMap=null,this._uniformObjectMap=null,this._gl=null,this._engine=null}}class GLVertexState extends GLObject{constructor(t){super(t),this._vertexDeclaration=[],t.isWebGL2||(this._vaoExt=t._supportCapatable.getExtension(e.WebGLExtension.OES_vertex_array_object)),this._vao=this.createVertexArray(),this._angleInstancedArrays=this._engine._supportCapatable.getExtension(e.WebGLExtension.ANGLE_instanced_arrays)}createVertexArray(){return this._engine.isWebGL2?this._gl.createVertexArray():this._vaoExt.createVertexArrayOES()}deleteVertexArray(){this._engine.isWebGL2?this._gl.deleteVertexArray(this._vao):this._vaoExt.deleteVertexArrayOES(this._vao)}bindVertexArray(){this._engine._GLBindVertexArray!=this&&(this._engine.isWebGL2?this._gl.bindVertexArray(this._vao):this._vaoExt.bindVertexArrayOES(this._vao),this._engine._GLBindVertexArray=this)}unbindVertexArray(){this._engine.isWebGL2?this._gl.bindVertexArray(null):this._vaoExt.bindVertexArrayOES(null),this._engine._GLBindVertexArray=null}isVertexArray(){this._engine.isWebGL2?this._gl.isVertexArray(this._vao):this._vaoExt.isVertexArrayOES(this._vao)}applyVertexBuffer(e){if(this.clearVAO(),this._vertexBuffers=e,this._engine._GLBindVertexArray!=this)throw"BufferState: must call bind() function first.";this._vertexDeclaration.length=e.length;var t=0;e.forEach((e=>{var r=e._shaderValues;for(var a in this._vertexDeclaration[t++]=e._shaderValues,e.bind(),r){var i=parseInt(a),n=r[a];this._gl.enableVertexAttribArray(i),this._gl.vertexAttribPointer(i,n.elementCount,n.elementType,!!n.normalized,n.vertexStride,n.elementOffset),e.instanceBuffer&&this.vertexAttribDivisor(i,1)}}))}clearVAO(){for(let a=0,i=this._vertexDeclaration.length;a<i;a++){var e=this._vertexDeclaration[a];for(var t in e){var r=parseInt(t);this._gl.disableVertexAttribArray(r)}}}applyIndexBuffer(e){if(null!=e){if(this._engine._GLBindVertexArray!=this)throw"BufferState: must call bind() function first.";this._bindedIndexBuffer!==e&&(e._glBuffer.bindBuffer(),this._bindedIndexBuffer=e)}}vertexAttribDivisor(e,t){this._engine.isWebGL2?this._gl.vertexAttribDivisor(e,t):this._angleInstancedArrays.vertexAttribDivisorANGLE(e,t)}destroy(){super.destroy(),this._gl,this.deleteVertexArray(),this._gl=null,this._engine=null}}!function(){var e={};function synthesizeGLError(t,r){var a;e[t]=!0,void 0!==r&&(a=r,window.console&&window.console.error&&window.console.error(a))}var t=function WebGLVertexArrayObjectOES(e){var t=e.gl;this.ext=e,this.isAlive=!0,this.hasBeenBound=!1,this.elementArrayBuffer=null,this.attribs=new Array(e.maxVertexAttribs);for(var r=0;r<this.attribs.length;r++){var a=new WebGLVertexArrayObjectOES.VertexAttrib(t);this.attribs[r]=a}this.maxAttrib=0};(t.VertexAttrib=function(e){this.enabled=!1,this.buffer=null,this.size=4,this.type=e.FLOAT,this.normalized=!1,this.stride=16,this.offset=0,this.cached="",this.recache()}).prototype.recache=function(){this.cached=[this.size,this.type,this.normalized,this.stride,this.offset].join(":")};var OESVertexArrayObject=function(t){var r=this;this.gl=t,function(t){var r=t.getError;t.getError=function(){var a;do{(a=r.apply(t))!=t.NO_ERROR&&(e[a]=!0)}while(a!=t.NO_ERROR);for(var i in e)if(e[i])return delete e[i],parseInt(i);return t.NO_ERROR}}(t);var a=this.original={getParameter:t.getParameter,enableVertexAttribArray:t.enableVertexAttribArray,disableVertexAttribArray:t.disableVertexAttribArray,bindBuffer:t.bindBuffer,getVertexAttrib:t.getVertexAttrib,vertexAttribPointer:t.vertexAttribPointer};t.getParameter=function(e){return e==r.VERTEX_ARRAY_BINDING_OES?r.currentVertexArrayObject==r.defaultVertexArrayObject?null:r.currentVertexArrayObject:a.getParameter.apply(this,arguments)},t.enableVertexAttribArray=function(e){var t=r.currentVertexArrayObject;t.maxAttrib=Math.max(t.maxAttrib,e);var i=t.attribs[e];return i.enabled=!0,a.enableVertexAttribArray.apply(this,arguments)},t.disableVertexAttribArray=function(e){var t=r.currentVertexArrayObject;t.maxAttrib=Math.max(t.maxAttrib,e);var i=t.attribs[e];return i.enabled=!1,a.disableVertexAttribArray.apply(this,arguments)},t.bindBuffer=function(e,i){switch(e){case t.ARRAY_BUFFER:r.currentArrayBuffer=i;break;case t.ELEMENT_ARRAY_BUFFER:r.currentVertexArrayObject.elementArrayBuffer=i}return a.bindBuffer.apply(this,arguments)},t.getVertexAttrib=function(e,i){var n=r.currentVertexArrayObject,s=n.attribs[e];switch(i){case t.VERTEX_ATTRIB_ARRAY_BUFFER_BINDING:return s.buffer;case t.VERTEX_ATTRIB_ARRAY_ENABLED:return s.enabled;case t.VERTEX_ATTRIB_ARRAY_SIZE:return s.size;case t.VERTEX_ATTRIB_ARRAY_STRIDE:return s.stride;case t.VERTEX_ATTRIB_ARRAY_TYPE:return s.type;case t.VERTEX_ATTRIB_ARRAY_NORMALIZED:return s.normalized;default:return a.getVertexAttrib.apply(this,arguments)}},t.vertexAttribPointer=function(e,t,i,n,s,_){var o=r.currentVertexArrayObject;o.maxAttrib=Math.max(o.maxAttrib,e);var l=o.attribs[e];return l.buffer=r.currentArrayBuffer,l.size=t,l.type=i,l.normalized=n,l.stride=s,l.offset=_,l.recache(),a.vertexAttribPointer.apply(this,arguments)},t.instrumentExtension&&t.instrumentExtension(this,"OES_vertex_array_object"),t.canvas.addEventListener("webglcontextrestored",(function(){var e;e="OESVertexArrayObject emulation library context restored",window.console&&window.console.log&&window.console.log(e),r.reset_()}),!0),this.reset_()};OESVertexArrayObject.prototype.VERTEX_ARRAY_BINDING_OES=34229,OESVertexArrayObject.prototype.reset_=function(){if(void 0!==this.vertexArrayObjects)for(var e=0;e<this.vertexArrayObjects.length;++e)this.vertexArrayObjects.isAlive=!1;var r=this.gl;this.maxVertexAttribs=r.getParameter(r.MAX_VERTEX_ATTRIBS),this.defaultVertexArrayObject=new t(this),this.currentVertexArrayObject=null,this.currentArrayBuffer=null,this.vertexArrayObjects=[this.defaultVertexArrayObject],this.bindVertexArrayOES(null)},OESVertexArrayObject.prototype.createVertexArrayOES=function(){var e=new t(this);return this.vertexArrayObjects.push(e),e},OESVertexArrayObject.prototype.deleteVertexArrayOES=function(e){e.isAlive=!1,this.vertexArrayObjects.splice(this.vertexArrayObjects.indexOf(e),1),this.currentVertexArrayObject==e&&this.bindVertexArrayOES(null)},OESVertexArrayObject.prototype.isVertexArrayOES=function(e){return!!(e&&e instanceof t&&e.hasBeenBound&&e.ext==this)},OESVertexArrayObject.prototype.bindVertexArrayOES=function(e){var t=this.gl;if(!e||e.isAlive){var r=this.original,a=this.currentVertexArrayObject;this.currentVertexArrayObject=e||this.defaultVertexArrayObject,this.currentVertexArrayObject.hasBeenBound=!0;var i=this.currentVertexArrayObject;if(a!=i){a&&i.elementArrayBuffer==a.elementArrayBuffer||r.bindBuffer.call(t,t.ELEMENT_ARRAY_BUFFER,i.elementArrayBuffer);for(var n=this.currentArrayBuffer,s=Math.max(a?a.maxAttrib:0,i.maxAttrib),_=0;_<=s;_++){var o=i.attribs[_],l=a?a.attribs[_]:null;if(a&&o.enabled==l.enabled||(o.enabled?r.enableVertexAttribArray.call(t,_):r.disableVertexAttribArray.call(t,_)),o.enabled){var h=!1;a&&o.buffer==l.buffer||(n!=o.buffer&&(r.bindBuffer.call(t,t.ARRAY_BUFFER,o.buffer),n=o.buffer),h=!0),(h||o.cached!=l.cached)&&r.vertexAttribPointer.call(t,_,o.size,o.type,o.normalized,o.stride,o.offset)}}this.currentArrayBuffer!=n&&r.bindBuffer.call(t,t.ARRAY_BUFFER,this.currentArrayBuffer)}}else synthesizeGLError(t.INVALID_OPERATION,"bindVertexArrayOES: attempt to bind deleted arrayObject")},window._setupVertexArrayObject=function(e){var t=e.getSupportedExtensions;e.getSupportedExtensions=function(){var e=t.call(this)||[];return e.indexOf("OES_vertex_array_object")<0&&e.push("OES_vertex_array_object"),e};var r=e.getExtension;e.getExtension=function(e){var t=r.call(this,e);return t||("OES_vertex_array_object"!==e?null:(this.__OESVertexArrayObject||(console.log("Setup OES_vertex_array_object polyfill"),this.__OESVertexArrayObject=new OESVertexArrayObject(this)),this.__OESVertexArrayObject))}}}();class GlCapable{constructor(e){this._extentionVendorPrefixes=["","WEBKIT_","MOZ_"],this._gl=e.gl,this.initExtension(e.isWebGL2),this.initCapable(e.isWebGL2)}initCapable(r){this._capabilityMap=new Map;let a=r||!!this.getExtension(e.WebGLExtension.OES_element_index_uint);this._capabilityMap.set(t.RenderCapable.Element_Index_Uint32,a),a=r||!!this.getExtension(e.WebGLExtension.OES_texture_float),this._capabilityMap.set(t.RenderCapable.TextureFormat_R32G32B32A32,a),a=r||!!this.getExtension(e.WebGLExtension.OES_texture_half_float),this._capabilityMap.set(t.RenderCapable.TextureFormat_R16G16B16A16,a),a=!!this.getExtension(e.WebGLExtension.EXT_texture_filter_anisotropic),this._capabilityMap.set(t.RenderCapable.Texture_anisotropic,a),a=r?!!this.getExtension(e.WebGLExtension.EXT_color_buffer_float)||!!this.getExtension(e.WebGLExtension.EXT_color_buffer_half_float):!(!this.getExtension(e.WebGLExtension.OES_texture_half_float)&&!this.getExtension(e.WebGLExtension.EXT_color_buffer_half_float)||!this.getExtension(e.WebGLExtension.OES_texture_half_float_linear)),this._capabilityMap.set(t.RenderCapable.RenderTextureFormat_R16G16B16A16,a),a=r?!!this.getExtension(e.WebGLExtension.EXT_color_buffer_float)&&!!this.getExtension(e.WebGLExtension.OES_texture_float_linear):!!this.getExtension(e.WebGLExtension.OES_texture_float)&&!!this.getExtension(e.WebGLExtension.OES_texture_float_linear),this._capabilityMap.set(t.RenderCapable.RenderTextureFormat_R32G32B32A32,a),a=r||!!this.getExtension(e.WebGLExtension.WEBGL_depth_texture),this._capabilityMap.set(t.RenderCapable.RenderTextureFormat_Depth,a),a=r,this._capabilityMap.set(t.RenderCapable.RenderTextureFormat_ShadowMap,a),a=r||!!this.getExtension(e.WebGLExtension.OES_vertex_array_object),this._capabilityMap.set(t.RenderCapable.Vertex_VAO,a),a=r||!!this.getExtension(e.WebGLExtension.ANGLE_instanced_arrays),this._capabilityMap.set(t.RenderCapable.DrawElement_Instance,a),a=r||!!this.getExtension(e.WebGLExtension.EXT_shader_texture_lod),this._capabilityMap.set(t.RenderCapable.Shader_TextureLod,a),a=!!this.getExtension(e.WebGLExtension.WEBGL_compressed_texture_s3tc),this._capabilityMap.set(t.RenderCapable.COMPRESS_TEXTURE_S3TC,a),a=!!this.getExtension(e.WebGLExtension.WEBGL_compressed_texture_s3tc_srgb),this._capabilityMap.set(t.RenderCapable.COMPRESS_TEXTURE_S3TC_SRGB,a),a=!!this.getExtension(e.WebGLExtension.WEBGL_compressed_texture_pvrtc),this._capabilityMap.set(t.RenderCapable.COMPRESS_TEXTURE_PVRTC,a),a=!!this.getExtension(e.WebGLExtension.WEBGL_compressed_texture_etc1),this._capabilityMap.set(t.RenderCapable.COMPRESS_TEXTURE_ETC1,a),a=!!this.getExtension(e.WebGLExtension.WEBGL_compressed_texture_etc),this._capabilityMap.set(t.RenderCapable.COMPRESS_TEXTURE_ETC,a),a=!!this.getExtension(e.WebGLExtension.WEBGL_compressed_texture_astc),this._capabilityMap.set(t.RenderCapable.COMPRESS_TEXTURE_ASTC,a),a=r||!!this.getExtension(e.WebGLExtension.EXT_sRGB),this._capabilityMap.set(t.RenderCapable.Texture_SRGB,a),a=!!this.getExtension(e.WebGLExtension.OES_texture_float_linear),this._capabilityMap.set(t.RenderCapable.Texture_FloatLinearFiltering,a),a=r||!!this.getExtension(e.WebGLExtension.OES_texture_half_float_linear),this._capabilityMap.set(t.RenderCapable.Texture_HalfFloatLinearFiltering,a),a=r,this._capabilityMap.set(t.RenderCapable.MSAA,a),this._capabilityMap.set(t.RenderCapable.UnifromBufferObject,a),this._capabilityMap.set(t.RenderCapable.Texture3D,a)}initExtension(t){this._extensionMap=new Map;const setExtensionMap=(e,t,r)=>{t&&r.set(e,t)},r=this._getExtension("EXT_texture_filter_anisotropic");setExtensionMap(e.WebGLExtension.EXT_texture_filter_anisotropic,r,this._extensionMap);const a=this._getExtension("WEBGL_compressed_texture_s3tc");setExtensionMap(e.WebGLExtension.WEBGL_compressed_texture_s3tc,a,this._extensionMap);const i=this._getExtension("WEBGL_compressed_texture_s3tc_srgb");setExtensionMap(e.WebGLExtension.WEBGL_compressed_texture_s3tc_srgb,i,this._extensionMap);const n=this._getExtension("WEBGL_compressed_texture_pvrtc");setExtensionMap(e.WebGLExtension.WEBGL_compressed_texture_pvrtc,n,this._extensionMap);const s=this._getExtension("WEBGL_compressed_texture_etc1");setExtensionMap(e.WebGLExtension.WEBGL_compressed_texture_etc1,s,this._extensionMap);const _=this._getExtension("WEBGL_compressed_texture_etc");setExtensionMap(e.WebGLExtension.WEBGL_compressed_texture_etc,_,this._extensionMap);const o=this._getExtension("WEBGL_compressed_texture_astc");setExtensionMap(e.WebGLExtension.WEBGL_compressed_texture_astc,o,this._extensionMap);const l=this._getExtension("OES_texture_float_linear");setExtensionMap(e.WebGLExtension.OES_texture_float_linear,l,this._extensionMap);const h=this._getExtension("EXT_color_buffer_half_float");if(setExtensionMap(e.WebGLExtension.EXT_color_buffer_half_float,h,this._extensionMap),t){const t=this._getExtension("EXT_color_buffer_float");setExtensionMap(e.WebGLExtension.EXT_color_buffer_float,t,this._extensionMap)}else{window._setupVertexArrayObject&&window._setupVertexArrayObject(this._gl);const t=this._getExtension("OES_vertex_array_object");setExtensionMap(e.WebGLExtension.OES_vertex_array_object,t,this._extensionMap);const r=this._getExtension("ANGLE_instanced_arrays");setExtensionMap(e.WebGLExtension.ANGLE_instanced_arrays,r,this._extensionMap);const a=this._getExtension("OES_texture_half_float");setExtensionMap(e.WebGLExtension.OES_texture_half_float,a,this._extensionMap);const i=this._getExtension("OES_texture_half_float_linear");setExtensionMap(e.WebGLExtension.OES_texture_half_float_linear,i,this._extensionMap);const n=this._getExtension("OES_texture_float");setExtensionMap(e.WebGLExtension.OES_texture_float,n,this._extensionMap);const s=this._getExtension("OES_element_index_uint");setExtensionMap(e.WebGLExtension.OES_element_index_uint,s,this._extensionMap);const _=this._getExtension("EXT_shader_texture_lod");setExtensionMap(e.WebGLExtension.EXT_shader_texture_lod,_,this._extensionMap);const o=this._getExtension("WEBGL_depth_texture");setExtensionMap(e.WebGLExtension.WEBGL_depth_texture,o,this._extensionMap);const l=this._getExtension("EXT_sRGB");setExtensionMap(e.WebGLExtension.EXT_sRGB,l,this._extensionMap);const h=this._getExtension("OES_standard_derivatives");setExtensionMap(e.WebGLExtension.OES_standard_derivatives,h,this._extensionMap)}}getCapable(e){return this._capabilityMap.get(e)}getExtension(e){return this._extensionMap.has(e)?this._extensionMap.get(e):null}_getExtension(e){const t=this._extentionVendorPrefixes;for(const a in t){var r=this._gl.getExtension(t[a]+e);if(r)return r}return null}}class WebGLEngine{constructor(r,a=e.WebGLMode.Auto){this._lost=!1,this._propertyNameMap={},this._propertyNameCounter=0,this._IDCounter=0,this._isShaderDebugMode=!0,this._enableStatistics=!1,this._curUBOPointer=0,this._GLUBOPointerMap=new Map,this._GLBindPointerUBOMap=new Map,this._lastClearColor=new t.Color,this._lastClearDepth=-1,this._remapZ=!0,this._screenInvertY=!1,this._lodTextureSample=!0,this._breakTextureSample=!0,this._GLStatisticsInfo=new Map,this._config=r,this._isWebGL2=!1,this._lastViewport=new t.Vector4(0,0,0,0),this._lastClearColor=new t.Color(0,0,0,0),this._lastScissor=new t.Vector4(0,0,0,0),this._webglMode=a,this._initStatisticsInfo(),WebGLEngine.instance=this}get lost(){return this._lost}resizeOffScreen(e,t){}addTexGammaDefine(e,t){WebGLEngine._texGammaDefine[e]=t}get gl(){return this._context}get isWebGL2(){return this._isWebGL2}get webglConfig(){return this._config}_initStatisticsInfo(){for(var e=0;e<t.GPUEngineStatisticsInfo.Count;e++)this._GLStatisticsInfo.set(e,0)}_addStatisticsInfo(e,t){this._enableStatistics&&this._GLStatisticsInfo.set(e,this._GLStatisticsInfo.get(e)+t)}clearStatisticsInfo(){if(this._enableStatistics)for(var e=0;e<t.GPUEngineStatisticsInfo.FrameClearCount;e++)this._GLStatisticsInfo.set(e,0)}getStatisticsInfo(e){return this._GLStatisticsInfo.get(e)}_getBindUBOBuffer(e){return this._GLBindPointerUBOMap.get(e)}_setBindUBOBuffer(e,t){this._GLBindPointerUBOMap.set(e,t)}initRenderEngine(t){let r,a;switch(this._webglMode){case e.WebGLMode.Auto:r=["webgl2","experimental-webgl2","webgl","experimental-webgl"];break;case e.WebGLMode.WebGL1:r=["webgl","experimental-webgl"];break;case e.WebGLMode.WebGL2:r=["webgl2","experimental-webgl2"]}for(var i=0;i<r.length;i++){try{a=t.getContext(r[i],this._config)}catch(e){}if(a){"webgl2"!==r[i]&&"experimental-webgl2"!==r[i]||(this._isWebGL2=!0);break}}this._context=a,this.scissorTest(!0),this._initBindBufferMap(),this._supportCapatable=new GlCapable(this),this._GLParams=new GLParams(this),this._GLRenderState=new GLRenderState(this),this._glTextureIDParams=[a.TEXTURE0,a.TEXTURE1,a.TEXTURE2,a.TEXTURE3,a.TEXTURE4,a.TEXTURE5,a.TEXTURE6,a.TEXTURE7,a.TEXTURE8,a.TEXTURE9,a.TEXTURE10,a.TEXTURE11,a.TEXTURE12,a.TEXTURE13,a.TEXTURE14,a.TEXTURE15,a.TEXTURE16,a.TEXTURE17,a.TEXTURE18,a.TEXTURE19,a.TEXTURE20,a.TEXTURE21,a.TEXTURE22,a.TEXTURE23,a.TEXTURE24,a.TEXTURE25,a.TEXTURE26,a.TEXTURE27,a.TEXTURE28,a.TEXTURE29,a.TEXTURE30,a.TEXTURE31],this._activedTextureID=a.TEXTURE0,this._activeTextures=[],this._GLTextureContext=this.isWebGL2?new GL2TextureContext(this):new GLTextureContext(this),this._GLRenderDrawContext=new GLRenderDrawContext(this),t.addEventListener("webglcontextlost",this.webglContextLost)}webglContextLost(e){console.log("lost webgl context"),t.Laya.stage.event("GraphicContextLost",e),this._lost=!0}_initBindBufferMap(){this._GLBufferBindMap={},this._GLBufferBindMap[t.BufferTargetType.ARRAY_BUFFER]=null,this._GLBufferBindMap[t.BufferTargetType.ELEMENT_ARRAY_BUFFER]=null,this._GLBufferBindMap[t.BufferTargetType.UNIFORM_BUFFER]=null}_getbindBuffer(e){return this._GLBufferBindMap[e]}_setbindBuffer(e,t){this._GLBufferBindMap[e]=t}_bindTexture(e,t){const r=this._activedTextureID-this._context.TEXTURE0;this._activeTextures[r]!==t&&(this._context.bindTexture(e,t),this._activeTextures[r]=t)}getCapable(e){return this._supportCapatable.getCapable(e)}viewport(e,r,a,i){const n=this._context,s=this._lastViewport;t.LayaEnv.isConch?n.viewport(e,r,a,i):e===s.x&&r===s.y&&a===s.z&&i===s.w||(n.viewport(e,r,a,i),s.setValue(e,r,a,i))}scissor(e,r,a,i){const n=this._context,s=this._lastScissor;t.LayaEnv.isConch?n.scissor(e,r,a,i):e===s.x&&r===s.y&&a===s.z&&i===s.w||(n.scissor(e,r,a,i),s.setValue(e,r,a,i))}scissorTest(e){this._scissorState!=e&&(this._scissorState=e,e?this._context.enable(this._context.SCISSOR_TEST):this._context.disable(this._context.SCISSOR_TEST))}clearRenderTexture(e,r=null,a=1,i=0){var n;e&t.RenderClearFlag.Color&&(r&&!this._lastClearColor.equal(r)&&(this._context.clearColor(r.r,r.g,r.b,r.a),r.cloneTo(this._lastClearColor)),n|=this.gl.COLOR_BUFFER_BIT),e&t.RenderClearFlag.Depth&&(this._lastClearDepth!=a&&(this._context.clearDepth(a),this._lastClearDepth=a),this._GLRenderState.setDepthMask(!0),n|=this._context.DEPTH_BUFFER_BIT),e&t.RenderClearFlag.Stencil&&(this._context.clearStencil(i),this._GLRenderState.setStencilMask(!0),n|=this._context.STENCIL_BUFFER_BIT),n&&this._context.clear(n)}copySubFrameBuffertoTex(e,t,r,a,i,n,s,_){this._bindTexture(e.target,e.resource),this._context.copyTexSubImage2D(e.target,t,r,a,i,n,s,_)}colorMask(e,t,r,a){this._context.colorMask(e,t,r,a)}getParams(e){return this._GLParams.getParams(e)}createBuffer(e,t){return new GLBuffer(this,e,t)}createShaderInstance(e,t,r){return new GLShaderInstance(this,e,t,r)}createVertexState(){return new GLVertexState(this)}getUBOPointer(e){return this._GLUBOPointerMap.has(e)||this._GLUBOPointerMap.set(e,this._curUBOPointer++),this._GLUBOPointerMap.get(e)}getTextureContext(){return this._GLTextureContext}getDrawContext(){return this._GLRenderDrawContext}getCreateRenderOBJContext(){return this._renderOBJCreateContext}propertyNameToID(e){if(null!=this._propertyNameMap[e])return this._propertyNameMap[e];var t=this._propertyNameCounter++;return this._propertyNameMap[e]=t,this._propertyNameMap[t]=e,t}propertyIDToName(e){return this._propertyNameMap[e]}getNamesByDefineData(e,t){var r=WebGLEngine._maskMap,a=e._mask;t.length=0;for(var i=0,n=e._length;i<n;i++)for(var s=r[i],_=a[i],o=0;o<32;o++){var l=1<<o;if(_>0&&l>_)break;_&l&&t.push(s[l])}}getDefineByName(e){var r=WebGLEngine._defineMap[e];if(!r){var a=WebGLEngine._maskMap,i=WebGLEngine._defineCounter,n=Math.floor(i/32),s=1<<i%32;r=new t.ShaderDefine(n,s),WebGLEngine._defineMap[e]=r,n==a.length&&(a.length++,a[n]={}),a[n][s]=e,WebGLEngine._defineCounter++}return r}uploadUniforms(e,t,r,a){r.applyUBO&&r.applyUBOData();for(var i=r._data,n=t.getArrayData(),s=0,_=0,o=n.length;_<o;_++){var l=n[_];if(a||-1!==l.textureID){var h=i[l.dataOffset];null!=h&&(s+=l.fun.call(l.caller,l,h))}}return s}uploadCustomUniforms(e,t,r,a){e.bind();var i=0,n=t[r];return n&&null!=a&&(i+=n.fun.call(n.caller,n,a)),i}unbindVertexState(){this.isWebGL2?this._context.bindVertexArray(null):this._supportCapatable.getExtension(e.WebGLExtension.OES_vertex_array_object).bindVertexArrayOES(null),this._GLBindVertexArray=null}}WebGLEngine._texGammaDefine={},WebGLEngine._defineMap={},WebGLEngine._defineCounter=0,WebGLEngine._maskMap=[];class WebGLShaderData extends t.ShaderData{constructor(e=null){super(e),this._ownerResource=null,this.applyUBO=!1,this._data=null,this._defineDatas=new WebDefineDatas,this._initData(),this._uniformBufferDatas=new Map,this._uniformBuffersMap=new Map}get uniformBufferDatas(){return this._uniformBufferDatas}get uniformBuffersMap(){return this._uniformBuffersMap}_releaseUBOData(){if(this._uniformBufferDatas){for(let e of this._uniformBufferDatas.values())e.ubo._updateDataInfo.destroy(),e.ubo.destroy(),e.ubo._updateDataInfo=null;this._uniformBufferDatas.clear(),this._uniformBuffersMap.clear()}}_addCheckUBO(e,t,r){this._uniformBufferDatas.set(e,{ubo:t,uboBuffer:r}),r._uniformParamsState.forEach(((e,r)=>{this.uniformBuffersMap.set(r,t)})),t.setDataByUniformBufferData(r)}_initData(){this._data={},this._gammaColorMap=new Map}getData(){return this._data}applyUBOData(){this._uniformBufferDatas.forEach(((e,t)=>{e.ubo.setDataByUniformBufferData(e.uboBuffer)})),this.applyUBO=!1}addDefine(e){this._defineDatas.add(e)}addDefines(e){this._defineDatas.addDefineDatas(e)}removeDefine(e){this._defineDatas.remove(e)}hasDefine(e){return this._defineDatas.has(e)}clearDefine(){this._defineDatas.clear()}getBool(e){return this._data[e]}setBool(e,t){this._data[e]=t}getInt(e){return this._data[e]}setInt(e,t){this._data[e]=t;let r=this._uniformBuffersMap.get(e);r&&this._uniformBufferDatas.get(r._name).uboBuffer._setData(e,this.getInt(e))}getNumber(e){return this._data[e]}setNumber(e,t){this._data[e]=t;let r=this._uniformBuffersMap.get(e);r&&(this._uniformBufferDatas.get(r._name).uboBuffer._setData(e,this.getNumber(e)),this.applyUBO=!0)}getVector2(e){return this._data[e]}setVector2(e,t){this._data[e]?t.cloneTo(this._data[e]):this._data[e]=t.clone();let r=this._uniformBuffersMap.get(e);r&&(this._uniformBufferDatas.get(r._name).uboBuffer._setData(e,this.getVector2(e)),this.applyUBO=!0)}getVector3(e){return this._data[e]}setVector3(e,t){this._data[e]?t.cloneTo(this._data[e]):this._data[e]=t.clone();let r=this._uniformBuffersMap.get(e);r&&(this._uniformBufferDatas.get(r._name).uboBuffer._setData(e,this.getVector3(e)),this.applyUBO=!0)}getVector(e){return this._data[e]}setVector(e,t){this._data[e]?t.cloneTo(this._data[e]):this._data[e]=t.clone();let r=this._uniformBuffersMap.get(e);r&&(this._uniformBufferDatas.get(r._name).uboBuffer._setData(e,this.getVector(e)),this.applyUBO=!0)}getColor(e){return this._gammaColorMap.get(e)}setColor(e,r){if(!r)return;if(this._data[e]){let a=this._gammaColorMap.get(e);r.cloneTo(a);let i=this._data[e];i.x=t.Color.gammaToLinearSpace(r.r),i.y=t.Color.gammaToLinearSpace(r.g),i.z=t.Color.gammaToLinearSpace(r.b),i.w=r.a}else{let a=new t.Vector4;a.x=t.Color.gammaToLinearSpace(r.r),a.y=t.Color.gammaToLinearSpace(r.g),a.z=t.Color.gammaToLinearSpace(r.b),a.w=r.a,this._data[e]=a,this._gammaColorMap.set(e,r.clone())}let a=this._uniformBuffersMap.get(e);a&&(this._uniformBufferDatas.get(a._name).uboBuffer._setData(e,this.getLinearColor(e)),this.applyUBO=!0)}getLinearColor(e){return this._data[e]}getMatrix4x4(e){return this._data[e]}setMatrix4x4(e,t){this._data[e]?t.cloneTo(this._data[e]):this._data[e]=t.clone();let r=this._uniformBuffersMap.get(e);r&&(this._uniformBufferDatas.get(r._name).uboBuffer._setData(e,this.getMatrix4x4(e)),this.applyUBO=!0)}getMatrix3x3(e){return this._data[e]}setMatrix3x3(e,t){this._data[e]?t.cloneTo(this._data[e]):this._data[e]=t.clone();let r=this._uniformBuffersMap.get(e);r&&this._uniformBufferDatas.get(r._name).uboBuffer._setData(e,this.getMatrix3x3(e))}getBuffer(e){return this._data[e]}setBuffer(e,t){this._data[e]=t}setTexture(e,t){var r=this._data[e];if(t){let r=WebGLEngine._texGammaDefine[e];r&&t&&t.gammaCorrection>1?this.addDefine(r):r&&this.removeDefine(r)}this._data[e]=t,r&&r._removeReference(),t&&t._addReference()}_setInternalTexture(e,t){if(this._data[e],t){let r=WebGLEngine._texGammaDefine[e];r&&t&&t.gammaCorrection>1?this.addDefine(r):r&&this.removeDefine(r)}this._data[e]=t}getTexture(e){return this._data[e]}getSourceIndex(e){for(var t in this._data)if(this._data[t]==e)return Number(t);return-1}setUniformBuffer(e,t){this._data[e]=t}getUniformBuffer(e){return this._data[e]}cloneTo(e){var r=e,a=r._data;for(var i in this._data){var n=this._data[i];if(null!=n)if("number"==typeof n)a[i]=n;else if("number"==typeof n)a[i]=n;else if("boolean"==typeof n)a[i]=n;else if(n instanceof t.Vector2){var s=a[i]||(a[i]=new t.Vector2);n.cloneTo(s),a[i]=s}else if(n instanceof t.Vector3){var _=a[i]||(a[i]=new t.Vector3);n.cloneTo(_),a[i]=_}else if(n instanceof t.Vector4){let r=this.getColor(parseInt(i));if(r){let t=r.clone();e.setColor(parseInt(i),t)}else{var o=a[i]||(a[i]=new t.Vector4);n.cloneTo(o),a[i]=o}}else if(n instanceof t.Matrix3x3){let e=a[i]||(a[i]=new t.Matrix3x3);n.cloneTo(e),a[i]=e}else if(n instanceof t.Matrix4x4){var l=a[i]||(a[i]=new t.Matrix4x4);n.cloneTo(l),a[i]=l}else(n instanceof t.BaseTexture||n instanceof t.Resource)&&(a[i]=n,n._addReference())}this._defineDatas.cloneTo(r._defineDatas),this._gammaColorMap.forEach(((t,r)=>{e._gammaColorMap.set(r,t.clone())})),this._cloneUBO(r._uniformBufferDatas),r.applyUBO=!0}getDefineData(){return this._defineDatas}_cloneUBO(e){this._uniformBufferDatas.forEach(((t,r)=>{e.has(r)&&t.uboBuffer.cloneTo(e.get(r).uboBuffer)}))}clone(){var e=new WebGLShaderData;return this.cloneTo(e),e}reset(){for(var e in this._data){var r=this._data[e];r instanceof t.Resource&&r._removeReference()}this._data={},this._gammaColorMap.clear(),this._uniformBufferDatas.clear(),this.applyUBO=!1,this._uniformBuffersMap.clear(),this._defineDatas.clear()}destroy(){for(var e in this._defineDatas.destroy(),this._defineDatas=null,this._data){var r=this._data[e];r instanceof t.Resource&&r._removeReference()}this._data=null,this._gammaColorMap.clear(),this._gammaColorMap=null,delete this._uniformBufferDatas,delete this._uniformBuffersMap,this._uniformBufferDatas=null,this._uniformBuffersMap=null}}class WebShaderPass{constructor(e){this._cacheShaderHierarchy=1,this._cacheSharders={},this._renderState=new t.RenderState,this._renderState.setNull()}get renderState(){return this._renderState}set renderState(e){this._renderState=e}get validDefine(){return this._validDefine}set validDefine(e){this._validDefine=e}_resizeCacheShaderMap(e,t,r){var a=this._cacheShaderHierarchy-1;if(t==a)for(var i in e)for(var n=e[i],s=0,_=r-a;s<_;s++)s==_-1?e[0]=n:e=e[0==s?i:0]={};else for(var i in++t,e)this._resizeCacheShaderMap(e[i],t,r)}setCacheShader(e,t){for(var r=this._cacheSharders,a=e._mask,i=e._length-1,n=this._cacheShaderHierarchy-1,s=0;s<n;s++){var _=i<s?0:a[s],o=r[_];o||(r[_]=o={}),r=o}r[i<n?0:a[n]]=t}getCacheShader(e){e._intersectionDefineDatas(this._validDefine);var t=this._cacheSharders,r=e._length;r>this._cacheShaderHierarchy&&(this._resizeCacheShaderMap(t,0,r),this._cacheShaderHierarchy=r);for(var a=e._mask,i=e._length-1,n=this._cacheShaderHierarchy-1,s=0;s<n;s++){var _=i<s?0:a[s],o=t[_];o||(t[_]=o={}),t=o}return t[i<n?0:a[n]]}destroy(){}}class WebSubShader{destroy(){throw new Error("Method not implemented.")}addShaderPass(e){}}class WebUnitRenderModuleDataFactory{createSubShader(){return new WebSubShader}createShaderPass(e){return new WebShaderPass(e)}createRenderState(){return new t.RenderState}createDefineDatas(){return new WebDefineDatas}}t.Laya.addBeforeInitCallback((()=>{t.LayaGL.unitRenderModuleDataFactory||(t.LayaGL.unitRenderModuleDataFactory=new WebUnitRenderModuleDataFactory)}));class WebglRenderContext2D{constructor(){this._clearColor=new t.Color(0,0,0,0),this.invertY=!1,this.pipelineMode="Forward",this._globalConfigShaderData=t.Shader3D._configDefineValues}setOffscreenView(e,t){this._offscreenWidth=e,this._offscreenHeight=t}setRenderTarget(e,r,a){this._destRT=e,a.cloneTo(this._clearColor),this._destRT?(WebGLEngine.instance.getTextureContext().bindRenderTarget(this._destRT),WebGLEngine.instance.viewport(0,0,this._destRT._textures[0].width,this._destRT._textures[0].height)):(WebGLEngine.instance.getTextureContext().bindoutScreenTarget(),WebGLEngine.instance.viewport(0,0,this._offscreenWidth,this._offscreenHeight)),WebGLEngine.instance.scissorTest(!1),WebGLEngine.instance.clearRenderTexture(r?t.RenderClearFlag.Color:t.RenderClearFlag.Nothing,this._clearColor)}drawRenderElementOne(e){e._prepare(this),e._render(this)}}class WebGLRenderelement2D{constructor(){this._shaderInstances=new t.SingletonList}_compileShader(e){var r=this.subShader._passes;this._shaderInstances.clear();for(var a=0,i=r.length;a<i;a++){var n=r[a];if(n.pipelineMode!==e.pipelineMode)continue;var s=WebGLRenderelement2D._compileDefine;e.sceneData?e.sceneData._defineDatas.cloneTo(s):e._globalConfigShaderData.cloneTo(s),!e._destRT||1!=e._destRT._textures[0].gammaCorrection?s.add(t.ShaderDefines2D.GAMMASPACE):s.remove(t.ShaderDefines2D.GAMMASPACE),e.invertY?s.add(t.ShaderDefines2D.INVERTY):s.remove(t.ShaderDefines2D.INVERTY),this.value2DShaderData&&s.addDefineDatas(this.value2DShaderData.getDefineData()),this.materialShaderData&&s.addDefineDatas(this.materialShaderData._defineDatas);var _=n.withCompile(s,!0);this._shaderInstances.add(_)}}_prepare(e){this._compileShader(e)}_render(e){if(1==this._shaderInstances.length)this.renderByShaderInstance(this._shaderInstances.elements[0],e);else for(var t=this._shaderInstances.elements,r=0,a=this._shaderInstances.length;r<a;r++)this.renderByShaderInstance(t[r],e)}renderByShaderInstance(e,t){e.complete&&(e.bind(),e.uploadUniforms(e._sprite2DUniformParamsMap,this.value2DShaderData,!0),t.sceneData&&e.uploadUniforms(e._sceneUniformParamsMap,t.sceneData,!0),this.materialShaderData&&e.uploadUniforms(e._materialUniformParamsMap,this.materialShaderData,!0),e.uploadRenderStateBlendDepth(this.value2DShaderData),e.uploadRenderStateFrontFace(this.value2DShaderData,!1,t.invertY),WebGLEngine.instance.getDrawContext().drawGeometryElement(this.geometry))}destroy(){}}WebGLRenderelement2D._compileDefine=new WebDefineDatas;class WebGLRender2DProcess{createRenderElement2D(){return new WebGLRenderelement2D}createRenderContext2D(){return new WebglRenderContext2D}}t.Laya.addBeforeInitCallback((()=>{t.LayaGL.render2DRenderPassFactory||(t.LayaGL.render2DRenderPassFactory=new WebGLRender2DProcess)}));class WebGLBufferState{constructor(){this._glVertexState=WebGLEngine.instance.createVertexState()}applyVertexBuffers(){this._glVertexState.applyVertexBuffer(this._vertexBuffers)}applyIndexBuffers(){this._glVertexState.applyIndexBuffer(this._bindedIndexBuffer)}applyState(e,t){this._vertexBuffers=e.slice(),this._bindedIndexBuffer=t,t&&t._glBuffer.unbindBuffer(),this.bind(),this.applyVertexBuffers(),this.applyIndexBuffers(),this.unBind(),t&&t._glBuffer.unbindBuffer()}bind(){this._glVertexState.bindVertexArray(),WebGLBufferState._curBindedBufferState=this}unBind(){if(WebGLBufferState._curBindedBufferState!=this)throw"BufferState: must call bind() function first.";this._glVertexState.unbindVertexArray(),WebGLBufferState._curBindedBufferState=null}isBind(){return WebGLBufferState._curBindedBufferState==this}destroy(){this._glVertexState.destroy(),this._vertexBuffers=null,this._bindedIndexBuffer=null}}class WebGLCommandUniformMap extends t.CommandUniformMap{constructor(e){super(e),this._idata={},this._stateName=e}hasPtrID(e){return!(null==this._idata[e])}addShaderUniform(e,t,r,a=""){this._idata[e]={uniformtype:r,propertyName:t,arrayLength:0,block:a,blockProperty:null}}addShaderUniformArray(e,r,a,i,n=""){if(a!==t.ShaderDataType.Matrix4x4&&a!==t.ShaderDataType.Vector4)throw"because of align rule, the engine does not support other types as arrays.";this._idata[e]={uniformtype:a,propertyName:r,arrayLength:i,block:n,blockProperty:null}}addShaderBlockUniform(e,r,a){this._idata[e]={propertyName:r,arrayLength:0,blockProperty:a,uniformtype:t.ShaderDataType.None,block:""},a.forEach((e=>{this.addShaderUniform(e.id,e.propertyName,e.uniformtype,r)}))}}class WebGLIndexBuffer{constructor(e,r){this._glBuffer=this._glBuffer=WebGLEngine.instance.createBuffer(e,r),WebGLEngine.instance._addStatisticsInfo(t.GPUEngineStatisticsInfo.RC_IndexBuffer,1)}_changeMemory(e){WebGLEngine.instance._addStatisticsInfo(t.GPUEngineStatisticsInfo.M_IndexBuffer,-this._glBuffer._byteLength+e)}_setIndexDataLength(e){this._changeMemory(e);var t=WebGLBufferState._curBindedBufferState;t?(t.unBind(),this._glBuffer.bindBuffer(),this._glBuffer.setDataLength(e),t.bind()):(this._glBuffer.bindBuffer(),this._glBuffer.setDataLength(e))}_setIndexData(e,t){var r=WebGLBufferState._curBindedBufferState;r?(r.unBind(),this._glBuffer.bindBuffer(),this._glBuffer.setData(e,t),r.bind()):(this._glBuffer.bindBuffer(),this._glBuffer.setData(e,t))}destroy(){this._glBuffer.destroy(),this._changeMemory(0),WebGLEngine.instance._addStatisticsInfo(t.GPUEngineStatisticsInfo.RC_IndexBuffer,-1)}}class FastSinglelist extends t.SingletonList{add(e){this.length===this.elements.length?this.elements.push(e):this.elements[this.length]=e}}class WebGLRenderGeometryElement{constructor(e,r){this._id=++WebGLRenderGeometryElement._idCounter,this.mode=e,this.drawParams=new t.SingletonList,this.drawType=r}get indexFormat(){return this._indexFormat}set indexFormat(e){this._indexFormat=e,this._glindexFormat=WebGLEngine.instance.getDrawContext().getIndexType(this._indexFormat)}get mode(){return this._mode}set mode(e){this._mode=e,this._glmode=WebGLEngine.instance.getDrawContext().getMeshTopology(this._mode)}setDrawArrayParams(e,t){this.drawParams.add(e),this.drawParams.add(t)}setDrawElemenParams(e,t){this.drawParams.add(t),this.drawParams.add(e)}destroy(){delete this.drawParams}clearRenderParams(){this.drawParams.length=0}cloneTo(e){e.mode=this.mode,e.drawType=this.drawType,e.indexFormat=this.indexFormat,e.instanceCount=this.instanceCount,e.drawParams.elements=this.drawParams.elements.slice(),e.drawParams.length=this.drawParams.length}}WebGLRenderGeometryElement._idCounter=0;class WebGLShaderInstance{constructor(){this._customUniformParamsMap=[],this._uploadMark=-1,this._uploadRenderType=-1}get complete(){return this._renderShaderInstance._complete}_create(e,r){let a=t.GLSLCodeGenerator.GLShaderLanguageProcess3D(e.defineString,e.attributeMap,e.uniformMap,e.vs,e.ps);this._renderShaderInstance=WebGLEngine.instance.createShaderInstance(a.vs,a.fs,e.attributeMap),this._renderShaderInstance._complete&&(this._shaderPass=r,e.is2D?this._create2D():this._create3D())}_create3D(){this._sceneUniformParamsMap=new t.CommandEncoder,this._cameraUniformParamsMap=new t.CommandEncoder,this._spriteUniformParamsMap=new t.CommandEncoder,this._materialUniformParamsMap=new t.CommandEncoder;const e=t.LayaGL.renderDeviceFactory.createGlobalUniformMap("Scene3D"),r=t.LayaGL.renderDeviceFactory.createGlobalUniformMap("BaseCamera"),a=t.LayaGL.renderDeviceFactory.createGlobalUniformMap("Custom");let i,n,s=this._renderShaderInstance.getUniformMap();for(i=0,n=s.length;i<n;i++){let t=s[i];e.hasPtrID(t.dataOffset)?this._sceneUniformParamsMap.addShaderUniform(t):r.hasPtrID(t.dataOffset)?this._cameraUniformParamsMap.addShaderUniform(t):this.hasSpritePtrID(t.dataOffset)?this._spriteUniformParamsMap.addShaderUniform(t):a.hasPtrID(t.dataOffset)?(this._customUniformParamsMap||(this._customUniformParamsMap=[]),this._customUniformParamsMap[t.dataOffset]=t):this._materialUniformParamsMap.addShaderUniform(t)}}_create2D(){this._sprite2DUniformParamsMap=new t.CommandEncoder,this._materialUniformParamsMap=new t.CommandEncoder,this._sceneUniformParamsMap=new t.CommandEncoder;const e=t.LayaGL.renderDeviceFactory.createGlobalUniformMap("Sprite2D"),r=t.LayaGL.renderDeviceFactory.createGlobalUniformMap("Sprite2DGlobal");let a,i,n=this._renderShaderInstance.getUniformMap();for(a=0,i=n.length;a<i;a++){let t=n[a];e.hasPtrID(t.dataOffset)?this._sprite2DUniformParamsMap.addShaderUniform(t):r.hasPtrID(t.dataOffset)?this._sceneUniformParamsMap.addShaderUniform(t):this._materialUniformParamsMap.addShaderUniform(t)}}hasSpritePtrID(e){let r=this._shaderPass.nodeCommonMap;if(r){for(let a=0,i=r.length;a<i;a++)if(t.LayaGL.renderDeviceFactory.createGlobalUniformMap(r[a]).hasPtrID(e))return!0;return!1}return!1}_disposeResource(){this._renderShaderInstance.destroy(),this._sceneUniformParamsMap=null,this._cameraUniformParamsMap=null,this._spriteUniformParamsMap=null,this._materialUniformParamsMap=null,this._customUniformParamsMap=null,this._uploadMaterial=null,this._uploadRender=null,this._uploadCameraShaderValue=null,this._uploadScene=null}bind(){return this._renderShaderInstance.bind()}uploadUniforms(e,r,a){WebGLEngine.instance._addStatisticsInfo(t.GPUEngineStatisticsInfo.C_UniformBufferUploadCount,WebGLEngine.instance.uploadUniforms(this._renderShaderInstance,e,r,a))}uploadRenderStateBlendDepth(e){this._shaderPass.statefirst?this.uploadRenderStateBlendDepthByShader(e):this.uploadRenderStateBlendDepthByMaterial(e)}uploadRenderStateBlendDepthByShader(e){var r,a,i,n,s,_,o,l,h,u,m,d,E,c,g,f,T,p,x,R,S,b,A,P,B,L,G,C,F,D,M,U,I=e._data,y=this._shaderPass.renderState,N=null!==(a=null!==(r=y.depthWrite)&&void 0!==r?r:I[t.Shader3D.DEPTH_WRITE])&&void 0!==a?a:t.RenderState.Default.depthWrite;t.RenderStateContext.setDepthMask(N);var O=null!==(n=null!==(i=y.depthTest)&&void 0!==i?i:I[t.Shader3D.DEPTH_TEST])&&void 0!==n?n:t.RenderState.Default.depthTest;O==t.RenderState.DEPTHTEST_OFF?t.RenderStateContext.setDepthTest(!1):(t.RenderStateContext.setDepthTest(!0),t.RenderStateContext.setDepthFunc(O));var v=null!==(_=null!==(s=y.stencilWrite)&&void 0!==s?s:I[t.Shader3D.STENCIL_WRITE])&&void 0!==_?_:t.RenderState.Default.stencilWrite,W=null!==(l=null!==(o=y.stencilTest)&&void 0!==o?o:I[t.Shader3D.STENCIL_TEST])&&void 0!==l?l:t.RenderState.Default.stencilTest;if(t.RenderStateContext.setStencilMask(v),v){var w=null!==(u=null!==(h=y.stencilOp)&&void 0!==h?h:I[t.Shader3D.STENCIL_Op])&&void 0!==u?u:t.RenderState.Default.stencilOp;t.RenderStateContext.setstencilOp(w.x,w.y,w.z)}if(W==t.RenderState.STENCILTEST_OFF)t.RenderStateContext.setStencilTest(!1);else{var X=null!==(d=null!==(m=y.stencilRef)&&void 0!==m?m:I[t.Shader3D.STENCIL_Ref])&&void 0!==d?d:t.RenderState.Default.stencilRef;t.RenderStateContext.setStencilTest(!0),t.RenderStateContext.setStencilFunc(W,X)}switch(null!==(c=null!==(E=y.blend)&&void 0!==E?E:I[t.Shader3D.BLEND])&&void 0!==c?c:t.RenderState.Default.blend){case t.RenderState.BLEND_DISABLE:t.RenderStateContext.setBlend(!1);break;case t.RenderState.BLEND_ENABLE_ALL:var V=null!==(f=null!==(g=y.blendEquation)&&void 0!==g?g:I[t.Shader3D.BLEND_EQUATION])&&void 0!==f?f:t.RenderState.Default.blendEquation,k=null!==(p=null!==(T=y.srcBlend)&&void 0!==T?T:I[t.Shader3D.BLEND_SRC])&&void 0!==p?p:t.RenderState.Default.srcBlend,H=null!==(R=null!==(x=y.dstBlend)&&void 0!==x?x:I[t.Shader3D.BLEND_DST])&&void 0!==R?R:t.RenderState.Default.dstBlend;t.RenderStateContext.setBlend(!0),t.RenderStateContext.setBlendEquation(V),t.RenderStateContext.setBlendFunc(k,H);break;case t.RenderState.BLEND_ENABLE_SEPERATE:var Y=null!==(b=null!==(S=y.blendEquationRGB)&&void 0!==S?S:I[t.Shader3D.BLEND_EQUATION_RGB])&&void 0!==b?b:t.RenderState.Default.blendEquationRGB,K=null!==(P=null!==(A=y.blendEquationAlpha)&&void 0!==A?A:I[t.Shader3D.BLEND_EQUATION_ALPHA])&&void 0!==P?P:t.RenderState.Default.blendEquationAlpha,j=null!==(L=null!==(B=y.srcBlendRGB)&&void 0!==B?B:I[t.Shader3D.BLEND_SRC_RGB])&&void 0!==L?L:t.RenderState.Default.srcBlendRGB,z=null!==(C=null!==(G=y.dstBlendRGB)&&void 0!==G?G:I[t.Shader3D.BLEND_DST_RGB])&&void 0!==C?C:t.RenderState.Default.dstBlendRGB,q=null!==(D=null!==(F=y.srcBlendAlpha)&&void 0!==F?F:I[t.Shader3D.BLEND_SRC_ALPHA])&&void 0!==D?D:t.RenderState.Default.srcBlendAlpha,Z=null!==(U=null!==(M=y.dstBlendAlpha)&&void 0!==M?M:I[t.Shader3D.BLEND_DST_ALPHA])&&void 0!==U?U:t.RenderState.Default.dstBlendAlpha;t.RenderStateContext.setBlend(!0),t.RenderStateContext.setBlendEquationSeparate(Y,K),t.RenderStateContext.setBlendFuncSeperate(j,z,q,Z)}}uploadRenderStateBlendDepthByMaterial(e){var r=e.getData(),a=r[t.Shader3D.DEPTH_WRITE];a=null!=a?a:t.RenderState.Default.depthWrite,t.RenderStateContext.setDepthMask(a);var i=r[t.Shader3D.DEPTH_TEST];(i=null!=i?i:t.RenderState.Default.depthTest)===t.RenderState.DEPTHTEST_OFF?t.RenderStateContext.setDepthTest(!1):(t.RenderStateContext.setDepthTest(!0),t.RenderStateContext.setDepthFunc(i));var n=r[t.Shader3D.STENCIL_WRITE];if(n=null!=n?n:t.RenderState.Default.stencilWrite,t.RenderStateContext.setStencilMask(n),n){var s=r[t.Shader3D.STENCIL_Op];s=null!=s?s:t.RenderState.Default.stencilOp,t.RenderStateContext.setstencilOp(s.x,s.y,s.z)}var _=r[t.Shader3D.STENCIL_TEST];if((_=null!=_?_:t.RenderState.Default.stencilTest)==t.RenderState.STENCILTEST_OFF)t.RenderStateContext.setStencilTest(!1);else{var o=r[t.Shader3D.STENCIL_Ref];o=null!=o?o:t.RenderState.Default.stencilRef,t.RenderStateContext.setStencilTest(!0),t.RenderStateContext.setStencilFunc(_,o)}var l=r[t.Shader3D.BLEND];switch(l=null!=l?l:t.RenderState.Default.blend){case t.RenderState.BLEND_ENABLE_ALL:var h=r[t.Shader3D.BLEND_EQUATION];h=null!=h?h:t.RenderState.Default.blendEquation;var u=r[t.Shader3D.BLEND_SRC];u=null!=u?u:t.RenderState.Default.srcBlend;var m=r[t.Shader3D.BLEND_DST];m=null!=m?m:t.RenderState.Default.dstBlend,t.RenderStateContext.setBlend(!0),t.RenderStateContext.setBlendEquation(h),t.RenderStateContext.setBlendFunc(u,m);break;case t.RenderState.BLEND_ENABLE_SEPERATE:var d=r[t.Shader3D.BLEND_EQUATION_RGB];d=null!=d?d:t.RenderState.Default.blendEquationRGB;var E=r[t.Shader3D.BLEND_EQUATION_ALPHA];E=null!=E?E:t.RenderState.Default.blendEquationAlpha;var c=r[t.Shader3D.BLEND_SRC_RGB];c=null!=c?c:t.RenderState.Default.srcBlendRGB;var g=r[t.Shader3D.BLEND_DST_RGB];g=null!=g?g:t.RenderState.Default.dstBlendRGB;var f=r[t.Shader3D.BLEND_SRC_ALPHA];f=null!=f?f:t.RenderState.Default.srcBlendAlpha;var T=r[t.Shader3D.BLEND_DST_ALPHA];T=null!=T?T:t.RenderState.Default.dstBlendAlpha,t.RenderStateContext.setBlend(!0),t.RenderStateContext.setBlendEquationSeparate(d,E),t.RenderStateContext.setBlendFuncSeperate(c,g,f,T);break;case t.RenderState.BLEND_DISABLE:default:t.RenderStateContext.setBlend(!1)}}uploadRenderStateFrontFace(e,r,a){var i,n,s=this._shaderPass.renderState,_=e.getData()[t.Shader3D.CULL];switch(this._shaderPass.statefirst&&(_=null!==(i=s.cull)&&void 0!==i?i:_),_=null!=_?_:t.RenderState.Default.cull){case t.RenderState.CULL_NONE:t.RenderStateContext.setCullFace(!1),n=r!=a?t.CullMode.Front:t.CullMode.Back,t.RenderStateContext.setFrontFace(n);break;case t.RenderState.CULL_FRONT:t.RenderStateContext.setCullFace(!0),n=r==a?t.CullMode.Front:t.CullMode.Back,t.RenderStateContext.setFrontFace(n);break;case t.RenderState.CULL_BACK:default:t.RenderStateContext.setCullFace(!0),n=r!=a?t.CullMode.Front:t.CullMode.Back,t.RenderStateContext.setFrontFace(n)}}uploadCustomUniform(e,t){WebGLEngine.instance.uploadCustomUniforms(this._renderShaderInstance,this._customUniformParamsMap,e,t)}}class WebGLVertexBuffer{constructor(e,r){this._glBuffer=WebGLEngine.instance.createBuffer(e,r),WebGLEngine.instance._addStatisticsInfo(t.GPUEngineStatisticsInfo.RC_VertexBuffer,1)}get vertexDeclaration(){return this._vertexDeclaration}set vertexDeclaration(e){this._vertexDeclaration=e,this._shaderValues=this._vertexDeclaration._shaderValues}_changeMemory(e){WebGLEngine.instance._addStatisticsInfo(t.GPUEngineStatisticsInfo.M_VertexBuffer,-this._glBuffer._byteLength+e)}setDataLength(e){this._changeMemory(e),this._glBuffer.setDataLength(e)}setData(e,t,r,a){if(this.bind(),0!==r||a!==Number.MAX_SAFE_INTEGER){var i=new Uint8Array(e,r,a);this._glBuffer.setData(i,t)}else this._glBuffer.setData(e,t)}bind(){return this._glBuffer.bindBuffer()}unbind(){return this._glBuffer.unbindBuffer()}orphanStorage(){this.bind(),this._glBuffer.setDataLength(this._glBuffer._byteLength)}destroy(){this._glBuffer.destroy(),this._vertexDeclaration=null,this._changeMemory(0),WebGLEngine.instance._addStatisticsInfo(t.GPUEngineStatisticsInfo.RC_VertexBuffer,-1)}}class WebGLRenderDeviceFactory{constructor(){this.globalBlockMap={}}createShaderData(e){return new WebGLShaderData(e)}createShaderInstance(e,t){let r=new WebGLShaderInstance;return r._create(e,t),r}createIndexBuffer(e){return new WebGLIndexBuffer(t.BufferTargetType.ELEMENT_ARRAY_BUFFER,e)}createVertexBuffer(e){return new WebGLVertexBuffer(t.BufferTargetType.ARRAY_BUFFER,e)}createBufferState(){return new WebGLBufferState}createRenderGeometryElement(e,t){return new WebGLRenderGeometryElement(e,t)}createGlobalUniformMap(e){let t=this.globalBlockMap[e];return t||(t=this.globalBlockMap[e]=new WebGLCommandUniformMap(e)),t}createEngine(r,a){let i,n={stencil:t.Config.isStencil,alpha:t.Config.isAlpha,antialias:t.Config.isAntialias,premultipliedAlpha:t.Config.premultipliedAlpha,preserveDrawingBuffer:t.Config.preserveDrawingBuffer,depth:t.Config.isDepth,failIfMajorPerformanceCaveat:t.Config.isfailIfMajorPerformanceCaveat,powerPreference:t.Config.powerPreference};const s=t.Config.useWebGL2?e.WebGLMode.Auto:e.WebGLMode.WebGL1;i=new WebGLEngine(n,s),i.initRenderEngine(a._source);var _=i._context;return t.Config.printWebglOrder&&this._replaceWebglcall(_),_&&new t.LayaGL,t.LayaGL.renderEngine=i,t.LayaGL.textureContext=i.getTextureContext(),Promise.resolve()}_replaceWebglcall(e){var t={};for(const r in e)"function"==typeof e[r]&&"getError"!=r&&"__SPECTOR_Origin_getError"!=r&&"__proto__"!=r&&(t[r]=e[r],e[r]=function(){let a=[];for(let e=0;e<arguments.length;e++)a.push(arguments[e]);let i=t[r].apply(e,a);e.getError();return i})}}t.Laya.addBeforeInitCallback((()=>{t.LayaGL.renderDeviceFactory||(t.LayaGL.renderDeviceFactory=new WebGLRenderDeviceFactory)}));class WebGLRenderEngineFactory{constructor(){this.globalBlockMap={}}createUniformBufferObject(e,r,a,i,n){return new t.UniformBufferObject(e,r,a,i,n)}createEngine(r,a){let i,n={stencil:t.Config.isStencil,alpha:t.Config.isAlpha,antialias:t.Config.isAntialias,premultipliedAlpha:t.Config.premultipliedAlpha,preserveDrawingBuffer:t.Config.preserveDrawingBuffer,depth:t.Config.isDepth,failIfMajorPerformanceCaveat:t.Config.isfailIfMajorPerformanceCaveat,powerPreference:t.Config.powerPreference};const s=t.Config.useWebGL2?e.WebGLMode.Auto:e.WebGLMode.WebGL1;i=new WebGLEngine(n,s),i.initRenderEngine(a._source);var _=i._context;return t.Config.printWebglOrder&&this._replaceWebglcall(_),_&&new t.LayaGL,t.LayaGL.renderEngine=i,t.LayaGL.textureContext=i.getTextureContext(),Promise.resolve()}_replaceWebglcall(e){var t={};for(const r in e)"function"==typeof e[r]&&"getError"!=r&&"__SPECTOR_Origin_getError"!=r&&"__proto__"!=r&&(t[r]=e[r],e[r]=function(){let a=[];for(let e=0;e<arguments.length;e++)a.push(arguments[e]);let i=t[r].apply(e,a);e.getError();return i})}}t.Laya.addBeforeInitCallback((()=>{t.LayaGL.renderOBJCreate||(t.LayaGL.renderOBJCreate=new WebGLRenderEngineFactory)}));e.FastSinglelist=FastSinglelist,e.GL2TextureContext=GL2TextureContext,e.GLBuffer=GLBuffer,e.GLObject=GLObject,e.GLParams=GLParams,e.GLRenderDrawContext=GLRenderDrawContext,e.GLRenderState=GLRenderState,e.GLShaderInstance=GLShaderInstance,e.GLTextureContext=GLTextureContext,e.GLVertexState=GLVertexState,e.GlCapable=GlCapable,e.VertexArrayObject=class{constructor(){}},e.WebDefineDatas=WebDefineDatas,e.WebGLBufferState=WebGLBufferState,e.WebGLCommandUniformMap=WebGLCommandUniformMap,e.WebGLConfig=class{},e.WebGLEngine=WebGLEngine,e.WebGLIndexBuffer=WebGLIndexBuffer,e.WebGLInternalRT=WebGLInternalRT,e.WebGLInternalTex=WebGLInternalTex,e.WebGLRender2DProcess=WebGLRender2DProcess,e.WebGLRenderDeviceFactory=WebGLRenderDeviceFactory,e.WebGLRenderEngineFactory=WebGLRenderEngineFactory,e.WebGLRenderGeometryElement=WebGLRenderGeometryElement,e.WebGLRenderelement2D=WebGLRenderelement2D,e.WebGLShaderData=WebGLShaderData,e.WebGLShaderInstance=WebGLShaderInstance,e.WebGLVertexBuffer=WebGLVertexBuffer,e.WebShaderPass=WebShaderPass,e.WebSubShader=WebSubShader,e.WebUnitRenderModuleDataFactory=WebUnitRenderModuleDataFactory,e.WebglRenderContext2D=WebglRenderContext2D}(window.Laya=window.Laya||{},Laya);
//# sourceMappingURL=laya.webgl_2D.js.map