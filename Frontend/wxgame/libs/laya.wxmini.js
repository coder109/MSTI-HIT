window.wxMiniGame=function(i,e){"use strict";function ImageDataPolyfill(){let i,t,n;if(3==arguments.length){if(!(arguments[0]instanceof Uint8ClampedArray))throw new Error("Failed to construct 'ImageData': parameter 1 is not of type 'Uint8ClampedArray'.");if(arguments[0].length%4!=0)throw new Error("Failed to construct 'ImageData': The input data length is not a multiple of 4.");if(arguments[0].length!==arguments[1]*arguments[2]*4)throw new Error("Failed to construct 'ImageData': The input data length is not equal to (4 * width * height).");n=arguments[0],i=arguments[1],t=arguments[2]}else if(2==arguments.length)i=arguments[0],t=arguments[1],n=new Uint8ClampedArray(arguments[0]*arguments[1]*4);else if(arguments.length<2)throw new Error("Failed to construct 'ImageData': 2 arguments required, but only "+arguments.length+" present.");let r=e.Browser.canvas.getContext("2d").getImageData(0,0,i,t);for(let i=0;i<n.length;i+=4)r.data[i]=n[i],r.data[i+1]=n[i+1],r.data[i+2]=n[i+2],r.data[i+3]=n[i+3];return r}class MiniFileMgr{static isLocalNativeFile(i){for(var e=0,t=MiniAdpter.nativefiles.length;e<t;e++)if(-1!=i.indexOf(MiniAdpter.nativefiles[e]))return!0;return!1}static isLocalNativeZipFile(i){for(var e=0,t=MiniAdpter.nativezipfiles.length;e<t;e++)if(-1!=i.indexOf(MiniAdpter.nativezipfiles[e]))return!0;return!1}static isNetFile(i){return(-1!=i.indexOf("http://")||-1!=i.indexOf("https://"))&&-1==i.indexOf(MiniAdpter.window.wx.env.USER_DATA_PATH)}static getFileInfo(i){var e=i,t=MiniFileMgr.fakeObj[e];return null==t?null:t}static read(i,t="utf8",n=null,r="",a=!1,o=""){var l;l=""==r||-1==r.indexOf("http://")&&-1==r.indexOf("https://")?i:MiniFileMgr.getFileNativePath(i),l=e.URL.postFormatURL(l),MiniFileMgr.fs.readFile({filePath:l,encoding:t,success:function(i){null!=n&&n.runWith([0,i])},fail:function(i){i&&""!=r?MiniFileMgr.downFiles(r,t,n,r,a,o):null!=n&&n.runWith([1])}})}static isFile(i){let e;try{e=MiniFileMgr.fs.statSync(i)}catch(i){return!1}return e.isFile()}static downFiles(i,t="utf8",n=null,r="",a=!1,o="",l=!0){i=e.URL.postFormatURL(i),MiniFileMgr.down({url:i,success:function(e){200===e.statusCode?MiniFileMgr.readFile(e.tempFilePath,t,n,r,a,o,l):403===e.statusCode?null!=n&&n.runWith([0,i]):null!=n&&n.runWith([1,e])},fail:function(i){null!=n&&n.runWith([1,i])}}).onProgressUpdate((function(i){null!=n&&n.runWith([2,i.progress])}))}static readFile(i,t="utf8",n=null,r="",a=!1,o="",l=!0){i=e.URL.postFormatURL(i),MiniFileMgr.fs.readFile({filePath:i,encoding:t,success:function(e){-1==r.indexOf("http://")&&-1==r.indexOf("https://")||-1!=i.indexOf(MiniAdpter.window.wx.env.USER_DATA_PATH)?null!=n&&n.runWith([0,e]):MiniAdpter.AutoCacheDownFile||a?(null!=n&&n.runWith([0,e]),MiniFileMgr.copyTOCache(i,r,null,t,l)):null!=n&&n.runWith([0,e])},fail:function(i){i&&null!=n&&n.runWith([1,i])}})}static downOtherFiles(i,e=null,t="",n=!1,r=!0){MiniFileMgr.down({url:i,success:function(i){200===i.statusCode?(MiniAdpter.autoCacheFile||n)&&-1==t.indexOf("qlogo.cn")&&-1==t.indexOf(".php")?(null!=e&&e.runWith([0,i.tempFilePath]),MiniFileMgr.copyTOCache(i.tempFilePath,t,null,"",r)):null!=e&&e.runWith([0,i.tempFilePath]):null!=e&&e.runWith([1,i])},fail:function(i){null!=e&&e.runWith([1,i])}})}static copyFile(i,e,t=null){MiniFileMgr.fs.copyFile({srcPath:i,destPath:e,success:function(){t&&t.runWith(0)},fail:function(i){t&&t.runWith([1,i])}})}static downLoadFile(i,t="",n=null,r="utf8"){window.navigator.userAgent.indexOf("MiniGame")<0?e.Laya.loader.load(i,n):t==e.Loader.IMAGE||t==e.Loader.SOUND?MiniFileMgr.downOtherFiles(i,n,i,!0,!1):MiniFileMgr.downFiles(i,r,n,i,!0,t,!1)}static copyTOCache(i,t,n,r="",a=!0){var o=i.split("/"),l=o[o.length-1],s=t,d=MiniFileMgr.getFileInfo(t),M=MiniFileMgr.getFileNativePath(l);MiniFileMgr.fakeObj[s]={md5:l,readyUrl:t,size:0,times:e.Browser.now(),encoding:r,tempFilePath:i};var u=MiniAdpter.sizeLimit,c=4194304,h=MiniFileMgr.getCacheUseSize();d?d.readyUrl!=t?MiniFileMgr.fs.getFileInfo({filePath:i,success:function(e){a&&h+c+e.size>=u&&(e.size>MiniAdpter.minClearSize&&(MiniAdpter.minClearSize=e.size),MiniFileMgr.onClearCacheRes()),MiniFileMgr.deleteFile(i,t,n,r,e.size)},fail:function(i){null!=n&&n.runWith([1,i])}}):null!=n&&n.runWith([0]):MiniFileMgr.fs.getFileInfo({filePath:i,success:function(e){a&&h+c+e.size>=u&&(e.size>MiniAdpter.minClearSize&&(MiniAdpter.minClearSize=e.size),MiniFileMgr.onClearCacheRes()),MiniFileMgr.fs.copyFile({srcPath:i,destPath:M,success:function(i){MiniFileMgr.onSaveFile(t,l,!0,r,n,e.size)},fail:function(i){null!=n&&n.runWith([1,i])}})},fail:function(i){null!=n&&n.runWith([1,i])}})}static onClearCacheRes(){var i=MiniAdpter.minClearSize,e=[];for(var t in MiniFileMgr.filesListObj)"fileUsedSize"!=t&&e.push(MiniFileMgr.filesListObj[t]);MiniFileMgr.sortOn(e,"times",MiniFileMgr.NUMERIC);for(var n=0,r=1,a=e.length;r<a;r++){var o=e[r];if(n>=i)break;n+=o.size,MiniFileMgr.deleteFile("",o.readyUrl)}}static sortOn(i,e,t=0){return t==MiniFileMgr.NUMERIC?i.sort((function(i,t){return i[e]-t[e]})):t==(MiniFileMgr.NUMERIC|MiniFileMgr.DESCENDING)?i.sort((function(i,t){return t[e]-i[e]})):i.sort((function(i,t){return i[e]-t[e]}))}static getFileNativePath(i){return MiniFileMgr.fileNativeDir+"/"+i}static deleteFile(i,e="",t=null,n="",r=0){var a=MiniFileMgr.getFileInfo(e),o=MiniFileMgr.getFileNativePath(a.md5);if(MiniFileMgr.fs.unlink({filePath:o,success:function(a){if(""!=i){var o=MiniFileMgr.getFileNativePath(i);MiniFileMgr.fs.copyFile({srcPath:i,destPath:o,success:function(a){MiniFileMgr.onSaveFile(e,i,!0,n,t,r)},fail:function(i){null!=t&&t.runWith([1,i])}})}else MiniFileMgr.onSaveFile(e,i,!1,n,t,r)},fail:function(i){null!=t&&t.runWith([1,i])}}),e&&""!=e&&-1!=e.indexOf(".zip")){var l=MiniAdpter.zipHeadFiles[e];if(l)try{MiniFileMgr.fs.rmdirSync(l,!0)}catch(i){console.log("目录:"+l+"delete fail"),console.log(i)}}}static deleteAll(){var i=[];for(var e in MiniFileMgr.filesListObj)"fileUsedSize"!=e&&i.push(MiniFileMgr.filesListObj[e]);for(var t=1,n=i.length;t<n;t++){var r=i[t];MiniFileMgr.deleteFile("",r.readyUrl)}MiniFileMgr.filesListObj&&MiniFileMgr.filesListObj.fileUsedSize&&(MiniFileMgr.filesListObj.fileUsedSize=0),MiniFileMgr.writeFilesList("",JSON.stringify({}),!1)}static onSaveFile(i,t,n=!0,r="",a=null,o=0){var l=i;if(null==MiniFileMgr.filesListObj.fileUsedSize&&(MiniFileMgr.filesListObj.fileUsedSize=0),n){var s=MiniFileMgr.getFileNativePath(t);MiniFileMgr.filesListObj[l]={md5:t,readyUrl:i,size:o,times:e.Browser.now(),encoding:r,tempFilePath:s},MiniFileMgr.filesListObj.fileUsedSize=parseInt(MiniFileMgr.filesListObj.fileUsedSize)+o,MiniFileMgr.writeFilesList(l,JSON.stringify(MiniFileMgr.filesListObj),!0),null!=a&&a.runWith([0])}else if(MiniFileMgr.filesListObj[l]){var d=parseInt(MiniFileMgr.filesListObj[l].size);MiniFileMgr.filesListObj.fileUsedSize=parseInt(MiniFileMgr.filesListObj.fileUsedSize)-d,MiniFileMgr.fakeObj[l].md5==MiniFileMgr.filesListObj[l].md5&&delete MiniFileMgr.fakeObj[l],delete MiniFileMgr.filesListObj[l],MiniFileMgr.writeFilesList(l,JSON.stringify(MiniFileMgr.filesListObj),!1),null!=a&&a.runWith([0])}}static writeFilesList(i,e,t){var n=MiniFileMgr.fileNativeDir+"/"+MiniFileMgr.fileListName;MiniFileMgr.fs.writeFile({filePath:n,encoding:"utf8",data:e,success:function(i){},fail:function(i){}}),!MiniAdpter.isZiYu&&MiniAdpter.isPosMsgYu&&MiniAdpter.window.wx.postMessage({url:i,data:MiniFileMgr.filesListObj[i],isLoad:"filenative",isAdd:t})}static getCacheUseSize(){return MiniFileMgr.filesListObj&&MiniFileMgr.filesListObj.fileUsedSize?MiniFileMgr.filesListObj.fileUsedSize:0}static getCacheList(i,e){let t;try{t=MiniFileMgr.fs.statSync(i)}catch(i){t=null}t?MiniFileMgr.readSync(MiniFileMgr.fileListName,"utf8",e):(MiniFileMgr.fs.mkdirSync(i,!0),e&&e.runWith([1]))}static existDir(i,e){MiniFileMgr.fs.access({path:i,success:function(i){MiniFileMgr.readSync(MiniFileMgr.fileListName,"utf8",e)},fail:function(t){MiniFileMgr.fs.mkdir({dirPath:i,success:function(i){null!=e&&e.runWith([0,{data:JSON.stringify({})}])},fail:function(i){-1!=i.errMsg.indexOf("file already exists")||-1!=i.errMsg.indexOf("File exists")?MiniFileMgr.readSync(MiniFileMgr.fileListName,"utf8",e):null!=e&&e.runWith([1,i])}})}})}static readSync(i,e="utf8",t=null,n=""){var r,a=MiniFileMgr.getFileNativePath(i);try{r=MiniFileMgr.fs.readFileSync(a,e),null!=t&&t.runWith([0,{data:r}])}catch(i){null!=t&&t.runWith([1])}}static setNativeFileDir(i){MiniFileMgr.fileNativeDir=MiniAdpter.window.wx.env.USER_DATA_PATH+i}}MiniFileMgr.fs=window.wx.getFileSystemManager(),MiniFileMgr.down=window.wx.downloadFile,MiniFileMgr.filesListObj={},MiniFileMgr.fakeObj={},MiniFileMgr.fileListName="layaairfiles.txt",MiniFileMgr.ziyuFileData={},MiniFileMgr.ziyuFileTextureData={},MiniFileMgr.loadPath="",MiniFileMgr.DESCENDING=2,MiniFileMgr.NUMERIC=16;class MiniSoundChannel extends e.SoundChannel{constructor(i){super(),this._sound=i,this._audio=i._sound,this._onCanplay=this.onCanPlay.bind(this),this._onError=this.onError.bind(this),this._onEnd=this.__onEnd.bind(this),this.addEventListener()}addEventListener(){this._audio.onError(this._onError),this._audio.onCanplay(this._onCanplay)}offEventListener(){this._audio.offError(this._onError),this._audio.offCanplay(this._onCanplay),this._audio.offEnded(this._onEnd)}onError(i){console.log("-----1---------------minisound-----url:",this.url),console.log(i),this.event(e.Event.ERROR),this._audio&&(this.offEventListener(),this._sound.dispose(),this._sound=this._audio=null)}onCanPlay(){this._audio&&(this.event(e.Event.COMPLETE),this.offEventListener(),this._audio.onEnded(this._onEnd),this.isStopped?this.stop():this.play())}__onEnd(){if(1==this.loops)return this.completeHandler&&(e.Laya.systemTimer.once(10,this,this.__runComplete,[this.completeHandler],!1),this.completeHandler=null),this.stop(),void this.event(e.Event.COMPLETE);this.loops>0&&this.loops--,this.startTime=0,this.play()}play(){this.isStopped=!1,e.SoundManager.addChannel(this),this._audio&&this._audio.play()}set startTime(i){this._audio&&(this._audio.startTime=i)}set autoplay(i){this._audio&&(this._audio.autoplay=i)}get autoplay(){return!!this._audio&&this._audio.autoplay}get position(){return this._audio?this._audio.currentTime:0}get duration(){return this._audio?this._audio.duration:0}stop(){super.stop(),this.isStopped=!0,e.SoundManager.removeChannel(this),this.completeHandler=null,this._audio&&(this._audio.stop(),this.loop||(this.offEventListener(),this._sound.dispose(),this._sound=null,this._audio=null))}pause(){this.isStopped=!0,this._audio&&this._audio.pause()}get loop(){return!!this._audio&&this._audio.loop}set loop(i){this._audio&&(this._audio.loop=i)}resume(){this.isStopped=!1,e.SoundManager.addChannel(this),this._audio&&this._audio.play()}set volume(i){this._audio&&(this._audio.volume=i)}get volume(){return this._audio?this._audio.volume:0}}class MiniSound extends e.EventDispatcher{constructor(){super(),this.loaded=!1,this._sound=MiniSound._createSound()}static _createSound(){return MiniSound._id++,MiniAdpter.window.wx.createInnerAudioContext()}load(i){if("string"!=typeof i)return i.loader.fetch(i.url,"sound",i.progress.createCallback(),i.options).then((i=>i));var t=i;if(t=e.URL.formatURL(t),MiniFileMgr.isLocalNativeFile(t)){if(!MiniFileMgr.isLocalNativeZipFile(t)&&MiniFileMgr.isNetFile(t))if(""!=MiniFileMgr.loadPath)t=t.split(MiniFileMgr.loadPath)[1];else{var n=""!=e.URL.rootPath?e.URL.rootPath:e.URL.basePath;""!=(n=47!=n.charCodeAt(n.length-1)?n+"/":n)&&(t=t.split(n)[1])}}else t=e.URL.formatURL(t);if(this.url=t,this.readyUrl=t,MiniAdpter.autoCacheFile&&MiniFileMgr.getFileInfo(t))this.onDownLoadCallBack(t,0);else if(MiniAdpter.autoCacheFile)if(MiniFileMgr.isLocalNativeFile(t)){if(MiniAdpter.subNativeFiles&&0==MiniAdpter.subNativeheads.length)for(var r in MiniAdpter.subNativeFiles){var a=MiniAdpter.subNativeFiles[r];MiniAdpter.subNativeheads=MiniAdpter.subNativeheads.concat(a);for(let i=0;i<a.length;i++)MiniAdpter.subMaps[a[i]]=r+"/"+a[i]}if(MiniAdpter.subNativeFiles&&-1!=t.indexOf("/")){var o=t.split("/")[0]+"/";if(o&&-1!=MiniAdpter.subNativeheads.indexOf(o)){var l=MiniAdpter.subMaps[o];t=t.replace(o,l)}}this.onDownLoadCallBack(t,0)}else MiniFileMgr.isNetFile(t)?MiniFileMgr.downOtherFiles(t,e.Handler.create(this,this.onDownLoadCallBack,[t]),t):this.onDownLoadCallBack(t,0);else this.onDownLoadCallBack(t,0)}onDownLoadCallBack(i,t,n=null){var r;if(!t&&this._sound)if(MiniAdpter.autoCacheFile){if(n)r=n;else if(MiniFileMgr.isLocalNativeFile(i)){var a=""!=e.URL.rootPath?e.URL.rootPath:e.URL.basePath,o=i;""==(a=47!=a.charCodeAt(a.length-1)?a+"/":a)||-1==i.indexOf("http://")&&-1==i.indexOf("https://")||(r=i.split(a)[1]),r||(r=o),-1==r.indexOf(MiniAdpter.window.wx.env.USER_DATA_PATH)&&MiniFileMgr.isLocalNativeZipFile(r)&&(r=MiniFileMgr.getFileNativePath(r))}else{var l=MiniFileMgr.getFileInfo(i);r=l&&l.md5?l.tempFilePath||MiniFileMgr.getFileNativePath(l.md5):i}this._sound.src=this.readyUrl=r}else this._sound.src=this.readyUrl=i;else this.event(e.Event.ERROR)}play(i=0,t=0){if(!this.url)return null;var n=new MiniSoundChannel(this);return n.url=this.url,n.loops=t,n.loop=0===t,n.startTime=i,n.isStopped=!1,e.SoundManager.addChannel(n),n}get duration(){return this._sound.duration}dispose(){this._sound&&(this._sound.destroy(),this._sound=null,this.readyUrl=this.url=null)}}MiniSound._id=0;class MiniInput{constructor(){}static _createInputElement(){e.Input._initInput(e.Input.area=e.Browser.createElement("textarea")),e.Input._initInput(e.Input.input=e.Browser.createElement("input")),e.Input.inputContainer=e.Browser.createElement("div"),e.Input.inputContainer.style.position="absolute",e.Input.inputContainer.style.zIndex=1e5,e.Browser.container.appendChild(e.Input.inputContainer),e.Laya.stage.on("resize",null,MiniInput._onStageResize),MiniAdpter.window.wx.onWindowResize&&MiniAdpter.window.wx.onWindowResize((function(i){})),e.SoundManager._soundClass=MiniSound,e.SoundManager._musicClass=MiniSound;let i=MiniAdpter.systemInfo.platform;"ios"===i?(e.Browser.onIOS=!0,e.Browser.onIPhone=!0,e.Browser.onIPad=!0,e.Browser.onAndroid=!1,e.Browser.platform=e.Browser.PLATFORM_IOS):"android"===i?(e.Browser.onIOS=!1,e.Browser.onIPhone=!1,e.Browser.onIPad=!1,e.Browser.onAndroid=!0,e.Browser.platform=e.Browser.PLATFORM_ANDROID):(e.Browser.onIOS=!1,e.Browser.onIPhone=!1,e.Browser.onIPad=!1,e.Browser.onAndroid=!1,e.Browser.platform=e.Browser.PLATFORM_PC)}static _onStageResize(){e.Laya.stage._canvasTransform.identity().scale(e.Browser.width/e.Render.canvas.width/e.Browser.pixelRatio,e.Browser.height/e.Render.canvas.height/e.Browser.pixelRatio)}static wxinputFocus(i){var t=e.Input.inputElement.target;t&&!t.editable||(MiniAdpter.window.wx.offKeyboardConfirm(),MiniAdpter.window.wx.offKeyboardInput(),MiniAdpter.window.wx.showKeyboard({defaultValue:t.text,maxLength:t.maxChars<=0?MiniInput._maxChars:t.maxChars,multiple:t.multiline,confirmHold:!0,confirmType:t.confirmType||"done",success:function(i){},fail:function(i){}}),MiniAdpter.window.wx.onKeyboardConfirm((function(i){var n=i?i.value:"";t._restrictPattern&&(n=n.replace(/\u2006|\x27/g,""),t._restrictPattern.test(n)&&(n=n.replace(t._restrictPattern,""))),t.text=n,t.event(e.Event.INPUT),MiniInput.inputEnter(),t.event("confirm"),t.event("enter")})),MiniAdpter.window.wx.onKeyboardInput((function(i){var n=i?i.value:"";t.multiline||-1==n.indexOf("\n")?(t._restrictPattern&&(n=n.replace(/\u2006|\x27/g,""),t._restrictPattern.test(n)&&(n=n.replace(t._restrictPattern,""))),t.text=n,t.miniGameTxt&&t.miniGameTxt(n),t.event(e.Event.INPUT)):MiniInput.inputEnter()})))}static inputEnter(){e.Input.inputElement.target.focus=!1}static wxinputblur(){MiniInput.hideKeyboard()}static hideKeyboard(){MiniAdpter.window.wx.offKeyboardConfirm(),MiniAdpter.window.wx.offKeyboardInput(),MiniAdpter.window.wx.hideKeyboard({success:function(i){console.log("隐藏键盘")},fail:function(i){console.log("隐藏键盘出错:"+(i?i.errMsg:""))}})}}MiniInput._maxChars=1e5;class MiniLoader extends e.EventDispatcher{constructor(){super()}download(i){MiniLoader._loadResourceFilter(i,this)}static _loadResourceFilter(i,t){var n=i.contentType,r=i.url;if(this.sourceUrl=e.URL.formatURL(r),MiniFileMgr.isNetFile(r))if(""!=MiniFileMgr.loadPath)r=r.split(MiniFileMgr.loadPath)[1];else{var a=""!=e.URL.rootPath?e.URL.rootPath:e.URL.basePath,o=r;""!=(a=47!=a.charCodeAt(a.length-1)?a+"/":a)&&(r=r.split(a)[1]),r||(r=o)}if(MiniAdpter.subNativeFiles&&0==MiniAdpter.subNativeheads.length)for(var l in MiniAdpter.subNativeFiles){var s=MiniAdpter.subNativeFiles[l];MiniAdpter.subNativeheads=MiniAdpter.subNativeheads.concat(s);for(var d=0;d<s.length;d++)MiniAdpter.subMaps[s[d]]=l+"/"+s[d]}if(MiniAdpter.subNativeFiles&&-1!=r.indexOf("/")){var M=r.split("/")[0]+"/";if(M&&-1!=MiniAdpter.subNativeheads.indexOf(M)){var u=MiniAdpter.subMaps[M];r=r.replace(M,u)}}switch(i.url=r,n){case e.Loader.IMAGE:case"htmlimage":case"nativeimage":MiniLoader.onLoadImage(i,t);break;case e.Loader.SOUND:MiniLoader.onLoadSound(i,t);break;default:MiniLoader.onLoadOtherFile(i,n,t)}}static onLoadSound(i,t){var n=i.url,r=e.URL.formatURL(i.url);MiniAdpter.autoCacheFile?MiniFileMgr.isLocalNativeFile(n)||MiniFileMgr.getFileInfo(r)?MiniLoader.onLoadSoundCB(i,t,0):MiniFileMgr.isNetFile(r)?(i.url=r,MiniFileMgr.downOtherFiles(r,e.Handler.create(MiniLoader,MiniLoader.onLoadSoundCB,[i,t]),r)):MiniLoader.onLoadSoundCB(i,t,0):MiniLoader.onLoadSoundCB(i,t,0)}static onLoadSoundCB(i,t,n,r=null){var a=i.url,o=e.URL.formatURL(i.url);if(n)t.completeItem(i,null);else{var l;if(MiniAdpter.autoCacheFile)if(r)l=r;else if(MiniFileMgr.isLocalNativeFile(a))-1==(l=a).indexOf(MiniAdpter.window.wx.env.USER_DATA_PATH)&&MiniFileMgr.isLocalNativeZipFile(l)&&(l=MiniFileMgr.getFileNativePath(l));else{var s=MiniFileMgr.getFileInfo(o);l=s&&s.md5?s.tempFilePath||MiniFileMgr.getFileNativePath(s.md5):o}else l=o;a=l;var d=new e.SoundManager._soundClass;d.load(a),t.completeItem(i,d)}}static onLoadOtherFile(i,t,n){var r=i.url,a=e.URL.formatURL(i.url),o=MiniAdpter.getUrlEncode(a,t);i.url=a;let l=e.Loader.preLoadedMap[a];if(l)n.completeItem(i,l);else if(MiniAdpter.AutoCacheDownFile)if(MiniFileMgr.isLocalNativeFile(r)||MiniFileMgr.getFileInfo(a)){var s=r,d=MiniFileMgr.getFileInfo(a);d&&d.md5&&(s=d.tempFilePath||MiniFileMgr.getFileNativePath(d.md5)),MiniFileMgr.readFile(s,o,new e.Handler(MiniLoader,MiniLoader.onLoadOtherFileCB,[i,t,n]),a)}else MiniFileMgr.isNetFile(a)?MiniFileMgr.downFiles(a,o,new e.Handler(MiniLoader,MiniLoader.onLoadOtherFileCB,[i,t,n]),a,!0):MiniFileMgr.readFile(r,o,new e.Handler(MiniLoader,MiniLoader.onLoadOtherFileCB,[i,t,n]),a);else MiniFileMgr.isNetFile(a)?n._download(i):(-1==r.indexOf(MiniAdpter.window.wx.env.USER_DATA_PATH)&&MiniFileMgr.isLocalNativeZipFile(r)&&(r=MiniFileMgr.getFileNativePath(r)),MiniFileMgr.readFile(r,o,new e.Handler(MiniLoader,MiniLoader.onLoadOtherFileCB,[i,t,n]),a))}static onLoadOtherFileCB(i,t=null,n=null,r=0,a=null){var o,l=i.url;r?1==r&&n.completeItem(i,null):(o=t==e.Loader.JSON||t==e.Loader.ATLAS||t==e.Loader.HIERARCHY||t==e.Loader.MATERIAL?MiniAdpter.getJson(a.data):t==e.Loader.XML?new e.XML(a.data):a.data,!MiniAdpter.isZiYu&&MiniAdpter.isPosMsgYu&&t!=e.Loader.BUFFER&&MiniAdpter.window.wx.postMessage({url:l,data:o,isLoad:"filedata"}),n.completeItem(i,o))}static onLoadImage(i,t){var n=i.url,r=e.URL.formatURL(i.url);if(MiniAdpter.isZiYu||MiniFileMgr.isLocalNativeFile(n))return MiniFileMgr.isLocalNativeZipFile(n)&&(i.url=MiniFileMgr.getFileNativePath(n)),void t._download(i);MiniAdpter.autoCacheFile?MiniFileMgr.isLocalNativeFile(n)||MiniFileMgr.getFileInfo(r)?MiniLoader.onCreateImage(i,t,!1):MiniFileMgr.isNetFile(r)?(i.url=r,MiniFileMgr.downOtherFiles(r,new e.Handler(MiniLoader,MiniLoader.onDownImgCallBack,[i,t]),r)):MiniLoader.onCreateImage(i,t,!0):(i.url=r,t._download(i))}static onDownImgCallBack(i,e,t,n=""){t?e.completeItem(i,null):MiniLoader.onCreateImage(i,e,!1,n)}static onCreateImage(i,t,n=!1,r=""){var a,o=i.url;if(MiniAdpter.autoCacheFile)if(n)if(MiniAdpter.isZiYu){var l=e.URL.formatURL(o);a=MiniFileMgr.ziyuFileTextureData[l]?MiniFileMgr.ziyuFileTextureData[l]:o}else a=o;else if(""!=r)a=r;else{var s=MiniFileMgr.getFileInfo(e.URL.formatURL(o));a=s.tempFilePath||MiniFileMgr.getFileNativePath(s.md5)}else a=n?o:r;i.url=a,t._download(i)}}class MiniLocalStorage{constructor(){}static __init__(){MiniLocalStorage.items=MiniLocalStorage}static setItem(i,e){try{MiniAdpter.window.wx.setStorageSync(i,e)}catch(t){MiniAdpter.window.wx.setStorage({key:i,data:e})}}static getItem(i){return MiniAdpter.window.wx.getStorageSync(i)}static setJSON(i,e){MiniLocalStorage.setItem(i,e)}static getJSON(i){return MiniLocalStorage.getItem(i)}static removeItem(i){MiniAdpter.window.wx.removeStorageSync(i)}static clear(){MiniAdpter.window.wx.clearStorageSync()}static getStorageInfoSync(){try{var i=MiniAdpter.window.wx.getStorageInfoSync();return console.log(i.keys),console.log(i.currentSize),console.log(i.limitSize),i}catch(i){}return null}}MiniLocalStorage.support=!0;class MiniTTFFontLoader{load(i){if(i){var t=e.URL.formatURL(i.url),n=MiniAdpter.window.wx.loadFont(t);return new Promise((i=>{n?i({family:n}):i(null)}))}}}class MiniAdpter{static getJson(i){return JSON.parse(i)}static enable(){MiniAdpter.init(e.Laya.isWXPosMsg,e.Laya.isWXOpenDataContext)}static init(i=!1,t=!1){MiniAdpter._inited||(MiniAdpter._inited=!0,MiniAdpter.window=window,MiniAdpter.window.hasOwnProperty("wx")&&(!MiniAdpter.window.conch&&MiniAdpter.window.navigator.userAgent.indexOf("MiniGame")<0||(MiniAdpter.isZiYu=t,MiniAdpter.isPosMsgYu=i,MiniAdpter.EnvConfig={},MiniAdpter.isZiYu||(MiniFileMgr.setNativeFileDir("/layaairGame"),MiniFileMgr.getCacheList(MiniFileMgr.fileNativeDir,e.Handler.create(MiniAdpter,MiniAdpter.onMkdirCallBack))),MiniAdpter.systemInfo=MiniAdpter.window.wx.getSystemInfoSync(),MiniAdpter.window.focus=function(){},e.URL.__init__=function(){e.URL.basePath=e.URL.rootPath=""},MiniAdpter.window.logtime=function(i){},MiniAdpter.window.alertTimeLog=function(i){},MiniAdpter.window.resetShareInfo=function(){},MiniAdpter.window.CanvasRenderingContext2D=function(){},MiniAdpter.window.conch?(MiniFileMgr.fs.readFile({filePath:"app/appConfig.json",encoding:"utf8",success:function(i){var e=JSON.parse(i.data).preDownloadFiles;for(var t in e)MiniAdpter.preDownloadFiles[e[t]]=!0},fail:function(i){}}),MiniAdpter._preCreateElement=e.Browser.createElement,e.Browser.createElement=function(i){return"textarea"==i||"input"==i?MiniAdpter.onCreateInput(i):MiniAdpter._preCreateElement(i)},e.Input._createInputElement=MiniInput._createInputElement):(MiniAdpter.window.CanvasRenderingContext2D.prototype=MiniAdpter.window.wx.createCanvas().getContext("2d").__proto__,MiniAdpter.window.document.body.appendChild=function(){},MiniAdpter.EnvConfig.pixelRatioInt=0,e.Browser._pixelRatio=MiniAdpter.pixelRatio(),MiniAdpter._preCreateElement=e.Browser.createElement,e.Browser.createElement=MiniAdpter.createElement,e.RunDriver.createShaderCondition=MiniAdpter.createShaderCondition,e.Input._createInputElement=MiniInput._createInputElement,window.ImageData||(window.ImageData=ImageDataPolyfill)),e.Loader.prototype._download=e.Loader.prototype.download,e.Loader.prototype.download=MiniLoader.prototype.download,e.Loader.registerLoader(["ttf","woff","woff2","otf"],MiniTTFFontLoader,e.Loader.TTF),e.Loader.registerLoader(["mp3","wav","ogg"],MiniSound,e.Loader.SOUND),MiniAdpter.window.conch||(e.LocalStorage._baseClass=MiniLocalStorage,MiniLocalStorage.__init__(),MiniAdpter.window.wx.onMessage&&MiniAdpter.window.wx.onMessage(MiniAdpter._onMessage)))))}static _onMessage(i){switch(i.type){case"changeMatrix":e.Laya.stage.transform.identity(),e.Laya.stage._width=i.w,e.Laya.stage._height=i.h,e.Laya.stage._canvasTransform=new e.Matrix(i.a,i.b,i.c,i.d,i.tx,i.ty);break;case"display":e.Laya.stage.frameRate=i.rate||e.Stage.FRAME_FAST;break;case"undisplay":e.Laya.stage.frameRate=e.Stage.FRAME_SLEEP}"opendatacontext"==i.isLoad?i.url&&(MiniFileMgr.ziyuFileData[i.url]=i.atlasdata,MiniFileMgr.ziyuFileTextureData[i.imgReadyUrl]=i.imgNativeUrl):"openJsondatacontext"==i.isLoad?i.url&&(MiniFileMgr.ziyuFileData[i.url]=i.atlasdata):"openJsondatacontextPic"==i.isLoad&&(MiniFileMgr.ziyuFileTextureData[i.imgReadyUrl]=i.imgNativeUrl)}static loadZip(i,e,t,n,r=0){var a=MiniFileMgr.fs;if(a&&a.unzip){MiniAdpter.nativefiles.push(e),MiniAdpter.nativezipfiles.push(e);var o=MiniFileMgr.fileNativeDir+"/"+e;MiniAdpter.zipHeadFiles[i]=e,a.access({path:o,success:function(e){if(1==r){try{a.rmdirSync(o,!0)}catch(i){console.log("目录删除成功"),console.log(i)}a.mkdir({dirPath:o,recursive:!0,success:function(e){MiniAdpter.downZip(i,o,a,t,n)}.bind(this),fail:function(i){null!=t&&t.runWith([{errCode:3,errMsg:"创建压缩包目录失败",wxData:i}])}.bind(this)})}else if(2==r)MiniAdpter.downZip(i,o,a,t,n);else{MiniFileMgr.getFileInfo(i)?null!=t&&t.runWith([{errCode:0,errMsg:"zip包目录存在，直接返回完成",wxData:e}]):MiniAdpter.downZip(i,o,a,t,n)}}.bind(this),fail:function(e){e&&-1!=e.errMsg.indexOf("access:fail no such file or directory")&&a.mkdir({dirPath:o,recursive:!0,success:function(e){MiniAdpter.downZip(i,o,a,t,n)}.bind(this),fail:function(i){null!=t&&t.runWith([{errCode:3,errMsg:"创建压缩包目录失败",wxData:i}])}.bind(this)})}.bind(this)})}else null!=t&&t.runWith([{errCode:2,errMsg:"微信压缩接口不支持"}])}static downZip(i,e,t,n,r){var a={zipFilePath:i,targetPath:e,success:function(i){null!=n&&n.runWith([{errCode:0,errMsg:"解压成功",wxData:i}])}.bind(this),fail:function(i){null!=n&&n.runWith([{errCode:1,errMsg:"解压失败",wxData:i}])}.bind(this)};-1==i.indexOf("http://")&&-1==i.indexOf("https://")?t.unzip(a):window.wx.downloadFile({url:i,success:function(e){200===e.statusCode?(a.zipFilePath=e.tempFilePath,t.unzip(a),MiniFileMgr.copyTOCache(e.tempFilePath,i,null,"utf8",!0)):null!=n&&n.runWith([{errCode:4,errMsg:"远端下载zip包失败",wxData:e}])}.bind(this),fail:function(i){null!=n&&n.runWith([{errCode:4,errMsg:"远端下载zip包失败",wxData:i}])}.bind(this)}).onProgressUpdate((function(i){null!=r&&r.runWith([{errCode:5,errMsg:"zip包下载中",progress:i.progress}])}))}static getUrlEncode(i,e){return"arraybuffer"==e?"":"utf8"}static downLoadFile(i,e="",t=null,n="utf8"){MiniFileMgr.getFileInfo(i)?null!=t&&t.runWith([0]):MiniFileMgr.downLoadFile(i,e,t,n)}static remove(i,e=null){MiniFileMgr.deleteFile("",i,e,"",0)}static removeAll(){MiniFileMgr.deleteAll()}static hasNativeFile(i){return MiniFileMgr.isLocalNativeFile(i)}static getFileInfo(i){return MiniFileMgr.getFileInfo(i)}static getFileList(){return MiniFileMgr.filesListObj}static exitMiniProgram(){MiniAdpter.window.wx.exitMiniProgram()}static onMkdirCallBack(i,e){i?(MiniFileMgr.fakeObj={},MiniFileMgr.filesListObj={}):(MiniFileMgr.filesListObj=JSON.parse(e.data),MiniFileMgr.fakeObj=JSON.parse(e.data));let t=MiniFileMgr.fs.readdirSync(MiniFileMgr.fileNativeDir);if(t.length){var n,r,a={};for(let i in MiniFileMgr.filesListObj)"fileUsedSize"!=i&&(a[(n=MiniFileMgr.filesListObj[i]).md5]=n.readyUrl);for(let i=0,e=t.length;i<e;i++)if((r=t[i])!=MiniFileMgr.fileListName){if(!a[r]){let i=MiniFileMgr.getFileNativePath(r);MiniFileMgr.fs.unlink({filePath:i,success:function(i){console.log("删除无引用的磁盘文件:"+r)}})}delete a[r]}for(let i in a)delete MiniFileMgr.filesListObj[a[i]],delete MiniFileMgr.fakeObj[a[i]],console.log("删除错误记录：",a[i])}}static pixelRatio(){if(!MiniAdpter.EnvConfig.pixelRatioInt)try{return MiniAdpter.EnvConfig.pixelRatioInt=MiniAdpter.systemInfo.pixelRatio,MiniAdpter.systemInfo.pixelRatio}catch(i){}return MiniAdpter.EnvConfig.pixelRatioInt}static createElement(i){var e;if("canvas"==i)return 1==MiniAdpter.idx?MiniAdpter.isZiYu?(e=MiniAdpter.window.sharedCanvas).style={}:e=MiniAdpter.window.canvas:e=MiniAdpter.window.wx.createCanvas(),MiniAdpter.idx++,e;if("textarea"==i||"input"==i)return MiniAdpter.onCreateInput(i);if("div"==i){var t=MiniAdpter._preCreateElement(i);return t.contains=function(i){return null},t.removeChild=function(i){},t}return MiniAdpter._preCreateElement(i)}static onCreateInput(i){var e=MiniAdpter._preCreateElement(i);return e.focus=MiniInput.wxinputFocus,e.blur=MiniInput.wxinputblur,e.style={},e.value=0,e.parentElement={},e.placeholder={},e.type={},e.setColor=function(i){},e.setType=function(i){},e.setFontFace=function(i){},e.addEventListener=function(i){},e.contains=function(i){return null},e.removeChild=function(i){},e}static createShaderCondition(i){return function(){return this[i.replace("this.","")]}}static sendAtlasToOpenDataContext(i){if(!MiniAdpter.isZiYu){var t=e.Loader.getRes(i);if(!t)throw"传递的url没有获取到对应的图集数据信息，请确保图集已经过！";if(t.meta&&t.meta.image)for(var n=t.meta.image.split(","),r=i.indexOf("/")>=0?"/":"\\",a=i.lastIndexOf(r),o=a>=0?i.substr(0,a+1):"",l=0,s=n.length;l<s;l++)n[l]=o+n[l];else n=[i.replace(".json",".png")];for(l=0;l<n.length;l++){var d=n[l];MiniAdpter.postInfoToContext(e.Laya.URL.formatURL(i),e.Laya.URL.formatURL(d),t)}}}static postInfoToContext(i,t,n){var r={frames:n.frames,meta:n.meta},a=t,o=MiniFileMgr.getFileInfo(e.URL.formatURL(t));if(o)var l=o.tempFilePath||MiniFileMgr.getFileNativePath(o.md5);else l=a;if(!l)throw"获取图集的磁盘url路径不存在！";MiniAdpter.window.wx.postMessage({url:i,atlasdata:r,imgNativeUrl:l,imgReadyUrl:a,isLoad:"opendatacontext"})}static sendSinglePicToOpenDataContext(i){var t=e.Laya.URL.formatURL(i),n=MiniFileMgr.getFileInfo(t);if(n){var r=n.tempFilePath||MiniFileMgr.getFileNativePath(n.md5);i=t}else r=i;if(!r)throw"获取图集的磁盘url路径不存在！";MiniAdpter.window.wx.postMessage({url:t,imgNativeUrl:r,imgReadyUrl:t,isLoad:"openJsondatacontextPic"})}static sendJsonDataToDataContext(i){if(!MiniAdpter.isZiYu){i=e.Laya.URL.formatURL(i);var t=e.Loader.getRes(i);if(!t)throw"传递的url没有获取到对应的图集数据信息，请确保图集已经过！";MiniAdpter.window.wx.postMessage({url:i,atlasdata:t,isLoad:"openJsondatacontext"})}}}MiniAdpter._inited=!1,MiniAdpter.autoCacheFile=!0,MiniAdpter.minClearSize=5242880,MiniAdpter.sizeLimit=209715200,MiniAdpter.nativefiles=["layaNativeDir","wxlocal"],MiniAdpter.nativezipfiles=[],MiniAdpter.zipRequestHead="",MiniAdpter.zipHeadFiles={},MiniAdpter.subNativeFiles=[],MiniAdpter.subNativeheads=[],MiniAdpter.subMaps=[],MiniAdpter.AutoCacheDownFile=!1,MiniAdpter.preDownloadFiles={},MiniAdpter.parseXMLFromString=function(i){var e;i=i.replace(/>\s+</g,"><");try{e=(new MiniAdpter.window.Parser.DOMParser).parseFromString(i,"text/xml")}catch(i){throw"需要引入xml解析库文件"}return e},MiniAdpter.idx=1;class MiniAccelerator extends e.EventDispatcher{constructor(){super()}static __init__(){try{var i;if(!(i=e.Accelerator))return;i.prototype.on=MiniAccelerator.prototype.on,i.prototype.off=MiniAccelerator.prototype.off}catch(i){}}static startListen(i){if(MiniAccelerator._callBack=i,!MiniAccelerator._isListening){MiniAccelerator._isListening=!0;try{MiniAdpter.window.wx.onAccelerometerChange(MiniAccelerator.onAccelerometerChange)}catch(i){}}}static stopListen(){MiniAccelerator._isListening=!1;try{MiniAdpter.window.wx.stopAccelerometer({})}catch(i){}}static onAccelerometerChange(i){var e;(e={}).acceleration=i,e.accelerationIncludingGravity=i,e.rotationRate={},null!=MiniAccelerator._callBack&&MiniAccelerator._callBack(e)}on(i,e,t,n=null){return super.on(i,e,t,n),MiniAccelerator.startListen(this.onDeviceOrientationChange),this}off(i,e,t,n=!1){return this.hasListener(i)||MiniAccelerator.stopListen(),super.off(i,e,t,n)}}MiniAccelerator._isListening=!1;class MiniLocation{constructor(){}static __init__(){MiniAdpter.window.navigator.geolocation.getCurrentPosition=MiniLocation.getCurrentPosition,MiniAdpter.window.navigator.geolocation.watchPosition=MiniLocation.watchPosition,MiniAdpter.window.navigator.geolocation.clearWatch=MiniLocation.clearWatch}static getCurrentPosition(i=null,e=null,t=null){var n;(n={}).success=function(e){null!=i&&i(e)},n.fail=e,MiniAdpter.window.wx.getLocation(n)}static watchPosition(i=null,t=null,n=null){var r;return MiniLocation._curID++,(r={}).success=i,r.error=t,MiniLocation._watchDic[MiniLocation._curID]=r,e.Laya.systemTimer.loop(1e3,null,MiniLocation._myLoop),MiniLocation._curID}static clearWatch(i){delete MiniLocation._watchDic[i],MiniLocation._hasWatch()||e.Laya.systemTimer.clear(null,MiniLocation._myLoop)}static _hasWatch(){var i;for(i in MiniLocation._watchDic)if(MiniLocation._watchDic[i])return!0;return!1}static _myLoop(){MiniLocation.getCurrentPosition(MiniLocation._mySuccess,MiniLocation._myError)}static _mySuccess(i){var t,n={};for(t in n.coords=i,n.timestamp=e.Browser.now(),MiniLocation._watchDic)MiniLocation._watchDic[t].success&&MiniLocation._watchDic[t].success(n)}static _myError(i){var e;for(e in MiniLocation._watchDic)MiniLocation._watchDic[e].error&&MiniLocation._watchDic[e].error(i)}}MiniLocation._watchDic={},MiniLocation._curID=0;i.ImageDataPolyfill=ImageDataPolyfill,i.MiniAccelerator=MiniAccelerator,i.MiniAdpter=MiniAdpter,i.MiniFileMgr=MiniFileMgr,i.MiniInput=MiniInput,i.MiniLoader=MiniLoader,i.MiniLocalStorage=MiniLocalStorage,i.MiniLocation=MiniLocation,i.MiniSound=MiniSound,i.MiniSoundChannel=MiniSoundChannel,i.MiniTTFFontLoader=MiniTTFFontLoader,i.MiniVideo=class{constructor(i=320,e=240){this.videoend=!1,this.videourl="",this.videoElement=MiniAdpter.window.wx.createVideo({width:i,height:e,autoplay:!0})}static __init__(){}on(i,e,t){"loadedmetadata"==i?(this.onPlayFunc=t.bind(e),this.videoElement.onPlay(this.onPlayFunction.bind(this))):"ended"==i&&(this.onEndedFunC=t.bind(e),this.videoElement.onEnded(this.onEndedFunction.bind(this))),this.videoElement.onTimeUpdate(this.onTimeUpdateFunc.bind(this))}onTimeUpdateFunc(i){this.position=i.position,this._duration=i.duration}get duration(){return this._duration}onPlayFunction(){this.videoElement&&(this.videoElement.readyState=200),console.log("=====视频加载完成========"),null!=this.onPlayFunc&&this.onPlayFunc()}onEndedFunction(){this.videoElement&&(this.videoend=!0,console.log("=====视频播放完毕========"),null!=this.onEndedFunC&&this.onEndedFunC())}off(i,e,t){"loadedmetadata"==i?(this.onPlayFunc=t.bind(e),this.videoElement.offPlay(this.onPlayFunction.bind(this))):"ended"==i&&(this.onEndedFunC=t.bind(e),this.videoElement.offEnded(this.onEndedFunction.bind(this)))}load(i){this.videoElement&&(this.videoElement.src=i)}play(){this.videoElement&&(this.videoend=!1,this.videoElement.play())}pause(){this.videoElement&&(this.videoend=!0,this.videoElement.pause())}get currentTime(){return this.videoElement?this.videoElement.initialTime:0}set currentTime(i){this.videoElement&&(this.videoElement.initialTime=i)}get videoWidth(){return this.videoElement?this.videoElement.width:0}get videoHeight(){return this.videoElement?this.videoElement.height:0}get ended(){return this.videoend}get loop(){return!!this.videoElement&&this.videoElement.loop}set loop(i){this.videoElement&&(this.videoElement.loop=i)}get playbackRate(){return this.videoElement?this.videoElement.playbackRate:0}set playbackRate(i){this.videoElement&&(this.videoElement.playbackRate=i)}get muted(){return!!this.videoElement&&this.videoElement.muted}set muted(i){this.videoElement&&(this.videoElement.muted=i)}get paused(){return!!this.videoElement&&this.videoElement.paused}size(i,e){this.videoElement&&(this.videoElement.width=i,this.videoElement.height=e)}get x(){return this.videoElement?this.videoElement.x:0}set x(i){this.videoElement&&(this.videoElement.x=i)}get y(){return this.videoElement?this.videoElement.y:0}set y(i){this.videoElement&&(this.videoElement.y=i)}get currentSrc(){return this.videoElement.src}destroy(){this.videoElement&&this.videoElement.destroy(),this.videoElement=null,this.onEndedFunC=null,this.onPlayFunc=null,this.videoend=!1,this.videourl=null}reload(){this.videoElement&&(this.videoElement.src=this.videourl)}}};